<!DOCTYPE html> <html lang="en"> <head> <title>Streaming databases in realtime with MySQL, Debezium, and Kafka</title> <meta charset="utf-8"> <meta content="width=device-width, initial-scale=1.0" name="viewport"> <meta content="" name="description"> <meta content="" name="author"> <link href="https://static.jboss.org/theme/css/bootstrap-community/3.2.0.2/bootstrap-community.min.css" media="screen" rel="stylesheet"> <!--[if lt IE 9]><script src="https://static.jboss.org/theme/js/libs/html5/pre3.6/html5.min.js"></script><![endif]--> <link href="https://static.jboss.org/example/images/favicon.ico" rel="shortcut icon"> <link href="https://static.jboss.org/example/images/apple-touch-icon-144x144-precomposed.png" rel="apple-touch-icon-precomposed" sizes="144x144"> <link href="https://static.jboss.org/example/images/apple-touch-icon-114x114-precomposed.png" rel="apple-touch-icon-precomposed" sizes="114x114"> <link href="https://static.jboss.org/example/images/apple-touch-icon-72x72-precomposed.png" rel="apple-touch-icon-precomposed" sizes="72x72"> <link href="https://static.jboss.org/example/images/apple-touch-icon-precomposed.png" rel="apple-touch-icon-precomposed"> <link href="/stylesheets/debezium.css" rel="stylesheet" type="text/css"> <link href="https://wecode.wepay.com/posts/streaming-databases-in-realtime-with-mysql-debezium-kafka" rel="canonical"> <style>
  @media (min-width: 980px) {
    .banner { background-image: url(https://static.jboss.org/example/images/debezium-banner-1180px.png); height: 110px;  }
  }
  @media (max-width: 979px) {
    .banner { background-image: url(https://static.jboss.org/example/images/debezium-logo.png); background-repeat:no-repeat; background-position: center bottom; height: 60px; }
  }
  @media (max-width: 650px) {
    .banner { width: 100%; margin: 0px auto; }
  }
  @media (max-width: 450px) {
    .banner { height: 90px; }
  }
</style> <link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/styles/default.min.css" rel="stylesheet"> <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/highlight.min.js"></script> <script>
hljs.initHighlightingOnLoad();
</script> <script src="https://static.jboss.org/theme/js/libs/jquery/jquery-1.9.1.min.js"></script> <style>
  /* adjusting the vertical spacing for when a stickynav is engaged */
  .breadcrumb-fixed > .active {
    color: #8c8f91;
  }
  .breadcrumb-fixed {
    margin: 70px 0 10px;
    padding: 8px 15px;
    margin-bottom: 20px;
    list-style: none;
    background-color: #f5f5f5;
    border-radius: 4px;
  }
  
  .breadcrumb-fixed > li {
    display: inline-block;
  }
</style> </head> <body> <div id="rhbar"> <a class="jbdevlogo" href="https://www.jboss.org/projects/about"></a> <a class="rhlogo" href="https://www.redhat.com/"></a> </div> <div id=""> <ul class="visuallyhidden" id="top"> <li> <a accesskey="n" href="#nav" title="Skip to navigation">Skip to navigation</a> </li> <li> <a accesskey="c" href="#page" title="Skip to content">Skip to content</a> </li> </ul> <div class="container" id="content"> <div class="navbar navbar-inverse navbar-fix"> <div class="container-fluid"> <div class="navbar-header"> <button class="navbar-toggle collapsed" data-target="#navbar-1" data-toggle="collapse"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href="/"> <img src="/images/color_white_debezium_type_600px.svg" style="height: 32px; margin-right: 5px; margin-top: -5px;"> </a> </div> <div class="collapse navbar-collapse" id="navbar-1"> <ul class="nav navbar-nav pull-right"> <li class=""><a href="/documentation/faq/">FAQ</a></li> <li class=""><a href="/documentation/">DOCUMENTATION</a></li> <li class=""><a href="/releases/">RELEASES</a></li> <li class=""><a href="/community/">COMMUNITY</a></li> <li class="active"><a href="/blog/">BLOG</a></li> </ul> </div> </div> </div> <div id="equalHeightsLayout"> <div class="row post-text-padding row-no-expand"> <div class="hidden-xs col-sm-3 no-right-padding" id="leftdocnav" style="padding-left: 15px; padding-right: 15px;"> <div class="doc-pills"> <ul class="nav nav-pills nav-stacked"> <li class="item"> <a href="/blog">Home</a> <div class="icon"> <span class="icon-home"></span> </div> </li> <li class="item"> <a href="/blog.atom">Feed</a> <div class="icon"> <span class="icon-rss"></span> </div> </li> </ul> </div> <p></p> <div class="featured-posts"> <div id="featured" style="margin-bottom: 4px; border-bottom: 1px solid #ccc; font-size: 115%; margin-left: 2px;"> Featured Posts </div> <ul style="padding-inline-start: 22px;"> <li style="margin-bottom: 3px;"> <a href="/blog/2019/10/22/audit-logs-with-kogito/" style="font-size: 95%;"> Admin Service for Audit Logs with Kogito </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2019/10/01/audit-logs-with-change-data-capture-and-stream-processing/" style="font-size: 95%;"> Building Audit Logs with Change Data Capture and Stream Processing </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2019/07/12/streaming-cassandra-at-wepay-part-1/" style="font-size: 95%;"> Streaming Cassandra at WePay - Part 1 </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2019/02/19/reliable-microservices-data-exchange-with-the-outbox-pattern/" style="font-size: 95%;"> Reliable Microservices Data Exchange With the Outbox Pattern </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/12/05/automating-cache-invalidation-with-change-data-capture/" style="font-size: 95%;"> Automating Cache Invalidation With Change Data Capture </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/09/20/materializing-aggregate-views-with-hibernate-and-debezium/" style="font-size: 95%;"> Materializing Aggregate Views With Hibernate and Debezium </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/07/19/advantages-of-log-based-change-data-capture/" style="font-size: 95%;"> Five Advantages of Log-Based Change Data Capture </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/03/08/creating-ddd-aggregates-with-debezium-and-kafka-streams/" style="font-size: 95%;"> Creating DDD aggregates with Debezium and Kafka Streams </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/01/17/streaming-to-elasticsearch/" style="font-size: 95%;"> Streaming Data Changes from Your Database to Elasticsearch </a> </li> </ul> </div> <p></p> <div class="cloud-tags"> <div id="tags" style="margin-bottom: 4px; border-bottom: 1px solid #ccc; font-size: 115%; margin-left: 2px;"> Tags </div> <div class="tag-cloud"> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/apache-kafka/">apache-kafka</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/avro/">avro</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/cassandra/">cassandra</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/community/">community</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/discussion/">discussion</a> </span> <span class="tag tag-5"> <a href="https://debezium.io/blog/tags/docker/">docker</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/elasticsearch/">elasticsearch</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/example/">example</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/examples/">examples</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/featured/">featured</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/fedora/">fedora</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/introduction/">introduction</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/json/">json</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/kafka/">kafka</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/kafka-streams/">kafka-streams</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/kogito/">kogito</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/ksql/">ksql</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/kubernetes/">kubernetes</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/microservices/">microservices</a> </span> <span class="tag tag-4"> <a href="https://debezium.io/blog/tags/mongodb/">mongodb</a> </span> <span class="tag tag-6"> <a href="https://debezium.io/blog/tags/mysql/">mysql</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/news/">news</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/newsletter/">newsletter</a> </span> <span class="tag tag-2"> <a href="https://debezium.io/blog/tags/oracle/">oracle</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/outbox/">outbox</a> </span> <span class="tag tag-5"> <a href="https://debezium.io/blog/tags/postgres/">postgres</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/presentation/">presentation</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/quarkus/">quarkus</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/rds/">rds</a> </span> <span class="tag tag-6"> <a href="https://debezium.io/blog/tags/releases/">releases</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/secrets/">secrets</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/sentry/">sentry</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/serialization/">serialization</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/smt/">smt</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/sql/">sql</a> </span> <span class="tag tag-3"> <a href="https://debezium.io/blog/tags/sqlserver/">sqlserver</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/vagrant/">vagrant</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/website/">website</a> </span> </div> </div> </div> <div class="col-xs-12 col-sm-9" id="maincol"> <div class="post"> <div class="row" style="margin-left: 0; margin-right: 0; margin-bottom: 10px;"> <div class="col-sm-12" style="padding-left: 0px;"> <div style="display: table-cell; vertical-align: top;"> <div style="width: 72px; border: 1px solid #ccc; padding: 3px; display: inline-block;"> <img src="/images/color_debezium_64px.png" style="width: 64px;"> </div> </div> <div style="display: table-cell; vertical-align: top;"> <div style="margin-left: 8px;"> <span class="hidden-sm hidden-xs" style="font-size: 2.75rem; line-height: 1;"> <a href="/blog/2017/02/22/Debezium-at-WePay/">Streaming databases in realtime with MySQL, Debezium, and Kafka</a> </span> <span class="hidden-md hidden-lg" style="font-size: 2rem; line-height: 1;"> <a href="/blog/2017/02/22/Debezium-at-WePay/">Streaming databases in realtime with MySQL, Debezium, and Kafka</a> </span> <div class="byline" style="line-height: 1;"> <em> February 22, 2017 by Chris Riccomini </em> <div class="hidden-xs" style="margin-top: 5px;"> <a class="hidden-sm hidden-xs label label-info" href="/blog/tags/mysql/">mysql</a> </div> </div> </div> </div> </div> </div> <div class="row" style="margin-left: 0; margin-right: 0;"> <div id="preamble"> <div class="sectionbody"> <div class="paragraph"> <p><strong><em>This post originally appeared on the <a href="https://wecode.wepay.com/posts/streaming-databases-in-realtime-with-mysql-debezium-kafka">WePay Engineering blog</a>.</em></strong></p> </div> <div class="paragraph"> <p><a href="https://en.wikipedia.org/wiki/Change_data_capture">Change data capture</a> has been around for a while, but some recent developments in technology have given it new life. Notably, using <a href="http://kafka.apache.org/">Kafka</a> as a backbone to stream your database data in realtime has become <a href="https://github.com/wushujames/mysql-cdc-projects/wiki">increasingly common</a>.</p> </div> <div class="paragraph"> <p>If you&#8217;re wondering why you might want to stream database changes into Kafka, I highly suggest reading <a href="http://blog.christianposta.com/microservices/the-hardest-part-about-microservices-data/">The Hardest Part About Microservices: Your Data</a>. At WePay, we wanted to integrate our microservices and downstream datastores with each other, so every system could get access to the data that it needed. We use Kafka as our data integration layer, so we needed a way to get our database data into it.</p> </div> <div class="paragraph"> <p>Last year, <a href="https://www.yelp.com/engineering">Yelp&#8217;s engineering team</a> published an excellent <a href="https://engineeringblog.yelp.com/2016/11/open-sourcing-yelps-data-pipeline.html">series of posts</a> on their data pipeline. These included a discussion on how they <a href="https://engineeringblog.yelp.com/2016/08/streaming-mysql-tables-in-real-time-to-kafka.html">stream MySQL data into Kafka</a>. Their architecture involves a series of homegrown pieces of software to accomplish the task, notably <a href="https://github.com/Yelp/schematizer">schematizer</a> and <a href="https://github.com/Yelp/mysql_streamer">MySQL streamer</a>. The write-up triggered a thoughtful post on Debezium&#8217;s blog about a proposed equivalent architecture using <a href="http://docs.confluent.io/3.1.1/connect/">Kafka connect</a>, <a href="/">Debezium</a>, and <a href="http://docs.confluent.io/3.1.1/schema-registry/docs/">Confluent&#8217;s schema registry</a>. This proposed architecture is what we&#8217;ve been implementing at WePay, and this post describes how we leverage Debezium and Kafka connect to stream our MySQL databases into Kafka.</p> </div> </div> </div> <div class="sect1"> <h2 id="architecture"><a class="anchor" href="#architecture"></a>Architecture</h2> <div class="sectionbody"> <div class="paragraph"> <p>The flow of data starts with each microservice&#8217;s MySQL database. These databases run in <a href="https://cloud.google.com/">Google Cloud</a> as <a href="https://cloud.google.com/sql/">CloudSQL</a> MySQL instances <a href="https://dev.mysql.com/doc/refman/5.7/en/replication-gtids.html">with GTIDs enabled</a>. We&#8217;ve set up a downstream MySQL cluster specifically for Debezium. Each CloudSQL instance replicates its data into the Debezium cluster, which consists of two MySQL machines: a primary (active) server and secondary (passive) server. This single Debezium cluster is an operational trick to make it easier for us to operate Debezium. Rather than having Debezium connect to dozens of microservice databases directly, we can connect to just a single database. This also isolates Debezium from impacting the production OLTP workload that the master CloudSQL instances are handling.</p> </div> <div class="paragraph"> <p>We run one Debezium connector (in <a href="http://docs.confluent.io/2.0.0/connect/userguide.html#distributed-mode">distributed mode</a> on the Kafka connect framework) for each microservice database. Again, the goal here is isolation. Theoretically, we could run a single Debezium connector that produces messages for all databases (since all microservice databases are in the Debezium cluster). This approach would actually be more resource efficient since each Debezium connector has to read MySQL&#8217;s entire <a href="https://dev.mysql.com/doc/refman/5.7/en/binary-log.html">binlog</a> anyway. We opted not to do this because we wanted to be able to bring Debezium connectors up and down, and configure them differently for each microservice DB.</p> </div> <div class="paragraph"> <p>The Debezium connectors feed the MySQL messages into Kafka (and add their schemas to the Confluent schema registry), where downstream systems can consume them. We use our Kafka connect <a href="https://wecode.wepay.com/posts/kafka-bigquery-connector">BigQuery connector</a> to load the MySQL data into BigQuery using BigQuery&#8217;s <a href="https://cloud.google.com/bigquery/streaming-data-into-bigquery">streaming API</a>. This gives us a data warehouse in BigQuery that is usually less than 30 seconds behind the data that&#8217;s in production. Other microservices, stream processors, and data infrastructure consume the feeds as well.</p> </div> <div class="imageblock"> <div class="content"> <img src="https://wecode.wepay.com/assets/2017-02-21-streaming-databases-in-realtime-with-mysql-debezium-kafka/debezium-architecture.png" alt="Debezium architecture"> </div> </div> </div> </div> <div class="sect1"> <h2 id="debezium"><a class="anchor" href="#debezium"></a>Debezium</h2> <div class="sectionbody"> <div class="paragraph"> <p>The remainder of this post will focus on Debezium (the DBZ boxes in the diagram above), and how we configure and operate it. Debezium works by connecting to MySQL and pretending to be a replica. MySQL sends its replication data to Debezium, thinking it&#8217;s actually funneling data to another downstream MySQL instance. Debezium then takes the data, converts the schemas from MySQL schemas to <a href="https://kafka.apache.org/0100/javadoc/org/apache/kafka/connect/data/Struct.html">Kafka connect structures</a>, and forwards them to Kafka.</p> </div> <div class="sect2"> <h3 id="adding_new_databases"><a class="anchor" href="#adding_new_databases"></a>Adding new databases</h3> <div class="paragraph"> <p>When a new microservice with a CloudSQL database comes online, we want to get that data into Kafka. The first step in the process is to load the data into the Debezium MySQL cluster. This involves several steps:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Take a MySQL dump of the data in the microservice DB.</p> </li> <li> <p>Pause the secondary Debezium MySQL DB.</p> </li> <li> <p>Load the MySQL dump into the secondary Debezium MySQL DB.</p> </li> <li> <p>Reset <code>GTID_PURGED</code> parameter to include the GTID from the new DB dump.</p> </li> <li> <p>Unpause the secondary Debezium MySQL DB.</p> </li> <li> <p>Update HA Proxy to point to the secondary, which now becomes the primary.</p> </li> <li> <p>Follow steps 2-5 for the old primary instance (now secondary).</p> </li> </ol> </div> <div class="paragraph"> <p>The actual commands that we run are:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight nowrap"><code class="language-bash" data-lang="bash"># (1) Take a dump of the database we wish to add.&#x000A;$ mydumper  --host=123.123.123.123 --port=3306 --user=foo --password=*********  -B log --trx-consistency-only  --triggers --routines -o /mysqldata/new_db/ -c -L mydumper.log&#x000A;&#x000A;# (2) Stop all replication on the secondary Debezium cluster.&#x000A;$ mysql&gt; STOP SLAVE for channel 'foo';&#x000A;$ mysql&gt; STOP SLAVE for channel 'bar';&#x000A;$ mysql&gt; STOP SLAVE for channel 'baz';&#x000A;&#x000A;# Get the current GTID purged values from MySQL.&#x000A;$ mysql&gt; SHOW GLOBAL VARIABLES like '%gtid_purged%';&#x000A;&#x000A;# (3) Load the dump of the database into the Debezium cluster.&#x000A;$ myloader -d /mysqldata/new_db/ -s new_db&#x000A;&#x000A;# (4) Clear out existing GTID_PURGED values so that we can overwrite it to include the GTID from the new dump file.&#x000A;$ mysql&gt; reset master;&#x000A;&#x000A;# Set the new GTID_PURGED value, including the GTID_PURGED value from the MySQL dump file.&#x000A;$ mysql&gt; set global GTID_PURGED="f3a44d1a-11e6-44ba-bf12-040bab830af0:1-10752,c627b2bc-b36a-11e6-a886-42010af00790:1-9052,01261abc3-6ade-11e6-9647-42010af0044a:1-375342";&#x000A;&#x000A;# (5) Start replication for the new DB.&#x000A;$ mysql&gt; CHANGE MASTER TO MASTER_HOST='123.123.123.123', MASTER_USER='REPLICATION_USER', MASTER_PASSWORD='REPLICATION_PASSWORD',MASTER_AUTO_POSITION=1 for CHANNEL 'new_db';&#x000A;$ mysql&gt; START SLAVE for channel 'new_db';&#x000A;&#x000A;# Start replication for the DBs that we paused.&#x000A;$ mysql&gt; START SLAVE for channel 'foo';&#x000A;$ mysql&gt; START SLAVE for channel 'bar';&#x000A;$ mysql&gt; START SLAVE for channel 'baz';&#x000A;&#x000A;# Repeat steps 2-5 on the old primary (now secondary).</code></pre> </div> </div> <div class="paragraph"> <p>At the end of these steps, both the primary and secondary Debezium MySQL servers have the new database. Once finished, we can then add a new Debezium connector to the Kafka connect cluster. This connector will have configuration that looks roughly like this:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight nowrap"><code class="language-json" data-lang="json">{&#x000A;   "name": "debezium-connector-microservice1",&#x000A;   "config": {&#x000A;       "name": "debezium-connector-microservice1",&#x000A;       "connector.class": "io.debezium.connector.mysql.MySqlConnector",&#x000A;       "tasks.max": "1",&#x000A;       "database.hostname": "dbz-mysql01",&#x000A;       "database.port": "3306",&#x000A;       "database.user": "user",&#x000A;       "database.password": "*******",&#x000A;       "database.server.id": "101",&#x000A;       "database.server.name": "db.debezium.microservice1",&#x000A;       "gtid.source.includes": "c34aeb9e-89ad-11e6-877b-42010a93af2d",&#x000A;       "database.whitelist": "microservice1_db",&#x000A;       "poll.interval.ms": "2",&#x000A;       "table.whitelist": "microservice1_db.table1,microservice1_db.table2",&#x000A;       "column.truncate.to.1024.chars" : "microservice1_db.table1.text_col",&#x000A;       "database.history.kafka.bootstrap.servers": "kafka01:9093,kafka02:9093,kafka03:9093",&#x000A;       "database.history.kafka.topic": "debezium.history.microservice1",&#x000A;       "database.ssl.truststore": "/certs/truststore",&#x000A;       "database.ssl.truststore.password": "*******",&#x000A;       "database.ssl.mode": "required",&#x000A;       "database.history.producer.security.protocol": "SSL",&#x000A;       "database.history.producer.ssl.truststore.location": "/certs/truststore",&#x000A;       "database.history.producer.ssl.truststore.password": "*******",&#x000A;       "database.history.consumer.security.protocol": "SSL",&#x000A;       "database.history.consumer.ssl.truststore.location": "/certs/truststore",&#x000A;       "database.history.consumer.ssl.truststore.password": "*******",&#x000A;   }&#x000A;}</code></pre> </div> </div> <div class="paragraph"> <p>The details on these configuration fields are located <a href="/docs/connectors/mysql/#connector-properties">here</a>.</p> </div> <div class="paragraph"> <p>The new connector will start up and begin <a href="/docs/connectors/mysql/#snapshots">snapshotting</a> the database, since this is the first time it&#8217;s been started. Debezium&#8217;s snapshot implementation (see <a href="https://issues.redhat.com/browse/DBZ-31">DBZ-31</a>) uses an approach very similar to MySQL&#8217;s mysqldump tool. Once the snapshot is complete, Debezium will switch over to using MySQL&#8217;s binlog to receive all future database updates.</p> </div> <div class="paragraph"> <p>Kafka connect and Debezium work together to periodically commit Debezium&#8217;s location in the MySQL binlog described by a <a href="https://dev.mysql.com/doc/refman/5.7/en/replication-gtids-concepts.html">MySQL global transaction ID</a> (GTID). When Debezium restarts, Kafka connect will give it the last committed MySQL GTID, and Debezium will pick up from there.</p> </div> <div class="paragraph"> <p><em>Note that commits only happen periodically, so Debezium might start up from a location in the log prior to the last row that it received. In such a case, you will observe duplicate messages in Debezium Kafka topic. Debezium writes messages to Kafka with an at-least-once messaging guarantee.</em></p> </div> </div> <div class="sect2"> <h3 id="high_availability"><a class="anchor" href="#high_availability"></a>High availability</h3> <div class="paragraph"> <p>One of the difficulties we faced when we first began using Debezium was how to make it tolerant to machine failures (both the upstream MySQL server, and Debezium, itself). MySQL prior to version 5.6 modeled a replica&#8217;s location in its parent&#8217;s binlogs using a (binlog filename, file offset) tuple. The problem with this approach is that the binlog filenames are not the same between MySQL machines. This means that a replica reading from upstream MySQL machine 1 can&#8217;t easily fail over to MySQL machine 2. There is an entire ecosystem of tools (including <a href="https://code.google.com/p/mysql-master-ha/">MHA</a>) to try and address this problem.</p> </div> <div class="paragraph"> <p>Starting with MySQL 5.6, MySQL introduced the concept of global transaction IDs. These GTIDs identify a specific location within the MySQL binlog <em>across machines</em>. This means that a consumer reading from a binlog on one MySQL server can switch over to the other, provided that both servers have the data available. This is how we run our systems. Both the CloudSQL instances and the Debezium MySQL cluster run with GTIDs enabled. The Debezium MySQL servers also have replication binlogs enabled so that binlogs exist for Debezium to read (replicas don&#8217;t normally have binlogs enabled by default). All of this enables Debezium to consume from the primary Debezium MySQL server, but switch over to the secondary (via HA Proxy) if there&#8217;s a failure.</p> </div> <div class="paragraph"> <p>If the machine that Debezium, itself, is running on fails, then the Kafka connect framework fails the connector over to another machine in the cluster. When the failover occurs, Debezium receives its last committed offset (GTID) from Kafka connect, and picks up where it left off (with the same caveat as above: you might see some duplicate messages due to periodic commit frequency).</p> </div> <div class="paragraph"> <p>An important configuration that needs to be called out is the <code>gtid.source.includes</code> field that we have set above. When we first set up the topology that&#8217;s described in the architecture section, we discovered that we could not fail over from the primary Debezium DB to the secondary DB even though they both were replicating exactly the same data. This is because, in addition to the GTIDs for the various upstream DBs that both primary and secondary machines are replicating, each machine has its <em>own</em> server UUID for its various MySQL databases (e.g. information_schema). The fact that these two servers have different UUIDs in them led MySQL to get confused when we triggered a failover, because Debezium&#8217;s GTID would include the server UUID for the primary server, which the secondary server didn&#8217;t know about. The fix was to filter out all UUIDs that we don&#8217;t care about from the GTID. Each Debezium connector filters out all server UUIDs except for the UUID for the microservice DB that it cares about. This allows the connector to fail from primary to secondary without issue. This issue is documented in detail on <a href="https://issues.redhat.com/browse/DBZ-129">DBZ-129</a>.</p> </div> </div> <div class="sect2"> <h3 id="schemas"><a class="anchor" href="#schemas"></a>Schemas</h3> <div class="paragraph"> <p>Debezium&#8217;s <a href="/docs/connectors/mysql/#change-events-value">message format</a> includes both the "before" and "after" versions of a row. For inserts, the "before" is null. For deletes, the "after" is null. Updates have both the "before" and "after" fields filled out. The messages also include some server information such as the server ID that the message came from, the GTID of the message, the server timestamp, and so on.</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-json" data-lang="json">{&#x000A;  "before": {&#x000A;    "id": 1004,&#x000A;    "first_name": "Anne",&#x000A;    "last_name": "Kretchmar",&#x000A;    "email": "annek@noanswer.org"&#x000A;  },&#x000A;  "after": {&#x000A;    "id": 1004,&#x000A;    "first_name": "Anne Marie",&#x000A;    "last_name": "Kretchmar",&#x000A;    "email": "annek@noanswer.org"&#x000A;  },&#x000A;  "source": {&#x000A;    "name": "mysql-server-1",&#x000A;    "server_id": 223344,&#x000A;    "ts_sec": 1465581,&#x000A;    "gtid": null,&#x000A;    "file": "mysql-bin.000003",&#x000A;    "pos": 484,&#x000A;    "row": 0,&#x000A;    "snapshot": null&#x000A;  },&#x000A;  "op": "u",&#x000A;  "ts_ms": 1465581029523&#x000A;}</code></pre> </div> </div> <div class="paragraph"> <p>The serialization format that Debezium sends to Kafka is configurable. We prefer Avro at WePay for its compact size, schema DDL, performance, and rich ecosystem. We&#8217;ve configured Kafka connect to use Confluent&#8217;s <a href="https://github.com/confluentinc/schema-registry/tree/master/avro-serializer/src/main/java/io/confluent/kafka/serializers">Avro encoder</a> codec for Kafka. This encoder serializes messages to Avro, but also registers the schemas with Confluent&#8217;s schema registry.</p> </div> <div class="paragraph"> <p>If a MySQL table&#8217;s schema is changed, Debezium adapts to the change by updating the structure and schema of the "before" and "after" portions of its event messages. This will appear to the Avro encoder as a new schema, which it will register with the schema registry before the message is sent to Kafka. The registry runs full compatibility checks to make sure that downstream consumers don&#8217;t break due to a schema evolution.</p> </div> <div class="paragraph"> <p><em>Note that it&#8217;s still possible to make an incompatible change in the MySQL schema itself, which would break downstream consumers. We have not yet added automatic compatibility checks to MySQL table alters.</em></p> </div> </div> </div> </div> <div class="sect1"> <h2 id="future_work"><a class="anchor" href="#future_work"></a>Future work</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="monolithic_database"><a class="anchor" href="#monolithic_database"></a>Monolithic database</h3> <div class="paragraph"> <p>In addition to our microservices, we have a legacy monolithic database that&#8217;s much larger than our microservice databases. We&#8217;re in the process of upgrading this cluster to run with GTIDs enabled. Once this is done, we plan to replicate this cluster into Kafka with Debezium as well.</p> </div> </div> <div class="sect2"> <h3 id="large_table_snapshots"><a class="anchor" href="#large_table_snapshots"></a>Large table snapshots</h3> <div class="paragraph"> <p>We&#8217;re lucky that all of our microservice databases are of relatively manageable size. Our monolithic database has some tables that are much larger. We have yet to test Debezium with very large tables, so it&#8217;s unclear if any tuning or patches will be required in order to snapshot these tables on the initial Debezium load. We have heard community reports that larger tables (6 billion+ rows) do work, provided that the configuration exposed in <a href="https://issues.redhat.com/browse/DBZ-152">DBZ-152</a> is set. This is work we&#8217;re planning to do shortly.</p> </div> </div> <div class="sect2"> <h3 id="more_monitoring"><a class="anchor" href="#more_monitoring"></a>More monitoring</h3> <div class="paragraph"> <p>Kafka connect doesn&#8217;t currently make it easy to expose metrics through the Kafka metrics framework. As a result, there are very few metrics available from the Kafka connect framework. Debezium does expose metrics via JMX (see <a href="https://issues.redhat.com/browse/DBZ-134">DBZ-134</a>), but we aren&#8217;t exposing them to our metrics system currently. We do monitor the system, but when things go wrong, it can be difficult to determine what&#8217;s going on. <a href="https://issues.apache.org/jira/browse/KAFKA-2376">KAFKA-2376</a> is the open JIRA that&#8217;s meant to address the underlying Kafka connect issue.</p> </div> </div> <div class="sect2"> <h3 id="more_databases"><a class="anchor" href="#more_databases"></a>More databases</h3> <div class="paragraph"> <p>As we add more microservice databases, we&#8217;ll begin to put pressure on the two Debezium MySQL servers that we have. Eventually, we plan to split the single Debezium cluster that we have into more than one, with some microservices replicating only to one cluster, and the rest replicating to others.</p> </div> </div> <div class="sect2"> <h3 id="unify_compatibility_checks"><a class="anchor" href="#unify_compatibility_checks"></a>Unify compatibility checks</h3> <div class="paragraph"> <p>As I mentioned in the schema section, above, the Confluent schema registry runs schema compatibility checks out of the box right now. This makes it very easy for us to prevent backward and forward incompatible changes from making their way into Kafka. We don&#8217;t currently have an equivalent check at the MySQL layer. This is a problem because it means it&#8217;s possible for a DBA to make incompatible changes at the MySQL layer. Debezium will then fail when trying to produce the new messages into Kafka. We need to make sure this can&#8217;t happen by adding equivalent checks at the MySQL layer. <a href="https://issues.redhat.com/browse/DBZ-70">DBZ-70</a> discusses this more.</p> </div> </div> <div class="sect2"> <h3 id="automatic_topic_configuration"><a class="anchor" href="#automatic_topic_configuration"></a>Automatic topic configuration</h3> <div class="paragraph"> <p>We currently run Kafka with topic auto-create enabled with a default of 6 partitions, and time-based/size-based retention. This configuration doesn&#8217;t make much sense for Debezium topics. At the very least, they should be using log-compaction as their retention. We plan to write a script that looks for mis-configured Debezium topics, and updates them to appropriate retention settings.</p> </div> </div> </div> </div> <div class="sect1"> <h2 id="conclusion"><a class="anchor" href="#conclusion"></a>Conclusion</h2> <div class="sectionbody"> <div class="paragraph"> <p>We&#8217;ve been running Debezium in production for the past 8 months. Initially, we ran it dark, and then enabled it for the realtime BigQuery pipeline shown in the architecture diagram above. Recently, we&#8217;ve begun consuming the messages in microservices and stream processing systems. We look forward to adding more data to the pipeline, and addressing some of the issues that were raised in the <em>Future work</em> section.</p> </div> <div class="paragraph"> <p>A special thanks to <a href="https://www.linkedin.com/in/randallhauch">Randall Hauch</a>, who has been invaluable in addressing a number of bug fixes and feature requests.</p> </div> </div> </div> </div> </div> <div class="well"> <div class="row"> <div class="col-md-8"> <h2>Chris Riccomini</h2> <p> <span class="bio-size">Chris is a Principal Software Engineer at WePay.</span> </p> <p class="bio-size"> <a href="https://twitter.com/criccomini"> <i class="icon-twitter"></i> </a> &nbsp; <a href="https://github.com/criccomini"> <i class="icon-github"></i> </a> &nbsp; <a href="https://www.linkedin.com/in/riccomini"> <i class="icon-linkedin"></i> </a> &nbsp; </p> </div> <div class="col-md-4"> </div> </div> </div> <div class="comments"> <div id="disqus_thread"></div> <script type="text/javascript">
            var disqus_shortname = 'Debezium';
            var disqus_url = "https://debezium.io/blog/2017/02/22/Debezium-at-WePay/";
            var disqus_developer = null;
            var disqus_identifier = null;
            (function() {
              var dsq = document.createElement("script"); dsq.type = "text/javascript"; dsq.async = true;
              dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName("head")[0] || document.getElementsByTagName("body")[0]).appendChild(dsq);
            })();
            </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript=Debezium">comments powered by Disqus.</a></noscript> </div> </div> </div> </div> </div> <footer class="container"> <div class="row"> <div class="col-md-5 col-md-offset-1"> <h4>Debezium</h4> <p> &#169; 2020 Debezium Community <br> <br> <i class="icon-fire"></i> Mixed with <a href="http://twitter.github.com/bootstrap">Bootstrap</a>, baked by <a href="http://awestruct.org">Awestruct</a>. <br> <i class="icon-flag"></i> Website and docs licensed under <a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>. <br> <i class="icon-flag-alt"></i> Code released under <a href="http://www.apache.org/licenses/LICENSE-2.0.html">Apache License, v2.0</a>. <br> <i class="icon-file-alt"></i> <a href="https://www.redhat.com/legal/legal_statement.html" title="Terms">Terms</a> | <a href="https://www.redhat.com/legal/privacy_statement.html" title="Privacy Policy">Privacy</a> </p> </div> <div class="col-md-3"> <h4>Documentation</h4> <ul class="list-unstyled"> <li> <a href="/documentation/features" title="Features">Features</a> </li> <li> <a href="/documentation/install/stable/" title="Install">Install</a> </li> <li> <a href="/documentation/architecture/" title="Architecture">Architecture</a> </li> <li> <a href="/documentation/faq/" title="FAQ">FAQ</a> </li> <li> <a href="/community/contribute/" title="Contribute">Contribute</a> </li> </ul> </div> <div class="col-md-3"> <h4>Connect</h4> <ul class="list-unstyled"> <li> <a href="/blog" title="Blog">Blog</a> </li> <li> <a href="http://twitter.com/debezium" title="Twitter">Twitter</a> </li> <li> <a href="http://github.com/debezium" title="GitHub">GitHub</a> </li> <li> <a href="https://gitter.im/debezium/user" title="Chat">Chat</a> </li> <li> <a href="https://groups.google.com/forum/#!forum/debezium" title="Google Groups">Google Groups</a> </li> <li> <a href="http://stackoverflow.com/questions/tagged/debezium" title="StackOverflow">StackOverflow</a> </li> </ul> </div> </div> </footer> <div class="container" id="companyfooter"> <div class="redhatlogo"> <div id="logospacer"></div> <a href="https://www.redhat.com/"><img src="/images/Logo-Red_Hat-Sponsored_By-B-Standard-RGB.svg"></a> </div> </div> <span class="backToTop"> <a href="#top">back to top</a> </span> <script src="https://static.jboss.org/theme/js/libs/bootstrap-community/3.2.0.2/bootstrap-community.min.js"></script> <script type='text/javascript' language='JavaScript' src='https://www.redhat.com/j/elqNow/elqCfg.js'></script> <script type='text/javascript' language='JavaScript' src='https://www.redhat.com/j/elqNow/elqImg.js'></script> <div id="oTags"> <script type="text/javascript" src="//www.redhat.com/j/s_code.js"></script> <script type="text/javascript"><!--
  var coreUrl = encodeURI(document.URL.split("?")[0]).replace(/-/g," ");
  var urlSplit = coreUrl.toLowerCase().split(/\//);
  var urlLast = urlSplit[urlSplit.length-1];
  var pageNameString = "";
  var siteName = "";
  var minorSectionIndex = 3
  if (urlLast == "") {
      urlSplit.splice(-1,1);
  }
  if (urlLast.search(/\./) >= 0) {
      if (urlLast == "index.html") {
          urlSplit.splice(-1,1);
      }
      else {
          urlSplit[urlSplit.length-1] = urlLast.split(".").splice(0,1);
      }
  }
  siteName = urlSplit[2].split(".")[1];
  s.prop14 = s.eVar27 = siteName || "";
  s.prop15 = s.eVar28 = urlSplit[minorSectionIndex] || "";
  s.prop16 = s.eVar29 = urlSplit[minorSectionIndex+1] || "";
  pageNameString = urlSplit.splice(3).join(" | ");
  s.pageName = "jboss | community | " + siteName + " | " + pageNameString;
  s.server = "jboss";
  s.channel = "jboss | community";
  s.prop4 = s.eVar23 = encodeURI(document.URL);
  s.prop21 = s.eVar18 = coreUrl;
  s.prop2 = s.eVar22 = "en";
  s.prop3 = s.eVar19 = "us";
  //--></script> <script type="text/javascript" src="//www.redhat.com/j/rh_omni_footer.js"></script> <script language="JavaScript" type="text/javascript"><!--
  if(navigator.appVersion.indexOf('MSIE')>=0)document.write(unescape('%3C')+'\!-'+'-')
  //--></script> <noscript><a href="http://www.omniture.com" title="Web Analytics"><img src="https://smtrcs.redhat.com/b/ss/redhatcom,redhatglobal/1/H.25.4--NS/0?[AQB]&cdp=3&[AQE]" height="1" width="1" border="0" alt=""/></a></noscript> </div> <script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script> <script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-10656779-1");
pageTracker._trackPageview();
} catch(err) {}</script> <script>
 (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
 
ga('create', 'UA-76464546-1', 'auto');
ga('send', 'pageview');
ga('set', 'anonymizeIp', true);
ga('require', 'linkid', 'linkid.js');

</script> </div> </body> </html>