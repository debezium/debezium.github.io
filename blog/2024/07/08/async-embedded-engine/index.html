<!DOCTYPE html> <html> <head> <title>Debezium asynchronous engine</title> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1"> <meta name="description" content="Debezium is an open source distributed platform for change data capture. Start it up, point it at your databases, and your apps can start responding to all of the inserts, updates, and deletes that other apps commit to your databases. Debezium is durable and fast, so your apps can respond quickly and never miss an event, even when things go wrong."> <meta content="Debezium" property="og:site_name"> <meta content="Debezium asynchronous engine" property="og:title"> <meta content="https://debezium.io/assets/images/color_black_debezium_type_1200px.png" property="og:image" name="image"> <meta property="og:description" content="Debezium is an open source distributed platform for change data capture. Start it up, point it at your databases, and your apps can start responding to all of the inserts, updates, and deletes that other apps commit to your databases. Debezium is durable and fast, so your apps can respond quickly and never miss an event, even when things go wrong."> <meta property="og:url" content="https://debezium.io/blog/2024/07/08/async-embedded-engine/"> <meta name="twitter:site" content="@debezium"> <meta name="twitter:title" content="Debezium asynchronous engine"> <meta name="twitter:creator" content="@vjuranek"> <meta name="twitter:description" content="Debezium is an open source distributed platform for change data capture. Start it up, point it at your databases, and your apps can start responding to all of the inserts, updates, and deletes that other apps commit to your databases. Debezium is durable and fast, so your apps can respond quickly and never miss an event, even when things go wrong."> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:image" content="https://debezium.io/assets/images/color_black_debezium_type_1200px.png"> <meta property="twitter:url" content="https://debezium.io/blog/2024/07/08/async-embedded-engine/"> <link rel="alternate" type="application/rss+xml" title="Debezium Blog" href="/blog.atom"> <link rel="shortcut icon" type="image/png" href="/favicon.ico"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css"/> <link rel="stylesheet" href="/assets/css/custom.css"/> <link rel="stylesheet" href="/assets/css/highlight.min.css"/> <link rel="stylesheet" href="/assets/css/coderay.css"/> </head> <body class="post"> <div id="rhbar"> <a class="jbdevlogo" href="https://developers.redhat.com"></a> <a class="rhlogo" href="https://www.redhat.com/"></a> </div> <div id> <div class="container" id="content"> <nav class="navbar navbar-inverse navbar-fix"> <div class="container-fluid"> <div class="navbar-header"> <button class="navbar-toggle collapsed border-0" type="button" data-toggle="collapse" data-target="#navigation" aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href="/"><img class="project-logo" src="/assets/images/color_white_debezium_type_600px.svg" style="height: 32px; margin-right: 5px; margin-top: -5px;"></a> </div> <div class="collapse navbar-collapse collapsed" id="navigation"> <ul class="nav navbar-nav pull-right"> <li> <a href="/documentation/faq" class="">FAQ</a> </li> <li class="item"> <a href="/documentation/" class="">Documentation</a> </li> <li> <a href="/releases/" class="">Releases</a> </li> <li> <a href="/community/" class="">Community</a> </li> <li class="active"> <a href="/blog/" class="active">Blog</a> </li> </ul> </div> </div> </nav> <div class="row post-text-padding row-no-expand"> <div class="col-md-3"><div id="leftdocnav"> <div class="hidden-lg hidden-md hidden-sm"> <button class="navbar-toggle docssubmenu-toggle collapsed" data-target="#docssubmenu" data-toggle="collapse" style=" float: none; background-color: #656565; border-color: #656565; width: 100%; color: #fff; "> Navigation Menu </button> </div> <div class="collapse" id="docssubmenu"> <div class="doc-pills"> <ul class="nav nav-pills nav-stacked"> <li class="item"> <a href="/blog">Home</a> <div class="icon"><span class="icon-home"></span></div> </li> <li class="item"> <a href="/archives">Archive</a> <div class="icon"><span class="icon-arrow-down"></span></div> </li> <li class="item"> <a href="/blog.atom">Feed</a> <div class="icon"><span class="icon-rss"></span></div> </li> </ul> </div> <p></p> <div class="featured-posts"> <div id="#featured" style="margin-bottom: 4px; border-bottom: 1px solid #ccc; font-size: 115%; margin-left: 2px;">Featured Posts</div> <ul style="padding-inline-start: 22px;"> <li style="margin-bottom: 3px;"> <a href="/blog/2024/07/08/async-embedded-engine/" style="font-size: 95%;"> Debezium asynchronous engine </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2024/01/11/Debezium-and-TimescaleDB/" style="font-size: 95%;"> Debezium and TimescaleDB </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2023/12/20/JDBC-sink-connector-batch-support/" style="font-size: 95%;"> Streamlined Performance: Debezium JDBC connector batch support </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2023/10/19/Debezium-Operator-Takes-off-to-the-Clouds/" style="font-size: 95%;"> Debezium Operator Takes off to the Clouds </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2023/10/05/Debezium-JMX-signaling-and-notifications/" style="font-size: 95%;"> Debezium signaling and notifications - Part 3: JMX channel </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2023/09/23/flink-spark-online-learning/" style="font-size: 95%;"> Online machine learning with the data streams from the database </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2023/07/10/custom-http-signaling-notification/" style="font-size: 95%;"> Debezium signaling and notifications - Part 2: Customisation </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2023/06/27/Debezium-signaling-and-notifications/" style="font-size: 95%;"> Debezium signaling and notifications - Part 1 </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2023/05/02/tensorflow-mnist-classification/" style="font-size: 95%;"> Image classification with Debezium and TensorFlow </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2020/11/04/streaming-vitess-at-bolt/" style="font-size: 95%;"> Streaming Vitess at Bolt </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2020/02/10/event-sourcing-vs-cdc/" style="font-size: 95%;"> Distributed Data for Microservices — Event Sourcing vs. Change Data Capture </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2019/10/01/audit-logs-with-change-data-capture-and-stream-processing/" style="font-size: 95%;"> Building Audit Logs with Change Data Capture and Stream Processing </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2019/07/12/streaming-cassandra-at-wepay-part-1/" style="font-size: 95%;"> Streaming Cassandra at WePay - Part 1 </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2019/02/19/reliable-microservices-data-exchange-with-the-outbox-pattern/" style="font-size: 95%;"> Reliable Microservices Data Exchange With the Outbox Pattern </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/12/05/automating-cache-invalidation-with-change-data-capture/" style="font-size: 95%;"> Automating Cache Invalidation With Change Data Capture </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/09/20/materializing-aggregate-views-with-hibernate-and-debezium/" style="font-size: 95%;"> Materializing Aggregate Views With Hibernate and Debezium </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/07/19/advantages-of-log-based-change-data-capture/" style="font-size: 95%;"> Five Advantages of Log-Based Change Data Capture </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/03/08/creating-ddd-aggregates-with-debezium-and-kafka-streams/" style="font-size: 95%;"> Creating DDD aggregates with Debezium and Kafka Streams </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/01/17/streaming-to-elasticsearch/" style="font-size: 95%;"> Streaming Data Changes from Your Database to Elasticsearch </a> </li> </ul> </div> <p></p> <p></p> <div class="cloud-tags"> <div id="tags" style="margin-bottom: 4px; border-bottom: 1px solid #ccc; font-size: 115%; margin-left: 2px;"> Tags </div> <div class="tag-cloud"> <span class="site-tag"> <a href="/tag/apache-kafka/" style="font-size: 82%"> apache kafka </a> </span> <span class="site-tag"> <a href="/tag/apache-kafka/" style="font-size: 96%"> apache kafka </a> </span> <span class="site-tag"> <a href="/tag/apicurio/" style="font-size: 82%"> apicurio </a> </span> <span class="site-tag"> <a href="/tag/avro/" style="font-size: 84%"> avro </a> </span> <span class="site-tag"> <a href="/tag/aws/" style="font-size: 82%"> aws </a> </span> <span class="site-tag"> <a href="/tag/batch/" style="font-size: 82%"> batch </a> </span> <span class="site-tag"> <a href="/tag/caassandra/" style="font-size: 86%"> caassandra </a> </span> <span class="site-tag"> <a href="/tag/camel/" style="font-size: 82%"> camel </a> </span> <span class="site-tag"> <a href="/tag/cassandra/" style="font-size: 302%"> cassandra </a> </span> <span class="site-tag"> <a href="/tag/cdc/" style="font-size: 82%"> cdc </a> </span> <span class="site-tag"> <a href="/tag/channels/" style="font-size: 82%"> channels </a> </span> <span class="site-tag"> <a href="/tag/community/" style="font-size: 124%"> community </a> </span> <span class="site-tag"> <a href="/tag/community-stories/" style="font-size: 84%"> community stories </a> </span> <span class="site-tag"> <a href="/tag/connectors/" style="font-size: 82%"> connectors </a> </span> <span class="site-tag"> <a href="/tag/containers/" style="font-size: 82%"> containers </a> </span> <span class="site-tag"> <a href="/tag/cqrs/" style="font-size: 84%"> cqrs </a> </span> <span class="site-tag"> <a href="/tag/custom/" style="font-size: 82%"> custom </a> </span> <span class="site-tag"> <a href="/tag/datalake/" style="font-size: 82%"> datalake </a> </span> <span class="site-tag"> <a href="/tag/db2/" style="font-size: 286%"> db2 </a> </span> <span class="site-tag"> <a href="/tag/ddd/" style="font-size: 82%"> ddd </a> </span> <span class="site-tag"> <a href="/tag/debezium/" style="font-size: 108%"> debezium </a> </span> <span class="site-tag"> <a href="/tag/debezium-server/" style="font-size: 94%"> debezium server </a> </span> <span class="site-tag"> <a href="/tag/debezium-ui/" style="font-size: 90%"> debezium ui </a> </span> <span class="site-tag"> <a href="/tag/deduplication/" style="font-size: 82%"> deduplication </a> </span> <span class="site-tag"> <a href="/tag/discussion/" style="font-size: 114%"> discussion </a> </span> <span class="site-tag"> <a href="/tag/docker/" style="font-size: 188%"> docker </a> </span> <span class="site-tag"> <a href="/tag/elasticsearch/" style="font-size: 82%"> elasticsearch </a> </span> <span class="site-tag"> <a href="/tag/event-sourcing/" style="font-size: 82%"> event sourcing </a> </span> <span class="site-tag"> <a href="/tag/exactly-once-semantics/" style="font-size: 82%"> exactly once semantics </a> </span> <span class="site-tag"> <a href="/tag/example/" style="font-size: 88%"> example </a> </span> <span class="site-tag"> <a href="/tag/examples/" style="font-size: 118%"> examples </a> </span> <span class="site-tag"> <a href="/tag/features/" style="font-size: 94%"> features </a> </span> <span class="site-tag"> <a href="/tag/fedora/" style="font-size: 82%"> fedora </a> </span> <span class="site-tag"> <a href="/tag/flink/" style="font-size: 84%"> flink </a> </span> <span class="site-tag"> <a href="/tag/hiring/" style="font-size: 84%"> hiring </a> </span> <span class="site-tag"> <a href="/tag/ibmi/" style="font-size: 110%"> ibmi </a> </span> <span class="site-tag"> <a href="/tag/iceberg/" style="font-size: 82%"> iceberg </a> </span> <span class="site-tag"> <a href="/tag/images/" style="font-size: 82%"> images </a> </span> <span class="site-tag"> <a href="/tag/informix/" style="font-size: 120%"> informix </a> </span> <span class="site-tag"> <a href="/tag/integration/" style="font-size: 86%"> integration </a> </span> <span class="site-tag"> <a href="/tag/introduction/" style="font-size: 84%"> introduction </a> </span> <span class="site-tag"> <a href="/tag/jaeger/" style="font-size: 82%"> jaeger </a> </span> <span class="site-tag"> <a href="/tag/jdbc/" style="font-size: 122%"> jdbc </a> </span> <span class="site-tag"> <a href="/tag/json/" style="font-size: 82%"> json </a> </span> <span class="site-tag"> <a href="/tag/kafka/" style="font-size: 94%"> kafka </a> </span> <span class="site-tag"> <a href="/tag/kafka-streams/" style="font-size: 82%"> kafka streams </a> </span> <span class="site-tag"> <a href="/tag/kafka-streams/" style="font-size: 86%"> kafka streams </a> </span> <span class="site-tag"> <a href="/tag/kogito/" style="font-size: 82%"> kogito </a> </span> <span class="site-tag"> <a href="/tag/ksql/" style="font-size: 82%"> ksql </a> </span> <span class="site-tag"> <a href="/tag/kubernetes/" style="font-size: 86%"> kubernetes </a> </span> <span class="site-tag"> <a href="/tag/lakehouse/" style="font-size: 82%"> lakehouse </a> </span> <span class="site-tag"> <a href="/tag/machine-learning/" style="font-size: 86%"> machine learning </a> </span> <span class="site-tag"> <a href="/tag/mariadb/" style="font-size: 118%"> mariadb </a> </span> <span class="site-tag"> <a href="/tag/microservices/" style="font-size: 84%"> microservices </a> </span> <span class="site-tag"> <a href="/tag/mongo/" style="font-size: 86%"> mongo </a> </span> <span class="site-tag"> <a href="/tag/mongodb/" style="font-size: 304%"> mongodb </a> </span> <span class="site-tag"> <a href="/tag/mysql/" style="font-size: 440%"> mysql </a> </span> <span class="site-tag"> <a href="/tag/news/" style="font-size: 112%"> news </a> </span> <span class="site-tag"> <a href="/tag/newsletter/" style="font-size: 88%"> newsletter </a> </span> <span class="site-tag"> <a href="/tag/notifications/" style="font-size: 86%"> notifications </a> </span> <span class="site-tag"> <a href="/tag/online-learning/" style="font-size: 84%"> online learning </a> </span> <span class="site-tag"> <a href="/tag/operator/" style="font-size: 84%"> operator </a> </span> <span class="site-tag"> <a href="/tag/oracle/" style="font-size: 336%"> oracle </a> </span> <span class="site-tag"> <a href="/tag/outbox/" style="font-size: 274%"> outbox </a> </span> <span class="site-tag"> <a href="/tag/performance/" style="font-size: 82%"> performance </a> </span> <span class="site-tag"> <a href="/tag/postgres/" style="font-size: 410%"> postgres </a> </span> <span class="site-tag"> <a href="/tag/presentation/" style="font-size: 84%"> presentation </a> </span> <span class="site-tag"> <a href="/tag/production/" style="font-size: 82%"> production </a> </span> <span class="site-tag"> <a href="/tag/quarkus/" style="font-size: 92%"> quarkus </a> </span> <span class="site-tag"> <a href="/tag/questdb/" style="font-size: 82%"> questdb </a> </span> <span class="site-tag"> <a href="/tag/rds/" style="font-size: 84%"> rds </a> </span> <span class="site-tag"> <a href="/tag/releases/" style="font-size: 422%"> releases </a> </span> <span class="site-tag"> <a href="/tag/schema/" style="font-size: 82%"> schema </a> </span> <span class="site-tag"> <a href="/tag/scylla/" style="font-size: 82%"> scylla </a> </span> <span class="site-tag"> <a href="/tag/secrets/" style="font-size: 82%"> secrets </a> </span> <span class="site-tag"> <a href="/tag/sentry/" style="font-size: 82%"> sentry </a> </span> <span class="site-tag"> <a href="/tag/serialization/" style="font-size: 82%"> serialization </a> </span> <span class="site-tag"> <a href="/tag/signaling/" style="font-size: 86%"> signaling </a> </span> <span class="site-tag"> <a href="/tag/smt/" style="font-size: 84%"> smt </a> </span> <span class="site-tag"> <a href="/tag/snapshots/" style="font-size: 84%"> snapshots </a> </span> <span class="site-tag"> <a href="/tag/spanner/" style="font-size: 162%"> spanner </a> </span> <span class="site-tag"> <a href="/tag/spark/" style="font-size: 84%"> spark </a> </span> <span class="site-tag"> <a href="/tag/sql/" style="font-size: 84%"> sql </a> </span> <span class="site-tag"> <a href="/tag/sqlserver/" style="font-size: 350%"> sqlserver </a> </span> <span class="site-tag"> <a href="/tag/tensorflow/" style="font-size: 82%"> tensorflow </a> </span> <span class="site-tag"> <a href="/tag/testcontainers/" style="font-size: 88%"> testcontainers </a> </span> <span class="site-tag"> <a href="/tag/tests/" style="font-size: 82%"> tests </a> </span> <span class="site-tag"> <a href="/tag/time-series/" style="font-size: 82%"> time series </a> </span> <span class="site-tag"> <a href="/tag/timescaledb/" style="font-size: 82%"> timescaledb </a> </span> <span class="site-tag"> <a href="/tag/topics/" style="font-size: 82%"> topics </a> </span> <span class="site-tag"> <a href="/tag/tracing/" style="font-size: 82%"> tracing </a> </span> <span class="site-tag"> <a href="/tag/transactions/" style="font-size: 82%"> transactions </a> </span> <span class="site-tag"> <a href="/tag/ui/" style="font-size: 82%"> ui </a> </span> <span class="site-tag"> <a href="/tag/vagrant/" style="font-size: 82%"> vagrant </a> </span> <span class="site-tag"> <a href="/tag/vitess/" style="font-size: 266%"> vitess </a> </span> <span class="site-tag"> <a href="/tag/website/" style="font-size: 84%"> website </a> </span> </div> </div> </div> </div> </div> <div class="col-md-9"> <div class="post"> <div class="row" style="margin-left: 0; margin-right: 0; margin-bottom: 10px"> <div class="col-sm-12" style="padding-left: 0px"> <div style="display: table-cell; vertical-align: top"> <div style=" width: 72px; border: 1px solid #ccc; padding: 3px; display: inline-block; "> <img src="/assets/images/vjuranek.jpg" style="width: 64px;"> </div> </div> <div style="display: table-cell; vertical-align: top"> <div style="margin-left: 8px"> <span class="hidden-sm hidden-xs" style="font-size: 2.75rem; line-height: 1"> <a href="/blog/2024/07/08/async-embedded-engine/">Debezium asynchronous engine</a> </span> <span class="hidden-md hidden-lg" style="font-size: 2rem; line-height: 1"> <a href="/blog/2024/07/08/async-embedded-engine/">Debezium asynchronous engine</a> </span> <div class="byline" style="line-height: 1"> <em> July 8, 2024 by </em> <em> Vojtěch Juránek </em> <div class="hidden-xs" style="margin-top: 5px"> <a class="label label-info hidden-sm hidden-xs" href="/tag/machine-learning/">machine-learning</a> <a class="label label-info hidden-sm hidden-xs" href="/tag/flink/">flink</a> <a class="label label-info hidden-sm hidden-xs" href="/tag/spark/">spark</a> <a class="label label-info hidden-sm hidden-xs" href="/tag/online-learning/">online-learning</a> <a class="label label-info hidden-sm hidden-xs" href="/tag/examples/">examples</a> <a class="label label-info hidden-sm hidden-xs" href="/tag/apache-kafka/">apache-kafka</a> </div> </div> </div> </div> </div> </div> <div class="grid__item width-12-12"><div class="paragraph"> <p>Debezium provides a way to run the connectors directly within Debezium from the very beginning of the project. The way how it was provided has changed over the time and it still evolves. This article will describe another evolution step in this regard - new implementation of Debezium engine.</p> </div> <div class="paragraph"> <p></p> </div> <div class="sect1"> <h2 id="a_bit_of_history">A bit of history</h2> <div class="sectionbody"> <div class="paragraph"> <p>The capability to run the connector directly within Debezium was not present from the first Debezium commit, but was <a href="https://github.com/debezium/debezium/commit/2da5b37f767393847f2ee25a1465e501b5633473">added</a> really very early in the Debezium development as part of <a href="https://issues.redhat.com/browse/DBZ-1">DBZ-1</a>. This <code>EmbeddedEngine</code> was used mostly for testing. However, over the time it has evolved into a full-fledged runtime platform for the connectors, with the support for storing offsets, schema history etc. Later on, a public API for <code>DebeziumEngine</code> was defined ( <a href="https://issues.redhat.com/browse/DBZ-234">DBZ-234</a>). The interface decoupled the user-facing API from the implementation and provided the ability to replace the implementation by a different one. Shortly after introducing the Debezium engine API, a new Debezium server was created as part of <a href="https://issues.redhat.com/browse/DBZ-651">DBZ-651</a>. While <code>EmbeddedEngine</code> had to be wrapped into another application which would consume the records, the Debezium server provided a way to run Debezium outside the Kafka Connect cluster without such a wrapper. The Debezium server provided several sinks, so the users could use the server out-of-the-box without any further coding, but the Debezium server is still powered by the Debezium engine. As the popularity of the Debezium server increased, more and more sinks were added. This resulted in the separating Debezium server into <a href="https://github.com/debezium/debezium-server/">separate GitHub project</a>. The separation of the Debezium server repository happened relatively recently (<a href="https://issues.redhat.com/browse/DBZ-6049">DBZ-6049</a>). The latest addition to the Debezium server evolution was implementation of <a href="https://github.com/debezium/debezium-operator">Debezium operator</a>. It allows seamless deployment and management of the Debezium server on the Kubernetes clusters. You can check <a href="https://debezium.io/blog/2023/10/19/Debezium-Operator-Takes-off-to-the-Clouds/">this blog post</a> for more details.</p> </div> <div class="paragraph"> <p>To sum-up, currently, if the user wants to run Debezium connectors outside the Kafka Connect cluster, there are three options. Users can embed the Debezium engine directly into their application or users can use a standalone Debezium server or, when run on the Kubernetes cluster, users can deploy the Debezium server via Debezium operator. However, no matter which deployment method the users use, all the hard work is done by <code>DebeziumEngine</code> implementation after all.</p> </div> </div> </div> <div class="sect1"> <h2 id="embeddedengine_limitations"><code>EmbeddedEngine</code> limitations</h2> <div class="sectionbody"> <div class="paragraph"> <p>As described in the previous section, if you decide to run Debezium outside the Kafka Connect cluster, the most important part (in terms of performance, sustainability etc.) is <code>DebeziumEngine</code> implementation. Up until recently, the only available implementation of <code>DebeziumEngine</code> was <a href="https://github.com/debezium/debezium/blob/2.7/debezium-embedded/src/main/java/io/debezium/embedded/EmbeddedEngine.java#L86"><code>EmbeddedEngine</code></a>. As also mentioned, <code>EmbeddedEngine</code> was originally implemented as a testing framework to make testing of the connectors easy, without the need to start the whole Kafka cluster. As such, <code>EmbeddedEngine</code> was not designed for the best performance or even production use. During the time, various improvements were done, but some original designs and code structure remained more or less the same.</p> </div> <div class="paragraph"> <p>The main limitation of the <code>EmbeddedEngine</code> is that it can run only one task. Therefore, if you have a connector which supports execution of multiple tasks (SQL server connector), you cannot use multiple tasks in <code>EmbeddedEngine</code> and still have to run everything in one task. Moreover, all the records are processed in a single thread. This means that the chain of single message transforms (SMTs), serialization as well as processing by the user handler is happening in a synchronous manner, as depicted on the figure below.</p> </div> <div class="imageblock centered-image"> <img src="/assets/images/2024-07-08-async-embedded-engine/synchronous_processing.png" class="responsive-image" alt="Synchronous record processing in EmbeddedEngine"> </div> <div class="paragraph"> <p>Once the whole pipeline is finished for the one record in the batch, only after that another record is processed. This mimics the behavior of Kafka Connect, which also does the source record processing in a serial manner.</p> </div> <div class="paragraph"> <p>From our performance tests as well as from the users reports on the Zulip chat, it seems that especially serialization is often a performance bottleneck. Naturally, one can immediately suggest running at least parts of the workloads, like serialization, in parallel. This would however require substantial changes in <code>EmbeddedEngine</code>. Current code structure of <code>EmbeddedEngine</code> was also far from perfect. Doing any changes e.g. in the retry mechanism was quite challenging and error prone. This led us to a decision to implement the <code>DebeziumEngine</code> API from scratch and create a new implementation of Debezium engine. Besides starting on a green field, it also gave us the comfort of testing the new engine only with a smaller part of the test suite and switching to new engine implementation gradually, always having an option to switch back to <code>EmbeddedEngine</code> as a backup. As a result <a href="https://github.com/debezium/debezium/blob/2.7/debezium-embedded/src/main/java/io/debezium/embedded/async/AsyncEmbeddedEngine.java#L89"><code>AsyncEmbeddedEngine</code></a> was created.</p> </div> </div> </div> <div class="sect1"> <h2 id="asynchronous_embedded_engine">Asynchronous embedded engine</h2> <div class="sectionbody"> <div class="paragraph"> <p><a href="https://github.com/debezium/debezium/blob/2.7/debezium-embedded/src/main/java/io/debezium/embedded/async/AsyncEmbeddedEngine.java#L89"><code>AsyncEmbeddedEngine</code></a> is a new implementation of the <code>DebeziumEngine</code> interface. It addresses the main shortcomings of <code>EmbeddedEngine</code> as outlined in the previous section. Asynchronous engine allows connectors to execute multiple tasks. Most importantly, as the name suggests, aims to run record processing in parallel.</p> </div> <div class="sect2"> <h3 id="architecture">Architecture</h3> <div class="paragraph"> <p>From the high-level perspective there are two thread pools, a smaller one for managing tasks and bigger one for processing records. The size of the task thread pool corresponds to the number of configured tasks - each task has its own dedicated thread. The size of the record processing thread pool is also configurable, however, threads from this thread pool are shared across all the running tasks.</p> </div> <div class="paragraph"> <p>Records in an asynchronous engine are processed in parallel. To which extent the processing is parallelized depends on configuration. <code>DebeziumEngine</code> API offers two possibilities how to consume the changes: either via <a href="https://github.com/debezium/debezium/blob/2.7/debezium-api/src/main/java/io/debezium/engine/DebeziumEngine.java#L159"><code>ChangeConsumer</code></a> or via <a href="https://github.com/debezium/debezium/blob/2.7/debezium-api/src/main/java/io/debezium/engine/DebeziumEngine.java#L191"><code>java.util.function.Consumer</code></a> function. In the first case <code>ChangeConsumer</code> expects the whole batch of records as we can run in parallel only SMT chain and serialization. Once all the records in the batch are processed, the whole batch is passed to the user-defined <code>ChangeConsumer</code>.</p> </div> <div class="imageblock centered-image"> <img src="/assets/images/2024-07-08-async-embedded-engine/parallel_processing_batch.png" class="responsive-image" alt="Parallel processing of the whole batch"> </div> <div class="paragraph"> <p>In the later case, when user provides only consumer function which processes just one record, we can run in parallel the whole record processing pipeline:</p> </div> <div class="imageblock centered-image"> <img src="/assets/images/2024-07-08-async-embedded-engine/parallel_processing_async.png" class="responsive-image" alt="Asynchronous parallel processing"> </div> <div class="paragraph"> <p>Pipelines can be processed in the same order as the original batch of the source records provided by the connector task or they can be processed completely asynchronously. Asynchronous processing of the whole pipeline means that the records could be sent to the sink in a different order than the changes were done in the source database. However, in some cases the order doesn&#8217;t matter (e.g. bulk inserts of distinct data) and what matters is speed of processing. Such use cases should be addressed by this setup.</p> </div> <div class="paragraph"> <p>This was a very high level overview of the asynchronous engine, which is required to fully understand configuration options described in the next section. If you are interested in more details, please see <a href="https://github.com/debezium/debezium-design-documents/blob/main/DDD-7.md">Design document for asynchronous engine</a>. And of course the most precise and up-to-date source of information is <a href="https://github.com/debezium/debezium/tree/main/debezium-embedded/src/main/java/io/debezium/embedded/async">the source code</a>.</p> </div> </div> <div class="sect2"> <h3 id="usage">Usage</h3> <div class="paragraph"> <p>As <code>AsyncEmbeddedEngine</code> implements the same interface as <code>EmbeddedEngine</code>, the usage is also the same:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">DebeziumEngine&lt;<span class="predefined-type">ChangeEvent</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;&gt; engine = DebeziumEngine
            .create(KeyValueHeaderChangeEventFormat.of(Json.class, Json.class, Json.class), <span class="string"><span class="delimiter">&quot;</span><span class="content">io.debezium.embedded.async.ConvertingAsyncEngineBuilderFactory</span><span class="delimiter">&quot;</span></span>)
            .using(props)
            .notifying(record -&gt; {
                <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Key = '</span><span class="delimiter">&quot;</span></span> + record.key() + <span class="string"><span class="delimiter">&quot;</span><span class="content">' value = '</span><span class="delimiter">&quot;</span></span> + record.value() + <span class="string"><span class="delimiter">&quot;</span><span class="content">'</span><span class="delimiter">&quot;</span></span>);
            }).build();

<span class="predefined-type">ExecutorService</span> executor = <span class="predefined-type">Executors</span>.newSingleThreadExecutor();
executor.execute(engine);</code></pre> </div> </div> <div class="paragraph"> <p>If you want to use <code>AsyncEmbeddedEngine</code>, for now you have to use <code>create(KeyValueHeaderChangeEventFormat&lt;K, V, H&gt; format, String builderFactory)</code> method with <code>io.debezium.embedded.async.ConvertingAsyncEngineBuilderFactory</code> as the builder factory. Other shortcut builder methods still point to <code>EmbeddedEngine</code>.</p> </div> <div class="paragraph"> <p>Once you are done and want to terminate the engine, you call <code>engine.close()</code> as in the case of <code>EmbeddedEngine</code>. The main difference here is that once the <code>AsyncEmbeddedEngine</code> is closed, it cannot be started again and has to be re-created. The reason for this is to prevent possible resource leaks when the engine is being stopped and started from different threads in parallel (you can find more details in the design document and <a href="https://issues.redhat.com/browse/DBZ-2534">DBZ-2534</a>).</p> </div> </div> <div class="sect2"> <h3 id="configuration_options">Configuration options</h3> <div class="paragraph"> <p>Compared to <code>EmbeddedEngine</code>, <code>AsyncEmbeddedEngine</code> provides only a few additional configuration options, mostly related to thread management:</p> </div> <div class="ulist"> <ul> <li> <p><code>record.processing.threads</code> - The size of the thread pool for record processing.</p> </li> <li> <p><code>record.processing.order</code> - Determines how the records should be produced, either <code>ORDERED</code> or <code>UNORDERED</code>.</p> </li> <li> <p><code>record.processing.with.serial.consumer</code> - Specifies whether the default <code>ChangeConsumer</code> should be created from the provided <code>Consumer</code>.</p> </li> <li> <p><code>record.processing.shutdown.timeout.ms</code> - Maximum time in milliseconds to wait for processing submitted records after a task shutdown is called.</p> </li> <li> <p><code>task.management.timeout.ms</code> - Time limit engine waits for a task’s lifecycle management operations (starting and stopping) to complete.</p> </li> </ul> </div> <div class="paragraph"> <p><code>record.processing.threads</code> is quite clear, it&#8217;s the size of the shared thread pool used for processing records. You can use the <code>AVAILABLE_CORES</code> placeholder to use all available cores on the given machine.</p> </div> <div class="paragraph"> <p><code>record.processing.order</code> - as described above, the records can be processed in the same order as the changes happened in the database or in a completely asynchronous manner which results in out-of-order delivery of the records to the sink. Which method is used is determined by this option. Please note that this option has any effect only in the case when user handler is provided as a <code>Consumer</code> function. As explained in the previous section, <code>ChangeConsumer</code> expects the whole batch of records and therefore the Debezium engine cannot ensure processing of individual records in parallel and setting it to <code>UNORDERED</code> processing has no sense in this case.</p> </div> <div class="paragraph"> <p><code>record.processing.with.serial.consumer</code> determines, if the default <code>ChangeConsumer</code> should be created from user provided <code>Consumer</code> function. This is basically an option for backward compatibility with the <code>EmbeddedEngine</code>. In case of <code>EmbeddedEngine</code> is always used <code>ChangeConsumer</code> and if the user provides the <code>Consumer</code> function interested, <code>EmbeddedEngine</code> creates default <code>ChangeConsumer</code>. When you enable this option, <code>AsyncEmbeddedEngine</code> does the same and creates the same <code>ChangeConsumer</code> as <code>EmbeddedEngine</code>, so you can get completely the same behavior as in case of <code>EmbeddedEngine</code>.</p> </div> <div class="paragraph"> <p><code>record.processing.shutdown.timeout.ms</code> specifies for how long the engine should wait for processing of submitted records. Once shutdown is called, no other records are submitted for processing, but you may want to wait for records already being processed. As processing of the records in general should be fast, this can be some smaller value (from dozen milliseconds to units of seconds).</p> </div> <div class="paragraph"> <p><code>task.management.timeout.ms</code> determines the timeout for the task to start or stop. If the timeout is exceeded, the thread running the task is forcefully killed. When this timeout is exceeded during the startup and task is killed, all other tasks are killed as well. Either all the tasks have to start or none of them. Compared to <code>record.processing.shutdown.timeout.ms</code>, starting of the tasks can be quite time consuming (creating connections to the database etc.), so in this case the timeout should be substantially higher than timeout for record processing (possibly in terms of minutes).</p> </div> </div> <div class="sect2"> <h3 id="debezium_server_usage">Debezium server usage</h3> <div class="paragraph"> <p>Starting Debezium 2.6.0.Alpha2, Debezium server was <a href="https://github.com/debezium/debezium-server/commit/aa58bc511596ac09f63d77c77fd5c8900afaed48">switched</a> to use <code>AsyncEmbeddedEngine</code>. Thus, if you use Debezium server 2.6.0.Alpha2 or later, you already use the asynchronous engine. As the Debezium engine currently uses only <code>ChangeConsumer</code> for processing CDC records, all constraints related to usage of <code>ChangeConsumer</code> mentioned above (impossibility to process records out of order) applies to the Debezium server as well. This can change in the future, but at the moment we don&#8217;t see any demand for it.</p> </div> </div> </div> </div> <div class="sect1"> <h2 id="deprecation_of_embeddedengine">Deprecation of <code>EmbeddedEngine</code></h2> <div class="sectionbody"> <div class="paragraph"> <p>As of Debezium 2.7.0.Final, <code>EmbeddedEngine</code> was deprecated (<a href="https://issues.redhat.com/browse/DBZ-7976">DBZ-7976</a>). We will keep it for about next 6 months. During this time we are going to migrate rest of our test suite to asynchronous engine (<a href="https://issues.redhat.com/browse/DBZ-7977">DBZ-7977</a>) and then remove <code>EmbeddedEngine</code> in Debezium 3.1.0.Final (<a href="https://issues.redhat.com/browse/DBZ-8029">DBZ-8029</a>). If you use the <code>DebeziumEngine</code> API, the migration should be very straightforward. The only thing you need to do if you use the converting wrapper is to switch from <code>ConvertingEngineBuilderFactory</code> to <code>ConvertingAsyncEngineBuilderFactory</code>, as described in the previous chapter. However, we would strongly recommend switching to the asynchronous engine sooner rather than later and eventually let us know if you spot any issue, so that we have sufficient time to fix any such issue before final removal of <code>EmbeddedEngine</code>.</p> </div> </div> </div> <div class="sect1"> <h2 id="future_steps_and_outlook">Future steps and outlook</h2> <div class="sectionbody"> <div class="paragraph"> <p>Besides the aforementioned removal of <code>EmbeddedEngine</code>, are we done with the changes or do we plan any further changes? Sure we plan to continue with the improvements! So what can you look for?</p> </div> <div class="paragraph"> <p>With Debezium 3.0 we will switch to Java 21 for building Debezium and in the future releases Java 21 will become Debezium base line. With this, we would like to switch to Java <a href="https://docs.oracle.com/en/java/javase/21/core/virtual-threads.html">virtual threads</a>. This may bring even more speedup and eventually also simplify the code a little bit. We will evaluate this option based on the results of our internal performance tests.</p> </div> <div class="paragraph"> <p>Speaking about performance tests, one may ask why at least some performance comparison is not mentioned in this blog post. We of course did some performance tests, we do have a some <a href="https://github.com/debezium/debezium/tree/main/debezium-microbenchmark-engine/src/main/java/io/debezium/performance/engine">JMH benchmarks</a> (PRs with improvements are welcome!) and also did some end-to-end performance tests. You can find some JMH results e.g. under <a href="https://github.com/debezium/debezium/pull/5494">this pull request</a>, which also compares the results with <code>EmbeddedEngine</code>. On the other hand, we are fully aware of complexity and trickiness of performance testing and we believe having some solid results requires still some more work. It would deserve its own blog post anyway. After all, even with very solid performance results, the reality of your deployment may still be different, so what really matters is your performance tests, done on your hardware, your production network setup etc. If you do so, we would be more than happy to hear the results.</p> </div> <div class="paragraph"> <p>As for other things, we may add more implementations of <a href="https://github.com/debezium/debezium/blob/main/debezium-embedded/src/main/java/io/debezium/embedded/async/RecordProcessor.java">RecordProcessor</a>s, e.g. one suggested by <a href="https://github.com/jeremy-l-ford">Jeremy Ford</a> in <a href="https://github.com/debezium/debezium-design-documents/pull/8#issuecomment-1859321629">the discussion</a> under the asynchronous engine DDD.</p> </div> <div class="paragraph"> <p>In the longer term, we would like to add support for gRPC and Protocol Buffers. It should give us a two-fold advantage: Debezium engine should be able to coordinate execution of multiple tasks across different machines and also would be able to receive CDC records from them in the unified format. Ability to run multiple tasks (for connectors which allow it) on separate machines/containers is crucial especially in environments like Kubernetes, where you ideally want to run each task in a separate container. Defining Protocol Buffers format would allow Debezium to work with all kinds of connectors, written even in different languages and running on a large variety of devices, even on the edge, allowing the Debezium engine to become the heart of any CDC solution.</p> </div> <div class="paragraph"> <p>These are plans for which you can look forward to in the short and long term future. What we are looking for in the near future is your feedback on the new asynchronous engine. If you have any, please share it via common means on either Debezium <a href="https://debezium.zulipchat.com/">Zulip chat</a> or <a href="https://groups.google.com/forum/#!forum/debezium">mailing list</a>.</p> </div> </div> </div></div> </div> <div class="well"> <div class="row"> <div class="col-md-8"> <h2>Vojtěch Juránek</h2> <p> <span class="bio-size">Vojta is a software engineer at Red Hat. He lives in the Czech Republic.</span> </p> <p class="bio-size"> <a href="https://github.com/vjuranek"> <i class="icon-github"></i> </a> &nbsp; </p> </div> <div class="col-md-4"> <img alt="" class="img-responsive pull-right portrait" src="/assets/images/vjuranek.jpg"/> </div> </div> </div> <ul class="pager pager-blog"> <li class="previous"> <a href="/blog/2024/07/01/debezium-2-7-final-released/" class="previous"> &laquo; Previous</a> </li> <li class="next"><a href="/blog/2024/07/11/debezium-3.0-alpha1-released/">Next &raquo; </a></li> </ul> <div class="row"> <div class="col-md-12"> <hr> <h2>About Debezium</h2> <p> Debezium is an open source distributed platform that turns your existing databases into event streams, so applications can see and respond almost instantly to each committed row-level change in the databases. Debezium is built on top of <a href="http://kafka.apache.org/">Kafka</a> and provides <a href="http://kafka.apache.org/documentation.html#connect">Kafka Connect</a> compatible connectors that monitor specific database management systems. Debezium records the history of data changes in Kafka logs, so your application can be stopped and restarted at any time and can easily consume all of the events it missed while it was not running, ensuring that all events are processed correctly and completely. Debezium is <a href="/license/">open source</a> under the <a href="http://www.apache.org/licenses/LICENSE-2.0.html">Apache License, Version 2.0</a>. </p> </div> </div> <div class="row"> <div class="col-md-12"> <h2>Get involved</h2> <p> We hope you find Debezium interesting and useful, and want to give it a try. Follow us on Twitter <a href="https://twitter.com/debezium">@debezium</a>, <a href="https://debezium.zulipchat.com/#narrow/stream/302529-users">chat with us on Zulip</a>, or join our <a href="https://groups.google.com/forum/#!forum/debezium">mailing list</a> to talk with the community. All of the code is open source <a href="https://github.com/debezium/">on GitHub</a>, so build the code locally and help us improve ours existing connectors and add even more connectors. If you find problems or have ideas how we can improve Debezium, please let us know or <a href="https://issues.redhat.com/projects/DBZ/issues/">log an issue</a>. </p> </div> </div> <div id="disqus_thread"></div> <script>var disqus_config=function(){this.page.url="https://debezium.io/blog/2024/07/08/async-embedded-engine/",this.page.identifier="https://debezium.io/blog/2024/07/08/async-embedded-engine/"};!function(){var e=document,t=e.createElement("script");t.src="https://Debezium.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)}();</script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> </div> </div> </div> <footer class="container"> <div> <div class="row mr-0 ml-0"> <div class="col-md-5 col-md-offset-1"> <h4>Debezium</h4> <p> &#169; 2024 Debezium Community <br/> <br/> <i class="icon-fire"></i> Mixed with <a href="https://getbootstrap.com/">Bootstrap</a>, baked by <a href="https://jekyllrb.com/">Jekyll</a>. <br/> <i class="icon-flag"></i> Website and docs licensed under <a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>. <br/> <i class="icon-flag-alt"></i> Code released under <a href="https://www.apache.org/licenses/LICENSE-2.0.html">Apache License, v2.0</a>. <br/> <i class="icon-file-alt"></i> <a href="https://www.redhat.com/legal/legal_statement.html" title="Terms">Terms</a> | <a href="https://www.redhat.com/legal/privacy_statement.html" title="Privacy Policy">Privacy</a> </p> <p>Rev: <a target="_blank" href="https://github.com/debezium/debezium.github.io/commit/b680432c75512cdf6b79aba4760e72e8186ca78b">b680432</a> </p> </div> <div class="col-md-3"> <h4>Documentation</h4> <ul class="list-unstyled"> <li><a href="/documentation/reference/stable/features.html" title="Features">Features</a></li> <li> <a href="/documentation/reference/stable/install.html" title="Install">Install</a> </li> <li> <a href="/documentation/reference/stable/architecture.html" title="Architecture">Architecture</a> </li> <li><a href="/documentation/faq/" title="FAQ">FAQ</a></li> <li> <a href="/community/contribute/" title="Contribute">Contribute</a> </li> </ul> </div> <div class="col-md-3"> <h4>Connect</h4> <ul class="list-unstyled"> <li><a href="/blog" title="Blog">Blog</a></li> <li> <a href="https://twitter.com/debezium" title="Twitter">Twitter</a> </li> <li><a href="https://github.com/debezium" title="GitHub">GitHub</a></li> <li><a href="https://debezium.zulipchat.com/#narrow/stream/302529-users" title="Chat">Chat</a></li> <li> <a href="https://groups.google.com/forum/#!forum/debezium" title="Google Groups">Google Groups</a> </li> <li> <a href="https://stackoverflow.com/questions/tagged/debezium" title="StackOverflow">StackOverflow</a> </li> </ul> </div> </div> </div> </footer> <div class="container" id="companyfooter"> <div class="redhatlogo"> <a href="https://www.redhat.com/"> <img src="/assets/images/Logo-Red_Hat-Sponsored_By-B-Standard-RGB.svg"/> </a> </div> </div> </div> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-76464546-1"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-76464546-1");</script> <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script> <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script> <script type="text/javascript" src="/assets/javascript/vanilla-back-to-top.min.js"></script> <script type="text/javascript" src="/assets/javascript/highlight.min.js"></script> <script>addBackToTop({scrollDuration:400}),hljs.initHighlightingOnLoad();</script> </body> </html>