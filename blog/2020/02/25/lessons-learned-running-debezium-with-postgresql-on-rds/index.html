<!DOCTYPE html>
<html>

<head>
  <title>Lessons Learned from Running Debezium with PostgreSQL on Amazon RDS</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Debezium is an open source distributed platform for change data capture. Start it up, point it at your databases, and your apps can start responding to all of the inserts, updates, and deletes that other apps commit to your databases. Debezium is durable and fast, so your apps can respond quickly and never miss an event, even when things go wrong.">
  <link rel="alternate" type="application/rss+xml" title="Debezium Blog" href="/blog.atom">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/assets/css/bootstrap.min.css" />
  <link rel="stylesheet" href="/assets/css/custom.css" />
  
</head>

<body class="post">
  <div id="rhbar">
  <a class="jbdevlogo" href="https://developers.redhat.com"></a>
  <a class="rhlogo" href="https://www.redhat.com/"></a>
</div>

  <div id>
    <div class="container" id="content">
      <nav class="navbar navbar-inverse navbar-fix">
  <div class="container-fluid">
    <div class="navbar-header">
      <button class="navbar-toggle collapsed border-0" type="button" data-toggle="collapse" data-target="#navigation"
        aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/"><img class="project-logo" src="/assets/images/color_white_debezium_type_600px.svg" style="height: 32px; margin-right: 5px; margin-top: -5px;"></a>
    </div>
    <div class="collapse navbar-collapse collapsed" id="navigation">
      <ul class="nav navbar-nav pull-right">
        
            <li>
          
          <a href="/documentation/faq" class="">FAQ</a>
        </li>
        
            <li class="item">
          
          <a href="/documentation/" class="">Documentation</a>
        </li>
        
            <li>
          
          <a href="/releases/" class="">Releases</a>
        </li>
        
            <li>
          
            <a href="/community/" class="">Community</a>
        </li>
        
          <li class="active">
            
          <a href="/blog/" class="active">Blog</a>
        </li>
      </ul>
    </div>
  </div>
</nav>
        
          <div class="row post-text-padding row-no-expand">
  <!-- Sidebar -->
  <div class="col-md-3"><div id="leftdocnav">
  <div class="hidden-lg hidden-md hidden-sm">
    <button
      class="navbar-toggle docssubmenu-toggle collapsed"
      data-target="#docssubmenu"
      data-toggle="collapse"
      style="
        float: none;
        background-color: #656565;
        border-color: #656565;
        width: 100%;
        color: #fff;
      "
    >
      Navigation Menu
    </button>
  </div>
  <div class="collapse" id="docssubmenu">
    <div class="doc-pills">
      <ul class="nav nav-pills nav-stacked">
        <li class="item">
          <a href="/blog">Home</a>
          <div class="icon"><span class="icon-home"></span></div>
        </li>
        
          <li class="item">
        
          <a href="/archives">Archive</a>
          <div class="icon"><span class="icon-arrow-down"></span></div>
        </li>
        <li class="item">
          <a href="/blog.atom">Feed</a>
          <div class="icon"><span class="icon-rss"></span></div>
        </li>
      </ul>
    </div>
    <p></p>
    <div class="featured-posts">
      <div id="#featured" style="margin-bottom: 4px; border-bottom: 1px solid #ccc; font-size: 115%; margin-left: 2px;">Featured Posts</div>
        <ul style="padding-inline-start: 22px;">
          
            
          
            
          
            
            <li style="margin-bottom: 3px;">
              <a href="/blog/2020/11/04/streaming-vitess-at-bolt/" style="font-size: 95%;">
                Streaming Vitess at Bolt
              </a>
            </li>  
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
            <li style="margin-bottom: 3px;">
              <a href="/blog/2020/02/10/event-sourcing-vs-cdc/" style="font-size: 95%;">
                Distributed Data for Microservices â€” Event Sourcing vs. Change Data Capture
              </a>
            </li>  
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
            <li style="margin-bottom: 3px;">
              <a href="/blog/2019/10/01/audit-logs-with-change-data-capture-and-stream-processing/" style="font-size: 95%;">
                Building Audit Logs with Change Data Capture and Stream Processing
              </a>
            </li>  
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
            <li style="margin-bottom: 3px;">
              <a href="/blog/2019/07/12/streaming-cassandra-at-wepay-part-1/" style="font-size: 95%;">
                Streaming Cassandra at WePay - Part 1
              </a>
            </li>  
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
            <li style="margin-bottom: 3px;">
              <a href="/blog/2019/02/19/reliable-microservices-data-exchange-with-the-outbox-pattern/" style="font-size: 95%;">
                Reliable Microservices Data Exchange With the Outbox Pattern
              </a>
            </li>  
            
          
            
          
            
          
            
          
            
          
            
          
            
            <li style="margin-bottom: 3px;">
              <a href="/blog/2018/12/05/automating-cache-invalidation-with-change-data-capture/" style="font-size: 95%;">
                Automating Cache Invalidation With Change Data Capture
              </a>
            </li>  
            
          
            
          
            
          
            
            <li style="margin-bottom: 3px;">
              <a href="/blog/2018/09/20/materializing-aggregate-views-with-hibernate-and-debezium/" style="font-size: 95%;">
                Materializing Aggregate Views With Hibernate and Debezium
              </a>
            </li>  
            
          
            
          
            
          
            
          
            
          
            
            <li style="margin-bottom: 3px;">
              <a href="/blog/2018/07/19/advantages-of-log-based-change-data-capture/" style="font-size: 95%;">
                Five Advantages of Log-Based Change Data Capture
              </a>
            </li>  
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
            <li style="margin-bottom: 3px;">
              <a href="/blog/2018/03/08/creating-ddd-aggregates-with-debezium-and-kafka-streams/" style="font-size: 95%;">
                Creating DDD aggregates with Debezium and Kafka Streams
              </a>
            </li>  
            
          
            
          
            
          
            
          
            
            <li style="margin-bottom: 3px;">
              <a href="/blog/2018/01/17/streaming-to-elasticsearch/" style="font-size: 95%;">
                Streaming Data Changes from Your Database to Elasticsearch
              </a>
            </li>  
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        </ul>
    </div>
    <p></p>
    <p></p>
    <div class="cloud-tags">
      <div id="tags" style="margin-bottom: 4px; border-bottom: 1px solid #ccc; font-size: 115%; margin-left: 2px;"> Tags
      </div>
        <div class="tag-cloud"> 
          
          
          <span class="site-tag">
            <a href="/tag/apache-kafka/" style="font-size: 88%">
              apache kafka
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/apicurio/" style="font-size: 82%">
              apicurio
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/avro/" style="font-size: 84%">
              avro
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/aws/" style="font-size: 82%">
              aws
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/camel/" style="font-size: 82%">
              camel
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/cassandra/" style="font-size: 128%">
              cassandra
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/community/" style="font-size: 102%">
              community
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/cqrs/" style="font-size: 82%">
              cqrs
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/db2/" style="font-size: 108%">
              db2
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/debezium-server/" style="font-size: 86%">
              debezium server
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/discussion/" style="font-size: 112%">
              discussion
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/docker/" style="font-size: 182%">
              docker
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/ebezium-server/" style="font-size: 82%">
              ebezium server
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/elasticsearch/" style="font-size: 82%">
              elasticsearch
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/event-sourcing/" style="font-size: 82%">
              event sourcing
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/example/" style="font-size: 88%">
              example
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/examples/" style="font-size: 102%">
              examples
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/fedora/" style="font-size: 82%">
              fedora
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/integration/" style="font-size: 82%">
              integration
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/introduction/" style="font-size: 84%">
              introduction
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/json/" style="font-size: 82%">
              json
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/kafka/" style="font-size: 86%">
              kafka
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/kafka-streams/" style="font-size: 86%">
              kafka streams
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/kogito/" style="font-size: 82%">
              kogito
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/ksql/" style="font-size: 82%">
              ksql
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/kubernetes/" style="font-size: 82%">
              kubernetes
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/microservices/" style="font-size: 84%">
              microservices
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/mongodb/" style="font-size: 182%">
              mongodb
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/mysql/" style="font-size: 246%">
              mysql
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/news/" style="font-size: 100%">
              news
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/newsletter/" style="font-size: 86%">
              newsletter
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/oracle/" style="font-size: 144%">
              oracle
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/outbox/" style="font-size: 98%">
              outbox
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/postgres/" style="font-size: 216%">
              postgres
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/presentation/" style="font-size: 84%">
              presentation
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/production/" style="font-size: 82%">
              production
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/quarkus/" style="font-size: 90%">
              quarkus
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/rds/" style="font-size: 84%">
              rds
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/releases/" style="font-size: 230%">
              releases
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/schema/" style="font-size: 82%">
              schema
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/secrets/" style="font-size: 82%">
              secrets
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/sentry/" style="font-size: 82%">
              sentry
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/serialization/" style="font-size: 82%">
              serialization
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/smt/" style="font-size: 84%">
              smt
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/sql/" style="font-size: 84%">
              sql
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/sqlserver/" style="font-size: 164%">
              sqlserver
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/testcontainers/" style="font-size: 88%">
              testcontainers
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/topics/" style="font-size: 82%">
              topics
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/vagrant/" style="font-size: 82%">
              vagrant
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/vitess/" style="font-size: 90%">
              vitess
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/website/" style="font-size: 84%">
              website
            </a>
          </span>
          
        </div>
  </div>
  </div>
</div>
</div>
  <div class="col-md-9">
    <div class="post">
      
      <div
        class="row"
        style="margin-left: 0; margin-right: 0; margin-bottom: 10px"
      >
        <div class="col-sm-12" style="padding-left: 0px">
          <div style="display: table-cell; vertical-align: top">
            <div
              style="
                width: 72px;
                border: 1px solid #ccc;
                padding: 3px;
                display: inline-block;
              "
            >
             
                  <img src="/assets/images/hashhar.jpg" style="width: 64px;"> 
                
            </div>
          </div>
          <div style="display: table-cell; vertical-align: top">
            <div style="margin-left: 8px">
              <span
                class="hidden-sm hidden-xs"
                style="font-size: 2.75rem; line-height: 1"
              >
                <a href="/blog/2020/02/25/lessons-learned-running-debezium-with-postgresql-on-rds/">Lessons Learned from Running Debezium with PostgreSQL on Amazon RDS</a>
              </span>
              <span
                class="hidden-md hidden-lg"
                style="font-size: 2rem; line-height: 1"
              >
                <a href="/blog/2020/02/25/lessons-learned-running-debezium-with-postgresql-on-rds/">Lessons Learned from Running Debezium with PostgreSQL on Amazon RDS</a>
              </span>
              <div class="byline" style="line-height: 1">
                
                    
                    <em> February 25, 2020 by </em>
                    <em> Ashhar Hasan </em>
                <div class="hidden-xs" style="margin-top: 5px">
                  
                  <a
                    class="label label-info hidden-sm hidden-xs"
                    href="/tag/aws/"
                    >aws</a
                  >
                  
                  <a
                    class="label label-info hidden-sm hidden-xs"
                    href="/tag/postgres/"
                    >postgres</a
                  >
                  
                  <a
                    class="label label-info hidden-sm hidden-xs"
                    href="/tag/rds/"
                    >rds</a
                  >
                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="grid__item width-12-12"><div class="paragraph">
<p>In this blog post, we are going to discuss how <a href="https://www.delhivery.com/">Delhivery</a>, the leading supply chain services company in India, is using Debezium to power a lot of different business use-cases ranging from driving event driven microservices, providing data integration and moving operational data to a data warehouse for real-time analytics and reporting. We will also take a look at the early mistakes we made when integrating Debezium and how we solved them so that any future users can avoid them, discuss one of the more challenging production incidents we faced and how Debezium helped ensure we could recover without any data loss. In closing, we discuss what value Debezium has provided us, areas where we believe there is a scope for improvement and how Debezium fits into our future goals.</p>
</div>
<div class="paragraph">
<p><!-- more --></p>
</div>
<div class="sect1">
<h2 id="debezium-at-delhivery">Debezium at Delhivery</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We work in the logistics landscape and hence most of the software we write is focused around state - status changes of a shipment, tracking location updates, collecting real time data and reacting to it. The most common place where you might find "state" in any software architecture is the database. We maintain all of our transactional data primarily in a document database like MongoDB and in relational database systems (specifically PostgreSQL) for different services within the organisation. There is a need to allow efficient and near-real time analysis of the transactional data across all the different data sources to allow surfacing insights and looking at the big picture of how the organisation is doing and to make data driven decisions.</p>
</div>
<div class="paragraph">
<p>To solve the above goal, we are using Debezium to perform Change Data Capture on our transactional data to make it available in Kafka, our choice of message broker. Once that data is available in Kafka we can do one or all of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Perform streaming joins or data enrichment across change streams of different relational tables (maybe even from different databases or services altogether. eg. Enriching shipments with trip and vehicle data)</p>
</li>
<li>
<p>Creating domain events from change streams for consumption by downstream services (eg. Creating an aggregate message with order, shipment and product information from three different change streams)</p>
</li>
<li>
<p>Moving the change stream data into a data lake to allow for disaster recovery or replaying part of the data</p>
</li>
<li>
<p>Complex event processing to generate real time metrics and power dashboards (eg. Live count of items in transit, average trip time within each region etc.)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Debezium makes all of those above use-cases possible and very easy to build by providing a common platform and framework to connect our existing data sources like MongoDB, PostgreSQL or MySQL.</p>
</div>
<div class="paragraph">
<p>This article is going to share our learnings with using Debezium on AWS RDS (AWS&#8217;s managed database service) and hopefully help transfer some knowledge we&#8217;ve gained in that process and also document how to skip unparseable records from PostgreSQL&#8217;s WAL until <a href="https://issues.redhat.com/browse/DBZ-1760">DBZ-1760</a> is fixed (already implemented and scheduled for the next Debezium 1.1 preview release).</p>
</div>
<div class="paragraph">
<p>Here&#8217;s a brief architecture overview that shows a few of the use-cases that Debezium is powering and the general data platform.</p>
</div>
<div class="exampleblock centered-image responsive-image">
<div class="content">
<img src="/assets/images/2020-02-25-debezium-on-rds/figure01.png" style="max-width:90%;" class="responsive-image">
<div class="paragraph">
<p><strong>Figure 1. Current Architecture</strong></p>
</div>
</div>
</div>
<div class="paragraph">
<p>But to get to the above was an iterative process which took a lot of experimentation and trial and error.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="debezium-with-postgresql-on-aws-rds">Debezium with PostgreSQL on AWS RDS</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now we are going to discuss some of the learnings from running Debezium with PostgreSQL on AWS RDS. We are not going to focus on how to get started with Debezium with PostgreSQL on RDS since it&#8217;s documented in detail at <a href="https://debezium.io/documentation/reference/1.0/connectors/postgresql.html#amazon-rds">the documentation for the PostgreSQL connector</a>.</p>
</div>
<div class="sect2">
<h3 id="lessons-learnt">Lessons Learnt</h3>
<div class="paragraph">
<p>We started by creating a proof-of-concept whose goal was to listen to changes from 3 different tables within a single PostgreSQL database and create two views downstream, one as the join of the three tables and another view which includes aggregated metrics tracked as a time-series. Both the join and the aggregations were implemented using <a href="https://kafka.apache.org/documentation/streams/">Kafka Streams</a> since it was easier to setup and learn compared to other stream processing frameworks. Since Debezium already provides a very feature rich <a href="https://hub.docker.com/r/debezium/connect">Docker container image</a> we extended that slightly and decided to run the service as containers on AWS&#8217;s Elastic Container Service which is a container orchestration service.</p>
</div>
<div class="paragraph">
<p>There were a few mistakes we made when we were starting out. All of the solutions to our mistakes are now documented in the Debezium documentation but they are all listed together here to make it easier to avoid them.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We initially used the <strong>wal2json</strong> plugin which caused the connector to encounter <strong>OutOfMemoryError</strong> when committing large transactions (transactions whose serialized form uses more memory than available Java Heap space). Hence our recommendation is:</p>
<div class="ulist">
<ul>
<li>
<p>On PostgreSQL &lt; 10, use the <strong>wal2json_streaming</strong> plugin to avoid <strong>OutOfMemoryError</strong> on large transactions.</p>
</li>
<li>
<p>On PostgreSQL &gt;= 10, use the <strong>pgoutput</strong> plugin.</p>
</li>
</ul>
</div>
</li>
<li>
<p>We were producing JSON messages with schemas enabled; this creates larger Kafka records than needed, in particular if schema changes are rare. Hence we decided to disable message schemas by setting <code>key.converter.schemas.enabled</code> and <code>value.converter.schemas.enabled</code> to <code>false</code> to reduce the size of each payload considerably hence saving on network bandwidth and serialization/deserialization costs. The only downside is that we now need to maintain the schema of those messages in an external schema registry.</p>
</li>
<li>
<p>We were observing a few data-types with base64 encoded data. As <a href="https://debezium.io/documentation/reference/1.0/connectors/postgresql.html#decimal-values">documented</a>, that&#8217;s the default for NUMERIC columns, but can be difficult to handle for consumers. To convert to a format that&#8217;s easier to parse at the expense of some accuracy loss, we configured the data type specific properties <a href="https://debezium.io/documentation/reference/1.0/connectors/postgresql.html#data-types">as documented</a>. Specifically, set <code>decimal.handling.mode</code> to <code>string</code> to receive NUMERIC, DECIMAL and equivalent types as a string (eg. "3.14") and set <code>hstore.handling.mode</code> to <code>json</code> to receive HSTORE columns as a JSON string.</p>
</li>
<li>
<p>Always ensure basic hygiene checks like database disk usage, transaction logs disk usage and network and disk bandwidth being used for read and write operations. No alarms were set up on the transaction logs disk usage on the database. We added alarms on the RDS metric <strong>TransactionLogsDiskUsage</strong> and <strong>OldestReplicationSlotLag</strong> to alert us when the transaction logs disk usage increased above a threshold or when a replication slot started lagging - meaning that Debezium might have died.</p>
</li>
<li>
<p>We had not enabled heartbeats in Debezium. Heartbeats are needed to control the <a href="https://debezium.io/documentation/reference/1.0/connectors/postgresql.html#wal-disk-space">WAL disk space consumption</a> in the following cases:</p>
<div class="ulist">
<ul>
<li>
<p>There are many updates in a monitored database but only a minuscule amount relates to the monitored table(s) and/or schema(s). We handled this case by enabling heartbeats by setting <code>heartbeat.interval.ms</code>.</p>
</li>
<li>
<p>The PostgreSQL instance contains multiple databases where the monitored database is low-traffic in comparison to the others. Since the WAL is shared by all databases in an instance it keeps accumulating data which cannot be removed until Debezium reads it. But since the high traffic databases are not monitored Debezium is not able to communicate to the database that the WAL files can be removed to reclaim disk space. To solve this scenario we triggered "heartbeat" events by periodically updating a single row in a table created in the monitored database using the below query:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">CREATE TABLE IF NOT EXISTS heartbeat (id SERIAL PRIMARY KEY, ts TIMESTAMP WITH TIME ZONE);
INSERT INTO heartbeat (id, ts) VALUES (1, NOW()) ON CONFLICT(id) DO UPDATE SET ts=EXCLUDED.ts;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since this is a common use-case that comes up when using Debezium with PostgreSQL, an issue has been created to track this at <a href="https://issues.redhat.com/browse/DBZ-1815">DBZ-1815</a>.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>We got severely reduced throughput on tables with JSONB columns. After debugging we were able to confirm the reason as frequent schema refresh by Debezium due to TOASTed columns not being present in the replication message. This was fixed by changing <code>schema.refresh.mode</code> to <code>columns_diff_exclude_unchanged_toast</code> and has since been <a href="https://debezium.io/documentation/reference/1.0/connectors/postgresql.html#discrepance-between-plugins">documented</a>.</p>
</li>
<li>
<p>We observed frequent EOF errors on the database connection on a few RDS instance sizes. We are still not sure of the cause but initial investigations point to the issue happening only on instances that have PgBouncer attached (even if not connecting through PgBouncer) or instances with smaller sizes (AWS t2/t3 series).</p>
</li>
<li>
<p>We initially used a single Debezium connector per PostgreSQL database (instead of per host) but then moved to using a single connector for each team. The main reasons for not running a single connector per PostgreSQL instance were regarding workload isolation. Any team performing bulk data updates or deletions or unplanned schema migrations will only impact their own Debezium connector instead of the entire PostgreSQL instance since Debezium filters events at its end according to the database and/or schema whitelist and blacklist configured. We are trying to identify possible issues in this configuration but haven&#8217;t found any yet. Moving to a single connector per team setup also eased a lot of management overhead regarding configuration changes since we no longer need to co-ordinate between multiple teams when creating a release plan for any changes. Although multiple replication slots on a single database do add overhead, we are able to run fine with around 6 to 10 slots per database host without any noticeable performance impact.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="production-incidents">Production Incidents</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As is common with every software development project we did hit a few issues and here we discuss one of the more difficult ones in detail. But thanks to Debezium being focused on ensuring data consistency we were able to recover without <strong>ANY</strong> data loss.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p><strong>The issue we discuss below is already fixed in Debezium 1.0 and you should update as soon as possible</strong>.</p>
</div>
<div class="paragraph">
<p>A new feature for skipping such unprocessable events in general has been merged as <a href="https://github.com/debezium/debezium/pull/1271">PR#1271</a> in the core Debezium framework and will be part of the next Debezium 1.1 preview release.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Two of the common things developers often fail to do are proper date-time handling and software version upgrades. Both of these can lead to issues on their own but makes things difficult when both occur together. We recently faced such an issue and provide a way to handle it. We&#8217;ll start with some background on why this issue came up in the first place.</p>
</div>
<div class="paragraph">
<p>PostgreSQL&#8217;s <a href="https://www.postgresql.org/docs/current/datatype-datetime.html">date/time types documentation</a> states that the TIMESTAMP types can range from <strong>4713 BC</strong> to <strong>294276 AD</strong>. Before Debezium 0.10, there were serveral issues regarding datetime overflow for dates too far into the future like <a href="https://issues.redhat.com/browse/DBZ-1255">DBZ-1255</a> and <a href="https://issues.redhat.com/browse/DBZ-1205">DBZ-1205</a>.</p>
</div>
<div class="sect2">
<h3 id="the-bug-and-dealing-with-it">The Bug and Dealing With It</h3>
<div class="paragraph">
<p>To hit the above issue you need to have a date sufficiently far into the future. You can get one if you are not using ISO8601 or epoch time and have a bug in your custom datetime formatter.</p>
</div>
<div class="paragraph">
<p>So, the bug was triggered by the application writing a datetime value containing the year <strong>20200</strong> into one of the tables monitored by Debezium which caused Debezium to throw an exception since we were still running on 0.9 in production.</p>
</div>
<div class="paragraph">
<p>Unfortunately our log pattern alerts did not work that day and the error silently skipped past us until the high replication lag alarms went off. Upon inspecting the logs we did figure out where the issue was coming from and for which value. Unfortunately the log did not tell what table the issue was in (<em>hint - can become a valuable contribution</em>) and which column contained the offending value. Luckily only four tables were monitored and each of them had two TIMESTAMPTZ columns and it was easy to query for the offending value in those to find the actual record.</p>
</div>
<div class="paragraph">
<p>A quick read of the source code showed us that this was happening for any year &gt; 9999 and hence we queried the database to check if any other such values existed. Thankfully no other values existed. By now we had a clear plan in mind:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Stop Debezium</p>
</li>
<li>
<p>Correct the data for the record</p>
</li>
<li>
<p>Somehow get Debezium to skip the unparseable record</p>
</li>
<li>
<p>Add validations to database to ensure such values don&#8217;t skip through for the time being</p>
</li>
<li>
<p>Upgrade Debezium to 1.0</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>But we were stuck at the 3rd step above since we could not find an equivalent option to MySQL&#8217;s <code>event.deserialization.failure.handling.mode</code> for the PostgreSQL connector.</p>
</div>
</div>
<div class="sect2">
<h3 id="how-debezium-and-postgresql-track-offsets">How Debezium and PostgreSQL track offsets</h3>
<div class="paragraph">
<p>Each change record in PostgreSQL has a position which is tracked using a value known as a log sequence number (LSN). PostgreSQL represents it as two hexadecimal numbers - logical <strong>xLog</strong> and <strong>segment</strong>. Debezium represents it as the decimal representation of that value. The actual conversion implementation can be seen in PostgreSQL&#8217;s JDBC driver <a href="https://github.com/pgjdbc/pgjdbc/blob/1970c4a3fb8ebf4cc52f5d8b0d4977388ee713e7/pgjdbc/src/main/java/org/postgresql/replication/LogSequenceNumber.java#L42">here</a>.</p>
</div>
<div class="paragraph">
<p>Periodically Debezium writes the last processed LSN and transaction id to the Kafka Connect offsets topic and advances the replication slot to match that. On startup, Debezium uses the last record from the Kafka Connect offsets topic to rewind the replication slot to the position as described before continuing streaming changes. This means that to change the position in the WAL where Debezium picks up from requires a change in both Debezium&#8217;s tracked information in the Kafka Connect offsets topic as well as server side in PostgreSQL.</p>
</div>
</div>
<div class="sect2">
<h3 id="skipping-unparseable-events">Skipping Unparseable Events</h3>
<div class="paragraph">
<p>We were able to use the above information to make Debezium skip the unparseable event by performing the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Stop Debezium to make the replication slot inactive.</p>
</li>
<li>
<p>Check Debezium has stopped listening on the replication slot by running <code>SELECT * FROM pg_replication_slots WHERE slot_name = '&lt;your-slot-name&gt;';</code>. The <code>active</code> column should be <code>f</code>.</p>
</li>
<li>
<p>Check the last message in Debezium&#8217;s offsets topic and note down the value for the <code>lsn</code> key. eg. <code>1516427642656</code>.</p>
</li>
<li>
<p>Convert that long representation of LSN into the hexadecimal format using PosgtreSQL&#8217;s Java driver using the below Java code:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import org.postgresql.replication.LogSequenceNumber;

class Scratch {
  public static void main(String[] args) {
      LogSequenceNumber a = LogSequenceNumber.valueOf(1516427642656L);
      System.out.println(a.asString());
  }
}</code></pre>
</div>
</div>
</li>
<li>
<p>Peek changes from the WAL upto the LSN above using <code>SELECT pg_logical_slot_peek_changes('&lt;your-slot-name&gt;', '&lt;lsn-from-above&gt;', 1)</code>. This is the replication change that we are going to skip, so please make sure that this is the record that you want to skip. Once confirmed, proceed to next step.</p>
</li>
<li>
<p>Advance the replication slot by skipping 1 change using <code>SELECT pg_logical_slot_get_changes('&lt;your-slot-name&gt;', NULL, 1)</code>. This will consume 1 change from the replication slot.</p>
</li>
<li>
<p>Publish a message to Debezium&#8217;s offset topic with the next LSN and TxId. We were able to successfully get it working by adding 1 to both the <code>lsn</code> and the <code>txId</code>.</p>
</li>
<li>
<p>Deploy Debezium again and it should have skipped the record.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="why-debezium">Why Debezium?</h3>
<div class="paragraph">
<p>In closing we would like to highlight the issues Debezium has solved for us.</p>
</div>
<div class="paragraph">
<p>One of the biggest concerns when handling any data is regarding data consistency and Debezium helps us avoid dual writes and maintains data consistency between our RDBMS and Kafka which makes it easier to ensure data consistency in all further layers.</p>
</div>
<div class="paragraph">
<p>Debezium enables low overhead change data capture and now we have ended up defaulting to enabling Debezium for all new data sources being created.</p>
</div>
<div class="paragraph">
<p>Debezium&#8217;s support for a wide variety of data sources, PostgreSQL, MySQL and MongoDB specifically, helps us provide a standard technology and platform to perform data integration on. No more having to write custom code to connect each data source.</p>
</div>
<div class="paragraph">
<p>Debezium being open source proved to be immensely useful in the early days to make sure we were able to send in patches for a few bugs ourselves without having to ask someone to prioritise the issue. And since it&#8217;s open source there is a growing community around it which can help you figure out your issues and provide general guidance. Check out <a href="https://debezium.io/community/">this page</a> on the Debezium website for a lot of awesome community contributed content.</p>
</div>
</div>
<div class="sect2">
<h3 id="challenges">Challenges</h3>
<div class="paragraph">
<p>Having said the above Debezium is still quite a young project and has a few areas in which improvement will be welcome (and your contributions too in the form of code, design, ideas, documentation and even blog posts):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Zero-downtime high availability. Debezium relies on the Kafka Connect framework to provide high availability but it does not provide something similar to a hot standby instance. It takes time for an existing connector to shut down and a new instance to come up - which might be acceptable for a few use-cases but unacceptable in others. See <a href="https://medium.com/blablacar-tech/streaming-data-out-of-the-monolith-building-a-highly-reliable-cdc-stack-d71599131acb">this blog post by BlaBlaCar</a> for a discussion and their solution around it.</p>
</li>
<li>
<p>Support for other data sinks besides Kafka. In a few scenarios you might want to directly move the events from your database to an API, a different data store or maybe a different message broker. But since Debezium is currently written on top of Kafka Connect it can only write the data into Kafka. Debezium does provide an embedded engine which you can use as a library to consume change events in your Java applications.  See <a href="https://debezium.io/documentation/reference/operations/embedded.html">the documentation around embedding Debezium</a>. In case you do end up writing a different adapter around Debezium to move data into a different destination, consider making it open source so that both you benefit by additional maintainers and the community benefits by getting new use cases solved.</p>
</li>
<li>
<p>Common framework to write any new CDC implementation. We particularly have a use case of performing CDC on top of AWS DynamoDB. Instead of writing a custom Kafka Connector from scratch, we can reuse the Debezium core framework and write only the DynamoDB specific parts. This will help prevent bugs since a lot of the existing flows and edge cases might have already been handled. There is ongoing work around this theme to refactor all existing Debezium connectors to use the common framework to make it easier to write new custom connectors. For an example of how to implement one, take a look at the <a href="https://github.com/debezium/debezium-incubator">Debezium incubator repository</a>.</p>
</li>
<li>
<p>A few minor annoyances which are already tracked on the project&#8217;s issue tracker - specifically <a href="https://issues.redhat.com/browse/DBZ-1760">DBZ-1760 (skipping unparseable records)</a>, <a href="https://issues.redhat.com/browse/DBZ-1263">DBZ-1263 (update table whitelist for existing connector)</a>, <a href="https://issues.redhat.com/projects/DBZ/issues/DBZ-1723">DBZ-1723 (Reconnect to DB on failure)</a>, <a href="https://issues.redhat.com/projects/DBZ/issues/DBZ-823">DBZ-823 (Parallel snapshots)</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="future-scope">Future Scope</h3>
<div class="paragraph">
<p>We do have a few tasks planned for the future to improve our existing workflow regarding Debezium and Kafka Connect.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Upgrading to Debezium v1.0. Debezium recently released the first 1.0 release with a number of new features including <a href="https://debezium.io/documentation/reference/integrations/cloudevents.html">support for the CloudEvents format</a> which we are looking towards to provide a unified message format for all data across the organisation.</p>
</li>
<li>
<p>Trying out the Outbox design pattern as documented at <a href="https://debezium.io/blog/2019/02/19/reliable-microservices-data-exchange-with-the-outbox-pattern/">Reliable Microservices Data Exchange With the Outbox Pattern</a> to unify application events and data change events. The outbox pattern also provides transactional guarantees across service boundaries in a microservices system - something everybody wants in an event based microservices architecture.</p>
</li>
<li>
<p>Setting up an <a href="https://atlas.apache.org/">Apache Atlas</a> integration to automate the creation of data sources and tracking data lineage in Atlas to help with data governance and discoverability.</p>
</li>
<li>
<p>Writing and open sourcing an AWS DynamoDB CDC connector as a Debezium connector. Since we are using AWS DynamoDB too we need to provide the same capabilities that the other data sources are using in terms of CDC. For that we are writing a DynamoDB CDC connector using Debezium as a framework. The work is still in its early stages and is planned to be released as an open source connector.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>So overall, we started the post by sharing our business use-case and discussed how Debezium has helped us solve them. We then detailed how we have been running Debezium in production for performing CDC on PostgreSQL on AWS RDS and talked about the mistakes we made when starting out and how to solve them. And as is common in software engineering, we did face production incidents along the way and are sharing our learnings from that incident in the hopes that they might be useful for the wider community.</p>
</div>
<div class="paragraph">
<p><em>Also a lot of thanks to the people who reviewed this post including <a href="https://twitter.com/gunnarmorling">Gunnar Morling</a>, <a href="https://www.linkedin.com/in/kbhara">Kapil Bharati</a> and <a href="https://www.linkedin.com/in/akashdeep1">Akash Deep Verma</a>.</em></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="further-reading">Further Reading</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="debezium-documentation-and-repositories">Debezium Documentation and Repositories</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://debezium.io/documentation/reference/1.0/connectors/postgresql.html">Debezium PostgreSQL Connector Documentation</a></p>
</li>
<li>
<p><a href="https://debezium.io/documentation/reference/1.0/connectors/postgresql.html#amazon-rds">Debezium with PostgreSQL on
Amazon RDS</a></p>
</li>
<li>
<p><a href="https://debezium.io/documentation/reference/operations/embedded.html">Debezium Embedded Engine</a></p>
</li>
<li>
<p><a href="https://github.com/debezium/debezium-incubator">Debezium Incubator Connectors - Cassandra, IBM DB2</a></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="external-documentation">External Documentation</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://kafka.apache.org/documentation/streams/">Kafka Streams</a></p>
</li>
<li>
<p><a href="https://www.postgresql.org/docs/current/datatype-datetime.html">PostgreSQL date/time data types</a></p>
</li>
<li>
<p><a href="https://github.com/pgjdbc/pgjdbc/blob/1970c4a3fb8ebf4cc52f5d8b0d4977388ee713e7/pgjdbc/src/main/java/org/postgresql/replication/LogSequenceNumber.java#L42">PostgreSQL LSN conversion in JDBC driver</a></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="blogs-and-articles">Blogs and Articles</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://medium.com/blablacar-tech/streaming-data-out-of-the-monolith-building-a-highly-reliable-cdc-stack-d71599131acb">Streaming Data out of the Monolith: Building a Highly Reliable CDC Stack</a></p>
</li>
<li>
<p><a href="https://debezium.io/blog/2019/02/19/reliable-microservices-data-exchange-with-the-outbox-pattern/">Reliable Microservices Data Exchange With the Outbox Pattern</a></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="relevant-issues">Relevant Issues</h3>
<div class="sect3">
<h4 id="open-issues">Open Issues</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://issues.redhat.com/browse/DBZ-1760">DBZ-1760 - Add option to skip unprocesseable event</a></p>
</li>
<li>
<p><a href="https://issues.redhat.com/browse/DBZ-1263">DBZ-1263 - Allow table.whitelist to be updated after a connector is created</a></p>
</li>
<li>
<p><a href="https://issues.redhat.com/browse/DBZ-1815">DBZ-1815 - The Postgres connector heartbeat should optionally write back a heartbeat change to the DB</a></p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="solved-issues">Solved Issues</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://issues.redhat.com/browse/DBZ-1255">DBZ-1255 - Debezium does not expect a year larger than 9999</a></p>
</li>
<li>
<p><a href="https://issues.redhat.com/browse/DBZ-1205">DBZ-1205 - Overflowed Timestamp in Postgres Connection</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div></div>
    </div>
    
   
      
      
      <div class="well">
      <div class="row">
        <div class="col-md-8">
          <h2>Ashhar Hasan</h2>
          
          <p>
            <span class="bio-size"
              >Ashhar is a software engineer at Delhivery where he focuses on change data capture, data warehousing, and creating event-driven systems.</span
            >
          </p>
          
          <p class="bio-size">
            
            <a href="https://twitter.com/Ashhar is a software engineer at Delhivery where he focuses on change data capture, data warehousing, and creating event-driven systems.">
              <i class="icon-twitter"></i>
            </a>
            &nbsp;
            
            
            <a href="https://github.com/hashhar">
              <i class="icon-github"></i>
            </a>
            &nbsp;
            
            
          </p>
        </div>
        <div class="col-md-4">
          
          <img
            alt=""
            class="img-responsive pull-right portrait"
            src="/assets/images/hashhar.jpg"
          />
          
        </div>
      </div>
    </div>
    

      <ul class="pager pager-blog">
        
          <li class="previous">
            <a href="/blog/2020/02/19/debezium-camel-integration/" class="previous"> &laquo; Previous</a>
        </li>
                
        
        <li class="next"><a href="/blog/2020/03/05/db2-cdc-approaches/">Next &raquo; </a></li>
        
      </ul>
    
    
    <div class="row">
      <div class="col-md-12">
        <hr>
        <h2>About Debezium</h2>
        <p>
          Debezium is an open source distributed platform that turns your existing databases into event streams,
          so applications can see and respond almost instantly to each committed row-level change in the databases.
          Debezium is built on top of <a href="http://kafka.apache.org/">Kafka</a> and provides <a href="http://kafka.apache.org/documentation.html#connect">Kafka Connect</a> compatible connectors that monitor specific database management systems.
          Debezium records the history of data changes in Kafka logs, so your application can be stopped and restarted at any time and can easily consume all of the events it missed while it was not running,
          ensuring that all events are processed correctly and completely.
          Debezium is <a href="/license/">open source</a> under the <a href="http://www.apache.org/licenses/LICENSE-2.0.html">Apache License, Version 2.0</a>.
        </p>
      </div>
    </div>
    <div class="row">
      <div class="col-md-12">
        <h2>Get involved</h2>
        <p>
          We hope you find Debezium interesting and useful, and want to give it a try.
          Follow us on Twitter <a href="https://twitter.com/debezium">@debezium</a>, <a href="https://gitter.im/debezium/user">chat with us on Gitter</a>,
          or join our <a href="https://groups.google.com/forum/#!forum/debezium">mailing list</a> to talk with the community.
          All of the code is open source <a href="https://github.com/debezium/">on GitHub</a>,
          so build the code locally and help us improve ours existing connectors and add even more connectors.
          If you find problems or have ideas how we can improve Debezium, please let us know or <a href="https://issues.redhat.com/projects/DBZ/issues/">log an issue</a>.
        </p>
      </div>
    </div>
    
    
  </div>
</div>

        
      </div>
      <footer class="container">
  <div>
  <div class="row mr-0 ml-0">
    <div class="col-md-5 col-md-offset-1">
      <h4>Debezium</h4>
      <p>
        &#169; 2020 Debezium Community <br />
        <br />
        <i class="icon-fire"></i> Mixed with
        <a href="https://getbootstrap.com/">Bootstrap</a>, baked by
        <a href="https://jekyllrb.com/">Jekyll</a>. <br />
        <i class="icon-flag"></i> Website and docs licensed under
        <a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>.
        <br />
        <i class="icon-flag-alt"></i> Code released under
        <a href="https://www.apache.org/licenses/LICENSE-2.0.html"
          >Apache License, v2.0</a
        >. <br />
        <i class="icon-file-alt"></i>
        <a
          href="https://www.redhat.com/legal/legal_statement.html"
          title="Terms"
          >Terms</a
        >
        |
        <a
          href="https://www.redhat.com/legal/privacy_statement.html"
          title="Privacy Policy"
          >Privacy</a
        >
      </p>
    </div>
    <div class="col-md-3">
      <h4>Documentation</h4>
      <ul class="list-unstyled">
        <li><a href="/documentation/reference/features.html" title="Features">Features</a></li>
        <li>
          <a href="documentation/reference/install.html" title="Install">Install</a>
        </li>
        <li>
          <a href="/documentation/reference/architecture.html" title="Architecture"
            >Architecture</a
          >
        </li>
        <li><a href="/documentation/faq/" title="FAQ">FAQ</a></li>
        <li>
          <a href="/community/contribute/" title="Contribute">Contribute</a>
        </li>
      </ul>
    </div>
    <div class="col-md-3">
      <h4>Connect</h4>
      <ul class="list-unstyled">
        <li><a href="/blog" title="Blog">Blog</a></li>
        <li>
          <a href="https://twitter.com/debezium" title="Twitter">Twitter</a>
        </li>
        <li><a href="https://github.com/debezium" title="GitHub">GitHub</a></li>
        <li><a href="https://gitter.im/debezium/user" title="Chat">Chat</a></li>
        <li>
          <a
            href="https://groups.google.com/forum/#!forum/debezium"
            title="Google Groups"
            >Google Groups</a
          >
        </li>
        <li>
          <a
            href="https://stackoverflow.com/questions/tagged/debezium"
            title="StackOverflow"
            >StackOverflow</a
          >
        </li>
      </ul>
    </div>
  </div>
</div>
</footer>
      <div class="container" id="companyfooter">
  <div class="redhatlogo">
    <a href="https://www.redhat.com/">
      <img
        src="/assets/images/Logo-Red_Hat-Sponsored_By-B-Standard-RGB.svg"
      />
    </a>
  </div>
</div>
  </div>
  
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
  <script type="text/javascript" src="/assets/javascript/vanilla-back-to-top.min.js"></script>
  <script>
    addBackToTop({
      scrollDuration: 400
    })
  </script>
</body>

</html>
