<!DOCTYPE html> <html lang="en"> <head> <title>Outbox Event Router goes Supersonic! Â· Debezium</title> <meta charset="utf-8"> <meta content="width=device-width, initial-scale=1.0" name="viewport"> <meta content="" name="description"> <meta content="" name="author"> <link href="https://static.jboss.org/theme/css/bootstrap-community/3.2.0.2/bootstrap-community.min.css" media="screen" rel="stylesheet"> <!--[if lt IE 9]><script src="https://static.jboss.org/theme/js/libs/html5/pre3.6/html5.min.js"></script><![endif]--> <link href="https://static.jboss.org/example/images/favicon.ico" rel="shortcut icon"> <link href="https://static.jboss.org/example/images/apple-touch-icon-144x144-precomposed.png" rel="apple-touch-icon-precomposed" sizes="144x144"> <link href="https://static.jboss.org/example/images/apple-touch-icon-114x114-precomposed.png" rel="apple-touch-icon-precomposed" sizes="114x114"> <link href="https://static.jboss.org/example/images/apple-touch-icon-72x72-precomposed.png" rel="apple-touch-icon-precomposed" sizes="72x72"> <link href="https://static.jboss.org/example/images/apple-touch-icon-precomposed.png" rel="apple-touch-icon-precomposed"> <link href="/stylesheets/debezium.css" rel="stylesheet" type="text/css"> <style>
  @media (min-width: 980px) {
    .banner { background-image: url(https://static.jboss.org/example/images/debezium-banner-1180px.png); height: 110px;  }
  }
  @media (max-width: 979px) {
    .banner { background-image: url(https://static.jboss.org/example/images/debezium-logo.png); background-repeat:no-repeat; background-position: center bottom; height: 60px; }
  }
  @media (max-width: 650px) {
    .banner { width: 100%; margin: 0px auto; }
  }
  @media (max-width: 450px) {
    .banner { height: 90px; }
  }
</style> <link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/styles/default.min.css" rel="stylesheet"> <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/highlight.min.js"></script> <script>
hljs.initHighlightingOnLoad();
</script> <script src="https://static.jboss.org/theme/js/libs/jquery/jquery-1.9.1.min.js"></script> <style>
  /* adjusting the vertical spacing for when a stickynav is engaged */
  .breadcrumb-fixed > .active {
    color: #8c8f91;
  }
  .breadcrumb-fixed {
    margin: 70px 0 10px;
    padding: 8px 15px;
    margin-bottom: 20px;
    list-style: none;
    background-color: #f5f5f5;
    border-radius: 4px;
  }
  
  .breadcrumb-fixed > li {
    display: inline-block;
  }
</style> </head> <body> <div id="rhbar"> <a class="jbdevlogo" href="https://www.jboss.org/projects/about"></a> <a class="rhlogo" href="https://www.redhat.com/"></a> </div> <div id=""> <ul class="visuallyhidden" id="top"> <li> <a accesskey="n" href="#nav" title="Skip to navigation">Skip to navigation</a> </li> <li> <a accesskey="c" href="#page" title="Skip to content">Skip to content</a> </li> </ul> <div class="container" id="content"> <div class="navbar navbar-inverse navbar-fix"> <div class="container-fluid"> <div class="navbar-header"> <button class="navbar-toggle collapsed" data-target="#navbar-1" data-toggle="collapse"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href="/"> <img src="/images/color_white_debezium_type_600px.svg" style="height: 32px; margin-right: 5px; margin-top: -5px;"> </a> </div> <div class="collapse navbar-collapse" id="navbar-1"> <ul class="nav navbar-nav pull-right"> <li class=""><a href="/documentation/faq/">FAQ</a></li> <li class=""><a href="/documentation/">DOCUMENTATION</a></li> <li class=""><a href="/releases/">RELEASES</a></li> <li class=""><a href="/community/">COMMUNITY</a></li> <li class="active"><a href="/blog/">BLOG</a></li> </ul> </div> </div> </div> <div id="equalHeightsLayout"> <div class="row post-text-padding row-no-expand"> <div class="hidden-xs col-sm-3 no-right-padding" id="leftdocnav" style="padding-left: 15px; padding-right: 15px;"> <div class="doc-pills"> <ul class="nav nav-pills nav-stacked"> <li class="item"> <a href="/blog">Home</a> <div class="icon"> <span class="icon-home"></span> </div> </li> <li class="item"> <a href="/blog.atom">Feed</a> <div class="icon"> <span class="icon-rss"></span> </div> </li> </ul> </div> <p></p> <div class="featured-posts"> <div id="featured" style="margin-bottom: 4px; border-bottom: 1px solid #ccc; font-size: 115%; margin-left: 2px;"> Featured Posts </div> <ul style="padding-inline-start: 22px;"> <li style="margin-bottom: 3px;"> <a href="/blog/2019/10/22/audit-logs-with-kogito/" style="font-size: 95%;"> Admin Service for Audit Logs with Kogito </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2019/10/01/audit-logs-with-change-data-capture-and-stream-processing/" style="font-size: 95%;"> Building Audit Logs with Change Data Capture and Stream Processing </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2019/07/12/streaming-cassandra-at-wepay-part-1/" style="font-size: 95%;"> Streaming Cassandra at WePay - Part 1 </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2019/02/19/reliable-microservices-data-exchange-with-the-outbox-pattern/" style="font-size: 95%;"> Reliable Microservices Data Exchange With the Outbox Pattern </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/12/05/automating-cache-invalidation-with-change-data-capture/" style="font-size: 95%;"> Automating Cache Invalidation With Change Data Capture </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/09/20/materializing-aggregate-views-with-hibernate-and-debezium/" style="font-size: 95%;"> Materializing Aggregate Views With Hibernate and Debezium </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/07/19/advantages-of-log-based-change-data-capture/" style="font-size: 95%;"> Five Advantages of Log-Based Change Data Capture </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/03/08/creating-ddd-aggregates-with-debezium-and-kafka-streams/" style="font-size: 95%;"> Creating DDD aggregates with Debezium and Kafka Streams </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/01/17/streaming-to-elasticsearch/" style="font-size: 95%;"> Streaming Data Changes from Your Database to Elasticsearch </a> </li> </ul> </div> <p></p> <div class="cloud-tags"> <div id="tags" style="margin-bottom: 4px; border-bottom: 1px solid #ccc; font-size: 115%; margin-left: 2px;"> Tags </div> <div class="tag-cloud"> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/apache-kafka/">apache-kafka</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/avro/">avro</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/cassandra/">cassandra</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/community/">community</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/discussion/">discussion</a> </span> <span class="tag tag-5"> <a href="https://debezium.io/blog/tags/docker/">docker</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/elasticsearch/">elasticsearch</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/example/">example</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/examples/">examples</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/featured/">featured</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/fedora/">fedora</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/introduction/">introduction</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/json/">json</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/kafka/">kafka</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/kafka-streams/">kafka-streams</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/kogito/">kogito</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/ksql/">ksql</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/kubernetes/">kubernetes</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/microservices/">microservices</a> </span> <span class="tag tag-4"> <a href="https://debezium.io/blog/tags/mongodb/">mongodb</a> </span> <span class="tag tag-6"> <a href="https://debezium.io/blog/tags/mysql/">mysql</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/news/">news</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/newsletter/">newsletter</a> </span> <span class="tag tag-2"> <a href="https://debezium.io/blog/tags/oracle/">oracle</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/outbox/">outbox</a> </span> <span class="tag tag-5"> <a href="https://debezium.io/blog/tags/postgres/">postgres</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/presentation/">presentation</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/quarkus/">quarkus</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/rds/">rds</a> </span> <span class="tag tag-6"> <a href="https://debezium.io/blog/tags/releases/">releases</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/secrets/">secrets</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/sentry/">sentry</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/serialization/">serialization</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/smt/">smt</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/sql/">sql</a> </span> <span class="tag tag-3"> <a href="https://debezium.io/blog/tags/sqlserver/">sqlserver</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/vagrant/">vagrant</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/website/">website</a> </span> </div> </div> </div> <div class="col-xs-12 col-sm-9" id="maincol"> <div class="post"> <div class="row" style="margin-left: 0; margin-right: 0; margin-bottom: 10px;"> <div class="col-sm-12" style="padding-left: 0px;"> <div style="display: table-cell; vertical-align: top;"> <div style="width: 72px; border: 1px solid #ccc; padding: 3px; display: inline-block;"> <img src="/images/ccranfor.jpg" style="width: 64px;"> </div> </div> <div style="display: table-cell; vertical-align: top;"> <div style="margin-left: 8px;"> <span class="hidden-sm hidden-xs" style="font-size: 2.75rem; line-height: 1;"> <a href="/blog/2020/01/22/outbox-quarkus-extension/">Outbox Event Router goes Supersonic!</a> </span> <span class="hidden-md hidden-lg" style="font-size: 2rem; line-height: 1;"> <a href="/blog/2020/01/22/outbox-quarkus-extension/">Outbox Event Router goes Supersonic!</a> </span> <div class="byline" style="line-height: 1;"> <em> January 22, 2020 by Chris Cranford </em> <div class="hidden-xs" style="margin-top: 5px;"> <a class="hidden-sm hidden-xs label label-info" href="/blog/tags/discussion/">discussion</a> <a class="hidden-sm hidden-xs label label-info" href="/blog/tags/examples/">examples</a> <a class="hidden-sm hidden-xs label label-info" href="/blog/tags/outbox/">outbox</a> <a class="hidden-sm hidden-xs label label-info" href="/blog/tags/quarkus/">quarkus</a> </div> </div> </div> </div> </div> </div> <div class="row" style="margin-left: 0; margin-right: 0;"> <div id="preamble"> <div class="sectionbody"> <div class="paragraph"> <p>Outbox as in that folder in my email client? No, not exactly but there are some similarities!</p> </div> <div class="paragraph"> <p>The term outbox describes a pattern that allows independent components or services to perform <em>read your own write</em> semantics while concurrently providing a reliable, eventually consistent view to those writes across component or service boundaries.</p> </div> <div class="paragraph"> <p>You can read more about the Outbox pattern and how it applies to microservices in our blog post, <a href="/blog/2019/02/19/reliable-microservices-data-exchange-with-the-outbox-pattern/">Reliable Microservices Data Exchange With the Outbox Patttern</a>.</p> </div> <div class="paragraph"> <p>So what exactly is an Outbox Event Router?</p> </div> <div class="paragraph"> <p>In Debezium version 0.9.3.Final, we introduced a ready-to-use <a href="https://kafka.apache.org/documentation/#connect_transforms">Single Message Transform</a> (SMT) that builds on the Outbox pattern to propagate data change events using Debezium and Kafka. Please see the <a href="https://debezium.io/documentation/reference/1.1/configuration/outbox-event-router.html">documentation</a> for details on how to use this transformation.</p> </div> </div> </div> <div class="sect1"> <h2 id="going_supersonic_with_quarkus"><a class="anchor" href="#going_supersonic_with_quarkus"></a>Going Supersonic with Quarkus!</h2> <div class="sectionbody"> <div class="paragraph"> <p><a href="http://www.quarkus.io">Quarkus</a> is a Kubernetes Native Java framework that is tailored for GraalVM and HotSpot using the <em>best-of-breed</em> Java technologies and standards. Quarkus aims to offer developers a unified reactive and imperative programming model to address a wide range of application architectures.</p> </div> <div class="paragraph"> <p>So what does all this mean exactly in laymen&#8217;s terms?</p> </div> <div class="paragraph"> <p>In short, the Debezium community can now leverage the Outbox pattern in a Quarkus-based application using a ready-to-use extension that works in parallel with your Debezium connector to emit change data events. The Debezium Outbox extension for Quarkus can be used in both JVM or Native image modes in Quarkus.</p> </div> <div class="sect2"> <h3 id="how_to_get_it"><a class="anchor" href="#how_to_get_it"></a>How to get it?</h3> <div class="paragraph"> <p>Currently the dependency must be manually added to your Quarkus application&#8217;s <code>pom.xml</code> as shown below. There are plans to make this extension available in the Quarkus extension catalogue as well as via Quarkus' Maven plugin in a future release.</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;&#x000A;  &lt;groupId&gt;io.debezium.quarkus&lt;/groupId&gt;&#x000A;  &lt;artifactId&gt;debezium-quarkus-outbox&lt;/artifactId&gt;&#x000A;  &lt;version&gt;1.1.0.Alpha1&lt;/version&gt;&#x000A;&lt;/dependency&gt;</code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="paragraph"> <p>At the time of this blog, the extension was released as <em>1.1.0.Alpha1</em>.<br> A newer version of the extension may be available, see <a href="/releases/">Releases</a> for details.</p> </div> </td> </tr> </table> </div> </div> <div class="sect2"> <h3 id="using_the_extension"><a class="anchor" href="#using_the_extension"></a>Using the extension</h3> <div class="paragraph"> <p>The Debezium Outbox extension uses the Observer pattern to monitor when the user application emits an object that implements the <code>io.debezium.outbox.quarkus.ExportedEvent</code> interface. This allows the Quarkus application behavior to be completely decoupled from that of the extension.</p> </div> <div class="paragraph"> <p>Lets walk through a simple example where a service is responsible for storing newly created orders and then emits an event that could be used to notify other interested services that an order has been created.</p> </div> <div class="paragraph"> <p>So to get started, we&#8217;ll begin by first implementing <code>OrderCreatedEvent</code>, an implementation of <code>ExportedEvent</code>. This event is used to signal when an <code>Order</code> has been saved by the <code>OrderService</code>.</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-java" data-lang="java">public class OrderCreatedEvent implements ExportedEvent&lt;String, JsonNode&gt; {&#x000A;    private final long orderId;&#x000A;    private final JsonNode payload;&#x000A;    private final Instant created;&#x000A;&#x000A;    public OrderCreatedEvent(Instant createdAt, Order order) {&#x000A;        this.orderId = order.getId();&#x000A;        this.payload = convertOrderToJsonNode(order);&#x000A;        this.created = createdAt;&#x000A;    }&#x000A;&#x000A;    @Override&#x000A;    public String getAggregateId() {&#x000A;        return String.valueOf(orderId);&#x000A;    }&#x000A;&#x000A;    @Override&#x000A;    public String getAggregateType() {&#x000A;        return "Order";&#x000A;    }&#x000A;&#x000A;    @Override&#x000A;    public JsonNode getPayload() {&#x000A;        return payload;&#x000A;    }&#x000A;&#x000A;    @Override&#x000A;    public String getType() {&#x000A;        return "OrderCreated";&#x000A;    }&#x000A;&#x000A;    @Override&#x000A;    public Instant getTimestamp() {&#x000A;        return created;&#x000A;    }&#x000A;}</code></pre> </div> </div> <div class="paragraph"> <p>The <code>ExportedEvent</code> interface is the contract that defines how a Quarkus application is to provide the extension with the data to persist to the outbox database table. This contract exposes several different values discussed below:</p> </div> <div class="sect3"> <h4 id="aggregate_id"><a class="anchor" href="#aggregate_id"></a>Aggregate Id</h4> <div class="paragraph"> <p>The aggregate id is used when emitting messages to Kafka as the message key to preserve message order. In this example, the <code>OrderCreatedEvent</code> returns the order identifier.</p> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> <div class="paragraph"> <p>The <code>ExportedEvent</code> interface is parameterized and the first argument of the parameter argument list allows the application to specify the return data type for the aggregate id. While this example uses a <code>String</code>, the value returned can be any persistable object type.</p> </div> </td> </tr> </table> </div> </div> <div class="sect3"> <h4 id="aggregate_type"><a class="anchor" href="#aggregate_type"></a>Aggregate Type</h4> <div class="paragraph"> <p>The aggregate type is a string-based value that is used to append to the Kafka topic name and also assists in routing of the given message inside the Outbox Event Router SMT. In this example, we use <code>Order</code> and when using the default configuration of the SMT, messages would be found in the <code>outbox.event.Order</code> topic. Please see the <code>route.topic.replacement</code> in the <a href="documentation/reference/1.1/configuration/outbox-event-router.html#configuration-options">SMT configuration options</a> for more details.</p> </div> </div> <div class="sect3"> <h4 id="type"><a class="anchor" href="#type"></a>Type</h4> <div class="paragraph"> <p>The message type is a string value that is emitted in the Kafka message&#8217;s envelope. In this example, the value in the message envelope would be <code>OrderCreated</code>.</p> </div> </div> <div class="sect3"> <h4 id="timestamp"><a class="anchor" href="#timestamp"></a>Timestamp</h4> <div class="paragraph"> <p>By default, the Outbox Event Router SMT emits outbox events using the current timestamp when processing records but this may not always be sufficient for every use case. This field allows the source application to specify an <code>Instant</code> that can then be configured through the <a href="documentation/reference/1.1/configuration/outbox-event-router.html#configuration-options">SMT configuration options</a> to be used as the Kafka message timestamp instead.</p> </div> </div> <div class="sect3"> <h4 id="payload"><a class="anchor" href="#payload"></a>Payload</h4> <div class="paragraph"> <p>The payload is the message content or value and is what is consumed by consumers of the Kafka topic.</p> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> <div class="paragraph"> <p>The <code>ExportedEvent</code> interface is parameterized and the second argument of the parameter argument list allows the application to specify the return data type for the payload. While this example uses a <code>JsonNode</code> to store a JSON representation of the <code>Order</code>, the payload can be any persistable object type.</p> </div> </td> </tr> </table> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="paragraph"> <p>If multiple implementations of <code>ExportedEvent</code> exist in a Quarkus application, they must all use the same signature. If different signatures are required, the code should be split into different Quarkus applications because all <code>ExportedEvent</code> implementations will be stored in the same database outbox table for a given Quarkus application. We are currently investigating alternatives to loosen this restriction in a future release to allow multiple variants within the same application.</p> </div> </td> </tr> </table> </div> <div class="paragraph"> <p>By itself, this <code>OrderCreatedEvent</code> does nothing on its own.</p> </div> <div class="paragraph"> <p>Next we want to implement an application component that is responsible for persisting the order to the database and then to emit the <code>OrderCreatedEvent</code> event. The <code>OrderService</code> class below uses JPA to persist the <code>Order</code> entity and then <code>javax.enterprise.event.Event&lt;T&gt;</code> to notify the outbox extension.</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-java" data-lang="java">@ApplicationScoped&#x000A;public class OrderService {&#x000A;    @Inject&#x000A;    EntityManager entityManager;&#x000A;&#x000A;    @Inject&#x000A;    Event&lt;ExportedEvent&lt;String, JsonNode&gt;&gt; event;&#x000A;&#x000A;    @Transactional&#x000A;    public Order addOrder(Order order) {&#x000A;        entityManager.persist(order);&#x000A;        event.fire(new OrderCreatedEvent(Instant.now(), order));&#x000A;        return order;&#x000A;    }&#x000A;}</code></pre> </div> </div> <div class="paragraph"> <p>Before starting the application, certain configuration settings must be specified in <code>application.properties</code>. An example configuration might look like the following where we specify the database to connect to as well as how the persistence provider, Hibernate, is to operate.</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-properties" data-lang="properties">quarkus.datasource.driver=org.postgresql.Driver&#x000A;quarkus.datasource.url=jdbc:postgresql://order-db:5432/orderdb?currentSchema=orders&#x000A;quarkus.datasource.username=user&#x000A;quarkus.datasource.password=password&#x000A;quarkus.hibernate-orm.database.generation=update&#x000A;quarkus.hibernate-orm.dialect=org.hibernate.dialect.PostgreSQLDialect&#x000A;quarkus.hibernate-orm.log.sql=true</code></pre> </div> </div> <div class="paragraph"> <p>By starting the application with this configuration the outbox table <code>OutboxEvent</code> will be created in the <code>orders</code> schema of the the <code>order-db</code> database with the following layout:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-sql" data-lang="sql">orderdb=# \d orders.outboxevent&#x000A;                        Table "orders.outboxevent"&#x000A;    Column     |            Type             | Collation | Nullable | Default&#x000A;---------------+-----------------------------+-----------+----------+---------&#x000A; id            | uuid                        |           | not null |&#x000A; aggregatetype | character varying(255)      |           | not null |&#x000A; aggregateid   | character varying(255)      |           | not null |&#x000A; type          | character varying(255)      |           | not null |&#x000A; timestamp     | timestamp without time zone |           | not null |&#x000A; payload       | character varying(8000)     |           |          |&#x000A;Indexes:&#x000A;    "outboxevent_pkey" PRIMARY KEY, btree (id)</code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="paragraph"> <p>When using <code>JsonNode</code> as the payload return type, the extension uses a JPA attribute converter to store the contents as a string in the database.</p> </div> </td> </tr> </table> </div> <div class="paragraph"> <p>Should the table or column names not fit your naming convention, they can be customized with several <a href="/documentation/reference/1.1/integrations/outbox.html#_build_time_configuration_options">build-time configuration options</a>. For example, if you wanted the table to be named <code>outbox</code> rather than <code>outboxevent</code> add the following line to the <code>application.properties</code> file:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-properties" data-lang="properties">quarkus.debezium-outbox.table-name=outbox</code></pre> </div> </div> <div class="paragraph"> <p>If you enabled SQL logging or check the row count of the outbox table, you might find it unusual that after saving the order that a record is inserted into the outbox table but then is immediately deleted. This is the default behavior since rows are not required to be retained for Debezium to pick up the change.</p> </div> <div class="paragraph"> <p>If row retention is required, this can be configured using a <a href="/documentation/reference/1.1/integrations/outbox.html#_runtime_configuration_options">run-time configuration option</a>. In order to enable row retention, add the following configuration to the <code>application.properties</code> file.</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-properties" data-lang="properties">quarkus.debezium-outbox.remove-after-insert=false</code></pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="setting_up_the_connector"><a class="anchor" href="#setting_up_the_connector"></a>Setting up the connector</h3> <div class="paragraph"> <p>Up to this point we&#8217;ve covered how to configure and use the extension in a Quarkus application to save events into the outbox database table. The last step is to configure the Debezium connector to monitor the outbox and emit those records to Kafka.</p> </div> <div class="paragraph"> <p>We&#8217;re going to use the following connector configuration:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-json" data-lang="json">{&#x000A;  "connector.class": "io.debezium.connector.postgresql.PostgresConnector",&#x000A;  "tasks.max": "1",&#x000A;  "database.hostname": "order-db",&#x000A;  "database.port": "5432",&#x000A;  "database.user": "user",&#x000A;  "database.password": "password",&#x000A;  "database.dbname": "orderdb",&#x000A;  "database.server.name": "dbserver1",&#x000A;  "schema.whitelist" : "orders",&#x000A;  "table.whitelist": "orders.outboxevent",&#x000A;  "tombstones.on.delete": "false",&#x000A;  "transforms": "outbox",&#x000A;  "transforms.outbox.type" : "io.debezium.transforms.outbox.EventRouter",&#x000A;  "transforms.outbox.route.topic.replacement": "${routedByValue}.events",&#x000A;  "transforms.outbox.table.field.event.timestamp": "timestamp",&#x000A;  "transforms.outbox.table.fields.additional.placement": "type:header:eventType"&#x000A;}</code></pre> </div> </div> <div class="paragraph"> <p>A vast majority of this is standard Debezium connector configuration, but what is important are the last several lines that begin with <strong>transforms</strong>. These are configuration options that are used by Kafka Connect to configure and call the Outbox Event Router SMT.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="paragraph"> <p>This configuration uses a custom <code>route.topic.replacement</code> configuration property. This setting will instead route <code>OrderCreatedEvent</code> rows from the outbox to the <code>Order.events</code> topic rather than the default <code>outbox.events.Order</code> topic.</p> </div> <div class="paragraph"> <p>This configuration also specifies the <code>field.event.timestamp</code> configuration property. This setting will instead populate the Kafka message time from the <code>timestamp</code> field in the outbox database table rather than the current timestamp when processing the row.</p> </div> <div class="paragraph"> <p>Please see <a href="/documentation/reference/1.1/configuration/outbox-event-router.html#configuration-options">Outbox Event Router Configuration Options</a> for details on how to configure the SMT.</p> </div> </td> </tr> </table> </div> <div class="paragraph"> <p>Once the connector is running, the <code>Order.events</code> topic will be populated with messages from the outbox table. The following JSON example represents an <code>Order</code> which gets saved by the <code>OrderService</code>.</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-json" data-lang="json">{&#x000A;    "customerId" : "123",&#x000A;    "orderDate" : "2019-01-31T12:13:01",&#x000A;    "lineItems" : [&#x000A;        {&#x000A;            "item" : "Debezium in Action",&#x000A;            "quantity" : 2,&#x000A;            "totalPrice" : 39.98&#x000A;        },&#x000A;        {&#x000A;            "item" : "Debezium for Dummies",&#x000A;            "quantity" : 1,&#x000A;            "totalPrice" : 29.99&#x000A;        }&#x000A;    ]&#x000A;}</code></pre> </div> </div> <div class="paragraph"> <p>When examining the <code>Order.events</code> topic, the event emitted will look like the following:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-json" data-lang="json">{&#x000A;  "key": "1",&#x000A;  "headers": "id=cc74eac7-176b-44e7-8bda-413a5088ca66,eventType=OrderCreated"&#x000A;}&#x000A;"{\"id\":1,\"customerId\":123,\"orderDate\":\"2019-01-31T12:13:01\",\"lineItems\":[{\"id\":1,\"item\":\"Debezium in Action\",\"quantity\":2,\"totalPrice\":39.98,\"status\":\"ENTERED\"},{\"id\":2,\"item\":\"Debezium for Dummies\",\"quantity\":1,\"totalPrice\":29.99,\"status\":\"ENTERED\"}]}"</code></pre> </div> </div> </div> <div class="sect2"> <h3 id="wrapping_up"><a class="anchor" href="#wrapping_up"></a>Wrapping up</h3> <div class="paragraph"> <p>It is really simple and easy to setup and use the Debezium Outbox extension.</p> </div> <div class="paragraph"> <p>We have a complete <a href="https://github.com/debezium/debezium-examples/tree/master/outbox">example</a> in our examples repository that uses the order service described here as well as a shipment service that consumes the events. For more details on the extension, refer to the <a href="https://debezium.io/documentation/reference/1.1/integrations/outbox.html">Outbox Quarkus Extension</a> documentation.</p> </div> </div> <div class="sect2"> <h3 id="future_plans"><a class="anchor" href="#future_plans"></a>Future Plans</h3> <div class="paragraph"> <p>The current implementation of the Debezium Outbox extension works quite well, but we acknowledge there is still room for improvement. Some of the things we&#8217;ve already identified and have plans to include in future iterations of the extension are:</p> </div> <div class="ulist"> <ul> <li> <p>Avro serialization support for event payload</p> </li> <li> <p>Full outbox table column attribute control, e.g. definition, length, precision, scale, and converters.</p> </li> <li> <p>Complete outbox table customization using a user-supplied entity class.</p> </li> <li> <p>Allow varied signatures of <code>ExportedEvent</code> within a single application.</p> </li> </ul> </div> <div class="paragraph"> <p>We are currently tracking all future changes to this extension in <a href="https://issues.redhat.com/browse/DBZ-1711">DBZ-1711</a>. As always we welcome any and all feedback, so feel free to let us know in that issue, on Gitter, or the mailing lists.</p> </div> </div> </div> </div> </div> </div> <div class="well"> <div class="row"> <div class="col-md-8"> <h2>Chris Cranford</h2> <p> <span class="bio-size">Chris is a software engineer at Red Hat. He previously was a member of the Hibernate ORM team and now works on Debezium. He lives in North Carolina just a few hours from Red Hat towers.</span> </p> <p class="bio-size"> <a href="https://github.com/naros"> <i class="icon-github"></i> </a> &nbsp; <a href="https://www.linkedin.com/in/crancran"> <i class="icon-linkedin"></i> </a> &nbsp; </p> </div> <div class="col-md-4"> <img alt="" class="img-responsive pull-right portrait" src="/images/ccranfor.jpg"> </div> </div> </div> <div class="comments"> <div id="disqus_thread"></div> <script type="text/javascript">
            var disqus_shortname = 'Debezium';
            var disqus_url = "https://debezium.io/blog/2020/01/22/outbox-quarkus-extension/";
            var disqus_developer = null;
            var disqus_identifier = null;
            (function() {
              var dsq = document.createElement("script"); dsq.type = "text/javascript"; dsq.async = true;
              dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName("head")[0] || document.getElementsByTagName("body")[0]).appendChild(dsq);
            })();
            </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript=Debezium">comments powered by Disqus.</a></noscript> </div> </div> </div> </div> </div> <footer class="container"> <div class="row"> <div class="col-md-5 col-md-offset-1"> <h4>Debezium</h4> <p> &#169; 2020 Debezium Community <br> <br> <i class="icon-fire"></i> Mixed with <a href="http://twitter.github.com/bootstrap">Bootstrap</a>, baked by <a href="http://awestruct.org">Awestruct</a>. <br> <i class="icon-flag"></i> Website and docs licensed under <a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>. <br> <i class="icon-flag-alt"></i> Code released under <a href="http://www.apache.org/licenses/LICENSE-2.0.html">Apache License, v2.0</a>. <br> <i class="icon-file-alt"></i> <a href="https://www.redhat.com/legal/legal_statement.html" title="Terms">Terms</a> | <a href="https://www.redhat.com/legal/privacy_statement.html" title="Privacy Policy">Privacy</a> </p> </div> <div class="col-md-3"> <h4>Documentation</h4> <ul class="list-unstyled"> <li> <a href="/documentation/features" title="Features">Features</a> </li> <li> <a href="/documentation/install/stable/" title="Install">Install</a> </li> <li> <a href="/documentation/architecture/" title="Architecture">Architecture</a> </li> <li> <a href="/documentation/faq/" title="FAQ">FAQ</a> </li> <li> <a href="/community/contribute/" title="Contribute">Contribute</a> </li> </ul> </div> <div class="col-md-3"> <h4>Connect</h4> <ul class="list-unstyled"> <li> <a href="/blog" title="Blog">Blog</a> </li> <li> <a href="http://twitter.com/debezium" title="Twitter">Twitter</a> </li> <li> <a href="http://github.com/debezium" title="GitHub">GitHub</a> </li> <li> <a href="https://gitter.im/debezium/user" title="Chat">Chat</a> </li> <li> <a href="https://groups.google.com/forum/#!forum/debezium" title="Google Groups">Google Groups</a> </li> <li> <a href="http://stackoverflow.com/questions/tagged/debezium" title="StackOverflow">StackOverflow</a> </li> </ul> </div> </div> </footer> <div class="container" id="companyfooter"> <div class="redhatlogo"> <div id="logospacer"></div> <a href="https://www.redhat.com/"><img src="/images/Logo-Red_Hat-Sponsored_By-B-Standard-RGB.svg"></a> </div> </div> <span class="backToTop"> <a href="#top">back to top</a> </span> <script src="https://static.jboss.org/theme/js/libs/bootstrap-community/3.2.0.2/bootstrap-community.min.js"></script> <script type='text/javascript' language='JavaScript' src='https://www.redhat.com/j/elqNow/elqCfg.js'></script> <script type='text/javascript' language='JavaScript' src='https://www.redhat.com/j/elqNow/elqImg.js'></script> <div id="oTags"> <script type="text/javascript" src="//www.redhat.com/j/s_code.js"></script> <script type="text/javascript"><!--
  var coreUrl = encodeURI(document.URL.split("?")[0]).replace(/-/g," ");
  var urlSplit = coreUrl.toLowerCase().split(/\//);
  var urlLast = urlSplit[urlSplit.length-1];
  var pageNameString = "";
  var siteName = "";
  var minorSectionIndex = 3
  if (urlLast == "") {
      urlSplit.splice(-1,1);
  }
  if (urlLast.search(/\./) >= 0) {
      if (urlLast == "index.html") {
          urlSplit.splice(-1,1);
      }
      else {
          urlSplit[urlSplit.length-1] = urlLast.split(".").splice(0,1);
      }
  }
  siteName = urlSplit[2].split(".")[1];
  s.prop14 = s.eVar27 = siteName || "";
  s.prop15 = s.eVar28 = urlSplit[minorSectionIndex] || "";
  s.prop16 = s.eVar29 = urlSplit[minorSectionIndex+1] || "";
  pageNameString = urlSplit.splice(3).join(" | ");
  s.pageName = "jboss | community | " + siteName + " | " + pageNameString;
  s.server = "jboss";
  s.channel = "jboss | community";
  s.prop4 = s.eVar23 = encodeURI(document.URL);
  s.prop21 = s.eVar18 = coreUrl;
  s.prop2 = s.eVar22 = "en";
  s.prop3 = s.eVar19 = "us";
  //--></script> <script type="text/javascript" src="//www.redhat.com/j/rh_omni_footer.js"></script> <script language="JavaScript" type="text/javascript"><!--
  if(navigator.appVersion.indexOf('MSIE')>=0)document.write(unescape('%3C')+'\!-'+'-')
  //--></script> <noscript><a href="http://www.omniture.com" title="Web Analytics"><img src="https://smtrcs.redhat.com/b/ss/redhatcom,redhatglobal/1/H.25.4--NS/0?[AQB]&cdp=3&[AQE]" height="1" width="1" border="0" alt=""/></a></noscript> </div> <script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script> <script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-10656779-1");
pageTracker._trackPageview();
} catch(err) {}</script> <script>
 (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
 
ga('create', 'UA-76464546-1', 'auto');
ga('send', 'pageview');
ga('set', 'anonymizeIp', true);
ga('require', 'linkid', 'linkid.js');

</script> </div> </body> </html>