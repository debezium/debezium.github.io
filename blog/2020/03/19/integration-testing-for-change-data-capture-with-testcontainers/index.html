<!DOCTYPE html> <html> <head> <title>Integration Testing for Change Data Capture with Testcontainers</title> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1"> <meta name="description" content="Debezium is an open source distributed platform for change data capture. Start it up, point it at your databases, and your apps can start responding to all of the inserts, updates, and deletes that other apps commit to your databases. Debezium is durable and fast, so your apps can respond quickly and never miss an event, even when things go wrong."> <meta content="Debezium" property="og:site_name"> <meta content="Integration Testing for Change Data Capture with Testcontainers" property="og:title"> <meta content="https://debezium.io/assets/images/color_black_debezium_type_1200px.png" property="og:image" name="image"> <meta property="og:description" content="Debezium is an open source distributed platform for change data capture. Start it up, point it at your databases, and your apps can start responding to all of the inserts, updates, and deletes that other apps commit to your databases. Debezium is durable and fast, so your apps can respond quickly and never miss an event, even when things go wrong."> <meta property="og:url" content="https://debezium.io/blog/2020/03/19/integration-testing-for-change-data-capture-with-testcontainers/"> <meta name="twitter:site" content="@debezium"> <meta name="twitter:title" content="Integration Testing for Change Data Capture with Testcontainers"> <meta name="twitter:creator" content="@gmorling"> <meta name="twitter:description" content="Debezium is an open source distributed platform for change data capture. Start it up, point it at your databases, and your apps can start responding to all of the inserts, updates, and deletes that other apps commit to your databases. Debezium is durable and fast, so your apps can respond quickly and never miss an event, even when things go wrong."> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:image" content="https://debezium.io/assets/images/color_black_debezium_type_1200px.png"> <meta property="twitter:url" content="https://debezium.io/blog/2020/03/19/integration-testing-for-change-data-capture-with-testcontainers/"> <link rel="alternate" type="application/rss+xml" title="Debezium Blog" href="/blog.atom"> <link rel="shortcut icon" type="image/png" href="/favicon.ico"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css"/> <link rel="stylesheet" href="/assets/css/custom.css"/> <link rel="stylesheet" href="/assets/css/highlight.min.css"/> <link rel="stylesheet" href="/assets/css/coderay.css"/> </head> <body class="post"> <div id="rhbar"> <a class="jbdevlogo" href="https://developers.redhat.com"></a> <a class="rhlogo" href="https://www.redhat.com/"></a> </div> <div id> <div class="container" id="content"> <nav class="navbar navbar-inverse navbar-fix"> <div class="container-fluid"> <div class="navbar-header"> <button class="navbar-toggle collapsed border-0" type="button" data-toggle="collapse" data-target="#navigation" aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href="/"><img class="project-logo" src="/assets/images/color_white_debezium_type_600px.svg" style="height: 32px; margin-right: 5px; margin-top: -5px;"></a> </div> <div class="collapse navbar-collapse collapsed" id="navigation"> <ul class="nav navbar-nav pull-right"> <li> <a href="/documentation/faq" class="">FAQ</a> </li> <li class="item"> <a href="/documentation/" class="">Documentation</a> </li> <li> <a href="/releases/" class="">Releases</a> </li> <li> <a href="/community/" class="">Community</a> </li> <li class="active"> <a href="/blog/" class="active">Blog</a> </li> </ul> </div> </div> </nav> <div class="row post-text-padding row-no-expand"> <div class="col-md-3"><div id="leftdocnav"> <div class="hidden-lg hidden-md hidden-sm"> <button class="navbar-toggle docssubmenu-toggle collapsed" data-target="#docssubmenu" data-toggle="collapse" style=" float: none; background-color: #656565; border-color: #656565; width: 100%; color: #fff; "> Navigation Menu </button> </div> <div class="collapse" id="docssubmenu"> <div class="doc-pills"> <ul class="nav nav-pills nav-stacked"> <li class="item"> <a href="/blog">Home</a> <div class="icon"><span class="icon-home"></span></div> </li> <li class="item"> <a href="/archives">Archive</a> <div class="icon"><span class="icon-arrow-down"></span></div> </li> <li class="item"> <a href="/blog.atom">Feed</a> <div class="icon"><span class="icon-rss"></span></div> </li> </ul> </div> <p></p> <div class="featured-posts"> <div id="#featured" style="margin-bottom: 4px; border-bottom: 1px solid #ccc; font-size: 115%; margin-left: 2px;">Featured Posts</div> <ul style="padding-inline-start: 22px;"> <li style="margin-bottom: 3px;"> <a href="/blog/2024/07/08/async-embedded-engine/" style="font-size: 95%;"> Debezium asynchronous engine </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2024/01/11/Debezium-and-TimescaleDB/" style="font-size: 95%;"> Debezium and TimescaleDB </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2023/12/20/JDBC-sink-connector-batch-support/" style="font-size: 95%;"> Streamlined Performance: Debezium JDBC connector batch support </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2023/10/19/Debezium-Operator-Takes-off-to-the-Clouds/" style="font-size: 95%;"> Debezium Operator Takes off to the Clouds </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2023/10/05/Debezium-JMX-signaling-and-notifications/" style="font-size: 95%;"> Debezium signaling and notifications - Part 3: JMX channel </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2023/09/23/flink-spark-online-learning/" style="font-size: 95%;"> Online machine learning with the data streams from the database </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2023/07/10/custom-http-signaling-notification/" style="font-size: 95%;"> Debezium signaling and notifications - Part 2: Customisation </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2023/06/27/Debezium-signaling-and-notifications/" style="font-size: 95%;"> Debezium signaling and notifications - Part 1 </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2023/05/02/tensorflow-mnist-classification/" style="font-size: 95%;"> Image classification with Debezium and TensorFlow </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2020/11/04/streaming-vitess-at-bolt/" style="font-size: 95%;"> Streaming Vitess at Bolt </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2020/02/10/event-sourcing-vs-cdc/" style="font-size: 95%;"> Distributed Data for Microservices â€” Event Sourcing vs. Change Data Capture </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2019/10/01/audit-logs-with-change-data-capture-and-stream-processing/" style="font-size: 95%;"> Building Audit Logs with Change Data Capture and Stream Processing </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2019/07/12/streaming-cassandra-at-wepay-part-1/" style="font-size: 95%;"> Streaming Cassandra at WePay - Part 1 </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2019/02/19/reliable-microservices-data-exchange-with-the-outbox-pattern/" style="font-size: 95%;"> Reliable Microservices Data Exchange With the Outbox Pattern </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/12/05/automating-cache-invalidation-with-change-data-capture/" style="font-size: 95%;"> Automating Cache Invalidation With Change Data Capture </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/09/20/materializing-aggregate-views-with-hibernate-and-debezium/" style="font-size: 95%;"> Materializing Aggregate Views With Hibernate and Debezium </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/07/19/advantages-of-log-based-change-data-capture/" style="font-size: 95%;"> Five Advantages of Log-Based Change Data Capture </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/03/08/creating-ddd-aggregates-with-debezium-and-kafka-streams/" style="font-size: 95%;"> Creating DDD aggregates with Debezium and Kafka Streams </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/01/17/streaming-to-elasticsearch/" style="font-size: 95%;"> Streaming Data Changes from Your Database to Elasticsearch </a> </li> </ul> </div> <p></p> <p></p> <div class="cloud-tags"> <div id="tags" style="margin-bottom: 4px; border-bottom: 1px solid #ccc; font-size: 115%; margin-left: 2px;"> Tags </div> <div class="tag-cloud"> <span class="site-tag"> <a href="/tag/apache-kafka/" style="font-size: 82%"> apache kafka </a> </span> <span class="site-tag"> <a href="/tag/apache-kafka/" style="font-size: 96%"> apache kafka </a> </span> <span class="site-tag"> <a href="/tag/apicurio/" style="font-size: 82%"> apicurio </a> </span> <span class="site-tag"> <a href="/tag/avro/" style="font-size: 84%"> avro </a> </span> <span class="site-tag"> <a href="/tag/aws/" style="font-size: 82%"> aws </a> </span> <span class="site-tag"> <a href="/tag/batch/" style="font-size: 82%"> batch </a> </span> <span class="site-tag"> <a href="/tag/caassandra/" style="font-size: 86%"> caassandra </a> </span> <span class="site-tag"> <a href="/tag/camel/" style="font-size: 82%"> camel </a> </span> <span class="site-tag"> <a href="/tag/cassandra/" style="font-size: 290%"> cassandra </a> </span> <span class="site-tag"> <a href="/tag/cdc/" style="font-size: 82%"> cdc </a> </span> <span class="site-tag"> <a href="/tag/channels/" style="font-size: 82%"> channels </a> </span> <span class="site-tag"> <a href="/tag/community/" style="font-size: 124%"> community </a> </span> <span class="site-tag"> <a href="/tag/community-stories/" style="font-size: 84%"> community stories </a> </span> <span class="site-tag"> <a href="/tag/connectors/" style="font-size: 82%"> connectors </a> </span> <span class="site-tag"> <a href="/tag/containers/" style="font-size: 82%"> containers </a> </span> <span class="site-tag"> <a href="/tag/cqrs/" style="font-size: 84%"> cqrs </a> </span> <span class="site-tag"> <a href="/tag/custom/" style="font-size: 82%"> custom </a> </span> <span class="site-tag"> <a href="/tag/datalake/" style="font-size: 82%"> datalake </a> </span> <span class="site-tag"> <a href="/tag/db2/" style="font-size: 274%"> db2 </a> </span> <span class="site-tag"> <a href="/tag/ddd/" style="font-size: 82%"> ddd </a> </span> <span class="site-tag"> <a href="/tag/debezium/" style="font-size: 104%"> debezium </a> </span> <span class="site-tag"> <a href="/tag/debezium-server/" style="font-size: 92%"> debezium server </a> </span> <span class="site-tag"> <a href="/tag/debezium-ui/" style="font-size: 90%"> debezium ui </a> </span> <span class="site-tag"> <a href="/tag/deduplication/" style="font-size: 82%"> deduplication </a> </span> <span class="site-tag"> <a href="/tag/discussion/" style="font-size: 114%"> discussion </a> </span> <span class="site-tag"> <a href="/tag/docker/" style="font-size: 186%"> docker </a> </span> <span class="site-tag"> <a href="/tag/elasticsearch/" style="font-size: 82%"> elasticsearch </a> </span> <span class="site-tag"> <a href="/tag/event-sourcing/" style="font-size: 82%"> event sourcing </a> </span> <span class="site-tag"> <a href="/tag/exactly-once-semantics/" style="font-size: 82%"> exactly once semantics </a> </span> <span class="site-tag"> <a href="/tag/example/" style="font-size: 88%"> example </a> </span> <span class="site-tag"> <a href="/tag/examples/" style="font-size: 118%"> examples </a> </span> <span class="site-tag"> <a href="/tag/features/" style="font-size: 92%"> features </a> </span> <span class="site-tag"> <a href="/tag/fedora/" style="font-size: 82%"> fedora </a> </span> <span class="site-tag"> <a href="/tag/flink/" style="font-size: 84%"> flink </a> </span> <span class="site-tag"> <a href="/tag/hiring/" style="font-size: 84%"> hiring </a> </span> <span class="site-tag"> <a href="/tag/ibmi/" style="font-size: 98%"> ibmi </a> </span> <span class="site-tag"> <a href="/tag/iceberg/" style="font-size: 82%"> iceberg </a> </span> <span class="site-tag"> <a href="/tag/informix/" style="font-size: 108%"> informix </a> </span> <span class="site-tag"> <a href="/tag/integration/" style="font-size: 86%"> integration </a> </span> <span class="site-tag"> <a href="/tag/introduction/" style="font-size: 84%"> introduction </a> </span> <span class="site-tag"> <a href="/tag/jaeger/" style="font-size: 82%"> jaeger </a> </span> <span class="site-tag"> <a href="/tag/jdbc/" style="font-size: 110%"> jdbc </a> </span> <span class="site-tag"> <a href="/tag/json/" style="font-size: 82%"> json </a> </span> <span class="site-tag"> <a href="/tag/kafka/" style="font-size: 94%"> kafka </a> </span> <span class="site-tag"> <a href="/tag/kafka-streams/" style="font-size: 82%"> kafka streams </a> </span> <span class="site-tag"> <a href="/tag/kafka-streams/" style="font-size: 86%"> kafka streams </a> </span> <span class="site-tag"> <a href="/tag/kogito/" style="font-size: 82%"> kogito </a> </span> <span class="site-tag"> <a href="/tag/ksql/" style="font-size: 82%"> ksql </a> </span> <span class="site-tag"> <a href="/tag/kubernetes/" style="font-size: 84%"> kubernetes </a> </span> <span class="site-tag"> <a href="/tag/lakehouse/" style="font-size: 82%"> lakehouse </a> </span> <span class="site-tag"> <a href="/tag/machine-learning/" style="font-size: 86%"> machine learning </a> </span> <span class="site-tag"> <a href="/tag/mariadb/" style="font-size: 106%"> mariadb </a> </span> <span class="site-tag"> <a href="/tag/microservices/" style="font-size: 84%"> microservices </a> </span> <span class="site-tag"> <a href="/tag/mongo/" style="font-size: 86%"> mongo </a> </span> <span class="site-tag"> <a href="/tag/mongodb/" style="font-size: 292%"> mongodb </a> </span> <span class="site-tag"> <a href="/tag/mysql/" style="font-size: 428%"> mysql </a> </span> <span class="site-tag"> <a href="/tag/news/" style="font-size: 112%"> news </a> </span> <span class="site-tag"> <a href="/tag/newsletter/" style="font-size: 88%"> newsletter </a> </span> <span class="site-tag"> <a href="/tag/notifications/" style="font-size: 86%"> notifications </a> </span> <span class="site-tag"> <a href="/tag/online-learning/" style="font-size: 84%"> online learning </a> </span> <span class="site-tag"> <a href="/tag/operator/" style="font-size: 82%"> operator </a> </span> <span class="site-tag"> <a href="/tag/oracle/" style="font-size: 324%"> oracle </a> </span> <span class="site-tag"> <a href="/tag/outbox/" style="font-size: 262%"> outbox </a> </span> <span class="site-tag"> <a href="/tag/performance/" style="font-size: 82%"> performance </a> </span> <span class="site-tag"> <a href="/tag/postgres/" style="font-size: 398%"> postgres </a> </span> <span class="site-tag"> <a href="/tag/presentation/" style="font-size: 84%"> presentation </a> </span> <span class="site-tag"> <a href="/tag/production/" style="font-size: 82%"> production </a> </span> <span class="site-tag"> <a href="/tag/quarkus/" style="font-size: 92%"> quarkus </a> </span> <span class="site-tag"> <a href="/tag/questdb/" style="font-size: 82%"> questdb </a> </span> <span class="site-tag"> <a href="/tag/rds/" style="font-size: 84%"> rds </a> </span> <span class="site-tag"> <a href="/tag/releases/" style="font-size: 410%"> releases </a> </span> <span class="site-tag"> <a href="/tag/schema/" style="font-size: 82%"> schema </a> </span> <span class="site-tag"> <a href="/tag/scylla/" style="font-size: 82%"> scylla </a> </span> <span class="site-tag"> <a href="/tag/secrets/" style="font-size: 82%"> secrets </a> </span> <span class="site-tag"> <a href="/tag/sentry/" style="font-size: 82%"> sentry </a> </span> <span class="site-tag"> <a href="/tag/serialization/" style="font-size: 82%"> serialization </a> </span> <span class="site-tag"> <a href="/tag/signaling/" style="font-size: 86%"> signaling </a> </span> <span class="site-tag"> <a href="/tag/smt/" style="font-size: 84%"> smt </a> </span> <span class="site-tag"> <a href="/tag/snapshots/" style="font-size: 84%"> snapshots </a> </span> <span class="site-tag"> <a href="/tag/spanner/" style="font-size: 150%"> spanner </a> </span> <span class="site-tag"> <a href="/tag/spark/" style="font-size: 84%"> spark </a> </span> <span class="site-tag"> <a href="/tag/sql/" style="font-size: 84%"> sql </a> </span> <span class="site-tag"> <a href="/tag/sqlserver/" style="font-size: 338%"> sqlserver </a> </span> <span class="site-tag"> <a href="/tag/tensorflow/" style="font-size: 82%"> tensorflow </a> </span> <span class="site-tag"> <a href="/tag/testcontainers/" style="font-size: 88%"> testcontainers </a> </span> <span class="site-tag"> <a href="/tag/tests/" style="font-size: 82%"> tests </a> </span> <span class="site-tag"> <a href="/tag/time-series/" style="font-size: 82%"> time series </a> </span> <span class="site-tag"> <a href="/tag/timescaledb/" style="font-size: 82%"> timescaledb </a> </span> <span class="site-tag"> <a href="/tag/topics/" style="font-size: 82%"> topics </a> </span> <span class="site-tag"> <a href="/tag/tracing/" style="font-size: 82%"> tracing </a> </span> <span class="site-tag"> <a href="/tag/transactions/" style="font-size: 82%"> transactions </a> </span> <span class="site-tag"> <a href="/tag/vagrant/" style="font-size: 82%"> vagrant </a> </span> <span class="site-tag"> <a href="/tag/vitess/" style="font-size: 254%"> vitess </a> </span> <span class="site-tag"> <a href="/tag/website/" style="font-size: 84%"> website </a> </span> </div> </div> </div> </div> </div> <div class="col-md-9"> <div class="post"> <div class="row" style="margin-left: 0; margin-right: 0; margin-bottom: 10px"> <div class="col-sm-12" style="padding-left: 0px"> <div style="display: table-cell; vertical-align: top"> <div style=" width: 72px; border: 1px solid #ccc; padding: 3px; display: inline-block; "> <img src="/assets/images/gmorling.jpg" style="width: 64px;"> </div> </div> <div style="display: table-cell; vertical-align: top"> <div style="margin-left: 8px"> <span class="hidden-sm hidden-xs" style="font-size: 2.75rem; line-height: 1"> <a href="/blog/2020/03/19/integration-testing-for-change-data-capture-with-testcontainers/">Integration Testing for Change Data Capture with Testcontainers</a> </span> <span class="hidden-md hidden-lg" style="font-size: 2rem; line-height: 1"> <a href="/blog/2020/03/19/integration-testing-for-change-data-capture-with-testcontainers/">Integration Testing for Change Data Capture with Testcontainers</a> </span> <div class="byline" style="line-height: 1"> <em> March 19, 2020 by </em> <em> Gunnar Morling </em> <div class="hidden-xs" style="margin-top: 5px"> <a class="label label-info hidden-sm hidden-xs" href="/tag/discussion/">discussion</a> <a class="label label-info hidden-sm hidden-xs" href="/tag/testcontainers/">testcontainers</a> <a class="label label-info hidden-sm hidden-xs" href="/tag/postgres/">postgres</a> </div> </div> </div> </div> </div> </div> <div class="grid__item width-12-12"><div class="paragraph"> <p>Setting up change data capture (CDC) pipelines with Debezium typically is a matter of configuration, without any programming being involved. It&#8217;s still a very good idea to have automated tests for your CDC set-up, making sure that everything is configured correctly and that your Debezium connectors are set up as intended.</p> </div> <div class="paragraph"> <p>There&#8217;s two main components involved whose configuration need consideration:</p> </div> <div class="ulist"> <ul> <li> <p><strong>The source database:</strong> it must be set up so that Debezium can connect to it and retrieve change events; details depend on the specific database, e.g. for MySQL the binlog must be in "row" mode, for Postgres, one of the supported logical decoding plug-ins must be installed, etc.</p> </li> <li> <p><strong>The Debezium connector:</strong> it must be configured using the right database host and credentials, possibly using SSL, applying table and column filters, potentially one or more single message transformations (SMTs), etc.</p> </li> </ul> </div> <div class="paragraph"> <p></p> </div> <div class="paragraph"> <p>This is where the newly added Debezium <a href="https://debezium.io/documentation/reference/1.1/integrations/testcontainers.html">support for integration tests</a> with <a href="https://www.testcontainers.org/">Testcontainers</a> comes in. It allows to set up all the required components (Apache Kafka, Kafka Connect etc.) using Linux container images, configure and deploy a Debezium connector and run assertions against produced change data events.</p> </div> <div class="paragraph"> <p>Let&#8217;s take a look at how it&#8217;s done.</p> </div> <div class="sect1"> <h2 id="project_set_up">Project Set-Up</h2> <div class="sectionbody"> <div class="paragraph"> <p>Assuming you&#8217;re working with Apache Maven for dependency management, add the following dependencies to your <em>pom.xml</em>, pulling in the Debezium Testcontainers integration and the Testcontainers <a href="https://www.testcontainers.org/modules/kafka/">module for Apache Kafka</a>:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>io.debezium<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>debezium-testing-testcontainers<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;version&gt;</span>1.1.0.CR1<span class="tag">&lt;/version&gt;</span>
  <span class="tag">&lt;scope&gt;</span>test<span class="tag">&lt;/scope&gt;</span>
<span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.testcontainers<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>kafka<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;scope&gt;</span>test<span class="tag">&lt;/scope&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Also add the Testcontainers dependency for your database, e.g. Postgres:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.testcontainers<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>postgresql<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;scope&gt;</span>test<span class="tag">&lt;/scope&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>You can find an example project with the complete configuration in the <a href="https://github.com/debezium/debezium-examples/tree/main/testcontainers">debezium-examples</a> repo on GitHub.</p> </div> </div> </div> <div class="sect1"> <h2 id="initializing_testcontainers">Initializing Testcontainers</h2> <div class="sectionbody"> <div class="paragraph"> <p>Having declared all the required dependencies, it&#8217;s time to write a CDC integration test. With Testcontainers, integration tests are implemented using Linux containers and Docker. It provides a Java API for starting and managing the resources needed by a test. We can use this to fire up Apache Kafka, Kafka Connect and a Postgres database:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">CdcTest</span> {

  <span class="directive">private</span> <span class="directive">static</span> Network network = Network.newNetwork(); <i class="conum" data-value="1"></i><b>(1)</b>

  <span class="directive">private</span> <span class="directive">static</span> KafkaContainer kafkaContainer = <span class="keyword">new</span> KafkaContainer()
      .withNetwork(network); <i class="conum" data-value="2"></i><b>(2)</b>

  <span class="directive">public</span> <span class="directive">static</span> PostgreSQLContainer&lt;?&gt; postgresContainer =
      <span class="keyword">new</span> PostgreSQLContainer&lt;&gt;(<span class="string"><span class="delimiter">&quot;</span><span class="content">debezium/postgres:11</span><span class="delimiter">&quot;</span></span>)
          .withNetwork(network)
          .withNetworkAliases(<span class="string"><span class="delimiter">&quot;</span><span class="content">postgres</span><span class="delimiter">&quot;</span></span>); <i class="conum" data-value="3"></i><b>(3)</b>

  <span class="directive">public</span> <span class="directive">static</span> DebeziumContainer debeziumContainer =
      <span class="keyword">new</span> DebeziumContainer(<span class="string"><span class="delimiter">&quot;</span><span class="content">1.1.0.CR1</span><span class="delimiter">&quot;</span></span>)
          .withNetwork(network)
          .withKafka(kafkaContainer)
          .dependsOn(kafkaContainer); <i class="conum" data-value="4"></i><b>(4)</b>

  <span class="annotation">@BeforeClass</span>
  <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> startContainers() { <i class="conum" data-value="5"></i><b>(5)</b>
    Startables.deepStart(Stream.of(
        kafkaContainer, postgresContainer, debeziumContainer))
            .join();
  }
}</code></pre> </div> </div> <div class="colist arabic"> <table> <tr> <td><i class="conum" data-value="1"></i><b>1</b></td> <td>Define a Docker network to be used by all the services</td> </tr> <tr> <td><i class="conum" data-value="2"></i><b>2</b></td> <td>Set up a container for Apache Kafka</td> </tr> <tr> <td><i class="conum" data-value="3"></i><b>3</b></td> <td>Set up a container for Postgres 11 (using Debezium&#8217;s Postgres container image)</td> </tr> <tr> <td><i class="conum" data-value="4"></i><b>4</b></td> <td>Set up a container for Kafka Connect with Debezium</td> </tr> <tr> <td><i class="conum" data-value="5"></i><b>5</b></td> <td>Start all three containers in a <code>@BeforeClass</code> method</td> </tr> </table> </div> <div class="paragraph"> <p>Note that you need to have Docker installed in order to use Testcontainers.</p> </div> </div> </div> <div class="sect1"> <h2 id="the_test_implementation">The Test Implementation</h2> <div class="sectionbody"> <div class="paragraph"> <p>With the needed infrastructure in place, we can write a test for our CDC set-up. The overall flow of the test is this:</p> </div> <div class="ulist"> <ul> <li> <p>Configure a Debezium connector for the Postgres database</p> </li> <li> <p>Execute a few SQL statements to change some data</p> </li> <li> <p>Retrieve the resulting change data events from the corresponding Kafka topic using a Kafka consumer</p> </li> <li> <p>Run some assertions against these events</p> </li> </ul> </div> <div class="paragraph"> <p>Here&#8217;s the shell for the test:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Test</span>
<span class="directive">public</span> <span class="type">void</span> canObtainChangeEventsFromPostgres() <span class="directive">throws</span> <span class="exception">Exception</span> {
  <span class="keyword">try</span> (<span class="predefined-type">Connection</span> connection = getConnection(postgresContainer);
      <span class="predefined-type">Statement</span> statement = connection.createStatement();
      KafkaConsumer&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; consumer =
          getConsumer(kafkaContainer)) {

      <span class="comment">// TODO ...</span>
  }
}</code></pre> </div> </div> <div class="paragraph"> <p>The credentials for the database connection can be obtained from the Postgres container started via Testcontainers, nicely avoiding any redundancies:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="predefined-type">Connection</span> getConnection(PostgreSQLContainer&lt;?&gt; postgresContainer)
    <span class="directive">throws</span> <span class="exception">SQLException</span> {

  <span class="keyword">return</span> <span class="predefined-type">DriverManager</span>.getConnection(postgresContainer.getJdbcUrl(),
      postgresContainer.getUsername(),
      postgresContainer.getPassword());
}</code></pre> </div> </div> <div class="paragraph"> <p>The same goes for the Kafka consumer:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> KafkaConsumer&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; getConsumer(
    KafkaContainer kafkaContainer) {

  <span class="keyword">return</span> <span class="keyword">new</span> KafkaConsumer&lt;&gt;(
      ImmutableMap.of(
          ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG,
          kafkaContainer.getBootstrapServers(),

          ConsumerConfig.GROUP_ID_CONFIG,
          <span class="string"><span class="delimiter">&quot;</span><span class="content">tc-</span><span class="delimiter">&quot;</span></span> + <span class="predefined-type">UUID</span>.randomUUID(),

          ConsumerConfig.AUTO_OFFSET_RESET_CONFIG,
          <span class="string"><span class="delimiter">&quot;</span><span class="content">earliest</span><span class="delimiter">&quot;</span></span>),
      <span class="keyword">new</span> StringDeserializer(),
      <span class="keyword">new</span> StringDeserializer());
}</code></pre> </div> </div> <div class="paragraph"> <p>Now let&#8217;s implement the actual test logic:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">statement.execute(<span class="string"><span class="delimiter">&quot;</span><span class="content">create schema todo</span><span class="delimiter">&quot;</span></span>); <i class="conum" data-value="1"></i><b>(1)</b>
statement.execute(<span class="string"><span class="delimiter">&quot;</span><span class="content">create table todo.Todo (</span><span class="delimiter">&quot;</span></span> +
                    <span class="string"><span class="delimiter">&quot;</span><span class="content">id int8 not null, </span><span class="delimiter">&quot;</span></span> +
                    <span class="string"><span class="delimiter">&quot;</span><span class="content">title varchar(255), </span><span class="delimiter">&quot;</span></span> +
                    <span class="string"><span class="delimiter">&quot;</span><span class="content">primary key (id))</span><span class="delimiter">&quot;</span></span>);
statement.execute(<span class="string"><span class="delimiter">&quot;</span><span class="content">alter table todo.Todo replica identity full</span><span class="delimiter">&quot;</span></span>);
statement.execute(<span class="string"><span class="delimiter">&quot;</span><span class="content">insert into todo.Todo values (1, 'Learn CDC')</span><span class="delimiter">&quot;</span></span>);
statement.execute(<span class="string"><span class="delimiter">&quot;</span><span class="content">insert into todo.Todo values (2, 'Learn Debezium')</span><span class="delimiter">&quot;</span></span>);

ConnectorConfiguration connector = ConnectorConfiguration
        .forJdbcContainer(postgresContainer)
        .with(<span class="string"><span class="delimiter">&quot;</span><span class="content">database.server.name</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">dbserver1</span><span class="delimiter">&quot;</span></span>);

debeziumContainer.registerConnector(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-connector</span><span class="delimiter">&quot;</span></span>,
        connector); <i class="conum" data-value="2"></i><b>(2)</b>

consumer.subscribe(<span class="predefined-type">Arrays</span>.asList(<span class="string"><span class="delimiter">&quot;</span><span class="content">dbserver1.todo.todo</span><span class="delimiter">&quot;</span></span>));

<span class="predefined-type">List</span>&lt;ConsumerRecord&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;&gt; changeEvents =
        drain(consumer, <span class="integer">2</span>); <i class="conum" data-value="3"></i><b>(3)</b>

ConsumerRecord&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; changeEvent = changeEvents.get(<span class="integer">0</span>);
assertThat(JsonPath.&lt;<span class="predefined-type">Integer</span>&gt; read(changeEvent.key(), <span class="string"><span class="delimiter">&quot;</span><span class="content">$.id</span><span class="delimiter">&quot;</span></span>))
  .isEqualTo(<span class="integer">1</span>);
assertThat(JsonPath.&lt;<span class="predefined-type">String</span>&gt; read(changeEvent.value(), <span class="string"><span class="delimiter">&quot;</span><span class="content">$.op</span><span class="delimiter">&quot;</span></span>))
  .isEqualTo(<span class="string"><span class="delimiter">&quot;</span><span class="content">r</span><span class="delimiter">&quot;</span></span>);
assertThat(JsonPath.&lt;<span class="predefined-type">String</span>&gt; read(changeEvent.value(), <span class="string"><span class="delimiter">&quot;</span><span class="content">$.after.title</span><span class="delimiter">&quot;</span></span>))
  .isEqualTo(<span class="string"><span class="delimiter">&quot;</span><span class="content">Learn CDC</span><span class="delimiter">&quot;</span></span>);

changeEvent = changeEvents.get(<span class="integer">1</span>);
assertThat(JsonPath.&lt;<span class="predefined-type">Integer</span>&gt; read(changeEvent.key(), <span class="string"><span class="delimiter">&quot;</span><span class="content">$.id</span><span class="delimiter">&quot;</span></span>))
  .isEqualTo(<span class="integer">2</span>);
assertThat(JsonPath.&lt;<span class="predefined-type">String</span>&gt; read(changeEvent.value(), <span class="string"><span class="delimiter">&quot;</span><span class="content">$.op</span><span class="delimiter">&quot;</span></span>))
  .isEqualTo(<span class="string"><span class="delimiter">&quot;</span><span class="content">r</span><span class="delimiter">&quot;</span></span>);
assertThat(JsonPath.&lt;<span class="predefined-type">String</span>&gt; read(changeEvent.value(), <span class="string"><span class="delimiter">&quot;</span><span class="content">$.after.title</span><span class="delimiter">&quot;</span></span>))
  .isEqualTo(<span class="string"><span class="delimiter">&quot;</span><span class="content">Learn Debezium</span><span class="delimiter">&quot;</span></span>);

consumer.unsubscribe();</code></pre> </div> </div> <div class="colist arabic"> <table> <tr> <td><i class="conum" data-value="1"></i><b>1</b></td> <td>Create a table in the Postgres database and insert two records</td> </tr> <tr> <td><i class="conum" data-value="2"></i><b>2</b></td> <td>Register an instance of the Debezium Postgres connector</td> </tr> <tr> <td><i class="conum" data-value="3"></i><b>3</b></td> <td>Read two records from the change event topic in Kafka and assert their attributes</td> </tr> </table> </div> <div class="paragraph"> <p>Note how Debezium&#8217;s Testcontainers support allows to seed the connector configuration from the database container, avoiding the need to give the database connection properties explicitly. Only the unique <code>database.server.name</code> must be given, and of course you could apply other configuration options such as table or column filters, SMTs and more.</p> </div> <div class="paragraph"> <p>The source code for the <code>drain()</code> method for reading a given number of records from a Kafka topic is omitted for the sake of brevity. You can <a href="https://github.com/debezium/debezium-examples/blob/main/testcontainers/src/test/java/io/debezium/examples/testcontainers/DebeziumContainerTest.java#L125-L138">find it</a> in the full example on GitHub.</p> </div> <div class="paragraph"> <p><a href="https://github.com/json-path/JsonPath">JsonPath-based</a> assertions come in handy for asserting the attributes of the expecting data change events, but of course you could also use any other JSON API for the job. When using Apache Avro instead of JSON as a serialization format, you&#8217;d have to use the Avro APIs instead.</p> </div> </div> </div> <div class="sect1"> <h2 id="wrap_up">Wrap-Up</h2> <div class="sectionbody"> <div class="paragraph"> <p>Testcontainers and Debezium&#8217;s support for it make it fairly easy to write automated integration tests for your CDC set-up.</p> </div> <div class="paragraph"> <p>The testing approach discussed in this post could be expanded in multiple ways. E.g. it might be desirable to put your connector configuration under revision control (so you can manage and track any configuration changes) and drive the test using these configuration files. You also might take things one step further and test your entire data streaming pipeline. To do so, you&#8217;d have to deploy not only the Debezium connector(s), but also a sink connector, e.g. for your data warehouse or search server. You could then run assertions against the data in those sink systems, ensuring the correctness of your data pipeline end-to-end.</p> </div> <div class="paragraph"> <p>What&#8217;s your take on testing CDC set-ups and pipelines? Let us know in the comments below!</p> </div> </div> </div></div> </div> <div class="well"> <div class="row"> <div class="col-md-8"> <h2>Gunnar Morling</h2> <p> <span class="bio-size">Gunnar is a software engineer at Decodable and an open-source enthusiast by heart. He has been the project lead of Debezium over many years. Gunnar has created open-source projects like kcctl, JfrUnit, and MapStruct, and is the spec lead for Bean Validation 2.0 (JSR 380). Heâ€™s based in Hamburg, Germany.</span> </p> <p class="bio-size"> <a href="https://twitter.com/gunnarmorling"> <i class="icon-twitter"></i> </a> &nbsp; <a href="https://github.com/gunnarmorling"> <i class="icon-github"></i> </a> &nbsp; </p> </div> <div class="col-md-4"> <img alt="" class="img-responsive pull-right portrait" src="/assets/images/gmorling.jpg"/> </div> </div> </div> <ul class="pager pager-blog"> <li class="previous"> <a href="/blog/2020/03/13/debezium-1-1-c1-released/" class="previous"> &laquo; Previous</a> </li> <li class="next"><a href="/blog/2020/03/24/debezium-1-1-final-released/">Next &raquo; </a></li> </ul> <div class="row"> <div class="col-md-12"> <hr> <h2>About Debezium</h2> <p> Debezium is an open source distributed platform that turns your existing databases into event streams, so applications can see and respond almost instantly to each committed row-level change in the databases. Debezium is built on top of <a href="http://kafka.apache.org/">Kafka</a> and provides <a href="http://kafka.apache.org/documentation.html#connect">Kafka Connect</a> compatible connectors that monitor specific database management systems. Debezium records the history of data changes in Kafka logs, so your application can be stopped and restarted at any time and can easily consume all of the events it missed while it was not running, ensuring that all events are processed correctly and completely. Debezium is <a href="/license/">open source</a> under the <a href="http://www.apache.org/licenses/LICENSE-2.0.html">Apache License, Version 2.0</a>. </p> </div> </div> <div class="row"> <div class="col-md-12"> <h2>Get involved</h2> <p> We hope you find Debezium interesting and useful, and want to give it a try. Follow us on Twitter <a href="https://twitter.com/debezium">@debezium</a>, <a href="https://debezium.zulipchat.com/#narrow/stream/302529-users">chat with us on Zulip</a>, or join our <a href="https://groups.google.com/forum/#!forum/debezium">mailing list</a> to talk with the community. All of the code is open source <a href="https://github.com/debezium/">on GitHub</a>, so build the code locally and help us improve ours existing connectors and add even more connectors. If you find problems or have ideas how we can improve Debezium, please let us know or <a href="https://issues.redhat.com/projects/DBZ/issues/">log an issue</a>. </p> </div> </div> <div id="disqus_thread"></div> <script>var disqus_config=function(){this.page.url="https://debezium.io/blog/2020/03/19/integration-testing-for-change-data-capture-with-testcontainers/",this.page.identifier="https://debezium.io/blog/2020/03/19/integration-testing-for-change-data-capture-with-testcontainers/"};!function(){var t=document,e=t.createElement("script");e.src="https://Debezium.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}();</script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> </div> </div> </div> <footer class="container"> <div> <div class="row mr-0 ml-0"> <div class="col-md-5 col-md-offset-1"> <h4>Debezium</h4> <p> &#169; 2024 Debezium Community <br/> <br/> <i class="icon-fire"></i> Mixed with <a href="https://getbootstrap.com/">Bootstrap</a>, baked by <a href="https://jekyllrb.com/">Jekyll</a>. <br/> <i class="icon-flag"></i> Website and docs licensed under <a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>. <br/> <i class="icon-flag-alt"></i> Code released under <a href="https://www.apache.org/licenses/LICENSE-2.0.html">Apache License, v2.0</a>. <br/> <i class="icon-file-alt"></i> <a href="https://www.redhat.com/legal/legal_statement.html" title="Terms">Terms</a> | <a href="https://www.redhat.com/legal/privacy_statement.html" title="Privacy Policy">Privacy</a> </p> <p>Rev: <a target="_blank" href="https://github.com/debezium/debezium.github.io/commit/1725a8296eec91e8ea106773ce893930de7ab5ca">1725a82</a> </p> </div> <div class="col-md-3"> <h4>Documentation</h4> <ul class="list-unstyled"> <li><a href="/documentation/reference/stable/features.html" title="Features">Features</a></li> <li> <a href="/documentation/reference/stable/install.html" title="Install">Install</a> </li> <li> <a href="/documentation/reference/stable/architecture.html" title="Architecture">Architecture</a> </li> <li><a href="/documentation/faq/" title="FAQ">FAQ</a></li> <li> <a href="/community/contribute/" title="Contribute">Contribute</a> </li> </ul> </div> <div class="col-md-3"> <h4>Connect</h4> <ul class="list-unstyled"> <li><a href="/blog" title="Blog">Blog</a></li> <li> <a href="https://twitter.com/debezium" title="Twitter">Twitter</a> </li> <li><a href="https://github.com/debezium" title="GitHub">GitHub</a></li> <li><a href="https://debezium.zulipchat.com/#narrow/stream/302529-users" title="Chat">Chat</a></li> <li> <a href="https://groups.google.com/forum/#!forum/debezium" title="Google Groups">Google Groups</a> </li> <li> <a href="https://stackoverflow.com/questions/tagged/debezium" title="StackOverflow">StackOverflow</a> </li> </ul> </div> </div> </div> </footer> <div class="container" id="companyfooter"> <div class="redhatlogo"> <a href="https://www.redhat.com/"> <img src="/assets/images/Logo-Red_Hat-Sponsored_By-B-Standard-RGB.svg"/> </a> </div> </div> </div> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-76464546-1"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-76464546-1");</script> <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script> <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script> <script type="text/javascript" src="/assets/javascript/vanilla-back-to-top.min.js"></script> <script type="text/javascript" src="/assets/javascript/highlight.min.js"></script> <script>addBackToTop({scrollDuration:400}),hljs.initHighlightingOnLoad();</script> </body> </html>