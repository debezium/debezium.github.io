<!DOCTYPE html>
<html>

<head>
  <title>Using Debezium With the Apicurio API and Schema Registry</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Debezium is an open source distributed platform for change data capture. Start it up, point it at your databases, and your apps can start responding to all of the inserts, updates, and deletes that other apps commit to your databases. Debezium is durable and fast, so your apps can respond quickly and never miss an event, even when things go wrong.">
  <link rel="alternate" type="application/rss+xml" title="Debezium Blog" href="/blog.atom">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/assets/css/bootstrap.min.css" />
  <link rel="stylesheet" href="/assets/css/custom.css" />
  
</head>

<body class="post">
  <div id="rhbar">
  <a class="jbdevlogo" href="https://developers.redhat.com"></a>
  <a class="rhlogo" href="https://www.redhat.com/"></a>
</div>

  <div id>
    <div class="container" id="content">
      <nav class="navbar navbar-inverse navbar-fix">
  <div class="container-fluid">
    <div class="navbar-header">
      <button class="navbar-toggle collapsed border-0" type="button" data-toggle="collapse" data-target="#navigation"
        aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/"><img class="project-logo" src="/assets/images/color_white_debezium_type_600px.svg" style="height: 32px; margin-right: 5px; margin-top: -5px;"></a>
    </div>
    <div class="collapse navbar-collapse collapsed" id="navigation">
      <ul class="nav navbar-nav pull-right">
        
            <li>
          
          <a href="/documentation/faq" class="">FAQ</a>
        </li>
        
            <li class="item">
          
          <a href="/documentation/" class="">Documentation</a>
        </li>
        
            <li>
          
          <a href="/releases/" class="">Releases</a>
        </li>
        
            <li>
          
            <a href="/community/" class="">Community</a>
        </li>
        
          <li class="active">
            
          <a href="/blog/" class="active">Blog</a>
        </li>
      </ul>
    </div>
  </div>
</nav>
        
          <div class="row post-text-padding row-no-expand">
  <!-- Sidebar -->
  <div class="col-md-3"><div id="leftdocnav">
  <div class="hidden-lg hidden-md hidden-sm">
    <button
      class="navbar-toggle docssubmenu-toggle collapsed"
      data-target="#docssubmenu"
      data-toggle="collapse"
      style="
        float: none;
        background-color: #656565;
        border-color: #656565;
        width: 100%;
        color: #fff;
      "
    >
      Navigation Menu
    </button>
  </div>
  <div class="collapse" id="docssubmenu">
    <div class="doc-pills">
      <ul class="nav nav-pills nav-stacked">
        <li class="item">
          <a href="/blog">Home</a>
          <div class="icon"><span class="icon-home"></span></div>
        </li>
        
          <li class="item">
        
          <a href="/archives">Archive</a>
          <div class="icon"><span class="icon-arrow-down"></span></div>
        </li>
        <li class="item">
          <a href="/blog.atom">Feed</a>
          <div class="icon"><span class="icon-rss"></span></div>
        </li>
      </ul>
    </div>
    <p></p>
    <div class="featured-posts">
      <div id="#featured" style="margin-bottom: 4px; border-bottom: 1px solid #ccc; font-size: 115%; margin-left: 2px;">Featured Posts</div>
        <ul style="padding-inline-start: 22px;">
          
            
          
            
          
            
            <li style="margin-bottom: 3px;">
              <a href="/blog/2020/11/04/streaming-vitess-at-bolt/" style="font-size: 95%;">
                Streaming Vitess at Bolt
              </a>
            </li>  
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
            <li style="margin-bottom: 3px;">
              <a href="/blog/2020/02/10/event-sourcing-vs-cdc/" style="font-size: 95%;">
                Distributed Data for Microservices â€” Event Sourcing vs. Change Data Capture
              </a>
            </li>  
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
            <li style="margin-bottom: 3px;">
              <a href="/blog/2019/10/01/audit-logs-with-change-data-capture-and-stream-processing/" style="font-size: 95%;">
                Building Audit Logs with Change Data Capture and Stream Processing
              </a>
            </li>  
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
            <li style="margin-bottom: 3px;">
              <a href="/blog/2019/07/12/streaming-cassandra-at-wepay-part-1/" style="font-size: 95%;">
                Streaming Cassandra at WePay - Part 1
              </a>
            </li>  
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
            <li style="margin-bottom: 3px;">
              <a href="/blog/2019/02/19/reliable-microservices-data-exchange-with-the-outbox-pattern/" style="font-size: 95%;">
                Reliable Microservices Data Exchange With the Outbox Pattern
              </a>
            </li>  
            
          
            
          
            
          
            
          
            
          
            
          
            
            <li style="margin-bottom: 3px;">
              <a href="/blog/2018/12/05/automating-cache-invalidation-with-change-data-capture/" style="font-size: 95%;">
                Automating Cache Invalidation With Change Data Capture
              </a>
            </li>  
            
          
            
          
            
          
            
            <li style="margin-bottom: 3px;">
              <a href="/blog/2018/09/20/materializing-aggregate-views-with-hibernate-and-debezium/" style="font-size: 95%;">
                Materializing Aggregate Views With Hibernate and Debezium
              </a>
            </li>  
            
          
            
          
            
          
            
          
            
          
            
            <li style="margin-bottom: 3px;">
              <a href="/blog/2018/07/19/advantages-of-log-based-change-data-capture/" style="font-size: 95%;">
                Five Advantages of Log-Based Change Data Capture
              </a>
            </li>  
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
            <li style="margin-bottom: 3px;">
              <a href="/blog/2018/03/08/creating-ddd-aggregates-with-debezium-and-kafka-streams/" style="font-size: 95%;">
                Creating DDD aggregates with Debezium and Kafka Streams
              </a>
            </li>  
            
          
            
          
            
          
            
          
            
            <li style="margin-bottom: 3px;">
              <a href="/blog/2018/01/17/streaming-to-elasticsearch/" style="font-size: 95%;">
                Streaming Data Changes from Your Database to Elasticsearch
              </a>
            </li>  
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        </ul>
    </div>
    <p></p>
    <p></p>
    <div class="cloud-tags">
      <div id="tags" style="margin-bottom: 4px; border-bottom: 1px solid #ccc; font-size: 115%; margin-left: 2px;"> Tags
      </div>
        <div class="tag-cloud"> 
          
          
          <span class="site-tag">
            <a href="/tag/apache-kafka/" style="font-size: 88%">
              apache kafka
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/apicurio/" style="font-size: 82%">
              apicurio
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/avro/" style="font-size: 84%">
              avro
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/aws/" style="font-size: 82%">
              aws
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/camel/" style="font-size: 82%">
              camel
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/cassandra/" style="font-size: 128%">
              cassandra
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/community/" style="font-size: 102%">
              community
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/cqrs/" style="font-size: 82%">
              cqrs
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/db2/" style="font-size: 108%">
              db2
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/debezium-server/" style="font-size: 86%">
              debezium server
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/discussion/" style="font-size: 112%">
              discussion
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/docker/" style="font-size: 182%">
              docker
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/ebezium-server/" style="font-size: 82%">
              ebezium server
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/elasticsearch/" style="font-size: 82%">
              elasticsearch
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/event-sourcing/" style="font-size: 82%">
              event sourcing
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/example/" style="font-size: 88%">
              example
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/examples/" style="font-size: 102%">
              examples
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/fedora/" style="font-size: 82%">
              fedora
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/integration/" style="font-size: 82%">
              integration
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/introduction/" style="font-size: 84%">
              introduction
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/json/" style="font-size: 82%">
              json
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/kafka/" style="font-size: 86%">
              kafka
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/kafka-streams/" style="font-size: 86%">
              kafka streams
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/kogito/" style="font-size: 82%">
              kogito
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/ksql/" style="font-size: 82%">
              ksql
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/kubernetes/" style="font-size: 82%">
              kubernetes
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/microservices/" style="font-size: 84%">
              microservices
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/mongodb/" style="font-size: 182%">
              mongodb
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/mysql/" style="font-size: 246%">
              mysql
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/news/" style="font-size: 100%">
              news
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/newsletter/" style="font-size: 86%">
              newsletter
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/oracle/" style="font-size: 144%">
              oracle
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/outbox/" style="font-size: 98%">
              outbox
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/postgres/" style="font-size: 216%">
              postgres
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/presentation/" style="font-size: 84%">
              presentation
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/production/" style="font-size: 82%">
              production
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/quarkus/" style="font-size: 90%">
              quarkus
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/rds/" style="font-size: 84%">
              rds
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/releases/" style="font-size: 230%">
              releases
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/schema/" style="font-size: 82%">
              schema
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/secrets/" style="font-size: 82%">
              secrets
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/sentry/" style="font-size: 82%">
              sentry
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/serialization/" style="font-size: 82%">
              serialization
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/smt/" style="font-size: 84%">
              smt
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/sql/" style="font-size: 84%">
              sql
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/sqlserver/" style="font-size: 164%">
              sqlserver
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/testcontainers/" style="font-size: 88%">
              testcontainers
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/topics/" style="font-size: 82%">
              topics
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/vagrant/" style="font-size: 82%">
              vagrant
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/vitess/" style="font-size: 90%">
              vitess
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/website/" style="font-size: 84%">
              website
            </a>
          </span>
          
        </div>
  </div>
  </div>
</div>
</div>
  <div class="col-md-9">
    <div class="post">
      
      <div
        class="row"
        style="margin-left: 0; margin-right: 0; margin-bottom: 10px"
      >
        <div class="col-sm-12" style="padding-left: 0px">
          <div style="display: table-cell; vertical-align: top">
            <div
              style="
                width: 72px;
                border: 1px solid #ccc;
                padding: 3px;
                display: inline-block;
              "
            >
             
                  <img src="/assets/images/jpechane.jpg" style="width: 64px;"> 
                
            </div>
          </div>
          <div style="display: table-cell; vertical-align: top">
            <div style="margin-left: 8px">
              <span
                class="hidden-sm hidden-xs"
                style="font-size: 2.75rem; line-height: 1"
              >
                <a href="/blog/2020/04/09/using-debezium-with-apicurio-api-schema-registry/">Using Debezium With the Apicurio API and Schema Registry</a>
              </span>
              <span
                class="hidden-md hidden-lg"
                style="font-size: 2rem; line-height: 1"
              >
                <a href="/blog/2020/04/09/using-debezium-with-apicurio-api-schema-registry/">Using Debezium With the Apicurio API and Schema Registry</a>
              </span>
              <div class="byline" style="line-height: 1">
                
                    
                    <em> April 9, 2020 by </em>
                    <em> Jiri Pechanec </em>
                <div class="hidden-xs" style="margin-top: 5px">
                  
                  <a
                    class="label label-info hidden-sm hidden-xs"
                    href="/tag/schema/"
                    >schema</a
                  >
                  
                  <a
                    class="label label-info hidden-sm hidden-xs"
                    href="/tag/avro/"
                    >avro</a
                  >
                  
                  <a
                    class="label label-info hidden-sm hidden-xs"
                    href="/tag/apicurio/"
                    >apicurio</a
                  >
                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="grid__item width-12-12"><div class="paragraph">
<p>Change events streamed from a database by Debezium are (in developer parlance) strongly typed.
This means that event consumers should be aware of the types of data conveyed in the events.
This problem of passing along message type data can be solved in multiple ways:</p>
</div>
<div class="paragraph">
<p><!-- more --></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>the message structure is passed out-of-band to the consumer, which is able to process the data stored in it</p>
</li>
<li>
<p>the message contains metadata (the <em>schema</em>) that is embedded within the message</p>
</li>
<li>
<p>the message contains a reference to a registry which contains the associated metadata</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>An example of the first case is Apache Kafka&#8217;s well known <code>JsonConverter</code>.
It can operate in two modes - with and without schemas.
When configured to work without schemas, it generates a plain JSON message where the consumer either needs to know the types of each field beforehand, or it needs to execute heuristic rules to "guess" and map values to datatypes.
While this approach is quite flexible it can fail for more advanced cases, e.g. temporal or other semantic types encoded as strings.
Also, constraints associated with the types are usually lost.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s an example of such a message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  "before": null,
  "after": {
    "id": 1001,
    "first_name": "Sally",
    "last_name": "Thomas",
    "email": "sally.thomas@acme.com"
  },
  "source": {
    "version": "1.1.0.Final",
    "connector": "mysql",
    "name": "dbserver1",
    "ts_ms": 0,
    "snapshot": "true",
    "db": "inventory",
    "table": "customers",
    "server_id": 0,
    "gtid": null,
    "file": "mysql-bin.000003",
    "pos": 154,
    "row": 0,
    "thread": null,
    "query": null
  },
  "op": "c",
  "ts_ms": 1586331101491,
  "transaction": null
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note how no type information beyond JSON&#8217;s basic type system is present.
E.g. a consumer cannot conclude from the event itself, which length the numeric <code>id</code> field has.</p>
</div>
<div class="paragraph">
<p>An example of the second case is again <code>JsonConverter</code>.
By means of its <code>schemas.enable</code> option, the JSON message will consist of two parts - <code>schema</code> and <code>payload</code>.
The <code>payload</code> part is exactly the same as in the previous case; the <code>schema</code> part contains a description of the message, its fields, field types and associated type constraints.
This enables the consumer to process the message in a type-safe way.
The drawback of this approach is that the message size has increased significantly, as the schema is quite a large object.
As schemas tend to be changed rarely (how often do you change the definitions of the columns of your database tables?),
adding the schema to each and every event poses a signficant overhead.</p>
</div>
<div class="paragraph">
<p>The following example of a message with a schema clearly shows that the schema itself can be significantly larger than the payload and is not very economical to use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  "schema": {
    "type": "struct",
    "fields": [
      {
        "type": "struct",
        "fields": [
          {
            "type": "int32",
            "optional": false,
            "field": "id"
          },
          {
            "type": "string",
            "optional": false,
            "field": "first_name"
          },
          {
            "type": "string",
            "optional": false,
            "field": "last_name"
          },
          {
            "type": "string",
            "optional": false,
            "field": "email"
          }
        ],
        "optional": true,
        "name": "dbserver1.inventory.customers.Value",
        "field": "before"
      },
      {
        "type": "struct",
        "fields": [
          {
            "type": "int32",
            "optional": false,
            "field": "id"
          },
          {
            "type": "string",
            "optional": false,
            "field": "first_name"
          },
          {
            "type": "string",
            "optional": false,
            "field": "last_name"
          },
          {
            "type": "string",
            "optional": false,
            "field": "email"
          }
        ],
        "optional": true,
        "name": "dbserver1.inventory.customers.Value",
        "field": "after"
      },
      {
        "type": "struct",
        "fields": [
          {
            "type": "string",
            "optional": false,
            "field": "version"
          },
          {
            "type": "string",
            "optional": false,
            "field": "connector"
          },
          {
            "type": "string",
            "optional": false,
            "field": "name"
          },
          {
            "type": "int64",
            "optional": false,
            "field": "ts_ms"
          },
          {
            "type": "string",
            "optional": true,
            "name": "io.debezium.data.Enum",
            "version": 1,
            "parameters": {
              "allowed": "true,last,false"
            },
            "default": "false",
            "field": "snapshot"
          },
          {
            "type": "string",
            "optional": false,
            "field": "db"
          },
          {
            "type": "string",
            "optional": true,
            "field": "table"
          },
          {
            "type": "int64",
            "optional": false,
            "field": "server_id"
          },
          {
            "type": "string",
            "optional": true,
            "field": "gtid"
          },
          {
            "type": "string",
            "optional": false,
            "field": "file"
          },
          {
            "type": "int64",
            "optional": false,
            "field": "pos"
          },
          {
            "type": "int32",
            "optional": false,
            "field": "row"
          },
          {
            "type": "int64",
            "optional": true,
            "field": "thread"
          },
          {
            "type": "string",
            "optional": true,
            "field": "query"
          }
        ],
        "optional": false,
        "name": "io.debezium.connector.mysql.Source",
        "field": "source"
      },
      {
        "type": "string",
        "optional": false,
        "field": "op"
      },
      {
        "type": "int64",
        "optional": true,
        "field": "ts_ms"
      },
      {
        "type": "struct",
        "fields": [
          {
            "type": "string",
            "optional": false,
            "field": "id"
          },
          {
            "type": "int64",
            "optional": false,
            "field": "total_order"
          },
          {
            "type": "int64",
            "optional": false,
            "field": "data_collection_order"
          }
        ],
        "optional": true,
        "field": "transaction"
      }
    ],
    "optional": false,
    "name": "dbserver1.inventory.customers.Envelope"
  },
  "payload": {
    "before": null,
    "after": {
      "id": 1001,
      "first_name": "Sally",
      "last_name": "Thomas",
      "email": "sally.thomas@acme.com"
    },
    "source": {
      "version": "1.1.0.Final",
      "connector": "mysql",
      "name": "dbserver1",
      "ts_ms": 0,
      "snapshot": "true",
      "db": "inventory",
      "table": "customers",
      "server_id": 0,
      "gtid": null,
      "file": "mysql-bin.000003",
      "pos": 154,
      "row": 0,
      "thread": null,
      "query": null
    },
    "op": "c",
    "ts_ms": 1586331101491,
    "transaction": null
  }
}</code></pre>
</div>
</div>
<div class="sect1">
<h2 id="registry">Registry</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Then there is the third approach that combines strong points of the first two, while it removes their drawbacks at the cost of introducing a new component - a registry - that stores and versions message schemas.</p>
</div>
<div class="paragraph">
<p>There are multiple schema registry implementations available;
in the following we&#8217;re going to focus on the <a href="https://github.com/Apicurio/apicurio-registry">Apicurio Registry</a>,
which is an open-source (Apache license 2.0) API and schema registry.
The project provides not only the registry itself, but also client libraries and tight integration with Apache Kafka and Kafka Connect in form of serializers and converters.</p>
</div>
<div class="paragraph">
<p>Apicurio enables Debezium and consumers to exchange messages whose schema is stored in the registry and pass only a reference to the schema in the messages themselves.
A the structure of captured source tables and thus message schemas evolve, the registry creates new versions of the schemas, too, so not only current but also historical schemas are available.</p>
</div>
<div class="paragraph">
<p>Apicurio provides multiple serialization formats out-of-the-box:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>JSON with externalized schema support</p>
</li>
<li>
<p><a href="https://avro.apache.org/">Apache Avro</a></p>
</li>
<li>
<p><a href="https://developers.google.com/protocol-buffers">Protocol Buffers</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Every serializer and deserializer knows how to automatically interact with the Apicurio API so the consumer is isolated from it as an implementation detail.
The only information necessary is the location of the registry.</p>
</div>
<div class="paragraph">
<p>Apicurio also provides API compatibility layers for schema registries from IBM and Confluent.
This is a very useful feature, as it enables the use of 3rd-party tools like <a href="https://github.com/edenhill/kafkacat">kafkacat</a>, even if they are not aware of Apicurio&#8217;s native API.</p>
</div>
<div class="sect2">
<h3 id="json-converter">JSON Converter</h3>
<div class="paragraph">
<p>In the Debezium examples repository, there is a <a href="https://github.com/debezium/debezium-examples/blob/master/tutorial/docker-compose-mysql-apicurio.yaml">Docker Compose</a> based example, that deploys the Apicurio registry side-by-side with the standard Debezium tutorial example setup.</p>
</div>
<div class="exampleblock centered-image responsive-image">
<div class="content">
<img src="/assets/images/2020-04-09-debezium-apicurio-registry/topology.png" style="max-width:100%;" class="responsive-image">
<div class="paragraph">
<p><strong>Figure 1. The Deployment Topology</strong></p>
</div>
</div>
</div>
<div class="paragraph">
<p>To follow the example you need to clone the Debezium <a href="https://github.com/debezium/debezium-examples/">example repository</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Since Debezium 1.2 the <a href="https://hub.docker.com/r/debezium/connect/">Debezium container images</a> are shipped
with Apicurio converter support.</p>
</div>
<div class="paragraph">
<p>You can enable Apicurio converters by using a <code>debezium/connect</code> or <code>debezium/connect-base</code> image version &gt;=1.2 and
adding the environment variable <code>ENABLE_APICURIO_CONVERTERS=true</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ cd tutorial
$ export DEBZIUM_VERSION=1.1

# Start the deployment
$ docker-compose -f docker-compose-mysql-apicurio.yaml up -d --build

# Start the connector
curl -i -X POST -H "Accept:application/json" \
    -H  "Content-Type:application/json" \
    http://localhost:8083/connectors/ -d @register-mysql-apicurio-converter-json.json

# Read content of the first message
$ docker run --rm --tty \
    --network tutorial_default debezium/tooling bash \
    -c 'kafkacat -b kafka:9092 -C -o beginning -q -t dbserver1.inventory.customers -c 1 | jq .'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The resulting message should look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  "schemaId": 48,
  "payload": {
    "before": null,
    "after": {
      "id": 1001,
      "first_name": "Sally",
      "last_name": "Thomas",
      "email": "sally.thomas@acme.com"
    },
    "source": {
      "version": "1.1.0.Final",
      "connector": "mysql",
      "name": "dbserver1",
      "ts_ms": 0,
      "snapshot": "true",
      "db": "inventory",
      "table": "customers",
      "server_id": 0,
      "gtid": null,
      "file": "mysql-bin.000003",
      "pos": 154,
      "row": 0,
      "thread": null,
      "query": null
    },
    "op": "c",
    "ts_ms": 1586334283147,
    "transaction": null
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The JSON message contains the full payload and at the same time a reference to a schema with id <code>48</code>.
It is possible to query the schema from the registry either using <code>id</code> or using a schema symbolic name as defined by Debezium documentation.
In this case both commands</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ docker run --rm --tty \
    --network tutorial_default \
    debezium/tooling bash -c 'http http://apicurio:8080/ids/64 | jq .'

$ docker run --rm --tty \
    --network tutorial_default \
    debezium/tooling bash -c 'http http://apicurio:8080/artifacts/dbserver1.inventory.customers-value | jq .'</code></pre>
</div>
</div>
<div class="paragraph">
<p>result in the same schema description:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  "type": "struct",
  "fields": [
    {
      "type": "struct",
      "fields": [
        {
          "type": "int32",
          "optional": false,
          "field": "id"
        },
        {
          "type": "string",
          "optional": false,
          "field": "first_name"
        },
        {
          "type": "string",
          "optional": false,
          "field": "last_name"
        },
        {
          "type": "string",
          "optional": false,
          "field": "email"
        }
      ],
      "optional": true,
      "name": "dbserver1.inventory.customers.Value",
      "field": "before"
    },
...
  ],
  "optional": false,
  "name": "dbserver1.inventory.customers.Envelope"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which is the same as we have seen in the "JSON with schema" example before.</p>
</div>
<div class="paragraph">
<p>The connector registration request differs in a few lines from the previous one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">...
"key.converter": "io.apicurio.registry.utils.converter.ExtJsonConverter", <b class="conum">(1)</b>
"key.converter.apicurio.registry.url": "http://apicurio:8080", <b class="conum">(2)</b>
"key.converter.apicurio.registry.global-id":
    "io.apicurio.registry.utils.serde.strategy.GetOrCreateIdStrategy", <b class="conum">(3)</b>

"value.converter": "io.apicurio.registry.utils.converter.ExtJsonConverter", <b class="conum">(1)</b>
"value.converter.apicurio.registry.url": "http://apicurio:8080", <b class="conum">(2)</b>
"value.converter.apicurio.registry.global-id":
    "io.apicurio.registry.utils.serde.strategy.GetOrCreateIdStrategy" <b class="conum">(3)</b>
...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The Apicurio JSON converter is used as both key and value converter</p>
</li>
<li>
<p>The Apicurio registry endpoint</p>
</li>
<li>
<p>This setting ensures that it is posible to automatically register the schema id which is the typical setting in Debezium deployment</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="avro-converter">Avro Converter</h3>
<div class="paragraph">
<p>So far we have demonstrated serialization of messages into the JSON format only.
While using the JSON format with the registry has a lot of advantages, like easy human readability, it&#8217;s still not very space-efficient.</p>
</div>
<div class="paragraph">
<p>To transfer really only the data without any significant overhead, it is useful to use binary format serialization like Avro format.
In this case, we would pack the data only without any field names and other ceremony, and again the message will contain a reference to a schema stored in the registry.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s look at how easily the Avro serialization can be used with Apicurio&#8217;s Avro converter.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"># Tear down the previous deployment
$ docker-compose -f docker-compose-mysql-apicurio.yaml down

# Start the deployment
$ docker-compose -f docker-compose-mysql-apicurio.yaml up -d --build

# Start the connector
curl -i -X POST -H "Accept:application/json" \
    -H  "Content-Type:application/json" \
    http://localhost:8083/connectors/ \
    -d @register-mysql-apicurio-converter-avro.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can query the registry using schema name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ docker run --rm --tty \
    --network tutorial_default \
    debezium/tooling \
    bash -c 'http http://apicurio:8080/artifacts/dbserver1.inventory.customers-value | jq .'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The resulting schema description is slightly different for the previous ones as it has an Avro flavour:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  "type": "record",
  "name": "Envelope",
  "namespace": "dbserver1.inventory.customers",
  "fields": [
    {
      "name": "before",
      "type": [
        "null",
        {
          "type": "record",
          "name": "Value",
          "fields": [
            {
              "name": "id",
              "type": "int"
            },
            {
              "name": "first_name",
              "type": "string"
            },
            {
              "name": "last_name",
              "type": "string"
            },
            {
              "name": "email",
              "type": "string"
            }
          ],
          "connect.name": "dbserver1.inventory.customers.Value"
        }
      ],
      "default": null
    },
    {
      "name": "after",
      "type": [
        "null",
        "Value"
      ],
      "default": null
    },
...
  ],
  "connect.name": "dbserver1.inventory.customers.Envelope"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The connector registration request also differs from the standard one in a handful of lines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">...
"key.converter": "io.apicurio.registry.utils.converter.AvroConverter", <b class="conum">(1)</b>
"key.converter.apicurio.registry.url": "http://apicurio:8080", <b class="conum">(2)</b>
"key.converter.apicurio.registry.converter.serializer":
    "io.apicurio.registry.utils.serde.AvroKafkaSerializer", <b class="conum">(3)</b>
"key.converter.apicurio.registry.converter.deserializer":
    "io.apicurio.registry.utils.serde.AvroKafkaDeserializer", <b class="conum">(3)</b>
"key.converter.apicurio.registry.global-id":
    "io.apicurio.registry.utils.serde.strategy.GetOrCreateIdStrategy", <b class="conum">(4)</b>

"value.converter": "io.apicurio.registry.utils.converter.AvroConverter", <b class="conum">(1)</b>
"value.converter.apicurio.registry.url": "http://apicurio:8080", <b class="conum">(2)</b>
"value.converter.apicurio.registry.converter.serializer":
    "io.apicurio.registry.utils.serde.AvroKafkaSerializer", <b class="conum">(3)</b>
"value.converter.apicurio.registry.converter.deserializer":
    "io.apicurio.registry.utils.serde.AvroKafkaDeserializer", <b class="conum">(3)</b>
"value.converter.apicurio.registry.global-id":
    "io.apicurio.registry.utils.serde.strategy.GetOrCreateIdStrategy", <b class="conum">(4)</b>
...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The Apicurio Avro converter is used as both key and value converter</p>
</li>
<li>
<p>The Apicurio registry endpoint</p>
</li>
<li>
<p>Prescribes which serializer and deserializer should be used by the converter</p>
</li>
<li>
<p>This setting ensures that it is posible to automatically register the schema id which is the typical setting in Debezium deployment</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>To demonstrate consumption of the messages on the sink side we can, for example, use the <a href="https://github.com/confluentinc/kafka-connect-elasticsearch">Kafka Connect Elasticsearch connector</a>. The sink configuration will be again extended only with converter configuration, and the sink connector can consume Avro-enabled topics, without any other changes needed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  "name": "elastic-sink",
  "config": {
    "connector.class": "io.confluent.connect.elasticsearch.ElasticsearchSinkConnector",
    "tasks.max": "1",
    "topics": "customers",
    "connection.url": "http://elastic:9200",
    "transforms": "unwrap,key",
    "transforms.unwrap.type": "io.debezium.transforms.ExtractNewRecordState",
    "transforms.unwrap.drop.tombstones": "false",
    "transforms.key.type": "org.apache.kafka.connect.transforms.ExtractField$Key",
    "transforms.key.field": "id",
    "key.ignore": "false",
    "type.name": "customer",
    "behavior.on.null.values": "delete",

    "key.converter": "io.apicurio.registry.utils.converter.AvroConverter",
    "key.converter.apicurio.registry.url": "http://apicurio:8080",
    "key.converter.apicurio.registry.converter.serializer":
        "io.apicurio.registry.utils.serde.AvroKafkaSerializer",
    "key.converter.apicurio.registry.converter.deserializer":
        "io.apicurio.registry.utils.serde.AvroKafkaDeserializer",
    "key.converter.apicurio.registry.global-id":
        "io.apicurio.registry.utils.serde.strategy.GetOrCreateIdStrategy",

    "value.converter": "io.apicurio.registry.utils.converter.AvroConverter",
    "value.converter.apicurio.registry.url": "http://apicurio:8080",
    "value.converter.apicurio.registry.converter.serializer":
        "io.apicurio.registry.utils.serde.AvroKafkaSerializer",
    "value.converter.apicurio.registry.converter.deserializer":
        "io.apicurio.registry.utils.serde.AvroKafkaDeserializer",
    "value.converter.apicurio.registry.global-id":
        "io.apicurio.registry.utils.serde.strategy.GetOrCreateIdStrategy",
  }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this article we discussed multiple approaches to message/schema association.
The Apicurio registry was presented as a solution for schema sotrage and versioning and we have demonstrated how Apicurio can be integrated with Debezium connectors to efficiently deliver messages with schema to the consumer.</p>
</div>
<div class="paragraph">
<p>You can find a complete example for using the Debezium connectors together with the Apicurio registry in the <a href="https://github.com/debezium/debezium-examples/tree/master/tutorial#using-mysql-and-apicurio-registry">tutorial</a> project of the Debezium examples repository on GitHub.</p>
</div>
</div>
</div></div>
    </div>
    
   
      
      
      <div class="well">
      <div class="row">
        <div class="col-md-8">
          <h2>Jiri Pechanec</h2>
          
          <p>
            <span class="bio-size"
              >Jiri is a software developer (and a former quality engineer) at Red Hat. He spent most of his career with Java and system integration projects and tasks. He lives near Brno, Czech Republic.</span
            >
          </p>
          
          <p class="bio-size">
            
            
            <a href="https://github.com/jpechane">
              <i class="icon-github"></i>
            </a>
            &nbsp;
            
            
            <a href="https://www.linkedin.com/in/jiripechanec">
              <i class="icon-linkedin"></i>
            </a>
            &nbsp;
            
          </p>
        </div>
        <div class="col-md-4">
          
          <img
            alt=""
            class="img-responsive pull-right portrait"
            src="/assets/images/jpechane.jpg"
          />
          
        </div>
      </div>
    </div>
    

      <ul class="pager pager-blog">
        
          <li class="previous">
            <a href="/blog/2020/03/31/debezium-newsletter-01-2020/" class="previous"> &laquo; Previous</a>
        </li>
                
        
        <li class="next"><a href="/blog/2020/04/16/debezium-1-2-alpha1-released/">Next &raquo; </a></li>
        
      </ul>
    
    
    <div class="row">
      <div class="col-md-12">
        <hr>
        <h2>About Debezium</h2>
        <p>
          Debezium is an open source distributed platform that turns your existing databases into event streams,
          so applications can see and respond almost instantly to each committed row-level change in the databases.
          Debezium is built on top of <a href="http://kafka.apache.org/">Kafka</a> and provides <a href="http://kafka.apache.org/documentation.html#connect">Kafka Connect</a> compatible connectors that monitor specific database management systems.
          Debezium records the history of data changes in Kafka logs, so your application can be stopped and restarted at any time and can easily consume all of the events it missed while it was not running,
          ensuring that all events are processed correctly and completely.
          Debezium is <a href="/license/">open source</a> under the <a href="http://www.apache.org/licenses/LICENSE-2.0.html">Apache License, Version 2.0</a>.
        </p>
      </div>
    </div>
    <div class="row">
      <div class="col-md-12">
        <h2>Get involved</h2>
        <p>
          We hope you find Debezium interesting and useful, and want to give it a try.
          Follow us on Twitter <a href="https://twitter.com/debezium">@debezium</a>, <a href="https://gitter.im/debezium/user">chat with us on Gitter</a>,
          or join our <a href="https://groups.google.com/forum/#!forum/debezium">mailing list</a> to talk with the community.
          All of the code is open source <a href="https://github.com/debezium/">on GitHub</a>,
          so build the code locally and help us improve ours existing connectors and add even more connectors.
          If you find problems or have ideas how we can improve Debezium, please let us know or <a href="https://issues.redhat.com/projects/DBZ/issues/">log an issue</a>.
        </p>
      </div>
    </div>
    
    
  </div>
</div>

        
      </div>
      <footer class="container">
  <div>
  <div class="row mr-0 ml-0">
    <div class="col-md-5 col-md-offset-1">
      <h4>Debezium</h4>
      <p>
        &#169; 2020 Debezium Community <br />
        <br />
        <i class="icon-fire"></i> Mixed with
        <a href="http://twitter.github.com/bootstrap">Bootstrap</a>, baked by
        <a href="https://jekyllrb.com/">Jekyll</a>. <br />
        <i class="icon-flag"></i> Website and docs licensed under
        <a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>.
        <br />
        <i class="icon-flag-alt"></i> Code released under
        <a href="http://www.apache.org/licenses/LICENSE-2.0.html"
          >Apache License, v2.0</a
        >. <br />
        <i class="icon-file-alt"></i>
        <a
          href="https://www.redhat.com/legal/legal_statement.html"
          title="Terms"
          >Terms</a
        >
        |
        <a
          href="https://www.redhat.com/legal/privacy_statement.html"
          title="Privacy Policy"
          >Privacy</a
        >
      </p>
    </div>
    <div class="col-md-3">
      <h4>Documentation</h4>
      <ul class="list-unstyled">
        <li><a href="/documentation/features" title="Features">Features</a></li>
        <li>
          <a href="/documentation/install/stable" title="Install">Install</a>
        </li>
        <li>
          <a href="/documentation/architecture" title="Architecture"
            >Architecture</a
          >
        </li>
        <li><a href="/docs/faq" title="FAQ">FAQ</a></li>
        <li>
          <a href="/community/contribute" title="Contribute">Contribute</a>
        </li>
      </ul>
    </div>
    <div class="col-md-3">
      <h4>Connect</h4>
      <ul class="list-unstyled">
        <li><a href="/blog" title="Blog">Blog</a></li>
        <li>
          <a href="http://twitter.com/debezium" title="Twitter">Twitter</a>
        </li>
        <li><a href="http://github.com/debezium" title="GitHub">GitHub</a></li>
        <li><a href="https://gitter.im/debezium/user" title="Chat">Chat</a></li>
        <li>
          <a
            href="https://groups.google.com/forum/#!forum/debezium"
            title="Google Groups"
            >Google Groups</a
          >
        </li>
        <li>
          <a
            href="http://stackoverflow.com/questions/tagged/debezium"
            title="StackOverflow"
            >StackOverflow</a
          >
        </li>
      </ul>
    </div>
  </div>
</div>
</footer>
      <div class="container" id="companyfooter">
  <div class="redhatlogo">
    <a href="https://www.redhat.com/">
      <img
        src="/assets/images/Logo-Red_Hat-Sponsored_By-B-Standard-RGB.svg"
      />
    </a>
  </div>
</div>
  </div>
  
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
  <script type="text/javascript" src="/assets/javascript/vanilla-back-to-top.min.js"></script>
  <script>
    addBackToTop({
      scrollDuration: 400
    })
  </script>
</body>

</html>
