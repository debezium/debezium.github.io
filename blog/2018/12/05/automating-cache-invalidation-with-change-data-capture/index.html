<!DOCTYPE html> <html lang="en"> <head> <title>Automating Cache Invalidation With Change Data Capture · Debezium</title> <meta charset="utf-8"> <meta content="width=device-width, initial-scale=1.0" name="viewport"> <meta content="" name="description"> <meta content="" name="author"> <link href="https://static.jboss.org/theme/css/bootstrap-community/3.2.0.2/bootstrap-community.min.css" media="screen" rel="stylesheet"> <!--[if lt IE 9]><script src="https://static.jboss.org/theme/js/libs/html5/pre3.6/html5.min.js"></script><![endif]--> <link href="https://static.jboss.org/example/images/favicon.ico" rel="shortcut icon"> <link href="https://static.jboss.org/example/images/apple-touch-icon-144x144-precomposed.png" rel="apple-touch-icon-precomposed" sizes="144x144"> <link href="https://static.jboss.org/example/images/apple-touch-icon-114x114-precomposed.png" rel="apple-touch-icon-precomposed" sizes="114x114"> <link href="https://static.jboss.org/example/images/apple-touch-icon-72x72-precomposed.png" rel="apple-touch-icon-precomposed" sizes="72x72"> <link href="https://static.jboss.org/example/images/apple-touch-icon-precomposed.png" rel="apple-touch-icon-precomposed"> <link href="/stylesheets/debezium.css" rel="stylesheet" type="text/css"> <style>
  @media (min-width: 980px) {
    .banner { background-image: url(https://static.jboss.org/example/images/debezium-banner-1180px.png); height: 110px;  }
  }
  @media (max-width: 979px) {
    .banner { background-image: url(https://static.jboss.org/example/images/debezium-logo.png); background-repeat:no-repeat; background-position: center bottom; height: 60px; }
  }
  @media (max-width: 650px) {
    .banner { width: 100%; margin: 0px auto; }
  }
  @media (max-width: 450px) {
    .banner { height: 90px; }
  }
</style> <link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/styles/default.min.css" rel="stylesheet"> <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/highlight.min.js"></script> <script>
hljs.initHighlightingOnLoad();
</script> <script src="https://static.jboss.org/theme/js/libs/jquery/jquery-1.9.1.min.js"></script> <style>
  /* adjusting the vertical spacing for when a stickynav is engaged */
  .breadcrumb-fixed > .active {
    color: #8c8f91;
  }
  .breadcrumb-fixed {
    margin: 70px 0 10px;
    padding: 8px 15px;
    margin-bottom: 20px;
    list-style: none;
    background-color: #f5f5f5;
    border-radius: 4px;
  }
  
  .breadcrumb-fixed > li {
    display: inline-block;
  }
</style> </head> <body> <div id="rhbar"> <a class="jbdevlogo" href="https://www.jboss.org/projects/about"></a> <a class="rhlogo" href="https://www.redhat.com/"></a> </div> <div id=""> <ul class="visuallyhidden" id="top"> <li> <a accesskey="n" href="#nav" title="Skip to navigation">Skip to navigation</a> </li> <li> <a accesskey="c" href="#page" title="Skip to content">Skip to content</a> </li> </ul> <div class="container" id="content"> <div class="navbar navbar-inverse navbar-fix"> <div class="container-fluid"> <div class="navbar-header"> <button class="navbar-toggle collapsed" data-target="#navbar-1" data-toggle="collapse"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href="/"> <img src="/images/color_white_debezium_type_600px.svg" style="height: 32px; margin-right: 5px; margin-top: -5px;"> </a> </div> <div class="collapse navbar-collapse" id="navbar-1"> <ul class="nav navbar-nav pull-right"> <li class=""><a href="/documentation/faq/">FAQ</a></li> <li class=""><a href="/documentation/">DOCUMENTATION</a></li> <li class=""><a href="/releases/">RELEASES</a></li> <li class=""><a href="/community/">COMMUNITY</a></li> <li class="active"><a href="/blog/">BLOG</a></li> </ul> </div> </div> </div> <div id="equalHeightsLayout"> <div class="row post-text-padding row-no-expand"> <div class="hidden-xs col-sm-3 no-right-padding" id="leftdocnav" style="padding-left: 15px; padding-right: 15px;"> <div class="doc-pills"> <ul class="nav nav-pills nav-stacked"> <li class="item"> <a href="/blog">Home</a> <div class="icon"> <span class="icon-home"></span> </div> </li> <li class="item"> <a href="/blog.atom">Feed</a> <div class="icon"> <span class="icon-rss"></span> </div> </li> </ul> </div> <p></p> <div class="featured-posts"> <div id="featured" style="margin-bottom: 4px; border-bottom: 1px solid #ccc; font-size: 115%; margin-left: 2px;"> Featured Posts </div> <ul style="padding-inline-start: 22px;"> <li style="margin-bottom: 3px;"> <a href="/blog/2019/10/22/audit-logs-with-kogito/" style="font-size: 95%;"> Admin Service for Audit Logs with Kogito </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2019/10/01/audit-logs-with-change-data-capture-and-stream-processing/" style="font-size: 95%;"> Building Audit Logs with Change Data Capture and Stream Processing </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2019/07/12/streaming-cassandra-at-wepay-part-1/" style="font-size: 95%;"> Streaming Cassandra at WePay - Part 1 </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2019/02/19/reliable-microservices-data-exchange-with-the-outbox-pattern/" style="font-size: 95%;"> Reliable Microservices Data Exchange With the Outbox Pattern </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/12/05/automating-cache-invalidation-with-change-data-capture/" style="font-size: 95%;"> Automating Cache Invalidation With Change Data Capture </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/09/20/materializing-aggregate-views-with-hibernate-and-debezium/" style="font-size: 95%;"> Materializing Aggregate Views With Hibernate and Debezium </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/07/19/advantages-of-log-based-change-data-capture/" style="font-size: 95%;"> Five Advantages of Log-Based Change Data Capture </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/03/08/creating-ddd-aggregates-with-debezium-and-kafka-streams/" style="font-size: 95%;"> Creating DDD aggregates with Debezium and Kafka Streams </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/01/17/streaming-to-elasticsearch/" style="font-size: 95%;"> Streaming Data Changes from Your Database to Elasticsearch </a> </li> </ul> </div> <p></p> <div class="cloud-tags"> <div id="tags" style="margin-bottom: 4px; border-bottom: 1px solid #ccc; font-size: 115%; margin-left: 2px;"> Tags </div> <div class="tag-cloud"> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/apache-kafka/">apache-kafka</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/avro/">avro</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/aws/">aws</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/camel/">camel</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/cassandra/">cassandra</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/community/">community</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/cqrs/">cqrs</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/db2/">db2</a> </span> <span class="tag tag-2"> <a href="https://debezium.io/blog/tags/discussion/">discussion</a> </span> <span class="tag tag-5"> <a href="https://debezium.io/blog/tags/docker/">docker</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/elasticsearch/">elasticsearch</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/event-sourcing/">event-sourcing</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/example/">example</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/examples/">examples</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/featured/">featured</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/fedora/">fedora</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/integration/">integration</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/introduction/">introduction</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/json/">json</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/kafka/">kafka</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/kafka-streams/">kafka-streams</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/kogito/">kogito</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/ksql/">ksql</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/kubernetes/">kubernetes</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/microservices/">microservices</a> </span> <span class="tag tag-4"> <a href="https://debezium.io/blog/tags/mongodb/">mongodb</a> </span> <span class="tag tag-6"> <a href="https://debezium.io/blog/tags/mysql/">mysql</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/news/">news</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/newsletter/">newsletter</a> </span> <span class="tag tag-2"> <a href="https://debezium.io/blog/tags/oracle/">oracle</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/outbox/">outbox</a> </span> <span class="tag tag-5"> <a href="https://debezium.io/blog/tags/postgres/">postgres</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/presentation/">presentation</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/quarkus/">quarkus</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/rds/">rds</a> </span> <span class="tag tag-6"> <a href="https://debezium.io/blog/tags/releases/">releases</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/secrets/">secrets</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/sentry/">sentry</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/serialization/">serialization</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/smt/">smt</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/sql/">sql</a> </span> <span class="tag tag-3"> <a href="https://debezium.io/blog/tags/sqlserver/">sqlserver</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/vagrant/">vagrant</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/website/">website</a> </span> </div> </div> </div> <div class="col-xs-12 col-sm-9" id="maincol"> <div class="post"> <div class="row" style="margin-left: 0; margin-right: 0; margin-bottom: 10px;"> <div class="col-sm-12" style="padding-left: 0px;"> <div style="display: table-cell; vertical-align: top;"> <div style="width: 72px; border: 1px solid #ccc; padding: 3px; display: inline-block;"> <img src="/images/gmorling.jpg" style="width: 64px;"> </div> </div> <div style="display: table-cell; vertical-align: top;"> <div style="margin-left: 8px;"> <span class="hidden-sm hidden-xs" style="font-size: 2.75rem; line-height: 1;"> <a href="/blog/2018/12/05/automating-cache-invalidation-with-change-data-capture/">Automating Cache Invalidation With Change Data Capture</a> </span> <span class="hidden-md hidden-lg" style="font-size: 2rem; line-height: 1;"> <a href="/blog/2018/12/05/automating-cache-invalidation-with-change-data-capture/">Automating Cache Invalidation With Change Data Capture</a> </span> <div class="byline" style="line-height: 1;"> <em> December 05, 2018 by Gunnar Morling </em> <div class="hidden-xs" style="margin-top: 5px;"> <a class="hidden-sm hidden-xs label label-info" href="/blog/tags/discussion/">discussion</a> <a class="hidden-sm hidden-xs label label-info" href="/blog/tags/examples/">examples</a> </div> </div> </div> </div> </div> </div> <div class="row" style="margin-left: 0; margin-right: 0;"> <div id="preamble"> <div class="sectionbody"> <div class="paragraph"> <p>The <a href="https://docs.jboss.org/hibernate/stable/orm/userguide/html_single/Hibernate_User_Guide.html#caching-config">second-level cache</a> of Hibernate ORM / JPA is a proven and efficient way to increase application performance: caching read-only or rarely modified entities avoids roundtrips to the database, resulting in improved response times of the application.</p> </div> <div class="paragraph"> <p>Unlike the first-level cache, the second-level cache is associated with the session factory (or entity manager factory in JPA terms), so its contents are shared across transactions and concurrent sessions. Naturally, if a cached entity gets modified, the corresponding cache entry must be updated (or purged from the cache), too. As long as the data changes are done through Hibernate ORM, this is nothing to worry about: the ORM will update the cache automatically.</p> </div> <div class="paragraph"> <p>Things get tricky, though, when bypassing the application, e.g. when modifying records directly in the database. Hibernate ORM then has no way of knowing that the cached data has become stale, and it&#8217;s necessary to invalidate the affected items explicitly. A common way for doing so is to foresee some admin functionality that allows to clear an application&#8217;s caches. For this to work, it&#8217;s vital to not forget about calling that invalidation functionality, or the application will keep working with outdated cached data.</p> </div> <div class="paragraph"> <p>In the following we&#8217;re going to explore an alternative approach for cache invalidation, which works in a reliable and fully automated way: by employing Debezium and its <a href="/blog/2018/07/19/advantages-of-log-based-change-data-capture/">change data capture</a> (CDC) capabilities, you can track data changes in the database itself and react to any applied change. This allows to invalidate affected cache entries in near-realtime, without the risk of stale data due to missed changes. If an entry has been evicted from the cache, Hibernate ORM will load the latest version of the entity from the database the next time is requested.</p> </div> </div> </div> <div class="sect1"> <h2 id="the_example_application"><a class="anchor" href="#the_example_application"></a>The Example Application</h2> <div class="sectionbody"> <div class="paragraph"> <p>As an example, consider this simple model of two entities, <code>PurchaseOrder</code> and <code>Item</code>:</p> </div> <div class="imageblock centered-image"> <img src="/images/cache_invalidation_class_diagram.png" class="responsive-image" alt="Example domain model"> </div> <div class="paragraph"> <p>A purchase order represents the order of an item, where its total price is the ordered quantity times the item&#8217;s base price.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="title">Source Code</div> <div class="paragraph"> <p>The <a href="https://github.com/debezium/debezium-examples/tree/master/cache-invalidation/">source code</a> of this example is provided on GitHub. If you want to follow along and try out all the steps described in the following, clone the repo and follow the instructions in <a href="https://github.com/debezium/debezium-examples/tree/master/cache-invalidation/_README.md">README.md</a> for building the project.</p> </div> </td> </tr> </table> </div> <div class="paragraph"> <p>Modelling order and item as JPA entities is straight-forward:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-java" data-lang="java">@Entity&#x000A;public class PurchaseOrder {&#x000A;&#x000A;    @Id&#x000A;    @GeneratedValue(generator = "sequence")&#x000A;    @SequenceGenerator(&#x000A;        name = "sequence", sequenceName = "seq_po", initialValue = 1001, allocationSize = 50&#x000A;    )&#x000A;    private long id;&#x000A;    private String customer;&#x000A;    @ManyToOne private Item item;&#x000A;    private int quantity;&#x000A;    private BigDecimal totalPrice;&#x000A;&#x000A;    // ...&#x000A;}</code></pre> </div> </div> <div class="paragraph"> <p>As changes to items are rare, the <code>Item</code> entity should be cached. This can be done by simply specifying JPA&#8217;s <a href="https://docs.oracle.com/javaee/7/api/javax/persistence/Cacheable.html">@Cacheable</a> annotation:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-java" data-lang="java">@Entity&#x000A;@Cacheable&#x000A;public class Item {&#x000A;&#x000A;    @Id&#x000A;    private long id;&#x000A;    private String description;&#x000A;    private BigDecimal price;&#x000A;&#x000A;    // ...&#x000A;}</code></pre> </div> </div> <div class="paragraph"> <p>You also need to enable the second-level cache in the <em>META-INF/persistence.xml</em> file. The property <code>hibernate.cache.use_second_level_cache</code> activates the cache itself, and the <code>ENABLE_SELECTIVE</code> cache mode causes only those entities to be put into the cache which are annotated with <code>@Cacheable</code>. It&#8217;s also a good idea to enable SQL query logging and cache access statistics. That way you&#8217;ll be able to verify whether things work as expected by examining the application log:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="utf-8"?&gt;&#x000A;&lt;persistence xmlns="http://xmlns.jcp.org/xml/ns/persistence"&#x000A;    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&#x000A;    xsi:schemaLocation="..."&#x000A;    version="2.2"&gt;&#x000A;&#x000A;    &lt;persistence-unit name="orders-PU-JTA" transaction-type="JTA"&gt;&#x000A;        &lt;jta-data-source&gt;java:jboss/datasources/OrderDS&lt;/jta-data-source&gt;&#x000A;        &lt;shared-cache-mode&gt;ENABLE_SELECTIVE&lt;/shared-cache-mode&gt;&#x000A;        &lt;properties&gt;&#x000A;            &lt;property name="hibernate.cache.use_second_level_cache" value="true" /&gt;&#x000A;&#x000A;            &lt;property name="hibernate.show_sql" value="true" /&gt;&#x000A;            &lt;property name="hibernate.format_sql" value="true" /&gt;&#x000A;            &lt;property name="hibernate.generate_statistics" value="true" /&gt;&#x000A;&#x000A;            &lt;!-- dialect etc. ... --&gt;&#x000A;        &lt;/properties&gt;&#x000A;    &lt;/persistence-unit&gt;&#x000A;&lt;/persistence&gt;</code></pre> </div> </div> <div class="paragraph"> <p>When running on a <a href="https://www.oracle.com/technetwork/java/javaee/overview/index.html">Java EE</a> application server (or <a href="https://jakarta.ee/">Jakarta EE</a> how the stack is called after it has been donated to the Eclipse Foundation), that&#8217;s all you need to enable second-level caching. In the case of <a href="http://wildfly.org/">WildFly</a> (which is what&#8217;s used in the example project), the <a href="http://infinispan.org/">Infinispan</a> key/value store is used as the cache provider by default.</p> </div> <div class="paragraph"> <p>Now try and see what happens when modifying an item&#8217;s price by running some SQL in the database, bypassing the application layer. If you&#8217;ve checked out the example source code, comment out the <code>DatabaseChangeEventListener</code> class and start the application as described in the <em>README.md</em>. You then can place purchase orders using curl like this (a couple of example items have been persisted at application start-up):</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-bash" data-lang="bash">&gt; curl -H "Content-Type: application/json" \&#x000A;  -X POST \&#x000A;  --data '{ "customer" : "Billy-Bob", "itemId" : 10003, "quantity" : 2 }' \&#x000A;  http://localhost:8080/cache-invalidation/rest/orders</code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-bash" data-lang="bash">{&#x000A;    "id" : 1002,&#x000A;    "customer" : "Billy-Bob",&#x000A;    "item" : {&#x000A;        "id" :10003,&#x000A;        "description" : "North By Northwest",&#x000A;        "price" : 14.99&#x000A;    },&#x000A;    "quantity" : 2,&#x000A;    "totalPrice" : 29.98&#x000A;}</code></pre> </div> </div> <div class="paragraph"> <p>The response is the expected one, as the item price is 14.99. Now update the item&#8217;s price directly in the database. The example uses Postgres, so you can use the <em>psql</em> CLI utility to do so:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-bash" data-lang="bash">docker-compose exec postgres bash -c 'psql -U $POSTGRES_USER $POSTGRES_DB -c "UPDATE item SET price = 20.99 where id = 10003"'</code></pre> </div> </div> <div class="paragraph"> <p>Placing another purchase order for the same item using curl, you&#8217;ll see that the calculated total price doesn&#8217;t reflect the update. Not good! But it&#8217;s not too surprising, given that the price update was applied completely bypassing the application layer and Hibernate ORM.</p> </div> </div> </div> <div class="sect1"> <h2 id="the_change_event_handler"><a class="anchor" href="#the_change_event_handler"></a>The Change Event Handler</h2> <div class="sectionbody"> <div class="paragraph"> <p>Now let&#8217;s explore how to use Debezium and CDC to react to changes in the <code>item</code> table and invalidate corresponding cache entries.</p> </div> <div class="paragraph"> <p>While Debezium most of the times is deployed into <a href="https://kafka.apache.org/documentation/#connect">Kafka Connect</a> (thus streaming change events into Apache Kafka topics), it has another mode of operation that comes in very handy for the use case at hand. Using the <a href="/docs/embedded/">embedded engine</a>, you can run the Debezium connectors as a library directly within your application. For each change event received from the database, a configured callback method will be invoked, which in the case at hand will evict the affected item from the second-level cache.</p> </div> <div class="paragraph"> <p>The following picture shows the design of this approach:</p> </div> <div class="imageblock centered-image"> <img src="/images/cache_invalidation_architecture.png" class="responsive-image" alt="Architecture Overview"> </div> <div class="paragraph"> <p>While this doesn&#8217;t come with the scalability and fault tolerance provided by Apache Kafka, it nicely fits the given requirements. As the second-level cache is bound to the application lifecycle, there is for instance no need for the offset management and restarting capabilities provided by the Kafka Connect framework. For the given use case it is enough to receive data change events while the application is running, and using the embedded engine enables exactly that.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="title">Clustered Applications</div> <div class="paragraph"> <p>Note that it still might make sense to use Apache Kafka and the regular deployment of Debezium into Kafka Connect when running a clustered application where each node has a local cache. Instead of registering a connector on each node, Kafka and Connect would allow you to deploy a single connector instance and have the application nodes listen to the topic(s) with the change events. This would result in less resource utilization in the database.</p> </div> </td> </tr> </table> </div> <div class="paragraph"> <p>Having added the dependencies of the Debezium embedded engine (<em>io.debezium:debezium-embedded:0.9.0.Beta1</em>) and the Debezium Postgres connector (<em>io.debezium:debezium-connector-postgres:0.9.0.Beta1</em>) to your project, a class <code>DatabaseChangeEventListener</code> for listening to any changes in the database can be implemented like this:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-java" data-lang="java">@ApplicationScoped&#x000A;public class DatabaseChangeEventListener {&#x000A;&#x000A;    @Resource&#x000A;    private ManagedExecutorService executorService;&#x000A;&#x000A;    @PersistenceUnit private EntityManagerFactory emf;&#x000A;&#x000A;    @PersistenceContext&#x000A;    private EntityManager em;&#x000A;&#x000A;    private EmbeddedEngine engine;&#x000A;&#x000A;    public void startEmbeddedEngine(@Observes @Initialized(ApplicationScoped.class) Object init) {&#x000A;        Configuration config = Configuration.empty()&#x000A;                .withSystemProperties(Function.identity()).edit()&#x000A;                .with(EmbeddedEngine.CONNECTOR_CLASS, PostgresConnector.class)&#x000A;                .with(EmbeddedEngine.ENGINE_NAME, "cache-invalidation-engine")&#x000A;                .with(EmbeddedEngine.OFFSET_STORAGE, MemoryOffsetBackingStore.class)&#x000A;                .with("name", "cache-invalidation-connector")&#x000A;                .with("database.hostname", "postgres")&#x000A;                .with("database.port", 5432)&#x000A;                .with("database.user", "postgresuser")&#x000A;                .with("database.password", "postgrespw")&#x000A;                .with("database.server.name", "dbserver1")&#x000A;                .with("database.dbname", "inventory")&#x000A;                .with("database.whitelist", "public")&#x000A;                .with("snapshot.mode", "never")&#x000A;                .build();&#x000A;&#x000A;        this.engine = EmbeddedEngine.create()&#x000A;                .using(config)&#x000A;                .notifying(this::handleDbChangeEvent)&#x000A;                .build();&#x000A;&#x000A;        executorService.execute(engine);&#x000A;    }&#x000A;&#x000A;    @PreDestroy&#x000A;    public void shutdownEngine() {&#x000A;        engine.stop();&#x000A;    }&#x000A;&#x000A;    private void handleDbChangeEvent(SourceRecord record) {&#x000A;        if (record.topic().equals("dbserver1.public.item")) {&#x000A;            Long itemId = ((Struct) record.key()).getInt64("id");&#x000A;            Struct payload = (Struct) record.value();&#x000A;            Operation op = Operation.forCode(payload.getString("op"));&#x000A;&#x000A;            if (op == Operation.UPDATE || op == Operation.DELETE) {&#x000A;                emf.getCache().evict(Item.class, itemId);&#x000A;            }&#x000A;        }&#x000A;    }&#x000A;}</code></pre> </div> </div> <div class="paragraph"> <p>Upon application start-up, this configures an instance of the <a href="/docs/connectors/postgresql/">Debezium Postgres connector</a> and sets up the embedded engine for running the connector. The <a href="/docs/connectors/postgresql/#connector-properties">connector options</a> (host name, credentials etc.) are mostly the same as when deploying the connector into Kafka Connect. There is no need for doing an initial snapshot of the existing data, hence the <a href="/docs/connectors/postgresql/#snapshots">snapshot mode</a> is set to "never".</p> </div> <div class="paragraph"> <p>The offset storage option is used for controlling how connector offsets should be persisted. As it&#8217;s not necessary to process any change events occurring while the connector is not running (instead you&#8217;d just begin to read the log from the current location after the restart), the in-memory implementation provided by Kafka Connect is used.</p> </div> <div class="paragraph"> <p>Once configured, the embedded engine must be run via an <code>Executor</code> instance. As the example runs in WildFly, a managed executor can simply be obtained through <code>@Resource</code> injection for that purpose (see <a href="https://www.jcp.org/en/jsr/detail?id=236">JSR 236</a>).</p> </div> <div class="paragraph"> <p>The embedded engine is configured to invoke the <code>handleDbChangeEvent()</code> method for each received data change event. In this method it first is checked whether the incoming event originates from the <code>item</code> table. If that&#8217;s the case, and if the change event represents an <code>UPDATE</code> or <code>DELETE</code> statement, the affected <code>Item</code> instance is evicted from the second-level cache. JPA 2.0 provides a <a href="https://javaee.github.io/javaee-spec/javadocs/index.html?javax/persistence/Cache.html">simple API</a> for this purpose which is accessible via the <code>EntityManagerFactory</code>.</p> </div> <div class="paragraph"> <p>With the <code>DatabaseChangeEventListener</code> class in place, the cache entry will now automatically be evicted when doing another item update via <em>psql</em>. When placing the first purchase order for that item after the update, you&#8217;ll see in the application log how Hibernate ORM executes a query <code>SELECT ... FROM item ...</code> in order to load the item referenced by the order. Also the cache statistics will report one "L2C miss". Upon subsequent orders of that same item it will be obtained from the cache again.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="title">Eventual Consistency</div> <div class="paragraph"> <p>While the event handling happens in near-realtime, it&#8217;s important to point out that it still applies eventual consistency semantics. This means that there is a very short time window between the point in time where a transaction is committed and the point in time where the change event is streamed from the log to the event handler and the cache entry is invalidated.</p> </div> </td> </tr> </table> </div> </div> </div> <div class="sect1"> <h2 id="avoiding_cache_invalidations_after_application_triggered_data_changes"><a class="anchor" href="#avoiding_cache_invalidations_after_application_triggered_data_changes"></a>Avoiding Cache Invalidations After Application-triggered Data Changes</h2> <div class="sectionbody"> <div class="paragraph"> <p>The change event listener shown above satisfies the requirement of invalidating cached items after external data changes. But in its current form it is evicting cache items a bit too aggressively: cached items will also be purged when updating an <code>Item</code> instance through the application itself. This is not only not needed (as the cached item already is the current version), but it&#8217;s even counter-productive: the superfluous cache evictions will cause additional database roundtrips, resulting in longer response times.</p> </div> <div class="paragraph"> <p>It is therefore necessary to distinguish between data changes performed by the application itself and external data changes. Only in the latter case the affected items should be evicted from the cache. In order to do so, you can leverage the fact that each Debezium data change event contains the id of the originating transaction. Keeping track of all transactions run by the application itself allows to trigger the cache eviction only for those items altered by external transactions.</p> </div> <div class="paragraph"> <p>Accounting for this change, the overall architecture looks like so:</p> </div> <div class="imageblock centered-image"> <img src="/images/cache_invalidation_architecture_tx_registry.png" class="responsive-image" alt="Architecture Overview with Transaction Registry"> </div> <div class="paragraph"> <p>The first thing to implement is the transaction registry, i.e. a class for the transaction book keeping:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-java" data-lang="java">@ApplicationScoped&#x000A;public class KnownTransactions {&#x000A;&#x000A;    private final DefaultCacheManager cacheManager;&#x000A;    private final Cache&lt;Long, Boolean&gt; applicationTransactions;&#x000A;&#x000A;    public KnownTransactions() {&#x000A;        cacheManager = new DefaultCacheManager();&#x000A;        cacheManager.defineConfiguration(&#x000A;                "tx-id-cache",&#x000A;                new ConfigurationBuilder()&#x000A;                    .expiration()&#x000A;                        .lifespan(60, TimeUnit.SECONDS)&#x000A;                    .build()&#x000A;                );&#x000A;&#x000A;        applicationTransactions = cacheManager.getCache("tx-id-cache");&#x000A;    }&#x000A;&#x000A;    @PreDestroy&#x000A;    public void stopCacheManager() {&#x000A;        cacheManager.stop();&#x000A;    }&#x000A;&#x000A;    public void register(long txId) {&#x000A;        applicationTransactions.put(txId, true);&#x000A;    }&#x000A;&#x000A;    public boolean isKnown(long txId) {&#x000A;        return Boolean.TRUE.equals(applicationTransactions.get(txId));&#x000A;    }&#x000A;}</code></pre> </div> </div> <div class="paragraph"> <p>This uses the Infinispan <code>DefaultCacheManager</code> for creating and maintaining an in-memory cache of transaction ids encountered by the application. As data change events arrive in near-realtime, the TTL of the cache entries can be rather short (in fact, the value of one minute shown in the example is chosen very conservatively, usually events should be received within seconds).</p> </div> <div class="paragraph"> <p>The next step is to retrieve the current transaction id whenever a request is processed by the application and register it within <code>KnownTransactions</code>. This should happen once per transaction. There are multiple ways for implementing this logic; in the following a Hibernate ORM <code>FlushEventListener</code> is used for this purpose:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-java" data-lang="java">class TransactionRegistrationListener implements FlushEventListener {&#x000A;&#x000A;    private volatile KnownTransactions knownTransactions;&#x000A;&#x000A;    public TransactionRegistrationListener() {&#x000A;    }&#x000A;&#x000A;    @Override&#x000A;    public void onFlush(FlushEvent event) throws HibernateException {&#x000A;        event.getSession().getActionQueue().registerProcess( session -&gt; {&#x000A;            Number txId = (Number) event.getSession().createNativeQuery("SELECT txid_current()")&#x000A;                    .setFlushMode(FlushMode.MANUAL)&#x000A;                    .getSingleResult();&#x000A;&#x000A;            getKnownTransactions().register(txId.longValue());&#x000A;        } );&#x000A;    }&#x000A;&#x000A;    private  KnownTransactions getKnownTransactions() {&#x000A;        KnownTransactions value = knownTransactions;&#x000A;&#x000A;        if (value == null) {&#x000A;            knownTransactions = value = CDI.current().select(KnownTransactions.class).get();&#x000A;        }&#x000A;&#x000A;        return value;&#x000A;    }&#x000A;}</code></pre> </div> </div> <div class="paragraph"> <p>As there&#8217;s no portable way to obtain the transaction id, this is done using a native SQL query. In the case of Postgres, the <code>txid_current()</code> function can be called for that. Hibernate ORM event listeners are not subject to dependency injection via CDI. Hence the static <code>current()</code> method is used to obtain a handle to the application&#8217;s CDI container and get a reference to the <code>KnownTransactions</code> bean.</p> </div> <div class="paragraph"> <p>This listener will be invoked whenever Hibernate ORM is synchronizing its persistence context with the database ("flushing"), which usually happens exactly once when the transaction is committed.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="title">Manual Flushes</div> <div class="paragraph"> <p>The session / entity manager can also be flushed manually, in which case the <code>txid_current()</code> function would be invoked multiple times. That&#8217;s neglected here for the sake of simplicity. The actual code in the example repo contains a slightly extended version of this class which makes sure that the transaction id is obtained only once.</p> </div> </td> </tr> </table> </div> <div class="paragraph"> <p>To register the flush listener with Hibernate ORM, an <code>Integrator</code> implementation must be created and declared in the <em>META-INF/services/org.hibernate.integrator.spi.Integrator</em> file:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-java" data-lang="java">public class TransactionRegistrationIntegrator implements Integrator {&#x000A;&#x000A;    @Override&#x000A;    public void integrate(Metadata metadata, SessionFactoryImplementor sessionFactory,&#x000A;            SessionFactoryServiceRegistry serviceRegistry) {&#x000A;        serviceRegistry.getService(EventListenerRegistry.class)&#x000A;            .appendListeners(EventType.FLUSH, new TransactionRegistrationListener());&#x000A;    }&#x000A;&#x000A;    @Override&#x000A;    public void disintegrate(SessionFactoryImplementor sessionFactory,&#x000A;            SessionFactoryServiceRegistry serviceRegistry) {&#x000A;    }&#x000A;}</code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code>io.debezium.examples.cacheinvalidation.persistence.TransactionRegistrationIntegrator</code></pre> </div> </div> <div class="paragraph"> <p>During bootstrap, Hibernate ORM will detect the integrator class (by means of the <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/ServiceLoader.html">Java service loader</a>), invoke its <code>integrate()</code> method which in turn will register the listener class for the <code>FLUSH</code> event.</p> </div> <div class="paragraph"> <p>The last step is to exclude any events stemming from transactions run by the application itself in the database change event handler:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-java" data-lang="java">@ApplicationScoped&#x000A;public class DatabaseChangeEventListener {&#x000A;&#x000A;    // ...&#x000A;&#x000A;    @Inject&#x000A;    private KnownTransactions knownTransactions;&#x000A;&#x000A;    private void handleDbChangeEvent(SourceRecord record) {&#x000A;        if (record.topic().equals("dbserver1.public.item")) {&#x000A;            Long itemId = ((Struct) record.key()).getInt64("id");&#x000A;            Struct payload = (Struct) record.value();&#x000A;            Operation op = Operation.forCode(payload.getString("op"));&#x000A;            Long txId = ((Struct) payload.get("source")).getInt64("txId");&#x000A;&#x000A;            if (!knownTransactions.isKnown(txId) &amp;&amp;&#x000A;                    (op == Operation.UPDATE || op == Operation.DELETE)) {&#x000A;                emf.getCache().evict(Item.class, itemId);&#x000A;            }&#x000A;        }&#x000A;    }&#x000A;}</code></pre> </div> </div> <div class="paragraph"> <p>And with that, you got all the pieces in place: cached <code>Item</code>s will only be evicted after external data changes, but not after changes done by the application itself. To confirm, you can invoke the example&#8217;s <code>items</code> resource using curl:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-bash" data-lang="bash">&gt; curl -H "Content-Type: application/json" \&#x000A;  -X PUT \&#x000A;  --data '{ "description" : "North by Northwest", "price" : 20.99}' \&#x000A;  http://localhost:8080/cache-invalidation/rest/items/10003</code></pre> </div> </div> <div class="paragraph"> <p>When placing the next order for the item after this update, you should see that the <code>Item</code> entity is obtained from the cache, i.e. the change event will not have caused the item&#8217;s cache entry to be evicted. In contrast, if you update the item&#8217;s price via <em>psql</em> another time, the item should be removed from the cache and the order request will produce a cache miss, followed by a <code>SELECT</code> against the <code>item</code> table in the database.</p> </div> </div> </div> <div class="sect1"> <h2 id="summary"><a class="anchor" href="#summary"></a>Summary</h2> <div class="sectionbody"> <div class="paragraph"> <p>In this blog post we&#8217;ve explored how Debezium and change data capture can be employed to invalidate application-level caches after external data changes. Compared to manual cache invalidation, this approach works very reliably (by capturing changes directly from the database log, no events will be missed) and fast (cache eviction happens in near-realtime after the data changes).</p> </div> <div class="paragraph"> <p>As you have seen, not too much glue code is needed in order to implement this. While the shown implementation is somewhat specific to the entities of the example, it should be possible to implement the change event handler in a more generic fashion, so that it can handle a set of configured entity types (essentially, the database change listener would have to convert the primary key field(s) from the change events into the primary key type of the corresponding entities in a generic way). Also such generic implementation would have to provide the logic for obtaining the current transaction id for the most commonly used databases.</p> </div> <div class="paragraph"> <p>Please let us know whether you think this would be an interesting extension to have for Debezium and Hibernate ORM. For instance this could be a new module under the Debezium umbrella, and it could also be a very great project to work on, should you be interested in contributing to Debezium. If you got any thoughts on this idea, please post a comment below or come to our <a href="https://groups.google.com/forum/#!forum/debezium">mailing list</a>.</p> </div> <div class="paragraph"> <p>Many thanks to Guillaume Smet, Hans-Peter Grahsl and Jiri Pechanec for their feedback while writing this post!</p> </div> </div> </div> <div class="sect1"> <h2 id="about_debezium"><a class="anchor" href="#about_debezium"></a>About Debezium</h2> <div class="sectionbody"> <div class="paragraph"> <p>Debezium is an open source distributed platform that turns your existing databases into event streams, so applications can see and respond almost instantly to each committed row-level change in the databases. Debezium is built on top of <a href="http://kafka.apache.org/">Kafka</a> and provides <a href="http://kafka.apache.org/documentation.html#connect">Kafka Connect</a> compatible connectors that monitor specific database management systems. Debezium records the history of data changes in Kafka logs, so your application can be stopped and restarted at any time and can easily consume all of the events it missed while it was not running, ensuring that all events are processed correctly and completely. Debezium is <a href="/license/">open source</a> under the <a href="http://www.apache.org/licenses/LICENSE-2.0.html">Apache License, Version 2.0</a>.</p> </div> </div> </div> <div class="sect1"> <h2 id="get_involved"><a class="anchor" href="#get_involved"></a>Get involved</h2> <div class="sectionbody"> <div class="paragraph"> <p>We hope you find Debezium interesting and useful, and want to give it a try. Follow us on Twitter <a href="https://twitter.com/debezium">@debezium</a>, <a href="https://gitter.im/debezium/user">chat with us on Gitter</a>, or join our <a href="https://groups.google.com/forum/#!forum/debezium">mailing list</a> to talk with the community. All of the code is open source <a href="https://github.com/debezium/">on GitHub</a>, so build the code locally and help us improve ours existing connectors and add even more connectors. If you find problems or have ideas how we can improve Debezium, please let us know or <a href="https://issues.redhat.com/projects/DBZ/issues/">log an issue</a>.</p> </div> </div> </div> </div> </div> <div class="well"> <div class="row"> <div class="col-md-8"> <h2>Gunnar Morling</h2> <p> <span class="bio-size">Gunnar is a software engineer at Red Hat and open-source enthusiast by heart. A long-time Hibernate core team member, he's now the project lead of Debezium. Gunnar is the spec lead for Bean Validation 2.0 (JSR 380). He’s based in Hamburg, Germany.</span> </p> <p class="bio-size"> <a href="https://twitter.com/gunnarmorling"> <i class="icon-twitter"></i> </a> &nbsp; <a href="https://github.com/gunnarmorling"> <i class="icon-github"></i> </a> &nbsp; </p> </div> <div class="col-md-4"> <img alt="" class="img-responsive pull-right portrait" src="/images/gmorling.jpg"> </div> </div> </div> <div class="comments"> <div id="disqus_thread"></div> <script type="text/javascript">
            var disqus_shortname = 'Debezium';
            var disqus_url = "https://debezium.io/blog/2018/12/05/automating-cache-invalidation-with-change-data-capture/";
            var disqus_developer = null;
            var disqus_identifier = null;
            (function() {
              var dsq = document.createElement("script"); dsq.type = "text/javascript"; dsq.async = true;
              dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName("head")[0] || document.getElementsByTagName("body")[0]).appendChild(dsq);
            })();
            </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript=Debezium">comments powered by Disqus.</a></noscript> </div> </div> </div> </div> </div> <footer class="container"> <div class="row"> <div class="col-md-5 col-md-offset-1"> <h4>Debezium</h4> <p> &#169; 2020 Debezium Community <br> <br> <i class="icon-fire"></i> Mixed with <a href="http://twitter.github.com/bootstrap">Bootstrap</a>, baked by <a href="http://awestruct.org">Awestruct</a>. <br> <i class="icon-flag"></i> Website and docs licensed under <a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>. <br> <i class="icon-flag-alt"></i> Code released under <a href="http://www.apache.org/licenses/LICENSE-2.0.html">Apache License, v2.0</a>. <br> <i class="icon-file-alt"></i> <a href="https://www.redhat.com/legal/legal_statement.html" title="Terms">Terms</a> | <a href="https://www.redhat.com/legal/privacy_statement.html" title="Privacy Policy">Privacy</a> </p> </div> <div class="col-md-3"> <h4>Documentation</h4> <ul class="list-unstyled"> <li> <a href="/documentation/features" title="Features">Features</a> </li> <li> <a href="/documentation/install/stable/" title="Install">Install</a> </li> <li> <a href="/documentation/architecture/" title="Architecture">Architecture</a> </li> <li> <a href="/documentation/faq/" title="FAQ">FAQ</a> </li> <li> <a href="/community/contribute/" title="Contribute">Contribute</a> </li> </ul> </div> <div class="col-md-3"> <h4>Connect</h4> <ul class="list-unstyled"> <li> <a href="/blog" title="Blog">Blog</a> </li> <li> <a href="http://twitter.com/debezium" title="Twitter">Twitter</a> </li> <li> <a href="http://github.com/debezium" title="GitHub">GitHub</a> </li> <li> <a href="https://gitter.im/debezium/user" title="Chat">Chat</a> </li> <li> <a href="https://groups.google.com/forum/#!forum/debezium" title="Google Groups">Google Groups</a> </li> <li> <a href="http://stackoverflow.com/questions/tagged/debezium" title="StackOverflow">StackOverflow</a> </li> </ul> </div> </div> </footer> <div class="container" id="companyfooter"> <div class="redhatlogo"> <div id="logospacer"></div> <a href="https://www.redhat.com/"><img src="/images/Logo-Red_Hat-Sponsored_By-B-Standard-RGB.svg"></a> </div> </div> <span class="backToTop"> <a href="#top">back to top</a> </span> <script src="https://static.jboss.org/theme/js/libs/bootstrap-community/3.2.0.2/bootstrap-community.min.js"></script> <script type='text/javascript' language='JavaScript' src='https://www.redhat.com/j/elqNow/elqCfg.js'></script> <script type='text/javascript' language='JavaScript' src='https://www.redhat.com/j/elqNow/elqImg.js'></script> <div id="oTags"> <script type="text/javascript" src="//www.redhat.com/j/s_code.js"></script> <script type="text/javascript"><!--
  var coreUrl = encodeURI(document.URL.split("?")[0]).replace(/-/g," ");
  var urlSplit = coreUrl.toLowerCase().split(/\//);
  var urlLast = urlSplit[urlSplit.length-1];
  var pageNameString = "";
  var siteName = "";
  var minorSectionIndex = 3
  if (urlLast == "") {
      urlSplit.splice(-1,1);
  }
  if (urlLast.search(/\./) >= 0) {
      if (urlLast == "index.html") {
          urlSplit.splice(-1,1);
      }
      else {
          urlSplit[urlSplit.length-1] = urlLast.split(".").splice(0,1);
      }
  }
  siteName = urlSplit[2].split(".")[1];
  s.prop14 = s.eVar27 = siteName || "";
  s.prop15 = s.eVar28 = urlSplit[minorSectionIndex] || "";
  s.prop16 = s.eVar29 = urlSplit[minorSectionIndex+1] || "";
  pageNameString = urlSplit.splice(3).join(" | ");
  s.pageName = "jboss | community | " + siteName + " | " + pageNameString;
  s.server = "jboss";
  s.channel = "jboss | community";
  s.prop4 = s.eVar23 = encodeURI(document.URL);
  s.prop21 = s.eVar18 = coreUrl;
  s.prop2 = s.eVar22 = "en";
  s.prop3 = s.eVar19 = "us";
  //--></script> <script type="text/javascript" src="//www.redhat.com/j/rh_omni_footer.js"></script> <script language="JavaScript" type="text/javascript"><!--
  if(navigator.appVersion.indexOf('MSIE')>=0)document.write(unescape('%3C')+'\!-'+'-')
  //--></script> <noscript><a href="http://www.omniture.com" title="Web Analytics"><img src="https://smtrcs.redhat.com/b/ss/redhatcom,redhatglobal/1/H.25.4--NS/0?[AQB]&cdp=3&[AQE]" height="1" width="1" border="0" alt=""/></a></noscript> </div> <script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script> <script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-10656779-1");
pageTracker._trackPageview();
} catch(err) {}</script> <script>
 (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
 
ga('create', 'UA-76464546-1', 'auto');
ga('send', 'pageview');
ga('set', 'anonymizeIp', true);
ga('require', 'linkid', 'linkid.js');

</script> </div> </body> </html>