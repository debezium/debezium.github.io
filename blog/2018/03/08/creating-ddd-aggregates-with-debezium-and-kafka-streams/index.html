<!DOCTYPE html>
<html>

<head>
  <title>Creating DDD aggregates with Debezium and Kafka Streams</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Debezium is an open source distributed platform for change data capture. Start it up, point it at your databases, and your apps can start responding to all of the inserts, updates, and deletes that other apps commit to your databases. Debezium is durable and fast, so your apps can respond quickly and never miss an event, even when things go wrong.">
  <link rel="alternate" type="application/rss+xml" title="Debezium Blog" href="/blog.atom">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/assets/css/bootstrap.min.css" />
  <link rel="stylesheet" href="/assets/css/custom.css" />
  
</head>

<body class="post">
  <div id="rhbar">
  <a class="jbdevlogo" href="https://developers.redhat.com"></a>
  <a class="rhlogo" href="https://www.redhat.com/"></a>
</div>

  <div id>
    <div class="container" id="content">
      <nav class="navbar navbar-inverse navbar-fix">
  <div class="container-fluid">
    <div class="navbar-header">
      <button class="navbar-toggle collapsed border-0" type="button" data-toggle="collapse" data-target="#navigation"
        aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/"><img class="project-logo" src="/assets/images/color_white_debezium_type_600px.svg" style="height: 32px; margin-right: 5px; margin-top: -5px;"></a>
    </div>
    <div class="collapse navbar-collapse collapsed" id="navigation">
      <ul class="nav navbar-nav pull-right">
        
            <li>
          
          <a href="/documentation/faq" class="">FAQ</a>
        </li>
        
            <li class="item">
          
          <a href="/documentation/" class="">Documentation</a>
        </li>
        
            <li>
          
          <a href="/releases/" class="">Releases</a>
        </li>
        
            <li>
          
            <a href="/community/" class="">Community</a>
        </li>
        
          <li class="active">
            
          <a href="/blog/" class="active">Blog</a>
        </li>
      </ul>
    </div>
  </div>
</nav>
        
          <div class="row post-text-padding row-no-expand">
  <!-- Sidebar -->
  <div class="col-md-3"><div id="leftdocnav">
  <div class="hidden-lg hidden-md hidden-sm">
    <button
      class="navbar-toggle docssubmenu-toggle collapsed"
      data-target="#docssubmenu"
      data-toggle="collapse"
      style="
        float: none;
        background-color: #656565;
        border-color: #656565;
        width: 100%;
        color: #fff;
      "
    >
      Navigation Menu
    </button>
  </div>
  <div class="collapse" id="docssubmenu">
    <div class="doc-pills">
      <ul class="nav nav-pills nav-stacked">
        <li class="item">
          <a href="/blog">Home</a>
          <div class="icon"><span class="icon-home"></span></div>
        </li>
        
          <li class="item">
        
          <a href="/archives">Archive</a>
          <div class="icon"><span class="icon-arrow-down"></span></div>
        </li>
        <li class="item">
          <a href="/blog.atom">Feed</a>
          <div class="icon"><span class="icon-rss"></span></div>
        </li>
      </ul>
    </div>
    <p></p>
    <div class="featured-posts">
      <div id="#featured" style="margin-bottom: 4px; border-bottom: 1px solid #ccc; font-size: 115%; margin-left: 2px;">Featured Posts</div>
        <ul style="padding-inline-start: 22px;">
          
            
          
            
          
            
          
            
          
            
            <li style="margin-bottom: 3px;">
              <a href="/blog/2020/11/04/streaming-vitess-at-bolt/" style="font-size: 95%;">
                Streaming Vitess at Bolt
              </a>
            </li>  
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
            <li style="margin-bottom: 3px;">
              <a href="/blog/2020/02/10/event-sourcing-vs-cdc/" style="font-size: 95%;">
                Distributed Data for Microservices — Event Sourcing vs. Change Data Capture
              </a>
            </li>  
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
            <li style="margin-bottom: 3px;">
              <a href="/blog/2019/10/01/audit-logs-with-change-data-capture-and-stream-processing/" style="font-size: 95%;">
                Building Audit Logs with Change Data Capture and Stream Processing
              </a>
            </li>  
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
            <li style="margin-bottom: 3px;">
              <a href="/blog/2019/07/12/streaming-cassandra-at-wepay-part-1/" style="font-size: 95%;">
                Streaming Cassandra at WePay - Part 1
              </a>
            </li>  
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
            <li style="margin-bottom: 3px;">
              <a href="/blog/2019/02/19/reliable-microservices-data-exchange-with-the-outbox-pattern/" style="font-size: 95%;">
                Reliable Microservices Data Exchange With the Outbox Pattern
              </a>
            </li>  
            
          
            
          
            
          
            
          
            
          
            
          
            
            <li style="margin-bottom: 3px;">
              <a href="/blog/2018/12/05/automating-cache-invalidation-with-change-data-capture/" style="font-size: 95%;">
                Automating Cache Invalidation With Change Data Capture
              </a>
            </li>  
            
          
            
          
            
          
            
            <li style="margin-bottom: 3px;">
              <a href="/blog/2018/09/20/materializing-aggregate-views-with-hibernate-and-debezium/" style="font-size: 95%;">
                Materializing Aggregate Views With Hibernate and Debezium
              </a>
            </li>  
            
          
            
          
            
          
            
          
            
          
            
            <li style="margin-bottom: 3px;">
              <a href="/blog/2018/07/19/advantages-of-log-based-change-data-capture/" style="font-size: 95%;">
                Five Advantages of Log-Based Change Data Capture
              </a>
            </li>  
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
            <li style="margin-bottom: 3px;">
              <a href="/blog/2018/03/08/creating-ddd-aggregates-with-debezium-and-kafka-streams/" style="font-size: 95%;">
                Creating DDD aggregates with Debezium and Kafka Streams
              </a>
            </li>  
            
          
            
          
            
          
            
          
            
            <li style="margin-bottom: 3px;">
              <a href="/blog/2018/01/17/streaming-to-elasticsearch/" style="font-size: 95%;">
                Streaming Data Changes from Your Database to Elasticsearch
              </a>
            </li>  
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        </ul>
    </div>
    <p></p>
    <p></p>
    <div class="cloud-tags">
      <div id="tags" style="margin-bottom: 4px; border-bottom: 1px solid #ccc; font-size: 115%; margin-left: 2px;"> Tags
      </div>
        <div class="tag-cloud"> 
          
          
          <span class="site-tag">
            <a href="/tag/apache-kafka/" style="font-size: 88%">
              apache kafka
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/apicurio/" style="font-size: 82%">
              apicurio
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/avro/" style="font-size: 84%">
              avro
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/aws/" style="font-size: 82%">
              aws
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/camel/" style="font-size: 82%">
              camel
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/cassandra/" style="font-size: 130%">
              cassandra
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/community/" style="font-size: 102%">
              community
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/cqrs/" style="font-size: 82%">
              cqrs
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/db2/" style="font-size: 110%">
              db2
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/debezium-server/" style="font-size: 86%">
              debezium server
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/discussion/" style="font-size: 112%">
              discussion
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/docker/" style="font-size: 182%">
              docker
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/ebezium-server/" style="font-size: 82%">
              ebezium server
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/elasticsearch/" style="font-size: 82%">
              elasticsearch
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/event-sourcing/" style="font-size: 82%">
              event sourcing
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/example/" style="font-size: 88%">
              example
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/examples/" style="font-size: 102%">
              examples
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/fedora/" style="font-size: 82%">
              fedora
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/integration/" style="font-size: 82%">
              integration
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/introduction/" style="font-size: 84%">
              introduction
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/jaeger/" style="font-size: 82%">
              jaeger
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/json/" style="font-size: 82%">
              json
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/kafka/" style="font-size: 86%">
              kafka
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/kafka-streams/" style="font-size: 86%">
              kafka streams
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/kogito/" style="font-size: 82%">
              kogito
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/ksql/" style="font-size: 82%">
              ksql
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/kubernetes/" style="font-size: 82%">
              kubernetes
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/microservices/" style="font-size: 84%">
              microservices
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/mongodb/" style="font-size: 184%">
              mongodb
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/mysql/" style="font-size: 248%">
              mysql
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/news/" style="font-size: 100%">
              news
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/newsletter/" style="font-size: 86%">
              newsletter
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/oracle/" style="font-size: 146%">
              oracle
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/outbox/" style="font-size: 98%">
              outbox
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/postgres/" style="font-size: 218%">
              postgres
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/presentation/" style="font-size: 84%">
              presentation
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/production/" style="font-size: 82%">
              production
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/quarkus/" style="font-size: 90%">
              quarkus
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/rds/" style="font-size: 84%">
              rds
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/releases/" style="font-size: 232%">
              releases
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/schema/" style="font-size: 82%">
              schema
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/secrets/" style="font-size: 82%">
              secrets
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/sentry/" style="font-size: 82%">
              sentry
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/serialization/" style="font-size: 82%">
              serialization
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/smt/" style="font-size: 84%">
              smt
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/sql/" style="font-size: 84%">
              sql
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/sqlserver/" style="font-size: 166%">
              sqlserver
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/testcontainers/" style="font-size: 88%">
              testcontainers
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/topics/" style="font-size: 82%">
              topics
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/tracing/" style="font-size: 82%">
              tracing
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/vagrant/" style="font-size: 82%">
              vagrant
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/vitess/" style="font-size: 92%">
              vitess
            </a>
          </span>
          
          <span class="site-tag">
            <a href="/tag/website/" style="font-size: 84%">
              website
            </a>
          </span>
          
        </div>
  </div>
  </div>
</div>
</div>
  <div class="col-md-9">
    <div class="post">
      
      <div
        class="row"
        style="margin-left: 0; margin-right: 0; margin-bottom: 10px"
      >
        <div class="col-sm-12" style="padding-left: 0px">
          <div style="display: table-cell; vertical-align: top">
            <div
              style="
                width: 72px;
                border: 1px solid #ccc;
                padding: 3px;
                display: inline-block;
              "
            >
            
                  <img src="/assets/images/color_debezium_64px.png" style="width: 64px;"> 
                
            </div>
          </div>
          <div style="display: table-cell; vertical-align: top">
            <div style="margin-left: 8px">
              <span
                class="hidden-sm hidden-xs"
                style="font-size: 2.75rem; line-height: 1"
              >
                <a href="/blog/2018/03/08/creating-ddd-aggregates-with-debezium-and-kafka-streams/">Creating DDD aggregates with Debezium and Kafka Streams</a>
              </span>
              <span
                class="hidden-md hidden-lg"
                style="font-size: 2rem; line-height: 1"
              >
                <a href="/blog/2018/03/08/creating-ddd-aggregates-with-debezium-and-kafka-streams/">Creating DDD aggregates with Debezium and Kafka Streams</a>
              </span>
              <div class="byline" style="line-height: 1">
                
                    
                    <em> March 8, 2018 by </em>
                    <em> Hans-Peter Grahsl, Gunnar Morling </em>
                <div class="hidden-xs" style="margin-top: 5px">
                  
                  <a
                    class="label label-info hidden-sm hidden-xs"
                    href="/tag/discussion/"
                    >discussion</a
                  >
                  
                  <a
                    class="label label-info hidden-sm hidden-xs"
                    href="/tag/examples/"
                    >examples</a
                  >
                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="grid__item width-12-12"><div class="paragraph">
<p>Microservice-based architectures can be considered an industry trend and are thus
often found in enterprise applications lately. One possible way to keep data
synchronized across multiple services and their backing data stores is to make us of an approach
called <a href="https://vladmihalcea.com/a-beginners-guide-to-cdc-change-data-capture/">change data capture</a>, or CDC for short.</p>
</div>
<div class="paragraph">
<p>Essentially CDC allows to listen to any modifications which are occurring at one end of a data flow (i.e. the data source)
and communicate them as change events to other interested parties or storing them into a data sink.
Instead of doing this in a point-to-point fashion, it&#8217;s advisable to decouple this flow of events
between data sources and data sinks. Such a scenario can be implemented based on <a href="https://debezium.io/">Debezium</a>
and <a href="https://kafka.apache.org/">Apache Kafka</a> with relative ease and effectively no coding.</p>
</div>
<div class="paragraph">
<p>As an example, consider the following microservice-based architecture of an order management system:</p>
</div>
<div class="paragraph">
<p><!-- more --></p>
</div>
<div class="exampleblock centered-image responsive-image">
<div class="content">
<img src="/assets/images/msa_streaming.png" style="max-width:100%;" class="responsive-image">
</div>
</div>
<div class="paragraph">
<p>This system comprises three services, <em>Order</em>, <em>Item</em> and <em>Stock</em>.
If the <em>Order</em> service receives an order request, it will need information from the other two,
such as item definitions or the stock count for specific items.
Instead of making synchronous calls to these services to obtain this information,
CDC can be used to set up change event streams for the data managed by the <em>Item</em> and <em>Stock</em> services.
The <em>Order</em> service can subscribe to these event streams and keep a local copy of the relevant item and stock data in its own database.
This approach helps to decouple the services
(e.g. no direct impact by service outages)
and can also be beneficial for overall performance,
as each service can hold optimized views just of those data items owned by other services which it is interested in.</p>
</div>
<div class="sect1">
<h2 id="how-to-handle-aggregate-objects">How to Handle Aggregate Objects?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are use cases however, where things are a bit more tricky. It is sometimes
useful to share information across services and data stores by means of so-called
aggregates, which are a concept/pattern defined by domain-driven design (DDD).
In general, a <a href="https://martinfowler.com/bliki/DDD_Aggregate.html">DDD aggregate</a> is used
to transfer state which can be comprised of multiple different domain objects that are
together treated as a single unit of information.</p>
</div>
<div class="paragraph">
<p>Concrete examples are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>customers and their addresses</strong> which are represented as a customer record <em>aggregate</em>
storing a customer and a list of addresses</p>
</li>
<li>
<p><strong>orders and corresponding line items</strong> which are represented as an order record
<em>aggregate</em> storing an order and all its line items</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Chances are that the data of the involved domain objects backing these DDD aggregates are stored in
separate relations of an RDBMS. When making use of the CDC capabilities currently found
in Debezium, all changes to domain objects will be independently captured and by default eventually
reflected in separate Kafka topics, one per RDBMS relation. While this behaviour
is tremendously helpful for a lot of use cases it can be pretty limiting to others,
like the DDD aggregate scenario described above.
Therefore, this blog post explores how DDD aggregates can be built based on Debezium CDC events,
using the <a href="https://kafka.apache.org/documentation/streams/">Kafka Streams API</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="capturing-change-events-from-a-data-source">Capturing Change Events from a Data Source</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The complete source code for this blog post is provided in the Debezium <a href="https://github.com/debezium/debezium-examples/tree/master/kstreams">examples repository</a> on GitHub.
Begin by cloning this repository and changing into the <em>kstreams</em> directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">git clone https://github.com/debezium/debezium-examples.git
cd kstreams</code></pre>
</div>
</div>
<div class="paragraph">
<p>The project provides a Docker Compose file with services for all the components you may already know from the <a href="/docs/tutorial/">Debezium tutorial</a>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://zookeeper.apache.org/">Apache ZooKeeper</a></p>
</li>
<li>
<p><a href="https://kafka.apache.org/">Apache Kafka</a></p>
</li>
<li>
<p>A <a href="https://kafka.apache.org/documentation/#connect">Kafka Connect</a> instance with the Debezium CDC connectors</p>
</li>
<li>
<p><a href="http://www.mysql.com/">MySQL</a> (populated with some test data)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In addition it declares the following services:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://www.mongodb.com/">MongoDB</a> which will be used as a data sink</p>
</li>
<li>
<p>Another Kafka Connect instance which will host the MongoDB sink connector</p>
</li>
<li>
<p>A service for running the DDD aggregation process we&#8217;re going to build in the following</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We&#8217;ll get to those three in a bit, for now let&#8217;s prepare the source side of our pipeline:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">export DEBEZIUM_VERSION=0.7
docker-compose up mysql zookeeper kafka connect_source</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once all services have been started, register an instance of the Debezium MySQL connector by submitting the following JSON document:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
    "name": "mysql-source",
    "config": {
        "connector.class": "io.debezium.connector.mysql.MySqlConnector",
        "tasks.max": "1",
        "database.hostname": "mysql",
        "database.port": "3306",
        "database.user": "debezium",
        "database.password": "dbz",
        "database.server.id": "184054",
        "database.server.name": "dbserver1",
        "table.whitelist": "inventory.customers,inventory.addresses",
        "database.history.kafka.bootstrap.servers": "kafka:9092",
        "database.history.kafka.topic": "schema-changes.inventory",
        "transforms": "unwrap",
        "transforms.unwrap.type":"io.debezium.transforms.UnwrapFromEnvelope",
        "transforms.unwrap.drop.tombstones":"false"
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To do so, run the following curl command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">curl -i -X POST -H "Accept:application/json" -H  "Content-Type:application/json" http://localhost:8083/connectors/ -d @mysql-source.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>This sets up the connector for the specified database, using the given credentials.
For our purposes we&#8217;re only interested in changes to the <code>customers</code> and <code>addresses</code> tables,
hence the <code>table.whitelist</code> property is given to just select these two tables.
Another noteworthy thing is the "unwrap" transform that is applied.
By default, Debezium&#8217;s CDC events would contain the old and new state of changed rows and some additional metadata on the source of the change.
By applying the <a href="/docs/configuration/event-flattening/">UnwrapFromEnvelope</a> SMT (single message transformation),
only the new state will be propagated into the corresponding Kafka topics.</p>
</div>
<div class="paragraph">
<p>We can take a look at them once the connector has been deployed and finished its initial snapshot of the two captured tables:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">docker-compose exec kafka /kafka/bin/kafka-console-consumer.sh \
    --bootstrap-server kafka:9092 \
    --from-beginning \
    --property print.key=true \
    --topic dbserver1.inventory.customers # or dbserver1.inventory.addresses</code></pre>
</div>
</div>
<div class="paragraph">
<p>E.g. you should see the following output</p>
</div>
<div class="paragraph">
<p>(formatted and omitting the schema information for the sake of readability) for the topic with customer changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">{
    "schema": { ... },
    "payload": {
        "id": 1001
    }
}
{
    "schema": { ... },
    "payload": {
        "id": 1001,
        "first_name": "Sally",
        "last_name": "Thomas",
        "email": "sally.thomas@acme.com"
    }
}
...</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="building-ddd-aggregates">Building DDD Aggregates</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The KStreams application is going to process data from the two Kafka topics. These topics
receive CDC events based on the customers and addresses relations found in MySQL, each of which has its
corresponding Jackson-annotated POJO (Customer and Address), enriched by a field holding the CDC event type (i.e. UPSERT/DELETE).</p>
</div>
<div class="paragraph">
<p>Since the Kafka topic records are in Debezium JSON format with unwrapped envelopes, a special <strong>SerDe</strong>
has been written in order to be able to read/write these records using their POJO or Debezium event representation respectively.
While the serializer simply converts the POJOs into JSON using Jackson, the deserializer is a "hybrid"
one, being able to deserialize from either Debezium CDC events or jsonified POJOs.</p>
</div>
<div class="paragraph">
<p>With that in place, the KStreams topology to create and maintain DDD aggregates on-the-fly can be built as follows:</p>
</div>
<div class="sect2">
<h3 id="customers-topic-parent">Customers Topic ("parent")</h3>
<div class="paragraph">
<p>All the customer records are simply read from the customer topic into a <strong>KTable</strong> which will automatically maintain
the latest state per customer according to the record key (i.e. the customer&#8217;s PK)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">KTable&lt;DefaultId, Customer&gt; customerTable =
        builder.table(parentTopic, Consumed.with(defaultIdSerde,customerSerde));</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="addresses-topic-children">Addresses Topic ("children")</h3>
<div class="paragraph">
<p>For the address records the processing is a bit more involved and needs several steps. First, all the address
records are read into a <strong>KStream</strong>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">KStream&lt;DefaultId, Address&gt; addressStream = builder.stream(childrenTopic,
        Consumed.with(defaultIdSerde, addressSerde));</code></pre>
</div>
</div>
<div class="paragraph">
<p>Second, a 'pseudo' grouping of these address records is done based on their keys (the original primary key in the relation),
During this step the relationships towards the corresponding customer records are maintained. This effectively allows to keep
track which address record belongs to which customer record, even in the light of address record deletions.
To achieve this an additional <em>LatestAddress</em> POJO is introduced which allows to store the latest known PK &lt;&#8594; FK
relation in addition to the <em>Address</em> record itself.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">KTable&lt;DefaultId,LatestAddress&gt; tempTable = addressStream
        .groupByKey(Serialized.with(defaultIdSerde, addressSerde))
        .aggregate(
                () -&gt; new LatestAddress(),
                (DefaultId addressId, Address address, LatestAddress latest) -&gt; {
                    latest.update(
                        address, addressId, new DefaultId(address.getCustomer_id()));
                    return latest;
                },
                Materialized.&lt;DefaultId,LatestAddress,KeyValueStore&lt;Bytes, byte[]&gt;&gt;
                        as(childrenTopic+"_table_temp")
                            .withKeySerde(defaultIdSerde)
                                .withValueSerde(latestAddressSerde)
        );</code></pre>
</div>
</div>
<div class="paragraph">
<p>Third, the intermediate <strong>KTable</strong> is again converted to a <strong>KStream</strong>. The <em>LatestAddress</em> records are transformed
to have the customer id (FK relationship) as their new key in order to group them per customer.
During the grouping step, customer specific addresses are updated which can result in an address
record being added or deleted. For this purpose, another POJO called <em>Addresses</em> is introduced, which
holds a map of address records that gets updated accordingly. The result is a <strong>KTable</strong> holding the
most recent <em>Addresses</em> per customer id.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">KTable&lt;DefaultId, Addresses&gt; addressTable = tempTable.toStream()
        .map((addressId, latestAddress) -&gt;
            new KeyValue&lt;&gt;(latestAddress.getCustomerId(),latestAddress))
        .groupByKey(Serialized.with(defaultIdSerde,latestAddressSerde))
        .aggregate(
                () -&gt; new Addresses(),
                (customerId, latestAddress, addresses) -&gt; {
                    addresses.update(latestAddress);
                    return addresses;
                },
                Materialized.&lt;DefaultId,Addresses,KeyValueStore&lt;Bytes, byte[]&gt;&gt;
                        as(childrenTopic+"_table_aggregate")
                            .withKeySerde(defaultIdSerde)
                                .withValueSerde(addressesSerde)
        );</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="combining-customers-with-addresses">Combining Customers With Addresses</h3>
<div class="paragraph">
<p>Finally, it&#8217;s easy to bring customers and addresses together by <strong>joining the customers KTable with
the addresses KTable</strong> and thereby building the DDD aggregates which are represented by the <em>CustomerAddressAggregate</em> POJO.
At the end, the KTable changes are written to a KStream, which in turn gets saved into a kafka topic.
This allows to make use of the resulting DDD aggregates in manifold ways.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">KTable&lt;DefaultId,CustomerAddressAggregate&gt; dddAggregate =
          customerTable.join(addressTable, (customer, addresses) -&gt;
              customer.get_eventType() == EventType.DELETE ?
                      null :
                      new CustomerAddressAggregate(customer,addresses.getEntries())
          );

  dddAggregate.toStream().to("final_ddd_aggregates",
                              Produced.with(defaultIdSerde,(Serde)aggregateSerde));</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Records in the customers KTable might receive a CDC delete event. If so, this can be detected by
checking the event type field of the customer POJO and e.g. return 'null' instead of a DDD aggregate.
Such a convention can be helpful whenever consuming parties also need to act to deletions accordingly._</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="running-the-aggregation-pipeline">Running the Aggregation Pipeline</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Having implemented the aggregation pipeline, it&#8217;s time to give it a test run.
To do so, build the <em>poc-ddd-aggregates</em> Maven project which contains the complete implementation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">mvn clean package -f poc-ddd-aggregates/pom.xml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then run the <code>aggregator</code> service from the Compose file which takes the JAR built by this project
and launches it using the <a href="https://hub.docker.com/r/fabric8/java-jboss-openjdk8-jdk/">java-jboss-openjdk8-jdk</a> base image:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">docker-compose up -d aggregator</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the aggregation pipeline is running, we can take a look at the aggregated events using the console consumer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">docker-compose exec kafka /kafka/bin/kafka-console-consumer.sh \
    --bootstrap-server kafka:9092 \
    --from-beginning \
    --property print.key=true \
    --topic final_ddd_aggregates</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="transferring-ddd-aggregates-to-data-sinks">Transferring DDD Aggregates to Data Sinks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We originally set out to build these DDD aggregates in order to transfer data and synchronize changes between
a data source (MySQL tables in this case) and a convenient data sink. By definition,
DDD aggregates are typically complex data structures and therefore it makes perfect sense to write them
to data stores which offer flexible ways and means to query and/or index them. Talking about NoSQL databases, a
document store seems the most natural choice with <a href="https://www.mongodb.com/">MongoDB</a> being the leading database
for such use cases.</p>
</div>
<div class="paragraph">
<p>Thanks to <a href="https://kafka.apache.org/documentation/#connect">Kafka Connect</a> and numerous turn-key ready
<a href="https://www.confluent.io/product/connectors/">connectors</a> it is almost effortless to get this done.
Using a <a href="https://github.com/hpgrahsl/kafka-connect-mongodb">MongoDB sink connector</a> from the open-source community,
it is easy to have the DDD aggregates written into MongoDB. All it needs is a proper configuration which can be posted
to the <a href="https://docs.confluent.io/current/connect/restapi.html">REST API</a> of Kafka Connect in order to run the connector.</p>
</div>
<div class="paragraph">
<p>So let&#8217;s start MongoDb and another Kafka Connect instance for hosting the sink connector:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">docker-compose up -d mongodb connect_sink</code></pre>
</div>
</div>
<div class="paragraph">
<p>In case the DDD aggregates should get written unmodified into MongoDB, a configuration may look as simple as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
    "name": "mongodb-sink",
    "config": {
        "connector.class": "at.grahsl.kafka.connect.mongodb.MongoDbSinkConnector",
        "tasks.max": "1",
        "topics": "final_ddd_aggregates",
        "mongodb.connection.uri": "mongodb://mongodb:27017/inventory?w=1&amp;journal=true",
        "mongodb.collection": "customers_with_addresses",
        "mongodb.document.id.strategy": "at.grahsl.kafka.connect.mongodb.processor.id.strategy.FullKeyStrategy",
        "mongodb.delete.on.null.values": true
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As with the source connector, deploy the connector using curl:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">curl -i -X POST -H "Accept:application/json" -H  "Content-Type:application/json" http://localhost:8084/connectors/ -d @mongodb-sink.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>This connector will consume messages from the "final_ddd_aggregates" Kafka topic and
write them as <strong>MongoDB documents</strong> into the "customers_with_addresses" collection.</p>
</div>
<div class="paragraph">
<p>You can take a look by firing up a Mongo shell and querying the collection&#8217;s contents:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">docker-compose exec mongodb bash -c 'mongo inventory'

&gt; db.customers_with_addresses.find().pretty()</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
    "_id": {
        "id": "1001"
    },
    "addresses": [
        {
            "zip": "76036",
            "_eventType": "UPSERT",
            "city": "Euless",
            "street": "3183 Moore Avenue",
            "id": "10",
            "state": "Texas",
            "customer_id": "1001",
            "type": "SHIPPING"
        },
        {
            "zip": "17116",
            "_eventType": "UPSERT",
            "city": "Harrisburg",
            "street": "2389 Hidden Valley Road",
            "id": "11",
            "state": "Pennsylvania",
            "customer_id": "1001",
            "type": "BILLING"
        }
    ],
    "customer": {
        "_eventType": "UPSERT",
        "last_name": "Thomas",
        "id": "1001",
        "first_name": "Sally",
        "email": "sally.thomas@acme.com"
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Due to the combination of the data in a single document some parts aren&#8217;t needed or redundant. To get rid of any
unwanted data (e.g. _eventType, customer_id of each address sub-document) it would also be possible
to adapt the configuration in order to blacklist said fields.</p>
</div>
<div class="paragraph">
<p>Finally, you update some customer or address data in the MySQL source database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">docker-compose exec mysql bash -c 'mysql -u $MYSQL_USER -p$MYSQL_PASSWORD inventory'

mysql&gt; update customers set first_name= "Sarah" where id = 1001;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Shortly thereafter, you should see that the corresponding aggregate document in MongoDB has been updated accordingly.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="drawbacks-and-limitations">Drawbacks and Limitations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>While this first version for creating DDD aggregates from table-based CDC events basically works, it is very important to understand its current limitations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>not generically applicable thus needs custom code for POJOs and intermediate types</p>
</li>
<li>
<p>cannot be scaled across multiple instances as is due to missing but necessary data repartitioning prior to processing</p>
</li>
<li>
<p>limited to building aggregates based on a single JOIN between 1:N relationships</p>
</li>
<li>
<p>resulting DDD aggregates are eventually consistent, meaning that it is possible for them to temporarily exhibit intermediate state before converging</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The first few can be addressed with a reasonable amount of work on the KStreams application. The last one,
dealing with the eventually consistent nature of resulting DDD aggregates is much harder to correct
and will require some efforts at Debezium&#8217;s own CDC mechanism.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="outlook">Outlook</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this post we described an approach for creating aggregated events from Debezium&#8217;s CDC events.
In a follow-up blog post we may dive a bit more into the topic of how to be able to horizontally scale
the DDD creation by running multiple KStreams aggregator instances. For that purpose, the data needs proper
re-partitioning before running the topology. In addition, it could be interesting to look into
a somewhat more generic version which only needs custom classes to the describe the two main POJOs involved.</p>
</div>
<div class="paragraph">
<p>We also thought about providing a ready-to-use component which would work in a generic way
(based on Connect records, i.e. not tied to a specific serialization format such as JSON) and
could be set up as a configurable stand-alone process running given aggregations.</p>
</div>
<div class="paragraph">
<p>Also on the topic of dealing with eventual consistency we got some ideas,
but those will need some more exploration and investigation for sure.
Stay tuned!</p>
</div>
<div class="paragraph">
<p>We&#8217;d love to hear about your feedback on the topic of event aggreation.
If you got any ideas or thoughts on the subject,
please get in touch by posting a comment below or sending a message to our <a href="https://groups.google.com/forum/#!forum/debezium">mailing list</a>.</p>
</div>
</div>
</div></div>
    </div>
    
   
      
      
      <div class="well">
      <div class="row">
        <div class="col-md-8">
          <h2>Hans-Peter Grahsl</h2>
          
          <p>
            <span class="bio-size"
              >Hans-Peter is a technical trainer at NETCONOMY as well as an individual consultant for Java web development and modern data architectures. Besides, he is working as an associate lecturer for software engineering. He lives in Graz, Austria.</span
            >
          </p>
          
          <p class="bio-size">
            
            <a href="https://twitter.com/Hans-Peter is a technical trainer at NETCONOMY as well as an individual consultant for Java web development and modern data architectures. Besides, he is working as an associate lecturer for software engineering. He lives in Graz, Austria.">
              <i class="icon-twitter"></i>
            </a>
            &nbsp;
            
            
            <a href="https://github.com/hpgrahsl">
              <i class="icon-github"></i>
            </a>
            &nbsp;
            
            
            <a href="https://www.linkedin.com/in/hpgrahsl">
              <i class="icon-linkedin"></i>
            </a>
            &nbsp;
            
          </p>
        </div>
        <div class="col-md-4">
          
          <img
            alt=""
            class="img-responsive pull-right portrait"
            src="/assets/images/hpgrahsl.jpg"
          />
          
        </div>
      </div>
    </div>
    
      
      <div class="well">
      <div class="row">
        <div class="col-md-8">
          <h2>Gunnar Morling</h2>
          
          <p>
            <span class="bio-size"
              >Gunnar is a software engineer at Red Hat and open-source enthusiast by heart. A long-time Hibernate core team member, he's now the project lead of Debezium. Gunnar is the spec lead for Bean Validation 2.0 (JSR 380). He’s based in Hamburg, Germany.</span
            >
          </p>
          
          <p class="bio-size">
            
            <a href="https://twitter.com/Gunnar is a software engineer at Red Hat and open-source enthusiast by heart. A long-time Hibernate core team member, he's now the project lead of Debezium. Gunnar is the spec lead for Bean Validation 2.0 (JSR 380). He’s based in Hamburg, Germany.">
              <i class="icon-twitter"></i>
            </a>
            &nbsp;
            
            
            <a href="https://github.com/gunnarmorling">
              <i class="icon-github"></i>
            </a>
            &nbsp;
            
            
          </p>
        </div>
        <div class="col-md-4">
          
          <img
            alt=""
            class="img-responsive pull-right portrait"
            src="/assets/images/gmorling.jpg"
          />
          
        </div>
      </div>
    </div>
    

      <ul class="pager pager-blog">
        
          <li class="previous">
            <a href="/blog/2018/03/07/debezium-0-7-4-released/" class="previous"> &laquo; Previous</a>
        </li>
                
        
        <li class="next"><a href="/blog/2018/03/16/note-on-database-history-topic-configuration/">Next &raquo; </a></li>
        
      </ul>
    
    
    <div class="row">
      <div class="col-md-12">
        <hr>
        <h2>About Debezium</h2>
        <p>
          Debezium is an open source distributed platform that turns your existing databases into event streams,
          so applications can see and respond almost instantly to each committed row-level change in the databases.
          Debezium is built on top of <a href="http://kafka.apache.org/">Kafka</a> and provides <a href="http://kafka.apache.org/documentation.html#connect">Kafka Connect</a> compatible connectors that monitor specific database management systems.
          Debezium records the history of data changes in Kafka logs, so your application can be stopped and restarted at any time and can easily consume all of the events it missed while it was not running,
          ensuring that all events are processed correctly and completely.
          Debezium is <a href="/license/">open source</a> under the <a href="http://www.apache.org/licenses/LICENSE-2.0.html">Apache License, Version 2.0</a>.
        </p>
      </div>
    </div>
    <div class="row">
      <div class="col-md-12">
        <h2>Get involved</h2>
        <p>
          We hope you find Debezium interesting and useful, and want to give it a try.
          Follow us on Twitter <a href="https://twitter.com/debezium">@debezium</a>, <a href="https://gitter.im/debezium/user">chat with us on Gitter</a>,
          or join our <a href="https://groups.google.com/forum/#!forum/debezium">mailing list</a> to talk with the community.
          All of the code is open source <a href="https://github.com/debezium/">on GitHub</a>,
          so build the code locally and help us improve ours existing connectors and add even more connectors.
          If you find problems or have ideas how we can improve Debezium, please let us know or <a href="https://issues.redhat.com/projects/DBZ/issues/">log an issue</a>.
        </p>
      </div>
    </div>
    
    
  </div>
</div>

        
      </div>
      <footer class="container">
  <div>
  <div class="row mr-0 ml-0">
    <div class="col-md-5 col-md-offset-1">
      <h4>Debezium</h4>
      <p>
        &#169; 2020 Debezium Community <br />
        <br />
        <i class="icon-fire"></i> Mixed with
        <a href="https://getbootstrap.com/">Bootstrap</a>, baked by
        <a href="https://jekyllrb.com/">Jekyll</a>. <br />
        <i class="icon-flag"></i> Website and docs licensed under
        <a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>.
        <br />
        <i class="icon-flag-alt"></i> Code released under
        <a href="https://www.apache.org/licenses/LICENSE-2.0.html"
          >Apache License, v2.0</a
        >. <br />
        <i class="icon-file-alt"></i>
        <a
          href="https://www.redhat.com/legal/legal_statement.html"
          title="Terms"
          >Terms</a
        >
        |
        <a
          href="https://www.redhat.com/legal/privacy_statement.html"
          title="Privacy Policy"
          >Privacy</a
        >
      </p>
    </div>
    <div class="col-md-3">
      <h4>Documentation</h4>
      <ul class="list-unstyled">
        <li><a href="/documentation/reference/features.html" title="Features">Features</a></li>
        <li>
          <a href="documentation/reference/install.html" title="Install">Install</a>
        </li>
        <li>
          <a href="/documentation/reference/architecture.html" title="Architecture"
            >Architecture</a
          >
        </li>
        <li><a href="/documentation/faq/" title="FAQ">FAQ</a></li>
        <li>
          <a href="/community/contribute/" title="Contribute">Contribute</a>
        </li>
      </ul>
    </div>
    <div class="col-md-3">
      <h4>Connect</h4>
      <ul class="list-unstyled">
        <li><a href="/blog" title="Blog">Blog</a></li>
        <li>
          <a href="https://twitter.com/debezium" title="Twitter">Twitter</a>
        </li>
        <li><a href="https://github.com/debezium" title="GitHub">GitHub</a></li>
        <li><a href="https://gitter.im/debezium/user" title="Chat">Chat</a></li>
        <li>
          <a
            href="https://groups.google.com/forum/#!forum/debezium"
            title="Google Groups"
            >Google Groups</a
          >
        </li>
        <li>
          <a
            href="https://stackoverflow.com/questions/tagged/debezium"
            title="StackOverflow"
            >StackOverflow</a
          >
        </li>
      </ul>
    </div>
  </div>
</div>
</footer>
      <div class="container" id="companyfooter">
  <div class="redhatlogo">
    <a href="https://www.redhat.com/">
      <img
        src="/assets/images/Logo-Red_Hat-Sponsored_By-B-Standard-RGB.svg"
      />
    </a>
  </div>
</div>
  </div>
  
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
  <script type="text/javascript" src="/assets/javascript/vanilla-back-to-top.min.js"></script>
  <script>
    addBackToTop({
      scrollDuration: 400
    })
  </script>
</body>

</html>
