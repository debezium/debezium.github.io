<!DOCTYPE html> <html lang="en"> <head> <title>Creating DDD aggregates with Debezium and Kafka Streams</title> <meta charset="utf-8"> <meta content="width=device-width, initial-scale=1.0" name="viewport"> <meta content="" name="description"> <meta content="" name="author"> <link href="https://static.jboss.org/theme/css/bootstrap-community/3.2.0.2/bootstrap-community.min.css" media="screen" rel="stylesheet"> <!--[if lt IE 9]><script src="https://static.jboss.org/theme/js/libs/html5/pre3.6/html5.min.js"></script><![endif]--> <link href="https://static.jboss.org/example/images/favicon.ico" rel="shortcut icon"> <link href="https://static.jboss.org/example/images/apple-touch-icon-144x144-precomposed.png" rel="apple-touch-icon-precomposed" sizes="144x144"> <link href="https://static.jboss.org/example/images/apple-touch-icon-114x114-precomposed.png" rel="apple-touch-icon-precomposed" sizes="114x114"> <link href="https://static.jboss.org/example/images/apple-touch-icon-72x72-precomposed.png" rel="apple-touch-icon-precomposed" sizes="72x72"> <link href="https://static.jboss.org/example/images/apple-touch-icon-precomposed.png" rel="apple-touch-icon-precomposed"> <link href="/stylesheets/debezium.css" rel="stylesheet" type="text/css"> <style>
  @media (min-width: 980px) {
    .banner { background-image: url(https://static.jboss.org/example/images/debezium-banner-1180px.png); height: 110px;  }
  }
  @media (max-width: 979px) {
    .banner { background-image: url(https://static.jboss.org/example/images/debezium-logo.png); background-repeat:no-repeat; background-position: center bottom; height: 60px; }
  }
  @media (max-width: 650px) {
    .banner { width: 100%; margin: 0px auto; }
  }
  @media (max-width: 450px) {
    .banner { height: 90px; }
  }
</style> <link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/styles/default.min.css" rel="stylesheet"> <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/highlight.min.js"></script> <script>
hljs.initHighlightingOnLoad();
</script> <script src="https://static.jboss.org/theme/js/libs/jquery/jquery-1.9.1.min.js"></script> <style>
  /* adjusting the vertical spacing for when a stickynav is engaged */
  .breadcrumb-fixed > .active {
    color: #8c8f91;
  }
  .breadcrumb-fixed {
    margin: 70px 0 10px;
    padding: 8px 15px;
    margin-bottom: 20px;
    list-style: none;
    background-color: #f5f5f5;
    border-radius: 4px;
  }
  
  .breadcrumb-fixed > li {
    display: inline-block;
  }
</style> </head> <body> <div id="rhbar"> <a class="jbdevlogo" href="https://www.jboss.org/projects/about"></a> <a class="rhlogo" href="https://www.redhat.com/"></a> </div> <div id=""> <ul class="visuallyhidden" id="top"> <li> <a accesskey="n" href="#nav" title="Skip to navigation">Skip to navigation</a> </li> <li> <a accesskey="c" href="#page" title="Skip to content">Skip to content</a> </li> </ul> <div class="container" id="content"> <div class="navbar navbar-inverse navbar-fix"> <div class="container-fluid"> <div class="navbar-header"> <button class="navbar-toggle collapsed" data-target="#navbar-1" data-toggle="collapse"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href="/"> <img src="/images/color_white_debezium_type_600px.svg" style="height: 32px; margin-right: 5px; margin-top: -5px;"> </a> </div> <div class="collapse navbar-collapse" id="navbar-1"> <ul class="nav navbar-nav pull-right"> <li class=""><a href="/documentation/faq/">FAQ</a></li> <li class=""><a href="/documentation/">DOCUMENTATION</a></li> <li class=""><a href="/releases/">RELEASES</a></li> <li class=""><a href="/community/">COMMUNITY</a></li> <li class="active"><a href="/blog/">BLOG</a></li> </ul> </div> </div> </div> <div id="equalHeightsLayout"> <div class="row post-text-padding row-no-expand"> <div class="hidden-xs col-sm-3 no-right-padding" id="leftdocnav" style="padding-left: 15px; padding-right: 15px;"> <div class="doc-pills"> <ul class="nav nav-pills nav-stacked"> <li class="item"> <a href="/blog">Home</a> <div class="icon"> <span class="icon-home"></span> </div> </li> <li class="item"> <a href="/blog.atom">Feed</a> <div class="icon"> <span class="icon-rss"></span> </div> </li> </ul> </div> <p></p> <div class="featured-posts"> <div id="featured" style="margin-bottom: 4px; border-bottom: 1px solid #ccc; font-size: 115%; margin-left: 2px;"> Featured Posts </div> <ul style="padding-inline-start: 22px;"> <li style="margin-bottom: 3px;"> <a href="/blog/2019/10/22/audit-logs-with-kogito/" style="font-size: 95%;"> Admin Service for Audit Logs with Kogito </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2019/10/01/audit-logs-with-change-data-capture-and-stream-processing/" style="font-size: 95%;"> Building Audit Logs with Change Data Capture and Stream Processing </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2019/07/12/streaming-cassandra-at-wepay-part-1/" style="font-size: 95%;"> Streaming Cassandra at WePay - Part 1 </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2019/02/19/reliable-microservices-data-exchange-with-the-outbox-pattern/" style="font-size: 95%;"> Reliable Microservices Data Exchange With the Outbox Pattern </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/12/05/automating-cache-invalidation-with-change-data-capture/" style="font-size: 95%;"> Automating Cache Invalidation With Change Data Capture </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/09/20/materializing-aggregate-views-with-hibernate-and-debezium/" style="font-size: 95%;"> Materializing Aggregate Views With Hibernate and Debezium </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/07/19/advantages-of-log-based-change-data-capture/" style="font-size: 95%;"> Five Advantages of Log-Based Change Data Capture </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/03/08/creating-ddd-aggregates-with-debezium-and-kafka-streams/" style="font-size: 95%;"> Creating DDD aggregates with Debezium and Kafka Streams </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/01/17/streaming-to-elasticsearch/" style="font-size: 95%;"> Streaming Data Changes from Your Database to Elasticsearch </a> </li> </ul> </div> <p></p> <div class="cloud-tags"> <div id="tags" style="margin-bottom: 4px; border-bottom: 1px solid #ccc; font-size: 115%; margin-left: 2px;"> Tags </div> <div class="tag-cloud"> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/apache-kafka/">apache-kafka</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/avro/">avro</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/cassandra/">cassandra</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/community/">community</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/discussion/">discussion</a> </span> <span class="tag tag-5"> <a href="https://debezium.io/blog/tags/docker/">docker</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/elasticsearch/">elasticsearch</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/example/">example</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/examples/">examples</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/featured/">featured</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/fedora/">fedora</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/introduction/">introduction</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/json/">json</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/kafka/">kafka</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/kafka-streams/">kafka-streams</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/kogito/">kogito</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/ksql/">ksql</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/kubernetes/">kubernetes</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/microservices/">microservices</a> </span> <span class="tag tag-4"> <a href="https://debezium.io/blog/tags/mongodb/">mongodb</a> </span> <span class="tag tag-6"> <a href="https://debezium.io/blog/tags/mysql/">mysql</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/news/">news</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/newsletter/">newsletter</a> </span> <span class="tag tag-2"> <a href="https://debezium.io/blog/tags/oracle/">oracle</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/outbox/">outbox</a> </span> <span class="tag tag-5"> <a href="https://debezium.io/blog/tags/postgres/">postgres</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/presentation/">presentation</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/quarkus/">quarkus</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/rds/">rds</a> </span> <span class="tag tag-6"> <a href="https://debezium.io/blog/tags/releases/">releases</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/secrets/">secrets</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/sentry/">sentry</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/serialization/">serialization</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/smt/">smt</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/sql/">sql</a> </span> <span class="tag tag-3"> <a href="https://debezium.io/blog/tags/sqlserver/">sqlserver</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/vagrant/">vagrant</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/website/">website</a> </span> </div> </div> </div> <div class="col-xs-12 col-sm-9" id="maincol"> <div class="post"> <div class="row" style="margin-left: 0; margin-right: 0; margin-bottom: 10px;"> <div class="col-sm-12" style="padding-left: 0px;"> <div style="display: table-cell; vertical-align: top;"> <div style="width: 72px; border: 1px solid #ccc; padding: 3px; display: inline-block;"> <img src="/images/color_debezium_64px.png" style="width: 64px;"> </div> </div> <div style="display: table-cell; vertical-align: top;"> <div style="margin-left: 8px;"> <span class="hidden-sm hidden-xs" style="font-size: 2.75rem; line-height: 1;"> <a href="/blog/2018/03/08/creating-ddd-aggregates-with-debezium-and-kafka-streams/">Creating DDD aggregates with Debezium and Kafka Streams</a> </span> <span class="hidden-md hidden-lg" style="font-size: 2rem; line-height: 1;"> <a href="/blog/2018/03/08/creating-ddd-aggregates-with-debezium-and-kafka-streams/">Creating DDD aggregates with Debezium and Kafka Streams</a> </span> <div class="byline" style="line-height: 1;"> <em> March 08, 2018 by Hans-Peter Grahsl, Gunnar Morling </em> <div class="hidden-xs" style="margin-top: 5px;"> <a class="hidden-sm hidden-xs label label-info" href="/blog/tags/discussion/">discussion</a> <a class="hidden-sm hidden-xs label label-info" href="/blog/tags/examples/">examples</a> </div> </div> </div> </div> </div> </div> <div class="row" style="margin-left: 0; margin-right: 0;"> <div id="preamble"> <div class="sectionbody"> <div class="paragraph"> <p>Microservice-based architectures can be considered an industry trend and are thus often found in enterprise applications lately. One possible way to keep data synchronized across multiple services and their backing data stores is to make us of an approach called <a href="https://vladmihalcea.com/a-beginners-guide-to-cdc-change-data-capture/">change data capture</a>, or CDC for short.</p> </div> <div class="paragraph"> <p>Essentially CDC allows to listen to any modifications which are occurring at one end of a data flow (i.e. the data source) and communicate them as change events to other interested parties or storing them into a data sink. Instead of doing this in a point-to-point fashion, it&#8217;s advisable to decouple this flow of events between data sources and data sinks. Such a scenario can be implemented based on <a href="https://debezium.io/">Debezium</a> and <a href="https://kafka.apache.org/">Apache Kafka</a> with relative ease and effectively no coding.</p> </div> <div class="paragraph"> <p>As an example, consider the following microservice-based architecture of an order management system:</p> </div> <div class="imageblock centered-image"> <div class="content"> <img src="/images/msa_streaming.png" alt="Microservice-based architecture of an order management system"> </div> </div> <div class="paragraph"> <p>This system comprises three services, <em>Order</em>, <em>Item</em> and <em>Stock</em>. If the <em>Order</em> service receives an order request, it will need information from the other two, such as item definitions or the stock count for specific items. Instead of making synchronous calls to these services to obtain this information, CDC can be used to set up change event streams for the data managed by the <em>Item</em> and <em>Stock</em> services. The <em>Order</em> service can subscribe to these event streams and keep a local copy of the relevant item and stock data in its own database. This approach helps to decouple the services (e.g. no direct impact by service outages) and can also be beneficial for overall performance, as each service can hold optimized views just of those data items owned by other services which it is interested in.</p> </div> </div> </div> <div class="sect1"> <h2 id="how_to_handle_aggregate_objects"><a class="anchor" href="#how_to_handle_aggregate_objects"></a>How to Handle Aggregate Objects?</h2> <div class="sectionbody"> <div class="paragraph"> <p>There are use cases however, where things are a bit more tricky. It is sometimes useful to share information across services and data stores by means of so-called aggregates, which are a concept/pattern defined by domain-driven design (DDD). In general, a <a href="https://martinfowler.com/bliki/DDD_Aggregate.html">DDD aggregate</a> is used to transfer state which can be comprised of multiple different domain objects that are together treated as a single unit of information.</p> </div> <div class="paragraph"> <p>Concrete examples are:</p> </div> <div class="ulist"> <ul> <li> <p><strong>customers and their addresses</strong> which are represented as a customer record <em>aggregate</em> storing a customer and a list of addresses</p> </li> <li> <p><strong>orders and corresponding line items</strong> which are represented as an order record <em>aggregate</em> storing an order and all its line items</p> </li> </ul> </div> <div class="paragraph"> <p>Chances are that the data of the involved domain objects backing these DDD aggregates are stored in separate relations of an RDBMS. When making use of the CDC capabilities currently found in Debezium, all changes to domain objects will be independently captured and by default eventually reflected in separate Kafka topics, one per RDBMS relation. While this behaviour is tremendously helpful for a lot of use cases it can be pretty limiting to others, like the DDD aggregate scenario described above. Therefore, this blog post explores how DDD aggregates can be built based on Debezium CDC events, using the <a href="https://kafka.apache.org/documentation/streams/">Kafka Streams API</a>.</p> </div> </div> </div> <div class="sect1"> <h2 id="capturing_change_events_from_a_data_source"><a class="anchor" href="#capturing_change_events_from_a_data_source"></a>Capturing Change Events from a Data Source</h2> <div class="sectionbody"> <div class="paragraph"> <p>The complete source code for this blog post is provided in the Debezium <a href="https://github.com/debezium/debezium-examples/tree/master/kstreams">examples repository</a> on GitHub. Begin by cloning this repository and changing into the <em>kstreams</em> directory:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-shell" data-lang="shell">git clone https://github.com/debezium/debezium-examples.git&#x000A;cd kstreams</code></pre> </div> </div> <div class="paragraph"> <p>The project provides a Docker Compose file with services for all the components you may already know from the <a href="/docs/tutorial/">Debezium tutorial</a>:</p> </div> <div class="ulist"> <ul> <li> <p><a href="https://zookeeper.apache.org/">Apache ZooKeeper</a></p> </li> <li> <p><a href="https://kafka.apache.org/">Apache Kafka</a></p> </li> <li> <p>A <a href="https://kafka.apache.org/documentation/#connect">Kafka Connect</a> instance with the Debezium CDC connectors</p> </li> <li> <p><a href="http://www.mysql.com/">MySQL</a> (populated with some test data)</p> </li> </ul> </div> <div class="paragraph"> <p>In addition it declares the following services:</p> </div> <div class="ulist"> <ul> <li> <p><a href="http://www.mongodb.com/">MongoDB</a> which will be used as a data sink</p> </li> <li> <p>Another Kafka Connect instance which will host the MongoDB sink connector</p> </li> <li> <p>A service for running the DDD aggregation process we&#8217;re going to build in the following</p> </li> </ul> </div> <div class="paragraph"> <p>We&#8217;ll get to those three in a bit, for now let&#8217;s prepare the source side of our pipeline:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-shell" data-lang="shell">export DEBEZIUM_VERSION=0.7&#x000A;docker-compose up mysql zookeeper kafka connect_source</code></pre> </div> </div> <div class="paragraph"> <p>Once all services have been started, register an instance of the Debezium MySQL connector by submitting the following JSON document:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-json" data-lang="json">{&#x000A;    "name": "mysql-source",&#x000A;    "config": {&#x000A;        "connector.class": "io.debezium.connector.mysql.MySqlConnector",&#x000A;        "tasks.max": "1",&#x000A;        "database.hostname": "mysql",&#x000A;        "database.port": "3306",&#x000A;        "database.user": "debezium",&#x000A;        "database.password": "dbz",&#x000A;        "database.server.id": "184054",&#x000A;        "database.server.name": "dbserver1",&#x000A;        "table.whitelist": "inventory.customers,inventory.addresses",&#x000A;        "database.history.kafka.bootstrap.servers": "kafka:9092",&#x000A;        "database.history.kafka.topic": "schema-changes.inventory",&#x000A;        "transforms": "unwrap",&#x000A;        "transforms.unwrap.type":"io.debezium.transforms.UnwrapFromEnvelope",&#x000A;        "transforms.unwrap.drop.tombstones":"false"&#x000A;    }&#x000A;}</code></pre> </div> </div> <div class="paragraph"> <p>To do so, run the following curl command:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-shell" data-lang="shell">curl -i -X POST -H "Accept:application/json" -H  "Content-Type:application/json" http://localhost:8083/connectors/ -d @mysql-source.json</code></pre> </div> </div> <div class="paragraph"> <p>This sets up the connector for the specified database, using the given credentials. For our purposes we&#8217;re only interested in changes to the <code>customers</code> and <code>addresses</code> tables, hence the <code>table.whitelist</code> property is given to just select these two tables. Another noteworthy thing is the "unwrap" transform that is applied. By default, Debezium&#8217;s CDC events would contain the old and new state of changed rows and some additional metadata on the source of the change. By applying the <a href="/docs/configuration/event-flattening/">UnwrapFromEnvelope</a> SMT (single message transformation), only the new state will be propagated into the corresponding Kafka topics.</p> </div> <div class="paragraph"> <p>We can take a look at them once the connector has been deployed and finished its initial snapshot of the two captured tables:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-shell" data-lang="shell">docker-compose exec kafka /kafka/bin/kafka-console-consumer.sh \&#x000A;    --bootstrap-server kafka:9092 \&#x000A;    --from-beginning \&#x000A;    --property print.key=true \&#x000A;    --topic dbserver1.inventory.customers # or dbserver1.inventory.addresses</code></pre> </div> </div> <div class="paragraph"> <p>E.g. you should see the following output</p> </div> <div class="paragraph"> <p>(formatted and omitting the schema information for the sake of readability) for the topic with customer changes:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-shell" data-lang="shell">{&#x000A;    "schema": { ... },&#x000A;    "payload": {&#x000A;        "id": 1001&#x000A;    }&#x000A;}&#x000A;{&#x000A;    "schema": { ... },&#x000A;    "payload": {&#x000A;        "id": 1001,&#x000A;        "first_name": "Sally",&#x000A;        "last_name": "Thomas",&#x000A;        "email": "sally.thomas@acme.com"&#x000A;    }&#x000A;}&#x000A;...</code></pre> </div> </div> </div> </div> <div class="sect1"> <h2 id="building_ddd_aggregates"><a class="anchor" href="#building_ddd_aggregates"></a>Building DDD Aggregates</h2> <div class="sectionbody"> <div class="paragraph"> <p>The KStreams application is going to process data from the two Kafka topics. These topics receive CDC events based on the customers and addresses relations found in MySQL, each of which has its corresponding Jackson-annotated POJO (Customer and Address), enriched by a field holding the CDC event type (i.e. UPSERT/DELETE).</p> </div> <div class="paragraph"> <p>Since the Kafka topic records are in Debezium JSON format with unwrapped envelopes, a special <strong>SerDe</strong> has been written in order to be able to read/write these records using their POJO or Debezium event representation respectively. While the serializer simply converts the POJOs into JSON using Jackson, the deserializer is a "hybrid" one, being able to deserialize from either Debezium CDC events or jsonified POJOs.</p> </div> <div class="paragraph"> <p>With that in place, the KStreams topology to create and maintain DDD aggregates on-the-fly can be built as follows:</p> </div> <div class="sect2"> <h3 id="customers_topic_parent"><a class="anchor" href="#customers_topic_parent"></a>Customers Topic ("parent")</h3> <div class="paragraph"> <p>All the customer records are simply read from the customer topic into a <strong>KTable</strong> which will automatically maintain the latest state per customer according to the record key (i.e. the customer&#8217;s PK)</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-java" data-lang="java">KTable&lt;DefaultId, Customer&gt; customerTable =&#x000A;        builder.table(parentTopic, Consumed.with(defaultIdSerde,customerSerde));</code></pre> </div> </div> </div> <div class="sect2"> <h3 id="addresses_topic_children"><a class="anchor" href="#addresses_topic_children"></a>Addresses Topic ("children")</h3> <div class="paragraph"> <p>For the address records the processing is a bit more involved and needs several steps. First, all the address records are read into a <strong>KStream</strong>.</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-java" data-lang="java">KStream&lt;DefaultId, Address&gt; addressStream = builder.stream(childrenTopic,&#x000A;        Consumed.with(defaultIdSerde, addressSerde));</code></pre> </div> </div> <div class="paragraph"> <p>Second, a 'pseudo' grouping of these address records is done based on their keys (the original primary key in the relation), During this step the relationships towards the corresponding customer records are maintained. This effectively allows to keep track which address record belongs to which customer record, even in the light of address record deletions. To achieve this an additional <em>LatestAddress</em> POJO is introduced which allows to store the latest known PK &lt;&#8594; FK relation in addition to the <em>Address</em> record itself.</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-java" data-lang="java">KTable&lt;DefaultId,LatestAddress&gt; tempTable = addressStream&#x000A;        .groupByKey(Serialized.with(defaultIdSerde, addressSerde))&#x000A;        .aggregate(&#x000A;                () -&gt; new LatestAddress(),&#x000A;                (DefaultId addressId, Address address, LatestAddress latest) -&gt; {&#x000A;                    latest.update(&#x000A;                        address, addressId, new DefaultId(address.getCustomer_id()));&#x000A;                    return latest;&#x000A;                },&#x000A;                Materialized.&lt;DefaultId,LatestAddress,KeyValueStore&lt;Bytes, byte[]&gt;&gt;&#x000A;                        as(childrenTopic+"_table_temp")&#x000A;                            .withKeySerde(defaultIdSerde)&#x000A;                                .withValueSerde(latestAddressSerde)&#x000A;        );</code></pre> </div> </div> <div class="paragraph"> <p>Third, the intermediate <strong>KTable</strong> is again converted to a <strong>KStream</strong>. The <em>LatestAddress</em> records are transformed to have the customer id (FK relationship) as their new key in order to group them per customer. During the grouping step, customer specific addresses are updated which can result in an address record being added or deleted. For this purpose, another POJO called <em>Addresses</em> is introduced, which holds a map of address records that gets updated accordingly. The result is a <strong>KTable</strong> holding the most recent <em>Addresses</em> per customer id.</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-java" data-lang="java">KTable&lt;DefaultId, Addresses&gt; addressTable = tempTable.toStream()&#x000A;        .map((addressId, latestAddress) -&gt;&#x000A;            new KeyValue&lt;&gt;(latestAddress.getCustomerId(),latestAddress))&#x000A;        .groupByKey(Serialized.with(defaultIdSerde,latestAddressSerde))&#x000A;        .aggregate(&#x000A;                () -&gt; new Addresses(),&#x000A;                (customerId, latestAddress, addresses) -&gt; {&#x000A;                    addresses.update(latestAddress);&#x000A;                    return addresses;&#x000A;                },&#x000A;                Materialized.&lt;DefaultId,Addresses,KeyValueStore&lt;Bytes, byte[]&gt;&gt;&#x000A;                        as(childrenTopic+"_table_aggregate")&#x000A;                            .withKeySerde(defaultIdSerde)&#x000A;                                .withValueSerde(addressesSerde)&#x000A;        );</code></pre> </div> </div> </div> <div class="sect2"> <h3 id="combining_customers_with_addresses"><a class="anchor" href="#combining_customers_with_addresses"></a>Combining Customers With Addresses</h3> <div class="paragraph"> <p>Finally, it&#8217;s easy to bring customers and addresses together by <strong>joining the customers KTable with the addresses KTable</strong> and thereby building the DDD aggregates which are represented by the <em>CustomerAddressAggregate</em> POJO. At the end, the KTable changes are written to a KStream, which in turn gets saved into a kafka topic. This allows to make use of the resulting DDD aggregates in manifold ways.</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-java" data-lang="java">KTable&lt;DefaultId,CustomerAddressAggregate&gt; dddAggregate =&#x000A;          customerTable.join(addressTable, (customer, addresses) -&gt;&#x000A;              customer.get_eventType() == EventType.DELETE ?&#x000A;                      null :&#x000A;                      new CustomerAddressAggregate(customer,addresses.getEntries())&#x000A;          );&#x000A;&#x000A;  dddAggregate.toStream().to("final_ddd_aggregates",&#x000A;                              Produced.with(defaultIdSerde,(Serde)aggregateSerde));</code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="paragraph"> <p>Records in the customers KTable might receive a CDC delete event. If so, this can be detected by checking the event type field of the customer POJO and e.g. return 'null' instead of a DDD aggregate. Such a convention can be helpful whenever consuming parties also need to act to deletions accordingly._</p> </div> </td> </tr> </table> </div> </div> </div> </div> <div class="sect1"> <h2 id="running_the_aggregation_pipeline"><a class="anchor" href="#running_the_aggregation_pipeline"></a>Running the Aggregation Pipeline</h2> <div class="sectionbody"> <div class="paragraph"> <p>Having implemented the aggregation pipeline, it&#8217;s time to give it a test run. To do so, build the <em>poc-ddd-aggregates</em> Maven project which contains the complete implementation:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-shell" data-lang="shell">mvn clean package -f poc-ddd-aggregates/pom.xml</code></pre> </div> </div> <div class="paragraph"> <p>Then run the <code>aggregator</code> service from the Compose file which takes the JAR built by this project and launches it using the <a href="https://hub.docker.com/r/fabric8/java-jboss-openjdk8-jdk/">java-jboss-openjdk8-jdk</a> base image:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-shell" data-lang="shell">docker-compose up -d aggregator</code></pre> </div> </div> <div class="paragraph"> <p>Once the aggregation pipeline is running, we can take a look at the aggregated events using the console consumer:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-shell" data-lang="shell">docker-compose exec kafka /kafka/bin/kafka-console-consumer.sh \&#x000A;    --bootstrap-server kafka:9092 \&#x000A;    --from-beginning \&#x000A;    --property print.key=true \&#x000A;    --topic final_ddd_aggregates</code></pre> </div> </div> </div> </div> <div class="sect1"> <h2 id="transferring_ddd_aggregates_to_data_sinks"><a class="anchor" href="#transferring_ddd_aggregates_to_data_sinks"></a>Transferring DDD Aggregates to Data Sinks</h2> <div class="sectionbody"> <div class="paragraph"> <p>We originally set out to build these DDD aggregates in order to transfer data and synchronize changes between a data source (MySQL tables in this case) and a convenient data sink. By definition, DDD aggregates are typically complex data structures and therefore it makes perfect sense to write them to data stores which offer flexible ways and means to query and/or index them. Talking about NoSQL databases, a document store seems the most natural choice with <a href="https://www.mongodb.com/">MongoDB</a> being the leading database for such use cases.</p> </div> <div class="paragraph"> <p>Thanks to <a href="https://kafka.apache.org/documentation/#connect">Kafka Connect</a> and numerous turn-key ready <a href="https://www.confluent.io/product/connectors/">connectors</a> it is almost effortless to get this done. Using a <a href="https://github.com/hpgrahsl/kafka-connect-mongodb">MongoDB sink connector</a> from the open-source community, it is easy to have the DDD aggregates written into MongoDB. All it needs is a proper configuration which can be posted to the <a href="https://docs.confluent.io/current/connect/restapi.html">REST API</a> of Kafka Connect in order to run the connector.</p> </div> <div class="paragraph"> <p>So let&#8217;s start MongoDb and another Kafka Connect instance for hosting the sink connector:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-shell" data-lang="shell">docker-compose up -d mongodb connect_sink</code></pre> </div> </div> <div class="paragraph"> <p>In case the DDD aggregates should get written unmodified into MongoDB, a configuration may look as simple as follows:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-json" data-lang="json">{&#x000A;    "name": "mongodb-sink",&#x000A;    "config": {&#x000A;        "connector.class": "at.grahsl.kafka.connect.mongodb.MongoDbSinkConnector",&#x000A;        "tasks.max": "1",&#x000A;        "topics": "final_ddd_aggregates",&#x000A;        "mongodb.connection.uri": "mongodb://mongodb:27017/inventory?w=1&amp;journal=true",&#x000A;        "mongodb.collection": "customers_with_addresses",&#x000A;        "mongodb.document.id.strategy": "at.grahsl.kafka.connect.mongodb.processor.id.strategy.FullKeyStrategy",&#x000A;        "mongodb.delete.on.null.values": true&#x000A;    }&#x000A;}</code></pre> </div> </div> <div class="paragraph"> <p>As with the source connector, deploy the connector using curl:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-shell" data-lang="shell">curl -i -X POST -H "Accept:application/json" -H  "Content-Type:application/json" http://localhost:8084/connectors/ -d @mongodb-sink.json</code></pre> </div> </div> <div class="paragraph"> <p>This connector will consume messages from the "final_ddd_aggregates" Kafka topic and write them as <strong>MongoDB documents</strong> into the "customers_with_addresses" collection.</p> </div> <div class="paragraph"> <p>You can take a look by firing up a Mongo shell and querying the collection&#8217;s contents:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-shell" data-lang="shell">docker-compose exec mongodb bash -c 'mongo inventory'&#x000A;&#x000A;&gt; db.customers_with_addresses.find().pretty()</code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-json" data-lang="json">{&#x000A;    "_id": {&#x000A;        "id": "1001"&#x000A;    },&#x000A;    "addresses": [&#x000A;        {&#x000A;            "zip": "76036",&#x000A;            "_eventType": "UPSERT",&#x000A;            "city": "Euless",&#x000A;            "street": "3183 Moore Avenue",&#x000A;            "id": "10",&#x000A;            "state": "Texas",&#x000A;            "customer_id": "1001",&#x000A;            "type": "SHIPPING"&#x000A;        },&#x000A;        {&#x000A;            "zip": "17116",&#x000A;            "_eventType": "UPSERT",&#x000A;            "city": "Harrisburg",&#x000A;            "street": "2389 Hidden Valley Road",&#x000A;            "id": "11",&#x000A;            "state": "Pennsylvania",&#x000A;            "customer_id": "1001",&#x000A;            "type": "BILLING"&#x000A;        }&#x000A;    ],&#x000A;    "customer": {&#x000A;        "_eventType": "UPSERT",&#x000A;        "last_name": "Thomas",&#x000A;        "id": "1001",&#x000A;        "first_name": "Sally",&#x000A;        "email": "sally.thomas@acme.com"&#x000A;    }&#x000A;}</code></pre> </div> </div> <div class="paragraph"> <p>Due to the combination of the data in a single document some parts aren&#8217;t needed or redundant. To get rid of any unwanted data (e.g. _eventType, customer_id of each address sub-document) it would also be possible to adapt the configuration in order to blacklist said fields.</p> </div> <div class="paragraph"> <p>Finally, you update some customer or address data in the MySQL source database:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-shell" data-lang="shell">docker-compose exec mysql bash -c 'mysql -u $MYSQL_USER -p$MYSQL_PASSWORD inventory'&#x000A;&#x000A;mysql&gt; update customers set first_name= "Sarah" where id = 1001;</code></pre> </div> </div> <div class="paragraph"> <p>Shortly thereafter, you should see that the corresponding aggregate document in MongoDB has been updated accordingly.</p> </div> </div> </div> <div class="sect1"> <h2 id="drawbacks_and_limitations"><a class="anchor" href="#drawbacks_and_limitations"></a>Drawbacks and Limitations</h2> <div class="sectionbody"> <div class="paragraph"> <p>While this first version for creating DDD aggregates from table-based CDC events basically works, it is very important to understand its current limitations:</p> </div> <div class="ulist"> <ul> <li> <p>not generically applicable thus needs custom code for POJOs and intermediate types</p> </li> <li> <p>cannot be scaled across multiple instances as is due to missing but necessary data repartitioning prior to processing</p> </li> <li> <p>limited to building aggregates based on a single JOIN between 1:N relationships</p> </li> <li> <p>resulting DDD aggregates are eventually consistent, meaning that it is possible for them to temporarily exhibit intermediate state before converging</p> </li> </ul> </div> <div class="paragraph"> <p>The first few can be addressed with a reasonable amount of work on the KStreams application. The last one, dealing with the eventually consistent nature of resulting DDD aggregates is much harder to correct and will require some efforts at Debezium&#8217;s own CDC mechanism.</p> </div> </div> </div> <div class="sect1"> <h2 id="outlook"><a class="anchor" href="#outlook"></a>Outlook</h2> <div class="sectionbody"> <div class="paragraph"> <p>In this post we described an approach for creating aggregated events from Debezium&#8217;s CDC events. In a follow-up blog post we may dive a bit more into the topic of how to be able to horizontally scale the DDD creation by running multiple KStreams aggregator instances. For that purpose, the data needs proper re-partitioning before running the topology. In addition, it could be interesting to look into a somewhat more generic version which only needs custom classes to the describe the two main POJOs involved.</p> </div> <div class="paragraph"> <p>We also thought about providing a ready-to-use component which would work in a generic way (based on Connect records, i.e. not tied to a specific serialization format such as JSON) and could be set up as a configurable stand-alone process running given aggregations.</p> </div> <div class="paragraph"> <p>Also on the topic of dealing with eventual consistency we got some ideas, but those will need some more exploration and investigation for sure. Stay tuned!</p> </div> <div class="paragraph"> <p>We&#8217;d love to hear about your feedback on the topic of event aggreation. If you got any ideas or thoughts on the subject, please get in touch by posting a comment below or sending a message to our <a href="https://groups.google.com/forum/#!forum/debezium">mailing list</a>.</p> </div> </div> </div> </div> </div> <div class="well"> <div class="row"> <div class="col-md-8"> <h2>Hans-Peter Grahsl</h2> <p> <span class="bio-size">Hans-Peter is a technical trainer at NETCONOMY as well as an individual consultant for Java web development and modern data architectures. Besides, he is working as an associate lecturer for software engineering. He lives in Graz, Austria.</span> </p> <p class="bio-size"> <a href="https://twitter.com/hpgrahsl"> <i class="icon-twitter"></i> </a> &nbsp; <a href="https://github.com/hpgrahsl"> <i class="icon-github"></i> </a> &nbsp; <a href="https://www.linkedin.com/in/hpgrahsl"> <i class="icon-linkedin"></i> </a> &nbsp; </p> </div> <div class="col-md-4"> <img alt="" class="img-responsive pull-right portrait" src="/images/hpgrahsl.jpg"> </div> </div> </div> <div class="well"> <div class="row"> <div class="col-md-8"> <h2>Gunnar Morling</h2> <p> <span class="bio-size">Gunnar is a software engineer at Red Hat and open-source enthusiast by heart. A long-time Hibernate core team member, he's now the project lead of Debezium. Gunnar is the spec lead for Bean Validation 2.0 (JSR 380). He’s based in Hamburg, Germany.</span> </p> <p class="bio-size"> <a href="https://twitter.com/gunnarmorling"> <i class="icon-twitter"></i> </a> &nbsp; <a href="https://github.com/gunnarmorling"> <i class="icon-github"></i> </a> &nbsp; </p> </div> <div class="col-md-4"> <img alt="" class="img-responsive pull-right portrait" src="/images/gmorling.jpg"> </div> </div> </div> <div class="comments"> <div id="disqus_thread"></div> <script type="text/javascript">
            var disqus_shortname = 'Debezium';
            var disqus_url = "https://debezium.io/blog/2018/03/08/creating-ddd-aggregates-with-debezium-and-kafka-streams/";
            var disqus_developer = null;
            var disqus_identifier = null;
            (function() {
              var dsq = document.createElement("script"); dsq.type = "text/javascript"; dsq.async = true;
              dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName("head")[0] || document.getElementsByTagName("body")[0]).appendChild(dsq);
            })();
            </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript=Debezium">comments powered by Disqus.</a></noscript> </div> </div> </div> </div> </div> <footer class="container"> <div class="row"> <div class="col-md-5 col-md-offset-1"> <h4>Debezium</h4> <p> &#169; 2020 Debezium Community <br> <br> <i class="icon-fire"></i> Mixed with <a href="http://twitter.github.com/bootstrap">Bootstrap</a>, baked by <a href="http://awestruct.org">Awestruct</a>. <br> <i class="icon-flag"></i> Website and docs licensed under <a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>. <br> <i class="icon-flag-alt"></i> Code released under <a href="http://www.apache.org/licenses/LICENSE-2.0.html">Apache License, v2.0</a>. <br> <i class="icon-file-alt"></i> <a href="https://www.redhat.com/legal/legal_statement.html" title="Terms">Terms</a> | <a href="https://www.redhat.com/legal/privacy_statement.html" title="Privacy Policy">Privacy</a> </p> </div> <div class="col-md-3"> <h4>Documentation</h4> <ul class="list-unstyled"> <li> <a href="/documentation/features" title="Features">Features</a> </li> <li> <a href="/documentation/install/stable/" title="Install">Install</a> </li> <li> <a href="/documentation/architecture/" title="Architecture">Architecture</a> </li> <li> <a href="/documentation/faq/" title="FAQ">FAQ</a> </li> <li> <a href="/community/contribute/" title="Contribute">Contribute</a> </li> </ul> </div> <div class="col-md-3"> <h4>Connect</h4> <ul class="list-unstyled"> <li> <a href="/blog" title="Blog">Blog</a> </li> <li> <a href="http://twitter.com/debezium" title="Twitter">Twitter</a> </li> <li> <a href="http://github.com/debezium" title="GitHub">GitHub</a> </li> <li> <a href="https://gitter.im/debezium/user" title="Chat">Chat</a> </li> <li> <a href="https://groups.google.com/forum/#!forum/debezium" title="Google Groups">Google Groups</a> </li> <li> <a href="http://stackoverflow.com/questions/tagged/debezium" title="StackOverflow">StackOverflow</a> </li> </ul> </div> </div> </footer> <div class="container" id="companyfooter"> <div class="redhatlogo"> <div id="logospacer"></div> <a href="https://www.redhat.com/"><img src="/images/Logo-Red_Hat-Sponsored_By-B-Standard-RGB.svg"></a> </div> </div> <span class="backToTop"> <a href="#top">back to top</a> </span> <script src="https://static.jboss.org/theme/js/libs/bootstrap-community/3.2.0.2/bootstrap-community.min.js"></script> <script type='text/javascript' language='JavaScript' src='https://www.redhat.com/j/elqNow/elqCfg.js'></script> <script type='text/javascript' language='JavaScript' src='https://www.redhat.com/j/elqNow/elqImg.js'></script> <div id="oTags"> <script type="text/javascript" src="//www.redhat.com/j/s_code.js"></script> <script type="text/javascript"><!--
  var coreUrl = encodeURI(document.URL.split("?")[0]).replace(/-/g," ");
  var urlSplit = coreUrl.toLowerCase().split(/\//);
  var urlLast = urlSplit[urlSplit.length-1];
  var pageNameString = "";
  var siteName = "";
  var minorSectionIndex = 3
  if (urlLast == "") {
      urlSplit.splice(-1,1);
  }
  if (urlLast.search(/\./) >= 0) {
      if (urlLast == "index.html") {
          urlSplit.splice(-1,1);
      }
      else {
          urlSplit[urlSplit.length-1] = urlLast.split(".").splice(0,1);
      }
  }
  siteName = urlSplit[2].split(".")[1];
  s.prop14 = s.eVar27 = siteName || "";
  s.prop15 = s.eVar28 = urlSplit[minorSectionIndex] || "";
  s.prop16 = s.eVar29 = urlSplit[minorSectionIndex+1] || "";
  pageNameString = urlSplit.splice(3).join(" | ");
  s.pageName = "jboss | community | " + siteName + " | " + pageNameString;
  s.server = "jboss";
  s.channel = "jboss | community";
  s.prop4 = s.eVar23 = encodeURI(document.URL);
  s.prop21 = s.eVar18 = coreUrl;
  s.prop2 = s.eVar22 = "en";
  s.prop3 = s.eVar19 = "us";
  //--></script> <script type="text/javascript" src="//www.redhat.com/j/rh_omni_footer.js"></script> <script language="JavaScript" type="text/javascript"><!--
  if(navigator.appVersion.indexOf('MSIE')>=0)document.write(unescape('%3C')+'\!-'+'-')
  //--></script> <noscript><a href="http://www.omniture.com" title="Web Analytics"><img src="https://smtrcs.redhat.com/b/ss/redhatcom,redhatglobal/1/H.25.4--NS/0?[AQB]&cdp=3&[AQE]" height="1" width="1" border="0" alt=""/></a></noscript> </div> <script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script> <script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-10656779-1");
pageTracker._trackPageview();
} catch(err) {}</script> <script>
 (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
 
ga('create', 'UA-76464546-1', 'auto');
ga('send', 'pageview');
ga('set', 'anonymizeIp', true);
ga('require', 'linkid', 'linkid.js');

</script> </div> </body> </html>