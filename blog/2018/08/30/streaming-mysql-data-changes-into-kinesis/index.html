<!DOCTYPE html> <html lang="en"> <head> <title>Streaming MySQL Data Changes to Amazon Kinesis · Debezium</title> <meta charset="utf-8"> <meta content="width=device-width, initial-scale=1.0" name="viewport"> <meta content="" name="description"> <meta content="" name="author"> <link href="https://static.jboss.org/theme/css/bootstrap-community/3.2.0.2/bootstrap-community.min.css" media="screen" rel="stylesheet"> <!--[if lt IE 9]><script src="https://static.jboss.org/theme/js/libs/html5/pre3.6/html5.min.js"></script><![endif]--> <link href="https://static.jboss.org/example/images/favicon.ico" rel="shortcut icon"> <link href="https://static.jboss.org/example/images/apple-touch-icon-144x144-precomposed.png" rel="apple-touch-icon-precomposed" sizes="144x144"> <link href="https://static.jboss.org/example/images/apple-touch-icon-114x114-precomposed.png" rel="apple-touch-icon-precomposed" sizes="114x114"> <link href="https://static.jboss.org/example/images/apple-touch-icon-72x72-precomposed.png" rel="apple-touch-icon-precomposed" sizes="72x72"> <link href="https://static.jboss.org/example/images/apple-touch-icon-precomposed.png" rel="apple-touch-icon-precomposed"> <link href="/stylesheets/debezium.css" rel="stylesheet" type="text/css"> <style>
  @media (min-width: 980px) {
    .banner { background-image: url(https://static.jboss.org/example/images/debezium-banner-1180px.png); height: 110px;  }
  }
  @media (max-width: 979px) {
    .banner { background-image: url(https://static.jboss.org/example/images/debezium-logo.png); background-repeat:no-repeat; background-position: center bottom; height: 60px; }
  }
  @media (max-width: 650px) {
    .banner { width: 100%; margin: 0px auto; }
  }
  @media (max-width: 450px) {
    .banner { height: 90px; }
  }
</style> <link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/styles/default.min.css" rel="stylesheet"> <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/highlight.min.js"></script> <script>
hljs.initHighlightingOnLoad();
</script> <script src="https://static.jboss.org/theme/js/libs/jquery/jquery-1.9.1.min.js"></script> <style>
  /* adjusting the vertical spacing for when a stickynav is engaged */
  .breadcrumb-fixed > .active {
    color: #8c8f91;
  }
  .breadcrumb-fixed {
    margin: 70px 0 10px;
    padding: 8px 15px;
    margin-bottom: 20px;
    list-style: none;
    background-color: #f5f5f5;
    border-radius: 4px;
  }
  
  .breadcrumb-fixed > li {
    display: inline-block;
  }
</style> </head> <body> <div id="rhbar"> <a class="jbdevlogo" href="https://www.jboss.org/projects/about"></a> <a class="rhlogo" href="https://www.redhat.com/"></a> </div> <div id=""> <ul class="visuallyhidden" id="top"> <li> <a accesskey="n" href="#nav" title="Skip to navigation">Skip to navigation</a> </li> <li> <a accesskey="c" href="#page" title="Skip to content">Skip to content</a> </li> </ul> <div class="container" id="content"> <div class="navbar navbar-inverse navbar-fix"> <div class="container-fluid"> <div class="navbar-header"> <button class="navbar-toggle collapsed" data-target="#navbar-1" data-toggle="collapse"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href="/"> <img src="/images/color_white_debezium_type_600px.svg" style="height: 32px; margin-right: 5px; margin-top: -5px;"> </a> </div> <div class="collapse navbar-collapse" id="navbar-1"> <ul class="nav navbar-nav pull-right"> <li class=""><a href="/documentation/faq/">FAQ</a></li> <li class=""><a href="/documentation/">DOCUMENTATION</a></li> <li class=""><a href="/releases/">RELEASES</a></li> <li class=""><a href="/community/">COMMUNITY</a></li> <li class="active"><a href="/blog/">BLOG</a></li> </ul> </div> </div> </div> <div id="equalHeightsLayout"> <div class="row post-text-padding row-no-expand"> <div class="hidden-xs col-sm-3 no-right-padding" id="leftdocnav" style="padding-left: 15px; padding-right: 15px;"> <div class="doc-pills"> <ul class="nav nav-pills nav-stacked"> <li class="item"> <a href="/blog">Home</a> <div class="icon"> <span class="icon-home"></span> </div> </li> <li class="item"> <a href="/blog.atom">Feed</a> <div class="icon"> <span class="icon-rss"></span> </div> </li> </ul> </div> <p></p> <div class="featured-posts"> <div id="featured" style="margin-bottom: 4px; border-bottom: 1px solid #ccc; font-size: 115%; margin-left: 2px;"> Featured Posts </div> <ul style="padding-inline-start: 22px;"> <li style="margin-bottom: 3px;"> <a href="/blog/2019/10/22/audit-logs-with-kogito/" style="font-size: 95%;"> Admin Service for Audit Logs with Kogito </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2019/10/01/audit-logs-with-change-data-capture-and-stream-processing/" style="font-size: 95%;"> Building Audit Logs with Change Data Capture and Stream Processing </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2019/07/12/streaming-cassandra-at-wepay-part-1/" style="font-size: 95%;"> Streaming Cassandra at WePay - Part 1 </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2019/02/19/reliable-microservices-data-exchange-with-the-outbox-pattern/" style="font-size: 95%;"> Reliable Microservices Data Exchange With the Outbox Pattern </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/12/05/automating-cache-invalidation-with-change-data-capture/" style="font-size: 95%;"> Automating Cache Invalidation With Change Data Capture </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/09/20/materializing-aggregate-views-with-hibernate-and-debezium/" style="font-size: 95%;"> Materializing Aggregate Views With Hibernate and Debezium </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/07/19/advantages-of-log-based-change-data-capture/" style="font-size: 95%;"> Five Advantages of Log-Based Change Data Capture </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/03/08/creating-ddd-aggregates-with-debezium-and-kafka-streams/" style="font-size: 95%;"> Creating DDD aggregates with Debezium and Kafka Streams </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/01/17/streaming-to-elasticsearch/" style="font-size: 95%;"> Streaming Data Changes from Your Database to Elasticsearch </a> </li> </ul> </div> <p></p> <div class="cloud-tags"> <div id="tags" style="margin-bottom: 4px; border-bottom: 1px solid #ccc; font-size: 115%; margin-left: 2px;"> Tags </div> <div class="tag-cloud"> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/apache-kafka/">apache-kafka</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/avro/">avro</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/aws/">aws</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/camel/">camel</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/cassandra/">cassandra</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/community/">community</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/cqrs/">cqrs</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/db2/">db2</a> </span> <span class="tag tag-2"> <a href="https://debezium.io/blog/tags/discussion/">discussion</a> </span> <span class="tag tag-5"> <a href="https://debezium.io/blog/tags/docker/">docker</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/elasticsearch/">elasticsearch</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/event-sourcing/">event-sourcing</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/example/">example</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/examples/">examples</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/featured/">featured</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/fedora/">fedora</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/integration/">integration</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/introduction/">introduction</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/json/">json</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/kafka/">kafka</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/kafka-streams/">kafka-streams</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/kogito/">kogito</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/ksql/">ksql</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/kubernetes/">kubernetes</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/microservices/">microservices</a> </span> <span class="tag tag-4"> <a href="https://debezium.io/blog/tags/mongodb/">mongodb</a> </span> <span class="tag tag-6"> <a href="https://debezium.io/blog/tags/mysql/">mysql</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/news/">news</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/newsletter/">newsletter</a> </span> <span class="tag tag-2"> <a href="https://debezium.io/blog/tags/oracle/">oracle</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/outbox/">outbox</a> </span> <span class="tag tag-5"> <a href="https://debezium.io/blog/tags/postgres/">postgres</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/presentation/">presentation</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/quarkus/">quarkus</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/rds/">rds</a> </span> <span class="tag tag-6"> <a href="https://debezium.io/blog/tags/releases/">releases</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/secrets/">secrets</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/sentry/">sentry</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/serialization/">serialization</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/smt/">smt</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/sql/">sql</a> </span> <span class="tag tag-3"> <a href="https://debezium.io/blog/tags/sqlserver/">sqlserver</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/vagrant/">vagrant</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/website/">website</a> </span> </div> </div> </div> <div class="col-xs-12 col-sm-9" id="maincol"> <div class="post"> <div class="row" style="margin-left: 0; margin-right: 0; margin-bottom: 10px;"> <div class="col-sm-12" style="padding-left: 0px;"> <div style="display: table-cell; vertical-align: top;"> <div style="width: 72px; border: 1px solid #ccc; padding: 3px; display: inline-block;"> <img src="/images/gmorling.jpg" style="width: 64px;"> </div> </div> <div style="display: table-cell; vertical-align: top;"> <div style="margin-left: 8px;"> <span class="hidden-sm hidden-xs" style="font-size: 2.75rem; line-height: 1;"> <a href="/blog/2018/08/30/streaming-mysql-data-changes-into-kinesis/">Streaming MySQL Data Changes to Amazon Kinesis</a> </span> <span class="hidden-md hidden-lg" style="font-size: 2rem; line-height: 1;"> <a href="/blog/2018/08/30/streaming-mysql-data-changes-into-kinesis/">Streaming MySQL Data Changes to Amazon Kinesis</a> </span> <div class="byline" style="line-height: 1;"> <em> August 30, 2018 by Gunnar Morling </em> <div class="hidden-xs" style="margin-top: 5px;"> <a class="hidden-sm hidden-xs label label-info" href="/blog/tags/discussion/">discussion</a> <a class="hidden-sm hidden-xs label label-info" href="/blog/tags/examples/">examples</a> </div> </div> </div> </div> </div> </div> <div class="row" style="margin-left: 0; margin-right: 0;"> <div id="preamble"> <div class="sectionbody"> <div class="paragraph"> <p>Most of the times Debezium is used to stream data changes into <a href="http://kafka.apache.org/">Apache Kafka</a>. What though if you&#8217;re using another streaming platform such as <a href="https://pulsar.incubator.apache.org/">Apache Pulsar</a> or a cloud-based solution such as <a href="https://aws.amazon.com/kinesis/">Amazon Kinesis</a>, <a href="https://azure.microsoft.com/services/event-hubs/">Azure Event Hubs</a> and the like? Can you still benefit from Debezium&#8217;s powerful change data capture (CDC) capabilities and ingest changes from databases such as MySQL, Postgres, SQL Server etc.?</p> </div> <div class="paragraph"> <p>Turns out, with just a bit of glue code, you can! In the following we&#8217;ll discuss how to use Debezium to capture changes in a MySQL database and stream the change events into Kinesis, a fully-managed data streaming service available on the Amazon cloud.</p> </div> </div> </div> <div class="sect1"> <h2 id="introducing_the_debezium_embedded_engine"><a class="anchor" href="#introducing_the_debezium_embedded_engine"></a>Introducing the Debezium Embedded Engine</h2> <div class="sectionbody"> <div class="paragraph"> <p>Debezium is implemented as a set of connectors for Kafka and thus usually is run via <a href="https://kafka.apache.org/documentation/#connect">Kafka Connect</a>. But there&#8217;s one little gem in Debezium which isn&#8217;t as widely known yet, which is the <a href="/docs/embedded/">embedded engine</a>.</p> </div> <div class="paragraph"> <p>When using this engine, the Debezium connectors are not executed within Kafka Connect, but as a library embedded into your own Java application. For this purpose, the <em>debezium-embedded</em> module provides a small runtime environment which performs the tasks that&#8217;d otherwise be handled by the Kafka Connect framework: requesting change records from the connector, committing offsets etc. Each change record produced by the connector is passed to a configured event handler method, which in our case will convert the record into its JSON representation and submit it to a Kinesis stream, using the Kinesis Java API.</p> </div> <div class="paragraph"> <p>The overall architecture looks like so:</p> </div> <div class="exampleblock centered-image"> <div class="content"> <img src="/images/debezium-embedded.png" class="responsive-image" alt="Debezium Embedded Engine Streaming to Amazon Kinesis"> </div> </div> <div class="paragraph"> <p>Now let&#8217;s walk through the relevant parts of the code required for that. A complete executable example can be found in the <a href="https://github.com/debezium/debezium-examples/tree/master/kinesis">debezium-examples</a> repo on GitHub.</p> </div> </div> </div> <div class="sect1"> <h2 id="set_up"><a class="anchor" href="#set_up"></a>Set-Up</h2> <div class="sectionbody"> <div class="paragraph"> <p>In order to use Debezium&#8217;s embedded engine, add the <em>debezium-embedded</em> dependency as well as the Debezium connector of your choice to your project&#8217;s <em>pom.xml</em>. In the following we&#8217;re going to use the connector for MySQL. We also need to add a dependency to the <a href="https://docs.aws.amazon.com/AWSJavaSDK/latest/javadoc/com/amazonaws/services/kinesis/package-summary.html">Kinesis Client API</a>, so these are the dependencies needed:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-xml" data-lang="xml">...&#x000A;&lt;dependency&gt;&#x000A;    &lt;groupId&gt;io.debezium&lt;/groupId&gt;&#x000A;    &lt;artifactId&gt;debezium-embedded&lt;/artifactId&gt;&#x000A;    &lt;version&gt;0.8.3.Final&lt;/version&gt;&#x000A;&lt;/dependency&gt;&#x000A;&lt;dependency&gt;&#x000A;    &lt;groupId&gt;io.debezium&lt;/groupId&gt;&#x000A;    &lt;artifactId&gt;debezium-connector-mysql&lt;/artifactId&gt;&#x000A;    &lt;version&gt;0.8.3.Final&lt;/version&gt;&#x000A;&lt;/dependency&gt;&#x000A;&lt;dependency&gt;&#x000A;    &lt;groupId&gt;com.amazonaws&lt;/groupId&gt;&#x000A;    &lt;artifactId&gt;amazon-kinesis-client&lt;/artifactId&gt;&#x000A;    &lt;version&gt;1.9.0&lt;/version&gt;&#x000A;&lt;/dependency&gt;&#x000A;...</code></pre> </div> </div> </div> </div> <div class="sect1"> <h2 id="configuring_the_embedded_engine"><a class="anchor" href="#configuring_the_embedded_engine"></a>Configuring the Embedded Engine</h2> <div class="sectionbody"> <div class="paragraph"> <p>The Debezium embedded engine is configured through an instance of <code>io.debezium.config.Configuration</code>. This class can obtain values from system properties or from a given config file, but for the sake of the example we&#8217;ll simply pass all required values via its fluent builder API:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-java" data-lang="java">Configuration config = Configuration.create()&#x000A;    .with(EmbeddedEngine.CONNECTOR_CLASS, "io.debezium.connector.mysql.MySqlConnector")&#x000A;    .with(EmbeddedEngine.ENGINE_NAME, "kinesis")&#x000A;    .with(MySqlConnectorConfig.SERVER_NAME, "kinesis")&#x000A;    .with(MySqlConnectorConfig.SERVER_ID, 8192)&#x000A;    .with(MySqlConnectorConfig.HOSTNAME, "localhost")&#x000A;    .with(MySqlConnectorConfig.PORT, 3306)&#x000A;    .with(MySqlConnectorConfig.USER, "debezium")&#x000A;    .with(MySqlConnectorConfig.PASSWORD, "dbz")&#x000A;    .with(MySqlConnectorConfig.DATABASE_WHITELIST, "inventory")&#x000A;    .with(MySqlConnectorConfig.TABLE_WHITELIST, "inventory.customers")&#x000A;    .with(EmbeddedEngine.OFFSET_STORAGE,&#x000A;        "org.apache.kafka.connect.storage.MemoryOffsetBackingStore")&#x000A;    .with(MySqlConnectorConfig.DATABASE_HISTORY,&#x000A;        MemoryDatabaseHistory.class.getName())&#x000A;    .with("schemas.enable", false)&#x000A;    .build();</code></pre> </div> </div> <div class="paragraph"> <p>If you&#8217;ve ever set up the Debezium MySQL connector in Kafka Connect, most of the properties will look familiar to you.</p> </div> <div class="paragraph"> <p>But let&#8217;s talk about the <code>OFFSET_STORAGE</code> and <code>DATABASE_HISTORY</code> options in a bit more detail. They deal with how connector offsets and the database history should be persisted. When running the connector via Kafka Connect, both would typically be stored in specific Kafka topics. But that&#8217;s not an option here, so an alternative is needed. For this example we&#8217;re simply going to keep the offsets and database history in memory. I.e. if the engine is restarted, this information will be lost and the connector will start from scratch, e.g. with a new initial snapshot.</p> </div> <div class="paragraph"> <p>While out of scope for this blog post, it wouldn&#8217;t be too difficult to create alternative implementations of the <code>OffsetBackingStore</code> and <code>DatabaseHistory</code> contracts, respectively. For instance if you&#8217;re fully committed into the AWS cloud services, you could think of storing offsets and database history in the DynamoDB NoSQL store. Note that, different from Kafka, a Kinesis stream wouldn&#8217;t be suitable for storing the database history. The reason being, that the maximum retention period for Kinesis data streams is seven days, whereas the database history must be kept for the entire lifetime of the connector. Another alternative could be to use the existing filesystem based implementations <code>FileOffsetBackingStore</code> and <code>FileDatabaseHistory</code>, respectively.</p> </div> <div class="paragraph"> <p>The next step is to build an <code>EmbeddedEngine</code> instance from the configuration. Again this is done using a fluent API:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-java" data-lang="java">EmbeddedEngine engine = EmbeddedEngine.create()&#x000A;    .using(config)&#x000A;    .using(this.getClass().getClassLoader())&#x000A;    .using(Clock.SYSTEM)&#x000A;    .notifying(this::sendRecord)&#x000A;    .build();</code></pre> </div> </div> <div class="paragraph"> <p>The most interesting part here is the <code>notifying</code> call. The method passed here is the one which will be invoked by the engine for each emitted data change record. So let&#8217;s take a look at the implementation of this method.</p> </div> </div> </div> <div class="sect1"> <h2 id="sending_change_records_to_kinesis"><a class="anchor" href="#sending_change_records_to_kinesis"></a>Sending Change Records to Kinesis</h2> <div class="sectionbody"> <div class="paragraph"> <p>The <code>sendRecord()</code> method is where the magic happens. We&#8217;ll convert the incoming <code>SourceRecord</code> into an equivalent JSON representation and propagate it to a Kinesis stream.</p> </div> <div class="paragraph"> <p>For that, it&#8217;s important to understand some conceptual differences between Apache Kafka and Kinesis. Specifically, messages in Kafka have a <em>key</em> and a <em>value</em> (which both are arbitrary byte arrays). In case of Debezium, the key of data change events represents the primary key of the affected record and the value is a structure comprising of old and new row state as well as some additional metadata.</p> </div> <div class="paragraph"> <p>In Kinesis on the other hand a message contains a <em>data blob</em> (again an arbitrary byte sequence) and a <em>partition key</em>. Kinesis streams can be split up into multiple shards and the partition key is used to determine into which shard a given message should go.</p> </div> <div class="paragraph"> <p>Now one could think of mapping the key from Debezium&#8217;s change data events to the Kinesis partition key, but partition keys are limited to a length of 256 bytes. Depending on the length of primary key column(s) in the captured tables, this might not be enough. So a safer option is to create a hash value from the change message key and use that as the partition key. This in turn means that the change message key structure should be added next to the actual value to the Kinesis message&#8217;s data blob. While the key column values themselves are part of the value structure, too, a consumer otherwise wouldn&#8217;t know which column(s) make up the primary key.</p> </div> <div class="paragraph"> <p>With that in mind, let&#8217;s take a look at the <code>sendRecord()</code> implementation:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-java" data-lang="java">private void sendRecord(SourceRecord record) {&#x000A;    // We are interested only in data events not schema change events&#x000A;    if (record.topic().equals("kinesis")) {&#x000A;        return;&#x000A;    }&#x000A;&#x000A;    // create schema for container with key *and* value&#x000A;    Schema schema = SchemaBuilder.struct()&#x000A;        .field("key", record.keySchema())&#x000A;        .field("value", record.valueSchema())&#x000A;        .build();&#x000A;&#x000A;    Struct message = new Struct(schema);&#x000A;    message.put("key", record.key());&#x000A;    message.put("value", record.value());&#x000A;&#x000A;    // create partition key by hashing the record's key&#x000A;    String partitionKey = String.valueOf(&#x000A;        record.key() != null ? record.key().hashCode() : -1);&#x000A;&#x000A;    // create data blob representing the container by using Kafka Connect's&#x000A;    // JSON converter&#x000A;    final byte[] payload = valueConverter.fromConnectData(&#x000A;        "dummy", schema, message);&#x000A;&#x000A;    // Assemble the put-record request ...&#x000A;    PutRecordRequest putRecord = new PutRecordRequest();&#x000A;&#x000A;    putRecord.setStreamName(record.topic());&#x000A;    putRecord.setPartitionKey(partitionKey);&#x000A;    putRecord.setData(ByteBuffer.wrap(payload));&#x000A;&#x000A;    // ... and execute it&#x000A;    kinesisClient.putRecord(putRecord);&#x000A;}</code></pre> </div> </div> <div class="paragraph"> <p>The code is quite straight-forward; as discussed above it&#8217;s first creating a container structure containing key <em>and</em> value of the incoming source record. This structure then is converted into a binary representation using the JSON converter provided by Kafka Connect (an instance of <code>JsonConverter</code>). Then a <code>PutRecordRequest</code> is assembled from that blob, the partition key and the change record&#8217;s topic name, which finally is sent to Kinesis.</p> </div> <div class="paragraph"> <p>The Kinesis client object can be re-used and is set up once like so:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-java" data-lang="java">// Uses the credentials from the local "default" AWS profile&#x000A;AWSCredentialsProvider credentialsProvider =&#x000A;    new ProfileCredentialsProvider("default");&#x000A;&#x000A;this.kinesisClient = AmazonKinesisClientBuilder.standard()&#x000A;    .withCredentials(credentialsProvider)&#x000A;    .withRegion("eu-central-1") // use your AWS region here&#x000A;    .build();</code></pre> </div> </div> <div class="paragraph"> <p>With that, we&#8217;ve set up an instance of Debezium&#8217;s <code>EmbeddedEngine</code> which runs the configured MySQL connector and passes each emitted change event to Amazon Kinesis. The last missing step is to actually run the engine. This is done on a separate thread using an <code>Executor</code>, e.g. like so:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-java" data-lang="java">ExecutorService executor = Executors.newSingleThreadExecutor();&#x000A;executor.execute(engine);</code></pre> </div> </div> <div class="paragraph"> <p>Note you also should make sure to properly shut down the engine eventually. How that can be done <a href="https://github.com/debezium/debezium-examples/blob/master/kinesis/src/main/java/io/debezium/examples/kinesis/ChangeDataSender.java#L83-L88">is shown</a> in the accompanying example in the <em>debezium-examples</em> repo.</p> </div> </div> </div> <div class="sect1"> <h2 id="running_the_example"><a class="anchor" href="#running_the_example"></a>Running the Example</h2> <div class="sectionbody"> <div class="paragraph"> <p>Finally let&#8217;s take a look at running the complete example and consuming the Debezium CDC events from the Kinesis stream. Start by cloning the examples repository and go to the <em>kinesis</em> directory:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-shell" data-lang="shell">git clone https://github.com/debezium/debezium-examples.git&#x000A;cd debezium-examples/kinesis</code></pre> </div> </div> <div class="paragraph"> <p>Make sure you&#8217;ve met the <a href="https://github.com/debezium/debezium-examples/tree/master/kinesis#prerequisites">prerequisites</a> described in the example&#8217;s <em>README.md</em>; most notably you should have a local Docker installation and you&#8217;ll need to have set up an AWS account as well as have the AWS client tools installed. Note that Kinesis isn&#8217;t part of the free tier when registering with AWS, i.e. you&#8217;ll pay a (small) amount of money when executing the example. Don&#8217;t forget to delete the streams you&#8217;ve set up once done, we won&#8217;t pay your AWS bills :)</p> </div> <div class="paragraph"> <p>Now run Debezium&#8217;s MySQL example database to have some data to play with:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-shell" data-lang="shell">docker run -it --rm --name mysql -p 3306:3306 \&#x000A;  -e MYSQL_ROOT_PASSWORD=debezium \&#x000A;  -e MYSQL_USER=mysqluser \&#x000A;  -e MYSQL_PASSWORD=mysqlpw \&#x000A;  debezium/example-mysql:0.8</code></pre> </div> </div> <div class="paragraph"> <p>Create a Kinesis stream for change events from the <code>customers</code> table:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-shell" data-lang="shell">aws kinesis create-stream --stream-name kinesis.inventory.customers \&#x000A;  --shard-count 1</code></pre> </div> </div> <div class="paragraph"> <p>Execute the Java application that runs the Debezium embedded engine (if needed, adjust the value of the <code>kinesis.region</code> property in <em>pom.xml</em> to your own region first):</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-shell" data-lang="shell">mvn exec:java</code></pre> </div> </div> <div class="paragraph"> <p>This will start up the engine and the MySQL connector, which takes an initial snapshot of the captured database.</p> </div> <div class="paragraph"> <p>In order to take a look at the CDC events in the Kinesis stream, the AWS CLI can be used (usually, you&#8217;d implement a Kinesis Streams application for consuming the events). To do so, set up a <a href="https://docs.aws.amazon.com/streams/latest/dev/developing-consumers-with-sdk.html#kinesis-using-sdk-java-get-data-shard-iterators">shard iterator</a> first:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-shell" data-lang="shell">ITERATOR=$(aws kinesis get-shard-iterator --stream-name kinesis.inventory.customers --shard-id 0 --shard-iterator-type TRIM_HORIZON | jq '.ShardIterator')</code></pre> </div> </div> <div class="paragraph"> <p>Note how the <a href="https://stedolan.github.io/jq/">jq</a> utility is used to obtain the generated id of the iterator from the JSON structure returned by the Kinesis API. Next that iterator can be used to examine the stream:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-shell" data-lang="shell">aws kinesis get-records --shard-iterator $ITERATOR</code></pre> </div> </div> <div class="paragraph"> <p>You should receive an array of records like this:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-json" data-lang="json">{&#x000A;    "Records": [&#x000A;        {&#x000A;            "SequenceNumber":&#x000A;                "49587760482547027816046765529422807492446419903410339842",&#x000A;            "ApproximateArrivalTimestamp": 1535551896.475,&#x000A;            "Data": "eyJiZWZvcm...4OTI3MzN9",&#x000A;            "PartitionKey": "eyJpZCI6MTAwMX0="&#x000A;        },&#x000A;        ...&#x000A;    ]&#x000A;}</code></pre> </div> </div> <div class="paragraph"> <p>The <code>Data</code> element is a Base64-encoded representation of the message&#8217;s data blob. Again <em>jq</em> comes in handy: we can use it to just extract the <code>Data</code> part of each record and decode the Base64 representation (make sure to use jq 1.6 or newer):</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-shell" data-lang="shell">aws kinesis get-records --shard-iterator $ITERATOR | \&#x000A;  jq -r '.Records[].Data | @base64d' | jq .</code></pre> </div> </div> <div class="paragraph"> <p>Now you should see the change events as JSON, each one with key and value:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-json" data-lang="json">{&#x000A;  "key": {&#x000A;    "id": 1001&#x000A;  },&#x000A;  "value": {&#x000A;    "before": null,&#x000A;    "after": {&#x000A;      "id": 1001,&#x000A;      "first_name": "Sally",&#x000A;      "last_name": "Thomas",&#x000A;      "email": "sally.thomas@acme.com"&#x000A;    },&#x000A;    "source": {&#x000A;      "version": "0.8.1.Final",&#x000A;      "name": "kinesis",&#x000A;      "server_id": 0,&#x000A;      "ts_sec": 0,&#x000A;      "gtid": null,&#x000A;      "file": "mysql-bin.000003",&#x000A;      "pos": 154,&#x000A;      "row": 0,&#x000A;      "snapshot": true,&#x000A;      "thread": null,&#x000A;      "db": "inventory",&#x000A;      "table": "customers",&#x000A;      "query": null&#x000A;    },&#x000A;    "op": "c",&#x000A;    "ts_ms": 1535555325628&#x000A;  }&#x000A;}&#x000A;...</code></pre> </div> </div> <div class="paragraph"> <p>Next let&#8217;s try and update a record in MySQL:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-shell" data-lang="shell"># Start MySQL CLI client&#x000A;docker run -it --rm --name mysqlterm --link mysql --rm mysql:5.7 \&#x000A;  sh -c 'exec mysql -h"$MYSQL_PORT_3306_TCP_ADDR" \&#x000A;  -P"$MYSQL_PORT_3306_TCP_PORT" -uroot -p"$MYSQL_ENV_MYSQL_ROOT_PASSWORD"'&#x000A;&#x000A;# In the MySQL client&#x000A;use inventory;&#x000A;update customers set first_name = 'Trudy' where id = 1001;</code></pre> </div> </div> <div class="paragraph"> <p>If you now fetch the iterator again, you should see one more data change event representing that update:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-json" data-lang="json">...&#x000A;&#x000A;{&#x000A;  "key": {&#x000A;    "id": 1001&#x000A;  },&#x000A;  "value": {&#x000A;    "before": {&#x000A;      "id": 1001,&#x000A;      "first_name": "Sally",&#x000A;      "last_name": "Thomas",&#x000A;      "email": "sally.thomas@acme.com"&#x000A;    },&#x000A;    "after": {&#x000A;      "id": 1001,&#x000A;      "first_name": "Trudy",&#x000A;      "last_name": "Thomas",&#x000A;      "email": "sally.thomas@acme.com"&#x000A;    },&#x000A;    "source": {&#x000A;      "version": "0.8.1.Final",&#x000A;      "name": "kinesis",&#x000A;      "server_id": 223344,&#x000A;      "ts_sec": 1535627629,&#x000A;      "gtid": null,&#x000A;      "file": "mysql-bin.000003",&#x000A;      "pos": 364,&#x000A;      "row": 0,&#x000A;      "snapshot": false,&#x000A;      "thread": 10,&#x000A;      "db": "inventory",&#x000A;      "table": "customers",&#x000A;      "query": null&#x000A;    },&#x000A;    "op": "u",&#x000A;    "ts_ms": 1535627622546&#x000A;  }&#x000A;}</code></pre> </div> </div> <div class="paragraph"> <p>Once you&#8217;re done, stop the embedded engine application by hitting Ctrl + C, stop the MySQL server by running <code>docker stop mysql</code> and delete the <em>kinesis.inventory.customers</em> stream in Kinesis.</p> </div> </div> </div> <div class="sect1"> <h2 id="summary_and_outlook"><a class="anchor" href="#summary_and_outlook"></a>Summary and Outlook</h2> <div class="sectionbody"> <div class="paragraph"> <p>In this blog post we&#8217;ve demonstrated that Debezium cannot only be used to stream data changes into Apache Kafka, but also into other streaming platforms such as Amazon Kinesis. Leveraging its embedded engine and by implementing a bit of glue code, you can benefit from <a href="/docs/connectors/">all the CDC connectors</a> provided by Debezium and their capabilities and connect them to the streaming solution of your choice.</p> </div> <div class="paragraph"> <p>And we&#8217;re thinking about even further simplifying this usage of Debezium. Instead of requiring you to implement your own application that invokes the embedded engine API, we&#8217;re considering to provide a small self-contained Debezium runtime which you can simply execute. It&#8217;d be configured with the source connector to run and make use of an outbound plug-in SPI with ready-to-use implementations for Kinesis, Apache Pulsar and others. Of course such runtime would also provide suitable implementations for safely persisting offsets and database history, and it&#8217;d offer means of monitoring, health checks etc. Meaning you could connect the Debezium source connectors with your preferred streaming platform in a robust and reliable way, without any manual coding required!</p> </div> <div class="paragraph"> <p>If you like this idea, then please check out JIRA issue <a href="https://issues.redhat.com/browse/DBZ-651">DBZ-651</a> and let us know about your thoughts, e.g. by leaving a comment on the issue, in the comment section below or on our <a href="https://groups.google.com/forum/#!forum/debezium">mailing list</a>.</p> </div> </div> </div> <div class="sect1"> <h2 id="about_debezium"><a class="anchor" href="#about_debezium"></a>About Debezium</h2> <div class="sectionbody"> <div class="paragraph"> <p>Debezium is an open source distributed platform that turns your existing databases into event streams, so applications can see and respond almost instantly to each committed row-level change in the databases. Debezium is built on top of <a href="http://kafka.apache.org/">Kafka</a> and provides <a href="http://kafka.apache.org/documentation.html#connect">Kafka Connect</a> compatible connectors that monitor specific database management systems. Debezium records the history of data changes in Kafka logs, so your application can be stopped and restarted at any time and can easily consume all of the events it missed while it was not running, ensuring that all events are processed correctly and completely. Debezium is <a href="/license/">open source</a> under the <a href="http://www.apache.org/licenses/LICENSE-2.0.html">Apache License, Version 2.0</a>.</p> </div> </div> </div> <div class="sect1"> <h2 id="get_involved"><a class="anchor" href="#get_involved"></a>Get involved</h2> <div class="sectionbody"> <div class="paragraph"> <p>We hope you find Debezium interesting and useful, and want to give it a try. Follow us on Twitter <a href="https://twitter.com/debezium">@debezium</a>, <a href="https://gitter.im/debezium/user">chat with us on Gitter</a>, or join our <a href="https://groups.google.com/forum/#!forum/debezium">mailing list</a> to talk with the community. All of the code is open source <a href="https://github.com/debezium/">on GitHub</a>, so build the code locally and help us improve ours existing connectors and add even more connectors. If you find problems or have ideas how we can improve Debezium, please let us know or <a href="https://issues.redhat.com/projects/DBZ/issues/">log an issue</a>.</p> </div> </div> </div> </div> </div> <div class="well"> <div class="row"> <div class="col-md-8"> <h2>Gunnar Morling</h2> <p> <span class="bio-size">Gunnar is a software engineer at Red Hat and open-source enthusiast by heart. A long-time Hibernate core team member, he's now the project lead of Debezium. Gunnar is the spec lead for Bean Validation 2.0 (JSR 380). He’s based in Hamburg, Germany.</span> </p> <p class="bio-size"> <a href="https://twitter.com/gunnarmorling"> <i class="icon-twitter"></i> </a> &nbsp; <a href="https://github.com/gunnarmorling"> <i class="icon-github"></i> </a> &nbsp; </p> </div> <div class="col-md-4"> <img alt="" class="img-responsive pull-right portrait" src="/images/gmorling.jpg"> </div> </div> </div> <div class="comments"> <div id="disqus_thread"></div> <script type="text/javascript">
            var disqus_shortname = 'Debezium';
            var disqus_url = "https://debezium.io/blog/2018/08/30/streaming-mysql-data-changes-into-kinesis/";
            var disqus_developer = null;
            var disqus_identifier = null;
            (function() {
              var dsq = document.createElement("script"); dsq.type = "text/javascript"; dsq.async = true;
              dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName("head")[0] || document.getElementsByTagName("body")[0]).appendChild(dsq);
            })();
            </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript=Debezium">comments powered by Disqus.</a></noscript> </div> </div> </div> </div> </div> <footer class="container"> <div class="row"> <div class="col-md-5 col-md-offset-1"> <h4>Debezium</h4> <p> &#169; 2020 Debezium Community <br> <br> <i class="icon-fire"></i> Mixed with <a href="http://twitter.github.com/bootstrap">Bootstrap</a>, baked by <a href="http://awestruct.org">Awestruct</a>. <br> <i class="icon-flag"></i> Website and docs licensed under <a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>. <br> <i class="icon-flag-alt"></i> Code released under <a href="http://www.apache.org/licenses/LICENSE-2.0.html">Apache License, v2.0</a>. <br> <i class="icon-file-alt"></i> <a href="https://www.redhat.com/legal/legal_statement.html" title="Terms">Terms</a> | <a href="https://www.redhat.com/legal/privacy_statement.html" title="Privacy Policy">Privacy</a> </p> </div> <div class="col-md-3"> <h4>Documentation</h4> <ul class="list-unstyled"> <li> <a href="/documentation/features" title="Features">Features</a> </li> <li> <a href="/documentation/install/stable/" title="Install">Install</a> </li> <li> <a href="/documentation/architecture/" title="Architecture">Architecture</a> </li> <li> <a href="/documentation/faq/" title="FAQ">FAQ</a> </li> <li> <a href="/community/contribute/" title="Contribute">Contribute</a> </li> </ul> </div> <div class="col-md-3"> <h4>Connect</h4> <ul class="list-unstyled"> <li> <a href="/blog" title="Blog">Blog</a> </li> <li> <a href="http://twitter.com/debezium" title="Twitter">Twitter</a> </li> <li> <a href="http://github.com/debezium" title="GitHub">GitHub</a> </li> <li> <a href="https://gitter.im/debezium/user" title="Chat">Chat</a> </li> <li> <a href="https://groups.google.com/forum/#!forum/debezium" title="Google Groups">Google Groups</a> </li> <li> <a href="http://stackoverflow.com/questions/tagged/debezium" title="StackOverflow">StackOverflow</a> </li> </ul> </div> </div> </footer> <div class="container" id="companyfooter"> <div class="redhatlogo"> <div id="logospacer"></div> <a href="https://www.redhat.com/"><img src="/images/Logo-Red_Hat-Sponsored_By-B-Standard-RGB.svg"></a> </div> </div> <span class="backToTop"> <a href="#top">back to top</a> </span> <script src="https://static.jboss.org/theme/js/libs/bootstrap-community/3.2.0.2/bootstrap-community.min.js"></script> <script type='text/javascript' language='JavaScript' src='https://www.redhat.com/j/elqNow/elqCfg.js'></script> <script type='text/javascript' language='JavaScript' src='https://www.redhat.com/j/elqNow/elqImg.js'></script> <div id="oTags"> <script type="text/javascript" src="//www.redhat.com/j/s_code.js"></script> <script type="text/javascript"><!--
  var coreUrl = encodeURI(document.URL.split("?")[0]).replace(/-/g," ");
  var urlSplit = coreUrl.toLowerCase().split(/\//);
  var urlLast = urlSplit[urlSplit.length-1];
  var pageNameString = "";
  var siteName = "";
  var minorSectionIndex = 3
  if (urlLast == "") {
      urlSplit.splice(-1,1);
  }
  if (urlLast.search(/\./) >= 0) {
      if (urlLast == "index.html") {
          urlSplit.splice(-1,1);
      }
      else {
          urlSplit[urlSplit.length-1] = urlLast.split(".").splice(0,1);
      }
  }
  siteName = urlSplit[2].split(".")[1];
  s.prop14 = s.eVar27 = siteName || "";
  s.prop15 = s.eVar28 = urlSplit[minorSectionIndex] || "";
  s.prop16 = s.eVar29 = urlSplit[minorSectionIndex+1] || "";
  pageNameString = urlSplit.splice(3).join(" | ");
  s.pageName = "jboss | community | " + siteName + " | " + pageNameString;
  s.server = "jboss";
  s.channel = "jboss | community";
  s.prop4 = s.eVar23 = encodeURI(document.URL);
  s.prop21 = s.eVar18 = coreUrl;
  s.prop2 = s.eVar22 = "en";
  s.prop3 = s.eVar19 = "us";
  //--></script> <script type="text/javascript" src="//www.redhat.com/j/rh_omni_footer.js"></script> <script language="JavaScript" type="text/javascript"><!--
  if(navigator.appVersion.indexOf('MSIE')>=0)document.write(unescape('%3C')+'\!-'+'-')
  //--></script> <noscript><a href="http://www.omniture.com" title="Web Analytics"><img src="https://smtrcs.redhat.com/b/ss/redhatcom,redhatglobal/1/H.25.4--NS/0?[AQB]&cdp=3&[AQE]" height="1" width="1" border="0" alt=""/></a></noscript> </div> <script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script> <script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-10656779-1");
pageTracker._trackPageview();
} catch(err) {}</script> <script>
 (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
 
ga('create', 'UA-76464546-1', 'auto');
ga('send', 'pageview');
ga('set', 'anonymizeIp', true);
ga('require', 'linkid', 'linkid.js');

</script> </div> </body> </html>