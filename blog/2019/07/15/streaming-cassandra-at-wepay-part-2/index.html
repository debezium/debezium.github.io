<!DOCTYPE html> <html> <head> <title>Streaming Cassandra at WePay - Part 2</title> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1"> <meta name="description" content="Debezium is an open source distributed platform for change data capture. Start it up, point it at your databases, and your apps can start responding to all of the inserts, updates, and deletes that other apps commit to your databases. Debezium is durable and fast, so your apps can respond quickly and never miss an event, even when things go wrong."> <meta content="Debezium" property="og:site_name"> <meta content="Streaming Cassandra at WePay - Part 2" property="og:title"> <meta content="https://debezium.io/assets/images/color_black_debezium_type_1200px.png" property="og:image" name="image"> <meta property="og:description" content="Debezium is an open source distributed platform for change data capture. Start it up, point it at your databases, and your apps can start responding to all of the inserts, updates, and deletes that other apps commit to your databases. Debezium is durable and fast, so your apps can respond quickly and never miss an event, even when things go wrong."> <meta property="og:url" content="https://debezium.io/blog/2019/07/15/streaming-cassandra-at-wepay-part-2/"> <meta name="twitter:site" content="@debezium"> <meta name="twitter:title" content="Streaming Cassandra at WePay - Part 2"> <meta name="twitter:creator" content="@joygao"> <meta name="twitter:description" content="Debezium is an open source distributed platform for change data capture. Start it up, point it at your databases, and your apps can start responding to all of the inserts, updates, and deletes that other apps commit to your databases. Debezium is durable and fast, so your apps can respond quickly and never miss an event, even when things go wrong."> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:image" content="https://debezium.io/assets/images/color_black_debezium_type_1200px.png"> <meta property="twitter:url" content="https://debezium.io/blog/2019/07/15/streaming-cassandra-at-wepay-part-2/"> <link rel="alternate" type="application/rss+xml" title="Debezium Blog" href="/blog.atom"> <link rel="shortcut icon" type="image/png" href="/favicon.ico"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css"/> <link rel="stylesheet" href="/assets/css/custom.css"/> <link rel="stylesheet" href="/assets/css/highlight.min.css"/> <link rel="stylesheet" href="/assets/css/coderay.css"/> <link rel="canonical" href="https://wecode.wepay.com/posts/streaming-cassandra-at-wepay-part-2"/> </head> <body class="post"> <div id="rhbar"> <a class="jbdevlogo" href="https://developers.redhat.com"></a> <a class="rhlogo" href="https://www.redhat.com/"></a> </div> <div id> <div class="container" id="content"> <nav class="navbar navbar-inverse navbar-fix"> <div class="container-fluid"> <div class="navbar-header"> <button class="navbar-toggle collapsed border-0" type="button" data-toggle="collapse" data-target="#navigation" aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href="/"><img class="project-logo" src="/assets/images/color_white_debezium_type_600px.svg" style="height: 32px; margin-right: 5px; margin-top: -5px;"></a> </div> <div class="collapse navbar-collapse collapsed" id="navigation"> <ul class="nav navbar-nav pull-right"> <li> <a href="/documentation/faq" class="">FAQ</a> </li> <li class="item"> <a href="/documentation/" class="">Documentation</a> </li> <li> <a href="/releases/" class="">Releases</a> </li> <li> <a href="/community/" class="">Community</a> </li> <li class="active"> <a href="/blog/" class="active">Blog</a> </li> </ul> </div> </div> </nav> <div class="row post-text-padding row-no-expand"> <div class="col-md-3"><div id="leftdocnav"> <div class="hidden-lg hidden-md hidden-sm"> <button class="navbar-toggle docssubmenu-toggle collapsed" data-target="#docssubmenu" data-toggle="collapse" style=" float: none; background-color: #656565; border-color: #656565; width: 100%; color: #fff; "> Navigation Menu </button> </div> <div class="collapse" id="docssubmenu"> <div class="doc-pills"> <ul class="nav nav-pills nav-stacked"> <li class="item"> <a href="/blog">Home</a> <div class="icon"><span class="icon-home"></span></div> </li> <li class="item"> <a href="/archives">Archive</a> <div class="icon"><span class="icon-arrow-down"></span></div> </li> <li class="item"> <a href="/blog.atom">Feed</a> <div class="icon"><span class="icon-rss"></span></div> </li> </ul> </div> <p></p> <div class="featured-posts"> <div id="#featured" style="margin-bottom: 4px; border-bottom: 1px solid #ccc; font-size: 115%; margin-left: 2px;">Featured Posts</div> <ul style="padding-inline-start: 22px;"> <li style="margin-bottom: 3px;"> <a href="/blog/2024/07/08/async-embedded-engine/" style="font-size: 95%;"> Debezium asynchronous engine </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2024/01/11/Debezium-and-TimescaleDB/" style="font-size: 95%;"> Debezium and TimescaleDB </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2023/12/20/JDBC-sink-connector-batch-support/" style="font-size: 95%;"> Streamlined Performance: Debezium JDBC connector batch support </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2023/10/19/Debezium-Operator-Takes-off-to-the-Clouds/" style="font-size: 95%;"> Debezium Operator Takes off to the Clouds </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2023/10/05/Debezium-JMX-signaling-and-notifications/" style="font-size: 95%;"> Debezium signaling and notifications - Part 3: JMX channel </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2023/09/23/flink-spark-online-learning/" style="font-size: 95%;"> Online machine learning with the data streams from the database </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2023/07/10/custom-http-signaling-notification/" style="font-size: 95%;"> Debezium signaling and notifications - Part 2: Customisation </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2023/06/27/Debezium-signaling-and-notifications/" style="font-size: 95%;"> Debezium signaling and notifications - Part 1 </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2023/05/02/tensorflow-mnist-classification/" style="font-size: 95%;"> Image classification with Debezium and TensorFlow </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2020/11/04/streaming-vitess-at-bolt/" style="font-size: 95%;"> Streaming Vitess at Bolt </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2020/02/10/event-sourcing-vs-cdc/" style="font-size: 95%;"> Distributed Data for Microservices â€” Event Sourcing vs. Change Data Capture </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2019/10/01/audit-logs-with-change-data-capture-and-stream-processing/" style="font-size: 95%;"> Building Audit Logs with Change Data Capture and Stream Processing </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2019/07/12/streaming-cassandra-at-wepay-part-1/" style="font-size: 95%;"> Streaming Cassandra at WePay - Part 1 </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2019/02/19/reliable-microservices-data-exchange-with-the-outbox-pattern/" style="font-size: 95%;"> Reliable Microservices Data Exchange With the Outbox Pattern </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/12/05/automating-cache-invalidation-with-change-data-capture/" style="font-size: 95%;"> Automating Cache Invalidation With Change Data Capture </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/09/20/materializing-aggregate-views-with-hibernate-and-debezium/" style="font-size: 95%;"> Materializing Aggregate Views With Hibernate and Debezium </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/07/19/advantages-of-log-based-change-data-capture/" style="font-size: 95%;"> Five Advantages of Log-Based Change Data Capture </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/03/08/creating-ddd-aggregates-with-debezium-and-kafka-streams/" style="font-size: 95%;"> Creating DDD aggregates with Debezium and Kafka Streams </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/01/17/streaming-to-elasticsearch/" style="font-size: 95%;"> Streaming Data Changes from Your Database to Elasticsearch </a> </li> </ul> </div> <p></p> <p></p> <div class="cloud-tags"> <div id="tags" style="margin-bottom: 4px; border-bottom: 1px solid #ccc; font-size: 115%; margin-left: 2px;"> Tags </div> <div class="tag-cloud"> <span class="site-tag"> <a href="/tag/apache-kafka/" style="font-size: 82%"> apache kafka </a> </span> <span class="site-tag"> <a href="/tag/apache-kafka/" style="font-size: 96%"> apache kafka </a> </span> <span class="site-tag"> <a href="/tag/apicurio/" style="font-size: 82%"> apicurio </a> </span> <span class="site-tag"> <a href="/tag/avro/" style="font-size: 84%"> avro </a> </span> <span class="site-tag"> <a href="/tag/aws/" style="font-size: 82%"> aws </a> </span> <span class="site-tag"> <a href="/tag/batch/" style="font-size: 82%"> batch </a> </span> <span class="site-tag"> <a href="/tag/caassandra/" style="font-size: 86%"> caassandra </a> </span> <span class="site-tag"> <a href="/tag/camel/" style="font-size: 82%"> camel </a> </span> <span class="site-tag"> <a href="/tag/cassandra/" style="font-size: 304%"> cassandra </a> </span> <span class="site-tag"> <a href="/tag/cdc/" style="font-size: 82%"> cdc </a> </span> <span class="site-tag"> <a href="/tag/channels/" style="font-size: 82%"> channels </a> </span> <span class="site-tag"> <a href="/tag/community/" style="font-size: 124%"> community </a> </span> <span class="site-tag"> <a href="/tag/community-stories/" style="font-size: 84%"> community stories </a> </span> <span class="site-tag"> <a href="/tag/connectors/" style="font-size: 82%"> connectors </a> </span> <span class="site-tag"> <a href="/tag/containers/" style="font-size: 82%"> containers </a> </span> <span class="site-tag"> <a href="/tag/cqrs/" style="font-size: 84%"> cqrs </a> </span> <span class="site-tag"> <a href="/tag/custom/" style="font-size: 82%"> custom </a> </span> <span class="site-tag"> <a href="/tag/datalake/" style="font-size: 82%"> datalake </a> </span> <span class="site-tag"> <a href="/tag/db2/" style="font-size: 288%"> db2 </a> </span> <span class="site-tag"> <a href="/tag/ddd/" style="font-size: 82%"> ddd </a> </span> <span class="site-tag"> <a href="/tag/debezium/" style="font-size: 108%"> debezium </a> </span> <span class="site-tag"> <a href="/tag/debezium-server/" style="font-size: 94%"> debezium server </a> </span> <span class="site-tag"> <a href="/tag/debezium-ui/" style="font-size: 90%"> debezium ui </a> </span> <span class="site-tag"> <a href="/tag/deduplication/" style="font-size: 82%"> deduplication </a> </span> <span class="site-tag"> <a href="/tag/discussion/" style="font-size: 114%"> discussion </a> </span> <span class="site-tag"> <a href="/tag/docker/" style="font-size: 188%"> docker </a> </span> <span class="site-tag"> <a href="/tag/elasticsearch/" style="font-size: 82%"> elasticsearch </a> </span> <span class="site-tag"> <a href="/tag/event-sourcing/" style="font-size: 82%"> event sourcing </a> </span> <span class="site-tag"> <a href="/tag/exactly-once-semantics/" style="font-size: 82%"> exactly once semantics </a> </span> <span class="site-tag"> <a href="/tag/example/" style="font-size: 88%"> example </a> </span> <span class="site-tag"> <a href="/tag/examples/" style="font-size: 118%"> examples </a> </span> <span class="site-tag"> <a href="/tag/features/" style="font-size: 94%"> features </a> </span> <span class="site-tag"> <a href="/tag/fedora/" style="font-size: 82%"> fedora </a> </span> <span class="site-tag"> <a href="/tag/flink/" style="font-size: 84%"> flink </a> </span> <span class="site-tag"> <a href="/tag/hiring/" style="font-size: 84%"> hiring </a> </span> <span class="site-tag"> <a href="/tag/ibmi/" style="font-size: 112%"> ibmi </a> </span> <span class="site-tag"> <a href="/tag/iceberg/" style="font-size: 82%"> iceberg </a> </span> <span class="site-tag"> <a href="/tag/images/" style="font-size: 82%"> images </a> </span> <span class="site-tag"> <a href="/tag/informix/" style="font-size: 122%"> informix </a> </span> <span class="site-tag"> <a href="/tag/integration/" style="font-size: 86%"> integration </a> </span> <span class="site-tag"> <a href="/tag/introduction/" style="font-size: 84%"> introduction </a> </span> <span class="site-tag"> <a href="/tag/jaeger/" style="font-size: 82%"> jaeger </a> </span> <span class="site-tag"> <a href="/tag/jdbc/" style="font-size: 124%"> jdbc </a> </span> <span class="site-tag"> <a href="/tag/json/" style="font-size: 82%"> json </a> </span> <span class="site-tag"> <a href="/tag/kafka/" style="font-size: 94%"> kafka </a> </span> <span class="site-tag"> <a href="/tag/kafka-streams/" style="font-size: 82%"> kafka streams </a> </span> <span class="site-tag"> <a href="/tag/kafka-streams/" style="font-size: 86%"> kafka streams </a> </span> <span class="site-tag"> <a href="/tag/kogito/" style="font-size: 82%"> kogito </a> </span> <span class="site-tag"> <a href="/tag/ksql/" style="font-size: 82%"> ksql </a> </span> <span class="site-tag"> <a href="/tag/kubernetes/" style="font-size: 86%"> kubernetes </a> </span> <span class="site-tag"> <a href="/tag/lakehouse/" style="font-size: 82%"> lakehouse </a> </span> <span class="site-tag"> <a href="/tag/machine-learning/" style="font-size: 86%"> machine learning </a> </span> <span class="site-tag"> <a href="/tag/mariadb/" style="font-size: 120%"> mariadb </a> </span> <span class="site-tag"> <a href="/tag/microservices/" style="font-size: 84%"> microservices </a> </span> <span class="site-tag"> <a href="/tag/mongo/" style="font-size: 86%"> mongo </a> </span> <span class="site-tag"> <a href="/tag/mongodb/" style="font-size: 306%"> mongodb </a> </span> <span class="site-tag"> <a href="/tag/mysql/" style="font-size: 442%"> mysql </a> </span> <span class="site-tag"> <a href="/tag/news/" style="font-size: 112%"> news </a> </span> <span class="site-tag"> <a href="/tag/newsletter/" style="font-size: 88%"> newsletter </a> </span> <span class="site-tag"> <a href="/tag/notifications/" style="font-size: 86%"> notifications </a> </span> <span class="site-tag"> <a href="/tag/online-learning/" style="font-size: 84%"> online learning </a> </span> <span class="site-tag"> <a href="/tag/operator/" style="font-size: 84%"> operator </a> </span> <span class="site-tag"> <a href="/tag/oracle/" style="font-size: 338%"> oracle </a> </span> <span class="site-tag"> <a href="/tag/outbox/" style="font-size: 276%"> outbox </a> </span> <span class="site-tag"> <a href="/tag/performance/" style="font-size: 82%"> performance </a> </span> <span class="site-tag"> <a href="/tag/postgres/" style="font-size: 412%"> postgres </a> </span> <span class="site-tag"> <a href="/tag/presentation/" style="font-size: 84%"> presentation </a> </span> <span class="site-tag"> <a href="/tag/production/" style="font-size: 82%"> production </a> </span> <span class="site-tag"> <a href="/tag/quarkus/" style="font-size: 92%"> quarkus </a> </span> <span class="site-tag"> <a href="/tag/questdb/" style="font-size: 82%"> questdb </a> </span> <span class="site-tag"> <a href="/tag/rds/" style="font-size: 84%"> rds </a> </span> <span class="site-tag"> <a href="/tag/releases/" style="font-size: 424%"> releases </a> </span> <span class="site-tag"> <a href="/tag/schema/" style="font-size: 82%"> schema </a> </span> <span class="site-tag"> <a href="/tag/scylla/" style="font-size: 82%"> scylla </a> </span> <span class="site-tag"> <a href="/tag/secrets/" style="font-size: 82%"> secrets </a> </span> <span class="site-tag"> <a href="/tag/sentry/" style="font-size: 82%"> sentry </a> </span> <span class="site-tag"> <a href="/tag/serialization/" style="font-size: 82%"> serialization </a> </span> <span class="site-tag"> <a href="/tag/signaling/" style="font-size: 86%"> signaling </a> </span> <span class="site-tag"> <a href="/tag/smt/" style="font-size: 84%"> smt </a> </span> <span class="site-tag"> <a href="/tag/snapshots/" style="font-size: 84%"> snapshots </a> </span> <span class="site-tag"> <a href="/tag/spanner/" style="font-size: 164%"> spanner </a> </span> <span class="site-tag"> <a href="/tag/spark/" style="font-size: 84%"> spark </a> </span> <span class="site-tag"> <a href="/tag/sql/" style="font-size: 84%"> sql </a> </span> <span class="site-tag"> <a href="/tag/sqlserver/" style="font-size: 352%"> sqlserver </a> </span> <span class="site-tag"> <a href="/tag/tensorflow/" style="font-size: 82%"> tensorflow </a> </span> <span class="site-tag"> <a href="/tag/testcontainers/" style="font-size: 88%"> testcontainers </a> </span> <span class="site-tag"> <a href="/tag/tests/" style="font-size: 82%"> tests </a> </span> <span class="site-tag"> <a href="/tag/time-series/" style="font-size: 82%"> time series </a> </span> <span class="site-tag"> <a href="/tag/timescaledb/" style="font-size: 82%"> timescaledb </a> </span> <span class="site-tag"> <a href="/tag/topics/" style="font-size: 82%"> topics </a> </span> <span class="site-tag"> <a href="/tag/tracing/" style="font-size: 82%"> tracing </a> </span> <span class="site-tag"> <a href="/tag/transactions/" style="font-size: 82%"> transactions </a> </span> <span class="site-tag"> <a href="/tag/ui/" style="font-size: 82%"> ui </a> </span> <span class="site-tag"> <a href="/tag/vagrant/" style="font-size: 82%"> vagrant </a> </span> <span class="site-tag"> <a href="/tag/vitess/" style="font-size: 268%"> vitess </a> </span> <span class="site-tag"> <a href="/tag/website/" style="font-size: 84%"> website </a> </span> </div> </div> </div> </div> </div> <div class="col-md-9"> <div class="post"> <div class="row" style="margin-left: 0; margin-right: 0; margin-bottom: 10px"> <div class="col-sm-12" style="padding-left: 0px"> <div style="display: table-cell; vertical-align: top"> <div style=" width: 72px; border: 1px solid #ccc; padding: 3px; display: inline-block; "> <img src="/assets/images/joygao.jpg" style="width: 64px;"> </div> </div> <div style="display: table-cell; vertical-align: top"> <div style="margin-left: 8px"> <span class="hidden-sm hidden-xs" style="font-size: 2.75rem; line-height: 1"> <a href="/blog/2019/07/15/streaming-cassandra-at-wepay-part-2/">Streaming Cassandra at WePay - Part 2</a> </span> <span class="hidden-md hidden-lg" style="font-size: 2rem; line-height: 1"> <a href="/blog/2019/07/15/streaming-cassandra-at-wepay-part-2/">Streaming Cassandra at WePay - Part 2</a> </span> <div class="byline" style="line-height: 1"> <em> July 15, 2019 by </em> <em> Joy Gao </em> <div class="hidden-xs" style="margin-top: 5px"> <a class="label label-info hidden-sm hidden-xs" href="/tag/cassandra/">cassandra</a> </div> </div> </div> </div> </div> </div> <div class="grid__item width-12-12"><div class="paragraph"> <p><strong><em>This post originally appeared on the <a href="https://wecode.wepay.com/posts/streaming-cassandra-at-wepay-part-2">WePay Engineering blog</a>.</em></strong></p> </div> <div class="paragraph"> <p>In the first half of this blog post series, we explained our decision-making process of designing a streaming data pipeline for Cassandra at WePay. In this post, we will break down the pipeline into three sections and discuss each of them in more detail:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Cassandra to Kafka with CDC agent</p> </li> <li> <p>Kafka with BigQuery with KCBQ</p> </li> <li> <p>Transformation with BigQuery view</p> </li> </ol> </div> <div class="paragraph"> <p></p> </div> <div class="sect1"> <h2 id="cassandra_to_kafka_with_cdc_agent">Cassandra to Kafka with CDC Agent</h2> <div class="sectionbody"> <div class="paragraph"> <p>The Cassandra CDC agent is a JVM process that is intended to be deployed on each node in a Cassandra cluster. The agent is comprised of several interdependent processors, running concurrently and working together to publish change events to Kafka.</p> </div> <div class="sect2"> <h3 id="snapshot_processor">Snapshot Processor</h3> <div class="paragraph"> <p>This processor is responsible for bootstrapping new tables. It looks up the CDC configuration to determine the snapshot mode, and performs snapshot on CDC-enabled tables if needed. To snapshot a table, the agent performs a full table scan and converts each row in the result set into an individual create event, and then sequentially enqueues them to an in-memory <a href="https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/BlockingQueue.html">BlockingQueue</a>.</p> </div> </div> <div class="sect2"> <h3 id="commit_log_processor">Commit Log Processor</h3> <div class="paragraph"> <p>This processor is responsible for watching the CDC directory for new commit logs, parsing the commit log files via Cassandraâ€™s <a href="https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/db/commitlog/CommitLogReader.java"><code>CommitLogReader</code></a>, transforming deserialized mutations into standardized change events, and finally enqueuing them to the same queue as the snapshot processor.</p> </div> <div class="paragraph"> <p>At this point, some readers may have concerns in regard to running Snapshot Processor and Commit Log Processors concurrently rather than serially. The reason is that Cassandra uses a <a href="https://datastax.github.io/cpp-driver/topics/basics/client_side_timestamps/">client-side timestamp</a> to determine event order, and resolves conflicts with last write wins. This client-side timestamp is deliberately stored in each change event. This is why snapshotting doesnâ€™t have to proceed commit log processing â€“ the ordering is determined later on when the data is queried in the data warehouse.</p> </div> </div> <div class="sect2"> <h3 id="queue_processor">Queue Processor</h3> <div class="paragraph"> <p>This processor is responsible for dequeuing change events, transforming them into <a href="https://avro.apache.org/docs/1.8.1/spec.html">Avro</a> records, and sending them to Kafka via a Kafka producer. It also tracks the position of the most recently sent event, so that on restart it is able to pick up from where it left off.</p> </div> <div class="paragraph"> <p>Implementing an in-memory queue in the CDC agent seems like overkill at first. Given there is only a single thread doing the enqueue and another thread doing the dequeue, the performance boost is negligible. The motivation here is to decouple the work of parsing commit logs, which should be done serially in the right order, from the work of serializing and publishing Kafka events, which can be parallelized by multiple threads for different tables. Although such parallelization is not implemented at the moment, we want the flexibility of adding this feature in the near future.</p> </div> <div class="paragraph"> <p>Some may also wonder why <a href="https://docs.confluent.io/current/connect/index.html">Kafka Connect</a> is not used here as it seems like a natural fit for streaming. It is a great option if we wanted distributed parallel processing with fault tolerance. However, it is more complicated to deploy, monitor, and debug than a Kafka producer. For the purpose of building a minimum viable infrastructure, we chose Kafka producer at the time.</p> </div> </div> <div class="sect2"> <h3 id="schema_processor">Schema Processor</h3> <div class="paragraph"> <p>In order to support automatic schema evolution, this processor periodically polls the database for the latest table schema, and updates the in-memory schema cache if a change is detected. Snapshot Processor and Commit Log Processor both look up table schema from this cache and attach it as part of the change event prior to enqueue. Then upon dequeue, the Queue Processor transforms the attached table schema into an Avro schema for record serialization.</p> </div> </div> <div class="sect2"> <h3 id="commit_log_post_processor">Commit Log Post Processor</h3> <div class="paragraph"> <p>This processor is responsible for cleaning up commit logs after they have been processed. The default Commit Log Post Processor implementation will simply perform deletion. A custom Commit Log Post Processor can be configured for use case such as archiving commit log files to <a href="https://aws.amazon.com/s3/">S3</a> or <a href="https://cloud.google.com/storage/">GCS</a>.</p> </div> </div> </div> </div> <div class="sect1"> <h2 id="kafka_to_bigquery_with_kcbq">Kafka to BigQuery with KCBQ</h2> <div class="sectionbody"> <div class="paragraph"> <p>Once the events arrive in Kafka, we use KCBQ to send the events data to BigQuery without performing special transformations, just like in our <a href="https://wecode.wepay.com/posts/streaming-databases-in-realtime-with-mysql-debezium-kafka">MySQL streaming data pipeline</a>. We have written a previous <a href="https://wecode.wepay.com/posts/kafka-bigquery-connector">blog post</a> explaining this connector in more details.</p> </div> </div> </div> <div class="sect1"> <h2 id="transformation_with_bigquery_view">Transformation with BigQuery View</h2> <div class="sectionbody"> <div class="paragraph"> <p>Once the events are in BigQuery, this is where the heavy-lifting is being done. We create <a href="https://cloud.google.com/bigquery/docs/views-intro">virtual views</a> on top of the raw tables to merge the data in a way that mirrors the source table in Cassandra. Note that each row in the raw tables contains limited data â€“ only columns that have been modified have states. This means selecting the latest row for each primary key will not provide us with data that is consistent with source. Instead, the query must identify the latest cell in each column for each primary key. This can be achieved with self-joins on the primary key for each column in the table. Although joins are slow in MySQL, BigQueryâ€™s parallel execution engine and columnar storage makes this possible. A view on top of a 1TB Cassandra table in BigQuery takes about 100 seconds to query.</p> </div> <div class="sect2"> <h3 id="compaction">Compaction</h3> <div class="paragraph"> <p>The fact that the BigQuery view is virtual implies each time the view is queried essentially triggers a full compaction of the raw data. This means the cost will go up with the number of queries, not to mention the duplicated events amplifies the amount of data that needs to be processed by a factor of N, where N is the replication factor. To save cost and improve performance, periodic compaction by materializing the view is necessary.</p> </div> </div> </div> </div> <div class="sect1"> <h2 id="future_development_work">Future Development Work</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="support_for_cassandra_4_0">Support for Cassandra 4.0</h3> <div class="paragraph"> <p>In Cassandra 4.0, the improved CDC feature allows the connector to be able to parse events in real-time as they are written rather than in micro-batches on each commit log flush. This reduces latency substantially.</p> </div> </div> <div class="sect2"> <h3 id="performance_optimization">Performance Optimization</h3> <div class="paragraph"> <p>As mentioned earlier, there is a single thread responsible for dequeuing, serializing, and publishing Kafka records. However, as the write throughput increases, if the performance of the agent does not keep up, it would result in a backlog of unprocessed commit logs which could potentially impact the health of our production database. The next step is to leverage parallel processing of events to optimize performance.</p> </div> </div> <div class="sect2"> <h3 id="streamline_with_debezium_and_kafka_connect">Streamline with Debezium and Kafka Connect</h3> <div class="paragraph"> <p>We initially built the Cassandra CDC agent as a standalone project. Now that it is open-sourced as a <a href="https://debezium.io/">Debezium</a> connector, we can replace some of our custom classes with existing ones in Debezium. Another improvement is to support common features that all Debezium connectors have, such as support for multiple serialization formats. Finally, the CDC agent is not fault tolerant; robust alert and monitoring are required as part of deployment. One area to explore in the future is to build the CDC agent on top of Kafka Connect as a source connector, this further streamlines the Cassandra connector with other Debezium connectors, and provides scalability and fault tolerance for free.</p> </div> </div> </div> </div> <div class="sect1"> <h2 id="closing_remarks">Closing Remarks</h2> <div class="sectionbody"> <div class="paragraph"> <p>Cassandra being a peer-to-peer distributed database poses some really interesting challenges for CDC that do not exist in relational databases like MySQL and Postgres, or even a single-master NoSQL database like MongoDB. Note that it is worth evaluating the limitations before rolling out your own real-time data pipeline for Cassandra.</p> </div> <div class="paragraph"> <p>Besides understanding Cassandra internals, we learned a few lessons on engineering productivity along the way:</p> </div> <div class="sect2"> <h3 id="minimum_viable_product_philosophy">Minimum Viable Product Philosophy</h3> <div class="paragraph"> <p>By stripping away all features except for the essentials, we were able to build, test, and deploy a working solution in a reasonable time with limited resources. Had we aimed to design a pipeline that encompasses all features upfront, it would have taken a lot longer and required much more resources.</p> </div> </div> <div class="sect2"> <h3 id="community_involvement">Community Involvement</h3> <div class="paragraph"> <p>Cassandra is an open-source project. Rather than tackling the problem solo, we were engaged with the Cassandra community from the very start (i.e. sharing experiences with committers and users via <a href="https://www.meetup.com/Apache-Cassandra-Bay-Area/">meetups</a>, <a href="https://user.cassandra.apache.narkive.com/njOxVaxP/using-cdc-feature-to-stream-c-to-kafka-design-proposal">discussing proposals in mailing list</a>, <a href="https://www.youtube.com/watch?v=0K0fYHsFBZg">presenting proof-of-concept in conferences</a>, etc.); all of which provided us with valuable feedback throughout the design and implementation stages.</p> </div> </div> </div> </div></div> </div> <div class="well"> <div class="row"> <div class="col-md-8"> <h2>Joy Gao</h2> <p> <span class="bio-size">Joy Gao is a software engineering at WePay, where she focuses on change data capture, data warehousing, and distributed systems.</span> </p> <p class="bio-size"> <a href="https://twitter.com/joygao"> <i class="icon-twitter"></i> </a> &nbsp; <a href="https://github.com/jgao54"> <i class="icon-github"></i> </a> &nbsp; </p> </div> <div class="col-md-4"> <img alt="" class="img-responsive pull-right portrait" src="/assets/images/joygao.jpg"/> </div> </div> </div> <ul class="pager pager-blog"> <li class="previous"> <a href="/blog/2019/07/12/streaming-cassandra-at-wepay-part-1/" class="previous"> &laquo; Previous</a> </li> <li class="next"><a href="/blog/2019/07/25/debezium-0-10-0-beta3-released/">Next &raquo; </a></li> </ul> <div class="row"> <div class="col-md-12"> <hr> <h2>About Debezium</h2> <p> Debezium is an open source distributed platform that turns your existing databases into event streams, so applications can see and respond almost instantly to each committed row-level change in the databases. Debezium is built on top of <a href="http://kafka.apache.org/">Kafka</a> and provides <a href="http://kafka.apache.org/documentation.html#connect">Kafka Connect</a> compatible connectors that monitor specific database management systems. Debezium records the history of data changes in Kafka logs, so your application can be stopped and restarted at any time and can easily consume all of the events it missed while it was not running, ensuring that all events are processed correctly and completely. Debezium is <a href="/license/">open source</a> under the <a href="http://www.apache.org/licenses/LICENSE-2.0.html">Apache License, Version 2.0</a>. </p> </div> </div> <div class="row"> <div class="col-md-12"> <h2>Get involved</h2> <p> We hope you find Debezium interesting and useful, and want to give it a try. Follow us on Twitter <a href="https://twitter.com/debezium">@debezium</a>, <a href="https://debezium.zulipchat.com/#narrow/stream/302529-users">chat with us on Zulip</a>, or join our <a href="https://groups.google.com/forum/#!forum/debezium">mailing list</a> to talk with the community. All of the code is open source <a href="https://github.com/debezium/">on GitHub</a>, so build the code locally and help us improve ours existing connectors and add even more connectors. If you find problems or have ideas how we can improve Debezium, please let us know or <a href="https://issues.redhat.com/projects/DBZ/issues/">log an issue</a>. </p> </div> </div> <div id="disqus_thread"></div> <script>var disqus_config=function(){this.page.url="https://debezium.io/blog/2019/07/15/streaming-cassandra-at-wepay-part-2/",this.page.identifier="https://debezium.io/blog/2019/07/15/streaming-cassandra-at-wepay-part-2/"};!function(){var t=document,e=t.createElement("script");e.src="https://Debezium.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}();</script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> </div> </div> </div> <footer class="container"> <div> <div class="row mr-0 ml-0"> <div class="col-md-5 col-md-offset-1"> <h4>Debezium</h4> <p> &#169; 2024 Debezium Community <br/> <br/> <i class="icon-fire"></i> Mixed with <a href="https://getbootstrap.com/">Bootstrap</a>, baked by <a href="https://jekyllrb.com/">Jekyll</a>. <br/> <i class="icon-flag"></i> Website and docs licensed under <a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>. <br/> <i class="icon-flag-alt"></i> Code released under <a href="https://www.apache.org/licenses/LICENSE-2.0.html">Apache License, v2.0</a>. <br/> <i class="icon-file-alt"></i> <a href="https://www.redhat.com/legal/legal_statement.html" title="Terms">Terms</a> | <a href="https://www.redhat.com/legal/privacy_statement.html" title="Privacy Policy">Privacy</a> </p> <p>Rev: <a target="_blank" href="https://github.com/debezium/debezium.github.io/commit/66c181e0df48c1d5a57d49865b66ee1a87e0d165">66c181e</a> </p> </div> <div class="col-md-3"> <h4>Documentation</h4> <ul class="list-unstyled"> <li><a href="/documentation/reference/stable/features.html" title="Features">Features</a></li> <li> <a href="/documentation/reference/stable/install.html" title="Install">Install</a> </li> <li> <a href="/documentation/reference/stable/architecture.html" title="Architecture">Architecture</a> </li> <li><a href="/documentation/faq/" title="FAQ">FAQ</a></li> <li> <a href="/community/contribute/" title="Contribute">Contribute</a> </li> </ul> </div> <div class="col-md-3"> <h4>Connect</h4> <ul class="list-unstyled"> <li><a href="/blog" title="Blog">Blog</a></li> <li> <a href="https://twitter.com/debezium" title="Twitter">Twitter</a> </li> <li><a href="https://github.com/debezium" title="GitHub">GitHub</a></li> <li><a href="https://debezium.zulipchat.com/#narrow/stream/302529-users" title="Chat">Chat</a></li> <li> <a href="https://groups.google.com/forum/#!forum/debezium" title="Google Groups">Google Groups</a> </li> <li> <a href="https://stackoverflow.com/questions/tagged/debezium" title="StackOverflow">StackOverflow</a> </li> </ul> </div> </div> </div> </footer> <div class="container" id="companyfooter"> <div class="redhatlogo"> <a href="https://www.redhat.com/"> <img src="/assets/images/Logo-Red_Hat-Sponsored_By-B-Standard-RGB.svg"/> </a> </div> </div> </div> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-76464546-1"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-76464546-1");</script> <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script> <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script> <script type="text/javascript" src="/assets/javascript/vanilla-back-to-top.min.js"></script> <script type="text/javascript" src="/assets/javascript/highlight.min.js"></script> <script>addBackToTop({scrollDuration:400}),hljs.initHighlightingOnLoad();</script> </body> </html>