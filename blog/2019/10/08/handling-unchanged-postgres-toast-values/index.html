<!DOCTYPE html> <html lang="en"> <head> <title>Strategies for Handling Unchanged Postgres TOAST Values Â· Debezium</title> <meta charset="utf-8"> <meta content="width=device-width, initial-scale=1.0" name="viewport"> <meta content="" name="description"> <meta content="" name="author"> <link href="https://static.jboss.org/theme/css/bootstrap-community/3.2.0.2/bootstrap-community.min.css" media="screen" rel="stylesheet"> <!--[if lt IE 9]><script src="https://static.jboss.org/theme/js/libs/html5/pre3.6/html5.min.js"></script><![endif]--> <link href="https://static.jboss.org/example/images/favicon.ico" rel="shortcut icon"> <link href="https://static.jboss.org/example/images/apple-touch-icon-144x144-precomposed.png" rel="apple-touch-icon-precomposed" sizes="144x144"> <link href="https://static.jboss.org/example/images/apple-touch-icon-114x114-precomposed.png" rel="apple-touch-icon-precomposed" sizes="114x114"> <link href="https://static.jboss.org/example/images/apple-touch-icon-72x72-precomposed.png" rel="apple-touch-icon-precomposed" sizes="72x72"> <link href="https://static.jboss.org/example/images/apple-touch-icon-precomposed.png" rel="apple-touch-icon-precomposed"> <link href="/stylesheets/debezium.css" rel="stylesheet" type="text/css"> <style>
  @media (min-width: 980px) {
    .banner { background-image: url(https://static.jboss.org/example/images/debezium-banner-1180px.png); height: 110px;  }
  }
  @media (max-width: 979px) {
    .banner { background-image: url(https://static.jboss.org/example/images/debezium-logo.png); background-repeat:no-repeat; background-position: center bottom; height: 60px; }
  }
  @media (max-width: 650px) {
    .banner { width: 100%; margin: 0px auto; }
  }
  @media (max-width: 450px) {
    .banner { height: 90px; }
  }
</style> <link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/styles/default.min.css" rel="stylesheet"> <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/highlight.min.js"></script> <script>
hljs.initHighlightingOnLoad();
</script> <script src="https://static.jboss.org/theme/js/libs/jquery/jquery-1.9.1.min.js"></script> <style>
  /* adjusting the vertical spacing for when a stickynav is engaged */
  .breadcrumb-fixed > .active {
    color: #8c8f91;
  }
  .breadcrumb-fixed {
    margin: 70px 0 10px;
    padding: 8px 15px;
    margin-bottom: 20px;
    list-style: none;
    background-color: #f5f5f5;
    border-radius: 4px;
  }
  
  .breadcrumb-fixed > li {
    display: inline-block;
  }
</style> </head> <body> <div id="rhbar"> <a class="jbdevlogo" href="https://www.jboss.org/projects/about"></a> <a class="rhlogo" href="https://www.redhat.com/"></a> </div> <div id=""> <ul class="visuallyhidden" id="top"> <li> <a accesskey="n" href="#nav" title="Skip to navigation">Skip to navigation</a> </li> <li> <a accesskey="c" href="#page" title="Skip to content">Skip to content</a> </li> </ul> <div class="container" id="content"> <div class="navbar navbar-inverse navbar-fix"> <div class="container-fluid"> <div class="navbar-header"> <button class="navbar-toggle collapsed" data-target="#navbar-1" data-toggle="collapse"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href="/"> <img src="/images/color_white_debezium_type_600px.svg" style="height: 32px; margin-right: 5px; margin-top: -5px;"> </a> </div> <div class="collapse navbar-collapse" id="navbar-1"> <ul class="nav navbar-nav pull-right"> <li class=""><a href="/documentation/faq/">FAQ</a></li> <li class=""><a href="/documentation/">DOCUMENTATION</a></li> <li class=""><a href="/releases/">RELEASES</a></li> <li class=""><a href="/community/">COMMUNITY</a></li> <li class="active"><a href="/blog/">BLOG</a></li> </ul> </div> </div> </div> <div id="equalHeightsLayout"> <div class="row post-text-padding row-no-expand"> <div class="hidden-xs col-sm-3 no-right-padding" id="leftdocnav" style="padding-left: 15px; padding-right: 15px;"> <div class="doc-pills"> <ul class="nav nav-pills nav-stacked"> <li class="item"> <a href="/blog">Home</a> <div class="icon"> <span class="icon-home"></span> </div> </li> <li class="item"> <a href="/blog.atom">Feed</a> <div class="icon"> <span class="icon-rss"></span> </div> </li> </ul> </div> <p></p> <div class="featured-posts"> <div id="featured" style="margin-bottom: 4px; border-bottom: 1px solid #ccc; font-size: 115%; margin-left: 2px;"> Featured Posts </div> <ul style="padding-inline-start: 22px;"> <li style="margin-bottom: 3px;"> <a href="/blog/2019/10/22/audit-logs-with-kogito/" style="font-size: 95%;"> Admin Service for Audit Logs with Kogito </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2019/10/01/audit-logs-with-change-data-capture-and-stream-processing/" style="font-size: 95%;"> Building Audit Logs with Change Data Capture and Stream Processing </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2019/07/12/streaming-cassandra-at-wepay-part-1/" style="font-size: 95%;"> Streaming Cassandra at WePay - Part 1 </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2019/02/19/reliable-microservices-data-exchange-with-the-outbox-pattern/" style="font-size: 95%;"> Reliable Microservices Data Exchange With the Outbox Pattern </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/12/05/automating-cache-invalidation-with-change-data-capture/" style="font-size: 95%;"> Automating Cache Invalidation With Change Data Capture </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/09/20/materializing-aggregate-views-with-hibernate-and-debezium/" style="font-size: 95%;"> Materializing Aggregate Views With Hibernate and Debezium </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/07/19/advantages-of-log-based-change-data-capture/" style="font-size: 95%;"> Five Advantages of Log-Based Change Data Capture </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/03/08/creating-ddd-aggregates-with-debezium-and-kafka-streams/" style="font-size: 95%;"> Creating DDD aggregates with Debezium and Kafka Streams </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/01/17/streaming-to-elasticsearch/" style="font-size: 95%;"> Streaming Data Changes from Your Database to Elasticsearch </a> </li> </ul> </div> <p></p> <div class="cloud-tags"> <div id="tags" style="margin-bottom: 4px; border-bottom: 1px solid #ccc; font-size: 115%; margin-left: 2px;"> Tags </div> <div class="tag-cloud"> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/apache-kafka/">apache-kafka</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/avro/">avro</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/cassandra/">cassandra</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/community/">community</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/discussion/">discussion</a> </span> <span class="tag tag-5"> <a href="https://debezium.io/blog/tags/docker/">docker</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/elasticsearch/">elasticsearch</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/example/">example</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/examples/">examples</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/featured/">featured</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/fedora/">fedora</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/introduction/">introduction</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/json/">json</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/kafka/">kafka</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/kafka-streams/">kafka-streams</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/kogito/">kogito</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/ksql/">ksql</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/kubernetes/">kubernetes</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/microservices/">microservices</a> </span> <span class="tag tag-4"> <a href="https://debezium.io/blog/tags/mongodb/">mongodb</a> </span> <span class="tag tag-6"> <a href="https://debezium.io/blog/tags/mysql/">mysql</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/news/">news</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/newsletter/">newsletter</a> </span> <span class="tag tag-2"> <a href="https://debezium.io/blog/tags/oracle/">oracle</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/outbox/">outbox</a> </span> <span class="tag tag-5"> <a href="https://debezium.io/blog/tags/postgres/">postgres</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/presentation/">presentation</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/quarkus/">quarkus</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/rds/">rds</a> </span> <span class="tag tag-6"> <a href="https://debezium.io/blog/tags/releases/">releases</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/secrets/">secrets</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/sentry/">sentry</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/serialization/">serialization</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/smt/">smt</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/sql/">sql</a> </span> <span class="tag tag-3"> <a href="https://debezium.io/blog/tags/sqlserver/">sqlserver</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/vagrant/">vagrant</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/website/">website</a> </span> </div> </div> </div> <div class="col-xs-12 col-sm-9" id="maincol"> <div class="post"> <div class="row" style="margin-left: 0; margin-right: 0; margin-bottom: 10px;"> <div class="col-sm-12" style="padding-left: 0px;"> <div style="display: table-cell; vertical-align: top;"> <div style="width: 72px; border: 1px solid #ccc; padding: 3px; display: inline-block;"> <img src="/images/gmorling.jpg" style="width: 64px;"> </div> </div> <div style="display: table-cell; vertical-align: top;"> <div style="margin-left: 8px;"> <span class="hidden-sm hidden-xs" style="font-size: 2.75rem; line-height: 1;"> <a href="/blog/2019/10/08/handling-unchanged-postgres-toast-values/">Strategies for Handling Unchanged Postgres TOAST Values</a> </span> <span class="hidden-md hidden-lg" style="font-size: 2rem; line-height: 1;"> <a href="/blog/2019/10/08/handling-unchanged-postgres-toast-values/">Strategies for Handling Unchanged Postgres TOAST Values</a> </span> <div class="byline" style="line-height: 1;"> <em> October 08, 2019 by Gunnar Morling </em> <div class="hidden-xs" style="margin-top: 5px;"> <a class="hidden-sm hidden-xs label label-info" href="/blog/tags/discussion/">discussion</a> <a class="hidden-sm hidden-xs label label-info" href="/blog/tags/examples/">examples</a> <a class="hidden-sm hidden-xs label label-info" href="/blog/tags/postgres/">postgres</a> <a class="hidden-sm hidden-xs label label-info" href="/blog/tags/kafka-streams/">kafka-streams</a> </div> </div> </div> </div> </div> </div> <div class="row" style="margin-left: 0; margin-right: 0;"> <div id="preamble"> <div class="sectionbody"> <div class="paragraph"> <p>Let&#8217;s talk about TOAST. Toast? No, TOAST!</p> </div> <div class="paragraph"> <p>So what&#8217;s that? <a href="https://www.postgresql.org/docs/current/storage-toast.html">TOAST</a> (The Oversized-Attribute Storage Technique) is a mechanism in Postgres which stores large column values in multiple physical rows, circumventing the page size limit of 8 KB.</p> </div> <div class="imageblock centered-image"> <img src="/images/postgres_toast.jpg" style="max-width:100%; width:40%; margin-bottom:10px; margin-top:10px;" class="responsive-image" alt="TOAST!"> </div> <div class="paragraph"> <p>Typically, TOAST storage is transparent to the user, so you don&#8217;t really have to care about it. There&#8217;s an exception, though: if a table row has changed, any <em>unchanged</em> values that were stored using the TOAST mechanism are not included in the message that Debezium receives from the database, unless they are part of the tableâs <a href="/documentation/reference/0.10/connectors/postgresql.html#replica-identity">replica identity</a>. Consequently, such unchanged TOAST column value will not be contained in Debezium data change events sent to Apache Kafka. In this post we&#8217;re going to discuss different strategies for dealing with this situation.</p> </div> <div class="paragraph"> <p></p> </div> <div class="paragraph"> <p>When encountering an unchanged TOAST column value in the logical replication message received from the database, the Debezium Postgres connector will represent that value with a configurable placeholder. By default, that&#8217;s the literal <code>__debezium_unavailable_value</code>, but that value can be overridden using the <code>toasted.value.placeholder</code> connector property.</p> </div> <div class="paragraph"> <p>Let&#8217;s consider the following Postgres table definition as an example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-sql" data-lang="sql">CREATE TABLE customers (&#x000A;  id SERIAL NOT NULL PRIMARY KEY,&#x000A;  first_name VARCHAR(255) NOT NULL,&#x000A;  last_name VARCHAR(255) NOT NULL,&#x000A;  email VARCHAR(255) NOT NULL UNIQUE,&#x000A;  biography TEXT&#x000A;);</code></pre> </div> </div> <div class="paragraph"> <p>Here, the <code>biography TEXT</code> column is a TOAST-able column, as its value may exceed the page size limit. So when issuing an update such as <code>update inventory.customers set first_name = 'Dana' where id = 1004;</code>, you might receive a data change event in Apache Kafka which looks like this (assuming the table has the default replica identity):</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-json" data-lang="json">{&#x000A;  "before": null,&#x000A;  "after": {&#x000A;    "id": 1004,&#x000A;    "first_name": "Dana",&#x000A;    "last_name": "Kretchmar",&#x000A;    "email": "annek@noanswer.org",&#x000A;    "biography": "__debezium_unavailable_value"&#x000A;  },&#x000A;  "source": {&#x000A;    "version": "0.10.0.Final",&#x000A;    "connector": "postgresql",&#x000A;    "name": "dbserver1",&#x000A;    "ts_ms": 1570448151151,&#x000A;    "snapshot": "false",&#x000A;    "db": "sourcedb",&#x000A;    "schema": "inventory",&#x000A;    "table": "customers",&#x000A;    "txId": 627,&#x000A;    "lsn": 34650016,&#x000A;    "xmin": null&#x000A;  },&#x000A;  "op": "u",&#x000A;  "ts_ms": 1570448151611&#x000A;}</code></pre> </div> </div> <div class="paragraph"> <p>Note how the <code>biography</code> field (whose value hasn&#8217;t changed with the <code>UPDATE</code>) has the special <code>__debezium_unavailable_value</code> marker value. Now, if change event consumers receive that placeholder value, the question arises how they should react to this.</p> </div> <div class="paragraph"> <p>One way, and <strong>certainly the easiest</strong> from a consumer&#8217;s perspective, is to avoid the situation in the first place. This can be achieved by using a "replica identity" of <code>FULL</code> for the Postgres table in question. Alternatively, the replica identity can be based on an index which comprises the TOAST-able column.</p> </div> </div> </div> <div class="sect1"> <h2 id="excluding_unchanged_values"><a class="anchor" href="#excluding_unchanged_values"></a>Excluding Unchanged Values</h2> <div class="sectionbody"> <div class="paragraph"> <p>If changing the source table&#8217;s replica identity is not an option, one approach for consumers that update a sink datastore (e.g. a database, cache or search index) is to ignore any field of a change event which has the placeholder value.</p> </div> <div class="paragraph"> <p>This means that any column with the placeholder value must be omitted from the update statement executed on the sink datastore. E.g. in terms of a SQL database, an specific <code>UPDATE</code> statement must be built and executed which doesn&#8217;t contain the column(s) with the placeholder value. Users of Hibernate ORM may feel reminded of the "dynamic updates" feature which works similar. Some datastores and connectors might only support full updates, though, in which case this strategy isn&#8217;t viable.</p> </div> </div> </div> <div class="sect1"> <h2 id="triggers"><a class="anchor" href="#triggers"></a>Triggers</h2> <div class="sectionbody"> <div class="paragraph"> <p>One interesting variation of the "ignore" approach is the usage of triggers in the sink database: registered for the column that may receive the marker value, they can "veto" such change and just keep the previously stored value instead. The following shows an example of such a trigger in Postgres:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-sql" data-lang="sql">CREATE OR REPLACE FUNCTION ignore_unchanged_biography()&#x000A;  RETURNS TRIGGER AS&#x000A;$BODY$&#x000A;BEGIN&#x000A;  IF NEW."biography" = '__debezium_unavailable_value'&#x000A;  THEN&#x000A;    NEW."biography" = OLD."biography";&#x000A;  END IF;&#x000A;&#x000A;  RETURN NEW;&#x000A;END;&#x000A;$BODY$ LANGUAGE PLPGSQL;&#x000A;&#x000A;CREATE TRIGGER customer_biography_trigger&#x000A;BEFORE UPDATE OF "biography"&#x000A;  ON customers&#x000A;FOR EACH ROW&#x000A;EXECUTE PROCEDURE ignore_unchanged_biography();</code></pre> </div> </div> <div class="paragraph"> <p>This will keep the old value for the <code>biography</code> column if it were to be set to the <code>__debezium_unavailable_value</code> marker value.</p> </div> </div> </div> <div class="sect1"> <h2 id="stateful_stream_processing"><a class="anchor" href="#stateful_stream_processing"></a>Stateful Stream Processing</h2> <div class="sectionbody"> <div class="paragraph"> <p>An alternative approach to dealing with unchanged TOAST column values is a stateful stream processing application.</p> </div> <div class="paragraph"> <p>This application can persist the latest value of a TOAST column (as obtained from a snapshot, an insert event or an update including the TOAST-able column) in a state store and put the value back into change events with the marker value.</p> </div> <div class="paragraph"> <p>Debezium makes sure that all change events for one particular record always go into the same partition, so they they will be processed in the exact same order as they were created. This ensures that the latest value is available in the statestore when receiving a change event with the marker value.</p> </div> <div class="paragraph"> <p><a href="https://kafka.apache.org/documentation/streams/">Kafka Streams</a> with its state store API comes in very handy for building such a service. Based on <a href="https://quarkus.io/">Quarkus</a> and its extension for building <a href="https://quarkus.io/guides/kafka-streams-guide">Kafka Streams applications</a> running either on the JVM or natively via GraalVM, a solution could look like this:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-java" data-lang="java">@ApplicationScoped&#x000A;public class TopologyProducer {&#x000A;&#x000A;    private static final Logger LOG = LoggerFactory.getLogger(TopologyProducer.class);&#x000A;&#x000A;    static final String BIOGRAPHY_STORE = "biography-store";&#x000A;&#x000A;    @ConfigProperty(name = "pgtoast.customers.topic")&#x000A;    String customersTopic;&#x000A;&#x000A;    @ConfigProperty(name = "pgtoast.customers.enriched.topic")&#x000A;    String customersEnrichedTopic;&#x000A;&#x000A;    @Produces&#x000A;    public Topology buildTopology() {&#x000A;        StreamsBuilder builder = new StreamsBuilder();&#x000A;&#x000A;        StoreBuilder&lt;KeyValueStore&lt;JsonObject, String&gt;&gt; biographyStore = <i class="conum" data-value="1"></i><b>(1)</b>&#x000A;                Stores.keyValueStoreBuilder(&#x000A;                    Stores.persistentKeyValueStore(BIOGRAPHY_STORE),&#x000A;                    new JsonObjectSerde(),&#x000A;                    new Serdes.StringSerde()&#x000A;                );&#x000A;        builder.addStateStore(biographyStore);&#x000A;&#x000A;        builder.&lt;JsonObject, JsonObject&gt;stream(customersTopic) <i class="conum" data-value="2"></i><b>(2)</b>&#x000A;                .transformValues(ToastColumnValueProvider::new, BIOGRAPHY_STORE)&#x000A;                .to(customersEnrichedTopic);&#x000A;&#x000A;        return builder.build();&#x000A;    }&#x000A;&#x000A;    class ToastColumnValueProvider implements&#x000A;            ValueTransformerWithKey&lt;JsonObject, JsonObject, JsonObject&gt; {&#x000A;&#x000A;        private KeyValueStore&lt;JsonObject, String&gt; biographyStore;&#x000A;&#x000A;        @Override&#x000A;        @SuppressWarnings("unchecked")&#x000A;        public void init(ProcessorContext context) {&#x000A;            biographyStore = (KeyValueStore&lt;JsonObject, String&gt;) context.getStateStore(&#x000A;                TopologyProducer.BIOGRAPHY_STORE);&#x000A;        }&#x000A;&#x000A;        @Override&#x000A;        public JsonObject transform(JsonObject key, JsonObject value) {&#x000A;            JsonObject payload = value.getJsonObject("payload");&#x000A;            JsonObject newRowState = payload.getJsonObject("after");&#x000A;            String biography = newRowState.getString("biography");&#x000A;&#x000A;            if (isUnavailableValueMarker(biography)) { <i class="conum" data-value="3"></i><b>(3)</b>&#x000A;                String currentValue = biographyStore.get(key); <i class="conum" data-value="4"></i><b>(4)</b>&#x000A;&#x000A;                if (currentValue == null) {&#x000A;                    LOG.warn("No biography value found for key '{}'", key);&#x000A;                }&#x000A;                else {&#x000A;                    value = Json.createObjectBuilder(value) <i class="conum" data-value="5"></i><b>(5)</b>&#x000A;                        .add(&#x000A;                            "payload",&#x000A;                            Json.createObjectBuilder(payload)&#x000A;                                .add(&#x000A;                                    "after",&#x000A;                                    Json.createObjectBuilder(newRowState).add(&#x000A;                                        "biography",&#x000A;                                        currentValue&#x000A;                                    )&#x000A;                                )&#x000A;                        )&#x000A;                        .build();&#x000A;                }&#x000A;            }&#x000A;            else { <i class="conum" data-value="6"></i><b>(6)</b>&#x000A;                biographyStore.put(key, biography);&#x000A;            }&#x000A;&#x000A;            return value;&#x000A;        }&#x000A;&#x000A;        private boolean isUnavailableValueMarker(String value) {&#x000A;            return "__debezium_unavailable_value".contentEquals(value);&#x000A;        }&#x000A;&#x000A;        @Override&#x000A;        public void close() {&#x000A;        }&#x000A;    }&#x000A;}</code></pre> </div> </div> <div class="colist arabic"> <table> <tr> <td><i class="conum" data-value="1"></i><b>1</b></td> <td>Set up a state store for storing the latest <code>biography</code> value per customer id</td> </tr> <tr> <td><i class="conum" data-value="2"></i><b>2</b></td> <td>The actual streaming pipeline: for each message on the customers topic, apply the logic for replacing the TOAST column marker value and write the transformed message to an output topic</td> </tr> <tr> <td><i class="conum" data-value="3"></i><b>3</b></td> <td>Check whether the <code>biography</code> value from the incoming message is the marker</td> </tr> <tr> <td><i class="conum" data-value="4"></i><b>4</b></td> <td>If so, get the current <code>biography</code> value for the customer from the state store</td> </tr> <tr> <td><i class="conum" data-value="5"></i><b>5</b></td> <td>Replace the marker value with the actual value obtained from the state store</td> </tr> <tr> <td><i class="conum" data-value="6"></i><b>6</b></td> <td>If the incoming message has an actual <code>biography</code> value, put this to the state store</td> </tr> </table> </div> <div class="paragraph"> <p>Now, if a consumer subscribes to the "enriched" topic, it will see any customer change events with the actual value of any unchanged TOAST columns, as materialized from the state store. The fact that the Debezium connector originally emitted the special marker value, is fully transparent at that point.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="title">Primary Key Changes</div> <div class="paragraph"> <p>When a record&#8217;s primary key gets updated, Debezium will create two change events: one "delete" event using the old key and one "insert" event with the new key. When processing the second event, the stream processing application will not be able to look up the <code>biography</code> value stored earlier on, as it has been under the old key.</p> </div> <div class="paragraph"> <p>One way to address this would be to expose the original key value e.g. as a message header of the insert event. This requirement is tracked as <a href="https://issues.redhat.com/browse/DBZ-1531">DBZ-1531</a>; let us know if you&#8217;d like to contribute and implement this feature.</p> </div> </td> </tr> </table> </div> </div> </div> <div class="sect1"> <h2 id="when_to_use_what"><a class="anchor" href="#when_to_use_what"></a>When to Use What?</h2> <div class="sectionbody"> <div class="paragraph"> <p>We&#8217;ve discussed different options for dealing with unchanged TOAST column values in Debezium&#8217;s data change events. Which one should be used in which case then?</p> </div> <div class="paragraph"> <p>Changing the replica identity to <code>FULL</code> is the easiest approach by far: a single configuration to the source table avoids the problem to begin with. It&#8217;s not the most efficient solution, though, and some DBAs might be reluctant to apply this setting.</p> </div> <div class="paragraph"> <p>When using the change events to update some kind of sink data store, it may sound attractive at first to simply omit any field with the special marker value when issuing an update. But this technique has some downsides: not all data stores and the corresponding connectors might support partial updates. Instead there might only be the option to do full updates to a record in the sink data store based on the incoming data. Even when that option exists, it might be sub-optimal. E.g. for a SQL database, a statement just with the available values may be executed. This is at odds with efficient usage of prepared statements and batching, though: as the "shape" of the data may change between two updates to the same table, the same prepared statement cannot be re-used and performance may suffer.</p> </div> <div class="paragraph"> <p>The trigger-based approach isn&#8217;t prone to these problems: any updates to a table will have the same number of columns, so the consumer (e.g. a sink connector) may re-use the same prepared statement and batch multiple records into a single execution. One thing to be aware of is the organizational cost associated with this approach: triggers must be installed for each affected column and be kept in sync when table structures change. This must be done individually in each sink datastore, and not all stores have may have support for triggers to begin with. But where possible, triggers can be a great solution.</p> </div> <div class="paragraph"> <p>Finally, stream processing makes the usage of TOAST-able columns and the absence of their values in update events fully transparent to consumers. The enrichment logic is implemented in a single place, from which all the consumers of the change event stream benefit, without the need for individual solutions in each one of them. Also, it&#8217;s the only viable solution if consumers themselves are stateless and don&#8217;t have any way to materialize the last value of such column, e.g. when streaming change events to a browser via web sockets or GraphQL subscriptions. The price to pay is the overhead of maintaining and operating a separate service.</p> </div> <div class="paragraph"> <p>On a side note, such stream processing application might also be provided as a configurable, ready-to-use component coming as a part of the Debezium platform. This might be useful not only for Postgres, but also when thinking about other Debezium connectors. For instance, in case of Cassandra, change events will only ever contain the updated fields; a similar mode could be envisioned for MySQL by supporting its "non full" binlog mode. In both cases, a stateful stream processing service could be used to hydrate full data change events based on earlier row state retrieved from a local state store and an incoming "patch" style change event. If you think that&#8217;d be a useful addition to Debezium, please let us know.</p> </div> <div class="paragraph"> <p>As always, there are no silver bullets: you should choose a solution based on your specific situation and requirements. As a starting point you can find a basic implementation of the trigger and Kafka Streams approaches in the Debezium <a href="https://github.com/debezium/debezium-examples/tree/master/postgres-toast">examples repository</a>.</p> </div> <div class="paragraph"> <p>Which approach would you prefer? Or perhaps you have even further alternatives in mind? Tell us about it in the comments below.</p> </div> <div class="paragraph"> <p><em>Many thanks to <a href="https://twitter.com/dave_cramer/">Dave Cramer</a> and Jiri Pechanec for their feedback while working on this post and the accompanying example code!</em></p> </div> </div> </div> <div class="sect1"> <h2 id="about_debezium"><a class="anchor" href="#about_debezium"></a>About Debezium</h2> <div class="sectionbody"> <div class="paragraph"> <p>Debezium is an open source distributed platform that turns your existing databases into event streams, so applications can see and respond almost instantly to each committed row-level change in the databases. Debezium is built on top of <a href="http://kafka.apache.org/">Kafka</a> and provides <a href="http://kafka.apache.org/documentation.html#connect">Kafka Connect</a> compatible connectors that monitor specific database management systems. Debezium records the history of data changes in Kafka logs, so your application can be stopped and restarted at any time and can easily consume all of the events it missed while it was not running, ensuring that all events are processed correctly and completely. Debezium is <a href="/license/">open source</a> under the <a href="http://www.apache.org/licenses/LICENSE-2.0.html">Apache License, Version 2.0</a>.</p> </div> </div> </div> <div class="sect1"> <h2 id="get_involved"><a class="anchor" href="#get_involved"></a>Get involved</h2> <div class="sectionbody"> <div class="paragraph"> <p>We hope you find Debezium interesting and useful, and want to give it a try. Follow us on Twitter <a href="https://twitter.com/debezium">@debezium</a>, <a href="https://gitter.im/debezium/user">chat with us on Gitter</a>, or join our <a href="https://groups.google.com/forum/#!forum/debezium">mailing list</a> to talk with the community. All of the code is open source <a href="https://github.com/debezium/">on GitHub</a>, so build the code locally and help us improve ours existing connectors and add even more connectors. If you find problems or have ideas how we can improve Debezium, please let us know or <a href="https://issues.redhat.com/projects/DBZ/issues/">log an issue</a>.</p> </div> </div> </div> </div> </div> <div class="well"> <div class="row"> <div class="col-md-8"> <h2>Gunnar Morling</h2> <p> <span class="bio-size">Gunnar is a software engineer at Red Hat and open-source enthusiast by heart. A long-time Hibernate core team member, he's now the project lead of Debezium. Gunnar is the spec lead for Bean Validation 2.0 (JSR 380). Heâs based in Hamburg, Germany.</span> </p> <p class="bio-size"> <a href="https://twitter.com/gunnarmorling"> <i class="icon-twitter"></i> </a> &nbsp; <a href="https://github.com/gunnarmorling"> <i class="icon-github"></i> </a> &nbsp; </p> </div> <div class="col-md-4"> <img alt="" class="img-responsive pull-right portrait" src="/images/gmorling.jpg"> </div> </div> </div> <div class="comments"> <div id="disqus_thread"></div> <script type="text/javascript">
            var disqus_shortname = 'Debezium';
            var disqus_url = "https://debezium.io/blog/2019/10/08/handling-unchanged-postgres-toast-values/";
            var disqus_developer = null;
            var disqus_identifier = null;
            (function() {
              var dsq = document.createElement("script"); dsq.type = "text/javascript"; dsq.async = true;
              dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName("head")[0] || document.getElementsByTagName("body")[0]).appendChild(dsq);
            })();
            </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript=Debezium">comments powered by Disqus.</a></noscript> </div> </div> </div> </div> </div> <footer class="container"> <div class="row"> <div class="col-md-5 col-md-offset-1"> <h4>Debezium</h4> <p> &#169; 2020 Debezium Community <br> <br> <i class="icon-fire"></i> Mixed with <a href="http://twitter.github.com/bootstrap">Bootstrap</a>, baked by <a href="http://awestruct.org">Awestruct</a>. <br> <i class="icon-flag"></i> Website and docs licensed under <a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>. <br> <i class="icon-flag-alt"></i> Code released under <a href="http://www.apache.org/licenses/LICENSE-2.0.html">Apache License, v2.0</a>. <br> <i class="icon-file-alt"></i> <a href="https://www.redhat.com/legal/legal_statement.html" title="Terms">Terms</a> | <a href="https://www.redhat.com/legal/privacy_statement.html" title="Privacy Policy">Privacy</a> </p> </div> <div class="col-md-3"> <h4>Documentation</h4> <ul class="list-unstyled"> <li> <a href="/documentation/features" title="Features">Features</a> </li> <li> <a href="/documentation/install/stable/" title="Install">Install</a> </li> <li> <a href="/documentation/architecture/" title="Architecture">Architecture</a> </li> <li> <a href="/documentation/faq/" title="FAQ">FAQ</a> </li> <li> <a href="/community/contribute/" title="Contribute">Contribute</a> </li> </ul> </div> <div class="col-md-3"> <h4>Connect</h4> <ul class="list-unstyled"> <li> <a href="/blog" title="Blog">Blog</a> </li> <li> <a href="http://twitter.com/debezium" title="Twitter">Twitter</a> </li> <li> <a href="http://github.com/debezium" title="GitHub">GitHub</a> </li> <li> <a href="https://gitter.im/debezium/user" title="Chat">Chat</a> </li> <li> <a href="https://groups.google.com/forum/#!forum/debezium" title="Google Groups">Google Groups</a> </li> <li> <a href="http://stackoverflow.com/questions/tagged/debezium" title="StackOverflow">StackOverflow</a> </li> </ul> </div> </div> </footer> <div class="container" id="companyfooter"> <div class="redhatlogo"> <div id="logospacer"></div> <a href="https://www.redhat.com/"><img src="/images/Logo-Red_Hat-Sponsored_By-B-Standard-RGB.svg"></a> </div> </div> <span class="backToTop"> <a href="#top">back to top</a> </span> <script src="https://static.jboss.org/theme/js/libs/bootstrap-community/3.2.0.2/bootstrap-community.min.js"></script> <script type='text/javascript' language='JavaScript' src='https://www.redhat.com/j/elqNow/elqCfg.js'></script> <script type='text/javascript' language='JavaScript' src='https://www.redhat.com/j/elqNow/elqImg.js'></script> <div id="oTags"> <script type="text/javascript" src="//www.redhat.com/j/s_code.js"></script> <script type="text/javascript"><!--
  var coreUrl = encodeURI(document.URL.split("?")[0]).replace(/-/g," ");
  var urlSplit = coreUrl.toLowerCase().split(/\//);
  var urlLast = urlSplit[urlSplit.length-1];
  var pageNameString = "";
  var siteName = "";
  var minorSectionIndex = 3
  if (urlLast == "") {
      urlSplit.splice(-1,1);
  }
  if (urlLast.search(/\./) >= 0) {
      if (urlLast == "index.html") {
          urlSplit.splice(-1,1);
      }
      else {
          urlSplit[urlSplit.length-1] = urlLast.split(".").splice(0,1);
      }
  }
  siteName = urlSplit[2].split(".")[1];
  s.prop14 = s.eVar27 = siteName || "";
  s.prop15 = s.eVar28 = urlSplit[minorSectionIndex] || "";
  s.prop16 = s.eVar29 = urlSplit[minorSectionIndex+1] || "";
  pageNameString = urlSplit.splice(3).join(" | ");
  s.pageName = "jboss | community | " + siteName + " | " + pageNameString;
  s.server = "jboss";
  s.channel = "jboss | community";
  s.prop4 = s.eVar23 = encodeURI(document.URL);
  s.prop21 = s.eVar18 = coreUrl;
  s.prop2 = s.eVar22 = "en";
  s.prop3 = s.eVar19 = "us";
  //--></script> <script type="text/javascript" src="//www.redhat.com/j/rh_omni_footer.js"></script> <script language="JavaScript" type="text/javascript"><!--
  if(navigator.appVersion.indexOf('MSIE')>=0)document.write(unescape('%3C')+'\!-'+'-')
  //--></script> <noscript><a href="http://www.omniture.com" title="Web Analytics"><img src="https://smtrcs.redhat.com/b/ss/redhatcom,redhatglobal/1/H.25.4--NS/0?[AQB]&cdp=3&[AQE]" height="1" width="1" border="0" alt=""/></a></noscript> </div> <script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script> <script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-10656779-1");
pageTracker._trackPageview();
} catch(err) {}</script> <script>
 (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
 
ga('create', 'UA-76464546-1', 'auto');
ga('send', 'pageview');
ga('set', 'anonymizeIp', true);
ga('require', 'linkid', 'linkid.js');

</script> </div> </body> </html>