<!DOCTYPE html> <html> <head> <title>Understanding Non-Key Joins With the Quarkus Extension for Kafka Streams</title> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1"> <meta name="description" content="Debezium is an open source distributed platform for change data capture. Start it up, point it at your databases, and your apps can start responding to all of the inserts, updates, and deletes that other apps commit to your databases. Debezium is durable and fast, so your apps can respond quickly and never miss an event, even when things go wrong."> <meta content="Debezium" property="og:site_name"> <meta content="Understanding Non-Key Joins With the Quarkus Extension for Kafka Streams" property="og:title"> <meta content="https://debezium.io/assets/images/color_black_debezium_type_1200px.png" property="og:image" name="image"> <meta property="og:description" content="Debezium is an open source distributed platform for change data capture. Start it up, point it at your databases, and your apps can start responding to all of the inserts, updates, and deletes that other apps commit to your databases. Debezium is durable and fast, so your apps can respond quickly and never miss an event, even when things go wrong."> <meta property="og:url" content="https://debezium.io/blog/2021/03/18/understanding-non-key-joins-with-quarkus-extension-for-kafka-streams/"> <meta name="twitter:site" content="@debezium"> <meta name="twitter:title" content="Understanding Non-Key Joins With the Quarkus Extension for Kafka Streams"> <meta name="twitter:creator" content="@anmohant"> <meta name="twitter:description" content="Debezium is an open source distributed platform for change data capture. Start it up, point it at your databases, and your apps can start responding to all of the inserts, updates, and deletes that other apps commit to your databases. Debezium is durable and fast, so your apps can respond quickly and never miss an event, even when things go wrong."> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:image" content="https://debezium.io/assets/images/color_black_debezium_type_1200px.png"> <meta property="twitter:url" content="https://debezium.io/blog/2021/03/18/understanding-non-key-joins-with-quarkus-extension-for-kafka-streams/"> <link rel="alternate" type="application/rss+xml" title="Debezium Blog" href="/blog.atom"> <link rel="shortcut icon" type="image/png" href="/favicon.ico"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css"/> <link rel="stylesheet" href="/assets/css/custom.css"/> <link rel="stylesheet" href="/assets/css/highlight.min.css"/> <link rel="stylesheet" href="/assets/css/coderay.css"/> </head> <body class="post"> <div id="rhbar"> <a class="jbdevlogo" href="https://developers.redhat.com"></a> <a class="rhlogo" href="https://www.redhat.com/"></a> </div> <div id> <div class="container" id="content"> <nav class="navbar navbar-inverse navbar-fix"> <div class="container-fluid"> <div class="navbar-header"> <button class="navbar-toggle collapsed border-0" type="button" data-toggle="collapse" data-target="#navigation" aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href="/"><img class="project-logo" src="/assets/images/color_white_debezium_type_600px.svg" style="height: 32px; margin-right: 5px; margin-top: -5px;"></a> </div> <div class="collapse navbar-collapse collapsed" id="navigation"> <ul class="nav navbar-nav pull-right"> <li> <a href="/documentation/faq" class="">FAQ</a> </li> <li class="item"> <a href="/documentation/" class="">Documentation</a> </li> <li> <a href="/releases/" class="">Releases</a> </li> <li> <a href="/community/" class="">Community</a> </li> <li class="active"> <a href="/blog/" class="active">Blog</a> </li> </ul> </div> </div> </nav> <div class="row post-text-padding row-no-expand"> <div class="col-md-3"><div id="leftdocnav"> <div class="hidden-lg hidden-md hidden-sm"> <button class="navbar-toggle docssubmenu-toggle collapsed" data-target="#docssubmenu" data-toggle="collapse" style=" float: none; background-color: #656565; border-color: #656565; width: 100%; color: #fff; "> Navigation Menu </button> </div> <div class="collapse" id="docssubmenu"> <div class="doc-pills"> <ul class="nav nav-pills nav-stacked"> <li class="item"> <a href="/blog">Home</a> <div class="icon"><span class="icon-home"></span></div> </li> <li class="item"> <a href="/archives">Archive</a> <div class="icon"><span class="icon-arrow-down"></span></div> </li> <li class="item"> <a href="/blog.atom">Feed</a> <div class="icon"><span class="icon-rss"></span></div> </li> </ul> </div> <p></p> <div class="featured-posts"> <div id="#featured" style="margin-bottom: 4px; border-bottom: 1px solid #ccc; font-size: 115%; margin-left: 2px;">Featured Posts</div> <ul style="padding-inline-start: 22px;"> <li style="margin-bottom: 3px;"> <a href="/blog/2024/07/08/async-embedded-engine/" style="font-size: 95%;"> Debezium asynchronous engine </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2024/01/11/Debezium-and-TimescaleDB/" style="font-size: 95%;"> Debezium and TimescaleDB </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2023/12/20/JDBC-sink-connector-batch-support/" style="font-size: 95%;"> Streamlined Performance: Debezium JDBC connector batch support </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2023/10/19/Debezium-Operator-Takes-off-to-the-Clouds/" style="font-size: 95%;"> Debezium Operator Takes off to the Clouds </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2023/10/05/Debezium-JMX-signaling-and-notifications/" style="font-size: 95%;"> Debezium signaling and notifications - Part 3: JMX channel </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2023/09/23/flink-spark-online-learning/" style="font-size: 95%;"> Online machine learning with the data streams from the database </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2023/07/10/custom-http-signaling-notification/" style="font-size: 95%;"> Debezium signaling and notifications - Part 2: Customisation </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2023/06/27/Debezium-signaling-and-notifications/" style="font-size: 95%;"> Debezium signaling and notifications - Part 1 </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2023/05/02/tensorflow-mnist-classification/" style="font-size: 95%;"> Image classification with Debezium and TensorFlow </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2020/11/04/streaming-vitess-at-bolt/" style="font-size: 95%;"> Streaming Vitess at Bolt </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2020/02/10/event-sourcing-vs-cdc/" style="font-size: 95%;"> Distributed Data for Microservices â€” Event Sourcing vs. Change Data Capture </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2019/10/01/audit-logs-with-change-data-capture-and-stream-processing/" style="font-size: 95%;"> Building Audit Logs with Change Data Capture and Stream Processing </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2019/07/12/streaming-cassandra-at-wepay-part-1/" style="font-size: 95%;"> Streaming Cassandra at WePay - Part 1 </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2019/02/19/reliable-microservices-data-exchange-with-the-outbox-pattern/" style="font-size: 95%;"> Reliable Microservices Data Exchange With the Outbox Pattern </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/12/05/automating-cache-invalidation-with-change-data-capture/" style="font-size: 95%;"> Automating Cache Invalidation With Change Data Capture </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/09/20/materializing-aggregate-views-with-hibernate-and-debezium/" style="font-size: 95%;"> Materializing Aggregate Views With Hibernate and Debezium </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/07/19/advantages-of-log-based-change-data-capture/" style="font-size: 95%;"> Five Advantages of Log-Based Change Data Capture </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/03/08/creating-ddd-aggregates-with-debezium-and-kafka-streams/" style="font-size: 95%;"> Creating DDD aggregates with Debezium and Kafka Streams </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/01/17/streaming-to-elasticsearch/" style="font-size: 95%;"> Streaming Data Changes from Your Database to Elasticsearch </a> </li> </ul> </div> <p></p> <p></p> <div class="cloud-tags"> <div id="tags" style="margin-bottom: 4px; border-bottom: 1px solid #ccc; font-size: 115%; margin-left: 2px;"> Tags </div> <div class="tag-cloud"> <span class="site-tag"> <a href="/tag/apache-kafka/" style="font-size: 82%"> apache kafka </a> </span> <span class="site-tag"> <a href="/tag/apache-kafka/" style="font-size: 96%"> apache kafka </a> </span> <span class="site-tag"> <a href="/tag/apicurio/" style="font-size: 82%"> apicurio </a> </span> <span class="site-tag"> <a href="/tag/avro/" style="font-size: 84%"> avro </a> </span> <span class="site-tag"> <a href="/tag/aws/" style="font-size: 82%"> aws </a> </span> <span class="site-tag"> <a href="/tag/batch/" style="font-size: 82%"> batch </a> </span> <span class="site-tag"> <a href="/tag/caassandra/" style="font-size: 86%"> caassandra </a> </span> <span class="site-tag"> <a href="/tag/camel/" style="font-size: 82%"> camel </a> </span> <span class="site-tag"> <a href="/tag/cassandra/" style="font-size: 306%"> cassandra </a> </span> <span class="site-tag"> <a href="/tag/cdc/" style="font-size: 82%"> cdc </a> </span> <span class="site-tag"> <a href="/tag/channels/" style="font-size: 82%"> channels </a> </span> <span class="site-tag"> <a href="/tag/community/" style="font-size: 124%"> community </a> </span> <span class="site-tag"> <a href="/tag/community-stories/" style="font-size: 84%"> community stories </a> </span> <span class="site-tag"> <a href="/tag/connectors/" style="font-size: 82%"> connectors </a> </span> <span class="site-tag"> <a href="/tag/containers/" style="font-size: 82%"> containers </a> </span> <span class="site-tag"> <a href="/tag/cqrs/" style="font-size: 84%"> cqrs </a> </span> <span class="site-tag"> <a href="/tag/custom/" style="font-size: 82%"> custom </a> </span> <span class="site-tag"> <a href="/tag/datalake/" style="font-size: 82%"> datalake </a> </span> <span class="site-tag"> <a href="/tag/db2/" style="font-size: 290%"> db2 </a> </span> <span class="site-tag"> <a href="/tag/ddd/" style="font-size: 82%"> ddd </a> </span> <span class="site-tag"> <a href="/tag/debezium/" style="font-size: 108%"> debezium </a> </span> <span class="site-tag"> <a href="/tag/debezium-server/" style="font-size: 94%"> debezium server </a> </span> <span class="site-tag"> <a href="/tag/debezium-ui/" style="font-size: 90%"> debezium ui </a> </span> <span class="site-tag"> <a href="/tag/deduplication/" style="font-size: 82%"> deduplication </a> </span> <span class="site-tag"> <a href="/tag/discussion/" style="font-size: 114%"> discussion </a> </span> <span class="site-tag"> <a href="/tag/docker/" style="font-size: 188%"> docker </a> </span> <span class="site-tag"> <a href="/tag/elasticsearch/" style="font-size: 82%"> elasticsearch </a> </span> <span class="site-tag"> <a href="/tag/event-sourcing/" style="font-size: 82%"> event sourcing </a> </span> <span class="site-tag"> <a href="/tag/exactly-once-semantics/" style="font-size: 82%"> exactly once semantics </a> </span> <span class="site-tag"> <a href="/tag/example/" style="font-size: 88%"> example </a> </span> <span class="site-tag"> <a href="/tag/examples/" style="font-size: 118%"> examples </a> </span> <span class="site-tag"> <a href="/tag/features/" style="font-size: 94%"> features </a> </span> <span class="site-tag"> <a href="/tag/fedora/" style="font-size: 82%"> fedora </a> </span> <span class="site-tag"> <a href="/tag/flink/" style="font-size: 84%"> flink </a> </span> <span class="site-tag"> <a href="/tag/hiring/" style="font-size: 84%"> hiring </a> </span> <span class="site-tag"> <a href="/tag/ibmi/" style="font-size: 114%"> ibmi </a> </span> <span class="site-tag"> <a href="/tag/iceberg/" style="font-size: 82%"> iceberg </a> </span> <span class="site-tag"> <a href="/tag/images/" style="font-size: 82%"> images </a> </span> <span class="site-tag"> <a href="/tag/informix/" style="font-size: 124%"> informix </a> </span> <span class="site-tag"> <a href="/tag/integration/" style="font-size: 86%"> integration </a> </span> <span class="site-tag"> <a href="/tag/introduction/" style="font-size: 84%"> introduction </a> </span> <span class="site-tag"> <a href="/tag/jaeger/" style="font-size: 82%"> jaeger </a> </span> <span class="site-tag"> <a href="/tag/jdbc/" style="font-size: 126%"> jdbc </a> </span> <span class="site-tag"> <a href="/tag/json/" style="font-size: 82%"> json </a> </span> <span class="site-tag"> <a href="/tag/kafka/" style="font-size: 94%"> kafka </a> </span> <span class="site-tag"> <a href="/tag/kafka-streams/" style="font-size: 82%"> kafka streams </a> </span> <span class="site-tag"> <a href="/tag/kafka-streams/" style="font-size: 86%"> kafka streams </a> </span> <span class="site-tag"> <a href="/tag/kogito/" style="font-size: 82%"> kogito </a> </span> <span class="site-tag"> <a href="/tag/ksql/" style="font-size: 82%"> ksql </a> </span> <span class="site-tag"> <a href="/tag/kubernetes/" style="font-size: 86%"> kubernetes </a> </span> <span class="site-tag"> <a href="/tag/lakehouse/" style="font-size: 82%"> lakehouse </a> </span> <span class="site-tag"> <a href="/tag/machine-learning/" style="font-size: 86%"> machine learning </a> </span> <span class="site-tag"> <a href="/tag/mariadb/" style="font-size: 122%"> mariadb </a> </span> <span class="site-tag"> <a href="/tag/microservices/" style="font-size: 84%"> microservices </a> </span> <span class="site-tag"> <a href="/tag/mongo/" style="font-size: 86%"> mongo </a> </span> <span class="site-tag"> <a href="/tag/mongodb/" style="font-size: 308%"> mongodb </a> </span> <span class="site-tag"> <a href="/tag/mysql/" style="font-size: 444%"> mysql </a> </span> <span class="site-tag"> <a href="/tag/news/" style="font-size: 112%"> news </a> </span> <span class="site-tag"> <a href="/tag/newsletter/" style="font-size: 88%"> newsletter </a> </span> <span class="site-tag"> <a href="/tag/notifications/" style="font-size: 86%"> notifications </a> </span> <span class="site-tag"> <a href="/tag/online-learning/" style="font-size: 84%"> online learning </a> </span> <span class="site-tag"> <a href="/tag/operator/" style="font-size: 84%"> operator </a> </span> <span class="site-tag"> <a href="/tag/oracle/" style="font-size: 340%"> oracle </a> </span> <span class="site-tag"> <a href="/tag/outbox/" style="font-size: 278%"> outbox </a> </span> <span class="site-tag"> <a href="/tag/performance/" style="font-size: 82%"> performance </a> </span> <span class="site-tag"> <a href="/tag/postgres/" style="font-size: 414%"> postgres </a> </span> <span class="site-tag"> <a href="/tag/presentation/" style="font-size: 84%"> presentation </a> </span> <span class="site-tag"> <a href="/tag/production/" style="font-size: 82%"> production </a> </span> <span class="site-tag"> <a href="/tag/quarkus/" style="font-size: 92%"> quarkus </a> </span> <span class="site-tag"> <a href="/tag/questdb/" style="font-size: 82%"> questdb </a> </span> <span class="site-tag"> <a href="/tag/rds/" style="font-size: 84%"> rds </a> </span> <span class="site-tag"> <a href="/tag/releases/" style="font-size: 426%"> releases </a> </span> <span class="site-tag"> <a href="/tag/schema/" style="font-size: 82%"> schema </a> </span> <span class="site-tag"> <a href="/tag/scylla/" style="font-size: 82%"> scylla </a> </span> <span class="site-tag"> <a href="/tag/secrets/" style="font-size: 82%"> secrets </a> </span> <span class="site-tag"> <a href="/tag/sentry/" style="font-size: 82%"> sentry </a> </span> <span class="site-tag"> <a href="/tag/serialization/" style="font-size: 82%"> serialization </a> </span> <span class="site-tag"> <a href="/tag/signaling/" style="font-size: 86%"> signaling </a> </span> <span class="site-tag"> <a href="/tag/smt/" style="font-size: 84%"> smt </a> </span> <span class="site-tag"> <a href="/tag/snapshots/" style="font-size: 84%"> snapshots </a> </span> <span class="site-tag"> <a href="/tag/spanner/" style="font-size: 166%"> spanner </a> </span> <span class="site-tag"> <a href="/tag/spark/" style="font-size: 84%"> spark </a> </span> <span class="site-tag"> <a href="/tag/sql/" style="font-size: 84%"> sql </a> </span> <span class="site-tag"> <a href="/tag/sqlserver/" style="font-size: 354%"> sqlserver </a> </span> <span class="site-tag"> <a href="/tag/tensorflow/" style="font-size: 82%"> tensorflow </a> </span> <span class="site-tag"> <a href="/tag/testcontainers/" style="font-size: 88%"> testcontainers </a> </span> <span class="site-tag"> <a href="/tag/tests/" style="font-size: 82%"> tests </a> </span> <span class="site-tag"> <a href="/tag/time-series/" style="font-size: 82%"> time series </a> </span> <span class="site-tag"> <a href="/tag/timescaledb/" style="font-size: 82%"> timescaledb </a> </span> <span class="site-tag"> <a href="/tag/topics/" style="font-size: 82%"> topics </a> </span> <span class="site-tag"> <a href="/tag/tracing/" style="font-size: 82%"> tracing </a> </span> <span class="site-tag"> <a href="/tag/transactions/" style="font-size: 82%"> transactions </a> </span> <span class="site-tag"> <a href="/tag/ui/" style="font-size: 82%"> ui </a> </span> <span class="site-tag"> <a href="/tag/vagrant/" style="font-size: 82%"> vagrant </a> </span> <span class="site-tag"> <a href="/tag/vitess/" style="font-size: 270%"> vitess </a> </span> <span class="site-tag"> <a href="/tag/website/" style="font-size: 84%"> website </a> </span> </div> </div> </div> </div> </div> <div class="col-md-9"> <div class="post"> <div class="row" style="margin-left: 0; margin-right: 0; margin-bottom: 10px"> <div class="col-sm-12" style="padding-left: 0px"> <div style="display: table-cell; vertical-align: top"> <div style=" width: 72px; border: 1px solid #ccc; padding: 3px; display: inline-block; "> <img src="/assets/images/anmohant.jpeg" style="width: 64px;"> </div> </div> <div style="display: table-cell; vertical-align: top"> <div style="margin-left: 8px"> <span class="hidden-sm hidden-xs" style="font-size: 2.75rem; line-height: 1"> <a href="/blog/2021/03/18/understanding-non-key-joins-with-quarkus-extension-for-kafka-streams/">Understanding Non-Key Joins With the Quarkus Extension for Kafka Streams</a> </span> <span class="hidden-md hidden-lg" style="font-size: 2rem; line-height: 1"> <a href="/blog/2021/03/18/understanding-non-key-joins-with-quarkus-extension-for-kafka-streams/">Understanding Non-Key Joins With the Quarkus Extension for Kafka Streams</a> </span> <div class="byline" style="line-height: 1"> <em> March 18, 2021 by </em> <em> Anisha Mohanty </em> <div class="hidden-xs" style="margin-top: 5px"> <a class="label label-info hidden-sm hidden-xs" href="/tag/kafka streams/">kafka streams</a> <a class="label label-info hidden-sm hidden-xs" href="/tag/quarkus/">quarkus</a> <a class="label label-info hidden-sm hidden-xs" href="/tag/examples/">examples</a> </div> </div> </div> </div> </div> </div> <div class="grid__item width-12-12"><div class="paragraph"> <p><a href="https://kafka.apache.org/documentation/streams/">Kafka Streams</a> is a library for developing stream processing applications based on Apache Kafka. Quoting its docs, "a Kafka Streams application processes record streams through a topology in real-time, processing data continuously, concurrently, and in a record-by-record manner". The Kafka Streams DSL provides a range of stream processing operations such as a map, filter, join, and aggregate.</p> </div> <div class="sect1"> <h2 id="non_key_joins_in_kafka_streams">Non-Key Joins in Kafka Streams</h2> <div class="sectionbody"> <div class="paragraph"> <p>Debeziumâ€™s CDC source connectors make it easy to capture data changes in databases and push them towards sink systems such as Elasticsearch in near real-time. By default, this results in a 1:1 relationship between tables in the source database, the corresponding Kafka topics, and a representation of the data at the sink side, such as a search index in Elasticsearch.</p> </div> <div class="paragraph"> <p>In case of 1:n relationships, say between a table of customers and a table of addresses, consumers often are interested in a view of the data that is a single, nested data structure, e.g. a single Elasticsearch document representing a customer and all their addresses.</p> </div> <div class="paragraph"> <p>This is where <a href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-213+Support+non-key+joining+in+KTable">KIP-213</a> ("Kafka Improvement Proposal") and its foreign key joining capabilities come in: it was introduced in <a href="https://kafka.apache.org">Apache Kafka</a> 2.4 "to close the gap between the semantics of KTables in streams and tables in relational databases". Before KIP-213, in order to join messages from two Debezium change event topics, you&#8217;d typically have to manually re-key at least one of the topics, so to make sure the same key is used on both sides of the join.</p> </div> <div class="paragraph"> <p>Thanks to KIP-213, this isn&#8217;t needed any longer, as it allows to join two Kafka topics on fields extracted from the Kafka message value, taking care of the required re-keying automatically, in a fully transparent way. Comparing to <a href="/blog/2018/03/08/creating-ddd-aggregates-with-debezium-and-kafka-streams/">previous approaches</a>, this drastically reduces the effort for creating aggregated events from Debeziumâ€™s CDC events.</p> </div> <div class="paragraph"> <p></p> </div> <div class="paragraph"> <p>Non-key joins or rather <a href="https://kafka.apache.org/27/documentation/streams/developer-guide/dsl-api.html#ktable-ktable-fk-join">foreign-key joins</a> are analogous to joins in SQL such as the following:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> * <span class="keyword">FROM</span> CUSTOMER <span class="keyword">JOIN</span> ADDRESS <span class="keyword">ON</span> CUSTOMER.ID = ADDRESS.CUSTOMER_ID</code></pre> </div> </div> <div class="paragraph"> <p>In Kafka Streams terms, the output of such join is a new <code>KTable</code> containing the join result.</p> </div> </div> </div> <div class="sect1"> <h2 id="database_overview">Database Overview</h2> <div class="sectionbody"> <div class="paragraph"> <p>Sticking to our earlier example of customers and address, let&#8217;s consider an application with the following data model:</p> </div> <div class="imageblock centered-image"> <img src="/assets/images/kstreams_db_diagram.jpg" class="responsive-image" alt="Database Overview"> </div> <div class="paragraph"> <p>The two entities, customer and address, share a foreign key relationship from address to customer, i.e. a customer can have multiple addresses. As stated above, by default Debezium will emit events for each table on distinct topics. Using Kafka Streams, the change event topics for both tables will be loaded into two <code>KTable</code>s, which are joined on the customer id. The Kafka Streams application is going to process data from the two Kafka topics. Whenever there&#8217;s a new CDC event on either topic&#8201;&#8212;&#8201;triggered by the insertion, update, or deletion of a record&#8201;&#8212;&#8201;the join will be re-executed.</p> </div> <div class="paragraph"> <p>As a runtime for the Kafka Streams application, we&#8217;re going to use <a href="https://quarkus.io/">Quarkus</a>, a stack for building cloud-native microservices, which (amongst many others) also provides an <a href="https://quarkus.io/guides/kafka-streams">extension</a> for Kafka Streams. While it&#8217;s general possible to run a Kafka Streams topology via a plain <code>main()</code> method, using Quarkus and this extension as a foundation has a number of advantages:</p> </div> <div class="ulist"> <ul> <li> <p>Management of the topology (e.g. waiting for all input topics to be created)</p> </li> <li> <p>Configurability via environment variables, system properties etc.</p> </li> <li> <p>Exposing health checks</p> </li> <li> <p>Exposing metrics</p> </li> <li> <p><em>Dev Mode</em>, a way of working on the stream topology with automatic hot code replacement after code changes</p> </li> <li> <p>Support for executing the Kafka Streams pipeline as a native binary via <a href="https://www.graalvm.org/">GraalVM</a>, resulting in a signficantly reduced memory consumption and start-up times</p> </li> </ul> </div> <div class="imageblock centered-image"> <img src="/assets/images/kstreams_change_event_overview.png" class="responsive-image" alt="Change Event Overview"> </div> <div class="paragraph"> <p>This picture shows an overview of our solution.</p> </div> </div> </div> <div class="sect1"> <h2 id="creating_an_application_using_the_quarkus_kafka_streams_extension">Creating an Application using the Quarkus Kafka Streams Extension</h2> <div class="sectionbody"> <div class="paragraph"> <p>To create a new Quarkus project with the Kafka Streams extension, run the following:</p> </div> <div class="listingblock"> <div class="content"> <pre>mvn io.quarkus:quarkus-maven-plugin:1.12.2.Final:create \
    -DprojectGroupId=org.acme \
    -DprojectArtifactId=customer-addresses-aggregator \
    -Dextensions="kafka-streams"
cd customer-addresses-aggregator</pre> </div> </div> <div class="sect2"> <h3 id="understanding_the_stream_processing_topology">Understanding the Stream Processing Topology</h3> <div class="paragraph"> <p>We have an aggregator application that will read from the two Kafka topics and process them in a streaming pipeline:</p> </div> <div class="ulist"> <ul> <li> <p>the two topics are joined on customer id</p> </li> <li> <p>each customer is enriched with its addresses</p> </li> <li> <p>this aggregated data is written out to a third topic, <code>customersWithAddressesTopic</code></p> </li> </ul> </div> <div class="paragraph"> <p>When using the Quarkus extension for Kafka Streams, all we need to do for that is to declare a <a href="http://www.cdi-spec.org/">CDI producer method</a>, which returns the topology of our stream processing application. This method must be annotated with <code>@Produces</code>, and it must return a <code>Topology</code> instance. The Quarkus extension is responsible for configuring, starting, and stopping the Kafka Streams engine. Now let&#8217;s take a look at the actual streaming query implementation itself.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ApplicationScoped</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">TopologyProducer</span> {

    <span class="annotation">@ConfigProperty</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">customers.topic</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="predefined-type">String</span> customersTopic;

    <span class="annotation">@ConfigProperty</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">addresses.topic</span><span class="delimiter">&quot;</span></span>)
    <span class="predefined-type">String</span> addressesTopic;

    <span class="annotation">@ConfigProperty</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">customers.with.addresses.topic</span><span class="delimiter">&quot;</span></span>)
    <span class="predefined-type">String</span> customersWithAddressesTopic;

    <span class="annotation">@Produces</span>
    <span class="directive">public</span> Topology buildTopology() {
        StreamsBuilder builder = <span class="keyword">new</span> StreamsBuilder(); <i class="conum" data-value="2"></i><b>(2)</b>

        Serde&lt;<span class="predefined-type">Long</span>&gt; adressKeySerde = DebeziumSerdes.payloadJson(<span class="predefined-type">Long</span>.class);
        adressKeySerde.configure(<span class="predefined-type">Collections</span>.emptyMap(), <span class="predefined-constant">true</span>);
        Serde&lt;Address&gt; addressSerde = DebeziumSerdes.payloadJson(Address.class);
        addressSerde.configure(<span class="predefined-type">Collections</span>.singletonMap(<span class="string"><span class="delimiter">&quot;</span><span class="content">from.field</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">after</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>);

        Serde&lt;<span class="predefined-type">Integer</span>&gt; customersKeySerde = DebeziumSerdes.payloadJson(<span class="predefined-type">Integer</span>.class);
        customersKeySerde.configure(<span class="predefined-type">Collections</span>.emptyMap(), <span class="predefined-constant">true</span>);
        Serde&lt;Customer&gt; customersSerde = DebeziumSerdes.payloadJson(Customer.class);
        customersSerde.configure(<span class="predefined-type">Collections</span>.singletonMap(<span class="string"><span class="delimiter">&quot;</span><span class="content">from.field</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">after</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>);

        JsonbSerde&lt;AddressAndCustomer&gt; addressAndCustomerSerde =
                <span class="keyword">new</span> JsonbSerde&lt;&gt;(AddressAndCustomer.class); <i class="conum" data-value="3"></i><b>(3)</b>
        JsonbSerde&lt;CustomerWithAddresses&gt; customerWithAddressesSerde =
                <span class="keyword">new</span> JsonbSerde&lt;&gt;(CustomerWithAddresses.class);

        KTable&lt;<span class="predefined-type">Long</span>, Address&gt; addresses = builder.table( <i class="conum" data-value="4"></i><b>(4)</b>
                addressesTopic,
                Consumed.with(adressKeySerde, addressSerde)
        );

        KTable&lt;<span class="predefined-type">Integer</span>, Customer&gt; customers = builder.table(
                customersTopic,
                Consumed.with(customersKeySerde, customersSerde)
        );

        KTable&lt;<span class="predefined-type">Integer</span>, CustomerWithAddresses&gt; customersWithAddresses = addresses.join( <i class="conum" data-value="5"></i><b>(5)</b>
                customers,
                address -&gt; address.customer_id,
                AddressAndCustomer::<span class="keyword">new</span>,
                Materialized.with(Serdes.Long(), addressAndCustomerSerde)
            )
            .groupBy( <i class="conum" data-value="6"></i><b>(6)</b>
                (addressId, addressAndCustomer) -&gt; KeyValue.pair(
                        addressAndCustomer.customer.id, addressAndCustomer),
                Grouped.with(Serdes.Integer(), addressAndCustomerSerde)
            )
            .aggregate( <i class="conum" data-value="7"></i><b>(7)</b>
                CustomerWithAddresses::<span class="keyword">new</span>,
                (customerId, addressAndCustomer, aggregate) -&gt; aggregate.addAddress(
                        addressAndCustomer),
                (customerId, addressAndCustomer, aggregate) -&gt; aggregate.removeAddress(
                        addressAndCustomer),
                Materialized.with(Serdes.Integer(), customerWithAddressesSerde)
            );

        customersWithAddresses.toStream() <i class="conum" data-value="8"></i><b>(8)</b>
        .to(
                customersWithAddressesTopic,
                Produced.with(Serdes.Integer(), customerWithAddressesSerde)
        );

        <span class="keyword">return</span> builder.build();
    }
}</code></pre> </div> </div> <div class="colist arabic"> <table> <tr> <td><i class="conum" data-value="1"></i><b>1</b></td> <td>The topic names are injected using the <a href="https://microprofile.io/project/eclipse/microprofile-config">MicroProfile Config API</a>, with the values being provided in the Quarkus <code>application.properties</code> configuration file (they could be overridden using environment variables for instance)</td> </tr> <tr> <td><i class="conum" data-value="2"></i><b>2</b></td> <td>Create an instance of <code>StreamsBuilder</code>, which helps us to build our topology</td> </tr> <tr> <td><i class="conum" data-value="3"></i><b>3</b></td> <td>For serializing and deserializing Java types used in the streaming pipeline into/from JSON, Quarkus provides the <code>class io.quarkus.kafka.client.serialization.JsonbSerde</code>; The Serde implementation based is on <a href="https://github.com/quarkusio/quarkus/blob/main/extensions/kafka-client/runtime/src/main/java/io/quarkus/kafka/client/serialization/JsonbSerde.java">JSON-B</a></td> </tr> <tr> <td><i class="conum" data-value="4"></i><b>4</b></td> <td>The <code>KTable</code>-<code>KTable</code> foreign-key join functionality is used to extract the <code>customer#id</code> and perform the join; <code>StreamsBuilder#table()</code> is used to read the two Kafka topics into the KTable <code>addresses</code> and <code>customers</code>, respectively</td> </tr> <tr> <td><i class="conum" data-value="5"></i><b>5</b></td> <td>The message from the <code>addresses</code> topic is joined with the corresponding <code>customers</code> topic; the join result contains the data of the customer with one of their addresses</td> </tr> <tr> <td><i class="conum" data-value="6"></i><b>6</b></td> <td><code>groupBy()</code> operation will have the records to be grouped by <code>customer#id</code></td> </tr> <tr> <td><i class="conum" data-value="7"></i><b>7</b></td> <td>To produce the nested structure of one customer and all their addresses, the <code>aggregate()</code> operation is applied to each group of records (customer-address tuples), updating a <code>CustomerWithAddresses</code> per customer</td> </tr> <tr> <td><i class="conum" data-value="8"></i><b>8</b></td> <td>The results of the pipeline are written out to the <code>customersWithAddressesTopic</code> topic</td> </tr> </table> </div> <div class="paragraph"> <p>The <code>CustomerWithAddresses</code> class keeps track of the aggregated values while the events are processed in the streaming pipeline.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">CustomerWithAddresses</span> {

    <span class="directive">public</span> Customer customer;
    <span class="directive">public</span> <span class="predefined-type">List</span>&lt;Address&gt; addresses = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

    <span class="directive">public</span> CustomerWithAddresses addAddress(AddressAndCustomer addressAndCustomer) {

        customer = addressAndCustomer.customer;
        addresses.add(addressAndCustomer.address);

        <span class="keyword">return</span> <span class="local-variable">this</span>;
    }

    <span class="directive">public</span> CustomerWithAddresses removeAddress(AddressAndCustomer addressAndCustomer) {

        <span class="predefined-type">Iterator</span>&lt;Address&gt; it = addresses.iterator();
        <span class="keyword">while</span> (it.hasNext()) {
            Address a = it.next();
            <span class="keyword">if</span> (a.id == addressAndCustomer.address.id) {
                it.remove();
                <span class="keyword">break</span>;
            }
        }

        <span class="keyword">return</span> <span class="local-variable">this</span>;
    }
}</code></pre> </div> </div> <div class="paragraph"> <p>The Kafka Streams extension is configured via the Quarkus configuration file <code>application.properties</code>. Along with the topic names, this file also has the information about the Kafka bootstrap server and several streams options:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="properties">customers.topic=dbserver1.inventory.customers
addresses.topic=dbserver1.inventory.addresses
customers.with.addresses.topic=customers-with-addresses

quarkus.kafka-streams.bootstrap-servers=localhost:9092
quarkus.kafka-streams.application-id=kstreams-fkjoin-aggregator
quarkus.kafka-streams.application-server=${hostname}:8080
quarkus.kafka-streams.topics=${customers.topic},${addresses.topic}

# streams options
kafka-streams.cache.max.bytes.buffering=10240
kafka-streams.commit.interval.ms=1000
kafka-streams.metadata.max.age.ms=500
kafka-streams.auto.offset.reset=earliest
kafka-streams.metrics.recording.level=DEBUG
kafka-streams.consumer.session.timeout.ms=150
kafka-streams.consumer.heartbeat.interval.ms=100</code></pre> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="building_and_running_the_application">Building and Running the Application</h2> <div class="sectionbody"> <div class="paragraph"> <p>You can now build the application like so:</p> </div> <div class="listingblock"> <div class="content"> <pre>mvn clean package</pre> </div> </div> <div class="paragraph"> <p>To run the application and all related components (Kafka, Kafka Connect with Debezium, a Postgres database), we&#8217;ve created a <a href="https://github.com/debezium/debezium-examples/blob/main/kstreams-fk-join/docker-compose.yaml">Docker Compose file</a>, which you can find in the <a href="https://github.com/debezium/debezium-examples/tree/main/kstreams-fk-join">debezium-examples</a> repo. To launch all the containers, also building the aggregator container image, run the the following:</p> </div> <div class="listingblock"> <div class="content"> <pre>export DEBEZIUM_VERSION=1.4

docker-compose up --build</pre> </div> </div> <div class="paragraph"> <p>To register the Debezium Connector with Kafka Connect, you need to specify the configuration properties like name of the connector, database hostname, user, password, port, name of the database, etc. Create a file <a href="https://github.com/debezium/debezium-examples/blob/main/kstreams-fk-join/register-postgres.json">register-postgres.json</a> with the following contents:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="json">{
    <span class="key"><span class="delimiter">&quot;</span><span class="content">connector.class</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">io.debezium.connector.postgresql.PostgresConnector</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">tasks.max</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">database.hostname</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">postgres</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">database.port</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">5432</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">database.user</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">postgres</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">database.password</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">postgres</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">database.dbname</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">postgres</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">database.server.name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">dbserver1</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">schema.include</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">inventory</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">decimal.handling.mode</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">string</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">key.converter</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">org.apache.kafka.connect.json.JsonConverter</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">key.converter.schemas.enable</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">value.converter</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">org.apache.kafka.connect.json.JsonConverter</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">value.converter.schemas.enable</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
}</code></pre> </div> </div> <div class="paragraph"> <p>Configure the Debezium Connector:</p> </div> <div class="listingblock"> <div class="content"> <pre>http PUT http://localhost:8083/connectors/inventory-connector/config &lt; register-postgres.json</pre> </div> </div> <div class="paragraph"> <p>Now run an instance of the <code>debezium/tooling</code> container image:</p> </div> <div class="listingblock"> <div class="content"> <pre>docker run --tty --rm \
    --network kstreams-fk-join-network \
    debezium/tooling:1.1 \</pre> </div> </div> <div class="paragraph"> <p>This image provides several useful tools such as <a href="https://github.com/edenhill/kafkacat">kafkacat</a>. Within the tooling container, run kafkacat to examine the results of the streaming pipeline:</p> </div> <div class="listingblock"> <div class="content"> <pre>kafkacat -b kafka:9092 -C -o beginning -q \
    -t customers-with-addresses | jq .</pre> </div> </div> <div class="paragraph"> <p>You should see records like the following, each containing all the data of one customer and all their addresses:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">addresses</span><span class="delimiter">&quot;</span></span>: [
    {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">city</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Hamburg</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">country</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Canada</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">customer_id</span><span class="delimiter">&quot;</span></span>: <span class="integer">1001</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="integer">100001</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">street</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">42 Main Street</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">zipcode</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">90210</span><span class="delimiter">&quot;</span></span>
    },
    {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">city</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Berlin</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">country</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Canada</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">customer_id</span><span class="delimiter">&quot;</span></span>: <span class="integer">1001</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="integer">100002</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">street</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">11 Post Dr.</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">zipcode</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">90211</span><span class="delimiter">&quot;</span></span>
    }
  ],
  <span class="key"><span class="delimiter">&quot;</span><span class="content">customer</span><span class="delimiter">&quot;</span></span>: {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">email</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">sally.thomas@acme.com</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">first_name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Sally</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="integer">1001</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">last_name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Thomas</span><span class="delimiter">&quot;</span></span>
  }
}</code></pre> </div> </div> <div class="paragraph"> <p>Get a shell for the database, insert, update, or delete some records, and the join will be reprocessed automatically:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="json"><span class="error">$</span> <span class="error">d</span><span class="error">o</span><span class="error">c</span><span class="error">k</span><span class="error">e</span><span class="error">r</span> <span class="error">r</span><span class="error">u</span><span class="error">n</span> <span class="error">-</span><span class="error">-</span><span class="error">t</span><span class="error">t</span><span class="error">y</span> <span class="error">-</span><span class="error">-</span><span class="error">r</span><span class="error">m</span> <span class="error">-</span><span class="error">i</span> <span class="error">\</span>
        <span class="error">-</span><span class="error">-</span><span class="error">n</span><span class="error">e</span><span class="error">t</span><span class="error">w</span><span class="error">o</span><span class="error">r</span><span class="error">k</span> <span class="error">k</span><span class="error">s</span><span class="error">t</span><span class="error">r</span><span class="error">e</span><span class="error">a</span><span class="error">m</span><span class="error">s</span><span class="error">-</span><span class="error">f</span><span class="error">k</span><span class="error">-</span><span class="error">j</span><span class="error">o</span><span class="error">i</span><span class="error">n</span><span class="error">-</span><span class="error">n</span><span class="error">e</span><span class="error">t</span><span class="error">w</span><span class="error">o</span><span class="error">r</span><span class="error">k</span> <span class="error">\</span>
        <span class="error">d</span><span class="error">e</span><span class="error">b</span><span class="error">e</span><span class="error">z</span><span class="error">i</span><span class="error">u</span><span class="error">m</span><span class="error">/</span><span class="error">t</span><span class="error">o</span><span class="error">o</span><span class="error">l</span><span class="error">i</span><span class="error">n</span><span class="error">g</span>:<span class="float">1.1</span> <span class="error">\</span>
        <span class="error">b</span><span class="error">a</span><span class="error">s</span><span class="error">h</span> <span class="error">-</span><span class="error">c</span> <span class="error">'</span><span class="error">p</span><span class="error">g</span><span class="error">c</span><span class="error">l</span><span class="error">i</span> <span class="error">p</span><span class="error">o</span><span class="error">s</span><span class="error">t</span><span class="error">g</span><span class="error">r</span><span class="error">e</span><span class="error">s</span><span class="error">q</span><span class="error">l</span>:<span class="error">/</span><span class="error">/</span><span class="error">p</span><span class="error">o</span><span class="error">s</span><span class="error">t</span><span class="error">g</span><span class="error">r</span><span class="error">e</span><span class="error">s</span>:<span class="error">p</span><span class="error">o</span><span class="error">s</span><span class="error">t</span><span class="error">g</span><span class="error">r</span><span class="error">e</span><span class="error">s</span><span class="error">@</span><span class="error">p</span><span class="error">o</span><span class="error">s</span><span class="error">t</span><span class="error">g</span><span class="error">r</span><span class="error">e</span><span class="error">s</span>:<span class="integer">5432</span><span class="error">/</span><span class="error">p</span><span class="error">o</span><span class="error">s</span><span class="error">t</span><span class="error">g</span><span class="error">r</span><span class="error">e</span><span class="error">s</span><span class="error">'</span>

<span class="error">#</span> <span class="error">i</span><span class="error">n</span> <span class="error">p</span><span class="error">g</span><span class="error">c</span><span class="error">l</span><span class="error">i</span>, <span class="error">e</span><span class="error">.</span><span class="error">g</span><span class="error">.</span> <span class="error">t</span><span class="error">o</span> <span class="error">u</span><span class="error">p</span><span class="error">d</span><span class="error">a</span><span class="error">t</span><span class="error">e</span> <span class="error">a</span> <span class="error">c</span><span class="error">u</span><span class="error">s</span><span class="error">t</span><span class="error">o</span><span class="error">m</span><span class="error">e</span><span class="error">r</span> <span class="error">r</span><span class="error">e</span><span class="error">c</span><span class="error">o</span><span class="error">r</span><span class="error">d</span>:

<span class="error">&gt;</span> <span class="error">u</span><span class="error">p</span><span class="error">d</span><span class="error">a</span><span class="error">t</span><span class="error">e</span> <span class="error">i</span><span class="error">n</span><span class="error">v</span><span class="error">e</span><span class="error">n</span><span class="error">t</span><span class="error">o</span><span class="error">r</span><span class="error">y</span><span class="error">.</span><span class="error">c</span><span class="error">u</span><span class="error">s</span><span class="error">t</span><span class="error">o</span><span class="error">m</span><span class="error">e</span><span class="error">r</span><span class="error">s</span> <span class="error">s</span><span class="error">e</span><span class="error">t</span> <span class="error">f</span><span class="error">i</span><span class="error">r</span><span class="error">s</span><span class="error">t</span><span class="error">_</span><span class="error">n</span><span class="error">a</span><span class="error">m</span><span class="error">e</span> <span class="error">=</span> <span class="error">'</span><span class="error">S</span><span class="error">a</span><span class="error">r</span><span class="error">a</span><span class="error">h</span><span class="error">'</span> <span class="error">w</span><span class="error">h</span><span class="error">e</span><span class="error">r</span><span class="error">e</span> <span class="error">i</span><span class="error">d</span> <span class="error">=</span> <span class="integer">1001</span><span class="error">;</span></code></pre> </div> </div> </div> </div> <div class="sect1"> <h2 id="running_natively">Running Natively</h2> <div class="sectionbody"> <div class="paragraph"> <p>Kafka Streams applications can easily be scaled out i.e. the load is going to be shared amongst multiple instances of the application, each processing a sub-set of the partitions of the input topics. When the Quarkus application gets compiled into native code via GraalVM, it takes considerably less memory and has a very fast start-up time. Without any concern about the memory management, you can start multiple instances of a Kafka Streams pipeline in parallel.</p> </div> <div class="paragraph"> <p>If you want to run this application in <code>native</code> mode, set the <code>QUARKUS_MODE</code> as <code>native</code> and run the following (make sure to have the required GraalVM tooling installed):</p> </div> <div class="listingblock"> <div class="content"> <pre>mvn clean package -Pnative</pre> </div> </div> <div class="paragraph"> <p>To learn more about running Kafka Streams applications as a native binary, please refer to the <a href="https://quarkus.io/guides/kafka-streams#running-natively">reference guide</a>.</p> </div> </div> </div> <div class="sect1"> <h2 id="more_insights_on_the_kafka_streams_extension">More Insights on the Kafka Streams Extension</h2> <div class="sectionbody"> <div class="paragraph"> <p>The Quarkus extension can also help you address some of the common requirements when building microservices for stream processing. For running your Kafka Streams application in production, you can for instance easily add health checks and metrics for the data pipeline.</p> </div> <div class="paragraph"> <p><a href="https://quarkus.io/guides/microprofile-metrics">Micrometer Metrics</a> provides rich metrics about your Quarkus application, i.e. what is happening inside your application by monitoring and what are its performance characteristics. Quarkus lets you expose these metrics via HTTP using a JSON format or the OpenMetrics format. From there, they can be scraped by tools such as <a href="https://prometheus.io/">Prometheus</a> and stored for analysis and visualization.</p> </div> <div class="paragraph"> <p>Once the application is started, the metrics will be exposed under <code>q/metrics</code>, returning the data in the OpenMetrics format by default:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="properties"># HELP kafka_producer_node_request_total The total number of requests sent
# TYPE kafka_producer_node_request_total counter
kafka_producer_node_request_total{client_id=&quot;kstreams-fkjoin-aggregator-b4ac1384-0e0a-4f19-8d52-8cc1ee4c6dfe-StreamThread-1-producer&quot;,kafka_version=&quot;2.5.0&quot;,node_id=&quot;node--1&quot;,status=&quot;up&quot;,} 83.0
# HELP kafka_producer_record_send_rate The average number of records sent per second.
# TYPE kafka_producer_record_send_rate gauge
kafka_producer_record_send_rate{client_id=&quot;kstreams-fkjoin-aggregator-b4ac1384-0e0a-4f19-8d52-8cc1ee4c6dfe-StreamThread-1-producer&quot;,kafka_version=&quot;2.5.0&quot;,status=&quot;up&quot;,} 0.0
# HELP jvm_gc_memory_allocated_bytes_total Incremented for an increase in the size of the (young) heap memory pool after one GC to before the next
# TYPE jvm_gc_memory_allocated_bytes_total counter
jvm_gc_memory_allocated_bytes_total 1.1534336E8
# ...
# HELP http_requests_total
# TYPE http_requests_total counter
http_requests_total{status=&quot;up&quot;,uri=&quot;/api/customers&quot;,} 0.0
# ...</code></pre> </div> </div> <div class="paragraph"> <p>If you arenâ€™t using Prometheus, you have a few options like Datadog, Stackdriver, and others. For a detailed guide check the <a href="https://github.com/quarkiverse/quarkus-micrometer-registry">Quarkiverse Extensions</a>.</p> </div> <div class="paragraph"> <p>On the other hand, we have <a href="https://quarkus.io/guides/microprofile-health">MicroProfile Health</a> spec, which provides information about the liveness of the application, i.e. signalling whether your application is running or not and whether your application is able to process requests. To monitor the health status of your existing Quarkus application you can add the <code>smallrye-health</code> extension:</p> </div> <div class="listingblock"> <div class="content"> <pre>mvn quarkus:add-extension -Dextensions="smallrye-health"</pre> </div> </div> <div class="paragraph"> <p>Quarkus will expose all health checks via HTTP under <code>q/health</code>, which in our case shows the status of the pipeline and any missing topics:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="json">{
    <span class="key"><span class="delimiter">&quot;</span><span class="content">status</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">DOWN</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">checks</span><span class="delimiter">&quot;</span></span>: [
        {
            <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Kafka Streams topics health check</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">status</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">DOWN</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">data</span><span class="delimiter">&quot;</span></span>: {
                <span class="key"><span class="delimiter">&quot;</span><span class="content">missing_topics</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">dbserver1.inventory.customers,dbserver1.inventory.addresses</span><span class="delimiter">&quot;</span></span>
            }
        }
    ]
}</code></pre> </div> </div> </div> </div> <div class="sect1"> <h2 id="summary">Summary</h2> <div class="sectionbody"> <div class="paragraph"> <p>The Quarkus extension for Kafka Streams comes with everything needed to run stream processing pipelines on the JVM as well as in native mode, along with additional bonuses of performing health checks, metrics, and more. For instance you could quite easily expose REST APIs for interactive queries using the Quarkus REST support, potentially retrieving data from other instances of scaled out Kafka Streams app using the <a href="https://quarkus.io/guides/rest-client">MicroProfile REST client API</a>.</p> </div> <div class="paragraph"> <p>In this article we have discussed a stream processing topology of foreign key joins in Kafka Streams, and how to use the Quarkus Kafka Streams extension for running and building your application in JVM mode. You can find the complete <a href="https://github.com/debezium/debezium-examples/tree/main/kstreams-fk-join">source code</a> of the implementation in the Debezium examples repo. If you got any questions or feedback, please let us know in the comments below. We&#8217;re looking forward to your suggestions!</p> </div> <div class="sect2"> <h3 id="references">References</h3> <div class="ulist"> <ul> <li> <p><a href="https://quarkus.io/guides/kafka-streams">Building Kafka Streams applications with Quarkus</a></p> </li> <li> <p><a href="https://speakerdeck.com/gunnarmorling/change-data-capture-pipelines-with-debezium-and-kafka-streams-jokerconf">Change Data Capture Pipelines With Debezium and Kafka Streams</a></p> </li> <li> <p><a href="https://micrometer.io/docs/concepts">Micrometer Application Monitor</a></p> </li> </ul> </div> </div> </div> </div></div> </div> <div class="well"> <div class="row"> <div class="col-md-8"> <h2>Anisha Mohanty</h2> <p> <span class="bio-size">Anisha is a Software Engineer at Red Hat. Currently working with the Debezium Team. She lives in Bangalore, India.</span> </p> <p class="bio-size"> <a href="https://twitter.com/anisha__mohanty"> <i class="icon-twitter"></i> </a> &nbsp; <a href="https://github.com/ani-sha"> <i class="icon-github"></i> </a> &nbsp; </p> </div> <div class="col-md-4"> <img alt="" class="img-responsive pull-right portrait" src="/assets/images/anmohant.jpeg"/> </div> </div> </div> <ul class="pager pager-blog"> <li class="previous"> <a href="/blog/2021/03/15/debezium-1-5-beta2-released/" class="previous"> &laquo; Previous</a> </li> <li class="next"><a href="/blog/2021/03/24/debezium-1-5-cr1-released/">Next &raquo; </a></li> </ul> <div class="row"> <div class="col-md-12"> <hr> <h2>About Debezium</h2> <p> Debezium is an open source distributed platform that turns your existing databases into event streams, so applications can see and respond almost instantly to each committed row-level change in the databases. Debezium is built on top of <a href="http://kafka.apache.org/">Kafka</a> and provides <a href="http://kafka.apache.org/documentation.html#connect">Kafka Connect</a> compatible connectors that monitor specific database management systems. Debezium records the history of data changes in Kafka logs, so your application can be stopped and restarted at any time and can easily consume all of the events it missed while it was not running, ensuring that all events are processed correctly and completely. Debezium is <a href="/license/">open source</a> under the <a href="http://www.apache.org/licenses/LICENSE-2.0.html">Apache License, Version 2.0</a>. </p> </div> </div> <div class="row"> <div class="col-md-12"> <h2>Get involved</h2> <p> We hope you find Debezium interesting and useful, and want to give it a try. Follow us on Twitter <a href="https://twitter.com/debezium">@debezium</a>, <a href="https://debezium.zulipchat.com/#narrow/stream/302529-users">chat with us on Zulip</a>, or join our <a href="https://groups.google.com/forum/#!forum/debezium">mailing list</a> to talk with the community. All of the code is open source <a href="https://github.com/debezium/">on GitHub</a>, so build the code locally and help us improve ours existing connectors and add even more connectors. If you find problems or have ideas how we can improve Debezium, please let us know or <a href="https://issues.redhat.com/projects/DBZ/issues/">log an issue</a>. </p> </div> </div> <div id="disqus_thread"></div> <script>var disqus_config=function(){this.page.url="https://debezium.io/blog/2021/03/18/understanding-non-key-joins-with-quarkus-extension-for-kafka-streams/",this.page.identifier="https://debezium.io/blog/2021/03/18/understanding-non-key-joins-with-quarkus-extension-for-kafka-streams/"};!function(){var e=document,t=e.createElement("script");t.src="https://Debezium.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)}();</script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> </div> </div> </div> <footer class="container"> <div> <div class="row mr-0 ml-0"> <div class="col-md-5 col-md-offset-1"> <h4>Debezium</h4> <p> &#169; 2024 Debezium Community <br/> <br/> <i class="icon-fire"></i> Mixed with <a href="https://getbootstrap.com/">Bootstrap</a>, baked by <a href="https://jekyllrb.com/">Jekyll</a>. <br/> <i class="icon-flag"></i> Website and docs licensed under <a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>. <br/> <i class="icon-flag-alt"></i> Code released under <a href="https://www.apache.org/licenses/LICENSE-2.0.html">Apache License, v2.0</a>. <br/> <i class="icon-file-alt"></i> <a href="https://www.redhat.com/legal/legal_statement.html" title="Terms">Terms</a> | <a href="https://www.redhat.com/legal/privacy_statement.html" title="Privacy Policy">Privacy</a> </p> <p>Rev: <a target="_blank" href="https://github.com/debezium/debezium.github.io/commit/4b6af42db052947a3dbf0249ec040f648bfb4ed9">4b6af42</a> </p> </div> <div class="col-md-3"> <h4>Documentation</h4> <ul class="list-unstyled"> <li><a href="/documentation/reference/stable/features.html" title="Features">Features</a></li> <li> <a href="/documentation/reference/stable/install.html" title="Install">Install</a> </li> <li> <a href="/documentation/reference/stable/architecture.html" title="Architecture">Architecture</a> </li> <li><a href="/documentation/faq/" title="FAQ">FAQ</a></li> <li> <a href="/community/contribute/" title="Contribute">Contribute</a> </li> </ul> </div> <div class="col-md-3"> <h4>Connect</h4> <ul class="list-unstyled"> <li><a href="/blog" title="Blog">Blog</a></li> <li> <a href="https://twitter.com/debezium" title="Twitter">Twitter</a> </li> <li><a href="https://github.com/debezium" title="GitHub">GitHub</a></li> <li><a href="https://debezium.zulipchat.com/#narrow/stream/302529-users" title="Chat">Chat</a></li> <li> <a href="https://groups.google.com/forum/#!forum/debezium" title="Google Groups">Google Groups</a> </li> <li> <a href="https://stackoverflow.com/questions/tagged/debezium" title="StackOverflow">StackOverflow</a> </li> </ul> </div> </div> </div> </footer> <div class="container" id="companyfooter"> <div class="redhatlogo"> <a href="https://www.redhat.com/"> <img src="/assets/images/Logo-Red_Hat-Sponsored_By-B-Standard-RGB.svg"/> </a> </div> </div> </div> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-76464546-1"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-76464546-1");</script> <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script> <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script> <script type="text/javascript" src="/assets/javascript/vanilla-back-to-top.min.js"></script> <script type="text/javascript" src="/assets/javascript/highlight.min.js"></script> <script>addBackToTop({scrollDuration:400}),hljs.initHighlightingOnLoad();</script> </body> </html>