<!DOCTYPE html> <html> <head> <title>Deep Dive Into a Debezium Community Connector: The Scylla CDC Source Connector</title> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1"> <meta name="description" content="Debezium is an open source distributed platform for change data capture. Start it up, point it at your databases, and your apps can start responding to all of the inserts, updates, and deletes that other apps commit to your databases. Debezium is durable and fast, so your apps can respond quickly and never miss an event, even when things go wrong."> <meta content="Debezium" property="og:site_name"> <meta content="Deep Dive Into a Debezium Community Connector: The Scylla CDC Source Connector" property="og:title"> <meta content="https://debezium.io/assets/images/color_black_debezium_type_1200px.png" property="og:image" name="image"> <meta property="og:description" content="Debezium is an open source distributed platform for change data capture. Start it up, point it at your databases, and your apps can start responding to all of the inserts, updates, and deletes that other apps commit to your databases. Debezium is durable and fast, so your apps can respond quickly and never miss an event, even when things go wrong."> <meta property="og:url" content="https://debezium.io/blog/2021/09/22/deep-dive-into-a-debezium-community-connector-scylla-cdc-source-connector/"> <meta name="twitter:site" content="@debezium"> <meta name="twitter:title" content="Deep Dive Into a Debezium Community Connector: The Scylla CDC Source Connector"> <meta name="twitter:creator" content="@pgrabowski"> <meta name="twitter:description" content="Debezium is an open source distributed platform for change data capture. Start it up, point it at your databases, and your apps can start responding to all of the inserts, updates, and deletes that other apps commit to your databases. Debezium is durable and fast, so your apps can respond quickly and never miss an event, even when things go wrong."> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:image" content="https://debezium.io/assets/images/color_black_debezium_type_1200px.png"> <meta property="twitter:url" content="https://debezium.io/blog/2021/09/22/deep-dive-into-a-debezium-community-connector-scylla-cdc-source-connector/"> <link rel="alternate" type="application/rss+xml" title="Debezium Blog" href="/blog.atom"> <link rel="shortcut icon" type="image/png" href="/favicon.ico"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css"/> <link rel="stylesheet" href="/assets/css/custom.css"/> <link rel="stylesheet" href="/assets/css/highlight.min.css"/> <link rel="stylesheet" href="/assets/css/coderay.css"/> </head> <body class="post"> <div id="rhbar"> <a class="jbdevlogo" href="https://developers.redhat.com"></a> <a class="rhlogo" href="https://www.redhat.com/"></a> </div> <div id> <div class="container" id="content"> <nav class="navbar navbar-inverse navbar-fix"> <div class="container-fluid"> <div class="navbar-header"> <button class="navbar-toggle collapsed border-0" type="button" data-toggle="collapse" data-target="#navigation" aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href="/"><img class="project-logo" src="/assets/images/color_white_debezium_type_600px.svg" style="height: 32px; margin-right: 5px; margin-top: -5px;"></a> </div> <div class="collapse navbar-collapse collapsed" id="navigation"> <ul class="nav navbar-nav pull-right"> <li> <a href="/documentation/faq" class="">FAQ</a> </li> <li class="item"> <a href="/documentation/" class="">Documentation</a> </li> <li> <a href="/releases/" class="">Releases</a> </li> <li class="active"> <a href="/community/" class="">Community</a> </li> <li class="active"> <a href="/blog/" class="active">Blog</a> </li> </ul> </div> </div> </nav> <div class="row post-text-padding row-no-expand"> <div class="col-md-3"><div id="leftdocnav"> <div class="hidden-lg hidden-md hidden-sm"> <button class="navbar-toggle docssubmenu-toggle collapsed" data-target="#docssubmenu" data-toggle="collapse" style=" float: none; background-color: #656565; border-color: #656565; width: 100%; color: #fff; "> Navigation Menu </button> </div> <div class="collapse" id="docssubmenu"> <div class="doc-pills"> <ul class="nav nav-pills nav-stacked"> <li class="item"> <a href="/blog">Home</a> <div class="icon"><span class="icon-home"></span></div> </li> <li class="item"> <a href="/archives">Archive</a> <div class="icon"><span class="icon-arrow-down"></span></div> </li> <li class="item"> <a href="/blog.atom">Feed</a> <div class="icon"><span class="icon-rss"></span></div> </li> </ul> </div> <p></p> <div class="featured-posts"> <div id="#featured" style="margin-bottom: 4px; border-bottom: 1px solid #ccc; font-size: 115%; margin-left: 2px;">Featured Posts</div> <ul style="padding-inline-start: 22px;"> <li style="margin-bottom: 3px;"> <a href="/blog/2023/07/10/custom-http-signaling-notification/" style="font-size: 95%;"> Debezium signaling and notifications - Part 2: Customisation </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2023/06/27/Debezium-signaling-and-notifications/" style="font-size: 95%;"> Debezium signaling and notifications - Part 1 </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2023/05/02/tensorflow-mnist-classification/" style="font-size: 95%;"> Image classification with Debezium and TensorFlow </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2020/11/04/streaming-vitess-at-bolt/" style="font-size: 95%;"> Streaming Vitess at Bolt </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2020/02/10/event-sourcing-vs-cdc/" style="font-size: 95%;"> Distributed Data for Microservices — Event Sourcing vs. Change Data Capture </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2019/10/01/audit-logs-with-change-data-capture-and-stream-processing/" style="font-size: 95%;"> Building Audit Logs with Change Data Capture and Stream Processing </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2019/07/12/streaming-cassandra-at-wepay-part-1/" style="font-size: 95%;"> Streaming Cassandra at WePay - Part 1 </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2019/02/19/reliable-microservices-data-exchange-with-the-outbox-pattern/" style="font-size: 95%;"> Reliable Microservices Data Exchange With the Outbox Pattern </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/12/05/automating-cache-invalidation-with-change-data-capture/" style="font-size: 95%;"> Automating Cache Invalidation With Change Data Capture </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/09/20/materializing-aggregate-views-with-hibernate-and-debezium/" style="font-size: 95%;"> Materializing Aggregate Views With Hibernate and Debezium </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/07/19/advantages-of-log-based-change-data-capture/" style="font-size: 95%;"> Five Advantages of Log-Based Change Data Capture </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/03/08/creating-ddd-aggregates-with-debezium-and-kafka-streams/" style="font-size: 95%;"> Creating DDD aggregates with Debezium and Kafka Streams </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/01/17/streaming-to-elasticsearch/" style="font-size: 95%;"> Streaming Data Changes from Your Database to Elasticsearch </a> </li> </ul> </div> <p></p> <p></p> <div class="cloud-tags"> <div id="tags" style="margin-bottom: 4px; border-bottom: 1px solid #ccc; font-size: 115%; margin-left: 2px;"> Tags </div> <div class="tag-cloud"> <span class="site-tag"> <a href="/tag/apache-kafka/" style="font-size: 82%"> apache kafka </a> </span> <span class="site-tag"> <a href="/tag/apache-kafka/" style="font-size: 92%"> apache kafka </a> </span> <span class="site-tag"> <a href="/tag/apicurio/" style="font-size: 82%"> apicurio </a> </span> <span class="site-tag"> <a href="/tag/avro/" style="font-size: 84%"> avro </a> </span> <span class="site-tag"> <a href="/tag/aws/" style="font-size: 82%"> aws </a> </span> <span class="site-tag"> <a href="/tag/caassandra/" style="font-size: 84%"> caassandra </a> </span> <span class="site-tag"> <a href="/tag/camel/" style="font-size: 82%"> camel </a> </span> <span class="site-tag"> <a href="/tag/cassandra/" style="font-size: 246%"> cassandra </a> </span> <span class="site-tag"> <a href="/tag/cdc/" style="font-size: 82%"> cdc </a> </span> <span class="site-tag"> <a href="/tag/channels/" style="font-size: 82%"> channels </a> </span> <span class="site-tag"> <a href="/tag/community/" style="font-size: 122%"> community </a> </span> <span class="site-tag"> <a href="/tag/community-stories/" style="font-size: 84%"> community stories </a> </span> <span class="site-tag"> <a href="/tag/containers/" style="font-size: 82%"> containers </a> </span> <span class="site-tag"> <a href="/tag/cqrs/" style="font-size: 84%"> cqrs </a> </span> <span class="site-tag"> <a href="/tag/custom/" style="font-size: 82%"> custom </a> </span> <span class="site-tag"> <a href="/tag/datalake/" style="font-size: 82%"> datalake </a> </span> <span class="site-tag"> <a href="/tag/db2/" style="font-size: 228%"> db2 </a> </span> <span class="site-tag"> <a href="/tag/ddd/" style="font-size: 82%"> ddd </a> </span> <span class="site-tag"> <a href="/tag/debezium/" style="font-size: 96%"> debezium </a> </span> <span class="site-tag"> <a href="/tag/debezium-server/" style="font-size: 90%"> debezium server </a> </span> <span class="site-tag"> <a href="/tag/debezium-ui/" style="font-size: 88%"> debezium ui </a> </span> <span class="site-tag"> <a href="/tag/deduplication/" style="font-size: 82%"> deduplication </a> </span> <span class="site-tag"> <a href="/tag/discussion/" style="font-size: 114%"> discussion </a> </span> <span class="site-tag"> <a href="/tag/docker/" style="font-size: 186%"> docker </a> </span> <span class="site-tag"> <a href="/tag/elasticsearch/" style="font-size: 82%"> elasticsearch </a> </span> <span class="site-tag"> <a href="/tag/event-sourcing/" style="font-size: 82%"> event sourcing </a> </span> <span class="site-tag"> <a href="/tag/exactly-once-semantics/" style="font-size: 82%"> exactly once semantics </a> </span> <span class="site-tag"> <a href="/tag/example/" style="font-size: 88%"> example </a> </span> <span class="site-tag"> <a href="/tag/examples/" style="font-size: 114%"> examples </a> </span> <span class="site-tag"> <a href="/tag/features/" style="font-size: 84%"> features </a> </span> <span class="site-tag"> <a href="/tag/fedora/" style="font-size: 82%"> fedora </a> </span> <span class="site-tag"> <a href="/tag/hiring/" style="font-size: 84%"> hiring </a> </span> <span class="site-tag"> <a href="/tag/iceberg/" style="font-size: 82%"> iceberg </a> </span> <span class="site-tag"> <a href="/tag/integration/" style="font-size: 84%"> integration </a> </span> <span class="site-tag"> <a href="/tag/introduction/" style="font-size: 84%"> introduction </a> </span> <span class="site-tag"> <a href="/tag/jaeger/" style="font-size: 82%"> jaeger </a> </span> <span class="site-tag"> <a href="/tag/json/" style="font-size: 82%"> json </a> </span> <span class="site-tag"> <a href="/tag/kafka/" style="font-size: 94%"> kafka </a> </span> <span class="site-tag"> <a href="/tag/kafka-streams/" style="font-size: 82%"> kafka streams </a> </span> <span class="site-tag"> <a href="/tag/kafka-streams/" style="font-size: 86%"> kafka streams </a> </span> <span class="site-tag"> <a href="/tag/kogito/" style="font-size: 82%"> kogito </a> </span> <span class="site-tag"> <a href="/tag/ksql/" style="font-size: 82%"> ksql </a> </span> <span class="site-tag"> <a href="/tag/kubernetes/" style="font-size: 82%"> kubernetes </a> </span> <span class="site-tag"> <a href="/tag/lakehouse/" style="font-size: 82%"> lakehouse </a> </span> <span class="site-tag"> <a href="/tag/machine-learning/" style="font-size: 82%"> machine learning </a> </span> <span class="site-tag"> <a href="/tag/microservices/" style="font-size: 84%"> microservices </a> </span> <span class="site-tag"> <a href="/tag/mongo/" style="font-size: 86%"> mongo </a> </span> <span class="site-tag"> <a href="/tag/mongodb/" style="font-size: 246%"> mongodb </a> </span> <span class="site-tag"> <a href="/tag/mysql/" style="font-size: 382%"> mysql </a> </span> <span class="site-tag"> <a href="/tag/news/" style="font-size: 112%"> news </a> </span> <span class="site-tag"> <a href="/tag/newsletter/" style="font-size: 88%"> newsletter </a> </span> <span class="site-tag"> <a href="/tag/notifications/" style="font-size: 84%"> notifications </a> </span> <span class="site-tag"> <a href="/tag/oracle/" style="font-size: 278%"> oracle </a> </span> <span class="site-tag"> <a href="/tag/outbox/" style="font-size: 216%"> outbox </a> </span> <span class="site-tag"> <a href="/tag/postgres/" style="font-size: 350%"> postgres </a> </span> <span class="site-tag"> <a href="/tag/presentation/" style="font-size: 84%"> presentation </a> </span> <span class="site-tag"> <a href="/tag/production/" style="font-size: 82%"> production </a> </span> <span class="site-tag"> <a href="/tag/quarkus/" style="font-size: 92%"> quarkus </a> </span> <span class="site-tag"> <a href="/tag/questdb/" style="font-size: 82%"> questdb </a> </span> <span class="site-tag"> <a href="/tag/rds/" style="font-size: 84%"> rds </a> </span> <span class="site-tag"> <a href="/tag/releases/" style="font-size: 364%"> releases </a> </span> <span class="site-tag"> <a href="/tag/schema/" style="font-size: 82%"> schema </a> </span> <span class="site-tag"> <a href="/tag/scylla/" style="font-size: 82%"> scylla </a> </span> <span class="site-tag"> <a href="/tag/secrets/" style="font-size: 82%"> secrets </a> </span> <span class="site-tag"> <a href="/tag/sentry/" style="font-size: 82%"> sentry </a> </span> <span class="site-tag"> <a href="/tag/serialization/" style="font-size: 82%"> serialization </a> </span> <span class="site-tag"> <a href="/tag/signaling/" style="font-size: 84%"> signaling </a> </span> <span class="site-tag"> <a href="/tag/smt/" style="font-size: 84%"> smt </a> </span> <span class="site-tag"> <a href="/tag/snapshots/" style="font-size: 84%"> snapshots </a> </span> <span class="site-tag"> <a href="/tag/spanner/" style="font-size: 104%"> spanner </a> </span> <span class="site-tag"> <a href="/tag/sql/" style="font-size: 84%"> sql </a> </span> <span class="site-tag"> <a href="/tag/sqlserver/" style="font-size: 292%"> sqlserver </a> </span> <span class="site-tag"> <a href="/tag/tensorflow/" style="font-size: 82%"> tensorflow </a> </span> <span class="site-tag"> <a href="/tag/testcontainers/" style="font-size: 88%"> testcontainers </a> </span> <span class="site-tag"> <a href="/tag/tests/" style="font-size: 82%"> tests </a> </span> <span class="site-tag"> <a href="/tag/time-series/" style="font-size: 82%"> time series </a> </span> <span class="site-tag"> <a href="/tag/topics/" style="font-size: 82%"> topics </a> </span> <span class="site-tag"> <a href="/tag/tracing/" style="font-size: 82%"> tracing </a> </span> <span class="site-tag"> <a href="/tag/transactions/" style="font-size: 82%"> transactions </a> </span> <span class="site-tag"> <a href="/tag/vagrant/" style="font-size: 82%"> vagrant </a> </span> <span class="site-tag"> <a href="/tag/vitess/" style="font-size: 208%"> vitess </a> </span> <span class="site-tag"> <a href="/tag/website/" style="font-size: 84%"> website </a> </span> </div> </div> </div> </div> </div> <div class="col-md-9"> <div class="post"> <div class="row" style="margin-left: 0; margin-right: 0; margin-bottom: 10px"> <div class="col-sm-12" style="padding-left: 0px"> <div style="display: table-cell; vertical-align: top"> <div style=" width: 72px; border: 1px solid #ccc; padding: 3px; display: inline-block; "> <img src="/assets/images/pgrabowski.jpg" style="width: 64px;"> </div> </div> <div style="display: table-cell; vertical-align: top"> <div style="margin-left: 8px"> <span class="hidden-sm hidden-xs" style="font-size: 2.75rem; line-height: 1"> <a href="/blog/2021/09/22/deep-dive-into-a-debezium-community-connector-scylla-cdc-source-connector/">Deep Dive Into a Debezium Community Connector: The Scylla CDC Source Connector</a> </span> <span class="hidden-md hidden-lg" style="font-size: 2rem; line-height: 1"> <a href="/blog/2021/09/22/deep-dive-into-a-debezium-community-connector-scylla-cdc-source-connector/">Deep Dive Into a Debezium Community Connector: The Scylla CDC Source Connector</a> </span> <div class="byline" style="line-height: 1"> <em> September 22, 2021 by </em> <em> Piotr Grabowski </em> <div class="hidden-xs" style="margin-top: 5px"> <a class="label label-info hidden-sm hidden-xs" href="/tag/community/">community</a> <a class="label label-info hidden-sm hidden-xs" href="/tag/kafka/">kafka</a> <a class="label label-info hidden-sm hidden-xs" href="/tag/scylla/">scylla</a> </div> </div> </div> </div> </div> </div> <div class="grid__item width-12-12"><div class="paragraph"> <p>At ScyllaDB, we develop a high-performance NoSQL database <a href="https://www.scylladb.com/">Scylla</a>, API-compatible with Apache Cassandra, Amazon DynamoDB and Redis. Earlier this year, we introduced support for <a href="https://docs.scylladb.com/using-scylla/cdc/cdc-intro/">Change Data Capture</a> in Scylla 4.3. This new feature seemed like a perfect match for integration with the Apache Kafka ecosystem, so we developed the <a href="https://github.com/scylladb/scylla-cdc-source-connector">Scylla CDC Source Connector</a> using the Debezium framework. In this blogpost we will cover the basic structure of Scylla’s CDC, reasons we chose the Debezium framework and design decisions we made.</p> </div> <div class="paragraph"> <p></p> </div> <div class="sect1"> <h2 id="cdc_support_in_scylla">CDC support in Scylla</h2> <div class="sectionbody"> <div class="paragraph"> <p>Change Data Capture (CDC) allows users to track data modifications in their Scylla database. It can be easily enabled/disabled on any Scylla table. Upon turning it on, a log of all modifications (INSERTs, UPDATEs, DELETEs) will be created and automatically updated.</p> </div> <div class="paragraph"> <p>When we designed our implementation of CDC in Scylla, we wanted to make it easy to consume the CDC log. Therefore, the CDC log is stored as a regular Scylla table, accessible by any existing CQL driver. When a modification is made to a table with CDC enabled, information about that operation is saved to the CDC log table.</p> </div> <div class="paragraph"> <p>Here’s a quick demo of it: First, we will create a table with CDC enabled:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="sql"><span class="class">CREATE</span> <span class="type">TABLE</span> ks.orders(
    user <span class="predefined-type">text</span>,
    order_id <span class="predefined-type">int</span>,
    order_name <span class="predefined-type">text</span>,
    <span class="directive">PRIMARY</span> <span class="type">KEY</span>(user, order_id)
) WITH cdc = {<span class="string"><span class="delimiter">'</span><span class="content">enabled</span><span class="delimiter">'</span></span>: <span class="predefined-constant">true</span>};</code></pre> </div> </div> <div class="paragraph"> <p>Next, let’s perform some operations:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="sql"><span class="class">INSERT</span> <span class="class">INTO</span> ks.orders(user, order_id, order_name)
    <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">Tim</span><span class="delimiter">'</span></span>, <span class="integer">1</span>, <span class="string"><span class="delimiter">'</span><span class="content">apple</span><span class="delimiter">'</span></span>);

<span class="class">INSERT</span> <span class="class">INTO</span> ks.orders(user, order_id, order_name)
    <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">Alice</span><span class="delimiter">'</span></span>, <span class="integer">2</span>, <span class="string"><span class="delimiter">'</span><span class="content">blueberries</span><span class="delimiter">'</span></span>);

<span class="class">UPDATE</span> ks.orders
    <span class="class">SET</span> order_name = <span class="string"><span class="delimiter">'</span><span class="content">pineapple</span><span class="delimiter">'</span></span>
    <span class="keyword">WHERE</span> user = <span class="string"><span class="delimiter">'</span><span class="content">Tim</span><span class="delimiter">'</span></span> <span class="keyword">AND</span> order_id = <span class="integer">1</span>;</code></pre> </div> </div> <div class="paragraph"> <p>Finally, let’s see the contents of the modified table:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> * <span class="keyword">FROM</span> ks.orders;

 user | order_id | order_name
<span class="comment">------+----------+-------------</span>
  Tim |        <span class="integer">1</span> |   pineapple
Alice |        <span class="integer">2</span> | blueberries</code></pre> </div> </div> <div class="paragraph"> <p>Looking only at this table, you cannot reconstruct all modifications that took place, e.g. Tim’s order name before the UPDATE. Let’s look at the CDC log, easily accessible as a table (some columns truncated for clarity):</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> * <span class="keyword">FROM</span> ks.orders_scylla_cdc_log;

 cdc$stream_id | cdc$time |     | cdc$operation | order_id | order_name  |     user
<span class="comment">---------------+----------+-...-+---------------+----------+-------------+----------</span>
    <span class="hex">0x2e46a</span>... |  <span class="error">7</span><span class="error">6</span><span class="error">0</span><span class="error">4</span>... | ... |             <span class="integer">2</span> |        <span class="integer">1</span> |       apple |      Tim
    <span class="hex">0x2e46a</span>... |  <span class="float">8f</span>dc... | ... |             <span class="integer">1</span> |        <span class="integer">1</span> |   pineapple |      Tim
    <span class="hex">0x41400</span>... |  <span class="error">8</span><span class="error">0</span><span class="error">8</span>e... | ... |             <span class="integer">2</span> |        <span class="integer">2</span> | blueberries |    Alice</code></pre> </div> </div> <div class="paragraph"> <p>All three operations are visible in the CDC log. There are two INSERTs (<code>cdc$operation = 2</code>) and one UPDATE (<code>cdc$operation = 1</code>). For each operation, its timestamp is also preserved in <code>cdc$time</code> column. The timestamp is encoded as a time-based UUID value as specified by the <a href="https://datatracker.ietf.org/doc/html/rfc4122">RFC 4122</a> specification, which can be decoded using helper methods in Scylla drivers.</p> </div> </div> </div> <div class="sect1"> <h2 id="choosing_debezium">Choosing Debezium</h2> <div class="sectionbody"> <div class="paragraph"> <p>As shown in the previous section, Scylla CDC can be easily queried as a regular table. To get the latest operations in real-time, you poll the table with appropriate time ranges. To make this easier, we developed client libraries for <a href="https://github.com/scylladb/scylla-cdc-java">Java</a> and <a href="https://github.com/scylladb/scylla-cdc-go">Go</a>.</p> </div> <div class="paragraph"> <p>When we thought about how our customers could access the CDC log, using it with Kafka seemed like the most accessible method. Therefore, we decided to develop a source connector for Scylla CDC.</p> </div> <div class="paragraph"> <p>For our first proof-of-concept, we implemented the source connector using the <a href="https://kafka.apache.org/documentation.html#connect_development">Kafka Connect API</a>. This prototype was crucial for us to determine if the connector could scale horizontally (described later in this blogpost).</p> </div> <div class="paragraph"> <p>However, we quickly realized that by using only the Kafka Connect API, we would have to reimplement a lot of functionality already present in other connectors. We also wanted our connector to be a good citizen in the Kafka community, sticking to the best practices and conventions. That’s exactly why we choose Debezium!</p> </div> <div class="paragraph"> <p>Thanks to this, when you start the Scylla CDC Source Connector, the configuration parameters will be immediately familiar, as many of them are common with other Debezium connectors. The generated data change events have the same <a href="https://javadoc.io/static/io.debezium/debezium-core/1.6.2.Final/io/debezium/data/Envelope.html">Envelope</a> structure as generated by other Debezium connectors. This similarity allows for the use of many standard Debezium features, such as <a href="/documentation/reference/1.6/transformations/event-flattening.html">New Record State Extraction</a>.</p> </div> </div> </div> <div class="sect1"> <h2 id="event_representation">Event representation</h2> <div class="sectionbody"> <div class="paragraph"> <p>After we decided to use the Debezium framework, we looked at how Scylla CDC operations should be represented in Debezium’s Envelope format.</p> </div> <div class="paragraph"> <p>The Envelope format consists of the following fields:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p><code>op</code> - type of operation: <code>c</code> for create, <code>u</code> for update, <code>d</code> for delete and <code>r</code> for read</p> </li> <li> <p><code>before</code> - state of row before an event occured</p> </li> <li> <p><code>after</code> - state of row after an event occurred</p> </li> <li> <p><code>source</code> - metadata of the event</p> </li> <li> <p><code>ts_ms</code> - time the connector processed the event</p> </li> </ol> </div> <div class="paragraph"> <p>Mapping Scylla operations to the <code>op</code> field was fairly easy: <code>c</code> for INSERT, <code>u</code> for UPDATE, <code>d</code> for DELETE.</p> </div> <div class="paragraph"> <p>We decided to skip DELETE events that span multiple rows, such as range DELETEs:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="sql"><span class="class">DELETE</span> <span class="keyword">FROM</span> ks.table
    <span class="keyword">WHERE</span> pk = <span class="integer">1</span> <span class="keyword">AND</span> ck &gt; <span class="integer">0</span> <span class="keyword">AND</span> ck &lt; <span class="integer">5</span></code></pre> </div> </div> <div class="paragraph"> <p>Representing such operations would unnecessarily complicate the format in order to accommodate additional range information. Moreover, it would break the expectation that an Envelope represents a modification to a single row.</p> </div> <div class="paragraph"> <p>In Scylla CDC, range DELETEs are represented as two rows in the CDC table: the first row encodes the information about the start of the deleted range (in the example above: <code>pk = 1, ck &gt; 0</code>) and the second row encodes the end of the deleted range (in the example above: <code>pk = 1, ck &lt; 5</code>). An information about each of the rows present in that range is not persisted. This corresponds to a fact that DELETEs in Scylla generate a tombstone in the database.</p> </div> <div class="paragraph"> <p>By default, Scylla’s CDC stores the primary key and only the modified columns of an operation. For example, suppose I created a table and inserted a row:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="sql"><span class="class">CREATE</span> <span class="type">TABLE</span> ks.example(
    pk <span class="predefined-type">int</span>,
    v1 <span class="predefined-type">int</span>,
    v2 <span class="predefined-type">int</span>,
    v3 <span class="predefined-type">int</span>,
<span class="directive">PRIMARY</span> <span class="type">KEY</span>(pk)) WITH cdc = {<span class="string"><span class="delimiter">'</span><span class="content">enabled</span><span class="delimiter">'</span></span>: <span class="predefined-constant">true</span>};

<span class="class">INSERT</span> <span class="class">INTO</span> ks.example(pk, v1, v2, v3)
    <span class="keyword">VALUES</span> (<span class="integer">1</span>, <span class="integer">2</span>, <span class="integer">3</span>, <span class="integer">4</span>);</code></pre> </div> </div> <div class="paragraph"> <p>In Scylla you can issue another INSERT statement, which will override some of the columns:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="sql"><span class="class">INSERT</span> <span class="class">INTO</span> ks.example(pk, v1, v3)
    <span class="keyword">VALUES</span> (<span class="integer">1</span>, <span class="integer">20</span>, <span class="predefined-constant">null</span>);</code></pre> </div> </div> <div class="paragraph"> <p>The <code>v2</code> column is left unchanged after this query and we don’t have any information about its previous value.</p> </div> <div class="paragraph"> <p>We must be able to represent three possibilities: a column was not modified, a column was assigned a <code>NULL</code> value or a column was assigned a non-null value. The representation we chose was inspired by <a href="/documentation/reference/1.6/connectors/cassandra.html">Debezium Connector for Cassandra</a>, which works by wrapping the value for a column in a structure:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="json"><span class="key"><span class="delimiter">&quot;</span><span class="content">v1</span><span class="delimiter">&quot;</span></span>: {<span class="key"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>},
<span class="key"><span class="delimiter">&quot;</span><span class="content">v2</span><span class="delimiter">&quot;</span></span>: <span class="value">null</span>,
<span class="key"><span class="delimiter">&quot;</span><span class="content">v3</span><span class="delimiter">&quot;</span></span>: {<span class="key"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>: <span class="value">null</span>}</code></pre> </div> </div> <div class="paragraph"> <p>A <code>null</code> structure value represents that a column was not modified (<code>v2</code> field). If the column was assigned a <code>NULL</code> value (<code>v3</code> field), there will be a structure with a <code>NULL</code> <code>value</code> field. A non-null column assignment (<code>v1</code> field) fills the contents of the <code>value</code> field. Such a format allows us to correctly represent all the possibilities and differentiate between assigning <code>NULL</code> and non-modification.</p> </div> <div class="paragraph"> <p>However, most sink connectors won’t be able to correctly parse such a structure. Therefore, we decided to develop our own SMT, based on Debezium’s <a href="https://debezium.io/documentation/reference/1.6/transformations/event-flattening.html">New Record State Extraction SMT</a>. Our <a href="https://github.com/scylladb/scylla-cdc-source-connector#scyllaextractnewstate-transformer">ScyllaExtractNewState</a> SMT works by applying Debezium&#8217;s New Record State Extraction and flattening the <code>{"value": &#8230;&#8203;}</code> structures (at the expense of not being able to distinguish <code>NULL</code> value and missing column value):</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="json"><span class="key"><span class="delimiter">&quot;</span><span class="content">v1</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
<span class="key"><span class="delimiter">&quot;</span><span class="content">v2</span><span class="delimiter">&quot;</span></span>: <span class="value">null</span>,
<span class="key"><span class="delimiter">&quot;</span><span class="content">v3</span><span class="delimiter">&quot;</span></span>: <span class="value">null</span></code></pre> </div> </div> <div class="paragraph"> <p>Scylla’s CDC also supports recording pre-images and post-images with every operation (at an additional cost). We plan to add support for them in the future versions of the Scylla CDC Source Connector.</p> </div> </div> </div> <div class="sect1"> <h2 id="horizontal_scaling">Horizontal scaling</h2> <div class="sectionbody"> <div class="paragraph"> <p>Even at a stage of proof-of-concept, great performance was a paramount requirement. Scylla databases can scale to hundreds of nodes and PBs of data, so it became clear that a single Kafka Connect worker node (even multithreaded) could not handle the load of a big Scylla cluster.</p> </div> <div class="paragraph"> <p>Thankfully, we took that into consideration while implementing CDC functionality in Scylla. Generally, you can think of Change Data Capture as a time-ordered queue of changes. To allow for horizontal scaling, Scylla maintains a set of multiple time-ordered queues of changes, called streams. When there is only a single consumer of the CDC log, it has to query all streams to properly read all changes. A benefit of this design is that you can introduce additional consumers, assigning a disjunct set of streams to each one of them. As a result, you can greatly increase the parallelism of processing the CDC log.</p> </div> <div class="paragraph"> <p>That’s the approach we implemented in the Scylla CDC Source Connector. When starting, the connector first reads the identifiers of all available streams. Next, it distributes them among many Kafka Connect tasks (configurable by <code>tasks.max</code>).</p> </div> <div class="paragraph"> <p>Each created Kafka Connect task (that can run on a separate Kafka Connect node) reads CDC changes from its assigned set of streams. If you double the number of tasks, each task will have to read only a half of the number of streams - half of data throughput, making it possible to handle a higher load.</p> </div> <div class="sect2"> <h3 id="solving_large_stream_count_problem">Solving large stream count problem</h3> <div class="paragraph"> <p>While designing CDC functionality in Scylla, we had to carefully pick the number of streams that would be created. If we chose too few streams, a consumer could possibly not keep up with the data throughput of a single stream. That could also slow down INSERT, UPDATE, DELETE operations, because many concurrent operations would fight for access to a single stream. However, if Scylla created too many streams, the consumers would have to issue a large number of queries to Scylla (to cover each stream), causing unnecessary load.</p> </div> <div class="paragraph"> <p>The current implementation of CDC in Scylla creates <code>number_of_nodes * number_of_vnodes_per_node * number_of_shards</code> streams per cluster. The number of VNodes refers to the fact that Scylla uses a <a href="https://docs.scylladb.com/architecture/ringarchitecture/">Ring architecture</a>, which has 256 VNodes per node by default. Each Scylla node consists of several independent shards, which contain their share of the node’s total data. Typically, there is one shard per each hyperthread or physical core.</p> </div> <div class="paragraph"> <p>For example, if you create a 4-node i3.metal (72 vCPU per node) Scylla cluster, which is capable of roughly 600k operations per second (half INSERTs, half SELECTs), that would be: <code>4 * 256 * 72 = 73728</code> streams.</p> </div> <div class="paragraph"> <p>We quickly realised that this many streams could be a problem in bigger clusters:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Too many queries to Scylla - one query per each stream</p> </li> <li> <p>Too many Kafka Connect offsets - one offset per each stream. Storing offsets means the connector can resume from the last saved position after a crash.</p> </li> </ol> </div> <div class="paragraph"> <p>To mitigate those problems, we made a decision to group streams on the client side. We chose to group the streams by VNode. This reduced the count from <code>number_of_nodes * number_of_vnodes_per_node * number_of_shards</code> to <code>number_of_nodes * number_of_vnodes_per_node</code>. In the case of 4-node i3.metal that means a reduction from 73728 to 1024: only 1024 queries to Scylla and 1024 offsets stored on Kafka.</p> </div> <div class="paragraph"> <p>However, we were still uneasy about the number of offsets to be stored on Kafka. When we looked into other connectors, most of them stored only a single offset or at most tens of offsets per replicated table (and as an effect having a limited scalability).</p> </div> <div class="paragraph"> <p>To understand why storing thousands of streams on Kafka Connect could be a problem, let’s look at how it works under the hood. Each Kafka Connect record created by a source connector contains a key/value offset, for example: key - <code>my_table</code>; offset - <code>25</code>, which could represent that the connector finished reading 25 rows in <code>my_table</code>. Periodically (configured by <code>offset.flush.interval.ms</code>), those offsets are flushed to a Kafka topic called <code>connect-offsets</code>, as regular Kafka messages.</p> </div> <div class="paragraph"> <p>Unfortunately, Kafka is not a key/value store. When a connector starts up, it must scan all messages on the <code>connect-offsets</code> topic to find the one it needs. When it updates a previously saved offset, it just appends the new value to this topic without deleting the previous entry. It’s not a problem with connectors that have only a single offset - when updated every minute, this topic would hold roughly 10,000 messages after a week. However, in the case of the Scylla CDC Source Connector this number could be several orders of magnitude larger!</p> </div> <div class="paragraph"> <p>Fortunately, this issue can be easily mitigated by setting a more aggressive compaction configuration on the <code>connect-offsets</code> topic. With the default configuration of <code>retention.ms</code> of 7 days and <code>segment.bytes</code> of 1GB, this topic could grow up to several hundred megabytes after just a few hours (with a Scylla cluster with tens of nodes and very small <code>offset.flush.interval.ms</code>). This made the connector startup time slower, as it had to scan the entire offset topic after a start/restart. By tuning the <code>segment.bytes</code>, <code>segment.ms</code> or <code>cleanup.policy</code>, <code>retention.ms</code> we were able to mitigate the problem and significantly reduce the <code>connect-offsets</code> topic size. The first two options specify the frequency of the log compaction process. When a segment is compacted, all messages with the same key are reduced to the latest one (the latest offset). Alternatively, setting a shorter retention time (but one that is larger than Scylla’s CDC retention time) proved to be a good option to reduce the offset topic size.</p> </div> </div> <div class="sect2"> <h3 id="benchmarks_near_linear_scaling">Benchmarks: near linear scaling</h3> <div class="paragraph"> <p>To verify that our connector can actually scale horizontally, we performed a benchmark to measure the maximum throughput of Scylla CDC Source Connector on increasingly larger Kafka Connect clusters.</p> </div> <div class="paragraph"> <p>First, we started a single-node i3.4xlarge Scylla cluster (based on the official Scylla AMI). Next, we inserted 50 million rows (total size 5.33GB) to a CDC-enabled table. Later, we started an Apache Kafka 2.6.0 cluster and Kafka Connect cluster on either 1, 3 or 5 nodes (r5n.2xlarge). We started the Scylla CDC Source Connector to consume data from the previously populated CDC-enabled table and measured the time it took to produce all 50 million Kafka messages.</p> </div> <div class="paragraph"> <p>Our connector was able to scale the throughput near linearly:</p> </div> <div class="exampleblock centered-image responsive-image"> <div class="content"> <img src="/assets/images/2021-09-08-deep-dive-into-a-debezium-community-connector-scylla-cdc-source-connector/horizontal_scalability.png" style="max-width:90%;" class="responsive-image"> </div> </div> <table class="tableblock frame-all grid-all stretch"> <colgroup> <col style="width: 50%;"> <col style="width: 33.3333%;"> <col style="width: 16.6667%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Kafka cluster size</th> <th class="tableblock halign-left valign-top">Throughput</th> <th class="tableblock halign-left valign-top">Speedup</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">1 node</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">46k/s</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">1x</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">3 nodes</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">129k/s</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">2.8x</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">5 nodes</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">215k/s</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">4.7x</p></td> </tr> </tbody> </table> </div> </div> </div> <div class="sect1"> <h2 id="conclusion">Conclusion</h2> <div class="sectionbody"> <div class="paragraph"> <p>In this blog post, we took a deep dive into the development of Scylla CDC Source Connector. We started with an overview of CDC implementation in Scylla. We have discussed the reasons we chose Debezium rather than just Kafka Connect API to build our connector, in turn making it familiar to users and Kafka-idiomatic. Next, we looked at two problems we encountered: how to represent Scylla changes and make the connector scalable.</p> </div> <div class="paragraph"> <p>We are very excited to continue improving our connector even further with additional features and making it even more performant. We are eagerly looking forward to watching the Debezium ecosystem grow and integrating functionalities introduced in the latest versions of Debezium.</p> </div> <div class="paragraph"> <p>If you want to check out the connector yourself, the GitHub repository with its source code is available here: <a href="https://github.com/scylladb/scylla-cdc-source-connector">github.com/scylladb/scylla-cdc-source-connector</a>. You can learn more about Scylla here: <a href="https://scylladb.com">scylladb.com</a>.</p> </div> </div> </div></div> </div> <div class="well"> <div class="row"> <div class="col-md-8"> <h2>Piotr Grabowski</h2> <p> <span class="bio-size">Piotr is a software engineer working at ScyllaDB. From a young age, he participated in many competitive programming contests. At ScyllaDB, Piotr works on Kafka connectors and Scylla Java Driver.</span> </p> <p class="bio-size"> <a href="https://github.com/avelanarius"> <i class="icon-github"></i> </a> &nbsp; </p> </div> <div class="col-md-4"> <img alt="" class="img-responsive pull-right portrait" src="/assets/images/pgrabowski.jpg"/> </div> </div> </div> <ul class="pager pager-blog"> <li class="previous"> <a href="/blog/2021/09/16/debezium-1-7-cr1-released/" class="previous"> &laquo; Previous</a> </li> <li class="next"><a href="/blog/2021/09/23/debezium-1-7-cr2-released/">Next &raquo; </a></li> </ul> <div class="row"> <div class="col-md-12"> <hr> <h2>About Debezium</h2> <p> Debezium is an open source distributed platform that turns your existing databases into event streams, so applications can see and respond almost instantly to each committed row-level change in the databases. Debezium is built on top of <a href="http://kafka.apache.org/">Kafka</a> and provides <a href="http://kafka.apache.org/documentation.html#connect">Kafka Connect</a> compatible connectors that monitor specific database management systems. Debezium records the history of data changes in Kafka logs, so your application can be stopped and restarted at any time and can easily consume all of the events it missed while it was not running, ensuring that all events are processed correctly and completely. Debezium is <a href="/license/">open source</a> under the <a href="http://www.apache.org/licenses/LICENSE-2.0.html">Apache License, Version 2.0</a>. </p> </div> </div> <div class="row"> <div class="col-md-12"> <h2>Get involved</h2> <p> We hope you find Debezium interesting and useful, and want to give it a try. Follow us on Twitter <a href="https://twitter.com/debezium">@debezium</a>, <a href="https://debezium.zulipchat.com/#narrow/stream/302529-users">chat with us on Zulip</a>, or join our <a href="https://groups.google.com/forum/#!forum/debezium">mailing list</a> to talk with the community. All of the code is open source <a href="https://github.com/debezium/">on GitHub</a>, so build the code locally and help us improve ours existing connectors and add even more connectors. If you find problems or have ideas how we can improve Debezium, please let us know or <a href="https://issues.redhat.com/projects/DBZ/issues/">log an issue</a>. </p> </div> </div> <div id="disqus_thread"></div> <script>var disqus_config=function(){this.page.url="https://debezium.io/blog/2021/09/22/deep-dive-into-a-debezium-community-connector-scylla-cdc-source-connector/",this.page.identifier="https://debezium.io/blog/2021/09/22/deep-dive-into-a-debezium-community-connector-scylla-cdc-source-connector/"};!function(){var e=document,t=e.createElement("script");t.src="https://Debezium.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)}();</script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> </div> </div> </div> <footer class="container"> <div> <div class="row mr-0 ml-0"> <div class="col-md-5 col-md-offset-1"> <h4>Debezium</h4> <p> &#169; 2023 Debezium Community <br/> <br/> <i class="icon-fire"></i> Mixed with <a href="https://getbootstrap.com/">Bootstrap</a>, baked by <a href="https://jekyllrb.com/">Jekyll</a>. <br/> <i class="icon-flag"></i> Website and docs licensed under <a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>. <br/> <i class="icon-flag-alt"></i> Code released under <a href="https://www.apache.org/licenses/LICENSE-2.0.html">Apache License, v2.0</a>. <br/> <i class="icon-file-alt"></i> <a href="https://www.redhat.com/legal/legal_statement.html" title="Terms">Terms</a> | <a href="https://www.redhat.com/legal/privacy_statement.html" title="Privacy Policy">Privacy</a> </p> <p>Rev: <a target="_blank" href="https://github.com/debezium/debezium.github.io/commit/b5ad192c050333b32f51b89110f5e46cc4e6d4dc">b5ad192</a> </p> </div> <div class="col-md-3"> <h4>Documentation</h4> <ul class="list-unstyled"> <li><a href="/documentation/reference/stable/features.html" title="Features">Features</a></li> <li> <a href="/documentation/reference/stable/install.html" title="Install">Install</a> </li> <li> <a href="/documentation/reference/stable/architecture.html" title="Architecture">Architecture</a> </li> <li><a href="/documentation/faq/" title="FAQ">FAQ</a></li> <li> <a href="/community/contribute/" title="Contribute">Contribute</a> </li> </ul> </div> <div class="col-md-3"> <h4>Connect</h4> <ul class="list-unstyled"> <li><a href="/blog" title="Blog">Blog</a></li> <li> <a href="https://twitter.com/debezium" title="Twitter">Twitter</a> </li> <li><a href="https://github.com/debezium" title="GitHub">GitHub</a></li> <li><a href="https://debezium.zulipchat.com/#narrow/stream/302529-users" title="Chat">Chat</a></li> <li> <a href="https://groups.google.com/forum/#!forum/debezium" title="Google Groups">Google Groups</a> </li> <li> <a href="https://stackoverflow.com/questions/tagged/debezium" title="StackOverflow">StackOverflow</a> </li> </ul> </div> </div> </div> </footer> <div class="container" id="companyfooter"> <div class="redhatlogo"> <a href="https://www.redhat.com/"> <img src="/assets/images/Logo-Red_Hat-Sponsored_By-B-Standard-RGB.svg"/> </a> </div> </div> </div> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-76464546-1"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-76464546-1");</script> <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script> <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script> <script type="text/javascript" src="/assets/javascript/vanilla-back-to-top.min.js"></script> <script type="text/javascript" src="/assets/javascript/highlight.min.js"></script> <script>addBackToTop({scrollDuration:400}),hljs.initHighlightingOnLoad();</script> </body> </html>