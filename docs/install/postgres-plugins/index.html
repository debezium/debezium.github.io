<!DOCTYPE html> <html lang="en"> <head> <title>Logical Decoding Output Plug-in Installation for PostgreSQL · Debezium</title> <meta charset="utf-8"> <meta content="width=device-width, initial-scale=1.0" name="viewport"> <meta content="" name="description"> <meta content="" name="author"> <link href="https://static.jboss.org/theme/css/bootstrap-community/3.2.0.2/bootstrap-community.min.css" media="screen" rel="stylesheet"> <!--[if lt IE 9]><script src="https://static.jboss.org/theme/js/libs/html5/pre3.6/html5.min.js"></script><![endif]--> <link href="https://static.jboss.org/example/images/favicon.ico" rel="shortcut icon"> <link href="https://static.jboss.org/example/images/apple-touch-icon-144x144-precomposed.png" rel="apple-touch-icon-precomposed" sizes="144x144"> <link href="https://static.jboss.org/example/images/apple-touch-icon-114x114-precomposed.png" rel="apple-touch-icon-precomposed" sizes="114x114"> <link href="https://static.jboss.org/example/images/apple-touch-icon-72x72-precomposed.png" rel="apple-touch-icon-precomposed" sizes="72x72"> <link href="https://static.jboss.org/example/images/apple-touch-icon-precomposed.png" rel="apple-touch-icon-precomposed"> <link href="/stylesheets/debezium.css" rel="stylesheet" type="text/css"> <style>
      @media (min-width: 980px) {
        .banner { background-image: url(https://static.jboss.org/example/images/debezium-banner-1180px.png); height: 110px;  }
      }
      @media (max-width: 979px) {
        .banner { background-image: url(https://static.jboss.org/example/images/debezium-logo.png); background-repeat:no-repeat; background-position: center bottom; height: 60px; }
      }
      @media (max-width: 650px) {
        .banner { width: 100%; margin: 0px auto; }
      }
      @media (max-width: 450px) {
        .banner { height: 90px; }
      }
    </style> <link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/styles/default.min.css" rel="stylesheet"> <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/highlight.min.js"></script> <script>
      hljs.initHighlightingOnLoad();
    </script> <script src="https://static.jboss.org/theme/js/libs/jquery/jquery-1.9.1.min.js"></script> <style>
      /* adjusting the vertical spacing for when a stickynav is engaged */
      .breadcrumb-fixed > .active {
        color: #8c8f91;
      }
      .breadcrumb-fixed {
        margin: 70px 0 10px;
        padding: 8px 15px;
        margin-bottom: 20px;
        list-style: none;
        background-color: #f5f5f5;
        border-radius: 4px;
      }
      
      .breadcrumb-fixed > li {
        display: inline-block;
      }
    </style> </head> <body> <div id="rhbar"> <a class="jbdevlogo" href="https://www.jboss.org/projects/about"></a> <a class="rhlogo" href="https://www.redhat.com/"></a> </div> <div id=""> <ul class="visuallyhidden" id="top"> <li> <a accesskey="n" href="#nav" title="Skip to navigation">Skip to navigation</a> </li> <li> <a accesskey="c" href="#page" title="Skip to content">Skip to content</a> </li> </ul> <div class="container" id="content"> <div class="navbar navbar-inverse navbar-fix"> <div class="container-fluid"> <div class="navbar-header"> <button class="navbar-toggle collapsed" data-target="#navbar-1" data-toggle="collapse"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href="/"> Debezium </a> </div> <div class="collapse navbar-collapse" id="navbar-1"> <ul class="nav navbar-nav pull-right"> <li class=""><a href="/docs/faq/">FAQ</a></li> <li class="active"><a href="/docs/">DOCS</a></li> <li class=""><a href="/community/">COMMUNITY</a></li> <li class=""><a href="/blog/">BLOG</a></li> </ul> </div> </div> </div> <div id="equalHeightsLayout"> <div class="col-sm-3" id="leftdocnav"> <div class="panel-group" id="accordion1"> <div class="panel panel-docnav"> <div class="panel-heading"> <h4 class="panel-title"> <a class="accordion-toggle" data-parent="#accordion1,#accordion2,#accordion3,#accordion4,#accordion5" data-toggle="collapse" href="#collapse1"> Get Started </a> </h4> </div> <div class="collapse in panel-collapse" id="collapse1"><div class="panel-body"> <ul class="list-group"> <li class="list-group-item"><a href="/docs/concepts/">Concepts</a></li> <li class="list-group-item"><a href="/docs/tutorial/">Tutorial</a></li> <li class="active list-group-item"><a href="/docs/install/">Installing Debezium</a></li> <li class="list-group-item"><a href="/docs/embedded/">Embedding Debezium</a></li> <li class="list-group-item"><a href="/docs/openshift/">Running on OpenShift</a></li> <li class="list-group-item"><a href="/docs/monitoring/">Monitoring Debezium</a></li> <li class="list-group-item"><a href="/docs/online-resources/">Resources on the Web</a></li> <li class="list-group-item"><a href="/docs/releases/">Releases</a></li> </ul> </div></div> </div> </div> <div class="panel-group" id="accordion2"> <div class="panel panel-docnav"> <div class="panel-heading"> <h4 class="panel-title"> <a class="accordion-toggle" data-parent="#accordion1,#accordion2,#accordion3,#accordion4,#accordion5" data-toggle="collapse" href="#collapse2"> Configuration </a> </h4> </div> <div class="collapse panel-collapse" id="collapse2"><div class="panel-body"> <ul class="list-group"> <li class="list-group-item"><a href="/docs/configuration/logging/">Logging</a></li> <li class="list-group-item"><a href="/docs/configuration/avro/">Avro Serialization</a></li> <li class="list-group-item"><a href="/docs/configuration/topic-routing/">Topic Routing</a></li> <li class="list-group-item"><a href="/docs/configuration/event-flattening/">CDC Event Flattening</a></li> <li class="list-group-item"><a href="/docs/configuration/mongodb-event-flattening/">MongoDB CDC Event Flattening</a></li> </ul> </div></div> </div> </div> <div class="panel-group" id="accordion3"> <div class="panel panel-docnav"> <div class="panel-heading"> <h4 class="panel-title"> <a class="accordion-toggle" data-parent="#accordion1,#accordion2,#accordion3,#accordion4,#accordion5" data-toggle="collapse" href="#collapse3"> Connectors </a> </h4> </div> <div class="collapse panel-collapse" id="collapse3"><div class="panel-body"> <ul class="list-group"> <li class="list-group-item"><a href="/docs/connectors/mysql/">MySQL</a></li> <li class="list-group-item"><a href="/docs/connectors/mongodb/">MongoDB</a></li> <li class="list-group-item"><a href="/docs/connectors/postgresql/">PostgreSQL</a></li> <li class="list-group-item"><a href="/docs/connectors/oracle/">Oracle</a></li> <li class="list-group-item"><a href="/docs/connectors/sqlserver/">SQL Server</a></li> </ul> </div></div> </div> </div> <div class="panel-group" id="accordion4"> <div class="panel panel-docnav"> <div class="panel-heading"> <h4 class="panel-title"> <a class="accordion-toggle" data-parent="#accordion1,#accordion2,#accordion3,#accordion4,#accordion5" data-toggle="collapse" href="#collapse4"> How it works </a> </h4> </div> <div class="collapse panel-collapse" id="collapse4"><div class="panel-body"> <ul class="list-group"> <li class="list-group-item"><a href="/docs/faq/">FAQ</a></li> <li class="list-group-item"><a href="/docs/architecture/">Debezium Architecture</a></li> <li class="list-group-item"><a href="/docs/features/">Debezium Features</a></li> </ul> </div></div> </div> </div> <div class="panel-group" id="accordion5"> <div class="panel panel-docnav"> <div class="panel-heading"> <h4 class="panel-title"> <a class="accordion-toggle" data-parent="#accordion1,#accordion2,#accordion3,#accordion4,#accordion5" data-toggle="collapse" href="#collapse5"> Contribute </a> </h4> </div> <div class="collapse panel-collapse" id="collapse5"><div class="panel-body"> <ul class="list-group"> <li class="list-group-item"><a href="/docs/contribute/">Contribute to Debezium</a></li> <li class="list-group-item"><a href="/docs/code-of-conduct/">Code of Conduct</a></li> <li class="list-group-item"> <a href="https://twitter.com/debezium">Twitter</a> </li> <li class="list-group-item"> <a href="https://gitter.im/debezium/dev">Chat</a> </li> <li class="list-group-item"> <a href="https://github.com/debezium/">Code</a> </li> <li class="list-group-item"> <a href="https://issues.jboss.org/projects/DBZ/issues">Issues</a> </li> </ul> </div></div> </div> </div> <div class="panel-group" id="accordion6"> <div class="panel panel-docnav"> <div class="panel-heading"> <h4 class="panel-title"> <a href="/docs/roadmap/">Roadmap</a> </h4> </div> </div> </div> </div> <div class="col-sm-9" id="maincol"> <h1 class="title"> Logical Decoding Output Plug-in Installation for PostgreSQL </h1> <div id="preamble"> <div class="sectionbody"> <div id="toc" class="toc"> <div id="toctitle" class="title">Table of Contents</div> <ul class="sectlevel1"> <li><a href="#logical-decoding-plugin-setup">Logical Decoding Plug-ins</a> <ul class="sectlevel2"> <li><a href="#logical-decoding-output-plugin-installation">Installation</a></li> <li><a href="#postgresql-server-configuration">PostgreSQL Server Configuration</a></li> <li><a href="#database-test-environment-setup">Database Test Environment Set-up</a></li> <li><a href="#decoding-output-plugin-test">Decoding Output Plug-in Test</a></li> </ul> </li> </ul> </div> <div class="paragraph"> <p>This document describes the database setup required for streaming data changes out of <a href="https://www.postgresql.org/">PostgreSQL</a>. This comprises configuration applying to the database itself as well as the installation of the <a href="https://github.com/eulerto/wal2json">wal2json</a> logical decoding output plug-in. The installation and the tests are performed at the following environment/configuration:</p> </div> <div class="ulist"> <ul> <li> <p><a href="https://www.postgresql.org/docs/9.6/static/index.html">PostgreSQL (v9.6.10)</a></p> </li> <li> <p><a href="https://github.com/eulerto/wal2json">wal2json</a></p> </li> <li> <p><a href="https://www.centos.org/">CentOS 7</a></p> </li> </ul> </div> <div class="paragraph"> <p>Similar steps need to be taken for other Postgres and OS versions and the Decoderbufs logical decoding plug-in which also is supported by Debezium.</p> </div> </div> </div> <div class="sect1"> <h2 id="logical-decoding-plugin-setup"><a class="anchor" href="#logical-decoding-plugin-setup"></a>Logical Decoding Plug-ins</h2> <div class="sectionbody"> <div class="paragraph"> <p>Logical decoding is the process of extracting all persistent changes to a database&#8217;s tables into a coherent, easy to understand format which can be interpreted without detailed knowledge of the database&#8217;s internal state.</p> </div> <div class="paragraph"> <p>As of PostgreSQL 9.4, logical decoding is implemented by decoding the contents of the write-ahead log, which describe changes on a storage level, into an application-specific form such as a stream of tuples or SQL statements. In the context of logical replication, a slot represents a stream of changes that can be replayed to a client in the order they were made on the origin server. Each slot streams a sequence of changes from a single database. The output plug-ins transform the data from the write-ahead log&#8217;s internal representation into the format the consumer of a replication slot desires. Plug-ins are written in C, compiled, and installed on the machine which runs the PostgreSQL server, and they use a number of PostgreSQL specific APIs, as described by the <a href="https://www.postgresql.org/docs/9.6/static/logicaldecoding-output-plugin.html">PostgreSQL documentation</a>.</p> </div> <div class="paragraph"> <p>Debezium’s PostgreSQL connector works with one of Debezium’s supported logical decoding plug-ins,</p> </div> <div class="ulist"> <ul> <li> <p><a href="https://github.com/debezium/postgres-decoderbufs/blob/master/README.md">protobuf</a> or</p> </li> <li> <p><a href="https://github.com/eulerto/wal2json/blob/master/README.md">wal2json</a></p> </li> </ul> </div> <div class="paragraph"> <p>to encode the changes in either <a href="https://github.com/google/protobuf">Protobuf</a> format or <a href="http://www.json.org/">JSON</a> format.</p> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> <div class="paragraph"> <p>For simplicity, Debezium also provides a Docker image based on a vanilla <a href="https://github.com/debezium/docker-images/tree/master/postgres/9.6">PostgreSQL server image</a> on top of which it compiles and installs the plug-ins.</p> </div> </td> </tr> </table> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> <div class="paragraph"> <p>The Debezium logical decoding plug-ins have only been installed and tested on <em>Linux</em> machines. For Windows and other platforms it may require different installation steps</p> </div> </td> </tr> </table> </div> <h4 id="differences_between_plug_ins" class="discrete">Differences between Plug-ins</h4> <div class="paragraph"> <p>The plug-ins' behaviour is not completely same for all cases. So far these differences have been identified</p> </div> <div class="ulist"> <ul> <li> <p>wal2json plug-in is not able to process quoted identifiers (<a href="https://github.com/eulerto/wal2json/issues/35">issue</a>)</p> </li> <li> <p>wal2json plug-in does not emit events for tables without primary keys</p> </li> <li> <p>wal2json plug-in does not support special values (<code>NaN</code> or <code>infinity</code>) for floating point types</p> </li> </ul> </div> <div class="paragraph"> <p>All up-to-date differences are tracked in a test suite <a href="https://github.com/debezium/debezium/blob/master/debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/DecoderDifferences.java">Java class</a>.</p> </div> <div class="paragraph"> <p>More information about the logical decoding and output plug-ins can be found at:</p> </div> <div class="ulist"> <ul> <li> <p><a href="https://www.postgresql.org/docs/9.6/static/logicaldecoding-explanation.html">PostgreSQL logical decoding explanation</a></p> </li> <li> <p><a href="https://www.postgresql.org/docs/9.6/static/logicaldecoding-output-plugin.html">PostgreSQL logical decoding output plug-in</a></p> </li> <li> <p><a href="https://wiki.postgresql.org/wiki/Logical_Decoding_Plugins">PostgreSQL logical decoding plug-ins</a></p> </li> </ul> </div> <div class="sect2"> <h3 id="logical-decoding-output-plugin-installation"><a class="anchor" href="#logical-decoding-output-plugin-installation"></a>Installation</h3> <div class="paragraph"> <p>At the current installation example, the <a href="https://github.com/eulerto/wal2json">wal2json</a> output plug-in for logical decoding is used. The wal2json output plug-in produces a JSON object per transaction. All of the new/old tuples are available in the JSON object. The plug-in <strong>compilation and installation</strong> is performed by executing the related commands extracted from the <a href="https://github.com/debezium/docker-images/blob/master/postgres/9.6/Dockerfile">Debezium docker image file</a>.</p> </div> <div class="paragraph"> <p>Before executing the commands, make sure that the user has the privileges to write the <code>wal2json</code> library at the PostgreSQL <code><em>lib</em></code> directory (at the test environment, the directory is: <code>/usr/pgsql-9.6/lib/</code>). Also note that the installation process requires the PostgreSQL utility <a href="https://www.postgresql.org/docs/9.6/static/app-pgconfig.html">pg_config</a>. Verify that the <code>PATH</code> environment variable is set so as the utility can be found. If not, update the <code>PATH</code> environment variable appropriately. For example at the test environment:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export PATH="$PATH:/usr/pgsql-9.6/bin"</code></pre> </div> </div> <div class="listingblock"> <div class="title"><strong>wal2json</strong> installation commands</div> <div class="content"> <pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ git clone https://github.com/eulerto/wal2json -b master --single-branch \&#x000A;&amp;&amp; cd wal2json \&#x000A;&amp;&amp; git checkout d2b7fef021c46e0d429f2c1768de361069e58696 \&#x000A;&amp;&amp; make &amp;&amp; make install \&#x000A;&amp;&amp; cd .. \&#x000A;&amp;&amp; rm -rf wal2json</code></pre> </div> </div> <div class="listingblock"> <div class="title"><strong>wal2json</strong> installation output</div> <div class="content"> <pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Cloning into 'wal2json'...&#x000A;remote: Counting objects: 445, done.&#x000A;remote: Total 445 (delta 0), reused 0 (delta 0), pack-reused 445&#x000A;Receiving objects: 100% (445/445), 180.70 KiB | 0 bytes/s, done.&#x000A;Resolving deltas: 100% (317/317), done.&#x000A;Note: checking out 'd2b7fef021c46e0d429f2c1768de361069e58696'.&#x000A;&#x000A;You are in 'detached HEAD' state. You can look around, make experimental&#x000A;changes and commit them, and you can discard any commits you make in this&#x000A;state without impacting any branches by performing another checkout.&#x000A;&#x000A;If you want to create a new branch to retain commits you create, you may&#x000A;do so (now or later) by using -b with the checkout command again. Example:&#x000A;&#x000A;  git checkout -b new_branch_name&#x000A;&#x000A;HEAD is now at d2b7fef... Improve style&#x000A;gcc -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fexcess-precision=standard -O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -fPIC -I. -I./ -I/usr/pgsql-9.6/include/server -I/usr/pgsql-9.6/include/internal -D_GNU_SOURCE -I/usr/include/libxml2  -I/usr/include  -c -o wal2json.o wal2json.c&#x000A;gcc -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fexcess-precision=standard -O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -fPIC -L/usr/pgsql-9.6/lib -Wl,--as-needed  -L/usr/lib64 -Wl,--as-needed -Wl,-rpath,'/usr/pgsql-9.6/lib',--enable-new-dtags  -shared -o wal2json.so wal2json.o&#x000A;/usr/bin/mkdir -p '/usr/pgsql-9.6/lib'&#x000A;/usr/bin/install -c -m 755  wal2json.so '/usr/pgsql-9.6/lib/'</code></pre> </div> </div> </div> <div class="sect2"> <h3 id="postgresql-server-configuration"><a class="anchor" href="#postgresql-server-configuration"></a>PostgreSQL Server Configuration</h3> <div class="paragraph"> <p>Once the <strong>wal2json</strong> plug-in has been installed, the database server should be configured.</p> </div> <h3 id="em_setting_up_libraries_wal_and_replication_parameters_em" class="discrete"><em>Setting up libraries, WAL and replication parameters</em></h3> <div class="paragraph"> <p>Add the following lines at the end of the <code>postgresql.conf</code> PostgreSQL configuration file in order to include the plug-in at the shared libraries and to adjust some <a href="https://www.postgresql.org/docs/9.6/static/runtime-config-wal.html">WAL</a> and <a href="https://www.postgresql.org/docs/9.6/static/runtime-config-replication.html">streaming replication</a> settings. The configuration is extracted from <a href="https://github.com/debezium/docker-images/blob/master/postgres/9.6/postgresql.conf.sample">postgresql.conf.sample</a>. You may need to modify it, if for example you have additionally installed <code>shared_preload_libraries</code>.</p> </div> <div class="listingblock"> <div class="title"><strong><em>postgresql.conf</em></strong> <em>, configuration file parameters settings</em></div> <div class="content"> <pre class="highlightjs highlight"><code>############ REPLICATION ##############&#x000A;# MODULES&#x000A;shared_preload_libraries = 'wal2json'   <i class="conum" data-value="1"></i><b>(1)</b>&#x000A;&#x000A;# REPLICATION&#x000A;wal_level = logical                     <i class="conum" data-value="2"></i><b>(2)</b>&#x000A;max_wal_senders = 4                     <i class="conum" data-value="3"></i><b>(3)</b>&#x000A;max_replication_slots = 4               <i class="conum" data-value="4"></i><b>(4)</b></code></pre> </div> </div> <div class="colist arabic"> <table> <tr> <td><i class="conum" data-value="1"></i><b>1</b></td> <td>tells the server that it should load at startup the <code>wal2json</code> (use <code>decoderbufs</code> for <a href="https://github.com/google/protobuf">protobuf</a>) logical decoding plug-in(s) (the names of the plug-ins are set in <a href="https://github.com/debezium/postgres-decoderbufs/blob/v0.9.1.Final/Makefile">protobuf</a> and <a href="https://github.com/eulerto/wal2json/blob/master/Makefile">wal2json</a> Makefiles)</td> </tr> <tr> <td><i class="conum" data-value="2"></i><b>2</b></td> <td>tells the server that it should use logical decoding with the write-ahead log</td> </tr> <tr> <td><i class="conum" data-value="3"></i><b>3</b></td> <td>tells the server that it should use a maximum of <code>4</code> separate processes for processing WAL changes</td> </tr> <tr> <td><i class="conum" data-value="4"></i><b>4</b></td> <td>tells the server that it should allow a maximum of <code>4</code> replication slots to be created for streaming WAL changes</td> </tr> </table> </div> <div class="paragraph"> <p>Debezium needs a PostgreSQL&#8217;s WAL to be kept during Debezium outages. If your WAL retention is too small and outages too long, then Debezium will not be able to recover after restart as it will miss part of the data changes. The usual indicator is an error similar to this thrown during the startup: <code>ERROR: requested WAL segment 000000010000000000000001 has already been removed</code>.</p> </div> <div class="paragraph"> <p>When this happens then it is necessary to re-execute the snapshot of the database. We also recommend to set parameter <code>wal_keep_segments = 0</code>. Please follow PostgreSQL official documentation for fine-tuning of WAL retention.</p> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> <div class="paragraph"> <p>We strongly recommend reading and understanding <a href="https://www.postgresql.org/docs/9.6/static/wal-configuration.html">the official documentation</a> regarding the mechanics and configuration of the PostgreSQL write-ahead log.</p> </div> </td> </tr> </table> </div> <h3 id="setting_replication_permissions" class="discrete"><em>Setting up replication permissions</em></h3> <div class="paragraph"> <p>Replication can only be performed by a database user that has appropriate permissions and only for a configured number of hosts. In order to give a user replication permissions, define a PostgreSQL role that has <em>at least</em> the <code>REPLICATION</code> and <code>LOGIN</code> permissions. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">CREATE ROLE name REPLICATION LOGIN;</code></pre> </div> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> <div class="paragraph"> <p>Superusers have by default both of the above roles.</p> </div> </td> </tr> </table> </div> <div class="paragraph"> <p>Add the following lines at the end of the <code>pg_hba.conf</code> PostgreSQL configuration file, so as to configure the <a href="https://www.postgresql.org/docs/9.6/static/auth-pg-hba-conf.html">client authentication</a> for the database replication. The PostgreSQL server should allow replication to take place between the server machine and the host on which the Debezium PostgreSQL connector is running.</p> </div> <div class="paragraph"> <p>Note that the authentication refers to the database superuser <code>postgres</code>. You may change this accordingly, if some other user with <code>REPLICATION</code> and <code>LOGIN</code> permissions has been created.</p> </div> <div id="pg_hba_conf" class="listingblock"> <div class="title"><strong><em>pg_hba.conf</em></strong> <em>, configuration file parameters settings</em></div> <div class="content"> <pre class="highlightjs highlight"><code>############ REPLICATION ##############&#x000A;local   replication     postgres                          trust		<i class="conum" data-value="1"></i><b>(1)</b>&#x000A;host    replication     postgres  127.0.0.1/32            trust		<i class="conum" data-value="2"></i><b>(2)</b>&#x000A;host    replication     postgres  ::1/128                 trust		<i class="conum" data-value="3"></i><b>(3)</b></code></pre> </div> </div> <div class="colist arabic"> <table> <tr> <td><i class="conum" data-value="1"></i><b>1</b></td> <td>tells the server to allow replication for <code>postgres</code> locally (i.e. on the server machine)</td> </tr> <tr> <td><i class="conum" data-value="2"></i><b>2</b></td> <td>tells the server to allow <code>postgres</code> on <code>localhost</code> to receive replication changes using <code>IPV4</code></td> </tr> <tr> <td><i class="conum" data-value="3"></i><b>3</b></td> <td>tells the server to allow <code>postgres</code> on <code>localhost</code> to receive replication changes using <code>IPV6</code></td> </tr> </table> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> <div class="paragraph"> <p>See <a href="https://www.postgresql.org/docs/9.6/static/datatype-net-types.html">the PostgreSQL documentation</a> for more information on network masks.</p> </div> </td> </tr> </table> </div> </div> <div class="sect2"> <h3 id="database-test-environment-setup"><a class="anchor" href="#database-test-environment-setup"></a>Database Test Environment Set-up</h3> <div class="paragraph"> <p>For the testing purposes, a database named <strong><code>test</code></strong> with a table named <strong><code>test_table</code></strong> are created with the following DDL commands:</p> </div> <div class="listingblock"> <div class="title"><em>Database SQL commands for test database/table creation</em></div> <div class="content"> <pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">CREATE DATABASE test;&#x000A;&#x000A;CREATE TABLE test_table (&#x000A;    id char(10) NOT NULL,&#x000A;    code        char(10),&#x000A;    PRIMARY KEY (id)&#x000A;);</code></pre> </div> </div> </div> <div class="sect2"> <h3 id="decoding-output-plugin-test"><a class="anchor" href="#decoding-output-plugin-test"></a>Decoding Output Plug-in Test</h3> <div class="paragraph"> <p>Test that the <code>wal2json</code> is working properly by obtaining the <code>test_table</code> changes using the <a href="https://www.postgresql.org/docs/9.6/static/app-pgrecvlogical.html">pg_recvlogical</a> PostgreSQL client application that controls PostgreSQL logical decoding streams.</p> </div> <div class="paragraph"> <p>Before starting make sure that you have logged in as a user with database replication permissions, as configured at a <a href="#setting_replication_permissions">previous step</a>. Otherwise, the slot creation and streaming fails with the following error message:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">pg_recvlogical: could not connect to server: FATAL:  no pg_hba.conf entry for replication connection from host "[local]", user "root", SSL off</code></pre> </div> </div> <div class="paragraph"> <p>At the test environment, the user with replication permission is the <code>postgres</code>.</p> </div> <div class="paragraph"> <p>Also, make sure that the <code>PATH</code> environment variable is set so as the <code>pg_recvlogical</code> can be found. If not, update the <code>PATH</code> environment variable appropriately. For example at the test environment:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export PATH="$PATH:/usr/pgsql-9.6/bin"</code></pre> </div> </div> <div class="ulist"> <ul> <li> <p><strong>Create a slot</strong> named <code>test_slot</code> for the database named <code>test</code>, using the logical output plug-in <code>wal2json</code></p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ pg_recvlogical -d test --slot test_slot --create-slot -P wal2json</code></pre> </div> </div> <div class="ulist"> <ul> <li> <p><strong>Begin streaming changes</strong> from the logical replication slot <code>test_slot</code> for the database <code>test</code></p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ pg_recvlogical -d test --slot test_slot --start -o pretty-print=1 -f -</code></pre> </div> </div> <div class="ulist"> <ul> <li> <p><strong>Perform some basic DML</strong> operations at <code>test_table</code> to trigger <code>INSERT</code>/<code>UPDATE</code>/<code>DELETE</code> change events</p> </li> </ul> </div> <div class="listingblock"> <div class="title"><em>Interactive PostgreSQL terminal, SQL commands</em></div> <div class="content"> <pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">test=# INSERT INTO test_table (id, code) VALUES('id1', 'code1');&#x000A;INSERT 0 1&#x000A;test=# update test_table set code='code2' where id='id1';&#x000A;UPDATE 1&#x000A;test=# delete from test_table where id='id1';&#x000A;DELETE 1</code></pre> </div> </div> <div class="paragraph"> <p>Upon the <code>INSERT</code>, <code>UPDATE</code> and <code>DELETE</code> events, the <code>wal2json</code> plug-in outputs the table changes as captured by <code>pg_recvlogical</code>.</p> </div> <div class="listingblock"> <div class="title"><em>Output for <code>INSERT</code> event</em></div> <div class="content"> <pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{&#x000A;  "change": [&#x000A;    {&#x000A;      "kind": "insert",&#x000A;      "schema": "public",&#x000A;      "table": "test_table",&#x000A;      "columnnames": ["id", "code"],&#x000A;      "columntypes": ["character(10)", "character(10)"],&#x000A;      "columnvalues": ["id1       ", "code1     "]&#x000A;    }&#x000A;  ]&#x000A;}</code></pre> </div> </div> <div id="update-table-change-event" class="listingblock"> <div class="title"><em>Output for <code>UPDATE</code> event</em></div> <div class="content"> <pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{&#x000A;  "change": [&#x000A;    {&#x000A;      "kind": "update",&#x000A;      "schema": "public",&#x000A;      "table": "test_table",&#x000A;      "columnnames": ["id", "code"],&#x000A;      "columntypes": ["character(10)", "character(10)"],&#x000A;      "columnvalues": ["id1       ", "code2     "],&#x000A;      "oldkeys": {&#x000A;        "keynames": ["id"],&#x000A;        "keytypes": ["character(10)"],&#x000A;        "keyvalues": ["id1       "]&#x000A;      }&#x000A;    }&#x000A;  ]&#x000A;}</code></pre> </div> </div> <div class="listingblock"> <div class="title"><em>Output for <code>DELETE</code> event</em></div> <div class="content"> <pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{&#x000A;  "change": [&#x000A;    {&#x000A;      "kind": "delete",&#x000A;      "schema": "public",&#x000A;      "table": "test_table",&#x000A;      "oldkeys": {&#x000A;        "keynames": ["id"],&#x000A;        "keytypes": ["character(10)"],&#x000A;        "keyvalues": ["id1       "]&#x000A;      }&#x000A;    }&#x000A;  ]&#x000A;}</code></pre> </div> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> <div class="paragraph"> <p>Note that the <a href="#replica-identity">REPLICA IDENTITY</a> of the table <code>test_table</code> is set to <code>DEFAULT</code>.</p> </div> </td> </tr> </table> </div> <div class="paragraph"> <p>When the test is finished, the slot <code>test_slot</code> for the database <code>test</code> can be removed by the following command:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ pg_recvlogical -d test --slot test_slot --drop-slot</code></pre> </div> </div> <div id="replica-identity" class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="paragraph"> <p><a href="https://www.postgresql.org/docs/9.6/static/sql-altertable.html#SQL-CREATETABLE-REPLICA-IDENTITY">REPLICA IDENTITY</a>, is a PostgreSQL specific table-level setting which determines the amount of information that is available to logical decoding in case of <code>UPDATE</code> and <code>DELETE</code> events.</p> </div> <div class="paragraph"> <p>There are 4 possible values for <code>REPLICA IDENTITY</code>:</p> </div> <div class="ulist"> <ul> <li> <p><strong>DEFAULT</strong> - <code>UPDATE</code> and <code>DELETE</code> events will only contain the previous values for the primary key columns of a table</p> </li> <li> <p><strong>NOTHING</strong> - <code>UPDATE</code> and <code>DELETE</code> events will not contain any information about the previous value on any of the table columns</p> </li> <li> <p><strong>FULL</strong> - <code>UPDATE</code> and <code>DELETE</code> events will contain the previous values of all the table&#8217;s columns</p> </li> <li> <p><strong>INDEX</strong> <code>index name</code> - <code>UPDATE</code> and <code>DELETE</code> events will contains the previous values of the columns contained in the index definition named <code>index name</code></p> </li> </ul> </div> <div class="paragraph"> <p>You can modify and check the replica <code>REPLICA IDENTITY</code> for a table with the following commands:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">ALTER TABLE test_table REPLICA IDENTITY FULL;&#x000A;test=# \d+ test_table&#x000A;                         Table "public.test_table"&#x000A; Column |     Type      | Modifiers | Storage  | Stats target | Description&#x000A; -------+---------------+-----------+----------+--------------+------------&#x000A; id     | character(10) | not null  | extended |              |&#x000A; code   | character(10) |           | extended |              |&#x000A;Indexes:&#x000A;    "test_table_pkey" PRIMARY KEY, btree (id)&#x000A;Replica Identity: FULL</code></pre> </div> </div> <div class="paragraph"> <p>Here is the output of <code>wal2json</code> plug-in on <code>DELETE</code> event and <code>REPLICA IDENTITY</code> set to <code>FULL</code>. Compare with the <a href="#update-table-change-event">respective output</a> when <code>REPLICA IDENTITY</code> is set to <code>DEFAULT</code>.</p> </div> <div class="listingblock"> <div class="title"><em>Output for `UPDATE`</em></div> <div class="content"> <pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{&#x000A;  "change": [&#x000A;    {&#x000A;      "kind": "update",&#x000A;      "schema": "public",&#x000A;      "table": "test_table",&#x000A;      "columnnames": ["id", "code"],&#x000A;      "columntypes": ["character(10)", "character(10)"],&#x000A;      "columnvalues": ["id1       ", "code2     "],&#x000A;      "oldkeys": {&#x000A;        "keynames": ["id", "code"],&#x000A;        "keytypes": ["character(10)", "character(10)"],&#x000A;        "keyvalues": ["id1       ", "code1     "]&#x000A;      }&#x000A;    }&#x000A;  ]&#x000A;}</code></pre> </div> </div> </td> </tr> </table> </div> </div> </div> </div> </div> </div> </div> <footer class="container"> <div class="row"> <div class="col-md-5 col-md-offset-1"> <h4>Debezium</h4> <p> &#169; 2019 Debezium Community <br> <br> <i class="icon-fire"></i> Mixed with <a href="http://twitter.github.com/bootstrap">Bootstrap</a>, baked by <a href="http://awestruct.org">Awestruct</a>. <br> <i class="icon-flag"></i> Website and docs licensed under <a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>. <br> <i class="icon-flag-alt"></i> Code released under <a href="http://www.apache.org/licenses/LICENSE-2.0.html">Apache License, v2.0</a>. <br> <i class="icon-file-alt"></i> <a href="https://www.redhat.com/legal/legal_statement.html" title="Terms">Terms</a> | <a href="https://www.redhat.com/legal/privacy_statement.html" title="Privacy Policy">Privacy</a> </p> </div> <div class="col-md-3"> <h4>Documentation</h4> <ul class="list-unstyled"> <li> <a href="/docs/features/" title="Features">Features</a> </li> <li> <a href="/docs/install/" title="Install">Install</a> </li> <li> <a href="/docs/manage/" title="Manage">Manage</a> </li> <li> <a href="/docs/architecture/" title="Architecture">Architecture</a> </li> <li> <a href="/docs/faq/" title="FAQ">FAQ</a> </li> <li> <a href="/docs/contribute/" title="Contribute">Contribute</a> </li> </ul> </div> <div class="col-md-3"> <h4>Connect</h4> <ul class="list-unstyled"> <li> <a href="/blog" title="Blog">Blog</a> </li> <li> <a href="http://twitter.com/debezium" title="Twitter">Twitter</a> </li> <li> <a href="http://github.com/debezium" title="GitHub">GitHub</a> </li> <li> <a href="https://gitter.im/debezium/dev" title="Chat">Chat</a> </li> <li> <a href="https://groups.google.com/forum/#!forum/debezium" title="Google Groups">Google Groups</a> </li> <li> <a href="http://stackoverflow.com/questions/tagged/debezium" title="StackOverflow">StackOverflow</a> </li> </ul> </div> </div> </footer> <div class="container" id="companyfooter"> <div class="redhatlogo"> <div id="logospacer"></div> <a href="https://www.redhat.com/"><img src="https://static.jboss.org/theme/images/common/redhat_logo.png"></a> </div> </div> <span class="backToTop"> <a href="#top">back to top</a> </span> <script src="https://static.jboss.org/theme/js/libs/bootstrap-community/3.2.0.2/bootstrap-community.min.js"></script> <script type='text/javascript' language='JavaScript' src='https://www.redhat.com/j/elqNow/elqCfg.js'></script> <script type='text/javascript' language='JavaScript' src='https://www.redhat.com/j/elqNow/elqImg.js'></script> <div id="oTags"> <script type="text/javascript" src="//www.redhat.com/j/s_code.js"></script> <script type="text/javascript"><!--
        var coreUrl = encodeURI(document.URL.split("?")[0]).replace(/-/g," ");
        var urlSplit = coreUrl.toLowerCase().split(/\//);
        var urlLast = urlSplit[urlSplit.length-1];
        var pageNameString = "";
        var siteName = "";
        var minorSectionIndex = 3
        if (urlLast == "") {
            urlSplit.splice(-1,1);
        }
        if (urlLast.search(/\./) >= 0) {
            if (urlLast == "index.html") {
                urlSplit.splice(-1,1);
            }
            else {
                urlSplit[urlSplit.length-1] = urlLast.split(".").splice(0,1);
            }
        }
        siteName = urlSplit[2].split(".")[1];
        s.prop14 = s.eVar27 = siteName || "";
        s.prop15 = s.eVar28 = urlSplit[minorSectionIndex] || "";
        s.prop16 = s.eVar29 = urlSplit[minorSectionIndex+1] || "";
        pageNameString = urlSplit.splice(3).join(" | ");
        s.pageName = "jboss | community | " + siteName + " | " + pageNameString;
        s.server = "jboss";
        s.channel = "jboss | community";
        s.prop4 = s.eVar23 = encodeURI(document.URL);
        s.prop21 = s.eVar18 = coreUrl;
        s.prop2 = s.eVar22 = "en";
        s.prop3 = s.eVar19 = "us";
        //--></script> <script type="text/javascript" src="//www.redhat.com/j/rh_omni_footer.js"></script> <script language="JavaScript" type="text/javascript"><!--
        if(navigator.appVersion.indexOf('MSIE')>=0)document.write(unescape('%3C')+'\!-'+'-')
        //--></script> <noscript><a href="http://www.omniture.com" title="Web Analytics"><img src="https://smtrcs.redhat.com/b/ss/redhatcom,redhatglobal/1/H.25.4--NS/0?[AQB]&cdp=3&[AQE]" height="1" width="1" border="0" alt=""/></a></noscript> </div> <script type="text/javascript">
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
      </script> <script type="text/javascript">
      try {
      var pageTracker = _gat._getTracker("UA-10656779-1");
      pageTracker._trackPageview();
      } catch(err) {}</script> <script>
       (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
       
      ga('create', 'UA-76464546-1', 'auto');
      ga('send', 'pageview');
      ga('set', 'anonymizeIp', true);
      ga('require', 'linkid', 'linkid.js');
      
      </script> </div> </body> </html>