<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>[DEPRECATED] Embedding Debezium Connectors :: Debezium Documentation</title>
    <link rel="canonical" href="https://www.debezium.io/documentation/reference/operations/embedded.html">
    <meta name="generator" content="Antora 2.3.4">
<link rel="stylesheet" href="../../../debezium-antora/css/site.css">
<link rel="stylesheet" href="../../../debezium-antora/css/debezium-antora.css">
<link rel="stylesheet" href="../../../debezium-antora/css/highlightjs-dark.css">
<link rel="stylesheet" href="https://static.jboss.org/css/rhbar.css">
<script src="//static.jboss.org/theme/js/libs/jquery/jquery-1.9.1.js"></script>
<script src="../../../debezium-antora/js/jquery.ba-floatingscrollbar.js"></script>
</head>
<body class="article">
<header class="header">
  <div id="rhbar">
      <a class="jbdevlogo" href="https://developers.redhat.com"></a>
      <a class="rhlogo" href="https://www.redhat.com"></a>
  </div>
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="/">
          <img src="/assets/images/color_white_debezium_type_600px.svg" style="height: 32px; margin-right: 14px;"/>
      </a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="/documentation/faq">FAQ</a>
        <a class="navbar-item" href="/documentation">DOCUMENTATION</a>
        <a class="navbar-item" href="/releases">RELEASES</a>
        <a class="navbar-item" href="/community">COMMUNITY</a>
        <a class="navbar-item" href="/blog">BLOG</a>
      </div>
    </div>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="reference" data-version="1.2">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Debezium Documentation</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Getting Started</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../tutorial.html">Tutorial</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../install.html">Installation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../postgres-plugins.html">PostgreSQL Decoding Plugins</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../architecture.html">Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../features.html">Features</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Configuration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../configuration/avro.html">Avro Serialization</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../configuration/topic-routing.html">Topic Routing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../configuration/event-flattening.html">New Record State Extraction</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../configuration/mongodb-event-flattening.html">MongoDB New Document State Extraction</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../configuration/outbox-event-router.html">Outbox Event Router</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../configuration/filtering.html">Message Filtering</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../configuration/content-based-routing.html">Content-Based Routing</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Connectors</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/index.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/mysql.html">MySQL</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/mongodb.html">MongoDB</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/postgresql.html">PostgreSQL</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/oracle.html">Oracle</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/sqlserver.html">SQL Server</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/db2.html">Db2</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/cassandra.html">Cassandra</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">API and SPI</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../development/engine.html">Debezium Engine</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../development/converters.html">Custom Converters</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Integrations</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../integrations/serdes.html">Change Event SerDes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../integrations/outbox.html">Outbox Quarkus Extension</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../integrations/cloudevents.html">CloudEvents</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../integrations/testcontainers.html">Integration Testing with Testcontainers</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Operations</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="debezium-server.html">Debezium Server</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="logging.html">Logging</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="monitoring.html">Monitoring</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="openshift.html">Running on Openshift</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="embedded.html">Embedding Debezium</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Debezium Documentation</span>
    <span class="version">1.2</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Debezium Documentation</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../index.html">master</a>
        </li>
        <li class="version">
          <a href="../../1.5/index.html">1.5</a>
        </li>
        <li class="version">
          <a href="../../1.4/index.html">1.4</a>
        </li>
        <li class="version">
          <a href="../../1.3/index.html">1.3</a>
        </li>
        <li class="version is-current">
          <a href="../index.html">1.2</a>
        </li>
        <li class="version">
          <a href="../../1.1/index.html">1.1</a>
        </li>
        <li class="version">
          <a href="../../1.0/index.html">1.0</a>
        </li>
        <li class="version">
          <a href="../../0.10/index.html">0.10</a>
        </li>
        <li class="version">
          <a href="../../0.9/index.html">0.9</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main role="main" class="main">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Debezium Documentation</a></li>
    <li>Operations</li>
    <li><a href="embedded.html">Embedding Debezium</a></li>
  </ul>
</nav>
    <div class="page-versions-container">
    Version:
    <div class="page-versions">
        <button class="version-menu-toggle versions-menu-current" title="Show other versions of page">1.2</button>
        <!--<button class="version-menu-toggle versions-menu-select" title="Select other versions">Select</button>-->
        <div class="version-menu">
                <a class="version" href="../../operations/embedded.html">master</a>
                <a class="version" href="../../1.5/operations/embedded.html">1.5</a>
                <a class="version" href="../../1.4/operations/embedded.html">1.4</a>
                <a class="version" href="../../1.3/operations/embedded.html">1.3</a>
                <a class="version is-current" href="embedded.html">1.2</a>
                <a class="version" href="../../1.1/operations/embedded.html">1.1</a>
                <a class="version" href="../../1.0/operations/embedded.html">1.0</a>
                <a class="version" href="../../0.10/operations/embedded.html">0.10</a>
                <a class="version" href="../../0.9/operations/embedded.html">0.9</a>
        </div>
        |
    </div>
    </div>
  <div class="edit-this-page"><a href="https://github.com/debezium/debezium/edit/1.2/documentation/modules/ROOT/pages/operations/embedded.adoc">Edit this Page</a></div>
  </div>
<div class="article-grid">
<div class="article-cell1">
<article class="doc">
            <div class="version-banner version-banner-outdated">
    You are viewing documentation for an outdated version of Debezium.
    <br/>
            If you want to view the latest stable version of this page, please go <a href="../../1.4/operations/embedded.html">here</a>.
            
</div>            <h1 class="page">[DEPRECATED] Embedding Debezium Connectors</h1>
        <div id="preamble">
<div class="sectionbody">
<div id="toc" class="toc">
<div id="toctitle" class="title">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_dependencies">Dependencies</a></li>
<li><a href="#_in_the_code">In the code</a></li>
<li><a href="#advanced-consuming">Advanced Record Consuming</a></li>
<li><a href="#engine-properties">Engine properties</a></li>
<li><a href="#_handling_failures">Handling failures</a></li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This page describes an internal API that is subject to backwards-incompatible changes in future releases.
Please use the new supported public <a href="../development/engine.html" class="page">Debezium Engine API</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Debezium connectors are normally operated by deploying them to a Kafka Connect service, and configuring one or more connectors to monitor upstream databases and produce data change events for all changes that they see in the upstream databases. Those data change events are written to Kafka, where they can be independently consumed by many different applications. Kafka Connect provides excellent fault tolerance and scalability, since it runs as a distributed service and ensures that all registered and configured connectors are always running. For example, even if one of the Kafka Connect endpoints in a cluster goes down, the remaining Kafka Connect endpoints will restart any connectors that were previously running on the now-terminated endpoint, minimizing downtime and eliminating administrative activities.</p>
</div>
<div class="paragraph">
<p>Not every application needs this level of fault tolerance and reliability, and they may not want to rely upon an external cluster of Kafka brokers and Kafka Connect services. Instead, some applications would prefer to <strong>embed</strong> Debezium connectors directly within the application space. They still want the same data change events, but prefer to have the connectors send them directly to the application rather than persist them inside Kafka.</p>
</div>
<div class="paragraph">
<p>This <code>debezium-embedded</code> module defines a small library that allows an application to easily configure and run Debezium connectors.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_dependencies"><a class="anchor" href="#_dependencies"></a>Dependencies</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To use this module, add the <code>debezium-embedded</code> module to your application&#8217;s dependencies. For Maven, this entails adding the following to your application&#8217;s POM:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.debezium&lt;/groupId&gt;
    &lt;artifactId&gt;debezium-embedded&lt;/artifactId&gt;
    &lt;version&gt;${version.debezium}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>${version.debezium}</code> is either the version of Debezium you&#8217;re using or a Maven property whose value contains the Debezium version string.</p>
</div>
<div class="paragraph">
<p>Likewise, add dependencies for each of the Debezium connectors that your application will use. For example, the following can be added to your application&#8217;s Maven POM file so your application can use the MySQL connector:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.debezium&lt;/groupId&gt;
    &lt;artifactId&gt;debezium-connector-mysql&lt;/artifactId&gt;
    &lt;version&gt;${version.debezium}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or for the MongoDB connector:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.debezium&lt;/groupId&gt;
    &lt;artifactId&gt;debezium-connector-mongodb&lt;/artifactId&gt;
    &lt;version&gt;${version.debezium}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The remainder of this document describes embedding the MySQL connector in your application. Other connectors are used in a similar manner, except with connector-specific configuration, topics, and events.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_in_the_code"><a class="anchor" href="#_in_the_code"></a>In the code</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Your application needs to set up an embedded engine for each connector instance you want to run. The <code>io.debezium.embedded.EmbeddedEngine</code> class serves as an easy-to-use wrapper around any standard Kafka Connect connector and completely manages the connector&#8217;s lifecycle. Basically, you create the <code>EmbeddedEngine</code> with a configuration (perhaps loaded from a properties file) that defines the environment for both the engine and the connector. You also provide the engine with a function that it will call for every data change event produced by the connector.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s an example of code that configures and runs an embedded <a href="#connectors/mysql">MySQL connector</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// Define the configuration for the embedded and MySQL connector ...
Configuration config = Configuration.create()
        /* begin engine properties */
        .with("connector.class",
              "io.debezium.connector.mysql.MySqlConnector")
        .with("offset.storage",
              "org.apache.kafka.connect.storage.FileOffsetBackingStore")
        .with("offset.storage.file.filename",
              "/path/to/storage/offset.dat")
        .with("offset.flush.interval.ms", 60000)
        /* begin connector properties */
        .with("name", "my-sql-connector")
        .with("database.hostname", "localhost")
        .with("database.port", 3306)
        .with("database.user", "mysqluser")
        .with("database.password", "mysqlpw")
        .with("database.server.id", 85744)
        .with("database.server.name", "my-app-connector")
        .with("database.history",
              "io.debezium.relational.history.FileDatabaseHistory")
        .with("database.history.file.filename",
              "/path/to/storage/dbhistory.dat")
        .build();

// Create the engine with this configuration ...
EmbeddedEngine engine = EmbeddedEngine.create()
        .using(config)
        .notifying(this::handleEvent)
        .build();

// Run the engine asynchronously ...
Executor executor = Executors.newSingleThreadExecutor();
executor.execute(engine);

// At some later time ...
engine.stop();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s look into this code in more detail, starting with the first few lines that we repeat here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// Define the configuration for the embedded and MySQL connector ...
Configuration config = Configuration.create()
        /* begin engine properties */
        .with("connector.class",
              "io.debezium.connector.mysql.MySqlConnector")
        .with("offset.storage",
              "org.apache.kafka.connect.storage.FileOffsetBackingStore")
        .with("offset.storage.file.filename",
              "/path/to/storage/offset.dat")
        .with("offset.flush.interval.ms", 60000);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This creates a new <code>Configuration</code> object and uses a fluent-style builder API to set several fields required by the engine regardless of which connector is being used. The first is a name for the engine that will be used within the source records produced by the connector and its internal state, so use something meaningful in your application. The <code>connector.class</code> field defines the name of the class that extends the Kafka Connect <code>org.apache.kafka.connect.source.SourceConnector</code> abstract class; in this example, we specify Debezium&#8217;s <code>MySqlConnector</code> class.</p>
</div>
<div class="paragraph">
<p>When a Kafka Connect connector runs, it reads information from the source and periodically records "offsets" that define how much of that information it has processed. Should the connector be restarted, it will use the last recorded offset to know where in the source information it should resume reading. Since connectors don&#8217;t know or care <strong>how</strong> the offsets are stored, it is up to the engine to provide a way to store and recover these offsets. The next few fields of our configuration specify that our engine should use the <code>FileOffsetBackingStore</code> class to store offsets in the <code>/path/to/storage/offset.dat</code> file on the local file system (the file can be named anything and stored anywhere). Additionally, although the connector records the offsets with every source record it produces, the engine flushes the offsets to the backing store periodically (in our case, once each minute). These fields can be tailored as needed for your application.</p>
</div>
<div class="paragraph">
<p>The next few lines define the fields that are specific to the connector, which in our example is the <code>MySqlConnector</code> connector:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">        /* begin connector properties */
        .with("name", "mysql-connector")
        .with("database.hostname", "localhost")
        .with("database.port", 3306)
        .with("database.user", "mysqluser")
        .with("database.password", "mysqlpw")
        .with("database.server.id", 85744)
        .with("database.server.name", "products")
        .with("database.history",
              "io.debezium.relational.history.FileDatabaseHistory")
        .with("database.history.file.filename",
              "/path/to/storage/dbhistory.dat")
        .build();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, we set the name of the host machine and port number where the MySQL database server is running, and we define the username and password that will be used to connect to the MySQL database. Note that for MySQL the username and password should correspond to a MySQL database user that has been granted the following MySQL permissions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>SELECT</code></p>
</li>
<li>
<p><code>RELOAD</code></p>
</li>
<li>
<p><code>SHOW DATABASES</code></p>
</li>
<li>
<p><code>REPLICATION SLAVE</code></p>
</li>
<li>
<p><code>REPLICATION CLIENT</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The first three privileges are required when reading a consistent snapshot of the databases. The last two privileges allow the database to read the server&#8217;s binlog that is normally used for MySQL replication.</p>
</div>
<div class="paragraph">
<p>The configuration also includes a numeric identifier for the <code>server.id</code>. Since MySQL&#8217;s binlog is part of the MySQL replication mechanism, in order to read the binlog the <code>MySqlConnector</code> instance must join the MySQL server group, and that means this server ID must be <a href="https://dev.mysql.com/doc/refman/5.7/en/replication-howto-masterbaseconfig.html">unique within all processes that make up the MySQL server group</a> and is any integer between 1 and 2<sup>32</sup>-1. In our code we set it to a fairly large but somewhat random value we&#8217;ll use only for our application.</p>
</div>
<div class="paragraph">
<p>The configuration also specifies a logical name for the MySQL server. The connector includes this logical name within the topic field of every source record it produces, enabling your application to discern the origin of those records. Our example uses a server name of "products", presumably because the database contains product information. Of course, you can name this anything meaningful to your application.</p>
</div>
<div class="paragraph">
<p>When the <code>MySqlConnector</code> class runs, it reads the MySQL server&#8217;s binlog, which includes all data changes and schema changes made to the databases hosted by the server. Since all changes to data are structured in terms of the owning table&#8217;s schema at the time the change was recorded, the connector needs to track all of the schema changes so that it can properly decode the change events. The connector records the schema information so that, should the connector be restarted and resume reading from the last recorded offset, it knows exactly what the database schemas looked like at that offset. How the connector records the database schema history is defined in the last two fields of our configuration, namely that our connector should use the <code>FileDatabaseHistory</code> class to store database schema history changes in the <code>/path/to/storage/dbhistory.dat</code> file on the local file system (again, this file can be named anything and stored anywhere).</p>
</div>
<div class="paragraph">
<p>Finally the immutable configuration is built using the <code>build()</code> method. (Incidentally, rather than build it programmatically, we could have <strong>read</strong> the configuration from a properties file using one of the <code>Configuration.read(&#8230;&#8203;)</code> methods.)</p>
</div>
<div class="paragraph">
<p>Now that we have a configuration, we can create our engine. Here again are the relevant lines of code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// Create the engine with this configuration ...
EmbeddedEngine engine = EmbeddedEngine.create()
        .using(config)
        .notifying(this::handleEvent)
        .build();</code></pre>
</div>
</div>
<div class="paragraph">
<p>A fluent-style builder API is used to create an engine that uses our <code>Configuration</code> object and that sends all data change records to the <code>handleEvent(SourceRecord)</code> method, which can be any method that matches the signature of the <code>java.util.function.Consumer&lt;SourceRecord&gt;</code> functional interface, where <code>SourceRecord</code> is the <code>org.apache.kafka.connect.source.SourceRecord</code> class. Note that your application&#8217;s handler function should not throw any exceptions; if it does, the engine will log any exception thrown by the method and will continue to operate on the next source record, but your application will not have another chance to handle the particular source record that caused the exception, meaning your application might become inconsistent with the database.</p>
</div>
<div class="paragraph">
<p>At this point, we have an existing <code>EmbeddedEngine</code> object that is configured and ready to run, but it doesn&#8217;t do anything. The <code>EmbeddedEngine</code> is designed to be executed asynchronously by an <code>Executor</code> or <code>ExecutorService</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// Run the engine asynchronously ...
Executor executor = Executors.newSingleThreadExecutor();
executor.execute(engine);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Your application can stop the engine safely and gracefully by calling its <code>stop()</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// At some later time ...
engine.stop();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The engine&#8217;s connector will stop reading information from the source system, forward all remaining <code>SourceRecord</code> objects to your handler function, and flush the latest offets to offset storage. Only after all of this completes will the engine&#8217;s <code>run()</code> method return. If your application needs to wait for the engine to completely stop before exiting, you can do this with the engine&#8217;s <code>await(&#8230;&#8203;)</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">try {
    while (!engine.await(30, TimeUnit.SECONDS)) {
        logger.info("Wating another 30 seconds for the embedded engine to shut down");
    }
}
catch ( InterruptedException e ) {
    Thread.currentThread().interrupt();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Recall that when the JVM shuts down, it only waits for daemon threads. Therefore, if your application exits, be sure to wait for completion of the engine or alternatively run the engine on a daemon thread.</p>
</div>
<div class="paragraph">
<p>Your application should always properly stop the engine to ensure graceful and complete shutdown and that each source record is sent to the application exactly one time. For example, do not rely upon shutting down the <code>ExecutorService</code>, since that interrupts the running threads. Although the <code>EmbeddedEngine</code> will indeed terminate when its thread is interrupted, the engine may not terminate cleanly, and when your application is restarted it may see some of the same source records that it had processed just prior to the shutdown.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="advanced-consuming"><a class="anchor" href="#advanced-consuming"></a>Advanced Record Consuming</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For some use cases, such as when trying to write records in batches or against an async API, the functional interface described above may be challenging. In these situations, it may be easier to use the <code>io.debezium.embedded.EmbeddedEngine.ChangeConsumer</code> interface.</p>
</div>
<div class="paragraph">
<p>This interface has single function with the following signature:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java"> /**
   * Handles a batch of records, calling the {@link RecordCommitter#markProcessed(SourceRecord)}
   * for each record and {@link RecordCommitter#markBatchFinished()} when this batch is finished.
   * @param records the records to be processed
   * @param committer the committer that indicates to the system that we are finished
   */
  void handleBatch(List&lt;SourceRecord&gt; records, RecordCommitter committer) throws InterruptedException;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As mentioned in the Javadoc, the <code>RecordCommitter</code> object is to be called for each record and once each batch is finished.
The <code>RecordCommitter</code> interface is threadsafe, which allows for flexible processing of records.</p>
</div>
<div class="paragraph">
<p>To use the <code>ChangeConsumer</code> API, you must pass an implementation of the interface to the <code>notifying</code> API, as seen below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class MyChangeConsumer implements EmbeddedEngine.ChangeConsumer {
  public void handleBatch(List&lt;SourceRecord&gt; records, RecordCommitter committer) throws InterruptedException {
    ...
  }
}
// Create the engine with this configuration ...
EmbeddedEngine engine = EmbeddedEngine.create()
        .using(config)
        .notifying(new MyChangeConsumer())
        .build();</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="engine-properties"><a class="anchor" href="#engine-properties"></a>Engine properties</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following configuration properties are <em>required</em> unless a default value is available (for the sake of text formatting the package names of Java classes are replaced with <code>&lt;&#8230;&#8203;&gt;</code>).</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 35%;">
<col style="width: 10%;">
<col style="width: 55%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>name</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Unique name for the connector instance.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>connector.class</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The name of the Java class for the connector, e.g  <code>&lt;&#8230;&#8203;&gt;.MySqlConnector</code> for the MySQL connector.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>offset.storage</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>&lt;&#8230;&#8203;&gt;.FileOffsetBackingStore</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The name of the Java class that is responsible for persistence of connector offsets.
It must implement <code>&lt;&#8230;&#8203;&gt;.OffsetBackingStore</code> interface.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>offset.storage.file.filename</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>""</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Path to file where offsets are to be stored.
Required when <code>offset.storage</code> is set to the <code>&lt;&#8230;&#8203;&gt;.FileOffsetBackingStore</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>offset.storage.topic</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>""</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The name of the Kafka topic where offsets are to be stored.
Required when <code>offset.storage</code> is set to the <code>&lt;&#8230;&#8203;&gt;.KafkaOffsetBackingStore</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>offset.storage.partitions</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>""</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The number of partitions used when creating the offset storage topic.
Required when <code>offset.storage</code> is set to the <code>&lt;&#8230;&#8203;&gt;.KafkaOffsetBackingStore</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>offset.storage.replication.factor</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>""</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Replication factor used when creating the offset storage topic.
Required when <code>offset.storage</code> is set to the <code>&lt;&#8230;&#8203;&gt;.KafkaOffsetBackingStore</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>offset.commit.policy</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>&lt;&#8230;&#8203;&gt;.PeriodicCommitOffsetPolicy</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The name of the Java class of the commit policy.
It defines when offsets commit has to be triggered based on the number of events processed and the time elapsed since the last commit. This class must implement the interface <code>&lt;&#8230;&#8203;&gt;.OffsetCommitPolicy</code>.
The default is a periodic commity policy based upon time intervals.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>offset.flush.interval.ms</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>60000</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Interval at which to try committing offsets. The default is 1 minute.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>offset.flush.timeout.ms</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>5000</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Maximum number of milliseconds to wait for records to flush and partition offset data to be committed to offset storage before cancelling the process and restoring the offset data to be committed in a future attempt. The default is 5 seconds.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>internal.key.converter</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>&lt;&#8230;&#8203;&gt;.JsonConverter</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The Converter class that should be used to serialize and deserialize key data for offsets. The default is JSON converter.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>internal.value.converter</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>&lt;&#8230;&#8203;&gt;.JsonConverter</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The Converter class that should be used to serialize and deserialize value data for offsets. The default is JSON converter.</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="_handling_failures"><a class="anchor" href="#_handling_failures"></a>Handling failures</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When the engine executes, its connector is actively recording the source offset inside each source record, and the engine is periodically flushing those offsets to persistent storage. When the application and engine shutdown normally or crash, when they are restarted the engine and its connector will resume reading the source information <strong>from the last recorded offset</strong>.</p>
</div>
<div class="paragraph">
<p>So, what happens when your application fails while an embedded engine is running? The net effect is that the application will likely receive some source records after restart that it had already processed right before the crash. How many depends upon how frequently the engine flushes offsets to its store (via the <code>offset.flush.interval.ms</code> property) and how many source records the specific connector returns in one batch. The best case is that the offsets are flushed every time (e.g., <code>offset.flush.interval.ms</code> is set to 0), but even then the embedded engine will still only flush the offsets after each batch of source records is received from the connector.</p>
</div>
<div class="paragraph">
<p>For example, the MySQL connector uses the <code>max.batch.size</code> to specify the maximum number of source records that can appear in a batch. Even with <code>offset.flush.interval.ms</code> is set to 0, when an application restarts after a crash it may see up to <strong>n</strong> duplicates, where <strong>n</strong> is the size of the batches. If the <code>offset.flush.interval.ms</code> property is set higher, then the application may see up to <code>n * m</code> duplicates, where <strong>n</strong> is the maximum size of the batches and <strong>m</strong> is the number of batches that might accumulate during a single offset flush interval. (Obviously it is possible to configure embedded connectors to use no batching and to always flush offsets, resulting in an application never receiving any duplicate source records. However, this dramatically increases the overhead and decreases the throughput of the connectors.)</p>
</div>
<div class="paragraph">
<p>The bottom line is that when using embedded connectors, applications will receive each source record exactly once during normal operation (including restart after a graceful shutdown), but do need to be tolerant of receiving duplicate events immediately following a restart after a crash or improper shutdown. If applications need more rigorous exactly-once behavior, then they should use the full Debezium platform that can provide exactly-once guarantees (even after crashes and restarts).</p>
</div>
</div>
</div>
</article>
</div>
<div class="article-cell2">
</div>
</div>

<div id="toc-rightbar"></div>    <footer class="footer">
        <div class="wrapper">
            <div class="copyright">Copyright &copy; 2021 Debezium Community</div>
        </div>
    </footer>
</main>
</div>
<script>
    /* Make sure TOC carets are expanded if sub-elements exist */
    $("#toc").each(function(i,v) {
      $(this).closest('article').addClass('with-toc');
    });

    $("#toc ul.sectlevel1 > li").each(function(i,v) {
      $(this).has("ul").addClass("expanded");
    });

    $(function() {
        /* Expands all the documentation submenus */
        $(".nav-list > .nav-item:not(.is-active) .nav-item-toggle").click();
    });

    /**
     * This checks if a "#toc" element exists in the DOM and if so:
     *
     *  1. Appends a cloned copy of the #toc node to the #toc-rightbar div.
     *  2. Forces the #toc-rightbar div to be visible.
     *  3. Adds the .toc-right class to the #article-wrapper div to restrict the article's overall width.
     */
    var $toc = $("#toc");
    if ( $toc.length ) {
        $("#toc-rightbar").append($toc.clone());
        $("body .main").addClass("with-toc");
    }

    /**
     * In order to make CSS changes that are backward compatible with old adoc files, this applies a version
     * style to the body tag so we can use it to differentiate between CSS styles per version if needed,
     * such as tfoot rows.
     */
    var $version = $("body .nav-container").data("version");
    var $versionClass = "version-" + $version;
    $versionClass = $versionClass.replace('.','-');
    $("body").addClass($versionClass);

    /** A CSS trick to wrap long-width tables in a div that can be scrolled on smaller screens */
    $("table.tableblock").wrap("<div class='table-scroll-wrapper'></div>");

    $(function() {
        /* apply floating scrollbar to the scroll-wrapper */
        $(".table-scroll-wrapper").floatingScrollbar();
    });

</script>
<script src="../../../debezium-antora/js/site.js"></script>
<script async src="../../../debezium-antora/js/vendor/highlight.js"></script>

<script type="text/javascript">
  var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
  document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
  try {
    var pageTracker = _gat._getTracker("UA-10656779-1");
    pageTracker._trackPageview();
  } catch(err) {}
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-76464546-1', 'auto');
  ga('send', 'pageview');
  ga('set', 'anonymizeIp', true);
  ga('require', 'linkid', 'linkid.js');
</script>
</body>
</html>