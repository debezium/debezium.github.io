<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MongoDB New Document State Extraction :: Debezium Documentation</title>
    <link rel="canonical" href="https://debezium.io/documentation/reference/stable/transformations/mongodb-event-flattening.html">
    <meta name="generator" content="Antora 3.1.7">
<link rel="stylesheet" href="../../../debezium-antora/css/site.css">
<link rel="stylesheet" href="../../../debezium-antora/css/debezium-antora.css">
<link rel="stylesheet" href="../../../debezium-antora/css/highlightjs-dark.css">
<link rel="stylesheet" href="https://static.jboss.org/css/rhbar.css">
<script src="//static.jboss.org/theme/js/libs/jquery/jquery-1.9.1.js"></script>
<script src="../../../debezium-antora/js/jquery.ba-floatingscrollbar.js"></script>
</head>
<body class="article">
<header class="header">
  <div id="rhbar">
      <a class="jbdevlogo" href="https://developers.redhat.com"></a>
      <a class="rhlogo" href="https://www.redhat.com"></a>
  </div>
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="/">
          <img src="/assets/images/color_white_debezium_type_600px.svg" style="height: 32px; margin-right: 14px;"/>
      </a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="/documentation/faq">FAQ</a>
        <a class="navbar-item" href="/documentation">DOCUMENTATION</a>
        <a class="navbar-item" href="/releases">RELEASES</a>
        <a class="navbar-item" href="/community">COMMUNITY</a>
        <a class="navbar-item" href="/blog">BLOG</a>
      </div>
    </div>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="reference" data-version="2.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Debezium 2.0 Documentation</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Getting Started</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../tutorial.html">Tutorial</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../install.html">Installation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../postgres-plugins.html">PostgreSQL Decoding Plugins</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../architecture.html">Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../features.html">Features</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Configuration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../configuration/avro.html">Avro Serialization</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../configuration/topic-auto-create-config.html">Customizing Topic Auto-Creation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../configuration/signalling.html">Sending Signals to Debezium</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Connectors</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/index.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/mysql.html">MySQL</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/mongodb.html">MongoDB</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/postgresql.html">PostgreSQL</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/oracle.html">Oracle</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/sqlserver.html">SQL Server</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/db2.html">Db2</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/cassandra.html">Cassandra</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/vitess.html">Vitess</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Transformations</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="topic-routing.html">Topic Routing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="event-flattening.html">New Record State Extraction</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="mongodb-event-flattening.html">MongoDB New Document State Extraction</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="outbox-event-router.html">Outbox Event Router</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="mongodb-outbox-event-router.html">MongoDB Outbox Event Router</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="filtering.html">Message Filtering</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="content-based-routing.html">Content-Based Routing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="applying-transformations-selectively.html">Using SMT Predicates to Selectively Apply Transformations</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">API and SPI</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../development/engine.html">Debezium Engine</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../development/converters.html">Custom Converters</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Integrations</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../integrations/serdes.html">Change Event SerDes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../integrations/outbox.html">Outbox Quarkus Extension</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../integrations/cloudevents.html">CloudEvents</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../integrations/tracing.html">OpenTracing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../integrations/testcontainers.html">Integration Testing with Testcontainers</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Operations</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../operations/debezium-server.html">Debezium Server</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../operations/logging.html">Logging</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../operations/monitoring.html">Monitoring</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../operations/kubernetes.html">Running on Kubernetes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../operations/openshift.html">Running on Openshift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../operations/embedded.html">Embedding Debezium</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../operations/debezium-ui.html">Debezium UI</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Debezium Documentation</span>
    <span class="version">2.0</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Debezium Documentation</span>
      <ul class="versions">
        <li class="version">
          <a href="/documentation/reference/nightly/index.html">nightly</a>
        </li>
        <li class="version">
          <a href="/documentation/reference/2.7/index.html">2.7</a>
        </li>
        <li class="version">
          <a href="/documentation/reference/3.0/index.html">3.0</a>
        </li>
        <li class="version">
          <a href="/documentation/reference/2.6/index.html">2.6</a>
        </li>
        <li class="version">
          <a href="/documentation/reference/2.5/index.html">2.5</a>
        </li>
        <li class="version">
          <a href="/documentation/reference/2.4/index.html">2.4</a>
        </li>
        <li class="version">
          <a href="/documentation/reference/2.3/index.html">2.3</a>
        </li>
        <li class="version">
          <a href="/documentation/reference/2.2/index.html">2.2</a>
        </li>
        <li class="version">
          <a href="/documentation/reference/2.1/index.html">2.1</a>
        </li>
        <li class="version is-current">
          <a href="/documentation/reference/2.0/index.html">2.0</a>
        </li>
        <li class="version">
          <a href="/documentation/reference/1.9/index.html">1.9</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main role="main" class="main">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../stable/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Debezium Documentation</a></li>
    <li>Transformations</li>
    <li><a href="mongodb-event-flattening.html">MongoDB New Document State Extraction</a></li>
  </ul>
</nav>
    <div class="page-versions-container">
    Version:
    <div class="page-versions">
        <button class="version-menu-toggle versions-menu-current" title="Show other versions of page">2.0</button>
        <div class="version-menu">
                <a class="version" href="/documentation/reference/nightly/index.html">nightly</a>
                <a class="version" href="/documentation/reference/2.7/index.html">2.7</a>
                <a class="version" href="/documentation/reference/3.0/index.html">3.0</a>
                <a class="version" href="/documentation/reference/2.6/index.html">2.6</a>
                <a class="version" href="/documentation/reference/2.5/index.html">2.5</a>
                <a class="version" href="/documentation/reference/2.4/index.html">2.4</a>
                <a class="version" href="/documentation/reference/2.3/index.html">2.3</a>
                <a class="version" href="/documentation/reference/2.2/index.html">2.2</a>
                <a class="version" href="/documentation/reference/2.1/index.html">2.1</a>
                <a class="version is-current" href="/documentation/reference/2.0/index.html">2.0</a>
                <a class="version" href="/documentation/reference/1.9/index.html">1.9</a>
        </div>
        |
    </div>
    </div>
  <div class="edit-this-page"><a href="https://github.com/debezium/debezium/edit/2.0/documentation/modules/ROOT/pages/transformations/mongodb-event-flattening.adoc">Edit this Page</a></div>
  </div>
<div class="article-grid">
<div class="article-cell1">
<article class="doc">
        
    <div class="version-banner version-banner-outdated">
    You are viewing documentation for an outdated version of Debezium.
    <br/>
            If you want to view the latest stable version of this page, please go <a href=/documentation/reference/stable/index.html>here</a>.
            
</div>            <h1 class="page">MongoDB New Document State Extraction</h1>
        <div id="preamble">
<div class="sectionbody">
<div id="toc" class="toc">
<div id="toctitle" class="title">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_configuration">Configuration</a>
<ul class="sectlevel2">
<li><a href="#_array_encoding">Array encoding</a></li>
<li><a href="#_nested_structure_flattening">Nested structure flattening</a></li>
<li><a href="#_mongodb_unset_handling">MongoDB <code>$unset</code> handling</a></li>
<li><a href="#_determine_original_operation">Determine original operation</a></li>
<li><a href="#_adding_source_metadata_fields">Adding source metadata fields</a></li>
</ul>
</li>
<li><a href="#options-for-applying-the-transformation-selectively">Options for applying the transformation selectively</a></li>
<li><a href="#mongodb-extract-new-record-state-configuration-options">Configuration options</a></li>
<li><a href="#_known_limitations">Known limitations</a></li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This single message transformation (SMT) is under active development right now, so the emitted message structure or other details may still change as development progresses.
Please see below for a descriptions of known limitations of this transformation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This SMT is supported only for the MongoDB connector.
See <a href="event-flattening.html" class="xref page">Extracting source record <code>after</code> state from Debezium change events</a> for the relational database equivalent to this SMT.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The Debezium MongoDB connector generates the data in a form of a complex message structure.
The message consists of two parts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>operation and metadata</p>
</li>
<li>
<p>for inserts, the whole data after the insert has been executed; for updates a patch element describing the altered fields</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>after</code> and <code>patch</code> elements are Strings containing JSON representations of the inserted/altered data.
E.g. the general message structure for a insert event looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "op": "r",
  "after": "{\"field1\":\"newvalue1\",\"field2\":\"newvalue1\"}",
  "source": { ... }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>More details about the message structure are provided in <a href="../connectors/mongodb.html" class="xref page">the documentation</a> of the MongoDB connector.</p>
</div>
<div class="paragraph">
<p>While this structure is a good fit to represent changes to MongoDB&#8217;s schemaless collections,
it is not understood by existing sink connectors such as the Confluent JDBC sink connector.</p>
</div>
<div class="paragraph">
<p>Therefore Debezium provides a <a href="https://kafka.apache.org/documentation/#connect_transforms">a single message transformation</a> (SMT)
which converts the <code>after</code>/<code>patch</code> information from the MongoDB CDC events into a structure suitable for consumption by existing sink connectors.
To do so, the SMT parses the JSON strings and reconstructs properly typed Kafka Connect
(comprising the correct message payload and schema) records from that,
which then can be consumed by connectors such as the JDBC sink connector.</p>
</div>
<div class="paragraph">
<p>Using JSON as visualization of the emitted record structure, the event from above would like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
	"field1" : "newvalue1",
	"field2" : "newvalue2"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The SMT should be applied on a sink connector.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration"><a class="anchor" href="#_configuration"></a>Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The configuration is a part of sink task connector and is expressed in a set of properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">transforms=unwrap,...
transforms.unwrap.type=io.debezium.connector.mongodb.transforms.ExtractNewDocumentState
transforms.unwrap.drop.tombstones=false
transforms.unwrap.delete.handling.mode=drop
transforms.unwrap.add.headers=op</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Customizing the configuration</div>
<p>The connector might emit many types of event messages (for example, heartbeat messages, tombstone messages, or metadata messages about transactions).
To apply the transformation to a subset of events, you can define <a href="#options-for-applying-the-transformation-selectively">an SMT predicate statement that selectively applies the transformation</a> to specific events only.</p>
</div>
<div class="sect2">
<h3 id="_array_encoding"><a class="anchor" href="#_array_encoding"></a>Array encoding</h3>
<div class="paragraph">
<p>The SMT converts MongoDB arrays into arrays as defined by Apache Connect (or Apache Avro) schema.
The problem is that such arrays must contains elements of the same type.
MongoDB allows the user to store elements of heterogeneous types into the same array.
To bypass this impedance mismatch it is possible to encode the array in two different ways using <code>array.encoding</code> configuration option.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">transforms=unwrap,...
transforms.unwrap.type=io.debezium.connector.mongodb.transforms.ExtractNewDocumentState
transforms.unwrap.array.encoding=&lt;array|document&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Value <code>array</code> (the default) will encode arrays as the array datatype.
It is user&#8217;s responsibility to ensure that all elements for a given array instance are of the same type.
This option is a restricting one but offers easy processing of arrays by downstream clients.</p>
</div>
<div class="paragraph">
<p>Value <code>document</code> will convert the array into a <strong>struct</strong> of <strong>structs</strong> in the similar way as done by <a href="http://bsonspec.org/">BSON serialization</a>.
The main <strong>struct</strong> contains fields named <code>_0</code>, <code>_1</code>, <code>_2</code> etc. where the name represents the index of the element in the array.
Every element is then passed as the value for the given field.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s suppose an example source MongoDB document with array with heterogeneous types</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "_id": 1,
    "a1": [
        {
            "a": 1,
            "b": "none"
        },
        {
            "a": "c",
            "d": "something"
        }
    ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This document will be encoded as</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "_id": 1,
    "a1": {
        "_0": {
            "a": 1,
            "b": "none"
        },
        "_1": {
            "a": "c",
            "d": "something"
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This option allows you to process arbitrary arrays but the consumer need to know how to properly handle them.</p>
</div>
<div class="paragraph">
<p><em>Note: The underscore in index names is present because Avro encoding requires field names not to start with digit.</em></p>
</div>
</div>
<div class="sect2">
<h3 id="_nested_structure_flattening"><a class="anchor" href="#_nested_structure_flattening"></a>Nested structure flattening</h3>
<div class="paragraph">
<p>When a MongoDB document contains a nested document (structure) it is faithfully encoded as a nested structure field.
If the sink connector does support only flat structure it is possible to flatten the internal structure into a flat one with a consistent field naming.
To enable this feature the option <code>flatten.struct</code> must be set to <code>true</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">transforms=unwrap,...
transforms.unwrap.type=io.debezium.connector.mongodb.transforms.ExtractNewDocumentState
transforms.unwrap.flatten.struct=&lt;true|false&gt;
transforms.unwrap.flatten.struct.delimiter=&lt;string&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The resulting flat document will consist of fields whose names are created by joining the name of the parent field and the name of the fields in the nested document.
Those elements are separated with string defined by an option <code>struct.delimiter</code> by default set to the <em>underscore</em>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s suppose an example source MongoDB document with a field with a nested document</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "_id": 1,
    "a": {
            "b": 1,
            "c": "none"
    },
    "d": 100
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Such document will be encoded as</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "_id": 1,
    "a_b": 1,
    "a_c": "none",
    "d": 100
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This option allows you to convert a hierarchical document into a flat structure suitable for a table-like storage.</p>
</div>
</div>
<div class="sect2">
<h3 id="_mongodb_unset_handling"><a class="anchor" href="#_mongodb_unset_handling"></a>MongoDB <code>$unset</code> handling</h3>
<div class="paragraph">
<p>MongoDB allows <code>$unset</code> operations that remove a certain field from a document. Because the collections are schemaless, it becomes hard to inform consumers/sinkers about the field that is now missing. The approach that Debezium uses is to set the field being removed to a null value.</p>
</div>
<div class="paragraph">
<p>Given the operation</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "after":null,
    "patch":"{\"$unset\" : {\"a\" : true}}"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The final encoding will look like</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "id": 1,
    "a": null
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that other MongoDB operations might cause an <code>$unset</code> internally, <code>$rename</code> is one example.</p>
</div>
</div>
<div class="sect2">
<h3 id="_determine_original_operation"><a class="anchor" href="#_determine_original_operation"></a>Determine original operation</h3>
<div class="paragraph">
<p>When a message is flattened the final result does not show whether it was an insert, update or first read. (Deletions can be detected via tombstones or rewrites, see <a href="#mongodb-extract-new-record-state-configuration-options">Configuration options</a>.)</p>
</div>
<div class="paragraph">
<p>To solve this problem, you can propagate the original operation either as a field added to message value or as a header property,
e.g. like so to use a header property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">transforms=unwrap,...
transforms.unwrap.type=io.debezium.connector.mongodb.transforms.ExtractNewDocumentState
transforms.unwrap.add.headers=op</code></pre>
</div>
</div>
<div class="paragraph">
<p>The possible values are the ones from the <code>op</code> field of <a href="../connectors/mongodb.html#mongodb-change-events-value" class="xref page">MongoDB connector change events</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_adding_source_metadata_fields"><a class="anchor" href="#_adding_source_metadata_fields"></a>Adding source metadata fields</h3>
<div class="paragraph">
<p>The SMT can optionally add metadata fields from the original change event&#8217;s <code>source</code> structure to the final flattened record (prefixed with "__").
This ability to add metadata to the event record makes it possible to include content such as the name of the collection associated with the change event, or such connector-specific fields as the replica set name.
For more information about the MongoDB source structure, see <a href="../connectors/mongodb.html" class="xref page">the documentation</a> for the MongoDB connector.</p>
</div>
<div class="paragraph">
<p>For example, you might specify the following configuration to add a replica set name (<code>rs</code>) and the collection name for a change event to the final flattened event record:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>transforms=unwrap,...
transforms.unwrap.type=io.debezium.connector.mongodb.transforms.ExtractNewDocumentState
transforms.unwrap.add.fields=rs,collection</pre>
</div>
</div>
<div class="paragraph">
<p>The preceding configuration results in the following content being added to the flattened record:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{ "__rs" : "rs0", "__collection" : "my-collection", ... }</pre>
</div>
</div>
<div class="paragraph">
<p>For <code>DELETE</code> events, the option to add metadata fields is supported only if the <code>delete.handling.mode</code> option is set to <code>rewrite</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="options-for-applying-the-transformation-selectively"><a class="anchor" href="#options-for-applying-the-transformation-selectively"></a>Options for applying the transformation selectively</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In addition to the change event messages that a Debezium connector emits when a database change occurs, the connector also emits other types of messages, including heartbeat messages, and metadata messages about schema changes and transactions.
Because the structure of these other messages differs from the structure of the change event messages that the SMT is designed to process, it&#8217;s best to configure the connector to selectively apply the SMT, so that it processes only the intended data change messages.</p>
</div>
<div class="paragraph">
<p>For more information about how to apply the SMT selectively, see <a href="applying-transformations-selectively.html#applying-transformations-selectively" class="xref page">Configure an SMT predicate for the transformation</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mongodb-extract-new-record-state-configuration-options"><a class="anchor" href="#mongodb-extract-new-record-state-configuration-options"></a>Configuration options</h2>
<div class="sectionbody">
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 30%;">
<col style="width: 25%;">
<col style="width: 45%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-extract-new-record-state-array-encoding"></a><a href="#mongodb-extract-new-record-state-array-encoding"><code>array.encoding</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>array</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The SMT converts MongoDB arrays into arrays as defined by Apache Connect (or Apache Avro) schema.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-extract-new-record-state-flatten-struct"></a><a href="#mongodb-extract-new-record-state-flatten-struct"><code>flatten.struct</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>false</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The SMT flattens structs by concatenating the fields into plain properties, using a configurable delimiter.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-extract-new-record-state-flatten-struct-delimiter"></a><a href="#mongodb-extract-new-record-state-flatten-struct-delimiter"><code>flatten.struct.delimiter</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>_</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Delimiter to concat between field names from the input record when generating field names for the output record. Only applies when <code>flatten.struct</code> is set to <code>true</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-extract-new-record-state-drop-tombstones"></a><a href="#mongodb-extract-new-record-state-drop-tombstones"><code>drop.tombstones</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>true</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The SMT removes the tombstone generated by Debezium from the stream.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-extract-new-record-state-delete-handling-mode"></a><a href="#mongodb-extract-new-record-state-delete-handling-mode"><code>delete.handling.mode</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>drop</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The SMT can <code>drop</code>, <code>rewrite</code> or pass delete records (<code>none</code>). The <code>rewrite</code> mode will add a <code>__deleted</code> field set to <code>true</code> or <code>false</code> depending on the represented operation.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-extract-new-record-state-add-headers-prefix"></a><a href="#mongodb-extract-new-record-state-add-headers-prefix"><code>add.headers.prefix</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>__ (double-underscore)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Set this optional string to prefix a header.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-extract-new-record-state-add-headers"></a><a href="#mongodb-extract-new-record-state-add-headers"><code>add.headers</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Specify a list of metadata fields to add to header of the flattened message.
In case of duplicate field names (e.g. "ts_ms" exists twice), the struct should be specified to get the correct field (e.g. "source.ts_ms").
The fields will be prefixed with <code>__</code> or <code>__&lt;struct&gt;__</code>, depending on the specification of the struct.
Please use a comma separated list without spaces.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-extract-new-record-state-add-fields-prefix"></a><a href="#mongodb-extract-new-record-state-add-fields-prefix"><code>add.fields.prefix</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>__ (double-underscore)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Set this optional string to prefix a field.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-extract-new-record-state-add-fields"></a><a href="#mongodb-extract-new-record-state-add-fields"><code>add.fields</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Specify a list of metadata fields to add to the flattened message.
In case of duplicate field names (e.g. "ts_ms" exists twice), the struct should be specified to get the correct field (e.g. "source.ts_ms").
The fields will be prefixed with <code>__</code> or <code>__&lt;struct&gt;__</code>, depending on the specification of the struct.
Please use a comma separated list without spaces.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-extract-new-record-state-sanitize-field-names"></a><a href="#mongodb-extract-new-record-state-sanitize-field-names"><code>sanitize.field.names</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>false</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Whether field names will be sanitized to adhere to Avro naming requirements.
See <a href="../configuration/avro.html#avro-naming" class="xref page">Avro naming</a> for more details.</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="_known_limitations"><a class="anchor" href="#_known_limitations"></a>Known limitations</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Feeding data changes from a schemaless store such as MongoDB to strictly schema-based datastores such as a relational database can by definition work within certain limits only.
Specifically, all fields of documents within one collection with the same name must be of the same type. Otherwise, no consistent column definition can be derived in the target database.</p>
</li>
<li>
<p>Arrays will be restored in the emitted Kafka Connect record correctly, but they are not supported by sink connector just expecting a "flat" message structure.</p>
</li>
</ul>
</div>
</div>
</div>
</article>
</div>
<div class="article-cell2">
</div>
</div>

<div id="toc-rightbar"></div>    <footer class="footer">
        <div class="wrapper">
            <div class="copyright">Copyright &copy; 2024 Debezium Community (Rev: <span class="truncated"><a href="https://github.com/debezium/debezium/commit/04ce19bc9f644ebfc9dc75950444cec71fd4f76e">04ce19bc</a></span>)
            
        </div>
    </footer>
</main></div>
<script>
    /* Make sure TOC carets are expanded if sub-elements exist */
    $("#toc").each(function(i,v) {
      $(this).closest('article').addClass('with-toc');
    });

    $("#toc ul.sectlevel1 > li").each(function(i,v) {
      $(this).has("ul").addClass("expanded");
    });

    $(function() {
        /* Expands all the documentation submenus */
        $(".nav-list > .nav-item:not(.is-active) .nav-item-toggle").click();
    });

    /**
     * This checks if a "#toc" element exists in the DOM and if so:
     *
     *  1. Appends a cloned copy of the #toc node to the #toc-rightbar div.
     *  2. Forces the #toc-rightbar div to be visible.
     *  3. Adds the .toc-right class to the #article-wrapper div to restrict the article's overall width.
     */
    var $toc = $("#toc");
    if ( $toc.length ) {
        $("#toc-rightbar").append($toc.clone());
        $("body .main").addClass("with-toc");
    }

    /**
     * In order to make CSS changes that are backward compatible with old adoc files, this applies a version
     * style to the body tag so we can use it to differentiate between CSS styles per version if needed,
     * such as tfoot rows.
     */
    var $version = $("body .nav-container").data("version");
    var $versionClass = "version-" + $version;
    $versionClass = $versionClass.replace('.','-');
    $("body").addClass($versionClass);

    /** A CSS trick to wrap long-width tables in a div that can be scrolled on smaller screens */
    $("table.tableblock").wrap("<div class='table-scroll-wrapper'></div>");

    $(function() {
        /* apply floating scrollbar to the scroll-wrapper */
        $(".table-scroll-wrapper").floatingScrollbar();
    });

</script>
<script src="../../../debezium-antora/js/site.js"></script>
<script async src="../../../debezium-antora/js/vendor/highlight.js"></script>

<script type="text/javascript">
  var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
  document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
  try {
    var pageTracker = _gat._getTracker("UA-10656779-1");
    pageTracker._trackPageview();
  } catch(err) {}
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-76464546-1', 'auto');
  ga('send', 'pageview');
  ga('set', 'anonymizeIp', true);
  ga('require', 'linkid', 'linkid.js');
</script>
</body>
</html>