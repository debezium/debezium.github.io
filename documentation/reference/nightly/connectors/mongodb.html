<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Debezium connector for MongoDB :: Debezium Documentation</title>
    <link rel="canonical" href="https://debezium.io/documentation/reference/stable/connectors/mongodb.html">
    <meta name="generator" content="Antora 3.1.7">
<link rel="stylesheet" href="../../debezium-antora/css/site.css">
<link rel="stylesheet" href="../../debezium-antora/css/debezium-antora.css">
<link rel="stylesheet" href="../../debezium-antora/css/highlightjs-dark.css">
<link rel="stylesheet" href="https://static.jboss.org/css/rhbar.css">
<script src="//static.jboss.org/theme/js/libs/jquery/jquery-1.9.1.js"></script>
<script src="../../debezium-antora/js/jquery.ba-floatingscrollbar.js"></script>
</head>
<body class="article">
<header class="header">
  <div id="rhbar">
      <a class="jbdevlogo" href="https://developers.redhat.com"></a>
      <a class="rhlogo" href="https://www.redhat.com"></a>
  </div>
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="/">
          <img src="/assets/images/color_white_debezium_type_600px.svg" style="height: 32px; margin-right: 14px;"/>
      </a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="/documentation/faq">FAQ</a>
        <a class="navbar-item" href="/documentation">DOCUMENTATION</a>
        <a class="navbar-item" href="/releases">RELEASES</a>
        <a class="navbar-item" href="/community">COMMUNITY</a>
        <a class="navbar-item" href="/blog">BLOG</a>
      </div>
    </div>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="reference" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Debezium nightly Documentation</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Getting Started</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../tutorial.html">Tutorial</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../install.html">Installation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../postgres-plugins.html">PostgreSQL Decoding Plugins</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../architecture.html">Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../features.html">Features</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Configuration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../configuration/avro.html">Avro Serialization</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../configuration/topic-auto-create-config.html">Customizing Topic Auto-Creation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../configuration/signalling.html">Sending Signals to Debezium</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../configuration/notification.html">Receive notifications from Debezium</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Connectors</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="mysql.html">MySQL</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="mariadb.html">MariaDB</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="mongodb.html">MongoDB</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="postgresql.html">PostgreSQL</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="oracle.html">Oracle</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="sqlserver.html">SQL Server</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="db2.html">Db2</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="cassandra.html">Cassandra</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="vitess.html">Vitess</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="spanner.html">Spanner</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="jdbc.html">JDBC</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="informix.html">Informix</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Transformations</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../transformations/index.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../transformations/topic-routing.html">Topic Routing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../transformations/event-flattening.html">New Record State Extraction</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../transformations/mongodb-event-flattening.html">MongoDB New Document State Extraction</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../transformations/event-changes.html">Event Changes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../transformations/outbox-event-router.html">Outbox Event Router</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../transformations/mongodb-outbox-event-router.html">MongoDB Outbox Event Router</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../transformations/filtering.html">Message Filtering</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../transformations/schema-change-event-filter.html">Schema Change Event Filtering</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../transformations/content-based-routing.html">Content-Based Routing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../transformations/applying-transformations-selectively.html">Using SMT Predicates to Selectively Apply Transformations</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../transformations/partition-routing.html">Partition Routing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../transformations/header-to-value.html">HeaderToValue</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../transformations/timezone-converter.html">Timezone Converter</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../transformations/timescaledb.html">TimescaleDB Integration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../transformations/decode-logical-decoding-message-content.html">Decode Logical Decoding Message Content</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../transformations/convert-cloudevent-to-saveable-form.html">Convert CloudEvents to Saveable Form</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Post Processors</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../post-processors/index.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../post-processors/reselect-columns.html">Reselect Columns</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">API and SPI</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../development/engine.html">Debezium Engine</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../development/converters.html">Custom Converters</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Integrations</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../integrations/serdes.html">Change Event SerDes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../integrations/outbox.html">Outbox Quarkus Extension</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../integrations/cloudevents.html">CloudEvents</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../integrations/tracing.html">OpenTelemetry</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../integrations/testcontainers.html">Integration Testing with Testcontainers</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Operations</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../operations/debezium-server.html">Debezium Server</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../operations/logging.html">Logging</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../operations/monitoring.html">Monitoring</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../operations/kubernetes.html">Running on Kubernetes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../operations/openshift.html">Running on Openshift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../operations/debezium-ui.html">Debezium UI</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Debezium Documentation</span>
    <span class="version">nightly</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Debezium Documentation</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="/documentation/reference/nightly/index.html">nightly</a>
        </li>
        <li class="version">
          <a href="/documentation/reference/2.7/index.html">2.7</a>
        </li>
        <li class="version">
          <a href="/documentation/reference/3.0/index.html">3.0</a>
        </li>
        <li class="version">
          <a href="/documentation/reference/2.6/index.html">2.6</a>
        </li>
        <li class="version">
          <a href="/documentation/reference/2.5/index.html">2.5</a>
        </li>
        <li class="version">
          <a href="/documentation/reference/2.4/index.html">2.4</a>
        </li>
        <li class="version">
          <a href="/documentation/reference/2.3/index.html">2.3</a>
        </li>
        <li class="version">
          <a href="/documentation/reference/2.2/index.html">2.2</a>
        </li>
        <li class="version">
          <a href="/documentation/reference/2.1/index.html">2.1</a>
        </li>
        <li class="version">
          <a href="/documentation/reference/2.0/index.html">2.0</a>
        </li>
        <li class="version">
          <a href="/documentation/reference/1.9/index.html">1.9</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main role="main" class="main">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../stable/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Debezium Documentation</a></li>
    <li>Connectors</li>
    <li><a href="mongodb.html">MongoDB</a></li>
  </ul>
</nav>
    <div class="page-versions-container">
    Version:
    <div class="page-versions">
        <button class="version-menu-toggle versions-menu-current" title="Show other versions of page">nightly</button>
        <div class="version-menu">
                <a class="version is-current" href="/documentation/reference/nightly/index.html">nightly</a>
                <a class="version" href="/documentation/reference/2.7/index.html">2.7</a>
                <a class="version" href="/documentation/reference/3.0/index.html">3.0</a>
                <a class="version" href="/documentation/reference/2.6/index.html">2.6</a>
                <a class="version" href="/documentation/reference/2.5/index.html">2.5</a>
                <a class="version" href="/documentation/reference/2.4/index.html">2.4</a>
                <a class="version" href="/documentation/reference/2.3/index.html">2.3</a>
                <a class="version" href="/documentation/reference/2.2/index.html">2.2</a>
                <a class="version" href="/documentation/reference/2.1/index.html">2.1</a>
                <a class="version" href="/documentation/reference/2.0/index.html">2.0</a>
                <a class="version" href="/documentation/reference/1.9/index.html">1.9</a>
        </div>
        |
    </div>
    </div>
  <div class="edit-this-page"><a href="https://github.com/debezium/debezium/edit/main/documentation/modules/ROOT/pages/connectors/mongodb.adoc">Edit this Page</a></div>
  </div>
<div class="article-grid">
<div class="article-cell1">
<article class="doc">
        
    <div class="version-banner version-banner-development">
    You are viewing documentation for an unreleased version of Debezium.
    <br/>
            If you want to view the latest stable version of this page, please go <a href=/documentation/reference/stable/index.html>here</a>.
            
</div>            <h1 class="page">Debezium connector for MongoDB</h1>
        <div id="preamble">
<div class="sectionbody">
<div id="toc" class="toc">
<div id="toctitle" class="title">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#mongodb-overview">Overview</a>
<ul class="sectlevel2">
<li><a href="#change-streams">Change streams</a></li>
<li><a href="#read-preference">Read Preference</a></li>
</ul>
</li>
<li><a href="#how-the-mongodb-connector-works">How the MongoDB connector works</a>
<ul class="sectlevel2">
<li><a href="#supported-mongodb-topologies">Supported MongoDB topologies</a></li>
<li><a href="#required-user-permissions">Required user permissions</a></li>
<li><a href="#mongodb-logical-connector-name">Logical connector name</a></li>
<li><a href="#mongodb-offset-consolidation">Offset consolidation</a></li>
<li><a href="#mongodb-performing-a-snapshot">Performing a snapshot</a></li>
<li><a href="#mongodb-ad-hoc-snapshots">Ad hoc snapshots</a></li>
<li><a href="#debezium-mongodb-incremental-snapshots">Incremental snapshots</a></li>
<li><a href="#connector-custom-snapshot">Custom snapshotter SPI</a></li>
<li><a href="#mongodb-blocking-snapshots">Blocking snapshots</a></li>
<li><a href="#mongodb-streaming-changes">Streaming changes</a></li>
<li><a href="#mongodb-pre-image-support">Pre-image support</a></li>
<li><a href="#mongodb-topic-names">Topic names</a></li>
<li><a href="#mongodb-partitions">Partitions</a></li>
<li><a href="#mongodb-transaction-metadata">Transaction Metadata</a></li>
</ul>
</li>
<li><a href="#mongodb-events">Data change events</a>
<ul class="sectlevel2">
<li><a href="#mongodb-change-events-key">Change event keys</a></li>
<li><a href="#mongodb-change-events-value">Change event values</a></li>
<li><a href="#mongodb-create-events"><em>create</em> events</a></li>
<li><a href="#mongodb-update-events"><em>update</em> events</a></li>
<li><a href="#mongodb-delete-events"><em>delete</em> events</a></li>
<li><a href="#mongodb-tombstone-events">Tombstone events</a></li>
</ul>
</li>
<li><a href="#setting-up-mongodb">Setting up MongoDB</a>
<ul class="sectlevel2">
<li><a href="#mongodb-in-the-cloud">MongoDB in the Cloud</a></li>
<li><a href="#mongodb-optimal-oplog-config">Optimal Oplog Config</a></li>
</ul>
</li>
<li><a href="#mongodb-deploying-a-connector">Deployment</a>
<ul class="sectlevel2">
<li><a href="#mongodb-example-configuration">MongoDB connector configuration example</a></li>
<li><a href="#mongodb-adding-connector-configuration">Adding connector configuration</a></li>
<li><a href="#mongodb-connector-properties">Connector properties</a></li>
</ul>
</li>
<li><a href="#mongodb-monitoring">Monitoring</a>
<ul class="sectlevel2">
<li><a href="#_customized_mbean_names">Customized MBean names</a></li>
<li><a href="#mongodb-snapshot-metrics">Snapshot Metrics</a></li>
<li><a href="#mongodb-streaming-metrics">Streaming Metrics</a></li>
</ul>
</li>
<li><a href="#mongodb-when-things-go-wrong">MongoDB connector common issues</a>
<ul class="sectlevel2">
<li><a href="#debezium-mongodb-connector-configuration-and-startup-errors">Configuration and startup errors</a></li>
<li><a href="#mongodb-becomes-unavailable-while-debezium-is-running">MongoDB becomes unavailable</a></li>
<li><a href="#connector-error-invalid-resume-token">Connector Unable to Start - InvalidResumeToken or ChangeStreamHistoryLost</a></li>
<li><a href="#debezium-mongodb-kafka-connect-process-stops-gracefully">Kafka Connect process stops gracefully</a></li>
<li><a href="#debezium-mongodb-kafka-connect-process-crashes">Kafka Connect process crashes</a></li>
<li><a href="#debezium-mongodb-kafka-process-becomes-unavailable">Kafka becomes unavailable</a></li>
<li><a href="#debezium-mongodb-connector-is-stopped-for-a-long-interval">Connector fails after it is stopped for a long interval if <code>snapshot.mode</code> is set to <code>initial</code></a></li>
<li><a href="#mongodb-crash-results-in-lost-commits">MongoDB loses writes</a></li>
</ul>
</li>
</ul>
</div>
<div class="paragraph">
<p>Debezium&#8217;s MongoDB connector tracks a MongoDB replica set or a MongoDB sharded cluster for document changes in databases and collections, recording those changes as events in Kafka topics.
The connector automatically handles the addition or removal of shards in a sharded cluster, changes in membership of each replica set, elections within each replica set, and awaiting the resolution of communications problems.</p>
</div>
<div class="paragraph">
<p>For information about the MongoDB versions that are compatible with this connector, see the <a href="https://debezium.io/releases/">Debezium release overview</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mongodb-overview"><a class="anchor" href="#mongodb-overview"></a>Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>MongoDB&#8217;s replication mechanism provides redundancy and high availability, and is the preferred way to run MongoDB in production.
MongoDB connector captures the changes in a replica set or sharded cluster.</p>
</div>
<div class="paragraph">
<p>A MongoDB <em>replica set</em> consists of a set of servers that all have copies of the same data, and replication ensures that all changes made by clients to documents on the replica set&#8217;s <em>primary</em> are correctly applied to the other replica set&#8217;s servers, called <em>secondaries</em>.
MongoDB replication works by having the primary record the changes in its <em>oplog</em> (or operation log), and then each of the secondaries reads the primary&#8217;s oplog and applies in order all of the operations to their own documents.
When a new server is added to a replica set, that server first performs an <a href="https://docs.mongodb.com/manual/core/replica-set-sync/">snapshot</a> of all of the databases and collections on the primary, and then reads the primary&#8217;s oplog to apply all changes that might have been made since it began the snapshot.
This new server becomes a secondary (and able to handle queries) when it catches up to the tail of the primary&#8217;s oplog.</p>
</div>
<div class="sect2">
<h3 id="change-streams"><a class="anchor" href="#change-streams"></a>Change streams</h3>
<div class="paragraph">
<p>Although the Debezium MongoDB connector does not become part of a replica set, it uses a similar replication mechanism to obtain oplog data.
The main difference is that the connector does not read the oplog directly.
Instead, it delegates the capture and decoding of oplog data to the MongoDB <a href="https://docs.mongodb.com/manual/changeStreams/">change streams</a> feature.
With change streams, the MongoDB server exposes the changes that occur in a collection as an event stream.
The Debezium connector monitors the stream and then delivers the changes downstream.
The first time that the connector detects a replica set, it examines the oplog to obtain the last recorded transaction, and then performs a snapshot of the primary&#8217;s databases and collections.
After the connector finishes copying the data, it creates a change stream beginning from the oplog position that it read earlier.</p>
</div>
<div class="paragraph">
<p>As the MongoDB connector processes changes, it periodically records the position at which the event originated in the oplog stream.
When the connector stops, it records the last oplog stream position that it processed, so that after a restart it can resume streaming from that position.
In other words, the connector can be stopped, upgraded or maintained, and restarted some time later, and always pick up exactly where it left off without losing a single event.
Of course, MongoDB oplogs are usually capped at a maximum size, so if the connector is stopped for long periods, operations in the oplog might be purged before the connector has a chance to read them.
In this case, after a restart the connector detects the missing oplog operations, performs a snapshot, and then proceeds to stream changes.</p>
</div>
<div class="paragraph">
<p>The MongoDB connector is also quite tolerant of changes in membership and leadership of the replica sets, of additions or removals of shards within a sharded cluster, and network problems that might cause communication failures.
The connector always uses the replica set&#8217;s primary node to stream changes, so when the replica set undergoes an election and a different node becomes primary, the connector will immediately stop streaming changes, connect to the new primary, and start streaming changes using the new primary node.
Similarly, if connector is unable to communicate with the replica set primary, it attempts to reconnect (using exponential backoff so as to not overwhelm the network or replica set).
After connection is reestablished, the connector continues to stream changes from the last event that it captured.
In this way the connector dynamically adjusts to changes in replica set membership, and automatically handles communication disruptions.</p>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.mongodb.com/manual/replication/">Replication mechanism</a></p>
</li>
<li>
<p><a href="https://docs.mongodb.com/manual/tutorial/deploy-replica-set/">Replica set</a></p>
</li>
<li>
<p><a href="https://docs.mongodb.com/manual/core/replica-set-elections/">Replica set elections</a></p>
</li>
<li>
<p><a href="https://docs.mongodb.com/manual/core/sharded-cluster-components/">Sharded cluster</a></p>
</li>
<li>
<p><a href="https://docs.mongodb.com/manual/tutorial/add-shards-to-shard-cluster/">Shard addition</a></p>
</li>
<li>
<p><a href="https://docs.mongodb.com/manual/tutorial/remove-shards-from-cluster/">Shard removal</a></p>
</li>
<li>
<p><a href="https://docs.mongodb.com/manual/changeStreams/">Change Streams</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="read-preference"><a class="anchor" href="#read-preference"></a>Read Preference</h3>
<div class="paragraph">
<p>You specify read preferences for a MongoDB connection by setting the <code>readPreference</code> parameter in the <a href="#mongodb-property-mongodb-connection-string"><code>mongodb.connection.string</code></a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="how-the-mongodb-connector-works"><a class="anchor" href="#how-the-mongodb-connector-works"></a>How the MongoDB connector works</h2>
<div class="sectionbody">
<div class="paragraph">
<p>An overview of the MongoDB topologies that the connector supports is useful for planning your application.</p>
</div>
<div class="sect2">
<h3 id="supported-mongodb-topologies"><a class="anchor" href="#supported-mongodb-topologies"></a>Supported MongoDB topologies</h3>
<div class="paragraph">
<p>The MongoDB connector supports the following MongoDB topologies:</p>
</div>
<div id="mongodb-replicaset" class="dlist">
<dl>
<dt class="hdlist1">MongoDB replica set</dt>
<dd>
<p>The Debezium MongoDB connector can capture changes from a single <a href="https://docs.mongodb.com/manual/replication/">MongoDB replica set</a>.
Production replica sets require a minimum of <a href="https://docs.mongodb.com/manual/core/replica-set-architecture-three-members/">at least three members</a>.</p>
<div class="paragraph">
<p>To use the MongoDB connector with a replica set, you must set the value of the <code>mongodb.connection.string</code> property in the connector configuration to the <a href="https://www.mongodb.com/docs/manual/reference/connection-string/">replica set connection string</a>.
When the connector is ready to begin capturing changes from a MongoDB change stream, it starts a connection task.
The connection task then uses the specified connection string to establish a connection to an available replica set member.</p>
</div>
</dd>
</dl>
</div>
<div id="mongodb-sharded-cluster" class="dlist">
<dl>
<dt class="hdlist1">MongoDB sharded cluster</dt>
<dd>
<p>A <a href="https://docs.mongodb.com/manual/sharding/">MongoDB sharded cluster</a> consists of:</p>
<div class="ulist">
<ul>
<li>
<p>One or more <em>shards</em>, each deployed as a replica set;</p>
</li>
<li>
<p>A separate replica set that acts as the cluster&#8217;s <em>configuration server</em></p>
</li>
<li>
<p>One or more <em>routers</em> (also called <code>mongos</code>) to which clients connect and that routes requests to the appropriate shards</p>
<div class="paragraph">
<p>To use the MongoDB connector with a sharded cluster, in the connector configuration, set the value of the <code>mongodb.connection.string</code> property to the  <a href="https://www.mongodb.com/docs/manual/reference/connection-string/">sharded cluster connection string</a>.</p>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div id="mongodb-standalone-server" class="dlist">
<dl>
<dt class="hdlist1">MongoDB standalone server</dt>
<dd>
<p>The MongoDB connector is not capable of monitoring the changes of a standalone MongoDB server, since standalone servers do not have an oplog.
The connector will work if the standalone server is converted to a replica set with one member.</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>MongoDB does not recommend running a standalone server in production.
For more information, see the <a href="https://docs.mongodb.com/manual/core/replica-set-architectures/">MongoDB documentation</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="required-user-permissions"><a class="anchor" href="#required-user-permissions"></a>Required user permissions</h3>
<div class="paragraph">
<p>To capture data from MongoDB, Debezium attaches to the database as a MongoDB user.
The MongoDB user account that you create for Debezium requires specific database permissions to read from the database.
The connector user requires the following permissions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Read from the database.</p>
</li>
<li>
<p>Run the <code>hello</code> command.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The connector user might also require the following permission:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Read from the <code>config.shards</code> system collection.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Database read permissions</div>
<p>The connector user must be able to read from all databases, or to read from a specific database, depending on the value of the connector&#8217;s <a href="#mongodb-property-capture-scope"><code>capture.scope</code></a> property.
Assign one of the following permissions to the user, depending on the <code>capture.scope</code> setting:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>capture.scope</code> is set to <code>deployment</code></dt>
<dd>
<p>Grant the user permission to read any database.</p>
</dd>
<dt class="hdlist1"><code>capture.scope</code> is set to <code>database</code></dt>
<dd>
<p>Grant the user permission to read the database specified by the connector&#8217;s <a href="#mongodb-property-capture-target"><code>capture.target</code></a> property.</p>
</dd>
<dt class="hdlist1"><code>capture.scope</code> is set to <code>collection</code></dt>
<dd>
<p>Grant the user permission to read the collection specified by the connector&#8217;s <a href="#mongodb-property-capture-target"><code>capture.target</code></a> property.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<div class="title">Permission to use the MongoDB <code>hello</code> command</div>
<p>Regardless of the <code>capture.scope</code> setting, the user requires permission to run the MongoDB <a href="https://www.mongodb.com/docs/manual/reference/command/hello/">hello</a> command.</p>
</div>
<div class="paragraph">
<div class="title">Permission to read the <code>config.shards</code> collection</div>
<p>Depending on your Debezium environment, to enable the connector to perform offset consolidation, you must grant the connector user explicit permission to read the <code>config.shards</code> collection.
Permission to read the <code>config.shards</code> collection is required for the following connector environments:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Connectors upgraded from Debezium 2.5 or earlier.</p>
</li>
<li>
<p>Connectors configured to capture changes from a sharded MongoDB cluster.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="mongodb-logical-connector-name"><a class="anchor" href="#mongodb-logical-connector-name"></a>Logical connector name</h3>
<div class="paragraph">
<p>The connector configuration property <code>topic.prefix</code> serves as a <em>logical name</em> for the MongoDB replica set or sharded cluster.
The connector uses the logical name in a number of ways: as the prefix for all topic names, and as a unique identifier when recording the change stream position of each replica set.</p>
</div>
<div class="paragraph">
<p>You should give each MongoDB connector a unique logical name that meaningfully describes the source MongoDB system.
We recommend logical names begin with an alphabetic or underscore character, and remaining characters that are alphanumeric or underscore.</p>
</div>
</div>
<div class="sect2">
<h3 id="mongodb-offset-consolidation"><a class="anchor" href="#mongodb-offset-consolidation"></a>Offset consolidation</h3>
<div class="paragraph">
<p>The Debezium MongoDB connector no longer supports <code>replica_set</code> connections to sharded MongoDB deployments.
As a result, the offsets recorded by connector versions that used the <code>replica_set</code> connection mode are incompatible with the current version.</p>
</div>
<div class="paragraph">
<p>To minimize the affects of the connection mode change, and to prevent the connector from running unnecessary snapshots, when the connector restarts after the upgrade, it runs a procedure to consolidate offsets.
During this offset consolidation procedure, the connector completes the following steps to reconcile offsets that were recorded by the earlier connector version:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Offsets that were recorded by connector versions later than 2.5 are used as-is.</p>
</li>
<li>
<p>Offsets for events that were captured in <code>sharded</code> connection mode from sharded MongoDB deployments, or from MongoDB replica set deployments, are used as-is.</p>
</li>
<li>
<p>Shard-specific offsets that were recorded by connector versions 2.5.x and earlier are used as-is, if both of the following conditions apply:</p>
<div class="ulist">
<ul>
<li>
<p>The offsets exist for all current database shards.</p>
</li>
<li>
<p><a href="#mongodb-property-allow-offset-invalidation">Offset invalidation</a> is enabled.<br>
If offset invalidation is disabled, the connector fails to start.</p>
</li>
</ul>
</div>
</li>
<li>
<p>After the connector processes existing offsets in the preceding steps, it resumes streaming changes, and then commits offsets for new events that it captures.<br>
If the offset consolidation procedure does not detect any existing offsets, the connector <a href="#mongodb-performing-a-snapshot">performs an initial snapshot</a>.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="mongodb-performing-a-snapshot"><a class="anchor" href="#mongodb-performing-a-snapshot"></a>Performing a snapshot</h3>
<div class="paragraph">
<p>When a Debezium task starts to use a replica set, it uses the connector&#8217;s logical name and the replica set name to find an <em>offset</em> that describes the position where the connector previously stopped reading changes.
If an offset can be found and it still exists in the oplog, then the task immediately proceeds with <a href="#mongodb-streaming-changes">streaming changes</a>, starting at the recorded offset position.</p>
</div>
<div class="paragraph">
<p>However, if no offset is found, or if the oplog no longer contains that position, the task must first obtain the current state of the replica set contents by performing a <em>snapshot</em>.
This process starts by recording the current position of the oplog and recording that as the offset (along with a flag that denotes a snapshot has been started).
The task then proceeds to copy each collection, spawning as many threads as possible (up to the value of the <code>snapshot.max.threads</code> configuration property) to perform this work in parallel.
The connector records a separate <em>read event</em> for each document it sees.
Each read event contains the object&#8217;s identifier, the complete state of the object, and <em>source</em> information about the MongoDB replica set where the object was found.
The source information also includes a flag that denotes that the event was produced during a snapshot.</p>
</div>
<div class="paragraph">
<p>This snapshot will continue until it has copied all collections that match the connector&#8217;s filters.
If the connector is stopped before the tasks' snapshots are completed, upon restart the connector begins the snapshot again.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Try to avoid task reassignment and reconfiguration while the connector performs snapshots of any replica sets.
The connector generates log messages to report on the progress of the snapshot.
To provide for the greatest control, run a separate Kafka Connect cluster for each connector.</p>
</div>
</td>
</tr>
</table>
</div>
<table id="mongodb-connector-snapshot-mode-options" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Settings for <code>snapshot.mode</code> connector configuration property</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Setting</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>always</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The connector performs a snapshot every time that it starts.
After the snapshot completes, the connector begins to stream event records for subsequent database changes.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>initial</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>After the connector starts, it performs an initial database snapshot.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>initial_only</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The connector performs a database snapshot.
After the snapshot completes, the connector stops, and does not stream event records for subsequent database changes.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>never</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Deprecated, see <code>no_data</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>no_data</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The connector captures the structure of all relevant tables,
but it does not create <code>READ</code> events to represent the data set at the point of the connector&#8217;s start-up.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>when_needed</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>After the connector starts, it performs a snapshot only if it detects one of the following circumstances:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It cannot detect any topic offsets.</p>
</li>
<li>
<p>A previously recorded offset specifies a log position that is not available on the server.</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>configuration_based</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Set the snapshot mode to <code>configuration_based</code> to control snapshot behavior through the set of connector properties that have the prefix 'snapshot.mode.configuration.based'.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>custom</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The <code>custom</code> snapshot mode lets you inject your own implementation of the <code>io.debezium.spi.snapshot.Snapshotter</code> interface.
Set the <code>snapshot.mode.custom.name</code> configuration property to the name provided by the <code>name()</code> method of your implementation.
The name is specified on the classpath of your Kafka Connect cluster.
If you use the Debezium <code>EmbeddedEngine</code>, the name is included in the connector JAR file.
For more information, see <a href="#connector-custom-snapshot">custom snapshotter SPI</a>.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For more information, see <a href="#mongodb-property-snapshot-mode"><code>snapshot.mode</code></a> in the table of connector configuration properties.</p>
</div>
</div>
<div class="sect2">
<h3 id="mongodb-ad-hoc-snapshots"><a class="anchor" href="#mongodb-ad-hoc-snapshots"></a>Ad hoc snapshots</h3>
<div class="paragraph">
<p>By default, a connector runs an initial snapshot operation only after it starts for the first time.
Following this initial snapshot, under normal circumstances, the connector does not repeat the snapshot process.
Any future change event data that the connector captures comes in through the streaming process only.</p>
</div>
<div class="paragraph">
<p>However, in some situations the data that the connector obtained during the initial snapshot might become stale, lost, or incomplete.
To provide a mechanism for recapturing collection data, Debezium includes an option to perform ad hoc snapshots.
You might want to perform an ad hoc snapshot after any of the following changes occur in your Debezium environment:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The connector configuration is modified to capture a different set of collections.</p>
</li>
<li>
<p>Kafka topics are deleted and must be rebuilt.</p>
</li>
<li>
<p>Data corruption occurs due to a configuration error or some other problem.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can re-run a snapshot for a collection for which you previously captured a snapshot by initiating a so-called <em>ad-hoc snapshot</em>.
Ad hoc snapshots require the use of <a href="../configuration/signalling.html#sending-signals-to-a-debezium-connector" class="xref page">signaling collections</a>.
You initiate an ad hoc snapshot by sending a signal request to the Debezium signaling collection.</p>
</div>
<div class="paragraph">
<p>When you initiate an ad hoc snapshot of an existing collection, the connector appends content to the topic that already exists for the collection.
If a previously existing topic was removed, Debezium can create a topic automatically if <a href="../configuration/topic-auto-create-config.html#customizing-debezium-automatically-created-topics" class="xref page">automatic topic creation</a> is enabled.</p>
</div>
<div class="paragraph">
<p>Ad hoc snapshot signals specify the collections to include in the snapshot.
The snapshot can capture the entire contents of the database, or capture only a subset of the collections in the database.</p>
</div>
<div class="paragraph">
<p>You specify the collections to capture by sending an <code>execute-snapshot</code> message to the signaling collection.
Set the type of the <code>execute-snapshot</code> signal to <code>incremental</code> or <code>blocking</code>, and provide the names of the collections to include in the snapshot, as described in the following table:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Example of an ad hoc <code>execute-snapshot</code> signal record</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>type</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>incremental</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Specifies the type of snapshot that you want to run.<br>
Currently, you can request <code>incremental</code> or <code>blocking</code> snapshots.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>data-collections</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>N/A</em></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>An array that contains regular expressions matching the fully-qualified names of the collection to be snapshotted.<br>
The format of the names is the same as for the <code>signal.data.collection</code> configuration option.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">Triggering an ad hoc incremental snapshot</div>
<p>You initiate an ad hoc incremental snapshot by adding an entry with the <code>execute-snapshot</code> signal type to the signaling collection.
After the connector processes the message, it begins the snapshot operation.
The snapshot process reads the first and last primary key values and uses those values as the start and end point for each collection.
Based on the number of entries in the collection, and the configured chunk size, Debezium divides the collection into chunks, and proceeds to snapshot each chunk, in succession, one at a time.</p>
</div>
<div class="paragraph">
<p>For more information, see <a href="#debezium-mongodb-incremental-snapshots">Incremental snapshots</a>.</p>
</div>
<div class="paragraph">
<div class="title">Triggering an ad hoc blocking snapshot</div>
<p>You initiate an ad hoc blocking snapshot by adding an entry with the <code>execute-snapshot</code> signal type to the signaling collection.
After the connector processes the message, it begins the snapshot operation.
The connector temporarily stops streaming, and then initiates a snapshot of the specified collection, following the same process that it uses during an initial snapshot.
After the snapshot completes, the connector resumes streaming.</p>
</div>
<div class="paragraph">
<p>For more information, see <a href="#mongodb-blocking-snapshots">Blocking snapshots</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="debezium-mongodb-incremental-snapshots"><a class="anchor" href="#debezium-mongodb-incremental-snapshots"></a>Incremental snapshots</h3>
<div class="paragraph">
<p>To provide flexibility in managing snapshots, Debezium includes a supplementary snapshot mechanism, known as <em>incremental snapshotting</em>.
Incremental snapshots rely on the Debezium mechanism for <a href="../configuration/signalling.html#sending-signals-to-a-debezium-connector" class="xref page">sending signals to a Debezium connector</a>.
Incremental snapshots are based on the <a href="https://github.com/debezium/debezium-design-documents/blob/main/DDD-3.md">DDD-3</a> design document.</p>
</div>
<div class="paragraph">
<p>In an incremental snapshot, instead of capturing the full state of a database all at once, as in an initial snapshot, Debezium captures each collection in phases, in a series of configurable chunks.
You can specify the collections that you want the snapshot to capture and the <a href="#mongodb-property-incremental-snapshot-chunk-size">size of each chunk</a>.
The chunk size determines the number of rows that the snapshot collects during each fetch operation on the database.
The default chunk size for incremental snapshots is 1024 rows.</p>
</div>
<div class="paragraph">
<p>As an incremental snapshot proceeds, Debezium uses watermarks to track its progress, maintaining a record of each collection row that it captures.
This phased approach to capturing data provides the following advantages over the standard initial snapshot process:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You can run incremental snapshots in parallel with streamed data capture, instead of postponing streaming until the snapshot completes.
The connector continues to capture near real-time events from the change log throughout the snapshot process, and neither operation blocks the other.</p>
</li>
<li>
<p>If the progress of an incremental snapshot is interrupted, you can resume it without losing any data.
After the process resumes, the snapshot begins at the point where it stopped, rather than recapturing the collection from the beginning.</p>
</li>
<li>
<p>You can run an incremental snapshot on demand at any time, and repeat the process as needed to adapt to database updates.
For example, you might re-run a snapshot after you modify the connector configuration to add a collection to its <a href="#mongodb-property-collection-include-list"><code>collection.include.list</code></a> property.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Incremental snapshot process</div>
<p>When you run an incremental snapshot, Debezium sorts each collection by primary key and then splits the collection into chunks based on the <a href="#mongodb-property-incremental-snapshot-chunk-size">configured chunk size</a>.
Working chunk by chunk, it then captures each collection row in a chunk.
For each row that it captures, the snapshot emits a <code>READ</code> event.
That event represents the value of the row when the snapshot for the chunk began.</p>
</div>
<div class="paragraph">
<p>As a snapshot proceeds, it’s likely that other processes continue to access the database, potentially modifying collection records.
To reflect such changes, <code>INSERT</code>, <code>UPDATE</code>, or <code>DELETE</code> operations are committed to the transaction log as per usual.
Similarly, the ongoing Debezium streaming process continues to detect these change events and emits corresponding change event records to Kafka.</p>
</div>
<div class="paragraph">
<div class="title">How Debezium resolves collisions among records with the same primary key</div>
<p>In some cases, the <code>UPDATE</code> or <code>DELETE</code> events that the streaming process emits are received out of sequence.
That is, the streaming process might emit an event that modifies a collection row before the snapshot captures the chunk that contains the <code>READ</code> event for that row.
When the snapshot eventually emits the corresponding <code>READ</code> event for the row, its value is already superseded.
To ensure that incremental snapshot events that arrive out of sequence are processed in the correct logical order, Debezium employs a buffering scheme for resolving collisions.
Only after collisions between the snapshot events and the streamed events are resolved does Debezium emit an event record to Kafka.</p>
</div>
<div class="paragraph">
<div class="title">Snapshot window</div>
<p>To assist in resolving collisions between late-arriving <code>READ</code> events and streamed events that modify the same collection row, Debezium employs a so-called <em>snapshot window</em>.
The snapshot windows demarcates the interval during which an incremental snapshot captures data for a specified collection chunk.
Before the snapshot window for a chunk opens, Debezium follows its usual behavior and emits events from the transaction log directly downstream to the target Kafka topic.
But from the moment that the snapshot for a particular chunk opens, until it closes, Debezium performs a de-duplication step to resolve collisions between events that have the same primary key..</p>
</div>
<div class="paragraph">
<p>For each data collection, the Debezium emits two types of events, and stores the records for them both in a single destination Kafka topic.
The snapshot records that it  captures directly from a table are emitted as <code>READ</code> operations.
Meanwhile, as users continue to update records in the data collection, and the transaction log is updated to reflect each commit, Debezium emits <code>UPDATE</code> or <code>DELETE</code> operations for each change.</p>
</div>
<div class="paragraph">
<p>As the snapshot window opens, and Debezium begins processing a snapshot chunk, it delivers snapshot records to a memory buffer.
During the snapshot windows, the primary keys of the <code>READ</code> events in the buffer are compared to the primary keys of the incoming streamed events.
If no match is found, the streamed event record is sent directly to Kafka.
If Debezium detects a match, it discards the buffered <code>READ</code> event, and writes the streamed record to the destination topic, because the streamed event logically supersede the static snapshot event.
After the snapshot window for the chunk closes, the buffer contains only <code>READ</code> events for which no related transaction log events exist.
Debezium emits these remaining <code>READ</code> events to the collection&#8217;s Kafka topic.</p>
</div>
<div class="paragraph">
<p>The connector repeats the process for each snapshot chunk.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Incremental snapshots require that the primary key for each table is stably ordered.
Because <code>String</code> fields can include special characters, and are subject to different encodings, string-based primary keys do not lend themselves to sorting in a consistent and predictable order.
When performing incremental snapshots, it&#8217;s best to set the primary key to a data type other than <code>String</code>.</p>
</div>
<div class="paragraph">
<p>For more information about BSON string types in MongoDB, see the <a href="https://www.mongodb.com/docs/manual/reference/bson-types/#string/">MongoDB documentation</a>).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Incremental snapshots for sharded clusters</div>
<p>To use incremental snapshots with sharded MongoDB clusters, you must set <a href="#mongodb-property-incremental-snapshot-chunk-size"><code>incremental.snapshot.chunk.size</code></a> to a value that is high enough to compensate for the <a href="https://www.mongodb.com/docs/manual/administration/change-streams-production-recommendations/#sharded-clusters">increased complexity</a> of change stream pipelines.</p>
</div>
<div class="sect3">
<h4 id="mongodb-triggering-an-incremental-snapshot"><a class="anchor" href="#mongodb-triggering-an-incremental-snapshot"></a>Triggering an incremental snapshot</h4>
<div class="paragraph">
<p>Currently, the only way to initiate an incremental snapshot is to send an <a href="../configuration/signalling.html#debezium-signaling-ad-hoc-snapshots" class="xref page">ad hoc snapshot signal</a> to the signaling collection on the source database.</p>
</div>
<div class="paragraph">
<p>You submit a signal to the signaling collection by using the MongoDB <code>insert()</code> method.</p>
</div>
<div class="paragraph">
<p>After Debezium detects the change in the signaling collection, it reads the signal, and runs the requested snapshot operation.</p>
</div>
<div class="paragraph">
<p>The query that you submit specifies the collections to include in the snapshot, and, optionally, specifies the type of snapshot operation.
Currently, the only valid options for snapshots operations are <code>incremental</code> and <code>blocking</code>.</p>
</div>
<div class="paragraph">
<p>To specify the collections to include in the snapshot, provide a <code>data-collections</code> array that lists the collections or an array of regular expressions used to match collections, for example,<br>
<code>{"data-collections": ["public.Collection1", "public.Collection2"]}</code><br></p>
</div>
<div class="paragraph">
<p>The <code>data-collections</code> array for an incremental snapshot signal has no default value.
If the <code>data-collections</code> array is empty, Debezium detects that no action is required and does not perform a snapshot.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the name of a collection that you want to include in a snapshot contains a dot (<code>.</code>) in the name of the database, schema, or table, to add the collection to the <code>data-collections</code> array, you must escape each part of the name in double quotes.<br>
<br>
For example, to include a data collection that exists in the <code><strong>public</strong></code> database, and that has the name <code><strong>My.Collection</strong></code>, use the following format: <code><strong>"public"."My.Collection"</strong></code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="../configuration/signalling.html#debezium-signaling-enabling-source-signaling-channel" class="xref page">Signaling is enabled</a>.<br></p>
<div class="ulist">
<ul>
<li>
<p>A signaling data collection exists on the source database.</p>
</li>
<li>
<p>The signaling data collection is specified in the <a href="#mongodb-property-signal-data-collection"><code>signal.data.collection</code></a> property.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Using a source signaling channel to trigger an incremental snapshot</div>
<ol class="arabic">
<li>
<p>Insert a snapshot signal document into the signaling collection:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"><em>&lt;signalDataCollection&gt;</em>.insert({"<em>id" : _&lt;idNumber&gt;</em>,"type" : <em>&lt;snapshotType&gt;</em>, "data" : {"data-collections" ["<em>&lt;collectionName&gt;</em>", "<em>&lt;collectionName&gt;</em>"],"type": <em>&lt;snapshotType&gt;</em>, "additional-conditions" : [{"data-collections" : "<em>&lt;collectionName&gt;</em>", "filter" : "<em>&lt;additional-condition&gt;</em>"}] }});</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">db.debeziumSignal.insert({ <i class="conum" data-value="1"></i><b>(1)</b>
"type" : "execute-snapshot", <i class="conum" data-value="2"></i><b>(2)</b> <i class="conum" data-value="3"></i><b>(3)</b>
"data" : {
"data-collections" ["\"public\".\"Collection1\"", "\"public\".\"Collection2\""], <i class="conum" data-value="4"></i><b>(4)</b>
"type": "incremental"} <i class="conum" data-value="5"></i><b>(5)</b>
"additional-conditions":[{"data-collection": "schema1.table1" ,"filter":"color=\'blue\'"}]}'); <i class="conum" data-value="6"></i><b>(6)</b>
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>The values of the <code>id</code>,<code>type</code>, and <code>data</code> parameters in the command correspond to the <a href="../configuration/signalling.html#debezium-signaling-description-of-required-structure-of-a-signaling-data-collection" class="xref page">fields of the signaling collection</a>.</p>
</div>
<div class="paragraph">
<p>The following table describes the parameters in the example:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Descriptions of fields in a MongoDB insert() command for sending an incremental snapshot signal to the signaling collection</caption>
<colgroup>
<col style="width: 11.1111%;">
<col style="width: 22.2222%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Item</th>
<th class="tableblock halign-left valign-top">Value</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>db.debeziumSignal</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the fully-qualified name of the signaling collection on the source database.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <code>_id</code> parameter specifies an arbitrary string that is assigned as the <code>id</code> identifier for the signal request.<br>
The insert method in the preceding example omits use of the optional <code>_id</code> parameter.
Because the document does not explicitly assign a value for the parameter, the arbitrary id that MongoDB automatically assigns to the document becomes the <code>id</code> identifier for the signal request.<br>
Use this string to identify logging messages to entries in the signaling collection.
Debezium does not use this identifier string.
Rather, during the snapshot, Debezium generates its own <code>id</code> string as a watermarking signal.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>execute-snapshot</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies <code>type</code> parameter specifies the operation that the signal is intended to trigger.<br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>data-collections</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A required component of the <code>data</code> field of a signal that specifies an array of collection names or regular expressions to match collection names to include in the snapshot.<br>
The array lists regular expressions which match collections by their fully-qualified names, using the same format as you use to specify the name of the connector&#8217;s signaling collection in the <a href="#mongodb-property-signal-data-collection"><code>signal.data.collection</code></a> configuration property.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>incremental</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An optional <code>type</code> component of the <code>data</code> field of a signal that specifies the type of snapshot operation to run.<br>
Currently supports the <code>incremental</code> and <code>blocking</code> types.<br>
If you do not specify a value, the connector runs an incremental snapshot.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>additional-conditions</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An optional array that specifies a set of additional conditions that the connector evaluates to determine the subset of records to include in a snapshot.<br>
Each element in the <code>additional-conditions</code> array is an object that includes the following keys:</p>
<p class="tableblock"><code>data-collection</code>:: The fully-qualified name of the data collection for which the filter will be applied.
<code>filter</code>:: Specifies the column values that must be present in a data collection record for the snapshot to include it, for example, <code>"color='blue'"</code>.</p></td>
</tr>
</tbody>
</table>
</li>
</ol>
</div>
<div class="paragraph">
<p>The following example, shows the JSON for an incremental snapshot event that is captured by a connector.</p>
</div>
<div class="listingblock">
<div class="title">Example: Incremental snapshot event message</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "before":null,
    "after": {
        "pk":"1",
        "value":"New data"
    },
    "source": {
        ...
        "snapshot":"incremental" <i class="conum" data-value="1"></i><b>(1)</b>
    },
    "op":"r", <i class="conum" data-value="2"></i><b>(2)</b>
    "ts_ms":"1620393591654",
    "ts_us":"1620393591654962",
    "ts_ns":"1620393591654962147",
    "transaction":null
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 66.6668%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Item</th>
<th class="tableblock halign-left valign-top">Field name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>snapshot</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the type of snapshot operation to run.<br>
Currently, the only valid options are <code>blocking</code> and <code>incremental</code>.<br>
Specifying a <code>type</code> value in the SQL query that you submit to the signaling collection is optional.<br>
If you do not specify a value, the connector runs an incremental snapshot.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>op</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the event type.<br>
The value for snapshot events is <code>r</code>, signifying a <code>READ</code> operation.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="mongodb-triggering-an-incremental-snapshot-kafka"><a class="anchor" href="#mongodb-triggering-an-incremental-snapshot-kafka"></a>Using the Kafka signaling channel to trigger an incremental snapshot</h4>
<div class="paragraph">
<p>You can send a message to the <a href="../configuration/signalling.html#debezium-signaling-enabling-kafka-signaling-channel" class="xref page">configured Kafka topic</a> to request the connector to run an ad hoc incremental snapshot.</p>
</div>
<div class="paragraph">
<p>The key of the Kafka message must match the value of the <code>topic.prefix</code> connector configuration option.</p>
</div>
<div class="paragraph">
<p>The value of the message is a JSON object with <code>type</code> and <code>data</code> fields.</p>
</div>
<div class="paragraph">
<p>The signal type is <code>execute-snapshot</code>, and the <code>data</code> field must have the following fields:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. Execute snapshot data fields</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>type</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>incremental</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The type of the snapshot to be executed.
Currently Debezium supports the <code>incremental</code> and <code>blocking</code> types.<br>
See the next section for more details.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>data-collections</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>N/A</em></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>An array of comma-separated regular expressions that match the fully-qualified names of tables to include in the snapshot.<br>
Specify the names by using the same format as is required for the <a href="#mongodb-property-signal-data-collection">signal.data.collection</a> configuration option.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>additional-conditions</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>N/A</em></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>An optional array of additional conditions that specifies criteria that the connector evaluates to designate a subset of records to include in a snapshot.<br>
Each additional condition is an object that specifies the criteria for filtering the data that an ad hoc snapshot captures.
You can set the following parameters for each additional condition:
<code>data-collection</code>:: The fully-qualified name of the collection that the filter applies to.
You can apply different filters to each collection.
<code>filter</code>:: Specifies column values that must be present in a database record for the snapshot to include it, for example,  <code>"color='blue'"</code>.<br>
<br>
The values that you assign to the <code>filter</code> parameter are the same types of values that you might specify in the <code>WHERE</code> clause of <code>SELECT</code> statements when you set the <code>snapshot.select.statement.overrides</code> property for a blocking snapshot.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>An example of the execute-snapshot Kafka message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Key = `test_connector`

Value = `{"type":"execute-snapshot","data": {"data-collections": ["schema1.table1", "schema1.table2"], "type": "INCREMENTAL"}}`</pre>
</div>
</div>
<div class="paragraph">
<div class="title">Ad hoc incremental snapshots with additional-conditions</div>
<p>Debezium uses the <code>additional-conditions</code> field to select a subset of a collection&#8217;s content.</p>
</div>
<div class="paragraph">
<p>Typically, when Debezium runs a snapshot, it runs a SQL query such as:</p>
</div>
<div class="paragraph">
<p><code>SELECT * FROM <em>&lt;tableName&gt;</em> &#8230;&#8203;.</code></p>
</div>
<div class="paragraph">
<p>When the snapshot request includes an <code>additional-conditions</code> property, the <code>data-collection</code> and <code>filter</code> parameters of the  property are appended to the SQL query, for example:</p>
</div>
<div class="paragraph">
<p><code>SELECT * FROM <em>&lt;data-collection&gt;</em> WHERE <em>&lt;filter&gt;</em> &#8230;&#8203;.</code></p>
</div>
<div class="paragraph">
<p>For example, given a <code>products</code> collection with the columns <code>id</code> (primary key), <code>color</code>, and <code>brand</code>, if you want a snapshot to include only content for which <code>color='blue'</code>, when you request the snapshot, you could add the <code>additional-conditions</code> property to filter the content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Key = `test_connector`

Value = `{"type":"execute-snapshot","data": {"data-collections": ["schema1.products"], "type": "INCREMENTAL", "additional-conditions": [{"data-collection": "schema1.products" ,"filter":"color='blue'"}]}}`</pre>
</div>
</div>
<div class="paragraph">
<p>You can use the <code>additional-conditions</code> property to pass conditions based on multiple columns.
For example, using the same <code>products</code> collection as in the previous example, if you want a snapshot to include only the content from the <code>products</code> collection for which <code>color='blue'</code>, and <code>brand='MyBrand'</code>, you could send the following request:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Key = `test_connector`

Value = `{"type":"execute-snapshot","data": {"data-collections": ["schema1.products"], "type": "INCREMENTAL", "additional-conditions": [{"data-collection": "schema1.products" ,"filter":"color='blue' AND brand='MyBrand'"}]}}`</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongodb-stopping-an-incremental-snapshot"><a class="anchor" href="#mongodb-stopping-an-incremental-snapshot"></a>Stopping an incremental snapshot</h4>
<div class="paragraph">
<p>You can also stop an incremental snapshot by sending a signal to the collection on the source database.
You submit a stop snapshot signal by inserting a document into the to the signaling collection.
After Debezium detects the change in the signaling collection, it reads the signal, and stops the incremental snapshot operation if it&#8217;s in progress.</p>
</div>
<div class="paragraph">
<p>The query that you submit specifies the snapshot operation of <code>incremental</code>, and, optionally, the collections of the current running snapshot to be removed.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="../configuration/signalling.html#debezium-signaling-enabling-source-signaling-channel" class="xref page">Signaling is enabled</a>.<br></p>
<div class="ulist">
<ul>
<li>
<p>A signaling data collection exists on the source database.</p>
</li>
<li>
<p>The signaling data collection is specified in the <a href="#mongodb-property-signal-data-collection"><code>signal.data.collection</code></a> property.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Using a source signaling channel to stop an incremental snapshot</div>
<ol class="arabic">
<li>
<p>Insert a stop snapshot signal document into the signaling collection:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"><em>&lt;signalDataCollection&gt;</em>.insert({"<em>id" : _&lt;idNumber&gt;</em>,"type" : "stop-snapshot", "data" : {"data-collections" ["<em>&lt;collectionName&gt;</em>", "<em>&lt;collectionName&gt;</em>"],"type": "incremental"}});</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">db.debeziumSignal.insert({ <i class="conum" data-value="1"></i><b>(1)</b>
"type" : "stop-snapshot", <i class="conum" data-value="2"></i><b>(2)</b> <i class="conum" data-value="3"></i><b>(3)</b>
"data" : {
"data-collections" ["\"public\".\"Collection1\"", "\"public\".\"Collection2\""], <i class="conum" data-value="4"></i><b>(4)</b>
"type": "incremental"} <i class="conum" data-value="5"></i><b>(5)</b>
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>The values of the <code>id</code>, <code>type</code>, and <code>data</code> parameters in the signal command correspond to the <a href="../configuration/signalling.html#debezium-signaling-description-of-required-structure-of-a-signaling-data-collection" class="xref page">fields of the signaling collection</a>.</p>
</div>
<div class="paragraph">
<p>The following table describes the parameters in the example:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. Descriptions of fields in an insert command for sending a stop incremental snapshot document to the signaling collection</caption>
<colgroup>
<col style="width: 11.1111%;">
<col style="width: 22.2222%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Item</th>
<th class="tableblock halign-left valign-top">Value</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>db.debeziumSignal</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the fully-qualified name of the signaling collection on the source database.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The insert method in the preceding example omits use of the optional <code>_id</code> parameter.
Because the document does not explicitly assign a value for the parameter, the arbitrary id that MongoDB automatically assigns to the document becomes the <code>id</code> identifier for the signal request.<br>
Use this string to identify logging messages to entries in the signaling collection.
Debezium does not use this identifier string.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stop-snapshot</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <code>type</code> parameter specifies the operation that the signal is intended to trigger.<br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>data-collections</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An optional component of the <code>data</code> field of a signal that specifies an array of collection names or regular expressions to match collection names to remove from the snapshot.<br>
The array lists regular expressions which match collections by their fully-qualified names, using the same format as you use to specify the name of the connector&#8217;s signaling collection in the <a href="#mongodb-property-signal-data-collection"><code>signal.data.collection</code></a> configuration property.
If this component of the <code>data</code> field is omitted, the signal stops the entire incremental snapshot that is in progress.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>incremental</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A required component of the <code>data</code> field of a signal that specifies the type of snapshot operation that is to be stopped.<br>
Currently, the only valid option is <code>incremental</code>.<br>
If you do not specify a <code>type</code> value, the signal fails to stop the incremental snapshot.</p></td>
</tr>
</tbody>
</table>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="mongodb-stopping-an-incremental-snapshot-kafka"><a class="anchor" href="#mongodb-stopping-an-incremental-snapshot-kafka"></a>Using the Kafka signaling channel to stop an incremental snapshot</h4>
<div class="paragraph">
<p>You can send a signal message to the <a href="../configuration/signalling.html#debezium-signaling-enabling-kafka-signaling-channel" class="xref page">configured Kafka signaling topic</a> to stop an ad hoc incremental snapshot.</p>
</div>
<div class="paragraph">
<p>The key of the Kafka message must match the value of the <code>topic.prefix</code> connector configuration option.</p>
</div>
<div class="paragraph">
<p>The value of the message is a JSON object with <code>type</code> and <code>data</code> fields.</p>
</div>
<div class="paragraph">
<p>The signal type is <code>stop-snapshot</code>, and the <code>data</code> field must have the following fields:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 6. Execute snapshot data fields</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>type</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>incremental</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The type of the snapshot to be executed.
Currently Debezium supports only the <code>incremental</code> type. <br>
See the next section for more details.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>data-collections</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>N/A</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An optional array of comma-separated regular expressions that match the fully-qualified names of the tables to include in the snapshot.<br>
Specify the names by using the same format as is required for the <a href="#mongodb-property-signal-data-collection">signal.data.collection</a> configuration option.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following example shows a typical <code>stop-snapshot</code> Kafka message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Key = `test_connector`

Value = `{"type":"stop-snapshot","data": {"data-collections": ["schema1.table1", "schema1.table2"], "type": "INCREMENTAL"}}`</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="connector-custom-snapshot"><a class="anchor" href="#connector-custom-snapshot"></a>Custom snapshotter SPI</h3>
<div class="paragraph">
<p>For more advanced uses, you can fine-tune control of the snapshot by implementing one of the following interfaces:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>io.debezium.snapshot.spi.Snapshotter</code></dt>
<dd>
<p>Controls whether the connector takes a snapshot.</p>
</dd>
<dt class="hdlist1"><code>io.debezium.snapshot.spi.SnapshotQuery</code></dt>
<dd>
<p>Controls how data is queried during a snapshot.</p>
</dd>
<dt class="hdlist1"><code>io.debezium.snapshot.spi.SnapshotLock</code></dt>
<dd>
<p>Controls whether the connector locks tables when taking a snapshot.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">io.debezium.snapshot.spi.Snapshotter interface. All built-in snapshot modes implement this interface.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">/**
 * {@link Snapshotter} is used to determine the following details about the snapshot process:
 * &lt;p&gt;
 * - Whether a snapshot occurs. &lt;br&gt;
 * - Whether streaming continues during the snapshot. &lt;br&gt;
 * - Whether the snapshot includes schema (if supported). &lt;br&gt;
 * - Whether to snapshot data or schema following an error.
 * &lt;p&gt;
 * Although Debezium provides many default snapshot modes,
 * to provide more advanced functionality, such as partial snapshots,
 * you can customize implementation of the interface.
 * For more information, see the documentation.
 *
 *
 *
 */
@Incubating
public interface Snapshotter extends Configurable {

    /**
     * @return the name of the snapshotter.
     *
     *
     */
    String name();

    /**
     * @param offsetExists is {@code true} when the connector has an offset context (i.e. restarted)
     * @param snapshotInProgress is {@code true} when the connector is started, but a snapshot is already in progress
     *
     * @return {@code true} if the snapshotter should take a data snapshot
     */
    boolean shouldSnapshotData(boolean offsetExists, boolean snapshotInProgress);

    /**
     * @param offsetExists is {@code true} when the connector has an offset context (i.e. restarted)
     * @param snapshotInProgress is {@code true} when the connector is started, but a snapshot is already in progress
     *
     * @return {@code true} if the snapshotter should take a schema snapshot
     */
    boolean shouldSnapshotSchema(boolean offsetExists, boolean snapshotInProgress);

    /**
     * @return {@code true} if the snapshotter should stream after taking a snapshot
     */
    boolean shouldStream();

    /**
     * @return {@code true} whether the schema can be recovered if database schema history is corrupted.
     */
    boolean shouldSnapshotOnSchemaError();

    /**
     * @return {@code true} whether the snapshot should be re-executed when there is a gap in data stream.
     */
    boolean shouldSnapshotOnDataError();

    /**
     *
     * @return {@code true} if streaming should resume from the start of the snapshot
     * transaction, or {@code false} for when a connector resumes and takes a snapshot,
     * streaming should resume from where streaming previously left off.
     */
    default boolean shouldStreamEventsStartingFromSnapshot() {
        return true;
    }

    /**
     * Lifecycle hook called after the snapshot phase is successful.
     */
    default void snapshotCompleted() {
        // no operation
    }

    /**
     * Lifecycle hook called after the snapshot phase is aborted.
     */
    default void snapshotAborted() {
        // no operation
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">io.debezium.snapshot.spi.SnapshotQuery interface. All built-in snapshot query modes implement this interface.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">/**
 * {@link SnapshotQuery} is used to determine the query used during a data snapshot
 *
 *
 */
public interface SnapshotQuery extends Configurable, Service {

    /**
     * @return the name of the snapshot lock.
     *
     *
     */
    String name();

    /**
     * Generate a valid query string for the specified table, or an empty {@link Optional}
     * to skip snapshotting this table (but that table will still be streamed from)
     *
     * @param tableId the table to generate a query for
     * @param snapshotSelectColumns the columns to be used in the snapshot select based on the column
     *                              include/exclude filters
     * @return a valid query string, or none to skip snapshotting this table
     */
    Optional&lt;String&gt; snapshotQuery(String tableId, List&lt;String&gt; snapshotSelectColumns);

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">io.debezium.snapshot.spi.SnapshotLock interface. All built-in snapshot lock modes implement this interface.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">/**
 * {@link SnapshotLock} is used to determine the table lock mode used during schema snapshot
 *
 *
 */
public interface SnapshotLock extends Configurable, Service {

    /**
     * @return the name of the snapshot lock.
     *
     *
     */
    String name();

    /**
     * Returns a SQL statement for locking the given table during snapshotting, if required by the specific snapshotter
     * implementation.
     */
    Optional&lt;String&gt; tableLockingStatement(Duration lockTimeout, String tableId);

}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongodb-blocking-snapshots"><a class="anchor" href="#mongodb-blocking-snapshots"></a>Blocking snapshots</h3>
<div class="paragraph">
<p>To provide more flexibility in managing snapshots, Debezium includes a supplementary ad hoc snapshot mechanism, known as a <em>blocking snapshot</em>.
Blocking snapshots rely on the Debezium mechanism for <a href="../configuration/signalling.html#sending-signals-to-a-debezium-connector" class="xref page">sending signals to a Debezium connector</a>.</p>
</div>
<div class="paragraph">
<p>A blocking snapshot behaves just like an <em>initial snapshot</em>, except that you can trigger it at run time.</p>
</div>
<div class="paragraph">
<p>You might want to run a blocking snapshot rather than use the standard initial snapshot process in the following situations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You add a new collection and you want to complete the snapshot while the connector is running.</p>
</li>
<li>
<p>You add a large collection, and you want the snapshot to complete in less time than is possible with an incremental snapshot.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Blocking snapshot process</div>
<p>When you run a blocking snapshot, Debezium stops streaming, and then initiates a snapshot of the specified collection, following the same process that it uses during an initial snapshot.
After the snapshot completes, the streaming is resumed.</p>
</div>
<div class="paragraph">
<div class="title">Configure snapshot</div>
<p>You can set the following properties in the <code>data</code> component of a signal:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>data-collections: to specify which collections must be snapshot</p>
</li>
<li>
<p>additional-conditions: You can specify different filters for different collection.<br></p>
<div class="ulist">
<ul>
<li>
<p>The <code>data-collection</code> property is the fully-qualified name of the collection for which the filter will be applied.</p>
</li>
<li>
<p>The <code>filter</code> property will have the same value used in the  <code>snapshot.select.statement.overrides</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">  {"type": "blocking", "data-collections": ["schema1.table1", "schema1.table2"], "additional-conditions": [{"data-collection": "schema1.table1", "filter": "SELECT * FROM [schema1].[table1] WHERE column1 = 0 ORDER BY column2 DESC"}, {"data-collection": "schema1.table2", "filter": "SELECT * FROM [schema1].[table2] WHERE column2 &gt; 0"}]}</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Possible duplicates</div>
<p>A delay might exist between the time that you send the signal to trigger the snapshot, and the time when streaming stops and the snapshot starts.
As a result of this delay, after the snapshot completes, the connector might emit some event records that duplicate records captured by the snapshot.</p>
</div>
</div>
<div class="sect2">
<h3 id="mongodb-streaming-changes"><a class="anchor" href="#mongodb-streaming-changes"></a>Streaming changes</h3>
<div id="mongodb-tailing-the-oplog" class="paragraph">
<p>After the connector task for a replica set records an offset, it uses the offset to determine the position in the oplog where it should start streaming changes.
The task then (depending on the configuration) either connects to the replica set&#8217;s primary node or connects to a replica-set-wide change stream and starts streaming changes from that position.
It processes all of create, insert, and delete operations, and converts them into Debezium <a href="#mongodb-events">change events</a>.
Each change event includes the position in the oplog where the operation was found, and the connector periodically records this as its most recent offset.
The interval at which the offset is recorded is governed by <a href="https://kafka.apache.org/documentation/#offset.flush.interval.ms"><code>offset.flush.interval.ms</code></a>, which is a Kafka Connect worker configuration property.</p>
</div>
<div class="paragraph">
<p>When the connector is stopped gracefully, the last offset processed is recorded so that, upon restart, the connector will continue exactly where it left off.
If the connector&#8217;s tasks terminate unexpectedly, however, then the tasks may have processed and generated events after it last records the offset but before the last offset is recorded; upon restart, the connector begins at the last <em>recorded</em> offset, possibly generating some the same events that were previously generated just prior to the crash.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When all components in a Kafka pipeline operate nominally, Kafka consumers receive every message <strong><em>exactly once</em></strong>.
However, when things go wrong, Kafka can only guarantee that consumers receive every message <strong><em>at least once</em></strong>.
To avoid unexpected results, consumers must be able to handle duplicate messages.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As mentioned earlier, the connector tasks always use the replica set&#8217;s primary node to stream changes from the oplog, ensuring that the connector sees the most up-to-date operations as possible and can capture the changes with lower latency than if secondaries were to be used instead.
When the replica set elects a new primary, the connector immediately stops streaming changes, connects to the new primary, and starts streaming changes from the new primary node at the same position.
Likewise, if the connector experiences any problems communicating with the replica set members, it tries to reconnect, by using exponential backoff so as to not overwhelm the replica set, and once connected it continues streaming changes from where it last left off.
In this way, the connector is able to dynamically adjust to changes in replica set membership and automatically handle communication failures.</p>
</div>
<div class="paragraph">
<p>To summarize, the MongoDB connector continues running in most situations. Communication problems might cause the connector to wait until the problems are resolved.</p>
</div>
</div>
<div class="sect2">
<h3 id="mongodb-pre-image-support"><a class="anchor" href="#mongodb-pre-image-support"></a>Pre-image support</h3>
<div class="paragraph">
<p>In MongoDB 6.0 and later, you can configure change streams to emit the pre-image state of a document to populate the <code>before</code> field for MongoDB change events.
To enable the use of pre-images in MongoDB, you must set the <code>changeStreamPreAndPostImages</code> for a collection by using <code>db.createCollection()</code>, <code>create</code>, or <code>collMod</code>.
To enable the Debezium MongoDB to include pre-images in change events, set the <code>capture.mode</code> for the connector to one of the <code>*_with_pre_image</code> options.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Size limits on MongoDB change stream events</div>
<div class="paragraph">
<p>The size of a MongoDB change stream event is limited to 16 megabytes.
The use of pre-images thus increases the likelihood of exceeding this threshold, which can lead to failures.
For information about how to avoid exceeding the change stream limit, see the <a href="https://www.mongodb.com/docs/manual/changeStreams/#change-streams-with-document-pre&#8212;&#8203;and-post-images/">MongoDB documentation</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="mongodb-topic-names"><a class="anchor" href="#mongodb-topic-names"></a>Topic names</h3>
<div class="paragraph">
<p>The MongoDB connector writes events for all insert, update, and delete operations to documents in each collection to a single Kafka topic.
The name of the Kafka topics always takes the form <em>logicalName</em>.<em>databaseName</em>.<em>collectionName</em>, where <em>logicalName</em> is the <a href="#mongodb-logical-connector-name">logical name</a> of the connector as specified with the <code>topic.prefix</code> configuration property, <em>databaseName</em> is the name of the database where the operation occurred, and <em>collectionName</em> is the name of the MongoDB collection in which the affected document existed.</p>
</div>
<div class="paragraph">
<p>For example, consider a MongoDB replica set with an <code>inventory</code> database that contains four collections: <code>products</code>, <code>products_on_hand</code>, <code>customers</code>, and <code>orders</code>.
If the connector monitoring this database were given a logical name of <code>fulfillment</code>, then the connector would produce events on these four Kafka topics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>fulfillment.inventory.products</code></p>
</li>
<li>
<p><code>fulfillment.inventory.products_on_hand</code></p>
</li>
<li>
<p><code>fulfillment.inventory.customers</code></p>
</li>
<li>
<p><code>fulfillment.inventory.orders</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Notice that the topic names do not incorporate the replica set name or shard name.
As a result, all changes to a sharded collection (where each shard contains a subset of the collection&#8217;s documents) all go to the same Kafka topic.</p>
</div>
<div class="paragraph">
<p>You can set up Kafka to <a href="https://kafka.apache.org/documentation.html#basic_ops_add_topic">auto-create</a> the topics as they are needed.
If not, then you must use Kafka administration tools to create the topics before starting the connector.</p>
</div>
</div>
<div class="sect2">
<h3 id="mongodb-partitions"><a class="anchor" href="#mongodb-partitions"></a>Partitions</h3>
<div class="paragraph">
<p>The MongoDB connector does not make any explicit determination about how to partition topics for events.
Instead, it allows Kafka to determine how to partition topics based on event keys.
You can change Kafka&#8217;s partitioning logic by defining the name of the <code>Partitioner</code> implementation in the Kafka Connect worker configuration.</p>
</div>
<div class="paragraph">
<p>Kafka maintains total order only for events written to a single topic partition.
Partitioning the events by key does mean that all events with the same key always go to the same partition.
This ensures that all events for a specific document are always totally ordered.</p>
</div>
</div>
<div class="sect2">
<h3 id="mongodb-transaction-metadata"><a class="anchor" href="#mongodb-transaction-metadata"></a>Transaction Metadata</h3>
<div class="paragraph">
<p>Debezium can generate events that represents transaction metadata boundaries and enrich change data event messages.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Limits on when Debezium receives transaction metadata</div>
<div class="paragraph">
<p>Debezium registers and receives metadata only for transactions that occur after you deploy the connector.
Metadata for transactions that occur before you deploy the connector is not available.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For every transaction <code>BEGIN</code> and <code>END</code>, Debezium generates an event that contains the following fields:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>status</code></dt>
<dd>
<p><code>BEGIN</code> or <code>END</code></p>
</dd>
<dt class="hdlist1"><code>id</code></dt>
<dd>
<p>String representation of unique transaction identifier.</p>
</dd>
<dt class="hdlist1"><code>event_count</code> (for <code>END</code> events)</dt>
<dd>
<p>Total number of events emitted by the transaction.</p>
</dd>
<dt class="hdlist1"><code>data_collections</code> (for <code>END</code> events)</dt>
<dd>
<p>An array of pairs of <code>data_collection</code> and <code>event_count</code> that provides number of events emitted by changes originating from given data collection.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The following example shows a typical message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "status": "BEGIN",
  "id": "1462833718356672513",
  "event_count": null,
  "data_collections": null
}

{
  "status": "END",
  "id": "1462833718356672513",
  "event_count": 2,
  "data_collections": [
    {
      "data_collection": "rs0.testDB.collectiona",
      "event_count": 1
    },
    {
      "data_collection": "rs0.testDB.collectionb",
      "event_count": 1
    }
  ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Unless overridden via the <a href="#mongodb-property-topic-transaction"><code>topic.transaction</code></a> option,
transaction events are written to the topic named <a href="#mongodb-property-topic-prefix"><code><em>&lt;topic.prefix&gt;</em></code></a><code>.transaction</code>.</p>
</div>
<div class="paragraph">
<div class="title">Change data event enrichment</div>
<p>When transaction metadata is enabled, the data message <code>Envelope</code> is enriched with a new <code>transaction</code> field.
This field provides information about every event in the form of a composite of fields:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>id</code></dt>
<dd>
<p>String representation of unique transaction identifier.</p>
</dd>
<dt class="hdlist1"><code>total_order</code></dt>
<dd>
<p>The absolute position of the event among all events generated by the transaction.</p>
</dd>
<dt class="hdlist1"><code>data_collection_order</code></dt>
<dd>
<p>The per-data collection position of the event among all events that were emitted by the transaction.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Following is an example of what a message looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "after": "{\"_id\" : {\"$numberLong\" : \"1004\"},\"first_name\" : \"Anne\",\"last_name\" : \"Kretchmar\",\"email\" : \"annek@noanswer.org\"}",
  "source": {
...
  },
  "op": "c",
  "ts_ms": "1580390884335",
  "ts_us": "1580390884335486",
  "ts_ns": "1580390884335486281",
  "transaction": {
    "id": "1462833718356672513",
    "total_order": "1",
    "data_collection_order": "1"
  }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mongodb-events"><a class="anchor" href="#mongodb-events"></a>Data change events</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Debezium MongoDB connector generates a data change event for each document-level operation that inserts, updates, or deletes data. Each event contains a key and a value. The structure of the key and the value depends on the collection that was changed.</p>
</div>
<div class="paragraph">
<p>Debezium and Kafka Connect are designed around <em>continuous streams of event messages</em>. However, the structure of these events may change over time, which can be difficult for consumers to handle. To address this, each event contains the schema for its content or, if you are using a schema registry, a schema ID that a consumer can use to obtain the schema from the registry. This makes each event self-contained.</p>
</div>
<div class="paragraph">
<p>The following skeleton JSON shows the basic four parts of a change event. However, how you configure the Kafka Connect converter that you choose to use in your application determines the representation of these four parts in change events. A <code>schema</code> field is in a change event only when you configure the converter to produce it. Likewise, the event key and event payload are in a change event only if you configure a converter to produce it. If you use the JSON converter and you configure it to produce all four basic change event parts, change events have this structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
 "schema": { <i class="conum" data-value="1"></i><b>(1)</b>
   ...
  },
 "payload": { <i class="conum" data-value="2"></i><b>(2)</b>
   ...
 },
 "schema": { <i class="conum" data-value="3"></i><b>(3)</b>
   ...
 },
 "payload": { <i class="conum" data-value="4"></i><b>(4)</b>
   ...
 },
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 7. Overview of change event basic content</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 20%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Item</th>
<th class="tableblock halign-left valign-top">Field name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>schema</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The first <code>schema</code> field is part of the event key. It specifies a Kafka Connect schema that describes what is in the event key&#8217;s <code>payload</code> portion. In other words, the first <code>schema</code> field describes the structure of the key for the document that was changed.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payload</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The first <code>payload</code> field is part of the event key. It has the structure described by the previous <code>schema</code> field and it contains the key for the document that was changed.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>schema</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The second <code>schema</code> field is part of the event value. It specifies the Kafka Connect schema that describes what is in the event value&#8217;s <code>payload</code> portion. In other words, the second <code>schema</code> describes the structure of the document that was changed. Typically, this schema contains nested schemas.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payload</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The second <code>payload</code> field is part of the event value. It has the structure described by the previous <code>schema</code> field and it contains the actual data for the document that was changed.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>By default, the connector streams change event records to topics with names that are the same as the event&#8217;s originating collection. See <a href="#mongodb-topic-names">topic names</a>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The MongoDB connector ensures that all Kafka Connect schema names adhere to the <a href="http://avro.apache.org/docs/current/spec.html#names">Avro schema name format</a>. This means that the logical server name must start with a Latin letter or an underscore, that is, a-z, A-Z, or _. Each remaining character in the logical server name and each character in the database and collection names must be a Latin letter, a digit, or an underscore, that is, a-z, A-Z, 0-9, or \_. If there is an invalid character it is replaced with an underscore character.</p>
</div>
<div class="paragraph">
<p>This can lead to unexpected conflicts if the logical server name, a database name, or a collection name contains invalid characters, and the only characters that distinguish names from one another are invalid and thus replaced with underscores.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="mongodb-change-events-key"><a class="anchor" href="#mongodb-change-events-key"></a>Change event keys</h3>
<div class="paragraph">
<p>A change event&#8217;s key contains the schema for the changed document&#8217;s key and the changed document&#8217;s actual key. For a given collection, both the schema and its corresponding payload contain a single <code>id</code> field.
The value of this field is the document&#8217;s identifier represented as a string that is derived from <a href="https://docs.mongodb.com/manual/reference/mongodb-extended-json/">MongoDB extended JSON serialization strict mode</a>.</p>
</div>
<div class="paragraph">
<p>Consider a connector with a logical name of <code>fulfillment</code>, a replica set containing an <code>inventory</code> database, and a <code>customers</code> collection that contains documents such as the following.</p>
</div>
<div class="listingblock">
<div class="title">Example document</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "_id": 1004,
  "first_name": "Anne",
  "last_name": "Kretchmar",
  "email": "annek@noanswer.org"
}</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Example change event key</div>
<p>Every change event that captures a change to the <code>customers</code> collection has the same event key schema. For as long as the <code>customers</code> collection has the previous definition, every change event that captures a change to the <code>customers</code> collection has the following key structure. In JSON, it looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "schema": { <i class="conum" data-value="1"></i><b>(1)</b>
    "type": "struct",
    "name": "fulfillment.inventory.customers.Key", <i class="conum" data-value="2"></i><b>(2)</b>
    "optional": false, <i class="conum" data-value="3"></i><b>(3)</b>
    "fields": [ <i class="conum" data-value="4"></i><b>(4)</b>
      {
        "field": "id",
        "type": "string",
        "optional": false
      }
    ]
  },
  "payload": { <i class="conum" data-value="5"></i><b>(5)</b>
    "id": "1004"
  }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 8. Description of change event key</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 20%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Item</th>
<th class="tableblock halign-left valign-top">Field name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>schema</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The schema portion of the key specifies a Kafka Connect schema that describes what is in the key&#8217;s <code>payload</code> portion.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fulfillment.inventory.customers.Key</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Name of the schema that defines the structure of the key&#8217;s payload. This schema describes the structure of the key for the document that was changed. Key schema names have the format <em>connector-name</em>.<em>database-name</em>.<em>collection-name</em>.<code>Key</code>. In this example:<br></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>fulfillment</code> is the name of the connector that generated this event.<br></p>
</li>
<li>
<p><code>inventory</code> is the database that contains the collection that was changed.<br></p>
</li>
<li>
<p><code>customers</code> is the collection that contains the document that was updated.</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>optional</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates whether the event key must contain a value in its <code>payload</code> field. In this example, a value in the key&#8217;s payload is required. A value in the key&#8217;s payload field is optional when a document does not have a key.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fields</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies each field that is expected in the <code>payload</code>, including each field&#8217;s name, type, and whether it is required.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payload</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contains the key for the document for which this change event was generated. In this example, the key contains a single <code>id</code> field of type <code>string</code> whose value is <code>1004</code>.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>This example uses a document with an integer identifier, but any valid MongoDB document identifier works the same way, including a document identifier. For a document identifier, an event key&#8217;s <code>payload.id</code> value is a string that represents the updated document&#8217;s original <code>_id</code> field as a MongoDB extended JSON serialization that uses strict mode. The following table provides examples of how different types of <code>_id</code> fields are represented.</p>
</div>
<table class="tableblock frame-all grid-all stretch code-wordbreak-col2 code-wordbreak-col3">
<caption class="title">Table 9. Examples of representing document <code>_id</code> fields in event key payloads</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">MongoDB <code>_id</code> Value</th>
<th class="tableblock halign-left valign-top">Key&#8217;s payload</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1234</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{ "id" : "1234" }</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Float</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">12.34</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{ "id" : "12.34" }</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"1234"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{ "id" : "\"1234\"" }</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Document</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{ "hi" : "kafka", "nums" : [10.0, 100.0, 1000.0] }</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{ "id" : "{\"hi\" : \"kafka\", \"nums\" : [10.0, 100.0, 1000.0]}" }</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ObjectId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ObjectId("596e275826f08b2730779e1f")</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{ "id" : "{\"$oid\" : \"596e275826f08b2730779e1f\"}" }</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Binary</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BinData("a2Fma2E=",0)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{ "id" : "{\"$binary\" : \"a2Fma2E=\", \"$type\" : \"00\"}" }</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="mongodb-change-events-value"><a class="anchor" href="#mongodb-change-events-value"></a>Change event values</h3>
<div class="paragraph">
<p>The value in a change event is a bit more complicated than the key. Like the key, the value has a <code>schema</code> section and a <code>payload</code> section. The <code>schema</code> section contains the schema that describes the <code>Envelope</code> structure of the <code>payload</code> section, including its nested fields. Change events for operations that create, update or delete data all have a value payload with an envelope structure.</p>
</div>
<div class="paragraph">
<p>Consider the same sample document that was used to show an example of a change event key:</p>
</div>
<div class="listingblock">
<div class="title">Example document</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "_id": 1004,
  "first_name": "Anne",
  "last_name": "Kretchmar",
  "email": "annek@noanswer.org"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The value portion of a change event for a change to this document is described for each event type:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#mongodb-create-events"><em>create</em> events</a></p>
</li>
<li>
<p><a href="#mongodb-update-events"><em>update</em> events</a></p>
</li>
<li>
<p><a href="#mongodb-delete-events"><em>delete</em> events</a></p>
</li>
<li>
<p><a href="#mongodb-tombstone-events">Tombstone events</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="mongodb-create-events"><a class="anchor" href="#mongodb-create-events"></a><em>create</em> events</h3>
<div class="paragraph">
<p>The following example shows the value portion of a change event that the connector generates for an operation that creates data in the <code>customers</code> collection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-json hljs" data-lang="json">{
    "schema": { <i class="conum" data-value="1"></i><b>(1)</b>
      "type": "struct",
      "fields": [
        {
          "type": "string",
          "optional": true,
          "name": "io.debezium.data.Json", <i class="conum" data-value="2"></i><b>(2)</b>
          "version": 1,
          "field": "after"
        },
        {
          "type": "string",
          "optional": true,
          "name": "io.debezium.data.Json",
          "version": 1,
          "field": "patch"
        },
        {
          "type": "struct",
          "fields": [
            {
              "type": "string",
              "optional": false,
              "field": "version"
            },
            {
              "type": "string",
              "optional": false,
              "field": "connector"
            },
            {
              "type": "string",
              "optional": false,
              "field": "name"
            },
            {
              "type": "int64",
              "optional": false,
              "field": "ts_ms"
            },
            {
              "type": "int64",
              "optional": false,
              "field": "ts_us"
            },
            {
              "type": "int64",
              "optional": false,
              "field": "ts_ns"
            },
            {
              "type": "boolean",
              "optional": true,
              "default": false,
              "field": "snapshot"
            },
            {
              "type": "string",
              "optional": false,
              "field": "db"
            },
            {
              "type": "string",
              "optional": false,
              "field": "rs"
            },
            {
              "type": "string",
              "optional": false,
              "field": "collection"
            },
            {
              "type": "int32",
              "optional": false,
              "field": "ord"
            },
            {
              "type": "int64",
              "optional": true,
              "field": "h"
            }
          ],
          "optional": false,
          "name": "io.debezium.connector.mongo.Source", <i class="conum" data-value="3"></i><b>(3)</b>
          "field": "source"
        },
        {
          "type": "string",
          "optional": true,
          "field": "op"
        },
        {
          "type": "int64",
          "optional": true,
          "field": "ts_ms"
        },
        {
          "type": "int64",
          "optional": true,
          "field": "ts_us"
        },
        {
          "type": "int64",
          "optional": true,
          "field": "ts_ns"
        }
      ],
      "optional": false,
      "name": "dbserver1.inventory.customers.Envelope" <i class="conum" data-value="4"></i><b>(4)</b>
      },
    "payload": { <i class="conum" data-value="5"></i><b>(5)</b>
      "after": "{\"_id\" : {\"$numberLong\" : \"1004\"},\"first_name\" : \"Anne\",\"last_name\" : \"Kretchmar\",\"email\" : \"annek@noanswer.org\"}", <i class="conum" data-value="6"></i><b>(6)</b>
      "source": { <i class="conum" data-value="7"></i><b>(7)</b>
        "version": "3.0.0.Beta1",
        "connector": "mongodb",
        "name": "fulfillment",
        "ts_ms": 1558965508000,
        "ts_ms": 1558965508000000,
        "ts_ms": 1558965508000000000,
        "snapshot": false,
        "db": "inventory",
        "rs": "rs0",
        "collection": "customers",
        "ord": 31,
        "h": 1546547425148721999
      },
      "op": "c", <i class="conum" data-value="8"></i><b>(8)</b>
      "ts_ms": 1558965515240, <i class="conum" data-value="9"></i><b>(9)</b>
      "ts_us": 1558965515240142, <i class="conum" data-value="10"></i><b>(10)</b>
      "ts_ns": 1558965515240142879, <i class="conum" data-value="11"></i><b>(11)</b>
    }
  }</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 10. Descriptions of <em>create</em> event value fields</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 20%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Item</th>
<th class="tableblock halign-left valign-top">Field name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>schema</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The value&#8217;s schema, which describes the structure of the value&#8217;s payload. A change event&#8217;s value schema is the same in every change event that the connector generates for a particular collection.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>name</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>In the <code>schema</code> section, each <code>name</code> field specifies the schema for a field in the value&#8217;s payload.<br>
<br>
<code>io.debezium.data.Json</code> is the schema for the payload&#8217;s <code>after</code>, <code>patch</code>, and <code>filter</code> fields. This schema is specific to the <code>customers</code> collection. A <em>create</em> event is the only kind of event that contains an <code>after</code> field. An <em>update</em> event contains a <code>filter</code> field and a <code>patch</code> field. A <em>delete</em> event contains a <code>filter</code> field, but not an <code>after</code> field nor a <code>patch</code> field.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>name</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>io.debezium.connector.mongo.Source</code> is the schema for the payload&#8217;s <code>source</code> field. This schema is specific to the MongoDB connector. The connector uses it for all events that it generates.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>name</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>dbserver1.inventory.customers.Envelope</code> is the schema for the overall structure of the payload, where <code>dbserver1</code> is the connector name, <code>inventory</code> is the database, and <code>customers</code> is the collection. This schema is specific to the collection.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payload</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The value&#8217;s actual data. This is the information that the change event is providing.<br>
<br>
It may appear that the JSON representations of the events are much larger than the documents they describe. This is because the JSON representation must include the schema and the payload portions of the message.
However, by using the <a href="../configuration/avro.html#avro-serialization" class="xref page">Avro converter</a>, you can significantly decrease the size of the messages that the connector streams to Kafka topics.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>after</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An optional field that specifies the state of the document after the event occurred.
In this example, the <code>after</code> field contains the values of the new document&#8217;s <code>_id</code>, <code>first_name</code>, <code>last_name</code>, and <code>email</code> fields.
The <code>after</code> value is always a string.
By convention, it contains a JSON representation of the document.
MongoDB oplog entries contain the full state of a document only for _create_ events and also for <code>update</code> events, when the <code>capture.mode</code> option is set to <code>change_streams_update_full</code>;
in other words, a <em>create</em> event is the only kind of event that contains an <em>after</em> field regardless of <code>capture.mode</code> option.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>source</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Mandatory field that describes the source metadata for the event. This field contains information that you can use to compare this event with other events, with regard to the origin of the events, the order in which the events occurred, and whether events were part of the same transaction. The source metadata includes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Debezium version.</p>
</li>
<li>
<p>Name of the connector that generated the event.</p>
</li>
<li>
<p>Logical name of the MongoDB replica set, which forms a namespace for generated events and is used in Kafka topic names to which the connector writes.</p>
</li>
<li>
<p>Names of the collection and database that contain the new document.</p>
</li>
<li>
<p>If the event was part of a snapshot.</p>
</li>
<li>
<p>Timestamp for when the change was made in the database and ordinal of the event within the timestamp.</p>
</li>
<li>
<p>Unique identifier of the MongoDB operation (the <code>h</code> field in the oplog event).</p>
</li>
<li>
<p>Unique identifiers of the MongoDB session <code>lsid</code> and transaction number <code>txnNumber</code> in case the change was executed inside a transaction (change streams capture mode only).</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>op</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Mandatory string that describes the type of operation that caused the connector to generate the event. In this example, <code>c</code> indicates that the operation created a document. Valid values are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>c</code> = create</p>
</li>
<li>
<p><code>u</code> = update</p>
</li>
<li>
<p><code>d</code> = delete</p>
</li>
<li>
<p><code>r</code> = read (applies to only snapshots)</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">9</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ts_ms</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Optional field that displays the time at which the connector processed the event.
The time is based on the system clock in the JVM running the Kafka Connect task. <br>
<br>
In the <code>source</code> object, <code>ts_ms</code> indicates the time that the change was made in the database. By comparing the value for <code>payload.source.ts_ms</code> with the value for <code>payload.ts_ms</code>, you can determine the lag between the source database update and Debezium.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ts_us</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Optional field that displays the time at which the connector processed the event, in microseconds.
The time is based on the system clock in the JVM running the Kafka Connect task.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">9</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ts_ns</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Optional field that displays the time at which the connector processed the event, in nanoseconds.
The time is based on the system clock in the JVM running the Kafka Connect task.</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="mongodb-update-events"><a class="anchor" href="#mongodb-update-events"></a><em>update</em> events</h3>
<div class="sect3">
<h4 id="_change_streams_capture_mode"><a class="anchor" href="#_change_streams_capture_mode"></a>Change streams capture mode</h4>
<div class="paragraph">
<p>The value of a change event for an update in the sample <code>customers</code> collection has the same schema as a <em>create</em> event for that collection.
Likewise, the event value&#8217;s payload has the same structure.
However, the event value payload contains different values in an <em>update</em> event.
An <em>update</em> event includes an <code>after</code> value only if the <code>capture.mode</code> option is set to <code>change_streams_update_full</code>.
A <code>before</code> value is provided if the <code>capture.mode</code> option is set to one of the <code>*_with_pre_image</code> option.
There is a new structured field <code>updateDescription</code> with a few additional fields in this case:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>updatedFields</code> is a string field that contains the JSON representation of the updated document fields with their values</p>
</li>
<li>
<p><code>removedFields</code> is a list of field names that were removed from the document</p>
</li>
<li>
<p><code>truncatedArrays</code> is a list of arrays in the document that were truncated</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here is an example of a change event value in an event that the connector generates for an update in the <code>customers</code> collection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-json hljs" data-lang="json">{
    "schema": { ... },
    "payload": {
      "op": "u", <i class="conum" data-value="1"></i><b>(1)</b>
      "ts_ms": 1465491461815, <i class="conum" data-value="2"></i><b>(2)</b>
      "ts_us": 1465491461815698, <i class="conum" data-value="2"></i><b>(2)</b>
      "ts_ns": 1465491461815698142, <i class="conum" data-value="2"></i><b>(2)</b>
      "before":"{\"_id\": {\"$numberLong\": \"1004\"},\"first_name\": \"unknown\",\"last_name\": \"Kretchmar\",\"email\": \"annek@noanswer.org\"}", <i class="conum" data-value="3"></i><b>(3)</b>
      "after":"{\"_id\": {\"$numberLong\": \"1004\"},\"first_name\": \"Anne Marie\",\"last_name\": \"Kretchmar\",\"email\": \"annek@noanswer.org\"}", <i class="conum" data-value="4"></i><b>(4)</b>
      "updateDescription": {
        "removedFields": null,
        "updatedFields": "{\"first_name\": \"Anne Marie\"}", <i class="conum" data-value="5"></i><b>(5)</b>
        "truncatedArrays": null
      },
      "source": { <i class="conum" data-value="6"></i><b>(6)</b>
        "version": "3.0.0.Beta1",
        "connector": "mongodb",
        "name": "fulfillment",
        "ts_ms": 1558965508000,
        "ts_us": 1558965508000000,
        "ts_ns": 1558965508000000000,
        "snapshot": false,
        "db": "inventory",
        "rs": "rs0",
        "collection": "customers",
        "ord": 1,
        "h": null,
        "tord": null,
        "stxnid": null,
        "lsid":"{\"id\": {\"$binary\": \"FA7YEzXgQXSX9OxmzllH2w==\",\"$type\": \"04\"},\"uid\": {\"$binary\": \"47DEQpj8HBSa+/TImW+5JCeuQeRkm5NMpJWZG3hSuFU=\",\"$type\": \"00\"}}",
        "txnNumber":1
      }
    }
  }</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 11. Descriptions of <em>update</em> event value fields</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 20%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Item</th>
<th class="tableblock halign-left valign-top">Field name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>op</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Mandatory string that describes the type of operation that caused the connector to generate the event. In this example, <code>u</code> indicates that the operation updated a document.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ts_ms</code>, <code>ts_us</code>, <code>ts_ns</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Optional field that displays the time at which the connector processed the event.
The time is based on the system clock in the JVM running the Kafka Connect task. <br>
<br>
In the <code>source</code> object, <code>ts_ms</code> indicates the time that the change was made in the database. By comparing the value for <code>payload.source.ts_ms</code> with the value for <code>payload.ts_ms</code>, you can determine the lag between the source database update and Debezium.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>before</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contains the JSON string representation of the actual MongoDB document before change.
+
An <em>update</em> event value does not contain an <code>before</code> field if the capture mode is not set to one of the <code>*_with_preimage</code> options.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>after</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contains the JSON string representation of the actual MongoDB document.
<br>
An <em>update</em> event value does not contain an <code>after</code> field if the capture mode is not set to <code>change_streams_update_full</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>updatedFields</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contains the JSON string representation of the updated field values of the document. In this example, the update changed the <code>first_name</code> field to a new value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>source</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Mandatory field that describes the source metadata for the event. This field contains the same information as a <em>create</em> event for the same collection, but the values are different since this event is from a different position in the oplog. The source metadata includes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Debezium version.</p>
</li>
<li>
<p>Name of the connector that generated the event.</p>
</li>
<li>
<p>Logical name of the MongoDB replica set, which forms a namespace for generated events and is used in Kafka topic names to which the connector writes.</p>
</li>
<li>
<p>Names of the collection and database that contain the updated document.</p>
</li>
<li>
<p>If the event was part of a snapshot.</p>
</li>
<li>
<p>Timestamp for when the change was made in the database and ordinal of the event within the timestamp.</p>
</li>
<li>
<p>Unique identifiers of the MongoDB session <code>lsid</code> and transaction number <code>txnNumber</code> in case the change was executed inside a transaction.</p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>after</code> value in the event should be handled as the at-point-of-time value of the document.
The value is not calculated dynamically but is obtained from the collection.
It is thus possible if multiple updates are closely following one after the other, that all <em>update</em> updates events will contain the same <code>after</code> value which will be representing the last value stored in the document.</p>
</div>
<div class="paragraph">
<p>If your application depends on gradual change evolution then you should rely on <code>updateDescription</code> only.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongodb-delete-events"><a class="anchor" href="#mongodb-delete-events"></a><em>delete</em> events</h3>
<div class="paragraph">
<p>The value in a <em>delete</em> change event has the same <code>schema</code> portion as <em>create</em> and <em>update</em> events for the same collection. The <code>payload</code> portion in a <em>delete</em> event contains values that are different from <em>create</em> and <em>update</em> events for the same collection. In particular, a <em>delete</em> event contains neither an <code>after</code> value nor a <code>updateDescription</code> value. Here is an example of a <em>delete</em> event for a document in the <code>customers</code> collection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "schema": { ... },
    "payload": {
      "op": "d", <i class="conum" data-value="1"></i><b>(1)</b>
      "ts_ms": 1465495462115, <i class="conum" data-value="2"></i><b>(2)</b>
      "ts_us": 1465495462115748, <i class="conum" data-value="2"></i><b>(2)</b>
      "ts_ns": 1465495462115748263, <i class="conum" data-value="2"></i><b>(2)</b>
      "before":"{\"_id\": {\"$numberLong\": \"1004\"},\"first_name\": \"Anne Marie\",\"last_name\": \"Kretchmar\",\"email\": \"annek@noanswer.org\"}",<i class="conum" data-value="3"></i><b>(3)</b>
      "source": { <i class="conum" data-value="4"></i><b>(4)</b>
        "version": "3.0.0.Beta1",
        "connector": "mongodb",
        "name": "fulfillment",
        "ts_ms": 1558965508000,
        "ts_us": 1558965508000000,
        "ts_ns": 1558965508000000000,
        "snapshot": true,
        "db": "inventory",
        "rs": "rs0",
        "collection": "customers",
        "ord": 6,
        "h": 1546547425148721999
      }
    }
  }</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 12. Descriptions of <em>delete</em> event value fields</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 20%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Item</th>
<th class="tableblock halign-left valign-top">Field name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>op</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Mandatory string that describes the type of operation. The <code>op</code> field value is <code>d</code>, signifying that this document was deleted.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ts_ms</code>, <code>ts_us</code>. <code>ts_ns</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Optional field that displays the time at which the connector processed the event.
The time is based on the system clock in the JVM running the Kafka Connect task. <br>
<br>
In the <code>source</code> object, <code>ts_ms</code> indicates the time that the change was made in the database. By comparing the value for <code>payload.source.ts_ms</code> with the value for <code>payload.ts_ms</code>, you can determine the lag between the source database update and Debezium.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>before</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contains the JSON string representation of the actual MongoDB document before change.
+
An <em>update</em> event value does not contain an <code>before</code> field if the capture mode is not set to one of the <code>*_with_preimage</code> options.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>source</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Mandatory field that describes the source metadata for the event. This field contains the same information as a <em>create</em> or <em>update</em> event for the same collection, but the values are different since this event is from a different position in the oplog. The source metadata includes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Debezium version.</p>
</li>
<li>
<p>Name of the connector that generated the event.</p>
</li>
<li>
<p>Logical name of the MongoDB replica set, which forms a namespace for generated events and is used in Kafka topic names to which the connector writes.</p>
</li>
<li>
<p>Names of the collection and database that contained the deleted document.</p>
</li>
<li>
<p>If the event was part of a snapshot.</p>
</li>
<li>
<p>Timestamp for when the change was made in the database and ordinal of the event within the timestamp.</p>
</li>
<li>
<p>Unique identifier of the MongoDB operation (the <code>h</code> field in the oplog event).</p>
</li>
<li>
<p>Unique identifiers of the MongoDB session <code>lsid</code> and transaction number <code>txnNumber</code> in case the change was executed inside a transaction (change streams capture mode only).</p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>MongoDB connector events are designed to work with <a href="https://kafka.apache.org/documentation/#compaction">Kafka log compaction</a>. Log compaction enables removal of some older messages as long as at least the most recent message for every key is kept. This lets Kafka reclaim storage space while ensuring that the topic contains a complete data set and can be used for reloading key-based state.</p>
</div>
</div>
<div class="sect2">
<h3 id="mongodb-tombstone-events"><a class="anchor" href="#mongodb-tombstone-events"></a>Tombstone events</h3>
<div class="paragraph">
<p>All MongoDB connector events for a uniquely identified document have exactly the same key. When a document is deleted, the <em>delete</em> event value still works with log compaction because Kafka can remove all earlier messages that have that same key. However, for Kafka to remove all messages that have that key, the message value must be <code>null</code>. To make this possible, after Debezium’s MongoDB connector emits a <em>delete</em> event, the connector emits a special tombstone event that has the same key but a <code>null</code> value. A tombstone event informs Kafka that all messages with that same key can be removed.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="setting-up-mongodb"><a class="anchor" href="#setting-up-mongodb"></a>Setting up MongoDB</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The MongoDB connector uses MongoDB&#8217;s change streams to capture the changes, so the connector works only with MongoDB replica sets or with sharded clusters where each shard is a separate replica set.
See the MongoDB documentation for setting up a <a href="https://docs.mongodb.com/manual/replication/">replica set</a> or <a href="https://docs.mongodb.com/manual/sharding/">sharded cluster</a>.
Also, be sure to understand how to enable <a href="https://docs.mongodb.com/manual/tutorial/deploy-replica-set-with-keyfile-access-control/#deploy-repl-set-with-auth">access control and authentication</a> with replica sets.</p>
</div>
<div class="paragraph">
<p>You must also have a MongoDB user that has the appropriate roles to read the <code>admin</code> database where the oplog can be read. Additionally, the user must also be able to read the <code>config</code> database in the configuration server of a sharded cluster and must have <code>listDatabases</code> privilege action.
When change streams are used (the default) the user also must have cluster-wide privilege actions <code>find</code> and <code>changeStream</code>.</p>
</div>
<div class="paragraph">
<p>When you intend to utilize pre-image and populate the <code>before</code> field, you need to first enable <code>changeStreamPreAndPostImages</code> for a collection using <code>db.createCollection()</code>, <code>create</code>, or <code>collMod</code>.</p>
</div>
<div class="sect2">
<h3 id="mongodb-in-the-cloud"><a class="anchor" href="#mongodb-in-the-cloud"></a>MongoDB in the Cloud</h3>
<div class="paragraph">
<p>You can use the Debezium connector for MongoDB with <a href="https://www.mongodb.com/atlas/database">MongoDB Atlas</a>.
Note that MongoDB Atlas only supports secure connections via SSL, i.e. the <a href="#mongodb-property-mongodb-ssl-enabled"><code>+mongodb.ssl.enabled</code></a> connector option <em>must</em> be set to <code>true</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="mongodb-optimal-oplog-config"><a class="anchor" href="#mongodb-optimal-oplog-config"></a>Optimal Oplog Config</h3>
<div class="paragraph">
<p>The Debezium MongoDB connector reads <a href="https://www.mongodb.com/docs/manual/changeStreams/">change streams</a> to obtain oplog data for a replica set.
Because the oplog is a fixed-sized, capped collection, if it exceeds its maximum configured size, it begins to overwrite its oldest entries.
If the connector is stopped for any reason, when it restarts, it attempts to resume streaming from the last oplog stream position.
However, if last stream position was removed from the oplog, depending on the value specified in the connector&#8217;s <a href="#mongodb-property-snapshot-mode"><code>snapshot.mode</code></a> property, the connector might fail to start, reporting an <a href="#connector-error-invalid-resume-token">invalid resume token error</a>.
In the event of a failure, you must create a new connector to enable Debezium to continue capturing records from the database.
For more information, see <a href="#debezium-mongodb-connector-is-stopped-for-a-long-interval">Connector fails after it is stopped for a long interval if snapshot.mode is set to initial</a>.</p>
</div>
<div class="paragraph">
<p>To ensure that the oplog retains the offset values that Debezium requires to resume streaming, you can use either of the following approaches:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.mongodb.com/docs/manual/core/replica-set-oplog/">Increase the size of the oplog</a>.
Based on your typical workloads, set the oplog size to a value that is greater than the peak number of oplog entries per hour.</p>
</li>
<li>
<p><a href="https://www.mongodb.com/docs/manual/core/replica-set-oplog/#std-label-replica-set-minimum-oplog-size/">Increase the minimum number of hours that an oplog entry is retained</a> (MongoDB 4.4 and greater).
This setting is time-based, such that entries in the last <em>n</em> hours are guaranteed to be available even if the oplog reaches its maximum configured size.
Although this is generally the preferred option, for clusters with high workloads that are nearing capacity, specify the maximum oplog size.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To help prevent failures that are related to missing oplog entries, it&#8217;s important to track metrics that report replication behavior, and to optimize the oplog size to support Debezium.
In particular, you should monitor the values of Oplog GB/Hour and Replication Oplog Window.
If Debezium is offline for an interval that exceeds the value of the replication oplog window, and the primary oplog grows faster than Debezium can consume entries, a connector failure can result.</p>
</div>
<div class="paragraph">
<p>For information about how to monitor these metrics, see <a href="https://www.mongodb.com/basics/how-to-monitor-mongodb-and-what-metrics-to-monitor#mongodb-replication-metrics">the MongoDB documentation</a>.</p>
</div>
<div class="paragraph">
<p>It&#8217;s best to set the maximum oplog size to a value that is based on the anticipated hourly growth of the oplog (<a href="https://www.mongodb.com/basics/how-to-monitor-mongodb-and-what-metrics-to-monitor#oplog-gbhour">Oplog GB/Hour</a>), multiplied by the time that might be required to address a Debezium failure.</p>
</div>
<div class="paragraph">
<p>That is,</p>
</div>
<div class="paragraph">
<p><code><em>Oplog GB/Hour</em></code> X  <code><em>average reaction time to Debezium failure</em></code></p>
</div>
<div class="paragraph">
<p>For example, if the oplog size limit is set to 1GB, and the oplog grows by 3GB per hour, oplog entries are cleared three times per hour.
If Debezium were to fail during this time, its last oplog position is likely to be removed.</p>
</div>
<div class="paragraph">
<p>If the oplog grows at the rate of 3GB/hour, and Debezium is offline for two hours, you would thus set the oplog size to 3GB/hour X 2 hours, or 6GB.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mongodb-deploying-a-connector"><a class="anchor" href="#mongodb-deploying-a-connector"></a>Deployment</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To deploy a Debezium MongoDB connector, you install the Debezium MongoDB connector archive, configure the connector, and start the connector by adding its configuration to Kafka Connect.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="https://zookeeper.apache.org/">Apache Zookeeper</a>, <a href="http://kafka.apache.org/">Apache Kafka</a>, and <a href="https://kafka.apache.org/documentation.html#connect">Kafka Connect</a> are installed.</p>
</li>
<li>
<p>MongoDB is installed and is <a href="#setting-up-mongodb">set up to work with the Debezium connector</a>.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Download the
<a href="https://s01.oss.sonatype.org/service/local/artifact/maven/redirect?r=snapshots&g=io.debezium&a=debezium-connector-mongodb&v=LATEST&c=plugin&e=tar.gz">connector&#8217;s plug-in archive</a>,</p>
</li>
<li>
<p>Extract the JAR files into your Kafka Connect environment.</p>
</li>
<li>
<p>Add the directory with the JAR files to <a href="https://kafka.apache.org/documentation/#connectconfigs">Kafka Connect&#8217;s <code>plugin.path</code></a>.</p>
</li>
<li>
<p>Restart your Kafka Connect process to pick up the new JAR files.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If you are working with immutable containers, see <a href="https://quay.io/organization/debezium">Debezium&#8217;s Container images</a> for Apache Zookeeper, Apache Kafka, and Kafka Connect with the MongoDB connector already installed and ready to run.</p>
</div>
<div class="paragraph">
<p>You can also <a href="../operations/openshift.html" class="xref page">run Debezium on Kubernetes and OpenShift</a>.</p>
</div>
<div class="paragraph">
<p>The Debezium <a href="../tutorial.html" class="xref page">tutorial</a> walks you through using these images, and this is a great way to learn about Debezium.</p>
</div>
<div class="sect2">
<h3 id="mongodb-example-configuration"><a class="anchor" href="#mongodb-example-configuration"></a>MongoDB connector configuration example</h3>
<div class="paragraph">
<p>Following is an example of the configuration for a connector instance that captures data from a MongoDB replica set <code>rs0</code> at port 27017 on 192.168.99.100, which we logically name <code>fullfillment</code>.
Typically, you configure the Debezium MongoDB connector in a JSON file by setting the configuration properties that are available for the connector.</p>
</div>
<div class="paragraph">
<p>You can choose to produce events for a particular MongoDB replica set or sharded cluster.
Optionally, you can filter out collections that are not needed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "name": "inventory-connector", <i class="conum" data-value="1"></i><b>(1)</b>
  "config": {
    "connector.class": "io.debezium.connector.mongodb.MongoDbConnector", <i class="conum" data-value="2"></i><b>(2)</b>
    "mongodb.connection.string": "mongodb://192.168.99.100:27017/?replicaSet=rs0", <i class="conum" data-value="3"></i><b>(3)</b>
    "topic.prefix": "fullfillment", <i class="conum" data-value="4"></i><b>(4)</b>
    "collection.include.list": "inventory[.]*" <i class="conum" data-value="5"></i><b>(5)</b>
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The name of our connector when we register it with a Kafka Connect service.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The name of the MongoDB connector class.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The connection string to use to connect to the MongoDB replica set.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <em>logical name</em> of the MongoDB replica set, which forms a namespace for generated events and is used in all the names of the Kafka topics to which the connector writes, the Kafka Connect schema names, and the namespaces of the corresponding Avro schema when the Avro converter is used.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>A list of regular expressions that match the collection namespaces (for example, &lt;dbName&gt;.&lt;collectionName&gt;) of all collections to be monitored. This is optional.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For the complete list of the configuration properties that you can set for the Debezium MongoDB connector,
see <a href="#mongodb-connector-properties">MongoDB connector configuration properties</a>.</p>
</div>
<div class="paragraph">
<p>You can send this configuration with a <code>POST</code> command to a running Kafka Connect service.
The service records the configuration and starts one connector task that performs the following actions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Connects to the MongoDB replica set or sharded cluster.</p>
</li>
<li>
<p>Assigns tasks for each replica set.</p>
</li>
<li>
<p>Performs a snapshot, if necessary.</p>
</li>
<li>
<p>Reads the change stream.</p>
</li>
<li>
<p>Streams change event records to Kafka topics.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="mongodb-adding-connector-configuration"><a class="anchor" href="#mongodb-adding-connector-configuration"></a>Adding connector configuration</h3>
<div class="paragraph">
<p>To start running a Debezium MongoDB connector, create a connector configuration, and add the configuration to your Kafka Connect cluster.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#setting-up-mongodb">MongoDB is set up to work with a Debezium connector</a>.</p>
</li>
<li>
<p>The Debezium MongoDB connector is installed.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a configuration for the MongoDB connector.</p>
</li>
<li>
<p>Use the <a href="https://kafka.apache.org/documentation/#connect_rest">Kafka Connect REST API</a> to add that connector configuration to your Kafka Connect cluster.</p>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Results</div>
<p>After the connector starts, it completes the following actions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#mongodb-performing-a-snapshot">Performs a consistent snapshot</a> of the collections in your MongoDB replica sets.</p>
</li>
<li>
<p>Reads the change streams for the replica sets.</p>
</li>
<li>
<p>Produces change events for every inserted, updated, and deleted document.</p>
</li>
<li>
<p>Streams change event records to Kafka topics.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="mongodb-connector-properties"><a class="anchor" href="#mongodb-connector-properties"></a>Connector properties</h3>
<div class="paragraph">
<p>The Debezium MongoDB connector has numerous configuration properties that you can use to achieve the right connector behavior for your application.
Many properties have default values. Information about the properties is organized as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#debezium-mongodb-connector-required-configuration-properties">Required Debezium MongoDB connector configuration properties</a></p>
</li>
<li>
<p><a href="#debezium-mongodb-connector-advanced-configuration-properties">Advanced Debezium MongoDB connector configuration properties</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following configuration properties are <em>required</em> unless a default value is available.</p>
</div>
<table id="debezium-mongodb-connector-required-configuration-properties" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 13. Required Debezium MongoDB connector configuration properties</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 25%;">
<col style="width: 45%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-allow-offset-invalidation"></a><a href="#mongodb-property-allow-offset-invalidation"><code>internal.mongodb.allow.offset.invalidation</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>false</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Set this property to <code>true</code> to enable the connector to invalidate and <a href="#mongodb-offset-consolidation">consolidate</a> shard-specific offsets that were recorded by earlier connector versions.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This property permits you to modify the current default behavior.
The property is subject to removal in a future release if the default behavior changes to permit the connector to automatically invalidate and consolidate offsets that are recorded by earlier connector versions.</p>
</div>
</td>
</tr>
</table>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-name"></a><a href="#mongodb-property-name"><code>name</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>No default</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Unique name for the connector. Attempting to register again with the same name will fail. (This property is required by all Kafka Connect connectors.)</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-connector-class"></a><a href="#mongodb-property-connector-class"><code>connector.class</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>No default</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The name of the Java class for the connector. Always use a value of <code>io.debezium.connector.mongodb.MongoDbConnector</code> for the MongoDB connector.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-mongodb-connection-string"></a><a href="#mongodb-property-mongodb-connection-string"><code>mongodb.connection.string</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>No default</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Specifies a <a href="https://www.mongodb.com/docs/manual/reference/connection-string/">connection string</a> that the connector uses to connect to a MongoDB replica set.
This property replaces the <code>mongodb.hosts</code> property that was available in previous versions of the MongoDB connector.<br></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-topic-prefix"></a><a href="#mongodb-property-topic-prefix"><code>topic.prefix</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>No default</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>A unique name that identifies the connector and/or MongoDB replica set or sharded cluster that this connector monitors.
Each server should be monitored by at most one Debezium connector, since this server name prefixes all persisted Kafka topics emanating from the MongoDB replica set or cluster.
Use only alphanumeric characters, hyphens, dots and underscores to form the name.
The logical name should be unique across all other connectors, because the name is used as the prefix in naming the Kafka topics that receive records from this connector.<br>
<br></p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do not change the value of this property.
If you change the name value, after a restart, instead of continuing to emit events to the original topics, the connector emits subsequent events to topics whose names are based on the new value.</p>
</div>
</td>
</tr>
</table>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-mongodb-authentication-class"></a><a href="#mongodb-property-mongodb-authentication-class"><code>mongodb.authentication.class</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><em>DefaultMongoDbAuthProvider</em></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>A full Java class name that is an implementation of the io.debezium.connector.mongodb.connection.MongoDbAuthProvider interface.
This class handles setting the credentials on the MongoDB connection (called on each app boot).
Default behavior uses the <a href="#mongodb-property-mongodb-user"><code>mongodb.user</code></a>, <a href="#mongodb-property-mongodb-password"><code>mongodb.password</code></a>, and <a href="#mongodb-property-mongodb-authsource"><code>mongodb.authsource</code></a> properties according to each of their documentation,
but other implementations may use them differently or ignore them altogether.
Note that any setting in <a href="#mongodb-property-mongodb-connection-string"><code>mongodb.connection.string</code></a> will override settings set by this class</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-mongodb-user"></a><a href="#mongodb-property-mongodb-user"><code>mongodb.user</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>No default</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>When using default <a href="#mongodb-property-mongodb-authentication-class"><code>mongodb.authentication.class</code></a>:
Name of the database user to be used when connecting to MongoDB. This is required only when MongoDB is configured to use authentication.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-mongodb-password"></a><a href="#mongodb-property-mongodb-password"><code>mongodb.password</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>No default</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>When using default <a href="#mongodb-property-mongodb-authentication-class"><code>mongodb.authentication.class</code></a>:
Password to be used when connecting to MongoDB. This is required only when MongoDB is configured to use authentication.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-mongodb-authsource"></a><a href="#mongodb-property-mongodb-authsource"><code>mongodb.authsource</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>admin</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>When using default <a href="#mongodb-property-mongodb-authentication-class"><code>mongodb.authentication.class</code></a>:
Database (authentication source) containing MongoDB credentials. This is required only when MongoDB is configured to use authentication with another authentication database than <code>admin</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-mongodb-ssl-enabled"></a><a href="#mongodb-property-mongodb-ssl-enabled"><code>mongodb.ssl.enabled</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>false</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Connector will use SSL to connect to MongoDB instances.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-mongodb-ssl-invalid-hostname-allowed"></a><a href="#mongodb-property-mongodb-ssl-invalid-hostname-allowed"><code>mongodb.ssl.invalid.hostname.allowed</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>false</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>When SSL is enabled this setting controls whether strict hostname checking is disabled during connection phase. If <code>true</code> the connection will not prevent man-in-the-middle attacks.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-filters-match-mode"></a><a href="#mongodb-property-filters-match-mode"><code>filters.match.mode</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>regex</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The mode used to match events based on included/excluded database and collection names.
Set the property to one of the following values:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>regex</code></dt>
<dd>
<p>Database and collection includes/excludes are evaluated as comma-separated list of regular expressions.</p>
</dd>
<dt class="hdlist1"><code>literal</code></dt>
<dd>
<p>Database and collection includes/excludes are evaluated as comma-separated list of string literals. Whitespace characters surrounding these literals are stripped.</p>
</dd>
</dl>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-database-include-list"></a><a href="#mongodb-property-database-include-list"><code>database.include.list</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><em>empty string</em></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>An optional comma-separated list of regular expressions or literals that match database names to be monitored.
By default, all databases are monitored.<br>
When <code>database.include.list</code> is set, the connector monitors only the databases that the property specifies.
Other databases are excluded from monitoring.</p>
</div>
<div class="paragraph">
<p>To match the name of a database, Debezium performs one of the following actions based on the value of <a href="#mongodb-property-filters-match-mode"><code>filters.match.mode</code></a> property</p>
</div>
<div class="ulist">
<ul>
<li>
<p>applies the regular expression that you specify as an <em>anchored</em> regular expression.
That is, the specified expression is matched against the entire name string of the database; it does not match substrings that might be present in a database name.</p>
</li>
<li>
<p>compares the literals that you specify with the entire name string of the database<br></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you include this property in the configuration, do not also set the <code>database.exclude.list</code> property.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-database-exclude-list"></a><a href="#mongodb-property-database-exclude-list"><code>database.exclude.list</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><em>empty string</em></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>An optional comma-separated list of regular expressions or literals that match database names to be excluded from monitoring.
When <code>database.exclude.list</code> is set, the connector monitors every database except the ones that the property specifies.</p>
</div>
<div class="paragraph">
<p>To match the name of a database, Debezium performs one of the following actions based on the value of <a href="#mongodb-property-filters-match-mode"><code>filters.match.mode</code></a> property</p>
</div>
<div class="ulist">
<ul>
<li>
<p>applies the regular expression that you specify as an <em>anchored</em> regular expression.
That is, the specified expression is matched against the entire name string of the database; it does not match substrings that might be present in a database name.</p>
</li>
<li>
<p>compares the literals that you specify with the entire name string of the database<br></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you include this property in the configuration, do not set the <code>database.include.list</code> property.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-collection-include-list"></a><a href="#mongodb-property-collection-include-list"><code>collection.include.list</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><em>empty string</em></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>An optional comma-separated list of regular expressions or literals that match fully-qualified namespaces for MongoDB collections to be monitored.
By default, the connector monitors all collections except those in the <code>local</code> and <code>admin</code> databases.
When <code>collection.include.list</code> is set, the connector monitors only the collections that the property specifies.
Other collections are excluded from monitoring.
Collection identifiers are of the form <em>databaseName</em>.<em>collectionName</em>.</p>
</div>
<div class="paragraph">
<p>To match the name of a namespace, Debezium performs one of the following actions based on the value of <a href="#mongodb-property-filters-match-mode"><code>filters.match.mode</code></a> property</p>
</div>
<div class="ulist">
<ul>
<li>
<p>applies the regular expression that you specify as an <em>anchored</em> regular expression.
That is, the specified expression is matched against the entire name string of the namespace; it does not match substrings in the name.</p>
</li>
<li>
<p>compares the literals that you specify with the entire name string of the namespace<br></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you include this property in the configuration, do not also set the <code>collection.exclude.list</code> property.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-collection-exclude-list"></a><a href="#mongodb-property-collection-exclude-list"><code>collection.exclude.list</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><em>empty string</em></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>An optional comma-separated list of regular expressions or literals that match fully-qualified namespaces for MongoDB collections to be excluded from monitoring.
When <code>collection.exclude.list</code> is set, the connector monitors every collection except the ones that the property specifies.
Collection identifiers are of the form <em>databaseName</em>.<em>collectionName</em>.<br></p>
</div>
<div class="paragraph">
<p>To match the name of a namespace, Debezium performs one of the following actions based on the value of <a href="#mongodb-property-filters-match-mode"><code>filters.match.mode</code></a> property</p>
</div>
<div class="ulist">
<ul>
<li>
<p>applies the regular expression that you specify as an <em>anchored</em> regular expression.
That is, the specified expression is matched against the entire name string of the namespace; it does not match substrings that might be present in a database name.</p>
</li>
<li>
<p>compares the literals that you specify with the entire name string of the namespace<br></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you include this property in the configuration, do not set the <code>collection.include.list</code> property.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-capture-mode"></a><a href="#mongodb-property-capture-mode"><code>capture.mode</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>change_streams_update_full</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Specifies the method that the connector uses to capture <code>update</code> event changes from a MongoDB server.
Set this property to one of the following values:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>change_streams</code></dt>
<dd>
<p><code>update</code> event messages do not include the full document.
Messages do not include a field that represents the state of the document <code>before</code> the change.</p>
</dd>
<dt class="hdlist1"><code>change_streams_update_full</code></dt>
<dd>
<p><code>update</code> event messages include the full document.
Messages do not include a <code>before</code> field that represents the state of the document before the update.
The event message returns the full state of the document in the <code>after</code> field.
Set <a href="#mongodb-property-capture-mode-full-update-type">capture.mode.full.update.type</a> to specify how the connector fetches full documents from the database.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In some situations, when <code>capture.mode</code> is configured to return full documents, the <code>updateDescription</code> and <code>after</code> fields of the update event message might report inconsistent values.
Such discrepancies can result after multiple updates are applied to a document in rapid succession.
The connector requests the full document from the MongoDB database only after it receives the update described in the event&#8217;s <code>updateDescription</code> field.
If a later update modifies the source document before the connector can retrieve it from the database, the connector receives the document that is modified by this later update.</p>
</div>
</td>
</tr>
</table>
</div>
</dd>
<dt class="hdlist1"><code>change_streams_update_full_with_pre_image</code></dt>
<dd>
<p><code>update</code> event event messages include the full document, and include a field that represents the state of the document <code>before</code> the change.
Set <a href="#mongodb-property-capture-mode-full-update-type">capture.mode.full.update.type</a> to specify how the connector fetches full documents from the database.</p>
</dd>
<dt class="hdlist1"><code>change_streams_with_pre_image</code></dt>
<dd>
<p><code>update</code> events do not include the full document, but include a field that represents the state of the document <code>before</code> the change.</p>
</dd>
</dl>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-capture-scope"></a><a href="#mongodb-property-capture-scope"><code>capture.scope</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>deployment</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Specifies the <a href="https://www.mongodb.com/docs/manual/changeStreams/#watch-a-collection&#8212;&#8203;database&#8212;&#8203;or-deployment">scope of the change streams</a> that the connector opens.
Set this property to one of the following values:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>deployment</code></dt>
<dd>
<p>Opens a change stream cursor for a deployment (either a replica set or a sharded cluster) to watch for changes to all non-system collections across all databases, except for <code>admin</code>, <code>local</code>, and <code>config</code>.</p>
</dd>
<dt class="hdlist1"><code>database</code></dt>
<dd>
<p>Opens a change stream cursor for a single database to watch for changes to all of its non-system collections.</p>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To support <a href="../configuration/signalling.html" class="xref page">Debezium signaling</a>, if you set <code>capture.scope</code> to <code>database</code>, the <a href="#mongodb-property-signal-data-collection">signaling data collection</a> must reside in a database that is specified by the <a href="#mongodb-property-capture-target"><code>capture.target</code></a> property.</p>
</div>
</td>
</tr>
</table>
</div>
</dd>
<dt class="hdlist1"><code>collection</code></dt>
<dd>
<p>Opens a change stream cursor for a single collection to watch for changes to that collection.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This feature is currently in an incubating state.
The exact semantics, configuration options, and so forth are subject to change, based on the feedback that we receive.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Setting the value of the <code>capture.scope</code> property to <code>collection</code> prevents the connector from using the default <code>source</code> <a href="../configuration/signalling.html" class="xref page">signaling</a> channel.
Because the <code>source</code> channel must be enabled to permit connectors to process incremental snapshot signals&#8201;&#8212;&#8201;even for signals are sent over the Kafka, JMX, or File channels&#8201;&#8212;&#8201;the connector cannot perform incremental snapshots when <code>capture-scope</code> is set to <code>collection</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</dd>
</dl>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-capture-target"></a><a href="#mongodb-property-capture-target"><code>capture.target</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Specifies the database that the connector monitors for changes.
This property applies only if the <a href="#mongodb-property-capture-scope"><code>capture.scope</code></a> is set to <code>database</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-field-exclude-list"></a><a href="#mongodb-property-field-exclude-list"><code>field.exclude.list</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><em>empty string</em></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>An optional comma-separated list of the fully-qualified names of fields that should be excluded from change event message values.
Fully-qualified names for fields are of the form <em>databaseName</em>.<em>collectionName</em>.<em>fieldName</em>.<em>nestedFieldName</em>, where <em>databaseName</em> and <em>collectionName</em> may contain the wildcard (*) which matches any characters.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-field-renames"></a><a href="#mongodb-property-field-renames"><code>field.renames</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><em>empty string</em></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>An optional comma-separated list of the fully-qualified replacements of fields that should be used to rename fields in change event message values. Fully-qualified replacements for fields are of the form <em>databaseName</em>.<em>collectionName</em>.<em>fieldName</em>.<em>nestedFieldName</em>:<em>newNestedFieldName</em>, where <em>databaseName</em> and <em>collectionName</em> may contain the wildcard (*) which matches any characters, the colon character (:) is used to determine rename mapping of field. The next field replacement is applied to the result of the previous field replacement in the list, so keep this in mind when renaming multiple fields that are in the same path.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-tombstones-on-delete"></a><a href="#mongodb-property-tombstones-on-delete"><code>tombstones.on.delete</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>true</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Controls whether a <em>delete</em> event is followed by a tombstone event.<br>
<br>
<code>true</code> - a delete operation is represented by a <em>delete</em> event and a subsequent tombstone event. <br>
<br>
<code>false</code> - only a <em>delete</em> event is emitted.<br>
<br>
After a source record is deleted, emitting a tombstone event (the default behavior) allows Kafka to completely delete all events that pertain to the key of the deleted row in case <a href="https://kafka.apache.org/documentation/#compaction">log compaction</a> is enabled for the topic.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-schema-name-adjustment-mode"></a><a href="#mongodb-property-schema-name-adjustment-mode"><code>schema.name.adjustment.mode</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>none</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Specifies how schema names should be adjusted for compatibility with the message converter used by the connector. Possible settings: <br></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>none</code> does not apply any adjustment.<br></p>
</li>
<li>
<p><code>avro</code> replaces the characters that cannot be used in the Avro type name with underscore.<br></p>
</li>
<li>
<p><code>avro_unicode</code> replaces the underscore or characters that cannot be used in the Avro type name with corresponding unicode like _uxxxx. Note: _ is an escape sequence like backslash in Java<br></p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-field-name-adjustment-mode"></a><a href="#mongodb-property-field-name-adjustment-mode"><code>field.name.adjustment.mode</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>none</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Specifies how field names should be adjusted for compatibility with the message converter used by the connector. Possible settings: <br></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>none</code> does not apply any adjustment.<br></p>
</li>
<li>
<p><code>avro</code> replaces the characters that cannot be used in the Avro type name with underscore.<br></p>
</li>
<li>
<p><code>avro_unicode</code> replaces the underscore or characters that cannot be used in the Avro type name with corresponding unicode like _uxxxx. Note: _ is an escape sequence like backslash in Java<br></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See <a href="../configuration/avro.html#avro-naming" class="xref page">Avro naming</a> for more details.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following <em>advanced</em> configuration properties have good defaults that will work in most situations and therefore rarely need to be specified in the connector&#8217;s configuration.</p>
</div>
<table id="debezium-mongodb-connector-advanced-configuration-properties" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 14. Debezium MongoDB connector advanced configuration properties</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 25%;">
<col style="width: 45%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-capture-mode-full-update-type"></a><a href="#mongodb-property-capture-mode-full-update-type"><code>capture.mode.full.update.type</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>lookup</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Specifies how the connector looks up the full value of an updated document when the <a href="#mongodb-property-capture-mode"><code>capture.mode</code></a> is set retrieve full documents.
The connector retrieves full documents when its <code>capture.mode</code> is set to one of the following options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>change_streams_update_full</code></p>
</li>
<li>
<p><code>change_streams_update_full_with_pre-image</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To use this option with a MongoDB change streams collection, you must configure the collection to <a href="https://www.mongodb.com/docs/manual/changeStreams/#change-streams-with-document-pre&#8212;&#8203;and-post-images">return document pre- and post-images</a>.
Pre- and post-images for an operation are available only if the required configuration is in place before the operation occurs.</p>
</div>
<div class="paragraph">
<p>Set this property to one of the following values:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>lookup</code></dt>
<dd>
<p>The connector uses a separate lookup to fetch the updated full MongoDB document.</p>
</dd>
</dl>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the lookup process fails to retrieve a document, it cannot populate the full document to the <code>after</code> state in the event payload.
In such a situation, the connector emits an event message that contains a <code>null</code> value in the <code>after</code> field.</p>
</div>
<div class="paragraph">
<p>Failed lookups can occur because a delete operation removed the document immediately after it was created, or because a change to the sharding key results in the document being moved to a different location.
Sharding key changes can result when you modify any of the properties that make up the key.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>post_image</code></dt>
<dd>
<p>The connector uses MongoDB post images to populate events with the full MongoDB document.
The database must be running MongoDB 6.0 or later to use this option.</p>
</dd>
</dl>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-max-batch-size"></a><a href="#mongodb-property-max-batch-size"><code>max.batch.size</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>2048</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Positive integer value that specifies the maximum size of each batch of events that should be processed during each iteration of this connector. Defaults to 2048.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-max-queue-size"></a><a href="#mongodb-property-max-queue-size"><code>max.queue.size</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>8192</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Positive integer value that specifies the maximum number of records that the blocking queue can hold.
When Debezium reads events streamed from the database, it places the events in the blocking queue before it writes them to Kafka.
The blocking queue can provide backpressure for reading change events from the database
in cases where the connector ingests messages faster than it can write them to Kafka, or when Kafka becomes unavailable.
Events that are held in the queue are disregarded when the connector periodically records offsets.
Always set the value of <code>max.queue.size</code> to be larger than the value of <a href="#mongodb-property-max-batch-size"><code>max.batch.size</code></a>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-max-queue-size-in-bytes"></a><a href="#mongodb-property-max-queue-size-in-bytes"><code>max.queue.size.in.bytes</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>0</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>A long integer value that specifies the maximum volume of the blocking queue in bytes.
By default, volume limits are not specified for the blocking queue.
To specify the number of bytes that the queue can consume, set this property to a positive long value.<br>
If <a href="#mongodb-property-max-queue-size"><code>max.queue.size</code></a> is also set, writing to the queue is blocked when the size of the queue reaches the limit specified by either property.
For example, if you set <code>max.queue.size=1000</code>, and <code>max.queue.size.in.bytes=5000</code>, writing to the queue is blocked after the queue contains 1000 records, or after the volume of the records in the queue reaches 5000 bytes.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-poll-interval-ms"></a><a href="#mongodb-property-poll-interval-ms"><code>poll.interval.ms</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>1000</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Positive integer value that specifies the number of milliseconds the connector should wait during each iteration for new change events to appear. Defaults to 500 milliseconds, or 0.5 second.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-connect-backoff-initial-delay-ms"></a><a href="#mongodb-property-connect-backoff-initial-delay-ms"><code>connect.backoff.initial.delay.ms</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>1000</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Positive integer value that specifies the initial delay when trying to reconnect to a primary after the first failed connection attempt or when no primary is available. Defaults to 1 second (1000 ms).</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-connect-backoff-max-delay-ms"></a><a href="#mongodb-property-connect-backoff-max-delay-ms"><code>connect.backoff.max.delay.ms</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>1000</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Positive integer value that specifies the maximum delay when trying to reconnect to a primary after repeated failed connection attempts or when no primary is available. Defaults to 120 seconds (120,000 ms).</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-connect-max-attempts"></a><a href="#mongodb-property-connect-max-attempts"><code>connect.max.attempts</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>16</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Positive integer value that specifies the maximum number of failed connection attempts to a replica set primary before an exception occurs and task is aborted. Defaults to 16, which with the defaults for <code>connect.backoff.initial.delay.ms</code> and <code>connect.backoff.max.delay.ms</code> results in just over 20 minutes of attempts before failing.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-source-struct-version"></a><a href="#mongodb-property-source-struct-version"><code>source.struct.version</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>v2</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Schema version for the <code>source</code> block in CDC events. Debezium 0.10 introduced a few breaking<br>
changes to the structure of the <code>source</code> block in order to unify the exposed structure across
all the connectors.<br>
By setting this option to <code>v1</code> the structure used in earlier versions can be produced.
Note that this setting is not recommended and is planned for removal in a future Debezium version.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-heartbeat-interval-ms"></a><a href="#mongodb-property-heartbeat-interval-ms"><code>heartbeat.interval.ms</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>0</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Controls how frequently heartbeat messages are sent.<br>
This property contains an interval in milliseconds that defines how frequently the connector sends messages into a heartbeat topic.
This can be used to monitor whether the connector is still receiving change events from the database.
You also should leverage heartbeat messages in cases where only records in non-captured collections are changed for a longer period of time.
In such situation the connector would proceed to read the oplog/change stream from the database but never emit any change messages into Kafka,
which in turn means that no offset updates are committed to Kafka.
This will cause the oplog files to be rotated out but connector will not notice it so on restart some events are no longer available which leads to the need of re-execution of the initial snapshot.</p>
</div>
<div class="paragraph">
<p>Set this parameter to <code>0</code> to not send heartbeat messages at all.<br>
Disabled by default.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-skipped-operations"></a><a href="#mongodb-property-skipped-operations"><code>skipped.operations</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>t</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>A comma-separated list of operation types that will be skipped during streaming.
The operations include: <code>c</code> for inserts/create, <code>u</code> for updates/replace, <code>d</code> for deletes, <code>t</code> for truncates, and <code>none</code> to not skip any aforementioned operations.
By default, for consistency with other Debezium connectors, truncate operations are skipped (not emitted by this connector). However, since MongoDB <a href="https://www.mongodb.com/docs/manual/reference/change-events/#operation-types">does not support</a> truncate change events, this is effectively the same as specifying <code>none</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-snapshot-collection-filter-overrides"></a><a href="#mongodb-property-snapshot-collection-filter-overrides"><code>snapshot.collection.filter.overrides</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>No default</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Controls which collection items are included in snapshot. This property affects snapshots only. Specify a comma-separated list of collection names in the form <em>databaseName.collectionName</em>.</p>
</div>
<div class="paragraph">
<p>For each collection that you specify, also specify another configuration property: <code>snapshot.collection.filter.overrides.<em>databaseName</em>.<em>collectionName</em></code>. For example, the name of the other configuration property might be: <code>snapshot.collection.filter.overrides.customers.orders</code>. Set this property to a valid filter expression that retrieves only the items that you want in the snapshot. When the connector performs a snapshot, it retrieves only the items that matches the filter expression.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-snapshot-delay-ms"></a><a href="#mongodb-property-snapshot-delay-ms"><code>snapshot.delay.ms</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>No default</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>An interval in milliseconds that the connector should wait before taking a snapshot after starting up;<br>
Can be used to avoid snapshot interruptions when starting multiple connectors in a cluster, which may cause re-balancing of connectors.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-streaming-delay-ms"></a><a href="#mongodb-property-streaming-delay-ms"><code>streaming.delay.ms</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>0</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Specifies the time, in milliseconds, that the connector delays the start of the streaming process after it completes a snapshot.
Setting a delay interval helps to prevent the connector from restarting snapshots in the event that a failure occurs immediately after the snapshot completes, but before the streaming process begins.
Set a delay value that is higher than the value of the <a href="https://kafka.apache.org/documentation/#connectconfigs_offset.flush.interval.ms"><code>offset.flush.interval.ms</code></a> property that is set for the Kafka Connect worker.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-snapshot-fetch-size"></a><a href="#mongodb-property-snapshot-fetch-size"><code>snapshot.fetch.size</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>0</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Specifies the maximum number of documents that should be read in one go from each collection while taking a snapshot.
The connector will read the collection contents in multiple batches of this size.<br>
Defaults to 0, which indicates that the server chooses an appropriate fetch size.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-snapshot-include-collection-list"></a><a href="#mongodb-property-snapshot-include-collection-list"><code>snapshot.include.collection.list</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>All collections specified in <code>collection.include.list</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>An optional, comma-separated list of regular expressions that match the fully-qualified names (<code><em>&lt;databaseName&gt;</em>.<em>&lt;collectionName&gt;</em></code>) of the schemas that you want to include in a snapshot.
The specified items must be named in the connectors&#8217;s <a href="#mongodb-property-collection-include-list"><code>collection.include.list</code></a> property.
This property takes effect only if the connector&#8217;s <a href="#mongodb-property-snapshot-mode"><code>snapshot.mode</code></a> property is set to a value other than <code>never</code>.<br>
This property does not affect the behavior of incremental snapshots.<br></p>
</div>
<div class="paragraph">
<p>To match the name of a schema, Debezium applies the regular expression that you specify as an <em>anchored</em> regular expression.
That is, the specified expression is matched against the entire name string of the schema; it does not match substrings that might be present in a schema name.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-snapshot-max-threads"></a><a href="#mongodb-property-snapshot-max-threads"><code>snapshot.max.threads</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>1</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Positive integer value that specifies the maximum number of threads used to perform an intial sync of the collections in a replica set. Defaults to 1.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-snapshot-mode"></a><a href="#mongodb-property-snapshot-mode"><code>snapshot.mode</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><em>initial</em></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Specifies the criteria for performing a snapshot when the connector starts.
Set the property to one of the following values:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>always</code></dt>
<dd>
<p>The connector performs a snapshot every time that it starts.
The snapshot includes the structure and data of the captured tables.
Specify this value to populate topics with a complete representation of the data from the captured tables every time that the connector starts.
After the snapshot completes, the connector begins to stream event records for subsequent database changes.</p>
</dd>
<dt class="hdlist1"><code>initial</code></dt>
<dd>
<p>When the connector starts, it performs an initial database snapshot.
After the snapshot completes, the connector begins to stream event records for subsequent database changes.</p>
</dd>
<dt class="hdlist1"><code>initial_only</code></dt>
<dd>
<p>The connector performs a database a snapshot only when no offsets have been recorded for the logical server name.
After the snapshot completes, the connector stops.
It does not transition to streaming event records for subsequent database changes.</p>
</dd>
<dt class="hdlist1"><code>never</code></dt>
<dd>
<p>Deprecated, see <code>no_data</code>.</p>
</dd>
<dt class="hdlist1"><code>no_data</code></dt>
<dd>
<p>The connector runs a snapshot that captures the structure of all relevant tables,
but it does not create <code>READ</code> events to represent the data set at the point of the connector&#8217;s start-up.</p>
</dd>
<dt class="hdlist1"><code>when_needed</code></dt>
<dd>
<p>After the connector starts, it performs a snapshot only if it detects one of the following circumstances:</p>
<div class="ulist">
<ul>
<li>
<p>It cannot detect any topic offsets.</p>
</li>
<li>
<p>A previously recorded offset specifies a log position that is not available on the server.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1"><code>configuration_based</code></dt>
<dd>
<p>With this option, you control snapshot behavior through a set of connector properties that have the prefix 'snapshot.mode.configuration.based'.</p>
</dd>
<dt class="hdlist1"><code>custom</code></dt>
<dd>
<p>The <code>custom</code> snapshot mode lets you inject your own implementation of the <code>io.debezium.spi.snapshot.Snapshotter</code> interface.
Set the <code>snapshot.mode.custom.name</code> configuration property to the name provided by the <code>name()</code> method of your implementation.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For more information, see <a href="#connector-custom-snapshot">custom snapshotter SPI</a>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-snapshot-mode-configuration-based-snapshot-data"></a><a href="#mongodb-property-configuration-based-snapshot-data"><code>snapshot.mode.configuration.based.snapshot.data</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>false</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>If the <code>snapshot.mode</code> is set to <code>configuration_based</code>, set this property to specify whether the connector includes table data when it performs a snapshot.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-snapshot-mode-configuration-based-snapshot-schema"></a><a href="#mongodb-property-configuration-based-snapshot-schema"><code>snapshot.mode.configuration.based.snapshot.schema</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>false</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>If the <code>snapshot.mode</code> is set to <code>configuration_based</code>, set this property to specify whether the connector includes the table schema when it performs a snapshot.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-snapshot-mode-configuration-based-start-stream"></a><a href="#mongodb-property-configuration-based-start-stream"><code>snapshot.mode.configuration.based.start.stream</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>false</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>If the <code>snapshot.mode</code> is set to <code>configuration_based</code>, set this property to specify whether the connector begins to stream change events after a snapshot completes.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-snapshot-mode-configuration-based-snapshot-on-schema-error"></a><a href="#mongodb-property-configuration-based-snapshot-on-schema-error"><code>snapshot.mode.configuration.based.snapshot.on.schema.error</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>false</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>If the <code>snapshot.mode</code> is set to <code>configuration_based</code>, set this property to specify whether the connector includes table schema in a snapshot if the schema history topic is not available.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-snapshot-mode-configuration-based-snapshot-on-data-error"></a><a href="#mongodb-property-configuration-based-snapshot-on-data-error"><code>snapshot.mode.configuration.based.snapshot.on.data.error</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>false</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>If the <code>snapshot.mode</code> is set to <code>configuration_based</code>, this property specifies whether the connector attempts to snapshot table data if it does not find the last committed offset in the transaction log.<br>
Set the value to <code>true</code> to instruct the connector to perform a new snapshot.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-snapshot-mode-custom-name"></a><a href="#mongodb-property-snapshot-mode-custom-name"><code>snapshot.mode.custom.name</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>No default</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>If <code>snapshot.mode</code> is set to <code>custom</code>, use this setting to specify the name of the custom implementation that is provided in the <code>name()</code> method that is defined in the 'io.debezium.spi.snapshot.Snapshotter' interface.
After a connector restart, Debezium calls the specified custom implementation to determine whether to perform a snapshot.
For more information, see <a href="#connector-custom-snapshot">custom snapshotter SPI</a>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-provide-transaction-metadata"></a><a href="#mongodb-property-provide-transaction-metadata"><code>provide.transaction.metadata</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>false</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>When set to <code>true</code> Debezium generates events with transaction boundaries and enriches data events envelope with transaction metadata.</p>
</div>
<div class="paragraph">
<p>See <a href="#mongodb-transaction-metadata">Transaction Metadata</a> for additional details.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-retriable-restart-connector-wait-ms"></a><a href="#mongodb-property-retriable-restart-connector-wait-ms"><code>retriable.restart.connector.wait.ms</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>10000 (10 seconds)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The number of milliseconds to wait before restarting a connector after a retriable error occurs.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-mongodb-poll-interval-ms"></a><a href="#mongodb-property-mongodb-poll-interval-ms"><code>mongodb.poll.interval.ms</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>30000</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The interval in which the connector polls for new, removed, or changed replica sets.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-mongodb-connect-timeout-ms"></a><a href="#mongodb-property-mongodb-connect-timeout-ms"><code>mongodb.connect.timeout.ms</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>10000 (10 seconds)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The number of milliseconds the driver will wait before a new connection attempt is aborted.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-mongodb-heartbeat-frequency-ms"></a><a href="#mongodb-property-mongodb-heartbeat-frequency-ms"><code>mongodb.heartbeat.frequency.ms</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>10000 (10 seconds)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The frequency that the cluster monitor attempts to reach each server.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-mongodb-socket-timeout-ms"></a><a href="#mongodb-property-mongodb-socket-timeout-ms"><code>mongodb.socket.timeout.ms</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>0</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The number of milliseconds before a send/receive on the socket can take before a timeout occurs.
A value of <code>0</code> disables this behavior.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-mongodb-server-selection-timeout-ms"></a><a href="#mongodb-property-mongodb-server-selection-timeout-ms"><code>mongodb.server.selection.timeout.ms</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>30000 (30 seconds)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The number of milliseconds the driver will wait to select a server before it times out and throws an error.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-cursor-pipeline"></a><a href="#mongodb-property-cursor-pipeline"><code>cursor.pipeline</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>No default</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>When streaming changes, this setting applies processing to change stream events as part of the standard MongoDB aggregation stream pipeline. A pipeline is a MongoDB aggregation pipeline composed of instructions to the database to filter or transform data. This can be used customize the data that the connector consumes.
The value of this property must be an array of permitted <a href="https://www.mongodb.com/docs/manual/changeStreams/#modify-change-stream-output">aggregation pipeline stages</a> in JSON format.
Note that this is appended after the internal pipeline used to support the connector (e.g. filtering operation types, database names, collection names, etc.).</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-cursor-pipeline-order"></a><a href="#mongodb-property-cursor-pipeline-order"><code>cursor.pipeline.order</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>internal_first</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The order used to construct the effective MongoDB aggregation stream pipeline.
Set the property to one of the following values:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>internal_first</code></dt>
<dd>
<p>Internal stages defined by the connector are applied first. This means that only the events which ought to be captured by the connector are fed to the user defined stages (configured by setting <code>cursor.pipeline</code>).</p>
</dd>
<dt class="hdlist1"><code>user_first</code></dt>
<dd>
<p>Stages defined by the 'cursor.pipeline' property are applied first. In this mode  all events, included those not captured by the connector, are fed to user defined pipeline stages. This mode can have negative performance impact if the value of <code>cursor.pipeline</code> contains complex operations.</p>
</dd>
<dt class="hdlist1"><code>user_only</code></dt>
<dd>
<p>Stages defined by the 'cursor.pipeline' property will replace internal stages defined by the connector. This mode is <strong>intended only for expert users</strong> since  all events are processed only by user defined pipeline stages. <strong>This mode can have negative impact on performance and overall functionality of the connector!</strong></p>
</dd>
</dl>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-cursor-oversize-handling-mode"></a><a href="#mongodb-property-cursor-oversize-handling-mode"><code>cursor.oversize.handling.mode</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>fail</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The strategy used to handle change events for documents exceeding specified BSON size.
Set the property to one of the following values:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>fail</code></dt>
<dd>
<p>The connector fails if the total size of change event exceed the maximum BSON size.</p>
</dd>
<dt class="hdlist1"><code>skip</code></dt>
<dd>
<p>Any change events for documents exceeding the maximum (specified by the <code>cursor.oversize.skip.threshold</code> property) size will be ignored</p>
</dd>
<dt class="hdlist1"><code>split</code></dt>
<dd>
<p>Change events exceeding the maximum BSON size will be split using the <a href="https://www.mongodb.com/docs/v6.0/reference/operator/aggregation/changeStreamSplitLargeEvent/">$changeStreamSplitLargeEvent</a> aggregation. This option requires <strong>MongoDB 6.0.9 or newer</strong>.</p>
</dd>
</dl>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-cursor-oversize-skip-threshold"></a><a href="#mongodb-property-cursor-oversize-skip-threshold"><code>cursor.oversize.skip.threshold</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>0</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The maximum allowed size <strong>in bytes</strong> of the stored document for which change events are processed. This includes both, the size before and after database operation, more specifically this limits the size of fullDocument and fullDocumentBeforeChange filed of MongoDB change events.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-cursor-max-await-time-ms"></a><a href="#mongodb-property-cursor-max-await-time-ms"><code>cursor.max.await.time.ms</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>0</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Specifies the maximum number of milliseconds the oplog/change stream cursor will wait for the server to produce a result before causing an execution timeout exception.
A value of <code>0</code> indicates using the server/driver default wait timeout.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-signal-data-collection"></a><a href="#mongodb-property-signal-data-collection"><code>signal.data.collection</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>No default</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Fully-qualified name of the data collection that is used to send <a href="../configuration/signalling.html#debezium-signaling-enabling-source-signaling-channel" class="xref page">signals</a> to the connector.
Use the following format to specify the collection name:<br>
<code><em>&lt;databaseName&gt;</em>.<em>&lt;collectionName&gt;</em></code><br></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-signal-enabled-channels"></a><a href="#mongodb-property-signal-enabled-channels"><code>signal.enabled.channels</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>source</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>List of the signaling channel names that are enabled for the connector.
By default, the following channels are available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>source</code></p>
</li>
<li>
<p><code>kafka</code></p>
</li>
<li>
<p><code>file</code></p>
</li>
<li>
<p><code>jmx</code>
Optionally, you can also implement a <a href="../configuration/signalling.html#debezium-signaling-enabling-custom-signaling-channel" class="xref page">custom signaling channel</a>.</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-notification-enabled-channels"></a><a href="#mongodb-property-notification-enabled-channels"><code>notification.enabled.channels</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>No default</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>List of notification channel names that are enabled for the connector.
By default, the following channels are available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>sink</code></p>
</li>
<li>
<p><code>log</code></p>
</li>
<li>
<p><code>jmx</code>
Optionally, you can also implement a <a href="../configuration/notification.html#debezium-notification-custom-channel" class="xref page">custom notification channel</a>.</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-incremental-snapshot-chunk-size"></a><a href="#mongodb-property-incremental-snapshot-chunk-size"><code>incremental.snapshot.chunk.size</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>1024</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The maximum number of documents that the connector fetches and reads into memory during an incremental snapshot chunk.
Increasing the chunk size provides greater efficiency, because the snapshot runs fewer snapshot queries of a greater size.
However, larger chunk sizes also require more memory to buffer the snapshot data.
Adjust the chunk size to a value that provides the best performance in your environment.<br></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-incremental-snapshot-watermarking-strategy"></a><a href="#mongodb-property-incremental-snapshot-watermarking-strategy"><code>incremental.snapshot.watermarking.strategy</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>insert_insert</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Specifies the watermarking mechanism that the connector uses during an incremental snapshot to deduplicate events that might be captured by an incremental snapshot and then recaptured after streaming resumes.<br>
You can specify one of the following options:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>insert_insert</code></dt>
<dd>
<p>When you send a signal to initiate an incremental snapshot, for every chunk that Debezium reads during the snapshot, it writes an entry to the signaling data collection to record the signal to open the snapshot window.
After the snapshot completes, Debezium inserts a second entry that records the signal to close the window.</p>
</dd>
<dt class="hdlist1"><code>insert_delete</code></dt>
<dd>
<p>When you send a signal to initiate an incremental snapshot, for every chunk that Debezium reads, it writes a single entry to the signaling data collection to record the signal to open the snapshot window.
After the snapshot completes, this entry is removed.
No entry is created for the signal to close the snapshot window.
Set this option to prevent rapid growth of the signaling data collection.</p>
</dd>
</dl>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-topic-naming-strategy"></a><a href="#mongodb-property-topic-naming-strategy"><code>topic.naming.strategy</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>io.debezium.schema.DefaultTopicNamingStrategy</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The name of the TopicNamingStrategy class that should be used to determine the topic name for data change, schema change, transaction, heartbeat event etc., defaults to <code>DefaultTopicNamingStrategy</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-topic-delimiter"></a><a href="#mongodb-property-topic-delimiter"><code>topic.delimiter</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>.</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Specify the delimiter for topic name, defaults to <code>.</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-topic-cache-size"></a><a href="#mongodb-property-topic-cache-size"><code>topic.cache.size</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>10000</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The size used for holding the topic names in bounded concurrent hash map. This cache will help to determine the topic name corresponding to a given data collection.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-topic-heartbeat-prefix"></a><a href="#mongodb-property-topic-heartbeat-prefix"><code>topic.heartbeat.prefix</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>__debezium-heartbeat</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Controls the name of the topic to which the connector sends heartbeat messages. The topic name has this pattern:<br>
<br>
<em>topic.heartbeat.prefix</em>.<em>topic.prefix</em><br>
<br>
For example, if the topic prefix is <code>fulfillment</code>, the default topic name is <code>__debezium-heartbeat.fulfillment</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-topic-transaction"></a><a href="#mongodb-property-topic-transaction"><code>topic.transaction</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>transaction</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Controls the name of the topic to which the connector sends transaction metadata messages. The topic name has this pattern:<br>
<br>
<em>topic.prefix</em>.<em>topic.transaction</em><br>
<br>
For example, if the topic prefix is <code>fulfillment</code>, the default topic name is <code>fulfillment.transaction</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-custom-metric-tags"></a><a href="#mongodb-property-custom-metric-tags"><code>custom.metric.tags</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>No default</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Defines tags that customize MBean object names by adding metadata that provides contextual information.
Specify a comma-separated list of key-value pairs.
Each key represents a tag for the MBean object name, and the corresponding value represents a value for the key, for example, <br>
<code>k1=v1,k2=v2</code></p>
</div>
<div class="paragraph">
<p>The connector appends the specified tags to the base MBean object name.
Tags can help you to organize and categorize metrics data.
You can define tags to identify particular application instances, environments, regions, versions, and so forth.
For more information, see <a href="#customized-mbean-names">Customized MBean names</a>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-errors-max-retires"></a><a href="#mongodb-property-errors-max-retires"><code>errors.max.retries</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>-1</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Specifies how the connector responds after an operation that results in a retriable error, such as a connection error.<br>
Set one of the following options:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>-1</code></dt>
<dd>
<p>No limit. The connector always restarts automatically, and retries the operation, regardless of the number of previous failures.</p>
</dd>
<dt class="hdlist1"><code>0</code></dt>
<dd>
<p>Disabled. The connector fails immediately, and never retries the operation.
User intervention is required to restart the connector.</p>
</dd>
<dt class="hdlist1"><code>&gt; 0</code></dt>
<dd>
<p>The connector restarts automatically until it reaches the specified maximum number of retries.
After the next failure, the connector stops, and user intervention is required to restart it.</p>
</dd>
</dl>
</div></div></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="debezium-mongodb-connector-kafka-signals-configuration-properties"><a class="anchor" href="#debezium-mongodb-connector-kafka-signals-configuration-properties"></a>Debezium connector Kafka signals configuration properties</h4>
<div class="paragraph">
<p>Debezium provides a set of <code>signal.*</code> properties that control how the connector interacts with the Kafka signals topic.</p>
</div>
<div class="paragraph">
<p>The following table describes the Kafka <code>signal</code> properties.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 15. Kafka signals configuration properties</caption>
<colgroup>
<col style="width: 33%;">
<col style="width: 17%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-signal-kafka-topic"></a><a href="#mongodb-property-signal-kafka-topic"><code>signal.kafka.topic</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>&lt;topic.prefix&gt;-signal</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The name of the Kafka topic that the connector monitors for ad hoc signals.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If <a href="../configuration/topic-auto-create-config.html#topic-auto-create-config" class="xref page">automatic topic creation</a> is disabled, you must manually create the required signaling topic.
A signaling topic is required to preserve signal ordering.
The signaling topic must have a single partition.</p>
</div>
</td>
</tr>
</table>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-signal-kafka-groupId"></a><a href="#mongodb-property-signal-kafka-groupId"><code>signal.kafka.groupId</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>kafka-signal</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The name of the group ID  that is used by Kafka consumers.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-signal-kafka-bootstrap-servers"></a><a href="#mongodb-property-signal-kafka-bootstrap-servers"><code>signal.kafka.bootstrap.servers</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>No default</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>A list of host/port pairs that the connector uses for establishing an initial connection to the Kafka cluster.
Each pair references the Kafka cluster that is used by the Debezium Kafka Connect process.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-signal-kafka-poll-timeout-ms"></a><a href="#mongodb-property-signal-kafka-poll-timeout-ms"><code>signal.kafka.poll.timeout.ms</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>100</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>An integer value that specifies the maximum number of milliseconds that the connector waits when polling signals.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-kafka-consumer-offset-commit-enabled"></a><a href="#mongodb-kafka-consumer-offset-commit-enabled"><code>kafka.consumer.offset.commit.enabled</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>false</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Enable the offset commit for the signal topic in order to guarantee At-Least-Once delivery. If disabled, only signals received when the consumer is up&amp;running are processed. Any signals received when the consumer is down are lost.</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="debezium-mongodb-connector-pass-through-signals-kafka-consumer-configuration-properties"><a class="anchor" href="#debezium-mongodb-connector-pass-through-signals-kafka-consumer-configuration-properties"></a>Debezium connector pass-through signals Kafka consumer client configuration properties</h4>
<div class="paragraph">
<p>The Debezium connector provides for pass-through configuration of the signals Kafka consumer.
Pass-through signals properties begin with the prefix <code>signals.consumer.*</code>.
For example, the connector passes properties such as <code>signal.consumer.security.protocol=SSL</code> to the Kafka consumer.</p>
</div>
<div class="paragraph">
<p>Debezium strips the prefixes from the properties before it passes the properties to the Kafka signals consumer.</p>
</div>
</div>
<div class="sect3">
<h4 id="debezium-mongodb-connector-kafka-notifications-configuration-properties"><a class="anchor" href="#debezium-mongodb-connector-kafka-notifications-configuration-properties"></a>Debezium connector sink notifications configuration properties</h4>
<div class="paragraph">
<p>The following table describes the <code>notification</code> properties.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 16. Sink notification configuration properties</caption>
<colgroup>
<col style="width: 33%;">
<col style="width: 17%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-property-notification-sink-topic-name"></a><a href="#mongodb-property-notification-sink-topic-name"><code>notification.sink.topic.name</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>No default</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The name of the topic that receives notifications from Debezium.
This property is required when you configure the <a href="#mongodb-property-notification-enabled-channels"><code>notification.enabled.channels</code></a> property to include <code>sink</code> as one of the enabled notification channels.</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mongodb-monitoring"><a class="anchor" href="#mongodb-monitoring"></a>Monitoring</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Debezium MongoDB connector has two metric types in addition to the built-in support for JMX metrics that Zookeeper, Kafka, and Kafka Connect have.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#mongodb-snapshot-metrics">Snapshot metrics</a> provide information about connector operation while performing a snapshot.</p>
</li>
<li>
<p><a href="#mongodb-streaming-metrics">Streaming metrics</a> provide information about connector operation when the connector is capturing changes and streaming change event records.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <a href="../operations/monitoring.html#monitoring-debezium" class="xref page">Debezium monitoring documentation</a> provides details about how to expose these metrics by using JMX.</p>
</div>
<div class="sect2">
<h3 id="_customized_mbean_names"><a class="anchor" href="#_customized_mbean_names"></a>Customized MBean names</h3>
<div class="paragraph">
<p>Debezium connectors expose metrics via the MBean name for the connector.
These metrics, which are specific to each connector instance, provide data about the behavior of the connector&#8217;s snapshot, streaming, and schema history processes.</p>
</div>
<div class="paragraph">
<p>By default, when you deploy a correctly configured connector, Debezium generates a unique MBean name for each of the different connector metrics.
To view the metrics for a connector process, you configure your observability stack to monitor its MBean.
But these default MBean names depend on the connector configuration; configuration changes can result in changes to the MBean names.
A change to the MBean name breaks the linkage between the connector instance and the MBean, disrupting monitoring activity.
In this scenario, you must reconfigure the observability stack to use the new MBean name if you want to resume monitoring.</p>
</div>
<div class="paragraph">
<p>To prevent monitoring disruptions that result from MBean name changes, you can configure custom metrics tags.
You configure custom metrics by adding the <code>custom.metric.tags</code> property to the connector configuration.
The property accepts key-value pairs in which each key represents a tag for the MBean object name, and the corresponding value represents the value of that tag.
For example: <code>k1=v1,k2=v2</code>.
Debezium appends the specified tags to the MBean name of the connector.</p>
</div>
<div class="paragraph">
<p>After you configure the <code>custom.metric.tags</code> property for a connector, you can configure the observability stack to retrieve metrics associated with the specified tags.
The observability stack then uses the specified tags, rather than the mutable MBean names to uniquely identify connectors.
Later, if Debezium redefines how it constructs MBean names, or if the <code>topic.prefix</code> in the connector configuration changes, metrics collection is uninterrupted,
because the metrics scrape task uses the specified tag patterns to identify the connector.</p>
</div>
<div class="paragraph">
<p>A further benefit of using custom tags, is that you can use tags that reflect the architecture of your data pipeline, so that metrics are organized in a way that suits you operational needs.
For example, you might specify tags with values that declare the type of connector activity, the application context, or the data source, for example, <code>db1-streaming-for-application-abc</code>.
If you specify multiple key-value pairs, all of the specified pairs are appended to the connector&#8217;s MBean name.</p>
</div>
<div class="paragraph">
<p>The following example illustrates how tags modify the default MBean name.</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. How custom tags modify the connector MBean name</div>
<div class="content">
<div class="paragraph">
<p>By default, the MongoDB connector uses the following MBean name for streaming metrics:
<br></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">debezium.mongodb:type=connector-metrics,context=streaming,server=<em>&lt;topic.prefix&gt;</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you set the value of <code>custom.metric.tags</code> to <code>database=salesdb-streaming,table=inventory</code>, Debezium generates the following custom MBean name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">debezium.mongodb:type=connector-metrics,context=streaming,server=<em>&lt;topic.prefix&gt;</em>,database=salesdb-streaming,table=inventory</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongodb-snapshot-metrics"><a class="anchor" href="#mongodb-snapshot-metrics"></a>Snapshot Metrics</h3>
<div class="paragraph">
<p>The <strong>MBean</strong> is <code>debezium.mongodb:type=connector-metrics,context=snapshot,server=<em>&lt;topic.prefix&gt;</em>,task=<em>&lt;task.id&gt;</em></code>.</p>
</div>
<div class="paragraph">
<p>Snapshot metrics are not exposed unless a snapshot operation is active, or if a snapshot has occurred since the last connector start.</p>
</div>
<div class="paragraph">
<p>The following table lists the snapshot metrics that are available.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 45%;">
<col style="width: 25%;">
<col style="width: 30%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attributes</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="connectors-snaps-metric-lastevent_mongodb"></a><a href="#connectors-snaps-metric-lastevent_mongodb"><code>LastEvent</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>string</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The last snapshot event that the connector has read.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="connectors-snaps-metric-millisecondssincelastevent_mongodb"></a><a href="#connectors-snaps-metric-millisecondssincelastevent_mongodb"><code>MilliSecondsSinceLastEvent</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>long</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The number of milliseconds since the connector has read and processed the most recent event.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="connectors-snaps-metric-totalnumberofeventsseen_mongodb"></a><a href="#connectors-snaps-metric-totalnumberofeventsseen_mongodb"><code>TotalNumberOfEventsSeen</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>long</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The total number of events that this connector has seen since last started or reset.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="connectors-snaps-metric-numberofeventsfiltered_mongodb"></a><a href="#connectors-snaps-metric-numberofeventsfiltered_mongodb"><code>NumberOfEventsFiltered</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>long</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The number of events that have been filtered by include/exclude list filtering rules configured on the connector.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="connectors-snaps-metric-capturedtables_mongodb"></a><a href="#connectors-snaps-metric-capturedtables_mongodb"><code>CapturedTables</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>string[]</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The list of tables that are captured by the connector.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="connectors-snaps-metric-queuetotalcapacity_mongodb"></a><a href="#connectors-snaps-metric-queuetotalcapacity_mongodb"><code>QueueTotalCapacity</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>int</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The length the queue used to pass events between the snapshotter and the main Kafka Connect loop.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="connectors-snaps-metric-queueremainingcapacity_mongodb"></a><a href="#connectors-snaps-metric-queueremainingcapacity_mongodb"><code>QueueRemainingCapacity</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>int</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The free capacity of the queue used to pass events between the snapshotter and the main Kafka Connect loop.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="connectors-snaps-metric-totaltablecount_mongodb"></a><a href="#connectors-snaps-metric-totaltablecount_mongodb"><code>TotalTableCount</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>int</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The total number of tables that are being included in the snapshot.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="connectors-snaps-metric-remainingtablecount_mongodb"></a><a href="#connectors-snaps-metric-remainingtablecount_mongodb"><code>RemainingTableCount</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>int</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The number of tables that the snapshot has yet to copy.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="connectors-snaps-metric-snapshotrunning_mongodb"></a><a href="#connectors-snaps-metric-snapshotrunning_mongodb"><code>SnapshotRunning</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>boolean</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Whether the snapshot was started.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="connectors-snaps-metric-snapshotpaused_mongodb"></a><a href="#connectors-snaps-metric-snapshotpaused_mongodb"><code>SnapshotPaused</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>boolean</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Whether the snapshot was paused.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="connectors-snaps-metric-snapshotaborted_mongodb"></a><a href="#connectors-snaps-metric-snapshotaborted_mongodb"><code>SnapshotAborted</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>boolean</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Whether the snapshot was aborted.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="connectors-snaps-metric-snapshotcompleted_mongodb"></a><a href="#connectors-snaps-metric-snapshotcompleted_mongodb"><code>SnapshotCompleted</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>boolean</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Whether the snapshot completed.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="connectors-snaps-metric-snapshotdurationinseconds_mongodb"></a><a href="#connectors-snaps-metric-snapshotdurationinseconds_mongodb"><code>SnapshotDurationInSeconds</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>long</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The total number of seconds that the snapshot has taken so far, even if not complete. Includes also time when snapshot was paused.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="connectors-snaps-metric-snapshotpauseddurationinseconds_mongodb"></a><a href="#connectors-snaps-metric-snapshotpauseddurationinseconds_mongodb"><code>SnapshotPausedDurationInSeconds</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>long</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The total number of seconds that the snapshot was paused. If the snapshot was paused several times, the paused time adds up.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="connectors-snaps-metric-rowsscanned_mongodb"></a><a href="#connectors-snaps-metric-rowsscanned_mongodb"><code>RowsScanned</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>Map&lt;String, Long&gt;</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Map containing the number of rows scanned for each table in the snapshot.
Tables are incrementally added to the Map during processing.
Updates every 10,000 rows scanned and upon completing a table.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="connectors-snaps-metric-maxqueuesizeinbytes_mongodb"></a><a href="#connectors-snaps-metric-maxqueuesizeinbytes_mongodb"><code>MaxQueueSizeInBytes</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>long</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The maximum buffer of the queue in bytes. This metric is available if <a href="#mongodb-property-max-queue-size-in-bytes"><code>max.queue.size.in.bytes</code></a> is set to a positive long value.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="connectors-snaps-metric-currentqueuesizeinbytes_mongodb"></a><a href="#connectors-snaps-metric-currentqueuesizeinbytes_mongodb"><code>CurrentQueueSizeInBytes</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>long</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The current volume, in bytes, of records in the queue.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The Debezium MongoDB connector also provides the following custom snapshot metrics:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 30%;">
<col style="width: 20%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NumberOfDisconnects</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>long</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of database disconnects.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="mongodb-streaming-metrics"><a class="anchor" href="#mongodb-streaming-metrics"></a>Streaming Metrics</h3>
<div class="paragraph">
<p>The <strong>MBean</strong> is <code>debezium.mongodb:type=connector-metrics,context=streaming,server=<em>&lt;topic.prefix&gt;</em>,task=<em>&lt;task.id&gt;</em></code>.</p>
</div>
<div class="paragraph">
<p>The following table lists the streaming metrics that are available.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 45%;">
<col style="width: 25%;">
<col style="width: 30%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attributes</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="connectors-strm-metric-lastevent_mongodb"></a><a href="#connectors-strm-metric-lastevent_mongodb"><code>LastEvent</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>string</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The last streaming event that the connector has read.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="connectors-strm-metric-millisecondssincelastevent_mongodb"></a><a href="#connectors-strm-metric-millisecondssincelastevent_mongodb"><code>MilliSecondsSinceLastEvent</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>long</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The number of milliseconds since the connector has read and processed the most recent event.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="connectors-strm-metric-totalnumberofeventsseen_mongodb"></a><a href="#connectors-strm-metric-totalnumberofeventsseen_mongodb"><code>TotalNumberOfEventsSeen</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>long</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The total number of data change events reported by the source database since the last connector start, or since a metrics reset.
Represents the data change workload for Debezium to process.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="connectors-strm-metric-totalnumberofcreateeventsseen_mongodb"></a><a href="#connectors-strm-metric-totalnumberofcreateeventsseen_mongodb"><code>TotalNumberOfCreateEventsSeen</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>long</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The total number of create events processed by the connector since its last start or metrics reset.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="connectors-strm-metric-totalnumberofupdateeventsseen_mongodb"></a><a href="#connectors-strm-metric-totalnumberofupdateeventsseen_mongodb"><code>TotalNumberOfUpdateEventsSeen</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>long</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The total number of update events processed by the connector since its last start or metrics reset.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="connectors-strm-metric-totalnumberofdeleteeventsseen_mongodb"></a><a href="#connectors-strm-metric-totalnumberofdeleteeventsseen_mongodb"><code>TotalNumberOfDeleteEventsSeen</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>long</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The total number of delete events processed by the connector since its last start or metrics reset.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="connectors-strm-metric-numberofeventsfiltered_mongodb"></a><a href="#connectors-strm-metric-numberofeventsfiltered_mongodb"><code>NumberOfEventsFiltered</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>long</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The number of events that have been filtered by include/exclude list filtering rules configured on the connector.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="connectors-strm-metric-capturedtables_mongodb"></a><a href="#connectors-strm-metric-capturedtables_mongodb"><code>CapturedTables</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>string[]</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The list of tables that are captured by the connector.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="connectors-strm-metric-queuetotalcapacity_mongodb"></a><a href="#connectors-strm-metric-queuetotalcapacity_mongodb"><code>QueueTotalCapacity</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>int</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The length the queue used to pass events between the streamer and the main Kafka Connect loop.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="connectors-strm-metric-queueremainingcapacity_mongodb"></a><a href="#connectors-strm-metric-queueremainingcapacity_mongodb"><code>QueueRemainingCapacity</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>int</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The free capacity of the queue used to pass events between the streamer and the main Kafka Connect loop.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="connectors-strm-metric-connected_mongodb"></a><a href="#connectors-strm-metric-connected_mongodb"><code>Connected</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>boolean</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Flag that denotes whether the connector is currently connected to the database server.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="connectors-strm-metric-millisecondsbehindsource_mongodb"></a><a href="#connectors-strm-metric-millisecondsbehindsource_mongodb"><code>MilliSecondsBehindSource</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>long</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The number of milliseconds between the last change event&#8217;s timestamp and the connector processing it.
The values will incorporate any differences between the clocks on the machines where the database server and the connector are running.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="connectors-strm-metric-numberofcommittedtransactions_mongodb"></a><a href="#connectors-strm-metric-numberofcommittedtransactions_mongodb"><code>NumberOfCommittedTransactions</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>long</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The number of processed transactions that were committed.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="connectors-strm-metric-sourceeventposition_mongodb"></a><a href="#connectors-strm-metric-sourceeventposition_mongodb"><code>SourceEventPosition</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>Map&lt;String, String&gt;</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The coordinates of the last received event.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="connectors-strm-metric-lasttransactionid_mongodb"></a><a href="#connectors-strm-metric-lasttransactionid_mongodb"><code>LastTransactionId</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>string</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Transaction identifier of the last processed transaction.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="connectors-strm-metric-maxqueuesizeinbytes_mongodb"></a><a href="#connectors-strm-metric-maxqueuesizeinbytes_mongodb"><code>MaxQueueSizeInBytes</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>long</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The maximum buffer of the queue in bytes. This metric is available if <a href="#mongodb-property-max-queue-size-in-bytes"><code>max.queue.size.in.bytes</code></a> is set to a positive long value.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="connectors-strm-metric-currentqueuesizeinbytes_mongodb"></a><a href="#connectors-strm-metric-currentqueuesizeinbytes_mongodb"><code>CurrentQueueSizeInBytes</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>long</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The current volume, in bytes, of records in the queue.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The Debezium MongoDB connector also provides the following custom streaming metrics:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 30%;">
<col style="width: 20%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NumberOfDisconnects</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>long</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of database disconnects.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NumberOfPrimaryElections</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>long</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of primary node elections.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mongodb-when-things-go-wrong"><a class="anchor" href="#mongodb-when-things-go-wrong"></a>MongoDB connector common issues</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Debezium is a distributed system that captures all changes in multiple upstream databases, and will never miss or lose an event.
When the system is operating normally and is managed carefully, then Debezium provides <em>exactly once</em> delivery of every change event.</p>
</div>
<div class="paragraph">
<p>If a fault occurs, the system does not lose any events.
However, while it is recovering from the fault, it might repeat some change events.
In such situations, Debezium, like Kafka, provides <em>at least once</em> delivery of change events.</p>
</div>
<div class="paragraph">
<p>The rest of this section describes how Debezium handles various kinds of faults and problems.</p>
</div>
<div class="sect2">
<h3 id="debezium-mongodb-connector-configuration-and-startup-errors"><a class="anchor" href="#debezium-mongodb-connector-configuration-and-startup-errors"></a>Configuration and startup errors</h3>
<div class="paragraph">
<p>In the following situations, the connector fails when trying to start, reports an error or exception in the log, and stops running:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The connector&#8217;s configuration is invalid.</p>
</li>
<li>
<p>The connector cannot successfully connect to MongoDB by using the specified connection parameters.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>After a failure, the connector attempts to reconnect by using exponential backoff.
You can configure the maximum number of reconnection attempts.</p>
</div>
<div class="paragraph">
<p>In these cases, the error will have more details about the problem and possibly a suggested work around. The connector can be restarted when the configuration has been corrected or the MongoDB problem has been addressed.</p>
</div>
</div>
<div class="sect2">
<h3 id="mongodb-becomes-unavailable-while-debezium-is-running"><a class="anchor" href="#mongodb-becomes-unavailable-while-debezium-is-running"></a>MongoDB becomes unavailable</h3>
<div class="paragraph">
<p>Once the connector is running, if the primary node of any of the MongoDB replica sets become unavailable or unreachable, the connector will repeatedly attempt to reconnect to the primary node, using exponential backoff to prevent saturating the network or servers. If the primary remains unavailable after the configurable number of connection attempts, the connector will fail.</p>
</div>
<div class="paragraph">
<p>The attempts to reconnect are controlled by three properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>connect.backoff.initial.delay.ms</code> - The delay before attempting to reconnect for the first time, with a default of 1 second (1000 milliseconds).</p>
</li>
<li>
<p><code>connect.backoff.max.delay.ms</code> - The maximum delay before attempting to reconnect, with a default of 120 seconds (120,000 milliseconds).</p>
</li>
<li>
<p><code>connect.max.attempts</code> - The maximum number of attempts before an error is produced, with a default of 16.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Each delay is double that of the prior delay, up to the maximum delay. Given the default values, the following table shows the delay for each failed connection attempt and the total accumulated time before failure.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 30%;">
<col style="width: 30%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Reconnection attempt number</th>
<th class="tableblock halign-left valign-top">Delay before attempt, in seconds</th>
<th class="tableblock halign-left valign-top">Total delay before attempt, in minutes and seconds</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>1</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>1</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>00:01</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>2</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>2</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>00:03</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>3</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>4</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>00:07</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>4</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>8</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>00:15</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>5</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>16</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>00:31</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>6</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>32</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>01:03</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>7</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>64</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>02:07</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>8</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>120</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>04:07</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>9</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>120</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>06:07</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>10</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>120</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>08:07</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>11</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>120</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>10:07</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>12</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>120</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>12:07</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>13</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>120</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>14:07</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>14</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>120</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>16:07</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>15</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>120</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>18:07</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>16</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>120</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>20:07</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="connector-error-invalid-resume-token"><a class="anchor" href="#connector-error-invalid-resume-token"></a>Connector Unable to Start - InvalidResumeToken or ChangeStreamHistoryLost</h3>
<div class="paragraph">
<p>A connector that is stopped for a long period fails to start, and reports the following exception:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Command failed with error 286 (ChangeStreamHistoryLost): 'PlanExecutor error during aggregation :: caused by :: Resume of change stream was not possible, as the resume point may no longer be in the oplog</pre>
</div>
</div>
<div class="paragraph">
<p>The preceding exception indicates that the entry that corresponds to the connector&#8217;s resume token is no longer present in the oplog.
Because the oplog no longer contains the last offset that the connector processed, the connector cannot resume streaming.</p>
</div>
<div class="paragraph">
<p>You can use either of the following options to recover from the failure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Delete the failed connector, and create a new connector with the same configuration but with a different connector name.</p>
</li>
<li>
<p>Pause the connector and then remove offsets, or change the offset topic.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To help prevent failures related to missing resume tokens, <a href="#mongodb-optimal-oplog-config">optimize configuration of the oplog</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="debezium-mongodb-kafka-connect-process-stops-gracefully"><a class="anchor" href="#debezium-mongodb-kafka-connect-process-stops-gracefully"></a>Kafka Connect process stops gracefully</h3>
<div class="paragraph">
<p>If Kafka Connect is being run in distributed mode, and a Kafka Connect process is stopped gracefully, then prior to shutdown of that processes Kafka Connect will migrate all of the process' connector tasks to another Kafka Connect process in that group, and the new connector tasks will pick up exactly where the prior tasks left off.
There is a short delay in processing while the connector tasks are stopped gracefully and restarted on the new processes.</p>
</div>
<div class="paragraph">
<p>If the group contains only one process and that process is stopped gracefully, then Kafka Connect will stop the connector and record the last offset for each replica set. Upon restart, the replica set tasks will continue exactly where they left off.</p>
</div>
</div>
<div class="sect2">
<h3 id="debezium-mongodb-kafka-connect-process-crashes"><a class="anchor" href="#debezium-mongodb-kafka-connect-process-crashes"></a>Kafka Connect process crashes</h3>
<div class="paragraph">
<p>If the Kafka Connector process stops unexpectedly, then any connector tasks it was running will terminate without recording their most recently-processed offsets.
When Kafka Connect is being run in distributed mode, it will restart those connector tasks on other processes.
However, the MongoDB connectors will resume from the last offset <em>recorded</em> by the earlier processes, which means that the new replacement tasks may generate some of the same change events that were processed just prior to the crash.
The number of duplicate events depends on the offset flush period and the volume of data changes just before the crash.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Because there is a chance that some events may be duplicated during a recovery from failure, consumers should always anticipate some events may be duplicated. Debezium changes are idempotent, so a sequence of events always results in the same state.</p>
</div>
<div class="paragraph">
<p>Debezium also includes with each change event message the source-specific information about the origin of the event, including the MongoDB event&#8217;s unique transaction identifier (<code>h</code>) and timestamp (<code>sec</code> and <code>ord</code>). Consumers can keep track of other of these values to know whether it has already seen a particular event.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="debezium-mongodb-kafka-process-becomes-unavailable"><a class="anchor" href="#debezium-mongodb-kafka-process-becomes-unavailable"></a>Kafka becomes unavailable</h3>
<div class="paragraph">
<p>As the connector generates change events, the Kafka Connect framework records those events in Kafka using the Kafka producer API. Kafka Connect will also periodically record the latest offset that appears in those change events, at a frequency that you have specified in the Kafka Connect worker configuration. If the Kafka brokers become unavailable, the Kafka Connect worker process running the connectors will simply repeatedly attempt to reconnect to the Kafka brokers. In other words, the connector tasks will simply pause until a connection can be reestablished, at which point the connectors will resume exactly where they left off.</p>
</div>
</div>
<div class="sect2">
<h3 id="debezium-mongodb-connector-is-stopped-for-a-long-interval"><a class="anchor" href="#debezium-mongodb-connector-is-stopped-for-a-long-interval"></a>Connector fails after it is stopped for a long interval if <code>snapshot.mode</code> is set to <code>initial</code></h3>
<div class="paragraph">
<p>If the connector is gracefully stopped, users might continue to perform operations on replica set members.
Changes that occur while the connector is offline continue to be recorded in MongoDB&#8217;s oplog.
In most cases, after the connector is restarted, it reads the offset value in the oplog to determine the last operation that it streamed for each replica set, and then resumes streaming changes from that point.
After the restart, database operations that occurred while the connector was stopped are emitted to Kafka as usual, and after some time, the connector catches up with the database.
The amount of time required for the connector to catch up depends on the capabilities and performance of Kafka and the volume of changes that occurred in the database.</p>
</div>
<div class="paragraph">
<p>However, if the connector remains stopped for a long enough interval, it can occur that MongoDB purges the oplog during the time that the connector is inactive, resulting in the loss of information about the connector&#8217;s last position.
After the connector restarts, it cannot resume streaming, because the oplog no longer contains the previous offset value that marks the last operation that the connector processed.
The connector also cannot perform a snapshot, as it typically would when the <code>snapshot.mode</code> property is set to <code>initial</code>, and no offset value is present.
In this case, a mismatch exists, because the oplog does not contain the value of the previous offset, but the offset value is present in the connector&#8217;s internal Kafka offsets topic.
An error results and the connector fails.</p>
</div>
<div class="paragraph">
<p>To recover from the failure, delete the failed connector, and create a new connector with the same configuration but with a different connector name.
When you start the new connector, it performs a snapshot to ingest the state of database, and then resumes streaming.</p>
</div>
</div>
<div class="sect2">
<h3 id="mongodb-crash-results-in-lost-commits"><a class="anchor" href="#mongodb-crash-results-in-lost-commits"></a>MongoDB loses writes</h3>
<div class="paragraph">
<p>In certain failure situations, MongoDB can lose commits, which results in the MongoDB connector being unable to capture the lost changes.
For example, if the primary crashes suddenly after it applies a change and records the change to its oplog, the oplog might become unavailable before secondary nodes can read its contents.
As a result, the secondary node that is elected as the new primary node might be missing the most recent changes from its oplog.</p>
</div>
<div class="paragraph">
<p>At this time, there is no way to prevent this side effect in MongoDB.</p>
</div>
</div>
</div>
</div>
</article>
</div>
<div class="article-cell2">
</div>
</div>

<div id="toc-rightbar"></div>    <footer class="footer">
        <div class="wrapper">
            <div class="copyright">Copyright &copy; 2024 Debezium Community (Rev: <span class="truncated"><a href="https://github.com/debezium/debezium/commit/e502fee0d73b1488e9a32d8f960a5c3ec3cff05c">e502fee0</a></span>)
            
        </div>
    </footer>
</main></div>
<script>
    /* Make sure TOC carets are expanded if sub-elements exist */
    $("#toc").each(function(i,v) {
      $(this).closest('article').addClass('with-toc');
    });

    $("#toc ul.sectlevel1 > li").each(function(i,v) {
      $(this).has("ul").addClass("expanded");
    });

    $(function() {
        /* Expands all the documentation submenus */
        $(".nav-list > .nav-item:not(.is-active) .nav-item-toggle").click();
    });

    /**
     * This checks if a "#toc" element exists in the DOM and if so:
     *
     *  1. Appends a cloned copy of the #toc node to the #toc-rightbar div.
     *  2. Forces the #toc-rightbar div to be visible.
     *  3. Adds the .toc-right class to the #article-wrapper div to restrict the article's overall width.
     */
    var $toc = $("#toc");
    if ( $toc.length ) {
        $("#toc-rightbar").append($toc.clone());
        $("body .main").addClass("with-toc");
    }

    /**
     * In order to make CSS changes that are backward compatible with old adoc files, this applies a version
     * style to the body tag so we can use it to differentiate between CSS styles per version if needed,
     * such as tfoot rows.
     */
    var $version = $("body .nav-container").data("version");
    var $versionClass = "version-" + $version;
    $versionClass = $versionClass.replace('.','-');
    $("body").addClass($versionClass);

    /** A CSS trick to wrap long-width tables in a div that can be scrolled on smaller screens */
    $("table.tableblock").wrap("<div class='table-scroll-wrapper'></div>");

    $(function() {
        /* apply floating scrollbar to the scroll-wrapper */
        $(".table-scroll-wrapper").floatingScrollbar();
    });

</script>
<script src="../../debezium-antora/js/site.js"></script>
<script async src="../../debezium-antora/js/vendor/highlight.js"></script>

<script type="text/javascript">
  var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
  document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
  try {
    var pageTracker = _gat._getTracker("UA-10656779-1");
    pageTracker._trackPageview();
  } catch(err) {}
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-76464546-1', 'auto');
  ga('send', 'pageview');
  ga('set', 'anonymizeIp', true);
  ga('require', 'linkid', 'linkid.js');
</script>
</body>
</html>