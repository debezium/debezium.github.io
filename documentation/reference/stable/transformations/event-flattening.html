<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>New Record State Extraction :: Debezium Documentation</title>
    <link rel="canonical" href="https://debezium.io/documentation/reference/stable/transformations/event-flattening.html">
    <meta name="generator" content="Antora 3.1.7">
<link rel="stylesheet" href="../../../debezium-antora/css/site.css">
<link rel="stylesheet" href="../../../debezium-antora/css/debezium-antora.css">
<link rel="stylesheet" href="../../../debezium-antora/css/highlightjs-dark.css">
<link rel="stylesheet" href="https://static.jboss.org/css/rhbar.css">
<script src="//static.jboss.org/theme/js/libs/jquery/jquery-1.9.1.js"></script>
<script src="../../../debezium-antora/js/jquery.ba-floatingscrollbar.js"></script>
</head>
<body class="article">
<header class="header">
  <div id="rhbar">
      <a class="jbdevlogo" href="https://developers.redhat.com"></a>
      <a class="rhlogo" href="https://www.redhat.com"></a>
  </div>
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="/">
          <img src="/assets/images/color_white_debezium_type_600px.svg" style="height: 32px; margin-right: 14px;"/>
      </a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="/documentation/faq">FAQ</a>
        <a class="navbar-item" href="/documentation">DOCUMENTATION</a>
        <a class="navbar-item" href="/releases">RELEASES</a>
        <a class="navbar-item" href="/community">COMMUNITY</a>
        <a class="navbar-item" href="/blog">BLOG</a>
      </div>
    </div>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="reference" data-version="stable">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Debezium 2.7 Documentation</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Getting Started</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../tutorial.html">Tutorial</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../install.html">Installation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../postgres-plugins.html">PostgreSQL Decoding Plugins</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../architecture.html">Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../features.html">Features</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Configuration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../configuration/avro.html">Avro Serialization</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../configuration/topic-auto-create-config.html">Customizing Topic Auto-Creation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../configuration/signalling.html">Sending Signals to Debezium</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../configuration/notification.html">Receive notifications from Debezium</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Source Connectors</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/index.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/mysql.html">MySQL</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/mariadb.html">MariaDB</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/mongodb.html">MongoDB</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/postgresql.html">PostgreSQL</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/oracle.html">Oracle</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/sqlserver.html">SQL Server</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/db2.html">Db2</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/cassandra.html">Cassandra</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/vitess.html">Vitess</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/spanner.html">Spanner</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/informix.html">Informix</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Sink Connectors</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/index-sink.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/jdbc.html">JDBC</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Transformations</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="topic-routing.html">Topic Routing</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="event-flattening.html">New Record State Extraction</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="mongodb-event-flattening.html">MongoDB New Document State Extraction</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="event-changes.html">Event Changes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="outbox-event-router.html">Outbox Event Router</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="mongodb-outbox-event-router.html">MongoDB Outbox Event Router</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="filtering.html">Message Filtering</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="schema-change-event-filter.html">Schema Change Event Filtering</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="content-based-routing.html">Content-Based Routing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="applying-transformations-selectively.html">Using SMT Predicates to Selectively Apply Transformations</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="partition-routing.html">Partition Routing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="header-to-value.html">HeaderToValue</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="timezone-converter.html">Timezone Converter</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="timescaledb.html">TimescaleDB Integration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="convert-cloudevent-to-saveable-form.html">Convert CloudEvents to Saveable Form</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Post Processors</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../post-processors/index.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../post-processors/reselect-columns.html">Reselect Columns</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">API and SPI</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../development/engine.html">Debezium Engine</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../development/converters.html">Custom Converters</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Integrations</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../integrations/serdes.html">Change Event SerDes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../integrations/outbox.html">Outbox Quarkus Extension</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../integrations/cloudevents.html">CloudEvents</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../integrations/tracing.html">OpenTelemetry</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../integrations/testcontainers.html">Integration Testing with Testcontainers</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Operations</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../operations/debezium-server.html">Debezium Server</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../operations/logging.html">Logging</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../operations/monitoring.html">Monitoring</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../operations/kubernetes.html">Running on Kubernetes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../operations/openshift.html">Running on Openshift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../operations/debezium-ui.html">Debezium UI</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Debezium Documentation</span>
    <span class="version">2.7</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Debezium Documentation</span>
      <ul class="versions">
        <li class="version">
          <a href="/documentation/reference/nightly/index.html">nightly</a>
        </li>
        <li class="version is-current">
          <a href="/documentation/reference/2.7/index.html">2.7</a>
        </li>
        <li class="version">
          <a href="/documentation/reference/3.0/index.html">3.0</a>
        </li>
        <li class="version">
          <a href="/documentation/reference/2.6/index.html">2.6</a>
        </li>
        <li class="version">
          <a href="/documentation/reference/2.5/index.html">2.5</a>
        </li>
        <li class="version">
          <a href="/documentation/reference/2.4/index.html">2.4</a>
        </li>
        <li class="version">
          <a href="/documentation/reference/2.3/index.html">2.3</a>
        </li>
        <li class="version">
          <a href="/documentation/reference/2.2/index.html">2.2</a>
        </li>
        <li class="version">
          <a href="/documentation/reference/2.1/index.html">2.1</a>
        </li>
        <li class="version">
          <a href="/documentation/reference/2.0/index.html">2.0</a>
        </li>
        <li class="version">
          <a href="/documentation/reference/1.9/index.html">1.9</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main role="main" class="main">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Debezium Documentation</a></li>
    <li>Transformations</li>
    <li><a href="event-flattening.html">New Record State Extraction</a></li>
  </ul>
</nav>
    <div class="page-versions-container">
    Version:
    <div class="page-versions">
        <button class="version-menu-toggle versions-menu-current" title="Show other versions of page">2.7</button>
        <div class="version-menu">
                <a class="version" href="/documentation/reference/nightly/index.html">nightly</a>
                <a class="version is-current" href="/documentation/reference/2.7/index.html">2.7</a>
                <a class="version" href="/documentation/reference/3.0/index.html">3.0</a>
                <a class="version" href="/documentation/reference/2.6/index.html">2.6</a>
                <a class="version" href="/documentation/reference/2.5/index.html">2.5</a>
                <a class="version" href="/documentation/reference/2.4/index.html">2.4</a>
                <a class="version" href="/documentation/reference/2.3/index.html">2.3</a>
                <a class="version" href="/documentation/reference/2.2/index.html">2.2</a>
                <a class="version" href="/documentation/reference/2.1/index.html">2.1</a>
                <a class="version" href="/documentation/reference/2.0/index.html">2.0</a>
                <a class="version" href="/documentation/reference/1.9/index.html">1.9</a>
        </div>
        |
    </div>
    </div>
  <div class="edit-this-page"><a href="https://github.com/debezium/debezium/edit/2.7/documentation/modules/ROOT/pages/transformations/event-flattening.adoc">Edit this Page</a></div>
  </div>
<div class="article-grid">
<div class="article-cell1">
<article class="doc">
        
    <!-- This partial is a placeholder -->            <h1 class="page">New Record State Extraction</h1>
        <div id="preamble">
<div class="sectionbody">
<div id="toc" class="toc">
<div id="toctitle" class="title">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_change_event_structure">Change event structure</a></li>
<li><a href="#event-flattening-behavior">Behavior</a></li>
<li><a href="#_configuration">Configuration</a></li>
<li><a href="#_adding_metadata">Adding metadata</a></li>
<li><a href="#options-for-applying-the-event-flattening-transformation-selectively">Options for applying the event-flattening transformation selectively</a></li>
<li><a href="#configuration-options">Configuration options</a></li>
</ul>
</div>
<div class="paragraph">
<p>Debezium connectors emits data change messages to represent each operation that they capture from a source database.
The messages that a connector sends to Apache Kafka have a complex structure that faithfully represent the details of the original database event.</p>
</div>
<div class="paragraph">
<p>Although this complex message format accurately details information about changes that happen in the system, the format might not be suitable for some downstream consumers.
Sink connectors, or other parts of the Kafka ecosystem might require messages that are formatted so that field names and values are presented in a simplified, flattened structure.</p>
</div>
<div class="paragraph">
<p>To simplify the format of the event records that the Debezium connectors produce, you can use the Debezium event flattening single message transformation (SMT).
Configure the transformation to support consumers that require Kafka records to be in a format that is simpler than the default format that that the connector produces.
Depending on your particular use case, you can apply the SMT to a Debezium connector, or to a sink connector that consumes messages that the Debezium connector produces.
To enable Apache Kafka to retain the Debezium change event messages in their original format, configure the SMT for a sink connector.</p>
</div>
<div class="paragraph">
<p>The event flattening transformation is a
<a href="https://kafka.apache.org/documentation/#connect_transforms">Kafka Connect SMT</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The information in this chapter describes the event flattening single message transformation (SMT) for Debezium SQL-based database connectors.
For information about an equivalent SMT for the Debezium MongoDB connector, see <a href="mongodb-event-flattening.html#mongodb-new-document-state-extraction" class="xref page">MongoDB New Document State Extraction</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_change_event_structure"><a class="anchor" href="#_change_event_structure"></a>Change event structure</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Debezium generates data change events that have a complex structure.
Each event consists of three parts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Metadata, which includes but is not limited to:</p>
<div class="ulist">
<ul>
<li>
<p>The type of operation that changed the data.</p>
</li>
<li>
<p>Source information, such as the names of the database and the table in which the change occurred.</p>
</li>
<li>
<p>Timestamp that identifies when the change was made.</p>
</li>
<li>
<p>Optional transaction information.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Row data before the change</p>
</li>
<li>
<p>Row data after the change</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following example shows part of the message structure for an <code>UPDATE</code> change event:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
	"op": "u",
	"source": {
		...
	},
	"ts_ms" : "...",
	"ts_us" : "...",
	"ts_ns" : "...",
	"before" : {
		"field1" : "oldvalue1",
		"field2" : "oldvalue2"
	},
	"after" : {
		"field1" : "newvalue1",
		"field2" : "newvalue2"
	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more information about the change event structure for a connector, see
<a href="../connectors/index.html" class="xref page">the documentation for the connector</a>.</p>
</div>
<div class="paragraph">
<p>After the event flattening SMT processes the message in the previous example, it simplifies the message format, resulting in the message in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
	"field1" : "newvalue1",
	"field2" : "newvalue2"
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="event-flattening-behavior"><a class="anchor" href="#event-flattening-behavior"></a>Behavior</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The event flattening SMT extracts the <code>after</code> field from a Debezium change event in a Kafka record. The SMT replaces the original change event with only its <code>after</code> field to create a simple Kafka record.</p>
</div>
<div class="paragraph">
<p>You can configure the event flattening SMT for a Debezium connector or for a sink connector that consumes messages emitted by a Debezium connector. The advantage of configuring event flattening for a sink connector is that records stored in Apache Kafka contain whole Debezium change events. The decision to apply the SMT to a source or sink connector depends on your particular use case.</p>
</div>
<div class="paragraph">
<p>You can configure the transformation to do any of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add metadata from the change event to the simplified Kafka record. The default behavior is that the SMT does not add metadata.</p>
</li>
<li>
<p>Keep Kafka records that contain change events for <code>DELETE</code> operations in the stream. The default behavior is that the SMT drops Kafka records for <code>DELETE</code> operation change events because most consumers cannot yet handle them.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A database <code>DELETE</code> operation causes Debezium to generate two Kafka records:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A record that contains <code>"op": "d",</code> the <code>before</code> row data, and some other fields.</p>
</li>
<li>
<p>A tombstone record that has the same key as the deleted row and a value of <code>null</code>. This record is a marker for Apache Kafka. It indicates that
<a href="https://kafka.apache.org/documentation/#compaction">log compaction</a> can remove all records that have this key.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Instead of dropping the record that contains the <code>before</code> row data, you can configure the event flattening SMT to do one of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Keep the record in the stream and edit it to have only the <code>"value": "null"</code> field.</p>
</li>
<li>
<p>Keep the record in the stream and edit it to have a <code>value</code> field that contains the key/value pairs that were in the <code>before</code> field with an added <code>"__deleted": "true"</code> entry.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Similarly, instead of dropping the tombstone record, you can configure the event flattening SMT to keep the tombstone record in the stream.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration"><a class="anchor" href="#_configuration"></a>Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Configure the Debezium event flattening SMT in a Kafka Connect source or sink connector by adding the SMT configuration details to your connector&#8217;s configuration.
For example, to obtain the default behavior of the transformation, add it to the connector configuration without specifying any options, as in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">transforms=unwrap,...
transforms.unwrap.type=io.debezium.transforms.ExtractNewRecordState</code></pre>
</div>
</div>
<div class="paragraph">
<p>As with any Kafka Connect connector configuration, you can set <code>transforms=</code> to multiple, comma-separated, SMT aliases in the order in which you want Kafka Connect to apply the SMTs.</p>
</div>
<div class="paragraph">
<p>The following <code>.properties</code> example sets several event flattening SMT options:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">transforms=unwrap,...
transforms.unwrap.type=io.debezium.transforms.ExtractNewRecordState
transforms.unwrap.drop.tombstones=false
transforms.unwrap.delete.handling.mode=rewrite
transforms.unwrap.add.fields=table,lsn</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>drop.tombstones=false</code></dt>
<dd>
<p>Keeps tombstone records for <code>DELETE</code> operations in the event stream.</p>
</dd>
<dt class="hdlist1"><code>delete.handling.mode=rewrite</code></dt>
<dd>
<p>For <code>DELETE</code> operations, edits the Kafka record by flattening the <code>value</code> field that was in the change event. The <code>value</code> field directly contains the key/value pairs that were in the <code>before</code> field. The SMT adds <code>__deleted</code> and sets it to <code>true</code>, for example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">"value": {
  "pk": 2,
  "cola": null,
  "__deleted": "true"
}</code></pre>
</div>
</div>
</dd>
<dt class="hdlist1"><code>add.fields=table,lsn</code></dt>
<dd>
<p>Adds change event metadata for the <code>table</code> and <code>lsn</code> fields to the simplified Kafka record.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<div class="title">Customizing the configuration</div>
<p>The connector might emit many types of event messages (heartbeat messages, tombstone messages, or metadata messages about transactions or schema changes).
To apply the transformation to a subset of events, you can define <a href="#options-for-applying-the-event-flattening-transformation-selectively">an SMT predicate statement that selectively applies the transformation</a> to specific events only.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_adding_metadata"><a class="anchor" href="#_adding_metadata"></a>Adding metadata</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can configure the event flattening SMT to add original change event metadata to the simplified Kafka record.
For example, you might want the simplified record&#8217;s header or value to contain any of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The type of operation that made the change</p>
</li>
<li>
<p>The name of the database or table that was changed</p>
</li>
<li>
<p>Connector-specific fields such as the Postgres LSN field</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more information on what is available see <a href="../connectors/index.html" class="xref page">the documentation for each connector</a>.</p>
</div>
<div class="paragraph">
<p>To add metadata to the simplified Kafka record&#8217;s header, specify the <code>add.headers</code> option.
To add metadata to the simplified Kafka record&#8217;s value, specify the <code>add.fields</code> option.
Each of these options takes a comma separated list of change event field names. Do not specify spaces. When there are duplicate field names, to add metadata for one of those fields, specify the struct as well as the field. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>transforms=unwrap,...
transforms.unwrap.type=io.debezium.transforms.ExtractNewRecordState
transforms.unwrap.add.fields=op,table,lsn,source.ts_ms
transforms.unwrap.add.headers=db
transforms.unwrap.delete.handling.mode=rewrite</pre>
</div>
</div>
<div class="paragraph">
<p>With that configuration, a simplified Kafka record would contain something like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
 ...
	"__op" : "c",
	"__table": "MY_TABLE",
	"__lsn": "123456789",
	"__source_ts_ms" : "123456789",
 ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also, simplified Kafka records would have a <code>__db</code> header.</p>
</div>
<div class="paragraph">
<p>In the simplified Kafka record, the SMT prefixes the metadata field names with a double underscore. When you specify a struct, the SMT also inserts an underscore between the struct name and the field name.</p>
</div>
<div class="paragraph">
<p>To add metadata to a simplified Kafka record that is for a <code>DELETE</code> operation, you must also configure <code>delete.handling.mode=rewrite</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="options-for-applying-the-event-flattening-transformation-selectively"><a class="anchor" href="#options-for-applying-the-event-flattening-transformation-selectively"></a>Options for applying the event-flattening transformation selectively</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In addition to the change event messages that a Debezium connector emits when a database change occurs, the connector also emits other types of messages, including heartbeat messages, and metadata messages about schema changes and transactions.
Because the structure of these other messages differs from the structure of the change event messages that the SMT is designed to process, it&#8217;s best to configure the connector to selectively apply the SMT, so that it processes only the intended data change messages.</p>
</div>
<div class="paragraph">
<p>For more information about how to apply the SMT selectively, see <a href="applying-transformations-selectively.html#applying-the-event-flattening-transformation-selectively" class="xref page">Configure an SMT predicate for the transformation</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuration-options"><a class="anchor" href="#configuration-options"></a>Configuration options</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following table describes the options that you can specify to configure the event flattening SMT.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Descriptions of event flattening SMT configuration options</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 25%;">
<col style="width: 45%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Option</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="extract-new-record-state-drop-tombstones"></a><a href="#extract-new-record-state-drop-tombstones"><code>drop.tombstones</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>true</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Debezium generates a tombstone record for each <code>DELETE</code> operation. The default behavior is that event flattening SMT removes tombstone records from the stream. To keep tombstone records in the stream, specify <code>drop.tombstones=false</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This option is scheduled for removal in a future release.
In its place, use the <a href="#extract-new-record-state-delete-tombstone-handling-mode"><code>delete.tombstone.handling.mode</code></a> option.</p>
</div>
</td>
</tr>
</table>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="extract-new-record-state-delete-handling-mode"></a><a href="#extract-new-record-state-delete-handling-mode"><code>delete.handling&#8203;.mode</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>drop</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Debezium generates a change event record for each <code>DELETE</code> operation. The default behavior is that event flattening SMT removes these records from the stream. To keep Kafka records for <code>DELETE</code> operations in the stream, set <code>delete.handling.mode</code> to <code>none</code> or <code>rewrite</code>.<br>
<br>
Specify <code>none</code> to keep the change event record in the stream. The record contains only <code>"value": "null"</code>. <br>
<br>
Specify <code>rewrite</code> to keep the change event record in the stream and edit the record to have a <code>value</code> field that contains the key/value pairs that were in the <code>before</code> field and also add <code>__deleted: true</code> to the <code>value</code>. This is another way to indicate that the record has been deleted.<br>
<br>
When you  specify <code>rewrite</code>, the updated simplified records for <code>DELETE</code> operations might be all you need to track deleted records. You can consider accepting the default behavior of dropping the tombstone records that the Debezium connector creates.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This option is scheduled for removal in a future release.
In its place, use the <a href="#extract-new-record-state-delete-tombstone-handling-mode"><code>delete.tombstone.handling.mode</code></a> option.</p>
</div>
</td>
</tr>
</table>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="extract-new-record-state-delete-tombstone-handling-mode"></a><a href="#extract-new-record-state-delete-tombstone-handling-mode"><code>delete.tombstone.handling.mode</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>No default</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Debezium generates a change event record for each <code>DELETE</code> operation. This setting determines how the event flattening SMT handles <code>DELETE</code> events from the stream.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The setting for this option takes precedence over any conflicting settings that you might configure for the deprecated <a href="#extract-new-record-state-drop-tombstones"><code>drop.tombstones</code></a> or <a href="#extract-new-record-state-delete-handling-mode"><code>delete.handling.mode</code></a> options.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Set one of the following options:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>drop</code></dt>
<dd>
<p>The SMT removes both the <code>DELETE</code> event and <code>TOMBSTONE</code> from the stream.</p>
</dd>
<dt class="hdlist1"><code>tombstone</code> (default)</dt>
<dd>
<p>The SMT retains <code>TOMBSTONE</code> records in the stream.
The <code>TOMBSTONE</code> record contains only the following value: <code>"value": "null"</code>.</p>
</dd>
<dt class="hdlist1"><code>rewrite</code></dt>
<dd>
<p>The SMT retains the change event record in the stream and makes the following changes:</p>
<div class="ulist">
<ul>
<li>
<p>Adds a <code>value</code> field to the record that contains the key/value pairs from the <code>before</code> field of the original record.</p>
</li>
<li>
<p>Adds <code>__deleted: true</code> to the <code>value</code> of the record.</p>
</li>
<li>
<p>Removes <code>TOMBSTONE</code> records.</p>
<div class="paragraph">
<p>This setting provides another way to indicate that the record has been deleted.</p>
</div>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1"><code>rewrite-with-tombstone</code></dt>
<dd>
<p>The SMT behaves as it does when you select the <code>rewrite</code> option, except that it also retains <code>TOMBSTONE</code> records.</p>
</dd>
</dl>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="extract-new-record-state-route-by-field"></a><a href="#extract-new-record-state-route-by-field"><code>route.by.field</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>To use row data to determine the topic to route the record to, set this option to an <code>after</code> field attribute. The SMT routes the record to the topic whose name matches the value of the specified <code>after</code> field attribute. For a <code>DELETE</code> operation, set this option to a <code>before</code> field attribute.<br>
<br>
For example, configuration of <code>route.by.field=destination</code> routes records to the topic whose name is the value of <code>after.destination</code>. The default behavior is that a Debezium connector sends each change event record to a topic whose name is formed from the name of the database and the name of the table in which the change was made.<br>
<br>
If you are configuring the event flattening SMT on a sink connector, setting this option might be useful when the destination topic name dictates the name of the database table that will be updated with the simplified change event record. If the topic name is not correct for your use case, you can configure <code>route.by.field</code> to re-route the event.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="extract-new-record-state-add-fields-prefix"></a><a href="#extract-new-record-state-add-fields-prefix"><code>add.fields.prefix</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>__ (double-underscore)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Set this optional string to prefix a field.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="extract-new-record-state-add-fields"></a><a href="#extract-new-record-state-add-fields"><code>add.fields</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Set this option to a comma-separated list, with no spaces, of metadata fields to add to the simplified Kafka record&#8217;s value. When there are duplicate field names, to add metadata for one of those fields, specify the struct as well as the field, for example <code>source.ts_ms</code>.<br>
<br>
Optionally, you can override the field name via <code>&lt;field name&gt;:&lt;new field name&gt;</code>, e.g. like so: new field name like <code>version:VERSION, connector:CONNECTOR, source.ts_ms:EVENT_TIMESTAMP</code>. Please note that the <code>new field name</code> is case-sensitive.<br>
<br>
When the SMT adds metadata fields to the simplified record&#8217;s value, it prefixes each metadata field name with a double underscore. For a struct specification, the SMT also inserts an underscore between the struct name and the field name.<br>
<br>
If you specify a field that is not in the change event record, the SMT still adds the field to the record&#8217;s value.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="extract-new-record-state-add-headers-prefix"></a><a href="#extract-new-record-state-add-headers-prefix"><code>add.headers.prefix</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>__ (double-underscore)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Set this optional string to prefix a header.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="extract-new-record-state-add-headers"></a><a href="#extract-new-record-state-add-headers"><code>add.headers</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Set this option to a comma-separated list, with no spaces, of metadata fields to add to the header of the simplified Kafka record. When there are duplicate field names, to add metadata for one of those fields, specify the struct as well as the field, for example <code>source.ts_ms</code>.<br>
<br>
Optionally, you can override the field name via <code>&lt;field name&gt;:&lt;new field name&gt;</code>, e.g. like so: new field name like <code>version:VERSION, connector:CONNECTOR, source.ts_ms:EVENT_TIMESTAMP</code>. Please note that the <code>new field name</code> is case-sensitive.<br>
<br>
When the SMT adds metadata fields to the simplified record&#8217;s header, it prefixes each metadata field name with a double underscore. For a struct specification, the SMT also inserts an underscore between the struct name and the field name.<br>
<br>
If you specify a field that is not in the change event record, the SMT does not add the field to the header.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="extract-new-record-state-drop-fields-header-name"></a><a href="#extract-new-record-state-drop-fields-header-name"><code>drop.fields.header.name</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The Kafka message header name to use for listing field names in the source message that you want to drop from the output message.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="extract-new-record-state-drop-fields-from-key"></a><a href="#extract-new-record-state-drop-fields-from-key"><code>drop.fields.from.key</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>false</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Specifies whether you want the SMT to remove fields that are listed in <code>drop.fields.header.name</code> from the event&#8217;s key.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="extract-new-record-state-drop-fields-keep-schema-compatible"></a><a href="#extract-new-record-state-drop-fields-keep-schema-compatible"><code>drop.fields.keep.schema.compatible</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>true</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Specifies whether you want the SMT to remove non-optional fields that are included in the <a href="#extract-new-record-state-drop-fields-header-name"><code>drop.fields.header.name</code></a> configuration property.<br>
<br>
By default, the SMT only removes fields that are marked <code>optional</code>.</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
</article>
</div>
<div class="article-cell2">
</div>
</div>

<div id="toc-rightbar"></div>    <footer class="footer">
        <div class="wrapper">
            <div class="copyright">Copyright &copy; 2024 Debezium Community (Rev: <span class="truncated"><a href="https://github.com/debezium/debezium/commit/9a9b208fd613ac4d195337da3c3e356f4ff21973">9a9b208f</a></span>)
            
        </div>
    </footer>
</main></div>
<script>
    /* Make sure TOC carets are expanded if sub-elements exist */
    $("#toc").each(function(i,v) {
      $(this).closest('article').addClass('with-toc');
    });

    $("#toc ul.sectlevel1 > li").each(function(i,v) {
      $(this).has("ul").addClass("expanded");
    });

    $(function() {
        /* Expands all the documentation submenus */
        $(".nav-list > .nav-item:not(.is-active) .nav-item-toggle").click();
    });

    /**
     * This checks if a "#toc" element exists in the DOM and if so:
     *
     *  1. Appends a cloned copy of the #toc node to the #toc-rightbar div.
     *  2. Forces the #toc-rightbar div to be visible.
     *  3. Adds the .toc-right class to the #article-wrapper div to restrict the article's overall width.
     */
    var $toc = $("#toc");
    if ( $toc.length ) {
        $("#toc-rightbar").append($toc.clone());
        $("body .main").addClass("with-toc");
    }

    /**
     * In order to make CSS changes that are backward compatible with old adoc files, this applies a version
     * style to the body tag so we can use it to differentiate between CSS styles per version if needed,
     * such as tfoot rows.
     */
    var $version = $("body .nav-container").data("version");
    var $versionClass = "version-" + $version;
    $versionClass = $versionClass.replace('.','-');
    $("body").addClass($versionClass);

    /** A CSS trick to wrap long-width tables in a div that can be scrolled on smaller screens */
    $("table.tableblock").wrap("<div class='table-scroll-wrapper'></div>");

    $(function() {
        /* apply floating scrollbar to the scroll-wrapper */
        $(".table-scroll-wrapper").floatingScrollbar();
    });

</script>
<script src="../../../debezium-antora/js/site.js"></script>
<script async src="../../../debezium-antora/js/vendor/highlight.js"></script>

<script type="text/javascript">
  var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
  document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
  try {
    var pageTracker = _gat._getTracker("UA-10656779-1");
    pageTracker._trackPageview();
  } catch(err) {}
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-76464546-1', 'auto');
  ga('send', 'pageview');
  ga('set', 'anonymizeIp', true);
  ga('require', 'linkid', 'linkid.js');
</script>
</body>
</html>