<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MongoDB New Document State Extraction :: Debezium Documentation</title>
    <link rel="canonical" href="https://debezium.io/documentation/reference/stable/transformations/mongodb-event-flattening.html">
    <meta name="generator" content="Antora 3.1.7">
<link rel="stylesheet" href="../../../debezium-antora/css/site.css">
<link rel="stylesheet" href="../../../debezium-antora/css/debezium-antora.css">
<link rel="stylesheet" href="../../../debezium-antora/css/highlightjs-dark.css">
<link rel="stylesheet" href="https://static.jboss.org/css/rhbar.css">
<script src="//static.jboss.org/theme/js/libs/jquery/jquery-1.9.1.js"></script>
<script src="../../../debezium-antora/js/jquery.ba-floatingscrollbar.js"></script>
</head>
<body class="article">
<header class="header">
  <div id="rhbar">
      <a class="jbdevlogo" href="https://developers.redhat.com"></a>
      <a class="rhlogo" href="https://www.redhat.com"></a>
  </div>
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="/">
          <img src="/assets/images/color_white_debezium_type_600px.svg" style="height: 32px; margin-right: 14px;"/>
      </a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="/documentation/faq">FAQ</a>
        <a class="navbar-item" href="/documentation">DOCUMENTATION</a>
        <a class="navbar-item" href="/releases">RELEASES</a>
        <a class="navbar-item" href="/community">COMMUNITY</a>
        <a class="navbar-item" href="/blog">BLOG</a>
      </div>
    </div>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="reference" data-version="stable">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Debezium 2.7 Documentation</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Getting Started</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../tutorial.html">Tutorial</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../install.html">Installation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../postgres-plugins.html">PostgreSQL Decoding Plugins</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../architecture.html">Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../features.html">Features</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Configuration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../configuration/avro.html">Avro Serialization</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../configuration/topic-auto-create-config.html">Customizing Topic Auto-Creation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../configuration/signalling.html">Sending Signals to Debezium</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../configuration/notification.html">Receive notifications from Debezium</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Source Connectors</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/index.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/mysql.html">MySQL</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/mariadb.html">MariaDB</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/mongodb.html">MongoDB</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/postgresql.html">PostgreSQL</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/oracle.html">Oracle</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/sqlserver.html">SQL Server</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/db2.html">Db2</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/cassandra.html">Cassandra</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/vitess.html">Vitess</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/spanner.html">Spanner</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/informix.html">Informix</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Sink Connectors</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/index-sink.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connectors/jdbc.html">JDBC</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Transformations</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="topic-routing.html">Topic Routing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="event-flattening.html">New Record State Extraction</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="mongodb-event-flattening.html">MongoDB New Document State Extraction</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="event-changes.html">Event Changes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="outbox-event-router.html">Outbox Event Router</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="mongodb-outbox-event-router.html">MongoDB Outbox Event Router</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="filtering.html">Message Filtering</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="schema-change-event-filter.html">Schema Change Event Filtering</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="content-based-routing.html">Content-Based Routing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="applying-transformations-selectively.html">Using SMT Predicates to Selectively Apply Transformations</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="partition-routing.html">Partition Routing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="header-to-value.html">HeaderToValue</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="timezone-converter.html">Timezone Converter</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="timescaledb.html">TimescaleDB Integration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="convert-cloudevent-to-saveable-form.html">Convert CloudEvents to Saveable Form</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Post Processors</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../post-processors/index.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../post-processors/reselect-columns.html">Reselect Columns</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">API and SPI</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../development/engine.html">Debezium Engine</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../development/converters.html">Custom Converters</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Integrations</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../integrations/serdes.html">Change Event SerDes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../integrations/outbox.html">Outbox Quarkus Extension</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../integrations/cloudevents.html">CloudEvents</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../integrations/tracing.html">OpenTelemetry</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../integrations/testcontainers.html">Integration Testing with Testcontainers</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Operations</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../operations/debezium-server.html">Debezium Server</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../operations/logging.html">Logging</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../operations/monitoring.html">Monitoring</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../operations/kubernetes.html">Running on Kubernetes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../operations/openshift.html">Running on Openshift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../operations/debezium-ui.html">Debezium UI</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Debezium Documentation</span>
    <span class="version">2.7</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Debezium Documentation</span>
      <ul class="versions">
        <li class="version">
          <a href="/documentation/reference/nightly/index.html">nightly</a>
        </li>
        <li class="version is-current">
          <a href="/documentation/reference/2.7/index.html">2.7</a>
        </li>
        <li class="version">
          <a href="/documentation/reference/3.0/index.html">3.0</a>
        </li>
        <li class="version">
          <a href="/documentation/reference/2.6/index.html">2.6</a>
        </li>
        <li class="version">
          <a href="/documentation/reference/2.5/index.html">2.5</a>
        </li>
        <li class="version">
          <a href="/documentation/reference/2.4/index.html">2.4</a>
        </li>
        <li class="version">
          <a href="/documentation/reference/2.3/index.html">2.3</a>
        </li>
        <li class="version">
          <a href="/documentation/reference/2.2/index.html">2.2</a>
        </li>
        <li class="version">
          <a href="/documentation/reference/2.1/index.html">2.1</a>
        </li>
        <li class="version">
          <a href="/documentation/reference/2.0/index.html">2.0</a>
        </li>
        <li class="version">
          <a href="/documentation/reference/1.9/index.html">1.9</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main role="main" class="main">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Debezium Documentation</a></li>
    <li>Transformations</li>
    <li><a href="mongodb-event-flattening.html">MongoDB New Document State Extraction</a></li>
  </ul>
</nav>
    <div class="page-versions-container">
    Version:
    <div class="page-versions">
        <button class="version-menu-toggle versions-menu-current" title="Show other versions of page">2.7</button>
        <div class="version-menu">
                <a class="version" href="/documentation/reference/nightly/index.html">nightly</a>
                <a class="version is-current" href="/documentation/reference/2.7/index.html">2.7</a>
                <a class="version" href="/documentation/reference/3.0/index.html">3.0</a>
                <a class="version" href="/documentation/reference/2.6/index.html">2.6</a>
                <a class="version" href="/documentation/reference/2.5/index.html">2.5</a>
                <a class="version" href="/documentation/reference/2.4/index.html">2.4</a>
                <a class="version" href="/documentation/reference/2.3/index.html">2.3</a>
                <a class="version" href="/documentation/reference/2.2/index.html">2.2</a>
                <a class="version" href="/documentation/reference/2.1/index.html">2.1</a>
                <a class="version" href="/documentation/reference/2.0/index.html">2.0</a>
                <a class="version" href="/documentation/reference/1.9/index.html">1.9</a>
        </div>
        |
    </div>
    </div>
  <div class="edit-this-page"><a href="https://github.com/debezium/debezium/edit/2.7/documentation/modules/ROOT/pages/transformations/mongodb-event-flattening.adoc">Edit this Page</a></div>
  </div>
<div class="article-grid">
<div class="article-cell1">
<article class="doc">
        
    <!-- This partial is a placeholder -->            <h1 class="page">MongoDB New Document State Extraction</h1>
        <div id="preamble">
<div class="sectionbody">
<div id="toc" class="toc">
<div id="toctitle" class="title">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_change_event_structure">Change event structure</a></li>
<li><a href="#event-flattening-behavior">Behavior</a></li>
<li><a href="#mongodb-event-flattening-configuration">Configuration</a>
<ul class="sectlevel2">
<li><a href="#mongodb-event-flattening-basic-configuration">Basic configuration</a></li>
</ul>
</li>
<li><a href="#mongodb-event-flattening-array-encoding">Array encoding</a></li>
<li><a href="#flattening-nested-structures-in-a-mongodb-event-message">Nested structure flattening</a></li>
<li><a href="#mongodb-$unset-handling">MongoDB <code>$unset</code> handling</a></li>
<li><a href="#mongodb-event-flattening-determining-the-type-of-the-original-database-operation">Determine original operation</a></li>
<li><a href="#_adding_metadata_fields">Adding metadata fields</a></li>
<li><a href="#options-for-applying-the-transformation-selectively">Options for applying the transformation selectively</a></li>
<li><a href="#mongodb-extract-new-record-state-configuration-options">Configuration options</a></li>
<li><a href="#debezium-event-flattening-smt-for-mongodb-known-limitations">Known limitations</a></li>
</ul>
</div>
<div class="paragraph">
<p>The Debezium MongoDB connector emits data change messages to represent each operation that occurs in a MongoDB collection.
The complex structure of these event messages faithfully represent the details of the original database event.
However, some downstream consumers might not be able to process the messages in their original format.
For example, to represent nested documents in a data collection, the connector emits an event message in a format that includes nested fields.
To support sink connectors, or other consumers that cannot process the hierarchical format of the original messages, you can use the Debezium MongoDB event flattening (ExtractNewDocumentState) single message transformation (SMT).
The SMT simplifies the structure of the original messages, and can modify messages in other ways to make data easier to process.</p>
</div>
<div class="paragraph">
<p>The event flattening transformation is a <a href="https://kafka.apache.org/documentation/#connect_transforms">Kafka Connect SMT</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The information in this chapter describes the event flattening single message transformation (SMT) for Debezium MongoDB connectors only.
For information about an equivalent SMT for use with relational databases, see the <a href="event-flattening.html#new-record-state-extraction" class="xref page">documentation for the New Record State Extraction SMT</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_change_event_structure"><a class="anchor" href="#_change_event_structure"></a>Change event structure</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Debezium MongoDB connector generates change events that have a complex structure.
Each event message includes the following parts:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Source metadata</dt>
<dd>
<p>Includes, but is not limited to the following fields:</p>
<div class="ulist">
<ul>
<li>
<p>Type of the operation that changed data in the collection (create/insert, update, or delete).</p>
</li>
<li>
<p>Name of the database and collection in which the change occurred.</p>
</li>
<li>
<p>Timestamp that identifies when the change was made.</p>
</li>
<li>
<p>Optional transaction information.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Document data</dt>
<dd>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>before</code> data</dt>
<dd>
<p>This field is present in environments that run MongoDB 6.0 and later when the <code>capture.mode</code> for the Debezium connector is set to one of the following values:</p>
<div class="ulist">
<ul>
<li>
<p><code>change_streams_with_pre_image</code>.</p>
</li>
<li>
<p><code>change_streams_update_full_with_pre_image</code>.</p>
<div class="paragraph">
<p>For more information, see <a href="../connectors/mongodb.html#mongodb-pre-image-support" class="xref page">MongoDB pre-image support</a></p>
</div>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1"><code>after</code> data</dt>
<dd>
<p>JSON strings that represent the values that are present in a document after the current operation.
The presence of an <code>after</code> field in an event message depends on the type of event and the connector configuration.
A <code>create</code> event for a MongoDB <code>insert</code> operation always contain an <code>after</code> field, regardless of the <code>capture.mode</code> setting.
For <code>update</code> events, the <code>after</code> field is present only when <code>capture.mode</code> is set to one of the following values:</p>
<div class="ulist">
<ul>
<li>
<p><code>change_streams_update_full</code></p>
</li>
<li>
<p><code>change_streams_update_full_with_pre_image</code>.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>after</code> value in a change event message does not necessarily represent the state of a document immediately following the event.
The value is not calculated dynamically; instead, after the connector captures a change event, it  queries the collection to retrieve the current value of the document.</p>
</div>
<div class="paragraph">
<p>For example, imagine a situation in which multiple operations, <code>a</code>, <code>b</code>, and <code>c</code> modify a document in quick succession.
When the connector processes, change <code>a</code>, it queries the collection for the full document.
In the meantime, changes <code>b</code> and <code>c</code> occur.
When the connector receives a response to its query for the full document for change <code>a</code>, it might receive a version of the document that is based on the subsequent changes for <code>b</code> or <code>c</code>.
For more information, see the documentation for the <a href="../connectors/mongodb.html#mongodb-property-capture-mode" class="xref page"><code>capture.mode</code></a> property.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The following fragment shows the basic structure of a <code>create</code> change event that the connector emits after a MongoDB <code>insert</code> operation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "op": "c",
  "after": "{\"field1\":\"newvalue1\",\"field2\":\"newvalue1\"}",
  "source": { ... }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The complex format of the <code>after</code> field in the preceding example provides detailed information about changes that occur in the source database.
However, some consumers cannot process messages that contain nested values.
To convert the complex nested fields of the original message into a simpler, more universally compatible structure, use the event flattening SMT for MongoDB.
The SMT flattens the structure of nested fields in a message, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "field1" : "newvalue1",
  "field2" : "newvalue2"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more information about the default structure of messages produced by the Debezium MongoDB connector, see the <a href="../connectors/mongodb.html#debezium-connector-for-mongodb" class="xref page">connector documentation</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="event-flattening-behavior"><a class="anchor" href="#event-flattening-behavior"></a>Behavior</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The event flattening SMT for MongoDB extracts the <code>after</code> field from <code>create</code> or <code>update</code> change event messages emitted by the Debezium MongoDB connector.
After the SMT processes the original change event message, it generates a simplified version that contains only the contents of the <code>after</code> field.</p>
</div>
<div class="paragraph">
<p>Depending on your use case, you can apply the ExtractNewDocumentState SMT to the Debezium MongoDB connector, or to a sink connector that consumes messages that the Debezium connector produces.
If you apply the SMT to the Debezium MongoDB connector, the SMT modifies messages that the connector emits before they are sent to Apache Kafka.
To ensure that Kafka retains the complete Debezium change event message in its original format, apply the SMT to a sink connector.</p>
</div>
<div class="paragraph">
<p>When you use the event flattening SMT to process a message emitted from a MongoDB connector, the SMT converts the structure of the records in the original message into properly typed Kafka Connect records that can be consumed by a typical sink connector.
For example, the SMT converts the JSON strings that represent the <code>after</code> information in the original message into schema structures that any consumer can process.</p>
</div>
<div class="paragraph">
<p>Optionally, you can configure the event flattening SMT for MongoDB to modify messages in other ways during processing.
For more information, see the <a href="#mongodb-event-flattening-configuration">configuration topic</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mongodb-event-flattening-configuration"><a class="anchor" href="#mongodb-event-flattening-configuration"></a>Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Configure the event flattening (ExtractNewDocumentState) SMT for MongoDB for sink connectors that consume the messages emitted by the Debezium MongoDB connector.</p>
</div>
<div class="sect2">
<h3 id="mongodb-event-flattening-basic-configuration"><a class="anchor" href="#mongodb-event-flattening-basic-configuration"></a>Basic configuration</h3>
<div class="paragraph">
<p>To obtain the default behavior of the SMT, add the SMT to the configuration of a sink connector without specifying any options, as in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">transforms=unwrap,...
transforms.unwrap.type=io.debezium.connector.mongodb.transforms.ExtractNewDocumentState</code></pre>
</div>
</div>
<div class="paragraph">
<p>As with any Kafka Connect connector configuration, you can set <code>transforms=</code> to multiple, comma-separated, SMT aliases.
Kafka Connect applies the transformations that you specify in the order in which they are listed.</p>
</div>
<div class="paragraph">
<p>You can set multiple options for a connector that uses the MongoDB event flattening SMT.
The following example shows a configuration that sets the <a href="#mongodb-extract-new-record-state-drop-tombstones"><code>drop.tombstones</code></a>, <a href="#mongodb-extract-new-record-state-delete-handling-mode"><code>delete.handling.mode</code></a>, and <a href="#mongodb-extract-new-record-state-add-headers"><code>add.headers</code></a> options for a connector:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">transforms=unwrap,...
transforms.unwrap.type=io.debezium.connector.mongodb.transforms.ExtractNewDocumentState
transforms.unwrap.drop.tombstones=false
transforms.unwrap.delete.handling.mode=drop
transforms.unwrap.add.headers=op</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more information about the configuration options in the preceding example, see the <a href="#mongodb-extract-new-record-state-configuration-options">configuration topic</a>.</p>
</div>
<div class="paragraph">
<div class="title">Customizing the configuration</div>
<p>The connector might emit many types of event messages (for example, heartbeat messages, tombstone messages, or metadata messages about transactions).
To apply the transformation to a subset of events, you can define <a href="#options-for-applying-the-transformation-selectively">an SMT predicate statement that selectively applies the transformation</a> to specific events only.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mongodb-event-flattening-array-encoding"><a class="anchor" href="#mongodb-event-flattening-array-encoding"></a>Array encoding</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By default, the event flattening SMT converts MongoDB arrays into arrays that are compatible with Apache Kafka Connect, or Apache Avro schemas.
While MongoDB arrays can contain multiple types of elements, all elements in a Kafka array must be of the same type.</p>
</div>
<div class="paragraph">
<p>To ensure that the SMT encodes arrays in a way that meets the needs of your environment, you can specify the <a href="#mongodb-extract-new-record-state-array-encoding"><code>array.encoding</code></a> configuration option.
The following example shows the configuration for setting the array encoding:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">transforms=unwrap,...
transforms.unwrap.type=io.debezium.connector.mongodb.transforms.ExtractNewDocumentState
transforms.unwrap.array.encoding=&lt;array|document&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Depending on the configuration, the SMT processes each instance of an array in the source message by using one of the following encoding methods:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">array encoding</dt>
<dd>
<p>If <code>array.encoding</code> is set to <code>array</code> (the default), the SMT encodes uses the <code>array</code> datatype to encode arrays in the original message.
To ensure correct processing, all elements in an array instance must be of the same type.
This option is a restricting one, but it enables downstream clients to easily process arrays.</p>
</dd>
<dt class="hdlist1">document encoding</dt>
<dd>
<p>If <code>array.encoding</code> is set to <code>document</code>, the SMT converts each array in the source into a <strong>struct</strong> of <strong>structs</strong>, in a manner that is similar to <a href="http://bsonspec.org/">BSON serialization</a>.
The main <strong>struct</strong> contains fields named <code>_0</code>, <code>_1</code>, <code>_2</code>, and so on, where each field name represents the index of an element in the original array.
The SMT populates each of these index fields with the values that it retrieves for the equivalent element in the source array.
Index names are prefixed with underscores, because Avro encoding prohibits field names that begin with a numeric character.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The following example shows how the Debezium MongoDB connector represents a database document that contains an array that includes heterogeneous data types:</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. Example: Document encoding of an array that contains multiple data types</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "_id": 1,
    "a1": [
        {
            "a": 1,
            "b": "none"
        },
        {
            "a": "c",
            "d": "something"
        }
    ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the <code>array.encoding</code> is set to <code>document</code>, the SMT converts the preceding document into the following format:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "_id": 1,
    "a1": {
        "_0": {
            "a": 1,
            "b": "none"
        },
        "_1": {
            "a": "c",
            "d": "something"
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>document</code> encoding option enables the SMT to process arbitrary arrays that are comprised of heterogeneous elements.
However, before you use this option, always verify that the sink connector and other downstream consumers are capable of processing arrays that contain multiple data types.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="flattening-nested-structures-in-a-mongodb-event-message"><a class="anchor" href="#flattening-nested-structures-in-a-mongodb-event-message"></a>Nested structure flattening</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When a database operation involves an embedded document, the Debezium MongoDB connector emits a Kafka event record that has a structure that reflects the hierarchical structure of the original document.
That is, the event message represents nested documents as a set of nested field structure.
In environments where downstream connectors cannot process messages that contain nested structures, you can configure the event flattening SMT to flatten hierarchical structures in the message.
A flat message structure is better suited to table-like storage.</p>
</div>
<div class="paragraph">
<p>To configure the SMT to flatten nested structures, set the <a href="#mongodb-extract-new-record-state-flatten-struct"><code>flatten.struct</code></a> configuration option to <code>true</code>.
In the converted message, field names are constructed to be consistent with the document source.
The SMT renames each flattened field by concatenating the name of the parent document field with the name of the nested document field.
A delimiter that is defined by the <a href="#mongodb-extract-new-record-state-flatten-struct-delimiter"><code>flatten.struct.delimiter</code></a> option separates the components of the name.
The default value of <code>struct.delimiter</code> is an underscore character (<code>_</code>).</p>
</div>
<div class="paragraph">
<p>The following example shows the configuration for specifying whether the SMT flattens nested structures:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">transforms=unwrap,...
transforms.unwrap.type=io.debezium.connector.mongodb.transforms.ExtractNewDocumentState
transforms.unwrap.flatten.struct=&lt;true|false&gt;
transforms.unwrap.flatten.struct.delimiter=&lt;string&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following example shows an event message that is emitted by the MongoDB connector.
The message includes a field for a document <code>a</code> that contains fields for two nested documents, <code>b</code> and <code>c</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "_id": 1,
    "a": {
            "b": 1,
            "c": "none"
    },
    "d": 100
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The message in the following example shows the output after the SMT for MongoDB flattens the nested structures in the preceding message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "_id": 1,
    "a_b": 1,
    "a_c": "none",
    "d": 100
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the resulting message, the <code>b</code> and <code>c</code> fields that were nested in the original message are flattened and renamed.
The renamed fields are formed by concatenating the name of the parent document <code>a</code> with the names of the nested documents: <code>a_b</code> and <code>a_c</code>.
The components of the new field names are separated by an underscore character, as defined by the setting of the <a href="#mongodb-extract-new-record-state-flatten-struct-delimiter"><code>struct.delimiter</code></a> configuration property,</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mongodb-$unset-handling"><a class="anchor" href="#mongodb-$unset-handling"></a>MongoDB <code>$unset</code> handling</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In MongoDB, the <code>$unset</code> operator and the <code>$rename</code> operator both remove fields from a document.
Because MongoDB collections are schemaless, after an update removes fields from a document, it&#8217;s not possible to infer the name of the missing field from the updated document.
To support sink connectors or other consumers that might require information about removed fields, Debezium emits update messages that include a <code>removedFields</code> element that lists the names of the deleted fields.</p>
</div>
<div class="paragraph">
<p>The following example shows part of an update message for an operation that results in the removal of the field <code>a</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">"payload": {
  "op": "u",
  "ts_ms": "...",
  "ts_us" : "...",
  "ts_ns" : "...",
  "before": "{ ... }",
  "after": "{ ... }",
  "updateDescription": {
    "removedFields": ["a"],
    "updatedFields": null,
    "truncatedArrays": null
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the preceding example, the <code>before</code> and <code>after</code> represent the state of the source document before and after the document was updated.
These fields are present in the event message that a connector emits only if the <code>capture.mode</code> for the connector is set as described in the following list:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>before</code> field</dt>
<dd>
<p>Provides the state of the document before the change.
This field is present only when <code>capture.mode</code> is set to one of the following values:</p>
<div class="ulist">
<ul>
<li>
<p><code>change_streams_with_pre_image</code></p>
</li>
<li>
<p><code>change_streams_update_full_with_pre_image</code>.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1"><code>after</code> field</dt>
<dd>
<p>Provides the full state of the document after a change.
This field is present only when <code>capture.mode</code> is set to one of the following values:</p>
<div class="ulist">
<ul>
<li>
<p><code>change_streams_update_full</code></p>
</li>
<li>
<p><code>change_streams_update_full_with_pre_image</code>.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Assuming a connector that is configured to capture full documents, when the <code>ExtractNewDocumentState</code> SMT receives an <code>update</code> message for an <code>$unset</code> event, the SMT re-encodes the message by representing the removed field has a <code>null</code> value, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "id": 1,
    "a": null
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For connectors that are not configured to capture full documents, when the SMT receives an update event for an <code>$unset</code> operation, it produces the following output message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
   "a": null
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mongodb-event-flattening-determining-the-type-of-the-original-database-operation"><a class="anchor" href="#mongodb-event-flattening-determining-the-type-of-the-original-database-operation"></a>Determine original operation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>After the SMT flattens an event message, the resulting message no longer indicates whether the operation that generated the event was of type <code>create</code>, <code>update</code> or initial snapshot <code>read</code>.
Typically, you can identify <code>delete</code> operations by configuring the connectors to expose information about the tombstone or rewrite events that accompany a deletion.
For more information about configuring the connector to expose information about tombstones and rewrites in event messages, see the <a href="#mongodb-extract-new-record-state-drop-tombstones"><code>drop.tombstones</code></a> and <a href="#mongodb-extract-new-record-state-delete-handling-mode"><code>delete.handling.mode</code></a> properties.</p>
</div>
<div class="paragraph">
<p>To report the type of a database operation in an event message, the SMT can add an <code>op</code> field to one of the following elements:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The event message body.</p>
</li>
<li>
<p>A message header.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, to add a header property that shows the type of the original operation, add the transform, and then add the <code>add.headers</code> property to the connector configuration, as in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">transforms=unwrap,...
transforms.unwrap.type=io.debezium.connector.mongodb.transforms.ExtractNewDocumentState
transforms.unwrap.add.headers=op</code></pre>
</div>
</div>
<div class="paragraph">
<p>Based on the preceding configuration, the SMT reports the event type by adding an <code>op</code> header to the message and assigning it a string value to identify the type of the operation.
The assigned string value is based on the <code>op</code> field value in the original <a href="../connectors/mongodb.html#mongodb-events" class="xref page">MongoDB change event message</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_adding_metadata_fields"><a class="anchor" href="#_adding_metadata_fields"></a>Adding metadata fields</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The event flattening SMT for MongoDB can add metadata fields from the original change event message to the simplified message.
The added metadata fields are prefixed with a double underscore (<code>"__"</code>).
Adding metadata to the event record makes it possible to include content such as the name of the collection in which a change event occurred, or to include connector-specific fields, such as a replica set name.
Currently, the SMT can add fields from the following change event sub-structures only: <code>source</code>, <code>transaction</code> and <code>updateDescription</code>.</p>
</div>
<div class="paragraph">
<p>For more information about the MongoDB change event structure, see the <a href="../connectors/mongodb.html#debezium-connector-for-mongodb" class="xref page">MongoDB connector documentation</a>.</p>
</div>
<div class="paragraph">
<p>For example, you might specify the following configuration to add the replica set name (<code>rs</code>) and the collection name for a change event to the final flattened event record:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>transforms=unwrap,...
transforms.unwrap.type=io.debezium.connector.mongodb.transforms.ExtractNewDocumentState
transforms.unwrap.add.fields=rs,collection</pre>
</div>
</div>
<div class="paragraph">
<p>The preceding configuration results in the following content being added to the flattened record:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{ "__rs" : "rs0", "__collection" : "my-collection", ... }</pre>
</div>
</div>
<div class="paragraph">
<p>If you want the SMT to add metadata fields to <code>delete</code> events, set the value of the <a href="#mongodb-extract-new-record-state-delete-handling-mode"><code>delete.handling.mode</code></a> option to <code>rewrite</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="options-for-applying-the-transformation-selectively"><a class="anchor" href="#options-for-applying-the-transformation-selectively"></a>Options for applying the transformation selectively</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In addition to the change event messages that a Debezium connector emits when a database change occurs, the connector also emits other types of messages, including heartbeat messages, and metadata messages about schema changes and transactions.
Because the structure of these other messages differs from the structure of the change event messages that the SMT is designed to process, it&#8217;s best to configure the connector to selectively apply the SMT, so that it processes only the intended data change messages.</p>
</div>
<div class="paragraph">
<p>For more information about how to apply the SMT selectively, see <a href="applying-transformations-selectively.html#applying-transformations-selectively" class="xref page">Configure an SMT predicate for the transformation</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mongodb-extract-new-record-state-configuration-options"><a class="anchor" href="#mongodb-extract-new-record-state-configuration-options"></a>Configuration options</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following table describes the configuration options for the MongoDB event flattening SMT.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 30%;">
<col style="width: 25%;">
<col style="width: 45%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-extract-new-record-state-array-encoding"></a><a href="#mongodb-extract-new-record-state-array-encoding"><code>array.encoding</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>array</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Specifies the format that the SMT uses when it encodes arrays that it reads from the original event message.
Set one of the following options:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>array</code></dt>
<dd>
<p>The SMT uses the <code>array</code> datatype to encode MongoDB arrays into a format that is compatible with Apache Kafka Connect or Apache Avro schemas.
If you set this option, verify that the elements in each array instance are of the same type.
Although MongoDB allows arrays to contain multiple data types, some downstream clients cannot process arrays.</p>
</dd>
<dt class="hdlist1"><code>document</code></dt>
<dd>
<p>The SMT converts each MongoDB array into a <strong>struct</strong> of <strong>structs</strong>, in a manner that is similar to <a href="http://bsonspec.org/">BSON serialization</a>.
The main <strong>struct</strong> contains fields with the names <code>_0</code>, <code>_1</code>, <code>_2</code>, and so forth.
To comply with Avro naming standards, the SMT prefixes the numeric name of each index field with an underscore.
Each of the numeric field names represents the index of an element in the original array.
The SMT populates each of these index fields with the value that it retrieves from the source document for the designated array element.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For more information about the <code>array.coding</code> option, see the <a href="#mongodb-event-flattening-array-encoding">options for encoding arrays in MongoDB event messages</a>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-extract-new-record-state-flatten-struct"></a><a href="#mongodb-extract-new-record-state-flatten-struct"><code>flatten.struct</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>false</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The SMT flattens structures (structs) in the original event message by concatenating the names of nested properties in the message, separated by a configurable delimiter, to form a simple field name.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-extract-new-record-state-flatten-struct-delimiter"></a><a href="#mongodb-extract-new-record-state-flatten-struct-delimiter"><code>flatten.struct.delimiter</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>_</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>When <code>flatten.struct</code> is set to <code>true</code>, specifies the delimiter that the transformation inserts between field names that it concatenates from the input record to generate field names in the output record.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-extract-new-record-state-drop-tombstones"></a><a href="#mongodb-extract-new-record-state-drop-tombstones"><code>drop.tombstones</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>true</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Debezium generates a tombstone record for each <code>delete</code> operation.
The default behavior is that event flattening SMT removes tombstone records from the stream.
To retain tombstone records in the stream, specify <code>drop.tombstones=false</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This option is scheduled for removal in a future release.
In its place, use the <a href="#mongodb-extract-new-record-state-delete-tombstone-handling-mode"><code>delete.tombstone.handling.mode</code></a> option.</p>
</div>
</td>
</tr>
</table>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-extract-new-record-state-delete-handling-mode"></a><a href="#mongodb-extract-new-record-state-delete-handling-mode"><code>delete.handling.mode</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>drop</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Specifies how the SMT handles the change event records that Debezium generates for <code>delete</code> operations.
Set one of the following options:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>drop</code></dt>
<dd>
<p>The SMT removes records for <code>delete</code> operations from the event stream.</p>
</dd>
<dt class="hdlist1"><code>none</code></dt>
<dd>
<p>The SMT retains the original change event record from the event stream.
The record contains only <code>"value": "null"</code>.</p>
</dd>
<dt class="hdlist1"><code>rewrite</code></dt>
<dd>
<p>The SMT retains a modified version of the change event record from the stream.
To provide another way to indicate that the record was deleted, the modified record includes a <code>value</code> field that contains the key/value pairs that were from the original record, and adds <code>__deleted: true</code> to the <code>value</code>.<br>
<br>
If you set the <code>rewrite</code> option, you might find that the updated, simplified records for <code>DELETE</code> operations are sufficient for tracking deleted records.
In such a case, you might want the SMT to <a href="#mongodb-extract-new-record-state-drop-tombstones">drop tombstone records</a>.</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This option is scheduled for removal in a future release.
In its place, use the <a href="#mongodb-extract-new-record-state-delete-tombstone-handling-mode"><code>delete.tombstone.handling.mode</code></a> option.</p>
</div>
</td>
</tr>
</table>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-extract-new-record-state-delete-tombstone-handling-mode"></a><a href="#mongodb-extract-new-record-state-delete-tombstone-handling-mode"><code>delete.tombstone.handling.mode</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>No default</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Debezium generates a change event record for each <code>DELETE</code> operation.
This setting determines how the MongoDB event flattening SMT handles <code>DELETE</code> events in the stream.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The setting for this option takes precedence over any conflicting settings that you might configure for the deprecated <a href="#mongodb-extract-new-record-state-drop-tombstones"><code>drop.tombstones</code></a> or <a href="#mongodb-extract-new-record-state-delete-handling-mode"><code>delete.handling.mode</code></a> options.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Set one of the following options:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>drop</code></dt>
<dd>
<p>The SMT removes both <code>DELETE</code> events and `TOMBSTONE`records from the stream.</p>
</dd>
<dt class="hdlist1"><code>tombstone</code> (default)</dt>
<dd>
<p>The SMT retains <code>TOMBSTONE</code> records in the stream.
The <code>TOMBSTONE</code> record contains only the following value: <code>"value": "null"</code>.</p>
</dd>
<dt class="hdlist1"><code>rewrite</code></dt>
<dd>
<p>The SMT retains the change event record in the stream and makes the following changes:</p>
<div class="ulist">
<ul>
<li>
<p>Adds a <code>value</code> field to the record that contains the key/value pairs from the <code>before</code> field of the original record.</p>
</li>
<li>
<p>Adds <code>__deleted: true</code> to the <code>value</code> of the record.</p>
</li>
<li>
<p>Removes <code>TOMBSTONE</code> records.</p>
<div class="paragraph">
<p>This setting provides another way to indicate that the record has been deleted.</p>
</div>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1"><code>rewrite-with-tombstone</code></dt>
<dd>
<p>The SMT behaves as it does when you select the <code>rewrite</code> option, except that it also retains <code>TOMBSTONE</code> records.</p>
</dd>
</dl>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-extract-new-record-state-delete-tombstone-handling-mode-rewrite-with-id"></a><a href="#mongodb-extract-new-record-state-delete-tombstone-handling-mode-rewrite-with-id"><code>delete.tombstone.handling.mode.rewrite-with-id</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>false</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>When set to <code>true</code> and <code>delete.tombstone.handling.mode</code> is <code>rewrite</code>, copies <code>id</code> field from the key and includes it as <code>_id</code> in the payload for delete events.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-extract-new-record-state-add-headers-prefix"></a><a href="#mongodb-extract-new-record-state-add-headers-prefix"><code>add.headers.prefix</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>__ (double-underscore)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Set this optional string to prefix a header.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-extract-new-record-state-add-headers"></a><a href="#mongodb-extract-new-record-state-add-headers"><code>add.headers</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>No default</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Specifies a comma-separated list, with no spaces, of metadata fields that you want the SMT to add to the header of simplified messages.
When the original message contains duplicate field names, you can identify the specific field to modify by providing the name of the struct together with the name of the field, for example, <code>source.ts_ms</code>.</p>
</div>
<div class="paragraph">
<p>Optionally, you can override the original name of a field and assign it a new name by adding an entry in the following format to the list:<br></p>
</div>
<div class="paragraph">
<p><code><em>&lt;field_name&gt;</em>:<em>&lt;new_field_name&gt;</em></code>.<br></p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">version:VERSION, connector:CONNECTOR, source.ts_ms:EVENT_TIMESTAMP</code></pre>
</div>
</div>
<div class="paragraph">
<p>The new name values that you specify are case-sensitive.<br>
<br>
When the SMT adds metadata fields to the header of the simplified message, it prefixes each metadata field name with a double underscore.
For a struct specification, the SMT also inserts an underscore between the struct name and the field name.<br>
<br>
If you specify a field that is not in the change event original message, the SMT does not add the field to the header.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-extract-new-record-state-add-fields-prefix"></a><a href="#mongodb-extract-new-record-state-add-fields-prefix"><code>add.fields.prefix</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>__ (double-underscore)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Specifies an optional string to prefix to a field name.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="mongodb-extract-new-record-state-add-fields"></a><a href="#mongodb-extract-new-record-state-add-fields"><code>add.fields</code></a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>No default</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Set this option to a comma-separated list, with no spaces, of metadata fields to add to the <code>value</code> element of the simplified Kafka message.
When the original message contains duplicate field names, you can identify the specific field to modify by providing the name of the struct together with the name of the field, for example, <code>source.ts_ms</code>.
<br>
Optionally, you can override the original name of a field and assign it a new name by adding an entry in the following format to the list:<br></p>
</div>
<div class="paragraph">
<p><code><em>&lt;field_name&gt;</em>:<em>&lt;new_field_name&gt;</em></code>.<br></p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">version:VERSION, connector:CONNECTOR, source.ts_ms:EVENT_TIMESTAMP</code></pre>
</div>
</div>
<div class="paragraph">
<p>The new name values that you specify are case-sensitive.<br></p>
</div>
<div class="paragraph">
<p>When the SMT adds metadata fields to the <code>value</code> element of the simplified message, it prefixes each metadata field name with a double underscore.
For a struct specification, the SMT also inserts an underscore between the struct name and the field name.<br>
<br>
If you specify a field that is not present in the original change event message, the SMT still adds the specified field to the <code>value</code> element of the modified message.</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="debezium-event-flattening-smt-for-mongodb-known-limitations"><a class="anchor" href="#debezium-event-flattening-smt-for-mongodb-known-limitations"></a>Known limitations</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Because MongoDB is a schemaless database, to ensure consistent column definitions when you use Debezium to stream changes to a schema-based data relational database, fields within a collection that have the same name must store the same type of data.</p>
</li>
<li>
<p>Configure the SMT to produce messages in the format that is compatible with the sink connector.
If a sink connector requires a "flat" message structure, but it receives a message that encodes an array in the source MongoDB document as a struct of structs, the sink connector cannot process the message.</p>
</li>
</ul>
</div>
</div>
</div>
</article>
</div>
<div class="article-cell2">
</div>
</div>

<div id="toc-rightbar"></div>    <footer class="footer">
        <div class="wrapper">
            <div class="copyright">Copyright &copy; 2024 Debezium Community (Rev: <span class="truncated"><a href="https://github.com/debezium/debezium/commit/0824a9a39091801e2e89de725c97be1c986100b6">0824a9a3</a></span>)
            
        </div>
    </footer>
</main></div>
<script>
    /* Make sure TOC carets are expanded if sub-elements exist */
    $("#toc").each(function(i,v) {
      $(this).closest('article').addClass('with-toc');
    });

    $("#toc ul.sectlevel1 > li").each(function(i,v) {
      $(this).has("ul").addClass("expanded");
    });

    $(function() {
        /* Expands all the documentation submenus */
        $(".nav-list > .nav-item:not(.is-active) .nav-item-toggle").click();
    });

    /**
     * This checks if a "#toc" element exists in the DOM and if so:
     *
     *  1. Appends a cloned copy of the #toc node to the #toc-rightbar div.
     *  2. Forces the #toc-rightbar div to be visible.
     *  3. Adds the .toc-right class to the #article-wrapper div to restrict the article's overall width.
     */
    var $toc = $("#toc");
    if ( $toc.length ) {
        $("#toc-rightbar").append($toc.clone());
        $("body .main").addClass("with-toc");
    }

    /**
     * In order to make CSS changes that are backward compatible with old adoc files, this applies a version
     * style to the body tag so we can use it to differentiate between CSS styles per version if needed,
     * such as tfoot rows.
     */
    var $version = $("body .nav-container").data("version");
    var $versionClass = "version-" + $version;
    $versionClass = $versionClass.replace('.','-');
    $("body").addClass($versionClass);

    /** A CSS trick to wrap long-width tables in a div that can be scrolled on smaller screens */
    $("table.tableblock").wrap("<div class='table-scroll-wrapper'></div>");

    $(function() {
        /* apply floating scrollbar to the scroll-wrapper */
        $(".table-scroll-wrapper").floatingScrollbar();
    });

</script>
<script src="../../../debezium-antora/js/site.js"></script>
<script async src="../../../debezium-antora/js/vendor/highlight.js"></script>

<script type="text/javascript">
  var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
  document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
  try {
    var pageTracker = _gat._getTracker("UA-10656779-1");
    pageTracker._trackPageview();
  } catch(err) {}
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-76464546-1', 'auto');
  ga('send', 'pageview');
  ga('set', 'anonymizeIp', true);
  ga('require', 'linkid', 'linkid.js');
</script>
</body>
</html>